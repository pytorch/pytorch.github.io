---
layout: blog_detail
title: "Inside the Matrix: Visualizing Matrix Multiplication, Attention and Beyond"
author: Basil Hosmer
---

_Use 3D to visualize matrix multiplication expressions, attention heads with real weights, and more._

Matrix multiplications (matmuls) are the building blocks of today’s ML models. This note presents [mm](https://bhosmer.github.io/mm/ref.html), a visualization tool for matmuls and compositions of matmuls.

Matrix multiplication is inherently a three-dimensional operation. Because mm uses all three spatial dimensions, it can convey meaning more clearly and intuitively than the usual squares-on-paper idioms, especially (though not only) for visual/spatial thinkers.

We also have room to _compose_ matmuls in geometrically consistent ways - so we can visualize big, compound structures like attention heads and MLP layers using the same rules as simple expressions. And more advanced features, like animating different matmul algorithms, partitioning for parallelism, and loading external data to explore the behavior of actual models, all build naturally on this foundation.

mm is fully interactive, runs [in the browser](https://bhosmer.github.io/mm/) and keeps its complete state in the URL, so links are shareable sessions (the screenshots and videos in this note all have links that open the corresponding visualization in the tool). This [reference guide](https://bhosmer.github.io/mm/ref.html) describes all of the available functionality.

We'll first introduce the visualization approach, build intuition by visualizing some simple matmuls and expressions, then dive into some more extended examples:



1. **Pitch** - why is this way of visualizing better?
2. **Warmup - animations** - watching the canonical matmul decompositions in action
3. **Warmup - expressions** - a quick tour of some fundamental expression building blocks
4. **Inside an attention head** - an in-depth look at the structure, values and computation behavior of a couple of attention heads from GPT2 via [NanoGPT](https://github.com/karpathy/nanoGPT)
5. **Parallelizing attention** - visualizing attention head parallelization with examples from the recent [Blockwise Parallel Transformer](https://arxiv.org/pdf/2305.19370.pdf) paper
6. **Sizes in an attention layer** - what do the MHA and FFA halves of an attention layer look like together, when we visualize a whole layer as a single structure? How does the picture change during autoregressive decoding?
7. **LoRA** - a visual explanation of this elaboration of the attention head architecture
8. **Wrapup** - next steps and call for feedback


## 1 Pitch

[mm](https://bhosmer.github.io/mm/ref.html)'s visualization approach is based on the premise that _matrix multiplication is fundamentally a three-dimensional operation_. 

In other words this:

![matrix multiplication is fundamentally a three-dimensional operation](/assets/images/inside-the-matrix/matmul3.jpg){:style="width:100%; max-width: 478px; display: block; margin-left: auto; margin-right: auto"}

is a sheet of paper trying to be this ([open in mm](https://bhosmer.github.io/mm/index.html?params=%7B%22expr%22%3A%22L%20%40%20R%22%2C%22name%22%3A%22L%20%40%20R%22%2C%22epilog%22%3A%22none%22%2C%22left%22%3A%7B%22name%22%3A%22L%22%2C%22matmul%22%3Afalse%2C%22h%22%3A32%2C%22w%22%3A24%2C%22init%22%3A%22expr%22%2C%22url%22%3A%22%22%2C%22min%22%3A-1%2C%22max%22%3A1%2C%22dropout%22%3A0%2C%22expr%22%3A%22-2%20*%20(Math.trunc(i%20%2F%208)%20%25%202)%20%2B%201%22%2C%22folder%22%3A%22open%22%7D%2C%22right%22%3A%7B%22name%22%3A%22R%22%2C%22matmul%22%3Afalse%2C%22h%22%3A24%2C%22w%22%3A32%2C%22init%22%3A%22expr%22%2C%22url%22%3A%22%22%2C%22min%22%3A-1%2C%22max%22%3A1%2C%22dropout%22%3A0%2C%22expr%22%3A%22-2%20*%20(Math.trunc(j%20%2F%208)%20%25%202)%20%2B%201%22%2C%22folder%22%3A%22open%22%7D%2C%22anim%22%3A%7B%22fuse%22%3A%22none%22%2C%22speed%22%3A20%2C%22hide%20inputs%22%3Afalse%2C%22alg%22%3A%22none%22%2C%22spin%22%3A0%2C%22folder%22%3A%22open%22%7D%2C%22block%22%3A%7B%22i%20blocks%22%3A1%2C%22j%20blocks%22%3A1%2C%22k%20blocks%22%3A1%7D%2C%22layout%22%3A%7B%22scheme%22%3A%22blocks%22%2C%22gap%22%3A3%2C%22scatter%22%3A0%2C%22molecule%22%3A1%2C%22blast%22%3A0%2C%22polarity%22%3A%22negative%22%2C%22left%20placement%22%3A%22left%22%2C%22right%20placement%22%3A%22top%22%2C%22result%20placement%22%3A%22front%22%2C%22folder%22%3A%22closed%22%7D%2C%22deco%22%3A%7B%22legends%22%3A6%2C%22shape%22%3Atrue%2C%22spotlight%22%3A2%2C%22row%20guides%22%3A1%2C%22flow%20guides%22%3A0.5%2C%22lens%20size%22%3A0.5%2C%22magnification%22%3A10%2C%22interior%20spotlight%22%3Afalse%2C%22axes%22%3Afalse%2C%22folder%22%3A%22closed%22%7D%2C%22viz%22%3A%7B%22sensitivity%22%3A%22semilocal%22%2C%22min%20size%22%3A0.196%2C%22min%20light%22%3A0.4%2C%22max%20light%22%3A0.6%2C%22elem%20scale%22%3A0.8227%2C%22zero%20hue%22%3A0.77%2C%22hue%20gap%22%3A0.74%2C%22hue%20spread%22%3A0.04%2C%22folder%22%3A%22open%22%7D%2C%22diag%22%3A%7B%22url%22%3A%22%22%7D%2C%22cam%22%3A%7B%22x%22%3A-48.763575165818956%2C%22y%22%3A43.72517618222101%2C%22z%22%3A33.70077275818966%2C%22target%22%3A%7B%22x%22%3A0%2C%22y%22%3A0%2C%22z%22%3A0%7D%7D%2C%22folder%22%3A%22closed%22%2C%22compress%22%3Afalse%7D)):



![wrap the matmul around a cube](/assets/images/inside-the-matrix/initial.jpg){:style="width:100%"}


When we wrap the matmul around a cube this way, the correct relationships between argument shapes, result shape and shared dimensions all fall into place. 

Now the computation makes _geometric sense_: each location `i, j` in the result matrix anchors a vector running along the depth dimension `k` in the cube's interior, where the horizontal plane extending from row `i` in `L` and a vertical plane extending from column `j` in `R` intersect. Along this vector, pairs of `(i, k)` `(k, j)` elements from the left and right arguments meet and are multiplied, and the resulting products are summed along `k` and the result is deposited in location `i, j` of the result.

(Jumping ahead momentarily, [here's an animation](https://bhosmer.github.io/mm/index.html?params=%7B%22expr%22%3A%22L%20%40%20R%22%2C%22name%22%3A%22L%20%40%20R%22%2C%22epilog%22%3A%22none%22%2C%22left%22%3A%7B%22name%22%3A%22L%22%2C%22matmul%22%3Afalse%2C%22h%22%3A32%2C%22w%22%3A24%2C%22init%22%3A%22expr%22%2C%22url%22%3A%22%22%2C%22min%22%3A-1%2C%22max%22%3A1%2C%22dropout%22%3A0%2C%22expr%22%3A%22-2%20*%20(Math.trunc(i%20%2F%208)%20%25%202)%20%2B%201%22%2C%22folder%22%3A%22open%22%7D%2C%22right%22%3A%7B%22name%22%3A%22R%22%2C%22matmul%22%3Afalse%2C%22h%22%3A24%2C%22w%22%3A32%2C%22init%22%3A%22expr%22%2C%22url%22%3A%22%22%2C%22min%22%3A-1%2C%22max%22%3A1%2C%22dropout%22%3A0%2C%22expr%22%3A%22-2%20*%20(Math.trunc(j%20%2F%208)%20%25%202)%20%2B%201%22%2C%22folder%22%3A%22open%22%7D%2C%22anim%22%3A%7B%22fuse%22%3A%22none%22%2C%22speed%22%3A48%2C%22hide%20inputs%22%3Afalse%2C%22alg%22%3A%22dotprod%20(row%20major)%22%2C%22spin%22%3A0%2C%22folder%22%3A%22open%22%7D%2C%22block%22%3A%7B%22i%20blocks%22%3A1%2C%22j%20blocks%22%3A1%2C%22k%20blocks%22%3A1%7D%2C%22layout%22%3A%7B%22scheme%22%3A%22blocks%22%2C%22gap%22%3A5%2C%22scatter%22%3A0%2C%22molecule%22%3A1%2C%22blast%22%3A0%2C%22polarity%22%3A%22negative%22%2C%22left%20placement%22%3A%22left%22%2C%22right%20placement%22%3A%22top%22%2C%22result%20placement%22%3A%22front%22%2C%22folder%22%3A%22open%22%7D%2C%22deco%22%3A%7B%22legends%22%3A6%2C%22shape%22%3Atrue%2C%22spotlight%22%3A2%2C%22row%20guides%22%3A1%2C%22flow%20guides%22%3A0.5%2C%22lens%20size%22%3A0.5%2C%22magnification%22%3A10%2C%22interior%20spotlight%22%3Afalse%2C%22axes%22%3Afalse%2C%22folder%22%3A%22closed%22%7D%2C%22viz%22%3A%7B%22sensitivity%22%3A%22semilocal%22%2C%22min%20size%22%3A0.196%2C%22min%20light%22%3A0.4%2C%22max%20light%22%3A0.6%2C%22elem%20scale%22%3A1%2C%22zero%20hue%22%3A0.77%2C%22hue%20gap%22%3A0.74%2C%22hue%20spread%22%3A0.04%2C%22folder%22%3A%22open%22%7D%2C%22diag%22%3A%7B%22url%22%3A%22%22%7D%2C%22cam%22%3A%7B%22x%22%3A-54.145594172414235%2C%22y%22%3A48.55110882721702%2C%22z%22%3A37.42031544768185%2C%22target%22%3A%7B%22x%22%3A0%2C%22y%22%3A0%2C%22z%22%3A0%7D%7D%2C%22folder%22%3A%22closed%22%2C%22compress%22%3Afalse%7D).)

This is the _intuitive_ meaning of matrix multiplication:



1. **project** two orthogonal matrices into the interior of a cube
2. **multiply** the pair of values at each intersection, forming a grid of products 
3. **sum** along the third orthogonal dimension to produce a result matrix.

For orientation, the tool displays an arrow in the cube's interior that points towards the result matrix, with a blue vane coming from the left argument and a **r**ed vane coming from the **r**ight argument. The tool also displays white guidelines to indicate the row axis of each matrix, though they're faint in this screenshot.

The layout constraints are straightforward:



* left argument and result must be adjoined along their shared **height** (i) dimension
* right argument and result must be adjoined along their shared **width** (j) dimension
* left and right arguments must be adjoined along their shared (left width/right height) dimension, which becomes the matmul’s **depth** (k) dimension

This geometry gives us a solid foundation for visualizing all the standard matmul decompositions, and an intuitive basis for exploring nontrivially complex _compositions_ of matmuls, as we'll see below.


## 2 Warmup - animations

Before diving into some more complex examples, we'll run through a few intuition builders to get a feel for how things look and feel in this style of visualization.


### 2a Dot product

First, the canonical algorithm - computing each result element by taking the dot product of the corresponding left row and right column. What we see in the animation is the sweep of multiplied value vectors through the cube’s interior, each delivering a summed result at the corresponding position.

Here, `L` has blocks of rows filled with 1 (blue) or -1 (red); `R` has column blocks filled similarly. `k` is 24 here, so the result matrix (`L @ R`) has blue values of 24 and red values of -24 ([open in mm](https://bhosmer.github.io/mm/index.html?params=%7B%22expr%22%3A%22L%20%40%20R%22%2C%22name%22%3A%22L%20%40%20R%22%2C%22epilog%22%3A%22none%22%2C%22left%22%3A%7B%22name%22%3A%22L%22%2C%22matmul%22%3Afalse%2C%22h%22%3A32%2C%22w%22%3A24%2C%22init%22%3A%22expr%22%2C%22url%22%3A%22%22%2C%22min%22%3A-1%2C%22max%22%3A1%2C%22dropout%22%3A0%2C%22expr%22%3A%22-2%20*%20(Math.trunc(i%20%2F%208)%20%25%202)%20%2B%201%22%2C%22folder%22%3A%22open%22%7D%2C%22right%22%3A%7B%22name%22%3A%22R%22%2C%22matmul%22%3Afalse%2C%22h%22%3A24%2C%22w%22%3A32%2C%22init%22%3A%22expr%22%2C%22url%22%3A%22%22%2C%22min%22%3A-1%2C%22max%22%3A1%2C%22dropout%22%3A0%2C%22expr%22%3A%22-2%20*%20(Math.trunc(j%20%2F%208)%20%25%202)%20%2B%201%22%2C%22folder%22%3A%22open%22%7D%2C%22anim%22%3A%7B%22fuse%22%3A%22none%22%2C%22speed%22%3A48%2C%22hide%20inputs%22%3Afalse%2C%22alg%22%3A%22dotprod%20(row%20major)%22%2C%22spin%22%3A0%2C%22folder%22%3A%22open%22%7D%2C%22block%22%3A%7B%22i%20blocks%22%3A1%2C%22j%20blocks%22%3A1%2C%22k%20blocks%22%3A1%7D%2C%22layout%22%3A%7B%22scheme%22%3A%22blocks%22%2C%22gap%22%3A5%2C%22scatter%22%3A0%2C%22molecule%22%3A1%2C%22blast%22%3A0%2C%22polarity%22%3A%22negative%22%2C%22left%20placement%22%3A%22left%22%2C%22right%20placement%22%3A%22top%22%2C%22result%20placement%22%3A%22front%22%2C%22folder%22%3A%22open%22%7D%2C%22deco%22%3A%7B%22legends%22%3A6%2C%22shape%22%3Atrue%2C%22spotlight%22%3A2%2C%22row%20guides%22%3A1%2C%22flow%20guides%22%3A0.5%2C%22lens%20size%22%3A0.5%2C%22magnification%22%3A10%2C%22interior%20spotlight%22%3Afalse%2C%22axes%22%3Afalse%2C%22folder%22%3A%22closed%22%7D%2C%22viz%22%3A%7B%22sensitivity%22%3A%22semilocal%22%2C%22min%20size%22%3A0.196%2C%22min%20light%22%3A0.4%2C%22max%20light%22%3A0.6%2C%22elem%20scale%22%3A1%2C%22zero%20hue%22%3A0.77%2C%22hue%20gap%22%3A0.74%2C%22hue%20spread%22%3A0.04%2C%22folder%22%3A%22open%22%7D%2C%22diag%22%3A%7B%22url%22%3A%22%22%7D%2C%22cam%22%3A%7B%22x%22%3A-54.145594172414235%2C%22y%22%3A48.55110882721702%2C%22z%22%3A37.42031544768185%2C%22target%22%3A%7B%22x%22%3A0%2C%22y%22%3A0%2C%22z%22%3A0%7D%7D%2C%22folder%22%3A%22closed%22%2C%22compress%22%3Afalse%7D) - long click or control-click to inspect values): 

<p align="center">
  <video width="100%" controls>
    <source src="/assets/videos/inside-the-matrix/dotprod1.mp4" type="video/mp4">
  </video>
</p>

### 2b Matrix-vector products

A matmul decomposed into matrix-vector products looks like a vertical plane (a product of the left argument with each column of the right argument) painting columns onto the result as it sweeps horizontally through the cube's interior ([open in mm](https://bhosmer.github.io/mm/index.html?params=%7B%22expr%22%3A%22L%20%40%20R%22%2C%22name%22%3A%22L%20%40%20R%22%2C%22epilog%22%3A%22none%22%2C%22left%22%3A%7B%22name%22%3A%22L%22%2C%22matmul%22%3Afalse%2C%22h%22%3A32%2C%22w%22%3A24%2C%22init%22%3A%22expr%22%2C%22url%22%3A%22%22%2C%22min%22%3A-1%2C%22max%22%3A1%2C%22dropout%22%3A0%2C%22expr%22%3A%22-2%20*%20(Math.trunc(i%20%2F%208)%20%25%202)%20%2B%201%22%2C%22folder%22%3A%22closed%22%7D%2C%22right%22%3A%7B%22name%22%3A%22R%22%2C%22matmul%22%3Afalse%2C%22h%22%3A24%2C%22w%22%3A32%2C%22init%22%3A%22expr%22%2C%22url%22%3A%22%22%2C%22min%22%3A-1%2C%22max%22%3A1%2C%22dropout%22%3A0%2C%22expr%22%3A%22-2%20*%20(Math.trunc(j%20%2F%208)%20%25%202)%20%2B%201%22%2C%22folder%22%3A%22closed%22%7D%2C%22anim%22%3A%7B%22fuse%22%3A%22none%22%2C%22speed%22%3A12%2C%22hide%20inputs%22%3Afalse%2C%22alg%22%3A%22mvprod%22%2C%22spin%22%3A0%2C%22folder%22%3A%22open%22%7D%2C%22block%22%3A%7B%22i%20blocks%22%3A1%2C%22j%20blocks%22%3A1%2C%22k%20blocks%22%3A1%7D%2C%22layout%22%3A%7B%22scheme%22%3A%22blocks%22%2C%22gap%22%3A5%2C%22scatter%22%3A0%2C%22molecule%22%3A1%2C%22blast%22%3A0%2C%22polarity%22%3A%22negative%22%2C%22left%20placement%22%3A%22left%22%2C%22right%20placement%22%3A%22top%22%2C%22result%20placement%22%3A%22front%22%2C%22folder%22%3A%22open%22%7D%2C%22deco%22%3A%7B%22legends%22%3A6%2C%22shape%22%3Atrue%2C%22spotlight%22%3A2%2C%22row%20guides%22%3A1%2C%22flow%20guides%22%3A0.5%2C%22lens%20size%22%3A0.5%2C%22magnification%22%3A10%2C%22interior%20spotlight%22%3Afalse%2C%22axes%22%3Afalse%2C%22folder%22%3A%22closed%22%7D%2C%22viz%22%3A%7B%22sensitivity%22%3A%22semilocal%22%2C%22min%20size%22%3A0.196%2C%22min%20light%22%3A0.4%2C%22max%20light%22%3A0.6%2C%22elem%20scale%22%3A1%2C%22zero%20hue%22%3A0.77%2C%22hue%20gap%22%3A0.74%2C%22hue%20spread%22%3A0.04%2C%22folder%22%3A%22open%22%7D%2C%22diag%22%3A%7B%22url%22%3A%22%22%7D%2C%22cam%22%3A%7B%22x%22%3A-54.145594172414235%2C%22y%22%3A48.55110882721702%2C%22z%22%3A37.42031544768185%2C%22target%22%3A%7B%22x%22%3A0%2C%22y%22%3A0%2C%22z%22%3A0%7D%7D%2C%22folder%22%3A%22closed%22%2C%22compress%22%3Afalse%7D)): 

<p align="center">
  <video width="100%" controls>
    <source src="/assets/videos/inside-the-matrix/mvprod1.mp4" type="video/mp4">
  </video>
</p>

Observing the intermediate values of a decomposition can be quite interesting, even in simple examples. 

For instance, note the prominent vertical patterns in the intermediate matrix-vector products when we use randomly initialized arguments- reflecting the fact that each intermediate is a column-scaled replica of the left argument ([open in mm](https://bhosmer.github.io/mm/index.html?params=%7B%22expr%22%3A%22L%20%40%20R%22%2C%22name%22%3A%22L%20%40%20R%22%2C%22epilog%22%3A%22none%22%2C%22left%22%3A%7B%22name%22%3A%22L%22%2C%22matmul%22%3Afalse%2C%22h%22%3A32%2C%22w%22%3A24%2C%22init%22%3A%22gaussian%22%2C%22url%22%3A%22%22%2C%22min%22%3A-1%2C%22max%22%3A1%2C%22dropout%22%3A0%2C%22expr%22%3A%22(-Math.trunc(i%20%2F%208)%20%25%202)%20%2B%20.5%22%2C%22folder%22%3A%22open%22%7D%2C%22right%22%3A%7B%22name%22%3A%22R%22%2C%22matmul%22%3Afalse%2C%22h%22%3A24%2C%22w%22%3A32%2C%22init%22%3A%22gaussian%22%2C%22url%22%3A%22%22%2C%22min%22%3A-1%2C%22max%22%3A1%2C%22dropout%22%3A0%2C%22expr%22%3A%22(-Math.trunc(j%20%2F%208)%20%25%202)%20%2B%20.5%22%2C%22folder%22%3A%22open%22%7D%2C%22anim%22%3A%7B%22fuse%22%3A%22none%22%2C%22speed%22%3A6%2C%22hide%20inputs%22%3Afalse%2C%22alg%22%3A%22mvprod%22%2C%22spin%22%3A0%2C%22folder%22%3A%22open%22%7D%2C%22block%22%3A%7B%22i%20blocks%22%3A1%2C%22j%20blocks%22%3A1%2C%22k%20blocks%22%3A1%7D%2C%22layout%22%3A%7B%22scheme%22%3A%22blocks%22%2C%22gap%22%3A5%2C%22scatter%22%3A0%2C%22molecule%22%3A1%2C%22blast%22%3A0%2C%22polarity%22%3A%22negative%22%2C%22left%20placement%22%3A%22left%22%2C%22right%20placement%22%3A%22top%22%2C%22result%20placement%22%3A%22front%22%2C%22folder%22%3A%22open%22%7D%2C%22deco%22%3A%7B%22legends%22%3A6%2C%22shape%22%3Atrue%2C%22spotlight%22%3A2%2C%22row%20guides%22%3A1%2C%22flow%20guides%22%3A0%2C%22lens%20size%22%3A0.5%2C%22magnification%22%3A10%2C%22interior%20spotlight%22%3Afalse%2C%22axes%22%3Afalse%2C%22folder%22%3A%22open%22%7D%2C%22viz%22%3A%7B%22sensitivity%22%3A%22local%22%2C%22min%20size%22%3A0.196%2C%22min%20light%22%3A0.4%2C%22max%20light%22%3A0.6%2C%22elem%20scale%22%3A1%2C%22zero%20hue%22%3A0.77%2C%22hue%20gap%22%3A0.74%2C%22hue%20spread%22%3A0.04%2C%22folder%22%3A%22open%22%7D%2C%22diag%22%3A%7B%22url%22%3A%22%22%7D%2C%22cam%22%3A%7B%22x%22%3A-54.14559417241423%2C%22y%22%3A48.55110882721702%2C%22z%22%3A37.42031544768186%2C%22target%22%3A%7B%22x%22%3A0%2C%22y%22%3A0%2C%22z%22%3A0%7D%7D%2C%22folder%22%3A%22closed%22%2C%22compress%22%3Afalse%7D)): 

<p align="center">
  <video width="100%" controls>
    <source src="/assets/videos/inside-the-matrix/mvprod2.mp4" type="video/mp4">
  </video>
</p>

### 2c Vector-matrix products

A matmul decomposed into vector-matrix products looks like a horizontal plane painting rows onto the result as it descends through the cube's interior ([open in mm](https://bhosmer.github.io/mm/index.html?params=%7B%22expr%22%3A%22L%20%40%20R%22%2C%22name%22%3A%22L%20%40%20R%22%2C%22epilog%22%3A%22none%22%2C%22left%22%3A%7B%22name%22%3A%22L%22%2C%22matmul%22%3Afalse%2C%22h%22%3A32%2C%22w%22%3A24%2C%22init%22%3A%22expr%22%2C%22url%22%3A%22%22%2C%22min%22%3A-1%2C%22max%22%3A1%2C%22dropout%22%3A0%2C%22expr%22%3A%22-2%20*%20(Math.trunc(i%20%2F%208)%20%25%202)%20%2B%201%22%2C%22folder%22%3A%22closed%22%7D%2C%22right%22%3A%7B%22name%22%3A%22R%22%2C%22matmul%22%3Afalse%2C%22h%22%3A24%2C%22w%22%3A32%2C%22init%22%3A%22expr%22%2C%22url%22%3A%22%22%2C%22min%22%3A-1%2C%22max%22%3A1%2C%22dropout%22%3A0%2C%22expr%22%3A%22-2%20*%20(Math.trunc(j%20%2F%208)%20%25%202)%20%2B%201%22%2C%22folder%22%3A%22closed%22%7D%2C%22anim%22%3A%7B%22fuse%22%3A%22none%22%2C%22speed%22%3A12%2C%22hide%20inputs%22%3Afalse%2C%22alg%22%3A%22vmprod%22%2C%22spin%22%3A0%2C%22folder%22%3A%22open%22%7D%2C%22block%22%3A%7B%22i%20blocks%22%3A1%2C%22j%20blocks%22%3A1%2C%22k%20blocks%22%3A1%7D%2C%22layout%22%3A%7B%22scheme%22%3A%22blocks%22%2C%22gap%22%3A5%2C%22scatter%22%3A0%2C%22molecule%22%3A1%2C%22blast%22%3A0%2C%22polarity%22%3A%22negative%22%2C%22left%20placement%22%3A%22left%22%2C%22right%20placement%22%3A%22top%22%2C%22result%20placement%22%3A%22front%22%2C%22folder%22%3A%22open%22%7D%2C%22deco%22%3A%7B%22legends%22%3A6%2C%22shape%22%3Atrue%2C%22spotlight%22%3A2%2C%22row%20guides%22%3A1%2C%22flow%20guides%22%3A0.5%2C%22lens%20size%22%3A0.5%2C%22magnification%22%3A10%2C%22interior%20spotlight%22%3Afalse%2C%22axes%22%3Afalse%2C%22folder%22%3A%22closed%22%7D%2C%22viz%22%3A%7B%22sensitivity%22%3A%22semilocal%22%2C%22min%20size%22%3A0.196%2C%22min%20light%22%3A0.4%2C%22max%20light%22%3A0.6%2C%22elem%20scale%22%3A1%2C%22zero%20hue%22%3A0.77%2C%22hue%20gap%22%3A0.74%2C%22hue%20spread%22%3A0.04%2C%22folder%22%3A%22open%22%7D%2C%22diag%22%3A%7B%22url%22%3A%22%22%7D%2C%22cam%22%3A%7B%22x%22%3A-54.145594172414235%2C%22y%22%3A48.55110882721702%2C%22z%22%3A37.42031544768185%2C%22target%22%3A%7B%22x%22%3A0%2C%22y%22%3A0%2C%22z%22%3A0%7D%7D%2C%22folder%22%3A%22closed%22%2C%22compress%22%3Afalse%7D)): 

<p align="center">
  <video width="100%" controls>
    <source src="/assets/videos/inside-the-matrix/vmprod_check.mp4" type="video/mp4">
  </video>
</p>


Switching to randomly initialized arguments, we see patterns analogous to those we saw with matrix-vector products - only this time the patterns are horizontal, corresponding to the fact that each intermediate vector-matrix product is a row-scaled replica of the right argument. 

When thinking about how matmuls express the rank and structure of their arguments, it's useful to envision both of these patterns happening simultaneously in the computation ([open in mm](https://bhosmer.github.io/mm/index.html?params=%7B%22expr%22%3A%22L%20%40%20R%22%2C%22name%22%3A%22L%20%40%20R%22%2C%22epilog%22%3A%22none%22%2C%22left%22%3A%7B%22name%22%3A%22L%22%2C%22matmul%22%3Afalse%2C%22h%22%3A32%2C%22w%22%3A24%2C%22init%22%3A%22gaussian%22%2C%22url%22%3A%22%22%2C%22min%22%3A-1%2C%22max%22%3A1%2C%22dropout%22%3A0%2C%22expr%22%3A%22(-Math.trunc(i%20%2F%208)%20%25%202)%20%2B%20.5%22%2C%22folder%22%3A%22open%22%7D%2C%22right%22%3A%7B%22name%22%3A%22R%22%2C%22matmul%22%3Afalse%2C%22h%22%3A24%2C%22w%22%3A32%2C%22init%22%3A%22gaussian%22%2C%22url%22%3A%22%22%2C%22min%22%3A-1%2C%22max%22%3A1%2C%22dropout%22%3A0%2C%22expr%22%3A%22(-Math.trunc(j%20%2F%208)%20%25%202)%20%2B%20.5%22%2C%22folder%22%3A%22open%22%7D%2C%22anim%22%3A%7B%22fuse%22%3A%22none%22%2C%22speed%22%3A6%2C%22hide%20inputs%22%3Afalse%2C%22alg%22%3A%22vmprod%22%2C%22spin%22%3A0%2C%22folder%22%3A%22open%22%7D%2C%22block%22%3A%7B%22i%20blocks%22%3A1%2C%22j%20blocks%22%3A1%2C%22k%20blocks%22%3A1%7D%2C%22layout%22%3A%7B%22scheme%22%3A%22blocks%22%2C%22gap%22%3A5%2C%22scatter%22%3A0%2C%22molecule%22%3A1%2C%22blast%22%3A0%2C%22polarity%22%3A%22negative%22%2C%22left%20placement%22%3A%22left%22%2C%22right%20placement%22%3A%22top%22%2C%22result%20placement%22%3A%22front%22%2C%22folder%22%3A%22open%22%7D%2C%22deco%22%3A%7B%22legends%22%3A6%2C%22shape%22%3Atrue%2C%22spotlight%22%3A2%2C%22row%20guides%22%3A1%2C%22flow%20guides%22%3A0%2C%22lens%20size%22%3A0.5%2C%22magnification%22%3A10%2C%22interior%20spotlight%22%3Afalse%2C%22axes%22%3Afalse%2C%22folder%22%3A%22open%22%7D%2C%22viz%22%3A%7B%22sensitivity%22%3A%22local%22%2C%22min%20size%22%3A0.196%2C%22min%20light%22%3A0.4%2C%22max%20light%22%3A0.6%2C%22elem%20scale%22%3A1%2C%22zero%20hue%22%3A0.77%2C%22hue%20gap%22%3A0.74%2C%22hue%20spread%22%3A0.04%2C%22folder%22%3A%22open%22%7D%2C%22diag%22%3A%7B%22url%22%3A%22%22%7D%2C%22cam%22%3A%7B%22x%22%3A-54.14559417241423%2C%22y%22%3A48.55110882721702%2C%22z%22%3A37.42031544768186%2C%22target%22%3A%7B%22x%22%3A0%2C%22y%22%3A0%2C%22z%22%3A0%7D%7D%2C%22folder%22%3A%22closed%22%2C%22compress%22%3Afalse%7D)): 

<p align="center">
  <video width="100%" controls>
    <source src="/assets/videos/inside-the-matrix/vmprod3.mp4" type="video/mp4">
  </video>
</p>

Here's one more intuition builder using vector-matrix products, showing how the identity matrix functions exactly like a mirror set at a 45deg angle to both its counterargument and the result ([open in mm](https://bhosmer.github.io/mm/index.html?params=%7B%22expr%22%3A%22L%20%40%20R%22%2C%22name%22%3A%22L%20%40%20R%22%2C%22epilog%22%3A%22none%22%2C%22left%22%3A%7B%22name%22%3A%22L%22%2C%22matmul%22%3Afalse%2C%22h%22%3A24%2C%22w%22%3A24%2C%22init%22%3A%22eye%22%2C%22url%22%3A%22%22%2C%22min%22%3A-1%2C%22max%22%3A1%2C%22dropout%22%3A0%2C%22expr%22%3A%22(-Math.trunc(i%20%2F%208)%20%25%202)%20%2B%20.5%22%2C%22folder%22%3A%22open%22%7D%2C%22right%22%3A%7B%22name%22%3A%22R%22%2C%22matmul%22%3Afalse%2C%22h%22%3A24%2C%22w%22%3A32%2C%22init%22%3A%22row%20major%22%2C%22url%22%3A%22%22%2C%22min%22%3A-1%2C%22max%22%3A1%2C%22dropout%22%3A0%2C%22expr%22%3A%22(-Math.trunc(j%20%2F%208)%20%25%202)%20%2B%20.5%22%2C%22folder%22%3A%22open%22%7D%2C%22anim%22%3A%7B%22fuse%22%3A%22none%22%2C%22speed%22%3A12%2C%22hide%20inputs%22%3Afalse%2C%22alg%22%3A%22vmprod%22%2C%22spin%22%3A0%2C%22folder%22%3A%22open%22%7D%2C%22block%22%3A%7B%22i%20blocks%22%3A1%2C%22j%20blocks%22%3A1%2C%22k%20blocks%22%3A1%7D%2C%22layout%22%3A%7B%22scheme%22%3A%22blocks%22%2C%22gap%22%3A5%2C%22scatter%22%3A0%2C%22molecule%22%3A1%2C%22blast%22%3A0%2C%22polarity%22%3A%22negative%22%2C%22left%20placement%22%3A%22left%22%2C%22right%20placement%22%3A%22top%22%2C%22result%20placement%22%3A%22front%22%2C%22folder%22%3A%22open%22%7D%2C%22deco%22%3A%7B%22legends%22%3A6%2C%22shape%22%3Atrue%2C%22spotlight%22%3A2%2C%22row%20guides%22%3A1%2C%22flow%20guides%22%3A0%2C%22lens%20size%22%3A0.5%2C%22magnification%22%3A10%2C%22interior%20spotlight%22%3Afalse%2C%22axes%22%3Afalse%2C%22folder%22%3A%22open%22%7D%2C%22viz%22%3A%7B%22sensitivity%22%3A%22local%22%2C%22min%20size%22%3A0.196%2C%22min%20light%22%3A0.4%2C%22max%20light%22%3A0.6%2C%22elem%20scale%22%3A1%2C%22zero%20hue%22%3A0.77%2C%22hue%20gap%22%3A0.74%2C%22hue%20spread%22%3A0.04%2C%22folder%22%3A%22open%22%7D%2C%22diag%22%3A%7B%22url%22%3A%22%22%7D%2C%22cam%22%3A%7B%22x%22%3A-50.560896320538845%2C%22y%22%3A45.336792719337595%2C%22z%22%3A34.94291121097398%7D%2C%22folder%22%3A%22closed%22%2C%22compress%22%3Afalse%7D)): 

<p align="center">
  <video width="100%" controls>
    <source src="/assets/videos/inside-the-matrix/vmprod_id.mp4" type="video/mp4">
  </video>
</p>

### 2d Summed outer products

The third planar decomposition is along the `k` axis, computing the matmul result by a pointwise summation of vector outer products. Here we see the plane of outer products sweeping the cube "from back to front", accumulating into the result ([open in mm](https://bhosmer.github.io/mm/index.html?params=%7B%22expr%22%3A%22L%20%40%20R%22%2C%22name%22%3A%22L%20%40%20R%22%2C%22epilog%22%3A%22none%22%2C%22left%22%3A%7B%22name%22%3A%22L%22%2C%22matmul%22%3Afalse%2C%22h%22%3A32%2C%22w%22%3A24%2C%22init%22%3A%22expr%22%2C%22url%22%3A%22%22%2C%22min%22%3A-1%2C%22max%22%3A1%2C%22dropout%22%3A0%2C%22expr%22%3A%22-2%20*%20(Math.trunc(i%20%2F%208)%20%25%202)%20%2B%201%22%2C%22folder%22%3A%22closed%22%7D%2C%22right%22%3A%7B%22name%22%3A%22R%22%2C%22matmul%22%3Afalse%2C%22h%22%3A24%2C%22w%22%3A32%2C%22init%22%3A%22expr%22%2C%22url%22%3A%22%22%2C%22min%22%3A-1%2C%22max%22%3A1%2C%22dropout%22%3A0%2C%22expr%22%3A%22-2%20*%20(Math.trunc(j%20%2F%208)%20%25%202)%20%2B%201%22%2C%22folder%22%3A%22closed%22%7D%2C%22anim%22%3A%7B%22fuse%22%3A%22none%22%2C%22speed%22%3A12%2C%22hide%20inputs%22%3Afalse%2C%22alg%22%3A%22vvprod%22%2C%22spin%22%3A0%2C%22folder%22%3A%22open%22%7D%2C%22block%22%3A%7B%22i%20blocks%22%3A1%2C%22j%20blocks%22%3A1%2C%22k%20blocks%22%3A1%7D%2C%22layout%22%3A%7B%22scheme%22%3A%22blocks%22%2C%22gap%22%3A5%2C%22scatter%22%3A0%2C%22molecule%22%3A1%2C%22blast%22%3A0%2C%22polarity%22%3A%22negative%22%2C%22left%20placement%22%3A%22left%22%2C%22right%20placement%22%3A%22top%22%2C%22result%20placement%22%3A%22front%22%2C%22folder%22%3A%22open%22%7D%2C%22deco%22%3A%7B%22legends%22%3A6%2C%22shape%22%3Atrue%2C%22spotlight%22%3A2%2C%22row%20guides%22%3A1%2C%22flow%20guides%22%3A0.5%2C%22lens%20size%22%3A0.5%2C%22magnification%22%3A10%2C%22interior%20spotlight%22%3Afalse%2C%22axes%22%3Afalse%2C%22folder%22%3A%22closed%22%7D%2C%22viz%22%3A%7B%22sensitivity%22%3A%22semilocal%22%2C%22min%20size%22%3A0.196%2C%22min%20light%22%3A0.4%2C%22max%20light%22%3A0.6%2C%22elem%20scale%22%3A1%2C%22zero%20hue%22%3A0.77%2C%22hue%20gap%22%3A0.74%2C%22hue%20spread%22%3A0.04%2C%22folder%22%3A%22open%22%7D%2C%22diag%22%3A%7B%22url%22%3A%22%22%7D%2C%22cam%22%3A%7B%22x%22%3A-54.145594172414235%2C%22y%22%3A48.55110882721702%2C%22z%22%3A37.42031544768185%2C%22target%22%3A%7B%22x%22%3A0%2C%22y%22%3A0%2C%22z%22%3A0%7D%7D%2C%22folder%22%3A%22closed%22%2C%22compress%22%3Afalse%7D)): 

<p align="center">
  <video width="100%" controls>
    <source src="/assets/videos/inside-the-matrix/vvprod_check.mp4" type="video/mp4">
  </video>
</p>

Using randomly initialized matrices with this decomposition, we can see not just values but _rank_ accumulate in the result, as each rank-1 outer product is added to it. 

Among other things this builds intuition for why "low-rank factorization" - i.e. approximating a matrix by constructing a matmul whose arguments are small in the depth dimension - works best when the matrix being approximated is low rank. [LoRA](https://arxiv.org/pdf/2106.09685.pdf) in a later section ([open in mm](https://bhosmer.github.io/mm/index.html?params=%7B%22expr%22%3A%22L%20%40%20R%22%2C%22name%22%3A%22L%20%40%20R%22%2C%22epilog%22%3A%22none%22%2C%22left%22%3A%7B%22name%22%3A%22L%22%2C%22matmul%22%3Afalse%2C%22h%22%3A32%2C%22w%22%3A24%2C%22init%22%3A%22gaussian%22%2C%22url%22%3A%22%22%2C%22min%22%3A-1%2C%22max%22%3A1%2C%22dropout%22%3A0%2C%22expr%22%3A%22(-Math.trunc(i%20%2F%208)%20%25%202)%20%2B%20.5%22%2C%22folder%22%3A%22closed%22%7D%2C%22right%22%3A%7B%22name%22%3A%22R%22%2C%22matmul%22%3Afalse%2C%22h%22%3A24%2C%22w%22%3A32%2C%22init%22%3A%22gaussian%22%2C%22url%22%3A%22%22%2C%22min%22%3A-1%2C%22max%22%3A1%2C%22dropout%22%3A0%2C%22expr%22%3A%22(-Math.trunc(j%20%2F%208)%20%25%202)%20%2B%20.5%22%2C%22folder%22%3A%22closed%22%7D%2C%22anim%22%3A%7B%22fuse%22%3A%22none%22%2C%22speed%22%3A6%2C%22hide%20inputs%22%3Afalse%2C%22alg%22%3A%22vvprod%22%2C%22spin%22%3A0%2C%22folder%22%3A%22open%22%7D%2C%22block%22%3A%7B%22i%20blocks%22%3A1%2C%22j%20blocks%22%3A1%2C%22k%20blocks%22%3A1%7D%2C%22layout%22%3A%7B%22scheme%22%3A%22blocks%22%2C%22gap%22%3A5%2C%22scatter%22%3A0%2C%22molecule%22%3A1%2C%22blast%22%3A0%2C%22polarity%22%3A%22negative%22%2C%22left%20placement%22%3A%22left%22%2C%22right%20placement%22%3A%22top%22%2C%22result%20placement%22%3A%22front%22%2C%22folder%22%3A%22open%22%7D%2C%22deco%22%3A%7B%22legends%22%3A6%2C%22shape%22%3Atrue%2C%22spotlight%22%3A2%2C%22row%20guides%22%3A1%2C%22flow%20guides%22%3A0%2C%22lens%20size%22%3A0.5%2C%22magnification%22%3A10%2C%22interior%20spotlight%22%3Afalse%2C%22axes%22%3Afalse%2C%22folder%22%3A%22open%22%7D%2C%22viz%22%3A%7B%22sensitivity%22%3A%22local%22%2C%22min%20size%22%3A0.196%2C%22min%20light%22%3A0.4%2C%22max%20light%22%3A0.6%2C%22elem%20scale%22%3A1%2C%22zero%20hue%22%3A0.77%2C%22hue%20gap%22%3A0.74%2C%22hue%20spread%22%3A0.04%2C%22folder%22%3A%22open%22%7D%2C%22diag%22%3A%7B%22url%22%3A%22%22%7D%2C%22cam%22%3A%7B%22x%22%3A-54.14559417241423%2C%22y%22%3A48.55110882721702%2C%22z%22%3A37.42031544768186%2C%22target%22%3A%7B%22x%22%3A0%2C%22y%22%3A0%2C%22z%22%3A0%7D%7D%2C%22folder%22%3A%22closed%22%2C%22compress%22%3Afalse%7D)): 

<p align="center">
  <video width="100%" controls>
    <source src="/assets/videos/inside-the-matrix/vvprod_random_fast.mp4" type="video/mp4">
  </video>
</p>

## 3 Warmup - expressions

How can we extend this visualization approach to _compositions_ of matmuls? Our examples so far have all visualized a single matmul `L @ R` of some matrices `L` and `R` - what about when `L` and/or `R` are themselves matmuls, and so on transitively?

It turns out we can extend the approach nicely to compound expressions. The key rules are simple: the subexpression (child) matmul is another cube, subject to the same layout constraints as the parent, and the result face of the child is _simultaneously_ the corresponding argument face of the parent, like a covalently shared electron.

Within these constraints, we're free to arrange the faces of a child matmul however we like. Here we use the tool's default scheme, which generates alternating convex and concave cubes - this layout works well in practice to maximize use of space and minimize occlusion. (Layouts are completely customizable, however - see the [reference](https://bhosmer.github.io/mm/ref.html) for details.)

In this section we'll visualize some of the key building blocks we find in ML models, to gain fluency in the visual idiom and to see what intuitions even simple examples can give us.


### 3a Left-associative expressions

We'll look at two expressions of the form `(A @ B) @ C`, each with its own distinctive shape and character. (Note: mm adheres to the convention that matrix multiplication is left-associative and writes this simply as `A @ B @ C`.)

First we'll give `A @ B @ C` the characteristic FFN shape, in which the "hidden dimension" is wider than the "input" or "output" dimensions. (Concretely in the context of this example, this means that the width of `B` is greater than the widths of `A` or `C`.)

As in the single matmul examples, the floating arrows point towards the result matrix, blue vane coming from the left argument and red vane from right argument ([open in mm](https://bhosmer.github.io/mm/index.html?0=A%20%40%20B%20%40%20C&1=A%20%40%20B%20%40%20C&2=none&12=closed&64=true&3.1=A%20%40%20B&3.4=true&3.5=32&3.6=32&3.7=row%20major&3.8=&3.9=-1&3.10=1&3.11=0&3.12=open&3.2=none&13.1=A&13.4=false&13.5=64&13.6=32&13.7=expr&13.8=&13.0=-2%20*%20(Math.trunc(i%20%2F%208)%20%25%202)%20%2B%201&13.9=-1&13.10=1&13.11=0&13.12=open&14.1=B&14.4=false&14.5=32&14.6=96&14.7=row%20major&14.8=&14.0=-2%20*%20(Math.trunc(j%20%2F%208)%20%25%202)%20%2B%201&14.9=-1&14.10=1&14.11=0&14.12=open&15.16=inherit&17.18=positive&17.19=left&17.20=bottom&17.21=back&22.23=1&24.1=C&24.4=false&24.5=96&24.6=32&24.7=col%20major&24.8=&24.9=-1&24.10=1&24.11=0&24.0=-2%20*%20(Math.trunc(i%20%2F%208)%20%25%202)%20%2B%201&24.12=open&25.26=none&25.27=12&25.28=false&25.16=none&25.29=0&25.12=closed&30.31=1&30.32=1&30.23=1&33.34=blocks&33.35=5&33.36=0&33.37=1&33.38=0&33.18=negative&33.19=left&33.20=top&33.21=front&33.12=closed&39.40=6&39.41=true&39.42=2&39.43=1&39.44=0.5&39.45=0.5&39.46=10&39.47=false&39.48=false&39.12=open&49.50=semilocal&49.51=0.2&49.52=0.4&49.53=0.6&49.54=1.25&49.55=0.77&49.56=0.74&49.57=0.04&49.12=open&58.8=&59.60=-102.42301073851515&59.61=96.27580041479706&59.62=112.34410815468306&63.60=-4.617417891034972&63.61=-3.695553245058398&63.62=-1.8863985145585351&expr=0&name=1&epilog=2&left=3&matmul=4&h=5&w=6&init=7&url=8&min=9&max=10&dropout=11&folder=12&left.left=13&left.right=14&left.anim=15&alg=16&left.layout=17&polarity=18&left%20placement=19&right%20placement=20&result%20placement=21&left.block=22&k%20blocks=23&right=24&anim=25&fuse=26&speed=27&hide%20inputs=28&spin=29&block=30&i%20blocks=31&j%20blocks=32&layout=33&scheme=34&gap=35&scatter=36&molecule=37&blast=38&deco=39&legends=40&shape=41&spotlight=42&row%20guides=43&flow%20guides=44&lens%20size=45&magnification=46&interior%20spotlight=47&axes=48&viz=49&sensitivity=50&min%20size=51&min%20light=52&max%20light=53&elem%20scale=54&zero%20hue=55&hue%20gap=56&hue%20spread=57&diag=58&cam=59&x=60&y=61&z=62&cam.target=63&compress=64)):


![As in the single matmul examples, the floating arrows point towards the result matrix, blue vane coming from the left argument and red vane from right argument](/assets/images/inside-the-matrix/la2still.jpg){:style="width:100%"}



Next we'll visualize `A @ B @ C` with the width of `B` _narrower_ than that of `A` or `C`, giving it a bottleneck or "autoencoder" shape ([open in mm](https://bhosmer.github.io/mm/index.html?0=A%20%40%20B%20%40%20C&1=A%20%40%20B%20%40%20C&2=none&12=closed&64=true&3.1=A%20%40%20B&3.4=true&3.5=32&3.6=32&3.7=row%20major&3.8=&3.9=-1&3.10=1&3.11=0&3.12=open&3.2=none&13.1=A&13.4=false&13.5=64&13.6=96&13.7=expr&13.8=&13.0=-2%20*%20(Math.trunc(i%20%2F%208)%20%25%202)%20%2B%201&13.9=-1&13.10=1&13.11=0&13.12=open&14.1=B&14.4=false&14.5=96&14.6=32&14.7=row%20major&14.8=&14.0=-2%20*%20(Math.trunc(j%20%2F%208)%20%25%202)%20%2B%201&14.9=-1&14.10=1&14.11=0&14.12=open&15.16=inherit&17.18=positive&17.19=left&17.20=bottom&17.21=back&22.23=1&24.1=C&24.4=false&24.5=32&24.6=96&24.7=col%20major&24.8=&24.9=-1&24.10=1&24.11=0&24.0=-2%20*%20(Math.trunc(i%20%2F%208)%20%25%202)%20%2B%201&24.12=open&25.26=none&25.27=12&25.28=false&25.16=none&25.29=0&25.12=closed&30.31=1&30.32=1&30.23=1&33.34=blocks&33.35=5&33.36=0&33.37=1&33.38=0&33.18=negative&33.19=left&33.20=top&33.21=front&33.12=closed&39.40=6&39.41=true&39.42=2&39.43=1&39.44=0.5&39.45=0.5&39.46=10&39.47=false&39.48=false&39.12=open&49.50=semilocal&49.51=0.2&49.52=0.4&49.53=0.6&49.54=1.25&49.55=0.77&49.56=0.74&49.57=0.04&49.12=open&58.8=&59.60=-125.71162036288077&59.61=101.84279252909485&59.62=122.50425255743914&63.60=-14.817097084822203&63.61=-9.723209466639396&63.62=-5.4699873376955646&expr=0&name=1&epilog=2&left=3&matmul=4&h=5&w=6&init=7&url=8&min=9&max=10&dropout=11&folder=12&left.left=13&left.right=14&left.anim=15&alg=16&left.layout=17&polarity=18&left%20placement=19&right%20placement=20&result%20placement=21&left.block=22&k%20blocks=23&right=24&anim=25&fuse=26&speed=27&hide%20inputs=28&spin=29&block=30&i%20blocks=31&j%20blocks=32&layout=33&scheme=34&gap=35&scatter=36&molecule=37&blast=38&deco=39&legends=40&shape=41&spotlight=42&row%20guides=43&flow%20guides=44&lens%20size=45&magnification=46&interior%20spotlight=47&axes=48&viz=49&sensitivity=50&min%20size=51&min%20light=52&max%20light=53&elem%20scale=54&zero%20hue=55&hue%20gap=56&hue%20spread=57&diag=58&cam=59&x=60&y=61&z=62&cam.target=63&compress=64)):


![visualize A @ B @ C with the width of B narrower than that of A or C](/assets/images/inside-the-matrix/lacontract.jpg){:style="width:100%"}



This pattern of alternating convex and concave blocks extends to chains of arbitrary length: for example this multilayer bottleneck ([open in mm](https://bhosmer.github.io/mm/index.html?0=A%20%40%20B%20%40%20C%20%40%20D%20%40%20E&1=A%20%40%20B%20%40%20C%20%40%20D%20%40%20E&2=none&23=closed&63=true&3.2=none&4.5=inherit&6.7=1&8.9=positive&8.10=left&8.11=bottom&8.12=back&13.0=A%20%40%20B%20%40%20C%20%40%20D%20%40%20E&13.1=A%20%40%20B%20%40%20C&13.2=none&14.1=A%20%40%20B&14.15=true&14.16=32&14.17=32&14.18=row%20major&14.19=&14.20=-1&14.21=1&14.22=0&14.23=open&14.2=none&24.1=A&24.15=false&24.16=64&24.17=96&24.18=expr&24.19=&24.0=-2%20*%20(Math.trunc(i%20%2F%208)%20%25%202)%20%2B%201&24.20=-1&24.21=1&24.22=0&24.23=open&25.1=B&25.15=false&25.16=96&25.17=64&25.18=row%20major&25.19=&25.0=-2%20*%20(Math.trunc(j%20%2F%208)%20%25%202)%20%2B%201&25.20=-1&25.21=1&25.22=0&25.23=open&26.5=inherit&27.9=positive&27.10=left&27.11=bottom&27.12=back&28.7=1&29.1=C&29.15=false&29.16=64&29.17=32&29.18=col%20major&29.19=&29.20=-1&29.21=1&29.22=0&29.0=-2%20*%20(Math.trunc(i%20%2F%208)%20%25%202)%20%2B%201&29.23=open&30.31=none&30.32=12&30.33=false&30.5=none&30.34=0&30.23=closed&35.36=1&35.7=1&37.9=negative&37.10=left&37.11=top&37.12=front&38.39=6&38.40=true&38.41=2&38.42=1&38.43=0.5&38.44=0.5&38.45=10&38.46=false&38.47=false&38.23=open&48.49=semilocal&48.50=0.2&48.51=0.4&48.52=0.6&48.53=1.25&48.54=0.77&48.55=0.74&48.56=0.04&48.23=open&57.19=&58.59=-125.71162036288077&58.60=101.84279252909485&58.61=122.50425255743914&62.59=-14.817097084822203&62.60=-9.723209466639396&62.61=-5.4699873376955646&13.23=open&13.63=true&13.15=true&64.1=D&64.15=false&64.16=32&64.17=64&64.18=col%20major&64.19=&64.20=-1&64.21=1&64.22=0&64.0=&64.23=open&3.1=A%20%40%20B%20%40%20C%20%40%20D&3.15=true&65.1=E&65.15=false&65.16=64&65.17=96&65.18=col%20major&65.19=&65.20=-1&65.21=1&65.22=0&65.0=&66.31=none&66.32=12&66.33=false&66.5=none&66.34=0&66.23=closed&67.36=1&67.68=1&67.7=1&69.70=blocks&69.71=5&69.72=0&69.73=1&69.74=0&69.9=negative&69.10=left&69.11=top&69.12=front&69.23=closed&75.39=5.28&75.40=true&75.41=2&75.42=1&75.43=0.5&75.44=0.5&75.45=10&75.46=false&75.47=false&75.23=open&76.49=semilocal&76.50=0.2&76.51=0.4&76.52=0.6&76.53=1.25&76.54=0.77&76.55=0.74&76.56=0.04&76.23=open&77.19=&78.59=-163.23429720087873&78.60=132.20892347209139&78.61=159.04014894666057&79.59=-14.817097084822203&79.60=-9.723209466639396&79.61=-5.4699873376955646&expr=0&name=1&epilog=2&left=3&left.anim=4&alg=5&left.block=6&k%20blocks=7&left.layout=8&polarity=9&left%20placement=10&right%20placement=11&result%20placement=12&left.left=13&left.left.left=14&matmul=15&h=16&w=17&init=18&url=19&min=20&max=21&dropout=22&folder=23&left.left.left.left=24&left.left.left.right=25&left.left.left.anim=26&left.left.left.layout=27&left.left.left.block=28&left.left.right=29&left.left.anim=30&fuse=31&speed=32&hide%20inputs=33&spin=34&left.left.block=35&i%20blocks=36&left.left.layout=37&left.left.deco=38&legends=39&shape=40&spotlight=41&row%20guides=42&flow%20guides=43&lens%20size=44&magnification=45&interior%20spotlight=46&axes=47&left.left.viz=48&sensitivity=49&min%20size=50&min%20light=51&max%20light=52&elem%20scale=53&zero%20hue=54&hue%20gap=55&hue%20spread=56&left.left.diag=57&left.left.cam=58&x=59&y=60&z=61&left.left.cam.target=62&compress=63&left.right=64&right=65&anim=66&block=67&j%20blocks=68&layout=69&scheme=70&gap=71&scatter=72&molecule=73&blast=74&deco=75&viz=76&diag=77&cam=78&cam.target=79)):


![pattern of alternating convex and concave blocks extends to chains of arbitrary length](/assets/images/inside-the-matrix/nlayerbottleneck.jpg){:style="width:100%"}




### 3b Right associative expressions

Next we'll visualize a right-associative expression `A @ (B @ C)`.

In the same way left-associative expressions extend horizontally - sprouting from the left argument of the root expression, so to speak - right-associative chains extend vertically, sprouting from the root's right argument.

One sometimes sees an MLP formulated right-associatively, i.e. with columnar input on the right and weight layers running right to left. Using the matrices from the 2-layer FFN example pictured above - suitably transposed - here's what that looks like, with `C` now playing the role of the input, `B` the first layer and `A` the second layer ([open in mm](https://bhosmer.github.io/mm/index.html?0=A%20%40%20(B%20%40%20C)&1=A%20%40%20(B%20%40%20C)&2=none&12=closed&64=true&3.1=A&3.4=false&3.5=32&3.6=96&3.7=row%20major&3.8=&3.9=-1&3.10=1&3.11=0&3.0=-2%20*%20(Math.trunc(j%20%2F%208)%20%25%202)%20%2B%201&3.12=open&13.1=B%20%40%20C&13.4=true&13.5=32&13.6=32&13.7=col%20major&13.8=&13.9=-1&13.10=1&13.11=0&13.2=none&14.15=inherit&16.17=1&18.19=positive&18.20=right&18.21=top&18.22=back&23.1=B&23.4=false&23.5=96&23.6=32&23.7=col%20major&23.8=&23.0=-2%20*%20(Math.trunc(j%20%2F%208)%20%25%202)%20%2B%201&23.9=-1&23.10=1&23.11=0&23.12=open&24.1=C&24.4=false&24.5=32&24.6=64&24.7=expr&24.8=&24.0=-2%20*%20(Math.trunc(j%20%2F%208)%20%25%202)%20%2B%201&24.9=-1&24.10=1&24.11=0&24.12=open&13.12=open&25.26=none&25.27=12&25.28=false&25.15=none&25.29=0&25.12=closed&30.31=1&30.32=1&30.17=1&33.34=blocks&33.35=5&33.36=0&33.37=1&33.38=0&33.19=negative&33.20=left&33.21=top&33.22=front&33.12=closed&39.40=6&39.41=true&39.42=2&39.43=1&39.44=0.5&39.45=0.5&39.46=10&39.47=false&39.48=false&39.12=closed&49.50=semilocal&49.51=0.2&49.52=0.4&49.53=0.6&49.54=1.25&49.55=0.77&49.56=0.74&49.57=0.04&49.12=closed&58.8=&58.12=open&59.60=-105.78213185291946&59.61=96.67420268229331&59.62=113.6419504179439&63.60=-4.617417891034972&63.61=-3.695553245058398&63.62=-1.8863985145585351&expr=0&name=1&epilog=2&left=3&matmul=4&h=5&w=6&init=7&url=8&min=9&max=10&dropout=11&folder=12&right=13&right.anim=14&alg=15&right.block=16&k%20blocks=17&right.layout=18&polarity=19&left%20placement=20&right%20placement=21&result%20placement=22&right.left=23&right.right=24&anim=25&fuse=26&speed=27&hide%20inputs=28&spin=29&block=30&i%20blocks=31&j%20blocks=32&layout=33&scheme=34&gap=35&scatter=36&molecule=37&blast=38&deco=39&legends=40&shape=41&spotlight=42&row%20guides=43&flow%20guides=44&lens%20size=45&magnification=46&interior%20spotlight=47&axes=48&viz=49&sensitivity=50&min%20size=51&min%20light=52&max%20light=53&elem%20scale=54&zero%20hue=55&hue%20gap=56&hue%20spread=57&diag=58&cam=59&x=60&y=61&z=62&cam.target=63&compress=64)):


![an MLP formulated right-associatively](/assets/images/inside-the-matrix/raffn.jpg){:style="width:100%"}



Aside: in addition to the color of the arrow vanes (blue for left, red for right), a second visual cue for distinguishing left and right arguments is their _orientation_: the rows of the left argument are coplanar with those of the result - they stack along the same axis (`i`). Both cues tell us for example that `B` is the left argument to `(B @ C)` above.


### 3c Binary expressions

For a visualization tool to be useful beyond simple didactic examples, visualizations need to remain legible as expressions get more complicated. A key structural component in real-world use cases is binary expressions - matmuls with subexpressions on both the left and right.

Here we'll visualize the simplest such expression shape, `(A @ B) @ (C @ D)` ([open in mm](https://bhosmer.github.io/mm/index.html?0=A%20%40%20B%20%40%20(C%20%40%20D)&1=A%20%40%20B%20%40%20(C%20%40%20D)&2=none&12=closed&69=true&3.1=A%20%40%20B&3.4=true&3.5=32&3.6=32&3.7=row%20major&3.8=&3.9=-1&3.10=1&3.11=0&3.12=open&3.2=none&13.1=A&13.4=false&13.5=64&13.6=64&13.7=expr&13.8=&13.0=-2%20*%20(Math.trunc(i%20%2F%208)%20%25%202)%20%2B%201&13.9=-1&13.10=1&13.11=0&13.12=closed&14.1=B&14.4=false&14.5=64&14.6=64&14.7=row%20major&14.8=&14.0=-2%20*%20(Math.trunc(j%20%2F%208)%20%25%202)%20%2B%201&14.9=-1&14.10=1&14.11=0&14.12=closed&15.16=inherit&17.18=positive&17.19=left&17.20=bottom&17.21=back&22.23=1&24.1=C%20%40%20D&24.4=true&24.5=32&24.6=32&24.7=col%20major&24.8=&24.9=-1&24.10=1&24.11=0&24.2=none&25.16=inherit&26.23=1&27.18=positive&27.19=right&27.20=top&27.21=back&28.1=C&28.4=false&28.5=64&28.6=64&28.7=col%20major&28.8=&28.9=-1&28.10=1&28.11=0&28.0=-2%20*%20(Math.trunc(i%20%2F%208)%20%25%202)%20%2B%201&28.12=open&29.1=D&29.4=false&29.5=64&29.6=64&29.7=expr&29.8=&29.9=-1&29.10=1&29.11=0&29.0=-2%20*%20(Math.trunc(j%20%2F%208)%20%25%202)%20%2B%201&29.12=open&30.31=none&30.32=12&30.33=false&30.16=none&30.34=0&30.12=closed&35.36=1&35.37=1&35.23=1&38.39=blocks&38.40=5&38.41=0&38.42=1&38.43=0&38.18=negative&38.19=left&38.20=top&38.21=front&38.12=closed&44.45=6&44.46=true&44.47=2&44.48=1&44.49=0.5&44.50=0.5&44.51=10&44.52=false&44.53=false&44.12=closed&54.55=semilocal&54.56=0.4&54.57=0.4&54.58=0.6&54.59=1.5&54.60=0.77&54.61=0.74&54.62=0.04&54.12=open&63.8=&64.65=-149.45958189074523&64.66=140.76437147298853&64.67=162.13832534246401&68.65=-4.044017278625395&68.66=-2.123834827920271&68.67=-2.551083969824457&expr=0&name=1&epilog=2&left=3&matmul=4&h=5&w=6&init=7&url=8&min=9&max=10&dropout=11&folder=12&left.left=13&left.right=14&left.anim=15&alg=16&left.layout=17&polarity=18&left%20placement=19&right%20placement=20&result%20placement=21&left.block=22&k%20blocks=23&right=24&right.anim=25&right.block=26&right.layout=27&right.left=28&right.right=29&anim=30&fuse=31&speed=32&hide%20inputs=33&spin=34&block=35&i%20blocks=36&j%20blocks=37&layout=38&scheme=39&gap=40&scatter=41&molecule=42&blast=43&deco=44&legends=45&shape=46&spotlight=47&row%20guides=48&flow%20guides=49&lens%20size=50&magnification=51&interior%20spotlight=52&axes=53&viz=54&sensitivity=55&min%20size=56&min%20light=57&max%20light=58&elem%20scale=59&zero%20hue=60&hue%20gap=61&hue%20spread=62&diag=63&cam=64&x=65&y=66&z=67&cam.target=68&compress=69)):

![binary expressions - matmuls with subexpressions on both the left and right](/assets/images/inside-the-matrix/binary4.jpg){:style="width:100%"}




### 3d Quick aside: partitioning and parallelism

A full presentation of this topic is out of scope for this note, though we'll see it in action later in the context of attention heads. But as a warmup, two quick examples should give a sense of how this style of visualization makes reasoning about parallelizing compound expressions very intuitive, via the simple geometry of partitioning.

In the first example we'll apply the canonical "data parallel" partitioning to the left-associative multilayer bottleneck example above. We partition along `i`, segmenting the initial left argument ("batch") and all intermediate results ("activations"), but none of the subsequent arguments ("weights") - the geometry making it obvious which participants in the expression are segmented and which remain whole ([open in mm](https://bhosmer.github.io/mm/index.html?0=A%20%40%20B%20%40%20C%20%40%20D%20%40%20E&1=A%20%40%20B%20%40%20C%20%40%20D%20%40%20E&2=none&23=closed&63=true&3.1=A%20%40%20B%20%40%20C%20%40%20D&3.4=true&3.5=32&3.6=32&3.7=row%20major&3.8=&3.9=-1&3.10=1&3.11=0&3.2=none&12.13=inherit&14.15=1&16.17=positive&16.18=left&16.19=bottom&16.20=back&21.0=A%20%40%20B%20%40%20C%20%40%20D%20%40%20E&21.1=A%20%40%20B%20%40%20C&21.2=none&22.1=A%20%40%20B&22.4=true&22.5=32&22.6=32&22.7=row%20major&22.8=&22.9=-1&22.10=1&22.11=0&22.23=open&22.2=none&24.1=A&24.4=false&24.5=64&24.6=96&24.7=expr&24.8=&24.0=-2%20*%20(Math.trunc(i%20%2F%208)%20%25%202)%20%2B%201&24.9=-1&24.10=1&24.11=0&24.23=open&25.1=B&25.4=false&25.5=96&25.6=64&25.7=row%20major&25.8=&25.0=-2%20*%20(Math.trunc(j%20%2F%208)%20%25%202)%20%2B%201&25.9=-1&25.10=1&25.11=0&25.23=open&26.13=inherit&27.17=positive&27.18=left&27.19=bottom&27.20=back&28.15=1&29.1=C&29.4=false&29.5=64&29.6=32&29.7=col%20major&29.8=&29.9=-1&29.10=1&29.11=0&29.0=-2%20*%20(Math.trunc(i%20%2F%208)%20%25%202)%20%2B%201&29.23=open&30.31=none&30.32=12&30.33=false&30.13=none&30.34=0&30.23=closed&35.36=1&35.15=1&37.17=negative&37.18=left&37.19=top&37.20=front&38.39=6&38.40=true&38.41=2&38.42=1&38.43=0.5&38.44=0.5&38.45=10&38.46=false&38.47=false&38.23=open&48.49=semilocal&48.50=0.2&48.51=0.4&48.52=0.6&48.53=1.25&48.54=0.77&48.55=0.74&48.56=0.04&48.23=open&57.8=&58.59=-125.71162036288077&58.60=101.84279252909485&58.61=122.50425255743914&62.59=-14.817097084822203&62.60=-9.723209466639396&62.61=-5.4699873376955646&21.23=open&21.63=true&21.4=true&64.1=D&64.4=false&64.5=32&64.6=64&64.7=col%20major&64.8=&64.9=-1&64.10=1&64.11=0&64.0=&64.23=open&65.1=E&65.4=false&65.5=64&65.6=96&65.7=col%20major&65.8=&65.9=-1&65.10=1&65.11=0&65.0=&66.31=none&66.32=12&66.33=false&66.13=none&66.34=0&66.23=closed&67.36=8&67.68=1&67.15=1&67.23=open&69.70=blocks&69.71=5&69.72=0&69.73=1&69.74=0&69.17=negative&69.18=left&69.19=top&69.20=front&69.23=closed&75.39=5.28&75.40=true&75.41=2&75.42=1&75.43=0.5&75.44=0.5&75.45=10&75.46=false&75.47=false&75.23=closed&76.49=semilocal&76.50=0.3&76.51=0.4&76.52=0.6&76.53=1.5&76.54=0.77&76.55=0.74&76.56=0.04&76.23=closed&77.8=&78.59=-174.76129648411032&78.60=141.54502619212317&78.61=170.2709730709386&79.59=-14.817097084822203&79.60=-9.723209466639396&79.61=-5.4699873376955646&expr=0&name=1&epilog=2&left=3&matmul=4&h=5&w=6&init=7&url=8&min=9&max=10&dropout=11&left.anim=12&alg=13&left.block=14&k%20blocks=15&left.layout=16&polarity=17&left%20placement=18&right%20placement=19&result%20placement=20&left.left=21&left.left.left=22&folder=23&left.left.left.left=24&left.left.left.right=25&left.left.left.anim=26&left.left.left.layout=27&left.left.left.block=28&left.left.right=29&left.left.anim=30&fuse=31&speed=32&hide%20inputs=33&spin=34&left.left.block=35&i%20blocks=36&left.left.layout=37&left.left.deco=38&legends=39&shape=40&spotlight=41&row%20guides=42&flow%20guides=43&lens%20size=44&magnification=45&interior%20spotlight=46&axes=47&left.left.viz=48&sensitivity=49&min%20size=50&min%20light=51&max%20light=52&elem%20scale=53&zero%20hue=54&hue%20gap=55&hue%20spread=56&left.left.diag=57&left.left.cam=58&x=59&y=60&z=61&left.left.cam.target=62&compress=63&left.right=64&right=65&anim=66&block=67&j%20blocks=68&layout=69&scheme=70&gap=71&scatter=72&molecule=73&blast=74&deco=75&viz=76&diag=77&cam=78&cam.target=79)):


![the canonical "data parallel" partitioning to the left-associative multilayer bottleneck example](/assets/images/inside-the-matrix/bottleneck_part.jpg){:style="width:100%"}



The second example would (for me, anyway) be much harder to build intuition about without clear geometry to support it: it shows how a binary expression can be parallelized by partitioning the left subexpression along its `j` axis, the right subexpression along its `i` axis, and the parent expression along its `k` axis ([open in mm](https://bhosmer.github.io/mm/index.html?0=A%20%40%20B%20%40%20(C%20%40%20D)&1=A%20%40%20B%20%40%20(C%20%40%20D)&2=none&12=closed&69=true&3.1=A%20%40%20B&3.4=true&3.5=32&3.6=32&3.7=row%20major&3.8=&3.9=-1&3.10=1&3.11=0&3.12=open&3.2=none&13.1=A&13.4=false&13.5=64&13.6=64&13.7=expr&13.8=&13.0=-2%20*%20(Math.trunc(i%20%2F%208)%20%25%202)%20%2B%201&13.9=-1&13.10=1&13.11=0&13.12=closed&14.1=B&14.4=false&14.5=64&14.6=64&14.7=row%20major&14.8=&14.0=-2%20*%20(Math.trunc(j%20%2F%208)%20%25%202)%20%2B%201&14.9=-1&14.10=1&14.11=0&14.12=closed&15.16=inherit&17.18=positive&17.19=left&17.20=bottom&17.21=back&22.23=1&24.1=C%20%40%20D&24.4=true&24.5=32&24.6=32&24.7=col%20major&24.8=&24.9=-1&24.10=1&24.11=0&24.2=none&25.16=inherit&26.23=1&27.18=positive&27.19=right&27.20=top&27.21=back&28.1=C&28.4=false&28.5=64&28.6=64&28.7=col%20major&28.8=&28.9=-1&28.10=1&28.11=0&28.0=-2%20*%20(Math.trunc(i%20%2F%208)%20%25%202)%20%2B%201&28.12=open&29.1=D&29.4=false&29.5=64&29.6=64&29.7=expr&29.8=&29.9=-1&29.10=1&29.11=0&29.0=-2%20*%20(Math.trunc(j%20%2F%208)%20%25%202)%20%2B%201&29.12=open&30.31=none&30.32=12&30.33=false&30.16=none&30.34=0&30.12=closed&35.36=1&35.37=1&35.23=8&35.12=open&38.39=blocks&38.40=5&38.41=0&38.42=1&38.43=0&38.18=negative&38.19=left&38.20=top&38.21=front&38.12=closed&44.45=6&44.46=true&44.47=2&44.48=1&44.49=0.5&44.50=0.5&44.51=10&44.52=false&44.53=false&44.12=closed&54.55=semilocal&54.56=0.4&54.57=0.4&54.58=0.6&54.59=1.5&54.60=0.77&54.61=0.74&54.62=0.04&54.12=open&63.8=&64.65=-163.0431410622342&64.66=153.55767080483412&64.67=176.87418575632128&68.65=-4.044017278625395&68.66=-2.123834827920271&68.67=-2.551083969824457&expr=0&name=1&epilog=2&left=3&matmul=4&h=5&w=6&init=7&url=8&min=9&max=10&dropout=11&folder=12&left.left=13&left.right=14&left.anim=15&alg=16&left.layout=17&polarity=18&left%20placement=19&right%20placement=20&result%20placement=21&left.block=22&k%20blocks=23&right=24&right.anim=25&right.block=26&right.layout=27&right.left=28&right.right=29&anim=30&fuse=31&speed=32&hide%20inputs=33&spin=34&block=35&i%20blocks=36&j%20blocks=37&layout=38&scheme=39&gap=40&scatter=41&molecule=42&blast=43&deco=44&legends=45&shape=46&spotlight=47&row%20guides=48&flow%20guides=49&lens%20size=50&magnification=51&interior%20spotlight=52&axes=53&viz=54&sensitivity=55&min%20size=56&min%20light=57&max%20light=58&elem%20scale=59&zero%20hue=60&hue%20gap=61&hue%20spread=62&diag=63&cam=64&x=65&y=66&z=67&cam.target=68&compress=69)):


![a binary expression can be parallelized by partitioning the left subexpression along its j axis, the right subexpression along its i axis, and the parent expression along its k axis](/assets/images/inside-the-matrix/binary_part.jpg){:style="width:100%"}



## 4 Inside an Attention Head

Let's look at a GPT2 attention head - specifically layer 5, head 4 of the "gpt2" (small) configuration (layers=12, heads=12, embed=768) from [NanoGPT](https://github.com/karpathy/nanoGPT), using OpenAI weights via HuggingFace. Input activations are taken from a forward pass on an OpenWebText training sample of 256 tokens.

There's nothing particularly unusual about this particular head; I chose it mainly because it computes a fairly common attention pattern and lives in the middle of the model, where activations have become structured and show some interesting texture. (Aside: in a subsequent note I'll present an attention head explorer that lets you visualize all layers and heads of this model, along with some travel notes.)

[Open in mm](https://bhosmer.github.io/mm/index.html?0=out%20%3D%20(attn%20%3D%20(Q%20%3D%20input%20%40%20wQ)%20%40%20(K_t%20%3D%20wK_t%20%40%20input_t))%20%40%20(V%20%3D%20input%20%40%20wV)%20%40%20wO&1=out&2=none&49=closed&84=true&3.1=attn%20%40%20V&3.4=true&3.5=32&3.6=32&3.7=row%20major&3.8=&3.9=-1&3.10=1&3.11=0&3.2=none&12.13=vmprod&14.15=1&16.17=positive&16.18=left&16.19=bottom&16.20=back&21.1=attn&21.4=true&21.2=softmax(tril(x%2Fsqrt(k)))&22.1=Q&22.4=true&22.2=none&23.1=input&23.4=false&23.5=256&23.6=768&23.7=url&23.9=-1&23.10=1&23.11=0&23.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input0_256_768.csv&23.0=&24.1=wQ&24.4=false&24.5=768&24.6=64&24.7=url&24.9=-1&24.10=1&24.11=0&24.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wq4_768_64.csv&24.0=&25.13=vmprod&26.15=1&27.17=positive&27.18=left&27.19=bottom&27.20=back&28.2=none&29.13=none&30.15=1&31.17=positive&31.18=right&31.19=top&31.20=back&32.1=wK_t&32.4=false&32.5=64&32.6=768&32.7=url&32.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wk_t4_64_768.csv&32.9=-1&32.10=1&32.11=0&32.0=&33.1=input_t&33.4=false&33.5=768&33.6=256&33.7=url&33.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input_t0_768_256.csv&33.9=-1&33.10=1&33.11=0&33.0=&28.1=K_t&28.4=true&34.13=vmprod&35.15=1&36.17=negative&36.18=left&36.19=top&36.20=front&37.1=V&37.4=true&37.2=none&38.1=input&38.4=false&38.5=256&38.6=768&38.7=url&38.9=-1&38.10=1&38.11=0&38.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input0_256_768.csv&38.0=&39.1=wV&39.4=false&39.5=768&39.6=64&39.7=url&39.9=-1&39.10=1&39.11=0&39.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wv4_768_64.csv&39.0=&40.13=none&41.15=1&42.17=negative&42.18=right&42.19=top&42.20=back&43.1=wO&43.4=false&43.5=64&43.6=768&43.7=url&43.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wo4_64_768.csv&43.9=-1&43.10=1&43.11=0&43.0=&44.45=sync&44.46=16&44.47=false&44.13=none&44.48=0&44.49=open&50.51=1&50.52=1&50.15=1&53.54=blocks&53.55=10&53.56=0&53.57=1&53.58=0&53.17=negative&53.18=left&53.19=top&53.20=front&53.49=open&59.60=10&59.61=true&59.62=4&59.63=0.394&59.64=0.655&59.65=0.5&59.66=12&59.67=false&59.68=false&59.49=open&69.70=local&69.71=0.2&69.72=0.2&69.73=0.9&69.74=2&69.75=0.75&69.76=0.75&69.77=0.03&69.49=closed&78.8=&78.49=closed&79.80=-1149.3128801149742&79.81=1143.004532598807&79.82=1754.3660479535383&83.80=-6.708919569777563&83.81=75.05036284609801&83.82=-216.66743330111652&expr=0&name=1&epilog=2&left=3&matmul=4&h=5&w=6&init=7&url=8&min=9&max=10&dropout=11&left.anim=12&alg=13&left.block=14&k%20blocks=15&left.layout=16&polarity=17&left%20placement=18&right%20placement=19&result%20placement=20&left.left=21&left.left.left=22&left.left.left.left=23&left.left.left.right=24&left.left.left.anim=25&left.left.left.block=26&left.left.left.layout=27&left.left.right=28&left.left.right.anim=29&left.left.right.block=30&left.left.right.layout=31&left.left.right.left=32&left.left.right.right=33&left.left.anim=34&left.left.block=35&left.left.layout=36&left.right=37&left.right.left=38&left.right.right=39&left.right.anim=40&left.right.block=41&left.right.layout=42&right=43&anim=44&fuse=45&speed=46&hide%20inputs=47&spin=48&folder=49&block=50&i%20blocks=51&j%20blocks=52&layout=53&scheme=54&gap=55&scatter=56&molecule=57&blast=58&deco=59&legends=60&shape=61&spotlight=62&row%20guides=63&flow%20guides=64&lens%20size=65&magnification=66&interior%20spotlight=67&axes=68&viz=69&sensitivity=70&min%20size=71&min%20light=72&max%20light=73&elem%20scale=74&zero%20hue=75&hue%20gap=76&hue%20spread=77&diag=78&cam=79&x=80&y=81&z=82&cam.target=83&compress=84) (may take a few seconds to fetch model weights)

![There's nothing particularly unusual about this particular head](/assets/images/inside-the-matrix/mha1.jpg){:style="width:100%"}




### 4a Structure

The entire attention head is visualized as a single compound expression, starting with input and ending with projected output. (Note: to keep things self-contained we do per-head output projection as described in [Megatron-LM](https://arxiv.org/pdf/1909.08053.pdf).)

The computation contains six matmuls:

```
Q = input @ wQ        // 1
K_t = wK_t @ input_t  // 2
V = input @ wV        // 3
attn = sdpa(Q @ K_t)  // 4
head_out = attn @ V   // 5
out = head_out @ wO   // 6
```

A thumbnail description of what we're looking at:



* the blades of the windmill are matmuls 1, 2, 3 and 6: the former group are the in-projections from input to Q, K and V; the latter is the out-projection from attn @ V back to the embedding dimension.
* at the hub is the double matmul that first calculates attention scores (convex cube in back), then uses them to produce output tokens from the values vector (concave cube in front). Causality means that the attention scores form a lower triangle.

But I'd encourage [exploring this example in the tool itself](https://bhosmer.github.io/mm/index.html?0=out%20%3D%20(attn%20%3D%20(Q%20%3D%20input%20%40%20wQ)%20%40%20(K_t%20%3D%20wK_t%20%40%20input_t))%20%40%20(V%20%3D%20input%20%40%20wV)%20%40%20wO&1=out&2=none&49=closed&84=true&3.1=attn%20%40%20V&3.4=true&3.5=32&3.6=32&3.7=row%20major&3.8=&3.9=-1&3.10=1&3.11=0&3.2=none&12.13=vmprod&14.15=1&16.17=positive&16.18=left&16.19=bottom&16.20=back&21.1=attn&21.4=true&21.2=softmax(tril(x%2Fsqrt(k)))&22.1=Q&22.4=true&22.2=none&23.1=input&23.4=false&23.5=256&23.6=768&23.7=url&23.9=-1&23.10=1&23.11=0&23.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input0_256_768.csv&23.0=&24.1=wQ&24.4=false&24.5=768&24.6=64&24.7=url&24.9=-1&24.10=1&24.11=0&24.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wq4_768_64.csv&24.0=&25.13=vmprod&26.15=1&27.17=positive&27.18=left&27.19=bottom&27.20=back&28.2=none&29.13=none&30.15=1&31.17=positive&31.18=right&31.19=top&31.20=back&32.1=wK_t&32.4=false&32.5=64&32.6=768&32.7=url&32.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wk_t4_64_768.csv&32.9=-1&32.10=1&32.11=0&32.0=&33.1=input_t&33.4=false&33.5=768&33.6=256&33.7=url&33.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input_t0_768_256.csv&33.9=-1&33.10=1&33.11=0&33.0=&28.1=K_t&28.4=true&34.13=vmprod&35.15=1&36.17=negative&36.18=left&36.19=top&36.20=front&37.1=V&37.4=true&37.2=none&38.1=input&38.4=false&38.5=256&38.6=768&38.7=url&38.9=-1&38.10=1&38.11=0&38.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input0_256_768.csv&38.0=&39.1=wV&39.4=false&39.5=768&39.6=64&39.7=url&39.9=-1&39.10=1&39.11=0&39.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wv4_768_64.csv&39.0=&40.13=none&41.15=1&42.17=negative&42.18=right&42.19=top&42.20=back&43.1=wO&43.4=false&43.5=64&43.6=768&43.7=url&43.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wo4_64_768.csv&43.9=-1&43.10=1&43.11=0&43.0=&44.45=sync&44.46=16&44.47=false&44.13=none&44.48=0&44.49=open&50.51=1&50.52=1&50.15=1&53.54=blocks&53.55=24&53.56=0&53.57=1&53.58=0&53.17=negative&53.18=left&53.19=top&53.20=front&59.60=10&59.61=true&59.62=4&59.63=0.394&59.64=0&59.65=0.5&59.66=12&59.67=false&59.68=false&59.49=closed&69.70=local&69.71=0&69.72=0.2&69.73=0.9&69.74=2&69.75=0.75&69.76=0.75&69.77=0.03&69.49=open&78.8=&78.49=open&79.80=-1212.5184472916683&79.81=1205.8631771144878&79.82=1850.8460431010271&83.80=-6.708919569777563&83.81=75.05036284609801&83.82=-216.66743330111652&expr=0&name=1&epilog=2&left=3&matmul=4&h=5&w=6&init=7&url=8&min=9&max=10&dropout=11&left.anim=12&alg=13&left.block=14&k%20blocks=15&left.layout=16&polarity=17&left%20placement=18&right%20placement=19&result%20placement=20&left.left=21&left.left.left=22&left.left.left.left=23&left.left.left.right=24&left.left.left.anim=25&left.left.left.block=26&left.left.left.layout=27&left.left.right=28&left.left.right.anim=29&left.left.right.block=30&left.left.right.layout=31&left.left.right.left=32&left.left.right.right=33&left.left.anim=34&left.left.block=35&left.left.layout=36&left.right=37&left.right.left=38&left.right.right=39&left.right.anim=40&left.right.block=41&left.right.layout=42&right=43&anim=44&fuse=45&speed=46&hide%20inputs=47&spin=48&folder=49&block=50&i%20blocks=51&j%20blocks=52&layout=53&scheme=54&gap=55&scatter=56&molecule=57&blast=58&deco=59&legends=60&shape=61&spotlight=62&row%20guides=63&flow%20guides=64&lens%20size=65&magnification=66&interior%20spotlight=67&axes=68&viz=69&sensitivity=70&min%20size=71&min%20light=72&max%20light=73&elem%20scale=74&zero%20hue=75&hue%20gap=76&hue%20spread=77&diag=78&cam=79&x=80&y=81&z=82&cam.target=83&compress=84), rather than relying on the screenshot or the video below to convey just how much signal can be absorbed from it - both about its structure and the actual values flowing through the computation.


### 4b Computation and Values

Here's an animation of the attention head computation. Specifically, we're watching

```
sdpa(input @ wQ @ K_t) @ V @ wO
```

(i.e., matmuls 1, 4 , 5 and 6 above, with `K_t` and `V` precomputed) being computed as a fused chain of vector-matrix products: each item in the sequence goes all the way from input through attention to output in one step. More on this animation choice in the later section on parallelization, but first let's look at what the values being computed tell us.

[Open in mm](https://bhosmer.github.io/mm/index.html?0=out%20%3D%20(attn%20%3D%20(Q%20%3D%20input_0_5%20%40%20wQ_5_4)%20%40%20(K_t%20%3D%20wK_t_5_4%20%40%20input_t_0_5))%20%40%20(V%20%3D%20input_0_5%20%40%20wV_5_4)%20%40%20wO_5_4&1=out&2=none&49=closed&84=true&3.1=attn%20%40%20V&3.4=true&3.5=32&3.6=32&3.7=row%20major&3.8=&3.9=-1&3.10=1&3.11=0&3.2=none&12.13=vmprod&14.15=1&16.17=positive&16.18=left&16.19=bottom&16.20=back&21.1=attn&21.4=true&21.2=softmax(tril(x%2Fsqrt(k)))&22.1=Q&22.4=true&22.2=none&23.1=input_0_5&23.4=false&23.5=256&23.6=768&23.7=url&23.9=-1&23.10=1&23.11=0&23.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input0_256_768.csv&23.0=&24.1=wQ_5_4&24.4=false&24.5=768&24.6=64&24.7=url&24.9=-1&24.10=1&24.11=0&24.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wq4_768_64.csv&24.0=&25.13=vmprod&26.15=1&27.17=positive&27.18=left&27.19=bottom&27.20=back&28.2=none&29.13=none&30.15=1&31.17=positive&31.18=right&31.19=top&31.20=back&32.1=wK_t_5_4&32.4=false&32.5=64&32.6=768&32.7=url&32.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wk_t4_64_768.csv&32.9=-1&32.10=1&32.11=0&32.0=&33.1=input_t_0_5&33.4=false&33.5=768&33.6=256&33.7=url&33.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input_t0_768_256.csv&33.9=-1&33.10=1&33.11=0&33.0=&28.1=K_t&28.4=true&34.13=vmprod&35.15=1&36.17=negative&36.18=left&36.19=top&36.20=front&37.1=V&37.4=true&37.2=none&38.1=input_0_5&38.4=false&38.5=256&38.6=768&38.7=url&38.9=-1&38.10=1&38.11=0&38.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input0_256_768.csv&38.0=&39.1=wV_5_4&39.4=false&39.5=768&39.6=64&39.7=url&39.9=-1&39.10=1&39.11=0&39.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wv4_768_64.csv&39.0=&40.13=none&41.15=1&42.17=negative&42.18=right&42.19=top&42.20=back&43.1=wO_5_4&43.4=false&43.5=64&43.6=768&43.7=url&43.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wo4_64_768.csv&43.9=-1&43.10=1&43.11=0&43.0=&44.45=sync&44.46=16&44.47=false&44.13=vmprod&44.48=0&44.49=open&50.51=1&50.52=1&50.15=1&53.54=blocks&53.55=24&53.56=0&53.57=1&53.58=0&53.17=negative&53.18=left&53.19=top&53.20=front&59.60=8.38&59.61=true&59.62=4&59.63=0.394&59.64=0&59.65=0.5&59.66=12&59.67=false&59.68=false&59.49=open&69.70=local&69.71=0.05&69.72=0.2&69.73=0.9&69.74=2&69.75=0.75&69.76=0.75&69.77=0.03&78.8=&79.80=-382.8684269325278&79.81=293.7591554956184&79.82=395.95878922315694&83.80=-14.023727291338966&83.81=-38.22974037070054&83.82=-84.10726407282482&expr=0&name=1&epilog=2&left=3&matmul=4&h=5&w=6&init=7&url=8&min=9&max=10&dropout=11&left.anim=12&alg=13&left.block=14&k%20blocks=15&left.layout=16&polarity=17&left%20placement=18&right%20placement=19&result%20placement=20&left.left=21&left.left.left=22&left.left.left.left=23&left.left.left.right=24&left.left.left.anim=25&left.left.left.block=26&left.left.left.layout=27&left.left.right=28&left.left.right.anim=29&left.left.right.block=30&left.left.right.layout=31&left.left.right.left=32&left.left.right.right=33&left.left.anim=34&left.left.block=35&left.left.layout=36&left.right=37&left.right.left=38&left.right.right=39&left.right.anim=40&left.right.block=41&left.right.layout=42&right=43&anim=44&fuse=45&speed=46&hide%20inputs=47&spin=48&folder=49&block=50&i%20blocks=51&j%20blocks=52&layout=53&scheme=54&gap=55&scatter=56&molecule=57&blast=58&deco=59&legends=60&shape=61&spotlight=62&row%20guides=63&flow%20guides=64&lens%20size=65&magnification=66&interior%20spotlight=67&axes=68&viz=69&sensitivity=70&min%20size=71&min%20light=72&max%20light=73&elem%20scale=74&zero%20hue=75&hue%20gap=76&hue%20spread=77&diag=78&cam=79&x=80&y=81&z=82&cam.target=83&compress=84) 

<p align="center">
  <video width="100%" controls>
    <source src="/assets/videos/inside-the-matrix/gpt2_big2b.mp4" type="video/mp4">
  </video>
</p>

There's a lot of interesting stuff going on here.



* Before we even get to the attention calculation, it's quite striking how low-rank `Q` and `K_t` are. [Zooming in on the Q @ K_t vector-matrix product animation](https://bhosmer.github.io/mm/index.html?0=out%20%3D%20(attn%20%3D%20(Q%20%3D%20input_0_5%20%40%20wQ_5_4)%20%40%20(K_t%20%3D%20wK_t_5_4%20%40%20input_t_0_5))%20%40%20(V%20%3D%20input_0_5%20%40%20wV_5_4)%20%40%20wO_5_4&1=out&2=none&24=closed&84=true&3.1=attn%20%40%20V&3.4=true&3.5=32&3.6=32&3.7=row%20major&3.8=&3.9=-1&3.10=1&3.11=0&3.2=none&12.13=vmprod&14.15=1&16.17=positive&16.18=left&16.19=bottom&16.20=back&21.1=attn&21.4=true&21.2=softmax(tril(x%2Fsqrt(k)))&22.1=Q&22.4=true&22.2=none&23.1=input_0_5&23.4=false&23.5=256&23.6=768&23.7=url&23.9=-1&23.10=1&23.11=0&23.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input0_256_768.csv&23.0=&23.24=closed&25.1=wQ_5_4&25.4=false&25.5=768&25.6=64&25.7=url&25.9=-1&25.10=1&25.11=0&25.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wq4_768_64.csv&25.0=&26.13=none&26.24=open&27.15=1&28.17=positive&28.18=left&28.19=bottom&28.20=back&22.24=open&29.2=none&30.13=none&31.15=1&32.17=positive&32.18=right&32.19=top&32.20=back&33.1=wK_t_5_4&33.4=false&33.5=64&33.6=768&33.7=url&33.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wk_t4_64_768.csv&33.9=-1&33.10=1&33.11=0&33.0=&34.1=input_t_0_5&34.4=false&34.5=768&34.6=256&34.7=url&34.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input_t0_768_256.csv&34.9=-1&34.10=1&34.11=0&34.0=&29.1=K_t&29.4=true&35.13=vmprod&36.15=1&37.17=negative&37.18=left&37.19=top&37.20=front&21.24=closed&38.1=V&38.4=true&38.2=none&39.1=input_0_5&39.4=false&39.5=256&39.6=768&39.7=url&39.9=-1&39.10=1&39.11=0&39.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input0_256_768.csv&39.0=&40.1=wV_5_4&40.4=false&40.5=768&40.6=64&40.7=url&40.9=-1&40.10=1&40.11=0&40.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wv4_768_64.csv&40.0=&41.13=none&42.15=1&43.17=negative&43.18=right&43.19=top&43.20=back&3.24=closed&44.1=wO_5_4&44.4=false&44.5=64&44.6=768&44.7=url&44.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wo4_64_768.csv&44.9=-1&44.10=1&44.11=0&44.0=&45.46=sync&45.47=4&45.48=false&45.13=vmprod&45.49=0&45.24=open&50.51=1&50.52=1&50.15=1&53.54=blocks&53.55=24&53.56=0&53.57=1&53.58=0&53.17=negative&53.18=left&53.19=top&53.20=front&59.60=8.38&59.61=true&59.62=4&59.63=0.394&59.64=0&59.65=0.5&59.66=12&59.67=false&59.68=false&59.24=open&69.70=local&69.71=0.05&69.72=0.2&69.73=0.9&69.74=2&69.75=0.75&69.76=0.75&69.77=0.03&78.8=&79.80=-0.30816774330149777&79.81=333.6054152134701&79.82=155.72856559616935&83.80=-0.11764216999897817&83.81=-38.43510027180947&83.82=-78.52287109278605&expr=0&name=1&epilog=2&left=3&matmul=4&h=5&w=6&init=7&url=8&min=9&max=10&dropout=11&left.anim=12&alg=13&left.block=14&k%20blocks=15&left.layout=16&polarity=17&left%20placement=18&right%20placement=19&result%20placement=20&left.left=21&left.left.left=22&left.left.left.left=23&folder=24&left.left.left.right=25&left.left.left.anim=26&left.left.left.block=27&left.left.left.layout=28&left.left.right=29&left.left.right.anim=30&left.left.right.block=31&left.left.right.layout=32&left.left.right.left=33&left.left.right.right=34&left.left.anim=35&left.left.block=36&left.left.layout=37&left.right=38&left.right.left=39&left.right.right=40&left.right.anim=41&left.right.block=42&left.right.layout=43&right=44&anim=45&fuse=46&speed=47&hide%20inputs=48&spin=49&block=50&i%20blocks=51&j%20blocks=52&layout=53&scheme=54&gap=55&scatter=56&molecule=57&blast=58&deco=59&legends=60&shape=61&spotlight=62&row%20guides=63&flow%20guides=64&lens%20size=65&magnification=66&interior%20spotlight=67&axes=68&viz=69&sensitivity=70&min%20size=71&min%20light=72&max%20light=73&elem%20scale=74&zero%20hue=75&hue%20gap=76&hue%20spread=77&diag=78&cam=79&x=80&y=81&z=82&cam.target=83&compress=84), the situation is even more vivid: a significant number of channels (embedding positions) in _both_ `Q` and `K` look more or less constant across the sequence, implying that the useful attention signal is potentially driven by a only smallish subset of the embedding. Understanding and exploiting this phenomenon is one of the threads we're pulling on as part of the SysML ATOM transformer efficiency project.
* Perhaps most familiar is the strong-but-not-perfect diagonal that emerges in the attention matrix. This is a common pattern, showing up in many of the attention heads of this model (and those of many transformers). It produces _localized_ attention: the value tokens in the small neighborhood immediately preceding an output token's position largely determine that output token's content pattern.
* However, the size of this neighborhood and the influence of individual tokens within it vary nontrivially - this can be seen both in the off-diagonal frost in the attention grid, and in the [fluctuating patterns of the attn[i] @ V vector-matrix product plane](https://bhosmer.github.io/mm/index.html?0=out%20%3D%20(attn%20%3D%20(Q%20%3D%20input_0_5%20%40%20wQ_5_4)%20%40%20(K_t%20%3D%20wK_t_5_4%20%40%20input_t_0_5))%20%40%20(V%20%3D%20input_0_5%20%40%20wV_5_4)%20%40%20wO_5_4&1=out&2=none&26=closed&84=true&3.1=attn%20%40%20V&3.4=true&3.5=32&3.6=32&3.7=row%20major&3.8=&3.9=-1&3.10=1&3.11=0&3.2=none&12.13=vmprod&14.15=1&16.17=positive&16.18=left&16.19=bottom&16.20=back&21.1=attn&21.4=true&21.2=softmax(tril(x%2Fsqrt(k)))&22.1=Q&22.4=true&22.2=none&23.1=input_0_5&23.4=false&23.5=256&23.6=768&23.7=url&23.9=-1&23.10=1&23.11=0&23.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input0_256_768.csv&23.0=&24.1=wQ_5_4&24.4=false&24.5=768&24.6=64&24.7=url&24.9=-1&24.10=1&24.11=0&24.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wq4_768_64.csv&24.0=&25.13=none&25.26=open&27.15=1&28.17=positive&28.18=left&28.19=bottom&28.20=back&22.26=closed&29.2=none&30.13=none&31.15=1&32.17=positive&32.18=right&32.19=top&32.20=back&33.1=wK_t_5_4&33.4=false&33.5=64&33.6=768&33.7=url&33.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wk_t4_64_768.csv&33.9=-1&33.10=1&33.11=0&33.0=&34.1=input_t_0_5&34.4=false&34.5=768&34.6=256&34.7=url&34.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input_t0_768_256.csv&34.9=-1&34.10=1&34.11=0&34.0=&29.1=K_t&29.4=true&35.13=none&35.26=open&36.15=1&37.17=negative&37.18=left&37.19=top&37.20=front&21.26=open&38.1=V&38.4=true&38.2=none&39.1=input_0_5&39.4=false&39.5=256&39.6=768&39.7=url&39.9=-1&39.10=1&39.11=0&39.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input0_256_768.csv&39.0=&40.1=wV_5_4&40.4=false&40.5=768&40.6=64&40.7=url&40.9=-1&40.10=1&40.11=0&40.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wv4_768_64.csv&40.0=&41.13=none&42.15=1&43.17=negative&43.18=right&43.19=top&43.20=back&3.26=open&44.1=wO_5_4&44.4=false&44.5=64&44.6=768&44.7=url&44.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wo4_64_768.csv&44.9=-1&44.10=1&44.11=0&44.0=&45.46=sync&45.47=16&45.48=false&45.13=vmprod&45.49=0&45.26=open&50.51=1&50.52=1&50.15=1&53.54=blocks&53.55=24&53.56=0&53.57=1&53.58=0&53.17=negative&53.18=left&53.19=top&53.20=front&59.60=8.38&59.61=true&59.62=4&59.63=0.394&59.64=0&59.65=0.5&59.66=12&59.67=false&59.68=false&59.26=open&69.70=local&69.71=0.05&69.72=0.2&69.73=0.9&69.74=2&69.75=0.75&69.76=0.75&69.77=0.03&78.8=&79.80=-12.838747258760423&79.81=224.62765397316576&79.82=274.71626756027933&83.80=-13.049253781233714&83.81=-55.16215322834755&83.82=-70.26525235295296&expr=0&name=1&epilog=2&left=3&matmul=4&h=5&w=6&init=7&url=8&min=9&max=10&dropout=11&left.anim=12&alg=13&left.block=14&k%20blocks=15&left.layout=16&polarity=17&left%20placement=18&right%20placement=19&result%20placement=20&left.left=21&left.left.left=22&left.left.left.left=23&left.left.left.right=24&left.left.left.anim=25&folder=26&left.left.left.block=27&left.left.left.layout=28&left.left.right=29&left.left.right.anim=30&left.left.right.block=31&left.left.right.layout=32&left.left.right.left=33&left.left.right.right=34&left.left.anim=35&left.left.block=36&left.left.layout=37&left.right=38&left.right.left=39&left.right.right=40&left.right.anim=41&left.right.block=42&left.right.layout=43&right=44&anim=45&fuse=46&speed=47&hide%20inputs=48&spin=49&block=50&i%20blocks=51&j%20blocks=52&layout=53&scheme=54&gap=55&scatter=56&molecule=57&blast=58&deco=59&legends=60&shape=61&spotlight=62&row%20guides=63&flow%20guides=64&lens%20size=65&magnification=66&interior%20spotlight=67&axes=68&viz=69&sensitivity=70&min%20size=71&min%20light=72&max%20light=73&elem%20scale=74&zero%20hue=75&hue%20gap=76&hue%20spread=77&diag=78&cam=79&x=80&y=81&z=82&cam.target=83&compress=84) as it descends the attention matrix on its way through the sequence.
* But note that the local neighborhood isn't the only thing that's attracting attention: the leftmost column of the attention grid, corresponding to the first token of the sequence, is entirely filled with nonzero (but fluctuating) values, meaning every output token will be influenced to some degree by the first value token.
* Moreover there's an [inexact but discernible oscillation in attention score dominance](https://bhosmer.github.io/mm/index.html?0=out%20%3D%20(attn%20%3D%20(Q%20%3D%20input_0_5%20%40%20wQ_5_4)%20%40%20(K_t%20%3D%20wK_t_5_4%20%40%20input_t_0_5))%20%40%20(V%20%3D%20input_0_5%20%40%20wV_5_4)%20%40%20wO_5_4&1=out&2=none&49=closed&84=true&3.1=attn%20%40%20V&3.4=true&3.5=32&3.6=32&3.7=row%20major&3.8=&3.9=-1&3.10=1&3.11=0&3.2=none&12.13=vmprod&14.15=1&16.17=positive&16.18=left&16.19=bottom&16.20=back&21.1=attn&21.4=true&21.2=softmax(tril(x%2Fsqrt(k)))&22.1=Q&22.4=true&22.2=none&23.1=input_0_5&23.4=false&23.5=256&23.6=768&23.7=url&23.9=-1&23.10=1&23.11=0&23.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input0_256_768.csv&23.0=&24.1=wQ_5_4&24.4=false&24.5=768&24.6=64&24.7=url&24.9=-1&24.10=1&24.11=0&24.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wq4_768_64.csv&24.0=&25.13=vmprod&26.15=1&27.17=positive&27.18=left&27.19=bottom&27.20=back&28.2=none&29.13=none&30.15=1&31.17=positive&31.18=right&31.19=top&31.20=back&32.1=wK_t_5_4&32.4=false&32.5=64&32.6=768&32.7=url&32.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wk_t4_64_768.csv&32.9=-1&32.10=1&32.11=0&32.0=&33.1=input_t_0_5&33.4=false&33.5=768&33.6=256&33.7=url&33.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input_t0_768_256.csv&33.9=-1&33.10=1&33.11=0&33.0=&28.1=K_t&28.4=true&34.13=vmprod&35.15=1&36.17=negative&36.18=left&36.19=top&36.20=front&37.1=V&37.4=true&37.2=none&38.1=input_0_5&38.4=false&38.5=256&38.6=768&38.7=url&38.9=-1&38.10=1&38.11=0&38.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input0_256_768.csv&38.0=&39.1=wV_5_4&39.4=false&39.5=768&39.6=64&39.7=url&39.9=-1&39.10=1&39.11=0&39.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wv4_768_64.csv&39.0=&40.13=none&41.15=1&42.17=negative&42.18=right&42.19=top&42.20=back&43.1=wO_5_4&43.4=false&43.5=64&43.6=768&43.7=url&43.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wo4_64_768.csv&43.9=-1&43.10=1&43.11=0&43.0=&44.45=sync&44.46=16&44.47=false&44.13=none&44.48=0&44.49=open&50.51=1&50.52=1&50.15=1&53.54=blocks&53.55=24&53.56=0&53.57=1&53.58=0&53.17=negative&53.18=left&53.19=top&53.20=front&59.60=8.38&59.61=true&59.62=4&59.63=0.394&59.64=0&59.65=0.5&59.66=12&59.67=false&59.68=false&59.49=open&69.70=local&69.71=0.05&69.72=0.2&69.73=0.9&69.74=2&69.75=0.75&69.76=0.75&69.77=0.03&78.8=&79.80=-328.8286059935543&79.81=-64.64788859858083&79.82=156.66189435044396&83.80=-6.5479856531724625&83.81=-27.630477427688977&83.82=-64.70186279804427&expr=0&name=1&epilog=2&left=3&matmul=4&h=5&w=6&init=7&url=8&min=9&max=10&dropout=11&left.anim=12&alg=13&left.block=14&k%20blocks=15&left.layout=16&polarity=17&left%20placement=18&right%20placement=19&result%20placement=20&left.left=21&left.left.left=22&left.left.left.left=23&left.left.left.right=24&left.left.left.anim=25&left.left.left.block=26&left.left.left.layout=27&left.left.right=28&left.left.right.anim=29&left.left.right.block=30&left.left.right.layout=31&left.left.right.left=32&left.left.right.right=33&left.left.anim=34&left.left.block=35&left.left.layout=36&left.right=37&left.right.left=38&left.right.right=39&left.right.anim=40&left.right.block=41&left.right.layout=42&right=43&anim=44&fuse=45&speed=46&hide%20inputs=47&spin=48&folder=49&block=50&i%20blocks=51&j%20blocks=52&layout=53&scheme=54&gap=55&scatter=56&molecule=57&blast=58&deco=59&legends=60&shape=61&spotlight=62&row%20guides=63&flow%20guides=64&lens%20size=65&magnification=66&interior%20spotlight=67&axes=68&viz=69&sensitivity=70&min%20size=71&min%20light=72&max%20light=73&elem%20scale=74&zero%20hue=75&hue%20gap=76&hue%20spread=77&diag=78&cam=79&x=80&y=81&z=82&cam.target=83&compress=84) between the current token neighborhood and the initial token. The period of the oscillation varies, but broadly speaking starts short and then lengthens as one travels down the sequence (evocatively correlated with the quantity of candidate attention tokens for each row, given causality).
* To get a feel for how (`attn @ V)` is formed, it's important not to focus on attention in isolation - `V` is an equal player. Each output item is a weighted average of the entire `V` vector: at the limit when attention is a perfect diagonal, `attn @ V` is simply an exact copy of `V`. Here we see [something more textured](https://bhosmer.github.io/mm/index.html?0=out+%3D+%28attn+%3D+%28Q+%3D+input_0_5+%40+wQ_5_4%29+%40+%28K_t+%3D+wK_t_5_4+%40+input_t_0_5%29%29+%40+%28V+%3D+input_0_5+%40+wV_5_4%29+%40+wO_5_4&1=out&2=none&51=closed&84=true&3.1=attn+%40+V&3.4=true&3.5=32&3.6=32&3.7=row+major&3.8=&3.9=-1&3.10=1&3.11=0&3.2=none&12.13=vmprod&14.15=1&14.16=1&14.17=1&18.19=positive&18.20=left&18.21=bottom&18.22=back&23.1=attn&23.4=true&23.2=softmax%28tril%28x%2Fsqrt%28k%29%29%29&24.1=Q&24.4=true&24.2=none&25.1=input_0_5&25.4=false&25.5=256&25.6=768&25.7=url&25.9=-1&25.10=1&25.11=0&25.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input0_256_768.csv&25.0=&26.1=wQ_5_4&26.4=false&26.5=768&26.6=64&26.7=url&26.9=-1&26.10=1&26.11=0&26.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wq4_768_64.csv&26.0=&27.13=vmprod&28.15=1&28.16=1&28.17=1&29.19=positive&29.20=left&29.21=bottom&29.22=back&30.2=none&31.13=none&32.15=1&32.16=1&32.17=1&33.19=positive&33.20=right&33.21=top&33.22=back&34.1=wK_t_5_4&34.4=false&34.5=64&34.6=768&34.7=url&34.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wk_t4_64_768.csv&34.9=-1&34.10=1&34.11=0&34.0=&35.1=input_t_0_5&35.4=false&35.5=768&35.6=256&35.7=url&35.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input_t0_768_256.csv&35.9=-1&35.10=1&35.11=0&35.0=&30.1=K_t&30.4=true&36.13=vmprod&37.15=1&37.16=1&37.17=1&38.19=negative&38.20=left&38.21=top&38.22=front&39.1=V&39.4=true&39.2=none&40.1=input_0_5&40.4=false&40.5=256&40.6=768&40.7=url&40.9=-1&40.10=1&40.11=0&40.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input0_256_768.csv&40.0=&41.1=wV_5_4&41.4=false&41.5=768&41.6=64&41.7=url&41.9=-1&41.10=1&41.11=0&41.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wv4_768_64.csv&41.0=&42.13=none&43.15=1&43.16=1&43.17=1&44.19=negative&44.20=right&44.21=top&44.22=back&45.1=wO_5_4&45.4=false&45.5=64&45.6=768&45.7=url&45.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wo4_64_768.csv&45.9=-1&45.10=1&45.11=0&45.0=&46.47=sync&46.48=16&46.49=false&46.13=none&46.50=0&46.51=open&52.16=1&52.15=1&52.17=1&53.54=blocks&53.55=24&53.56=0&53.57=1&53.58=0&53.19=negative&53.20=left&53.21=top&53.22=front&59.60=8.38&59.61=true&59.62=4&59.63=0.394&59.64=0&59.65=0.5&59.66=20&59.67=false&59.68=false&59.51=open&69.70=local&69.71=0.05&69.72=0.2&69.73=0.9&69.74=2&69.75=0.75&69.76=0.75&69.77=0.03&78.8=&79.80=-164.2339403949366&79.81=18.940074323234473&79.82=173.55325640245638&83.80=117.76774477612946&83.81=2.623526996843087&83.82=53.25986191913323&expr=0&name=1&epilog=2&left=3&matmul=4&h=5&w=6&init=7&url=8&min=9&max=10&dropout=11&left.anim=12&alg=13&left.block=14&k+blocks=15&i+blocks=16&j+blocks=17&left.layout=18&polarity=19&left+placement=20&right+placement=21&result+placement=22&left.left=23&left.left.left=24&left.left.left.left=25&left.left.left.right=26&left.left.left.anim=27&left.left.left.block=28&left.left.left.layout=29&left.left.right=30&left.left.right.anim=31&left.left.right.block=32&left.left.right.layout=33&left.left.right.left=34&left.left.right.right=35&left.left.anim=36&left.left.block=37&left.left.layout=38&left.right=39&left.right.left=40&left.right.right=41&left.right.anim=42&left.right.block=43&left.right.layout=44&right=45&anim=46&fuse=47&speed=48&hide+inputs=49&spin=50&folder=51&block=52&layout=53&scheme=54&gap=55&scatter=56&molecule=57&blast=58&deco=59&legends=60&shape=61&spotlight=62&row+guides=63&flow+guides=64&lens+size=65&magnification=66&interior+spotlight=67&axes=68&viz=69&sensitivity=70&min+size=71&min+light=72&max+light=73&elem+scale=74&zero+hue=75&hue+gap=76&hue+spread=77&diag=78&cam=79&x=80&y=81&z=82&cam.target=83&compress=84): visible banding where particular tokens have scored high over a contiguous subsequence of attention rows, superimposed on a matrix visibly similar to to `V` but with some vertical smearing due to the fat diagonal. (Aside: per the [mm reference guide](https://bhosmer.github.io/mm/ref.html), long-clicking or control-clicking will reveal the actual numeric values of visualized elements.)
* Bear in mind that since we're in a middle layer (5), the input to this attention head is an intermediate representation, not the original tokenized text. So the [patterns seen in the input](https://bhosmer.github.io/mm/index.html?0=out+%3D+%28attn+%3D+%28Q+%3D+input+%40+wQ%29+%40+%28K_t+%3D+wK_t+%40+input_t%29%29+%40+%28V+%3D+input+%40+wV%29+%40+wO&1=out&2=none&26=closed&84=true&3.1=attn+%40+V&3.4=true&3.5=32&3.6=32&3.7=row+major&3.8=&3.9=-1&3.10=1&3.11=0&3.2=none&12.13=vmprod&14.15=1&14.16=1&14.17=1&18.19=positive&18.20=left&18.21=bottom&18.22=back&23.1=attn&23.4=true&23.2=softmax%28tril%28x%2Fsqrt%28k%29%29%29&24.1=Q&24.4=true&24.2=none&25.1=input&25.4=false&25.5=256&25.6=768&25.7=url&25.9=-1&25.10=1&25.11=0&25.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input0_256_768.csv&25.0=&25.26=open&27.1=wQ&27.4=false&27.5=768&27.6=64&27.7=url&27.9=-1&27.10=1&27.11=0&27.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wq4_768_64.csv&27.0=&28.13=vmprod&29.15=1&29.16=1&29.17=1&30.19=positive&30.20=left&30.21=bottom&30.22=back&24.26=open&31.2=none&32.13=none&33.15=1&33.16=1&33.17=1&34.19=positive&34.20=right&34.21=top&34.22=back&35.1=wK_t&35.4=false&35.5=64&35.6=768&35.7=url&35.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wk_t4_64_768.csv&35.9=-1&35.10=1&35.11=0&35.0=&36.1=input_t&36.4=false&36.5=768&36.6=256&36.7=url&36.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input_t0_768_256.csv&36.9=-1&36.10=1&36.11=0&36.0=&31.1=K_t&31.4=true&37.13=vmprod&38.15=1&38.16=1&38.17=1&39.19=negative&39.20=left&39.21=top&39.22=front&23.26=open&40.1=V&40.4=true&40.2=none&41.1=input&41.4=false&41.5=256&41.6=768&41.7=url&41.9=-1&41.10=1&41.11=0&41.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input0_256_768.csv&41.0=&42.1=wV&42.4=false&42.5=768&42.6=64&42.7=url&42.9=-1&42.10=1&42.11=0&42.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wv4_768_64.csv&42.0=&43.13=none&44.15=1&44.16=1&44.17=1&45.19=negative&45.20=right&45.21=top&45.22=back&3.26=open&46.1=wO&46.4=false&46.5=64&46.6=768&46.7=url&46.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wo4_64_768.csv&46.9=-1&46.10=1&46.11=0&46.0=&47.48=sync&47.49=16&47.50=false&47.13=none&47.51=0&47.26=open&52.16=1&52.15=1&52.17=1&53.54=blocks&53.55=24&53.56=0&53.57=1&53.58=0&53.19=negative&53.20=left&53.21=top&53.22=front&59.60=10&59.61=true&59.62=5&59.63=0.394&59.64=0&59.65=0.25&59.66=4.632&59.67=false&59.68=false&59.26=open&69.70=local&69.71=0.2&69.72=0.4&69.73=0.9&69.74=2&69.75=0.75&69.76=0.75&69.77=0.03&69.26=open&78.8=&78.26=open&79.80=-1126.8641673236093&79.81=-4.707283693510895&79.82=168.0669807860928&83.80=-692.9006907132649&83.81=4.068470706235418&83.82=-171.27561837707958&expr=0&name=1&epilog=2&left=3&matmul=4&h=5&w=6&init=7&url=8&min=9&max=10&dropout=11&left.anim=12&alg=13&left.block=14&k+blocks=15&i+blocks=16&j+blocks=17&left.layout=18&polarity=19&left+placement=20&right+placement=21&result+placement=22&left.left=23&left.left.left=24&left.left.left.left=25&folder=26&left.left.left.right=27&left.left.left.anim=28&left.left.left.block=29&left.left.left.layout=30&left.left.right=31&left.left.right.anim=32&left.left.right.block=33&left.left.right.layout=34&left.left.right.left=35&left.left.right.right=36&left.left.anim=37&left.left.block=38&left.left.layout=39&left.right=40&left.right.left=41&left.right.right=42&left.right.anim=43&left.right.block=44&left.right.layout=45&right=46&anim=47&fuse=48&speed=49&hide+inputs=50&spin=51&block=52&layout=53&scheme=54&gap=55&scatter=56&molecule=57&blast=58&deco=59&legends=60&shape=61&spotlight=62&row+guides=63&flow+guides=64&lens+size=65&magnification=66&interior+spotlight=67&axes=68&viz=69&sensitivity=70&min+size=71&min+light=72&max+light=73&elem+scale=74&zero+hue=75&hue+gap=76&hue+spread=77&diag=78&cam=79&x=80&y=81&z=82&cam.target=83&compress=84) are themselves thought-provoking - in particular, the strong vertical threads are particular embedding positions whose values are uniformly high magnitude across long stretches of the sequence - sometimes almost the entire thing.
* Interestingly, though, the [first vector in the input sequence is distinctive](https://bhosmer.github.io/mm/index.html?0=out%20%3D%20(attn%20%3D%20(Q%20%3D%20input%20%40%20wQ)%20%40%20(K_t%20%3D%20wK_t%20%40%20input_t))%20%40%20(V%20%3D%20input%20%40%20wV)%20%40%20wO&1=out&2=none&24=closed&84=true&3.1=attn%20%40%20V&3.4=true&3.5=32&3.6=32&3.7=row%20major&3.8=&3.9=-1&3.10=1&3.11=0&3.2=none&12.13=vmprod&14.15=1&16.17=positive&16.18=left&16.19=bottom&16.20=back&21.1=attn&21.4=true&21.2=softmax(tril(x%2Fsqrt(k)))&22.1=Q&22.4=true&22.2=none&23.1=input&23.4=false&23.5=256&23.6=768&23.7=url&23.9=-1&23.10=1&23.11=0&23.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input0_256_768.csv&23.0=&23.24=open&25.1=wQ&25.4=false&25.5=768&25.6=64&25.7=url&25.9=-1&25.10=1&25.11=0&25.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wq4_768_64.csv&25.0=&26.13=vmprod&27.15=1&28.17=positive&28.18=left&28.19=bottom&28.20=back&22.24=open&29.2=none&30.13=none&31.15=1&32.17=positive&32.18=right&32.19=top&32.20=back&33.1=wK_t&33.4=false&33.5=64&33.6=768&33.7=url&33.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wk_t4_64_768.csv&33.9=-1&33.10=1&33.11=0&33.0=&34.1=input_t&34.4=false&34.5=768&34.6=256&34.7=url&34.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input_t0_768_256.csv&34.9=-1&34.10=1&34.11=0&34.0=&29.1=K_t&29.4=true&35.13=vmprod&36.15=1&37.17=negative&37.18=left&37.19=top&37.20=front&21.24=open&38.1=V&38.4=true&38.2=none&39.1=input&39.4=false&39.5=256&39.6=768&39.7=url&39.9=-1&39.10=1&39.11=0&39.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input0_256_768.csv&39.0=&40.1=wV&40.4=false&40.5=768&40.6=64&40.7=url&40.9=-1&40.10=1&40.11=0&40.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wv4_768_64.csv&40.0=&41.13=none&42.15=1&43.17=negative&43.18=right&43.19=top&43.20=back&3.24=open&44.1=wO&44.4=false&44.5=64&44.6=768&44.7=url&44.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wo4_64_768.csv&44.9=-1&44.10=1&44.11=0&44.0=&45.46=sync&45.47=16&45.48=false&45.13=none&45.49=0&45.24=open&50.51=1&50.52=1&50.15=1&53.54=blocks&53.55=24&53.56=0&53.57=1&53.58=0&53.17=negative&53.18=left&53.19=top&53.20=front&59.60=10&59.61=true&59.62=5&59.63=0.394&59.64=0&59.65=0&59.66=4.632&59.67=false&59.68=false&59.24=open&69.70=local&69.71=0.2&69.72=0.4&69.73=0.9&69.74=2&69.75=0.75&69.76=0.75&69.77=0.03&69.24=open&78.8=&78.24=open&79.80=-905.2149526505231&79.81=126.10717525695773&79.82=-90.1644865901155&83.80=-739.2766627330938&83.81=125.47333863007341&83.82=-229.39828071999955&expr=0&name=1&epilog=2&left=3&matmul=4&h=5&w=6&init=7&url=8&min=9&max=10&dropout=11&left.anim=12&alg=13&left.block=14&k%20blocks=15&left.layout=16&polarity=17&left%20placement=18&right%20placement=19&result%20placement=20&left.left=21&left.left.left=22&left.left.left.left=23&folder=24&left.left.left.right=25&left.left.left.anim=26&left.left.left.block=27&left.left.left.layout=28&left.left.right=29&left.left.right.anim=30&left.left.right.block=31&left.left.right.layout=32&left.left.right.left=33&left.left.right.right=34&left.left.anim=35&left.left.block=36&left.left.layout=37&left.right=38&left.right.left=39&left.right.right=40&left.right.anim=41&left.right.block=42&left.right.layout=43&right=44&anim=45&fuse=46&speed=47&hide%20inputs=48&spin=49&block=50&i%20blocks=51&j%20blocks=52&layout=53&scheme=54&gap=55&scatter=56&molecule=57&blast=58&deco=59&legends=60&shape=61&spotlight=62&row%20guides=63&flow%20guides=64&lens%20size=65&magnification=66&interior%20spotlight=67&axes=68&viz=69&sensitivity=70&min%20size=71&min%20light=72&max%20light=73&elem%20scale=74&zero%20hue=75&hue%20gap=76&hue%20spread=77&diag=78&cam=79&x=80&y=81&z=82&cam.target=83&compress=84), not only breaking the pattern of these high-magnitude columns but carrying atypical values at almost every position (aside: not visualized here, but this pattern is repeated over multiple sample inputs).

Note: apropos of the last two bullet points, it's worth reiterating that we're visualizing computation over a _single sample input_. In practice I've found that each head has a characteristic pattern it will express consistently (though not identically) over a decent collection of samples (and the upcoming attention head browser will provide a collection of samples to play with), but when looking at any visualization that includes activations, it's important to bear in mind that a full distribution of inputs may influence the ideas and intuitions it provokes it in subtle ways.

Finally, one more pitch to [explore the animation directly](https://bhosmer.github.io/mm/index.html?0=out%20%3D%20(attn%20%3D%20(Q%20%3D%20input_0_5%20%40%20wQ_5_4)%20%40%20(K_t%20%3D%20wK_t_5_4%20%40%20input_t_0_5))%20%40%20(V%20%3D%20input_0_5%20%40%20wV_5_4)%20%40%20wO_5_4&1=out&2=none&49=closed&84=true&3.1=attn%20%40%20V&3.4=true&3.5=32&3.6=32&3.7=row%20major&3.8=&3.9=-1&3.10=1&3.11=0&3.2=none&12.13=vmprod&14.15=1&16.17=positive&16.18=left&16.19=bottom&16.20=back&21.1=attn&21.4=true&21.2=softmax(tril(x%2Fsqrt(k)))&22.1=Q&22.4=true&22.2=none&23.1=input_0_5&23.4=false&23.5=256&23.6=768&23.7=url&23.9=-1&23.10=1&23.11=0&23.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input0_256_768.csv&23.0=&24.1=wQ_5_4&24.4=false&24.5=768&24.6=64&24.7=url&24.9=-1&24.10=1&24.11=0&24.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wq4_768_64.csv&24.0=&25.13=vmprod&26.15=1&27.17=positive&27.18=left&27.19=bottom&27.20=back&28.2=none&29.13=none&30.15=1&31.17=positive&31.18=right&31.19=top&31.20=back&32.1=wK_t_5_4&32.4=false&32.5=64&32.6=768&32.7=url&32.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wk_t4_64_768.csv&32.9=-1&32.10=1&32.11=0&32.0=&33.1=input_t_0_5&33.4=false&33.5=768&33.6=256&33.7=url&33.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input_t0_768_256.csv&33.9=-1&33.10=1&33.11=0&33.0=&28.1=K_t&28.4=true&34.13=vmprod&35.15=1&36.17=negative&36.18=left&36.19=top&36.20=front&37.1=V&37.4=true&37.2=none&38.1=input_0_5&38.4=false&38.5=256&38.6=768&38.7=url&38.9=-1&38.10=1&38.11=0&38.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input0_256_768.csv&38.0=&39.1=wV_5_4&39.4=false&39.5=768&39.6=64&39.7=url&39.9=-1&39.10=1&39.11=0&39.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wv4_768_64.csv&39.0=&40.13=none&41.15=1&42.17=negative&42.18=right&42.19=top&42.20=back&43.1=wO_5_4&43.4=false&43.5=64&43.6=768&43.7=url&43.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wo4_64_768.csv&43.9=-1&43.10=1&43.11=0&43.0=&44.45=sync&44.46=16&44.47=false&44.13=vmprod&44.48=0&44.49=open&50.51=1&50.52=1&50.15=1&53.54=blocks&53.55=24&53.56=0&53.57=1&53.58=0&53.17=negative&53.18=left&53.19=top&53.20=front&59.60=8.38&59.61=true&59.62=4&59.63=0.394&59.64=0&59.65=0.5&59.66=12&59.67=false&59.68=false&59.49=open&69.70=local&69.71=0.05&69.72=0.2&69.73=0.9&69.74=2&69.75=0.75&69.76=0.75&69.77=0.03&78.8=&79.80=-382.8684269325278&79.81=293.7591554956184&79.82=395.95878922315694&83.80=-14.023727291338966&83.81=-38.22974037070054&83.82=-84.10726407282482&expr=0&name=1&epilog=2&left=3&matmul=4&h=5&w=6&init=7&url=8&min=9&max=10&dropout=11&left.anim=12&alg=13&left.block=14&k%20blocks=15&left.layout=16&polarity=17&left%20placement=18&right%20placement=19&result%20placement=20&left.left=21&left.left.left=22&left.left.left.left=23&left.left.left.right=24&left.left.left.anim=25&left.left.left.block=26&left.left.left.layout=27&left.left.right=28&left.left.right.anim=29&left.left.right.block=30&left.left.right.layout=31&left.left.right.left=32&left.left.right.right=33&left.left.anim=34&left.left.block=35&left.left.layout=36&left.right=37&left.right.left=38&left.right.right=39&left.right.anim=40&left.right.block=41&left.right.layout=42&right=43&anim=44&fuse=45&speed=46&hide%20inputs=47&spin=48&folder=49&block=50&i%20blocks=51&j%20blocks=52&layout=53&scheme=54&gap=55&scatter=56&molecule=57&blast=58&deco=59&legends=60&shape=61&spotlight=62&row%20guides=63&flow%20guides=64&lens%20size=65&magnification=66&interior%20spotlight=67&axes=68&viz=69&sensitivity=70&min%20size=71&min%20light=72&max%20light=73&elem%20scale=74&zero%20hue=75&hue%20gap=76&hue%20spread=77&diag=78&cam=79&x=80&y=81&z=82&cam.target=83&compress=84)!


### 4c Heads are different in interesting ways

Before we move on, here's one more demonstration of the usefulness of simply poking around a model to see how it works in detail.

This is another attention head from GPT2. It behaves quite differently from layer 5, head 4 above - as one might expect, given that it's in a very different part of the model. This head is in the very first layer: layer 0, head 2 ([open in mm](https://bhosmer.github.io/mm/index.html?0=out%20%3D%20(attn%20%3D%20(Q%20%3D%20input_0_0%20%40%20wQ_0_2)%20%40%20(K_t%20%3D%20wK_t_0_2%20%40%20input_t_0_0))%20%40%20(V%20%3D%20input_0_0%20%40%20wV_0_2)%20%40%20wO_0_2&1=out&2=none&49=closed&84=true&3.1=attn%20%40%20V&3.4=true&3.5=32&3.6=32&3.7=row%20major&3.8=&3.9=-1&3.10=1&3.11=0&3.2=none&12.13=vmprod&14.15=1&16.17=positive&16.18=left&16.19=bottom&16.20=back&21.1=attn&21.4=true&21.2=softmax(tril(x%2Fsqrt(k)))&22.1=Q&22.4=true&22.2=none&23.1=input_0_0&23.4=false&23.5=256&23.6=768&23.7=url&23.9=-1&23.10=1&23.11=0&23.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_input0_256_768.csv&23.0=&24.1=wQ_0_2&24.4=false&24.5=768&24.6=64&24.7=url&24.9=-1&24.10=1&24.11=0&24.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_wq2_768_64.csv&24.0=&25.13=none&26.15=1&27.17=positive&27.18=left&27.19=bottom&27.20=back&28.2=none&29.13=none&30.15=1&31.17=positive&31.18=right&31.19=top&31.20=back&32.1=wK_t_0_2&32.4=false&32.5=64&32.6=768&32.7=url&32.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_wk_t2_64_768.csv&32.9=-1&32.10=1&32.11=0&32.0=&33.1=input_t_0_0&33.4=false&33.5=768&33.6=256&33.7=url&33.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_input_t0_768_256.csv&33.9=-1&33.10=1&33.11=0&33.0=&28.1=K_t&28.4=true&34.13=none&35.15=1&36.17=negative&36.18=left&36.19=top&36.20=front&37.1=V&37.4=true&37.2=none&38.1=input_0_0&38.4=false&38.5=256&38.6=768&38.7=url&38.9=-1&38.10=1&38.11=0&38.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_input0_256_768.csv&38.0=&39.1=wV_0_2&39.4=false&39.5=768&39.6=64&39.7=url&39.9=-1&39.10=1&39.11=0&39.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_wv2_768_64.csv&39.0=&40.13=none&41.15=1&42.17=negative&42.18=right&42.19=top&42.20=back&43.1=wO_0_2&43.4=false&43.5=64&43.6=768&43.7=url&43.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_wo2_64_768.csv&43.9=-1&43.10=1&43.11=0&43.0=&44.45=sync&44.46=16&44.47=false&44.13=none&44.48=0&44.49=open&50.51=1&50.52=1&50.15=1&53.54=blocks&53.55=24&53.56=0&53.57=1&53.58=0&53.17=negative&53.18=left&53.19=top&53.20=front&59.60=6&59.61=true&59.62=4&59.63=0.73&59.64=0&59.65=0.5&59.66=12&59.67=false&59.68=false&59.49=open&69.70=local&69.71=0.2&69.72=0.2&69.73=0.9&69.74=2&69.75=0.75&69.76=0.75&69.77=0.03&69.49=open&78.8=&78.49=open&79.80=-217.09372134188362&79.81=412.82010718887307&79.82=523.3596617096426&83.80=127.59196458710655&83.81=35.32022663933653&83.82=87.43354119148215&expr=0&name=1&epilog=2&left=3&matmul=4&h=5&w=6&init=7&url=8&min=9&max=10&dropout=11&left.anim=12&alg=13&left.block=14&k%20blocks=15&left.layout=16&polarity=17&left%20placement=18&right%20placement=19&result%20placement=20&left.left=21&left.left.left=22&left.left.left.left=23&left.left.left.right=24&left.left.left.anim=25&left.left.left.block=26&left.left.left.layout=27&left.left.right=28&left.left.right.anim=29&left.left.right.block=30&left.left.right.layout=31&left.left.right.left=32&left.left.right.right=33&left.left.anim=34&left.left.block=35&left.left.layout=36&left.right=37&left.right.left=38&left.right.right=39&left.right.anim=40&left.right.block=41&left.right.layout=42&right=43&anim=44&fuse=45&speed=46&hide%20inputs=47&spin=48&folder=49&block=50&i%20blocks=51&j%20blocks=52&layout=53&scheme=54&gap=55&scatter=56&molecule=57&blast=58&deco=59&legends=60&shape=61&spotlight=62&row%20guides=63&flow%20guides=64&lens%20size=65&magnification=66&interior%20spotlight=67&axes=68&viz=69&sensitivity=70&min%20size=71&min%20light=72&max%20light=73&elem%20scale=74&zero%20hue=75&hue%20gap=76&hue%20spread=77&diag=78&cam=79&x=80&y=81&z=82&cam.target=83&compress=84), may take a few seconds to load model weights):


![This is another attention head from GPT2](/assets/images/inside-the-matrix/gpt2_0_2c.jpg){:style="width:100%"}



Things to note:



* This head spreads attention very evenly. This has the effect of delivering a relatively _unweighted_ average of `V` (or rather, the appropriate causal prefix of `V`) to each row in `attn @ V`, as can be seen in [this animation](https://bhosmer.github.io/mm/index.html?0=out%20%3D%20(attn%20%3D%20(Q%20%3D%20input_0_0%20%40%20wQ_0_2)%20%40%20(K_t%20%3D%20wK_t_0_2%20%40%20input_t_0_0))%20%40%20(V%20%3D%20input_0_0%20%40%20wV_0_2)%20%40%20wO_0_2&1=out&2=none&49=closed&84=true&3.1=attn%20%40%20V&3.4=true&3.5=32&3.6=32&3.7=row%20major&3.8=&3.9=-1&3.10=1&3.11=0&3.2=none&12.13=vmprod&14.15=1&16.17=positive&16.18=left&16.19=bottom&16.20=back&21.1=attn&21.4=true&21.2=softmax(tril(x%2Fsqrt(k)))&22.1=Q&22.4=true&22.2=none&23.1=input_0_0&23.4=false&23.5=256&23.6=768&23.7=url&23.9=-1&23.10=1&23.11=0&23.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_input0_256_768.csv&23.0=&24.1=wQ_0_2&24.4=false&24.5=768&24.6=64&24.7=url&24.9=-1&24.10=1&24.11=0&24.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_wq2_768_64.csv&24.0=&25.13=none&26.15=1&27.17=positive&27.18=left&27.19=bottom&27.20=back&28.2=none&29.13=none&30.15=1&31.17=positive&31.18=right&31.19=top&31.20=back&32.1=wK_t_0_2&32.4=false&32.5=64&32.6=768&32.7=url&32.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_wk_t2_64_768.csv&32.9=-1&32.10=1&32.11=0&32.0=&33.1=input_t_0_0&33.4=false&33.5=768&33.6=256&33.7=url&33.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_input_t0_768_256.csv&33.9=-1&33.10=1&33.11=0&33.0=&28.1=K_t&28.4=true&34.13=none&35.15=1&36.17=negative&36.18=left&36.19=top&36.20=front&37.1=V&37.4=true&37.2=none&38.1=input_0_0&38.4=false&38.5=256&38.6=768&38.7=url&38.9=-1&38.10=1&38.11=0&38.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_input0_256_768.csv&38.0=&39.1=wV_0_2&39.4=false&39.5=768&39.6=64&39.7=url&39.9=-1&39.10=1&39.11=0&39.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_wv2_768_64.csv&39.0=&40.13=none&41.15=1&42.17=negative&42.18=right&42.19=top&42.20=back&43.1=wO_0_2&43.4=false&43.5=64&43.6=768&43.7=url&43.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_wo2_64_768.csv&43.9=-1&43.10=1&43.11=0&43.0=&44.45=sync&44.46=16&44.47=false&44.13=vmprod&44.48=0&44.49=open&50.51=1&50.52=1&50.15=1&53.54=blocks&53.55=24&53.56=0&53.57=1&53.58=0&53.17=negative&53.18=left&53.19=top&53.20=front&59.60=6&59.61=true&59.62=4&59.63=0.73&59.64=0&59.65=0.5&59.66=12&59.67=false&59.68=false&59.49=closed&69.70=local&69.71=0.4&69.72=0.4&69.73=0.9&69.74=2&69.75=0.75&69.76=0.75&69.77=0.03&69.49=open&78.8=&78.49=closed&79.80=11.34872888812131&79.81=324.07536950158396&79.82=239.8893041928473&83.80=11.804686909150822&83.81=25.33948904441141&83.82=46.896270190786204&expr=0&name=1&epilog=2&left=3&matmul=4&h=5&w=6&init=7&url=8&min=9&max=10&dropout=11&left.anim=12&alg=13&left.block=14&k%20blocks=15&left.layout=16&polarity=17&left%20placement=18&right%20placement=19&result%20placement=20&left.left=21&left.left.left=22&left.left.left.left=23&left.left.left.right=24&left.left.left.anim=25&left.left.left.block=26&left.left.left.layout=27&left.left.right=28&left.left.right.anim=29&left.left.right.block=30&left.left.right.layout=31&left.left.right.left=32&left.left.right.right=33&left.left.anim=34&left.left.block=35&left.left.layout=36&left.right=37&left.right.left=38&left.right.right=39&left.right.anim=40&left.right.block=41&left.right.layout=42&right=43&anim=44&fuse=45&speed=46&hide%20inputs=47&spin=48&folder=49&block=50&i%20blocks=51&j%20blocks=52&layout=53&scheme=54&gap=55&scatter=56&molecule=57&blast=58&deco=59&legends=60&shape=61&spotlight=62&row%20guides=63&flow%20guides=64&lens%20size=65&magnification=66&interior%20spotlight=67&axes=68&viz=69&sensitivity=70&min%20size=71&min%20light=72&max%20light=73&elem%20scale=74&zero%20hue=75&hue%20gap=76&hue%20spread=77&diag=78&cam=79&x=80&y=81&z=82&cam.target=83&compress=84): as we move down the attention score triangle, the `attn[i] @ V` vector-matrix product is small fluctuations away from being simply a downscaled, progressively revealed copy of `V`.
* `attn @ V` has [striking vertical uniformity](https://bhosmer.github.io/mm/index.html?0=out%20%3D%20(attn%20%3D%20(Q%20%3D%20input_0_0%20%40%20wQ_0_2)%20%40%20(K_t%20%3D%20wK_t_0_2%20%40%20input_t_0_0))%20%40%20(V%20%3D%20input_0_0%20%40%20wV_0_2)%20%40%20wO_0_2&1=out&2=none&49=closed&84=true&3.1=attn%20%40%20V&3.4=true&3.5=32&3.6=32&3.7=row%20major&3.8=&3.9=-1&3.10=1&3.11=0&3.2=none&12.13=vmprod&14.15=1&16.17=positive&16.18=left&16.19=bottom&16.20=back&21.1=attn&21.4=true&21.2=softmax(tril(x%2Fsqrt(k)))&22.1=Q&22.4=true&22.2=none&23.1=input_0_0&23.4=false&23.5=256&23.6=768&23.7=url&23.9=-1&23.10=1&23.11=0&23.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_input0_256_768.csv&23.0=&24.1=wQ_0_2&24.4=false&24.5=768&24.6=64&24.7=url&24.9=-1&24.10=1&24.11=0&24.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_wq2_768_64.csv&24.0=&25.13=none&26.15=1&27.17=positive&27.18=left&27.19=bottom&27.20=back&28.2=none&29.13=none&30.15=1&31.17=positive&31.18=right&31.19=top&31.20=back&32.1=wK_t_0_2&32.4=false&32.5=64&32.6=768&32.7=url&32.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_wk_t2_64_768.csv&32.9=-1&32.10=1&32.11=0&32.0=&33.1=input_t_0_0&33.4=false&33.5=768&33.6=256&33.7=url&33.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_input_t0_768_256.csv&33.9=-1&33.10=1&33.11=0&33.0=&28.1=K_t&28.4=true&34.13=none&35.15=1&36.17=negative&36.18=left&36.19=top&36.20=front&37.1=V&37.4=true&37.2=none&38.1=input_0_0&38.4=false&38.5=256&38.6=768&38.7=url&38.9=-1&38.10=1&38.11=0&38.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_input0_256_768.csv&38.0=&39.1=wV_0_2&39.4=false&39.5=768&39.6=64&39.7=url&39.9=-1&39.10=1&39.11=0&39.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_wv2_768_64.csv&39.0=&40.13=none&41.15=1&42.17=negative&42.18=right&42.19=top&42.20=back&43.1=wO_0_2&43.4=false&43.5=64&43.6=768&43.7=url&43.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_wo2_64_768.csv&43.9=-1&43.10=1&43.11=0&43.0=&44.45=sync&44.46=16&44.47=false&44.13=none&44.48=0&44.49=open&50.51=1&50.52=1&50.15=1&53.54=blocks&53.55=24&53.56=0&53.57=1&53.58=0&53.17=negative&53.18=left&53.19=top&53.20=front&59.60=6&59.61=true&59.62=4&59.63=0.73&59.64=0&59.65=0.5&59.66=12&59.67=false&59.68=false&59.49=open&69.70=local&69.71=0.2&69.72=0.2&69.73=0.9&69.74=2&69.75=0.75&69.76=0.75&69.77=0.03&69.49=open&78.8=&78.49=open&79.80=-152.24249732960024&79.81=115.78244265148294&79.82=89.29496035154&83.80=20.231661185991296&83.81=61.75722293832386&83.82=52.45120329048098&expr=0&name=1&epilog=2&left=3&matmul=4&h=5&w=6&init=7&url=8&min=9&max=10&dropout=11&left.anim=12&alg=13&left.block=14&k%20blocks=15&left.layout=16&polarity=17&left%20placement=18&right%20placement=19&result%20placement=20&left.left=21&left.left.left=22&left.left.left.left=23&left.left.left.right=24&left.left.left.anim=25&left.left.left.block=26&left.left.left.layout=27&left.left.right=28&left.left.right.anim=29&left.left.right.block=30&left.left.right.layout=31&left.left.right.left=32&left.left.right.right=33&left.left.anim=34&left.left.block=35&left.left.layout=36&left.right=37&left.right.left=38&left.right.right=39&left.right.anim=40&left.right.block=41&left.right.layout=42&right=43&anim=44&fuse=45&speed=46&hide%20inputs=47&spin=48&folder=49&block=50&i%20blocks=51&j%20blocks=52&layout=53&scheme=54&gap=55&scatter=56&molecule=57&blast=58&deco=59&legends=60&shape=61&spotlight=62&row%20guides=63&flow%20guides=64&lens%20size=65&magnification=66&interior%20spotlight=67&axes=68&viz=69&sensitivity=70&min%20size=71&min%20light=72&max%20light=73&elem%20scale=74&zero%20hue=75&hue%20gap=76&hue%20spread=77&diag=78&cam=79&x=80&y=81&z=82&cam.target=83&compress=84) - in large columnar regions of the embedding, the same value patterns persist over _the entire sequence_. One can think of these as properties shared by every token.
* Aside: on the one hand one might expect _some_ uniformity in `attn @ V` given the effect of very evenly spread attention. But each row has been constructed from only a causal subsequence of `V` rather than the whole thing - why is that not causing more variation, like a progressive morphing as one moves down the sequence? [By visual inspection V isn't uniform along its length](https://bhosmer.github.io/mm/index.html?0=out%20%3D%20(attn%20%3D%20(Q%20%3D%20input_0_0%20%40%20wQ_0_2)%20%40%20(K_t%20%3D%20wK_t_0_2%20%40%20input_t_0_0))%20%40%20(V%20%3D%20input_0_0%20%40%20wV_0_2)%20%40%20wO_0_2&1=out&2=none&49=closed&84=true&3.1=attn%20%40%20V&3.4=true&3.5=32&3.6=32&3.7=row%20major&3.8=&3.9=-1&3.10=1&3.11=0&3.2=none&12.13=vmprod&14.15=1&16.17=positive&16.18=left&16.19=bottom&16.20=back&21.1=attn&21.4=true&21.2=softmax(tril(x%2Fsqrt(k)))&22.1=Q&22.4=true&22.2=none&23.1=input_0_0&23.4=false&23.5=256&23.6=768&23.7=url&23.9=-1&23.10=1&23.11=0&23.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_input0_256_768.csv&23.0=&24.1=wQ_0_2&24.4=false&24.5=768&24.6=64&24.7=url&24.9=-1&24.10=1&24.11=0&24.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_wq2_768_64.csv&24.0=&25.13=none&26.15=1&27.17=positive&27.18=left&27.19=bottom&27.20=back&28.2=none&29.13=none&30.15=1&31.17=positive&31.18=right&31.19=top&31.20=back&32.1=wK_t_0_2&32.4=false&32.5=64&32.6=768&32.7=url&32.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_wk_t2_64_768.csv&32.9=-1&32.10=1&32.11=0&32.0=&33.1=input_t_0_0&33.4=false&33.5=768&33.6=256&33.7=url&33.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_input_t0_768_256.csv&33.9=-1&33.10=1&33.11=0&33.0=&28.1=K_t&28.4=true&34.13=none&35.15=1&36.17=negative&36.18=left&36.19=top&36.20=front&37.1=V&37.4=true&37.2=none&38.1=input_0_0&38.4=false&38.5=256&38.6=768&38.7=url&38.9=-1&38.10=1&38.11=0&38.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_input0_256_768.csv&38.0=&39.1=wV_0_2&39.4=false&39.5=768&39.6=64&39.7=url&39.9=-1&39.10=1&39.11=0&39.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_wv2_768_64.csv&39.0=&40.13=none&41.15=1&42.17=negative&42.18=right&42.19=top&42.20=back&43.1=wO_0_2&43.4=false&43.5=64&43.6=768&43.7=url&43.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_wo2_64_768.csv&43.9=-1&43.10=1&43.11=0&43.0=&44.45=sync&44.46=16&44.47=false&44.13=none&44.48=0&44.49=open&50.51=1&50.52=1&50.15=1&53.54=blocks&53.55=24&53.56=0&53.57=1&53.58=0&53.17=negative&53.18=left&53.19=top&53.20=front&59.60=6&59.61=true&59.62=4&59.63=0.73&59.64=0&59.65=0.5&59.66=12&59.67=false&59.68=false&59.49=open&69.70=local&69.71=0.2&69.72=0.2&69.73=0.9&69.74=2&69.75=0.75&69.76=0.75&69.77=0.03&69.49=open&78.8=&78.49=open&79.80=8.296178745251016&79.81=-533.8678069620822&79.82=35.64126972299759&83.80=8.29674894856322&83.81=36.25749961529174&83.82=35.64126624185369&expr=0&name=1&epilog=2&left=3&matmul=4&h=5&w=6&init=7&url=8&min=9&max=10&dropout=11&left.anim=12&alg=13&left.block=14&k%20blocks=15&left.layout=16&polarity=17&left%20placement=18&right%20placement=19&result%20placement=20&left.left=21&left.left.left=22&left.left.left.left=23&left.left.left.right=24&left.left.left.anim=25&left.left.left.block=26&left.left.left.layout=27&left.left.right=28&left.left.right.anim=29&left.left.right.block=30&left.left.right.layout=31&left.left.right.left=32&left.left.right.right=33&left.left.anim=34&left.left.block=35&left.left.layout=36&left.right=37&left.right.left=38&left.right.right=39&left.right.anim=40&left.right.block=41&left.right.layout=42&right=43&anim=44&fuse=45&speed=46&hide%20inputs=47&spin=48&folder=49&block=50&i%20blocks=51&j%20blocks=52&layout=53&scheme=54&gap=55&scatter=56&molecule=57&blast=58&deco=59&legends=60&shape=61&spotlight=62&row%20guides=63&flow%20guides=64&lens%20size=65&magnification=66&interior%20spotlight=67&axes=68&viz=69&sensitivity=70&min%20size=71&min%20light=72&max%20light=73&elem%20scale=74&zero%20hue=75&hue%20gap=76&hue%20spread=77&diag=78&cam=79&x=80&y=81&z=82&cam.target=83&compress=84), so the answer must lie in some more subtle property of its distribution of values.
* Finally, this head's output is [even more vertically uniform after out-projection](https://bhosmer.github.io/mm/index.html?0=out%20%3D%20(attn%20%3D%20(Q%20%3D%20input_0_0%20%40%20wQ_0_2)%20%40%20(K_t%20%3D%20wK_t_0_2%20%40%20input_t_0_0))%20%40%20(V%20%3D%20input_0_0%20%40%20wV_0_2)%20%40%20wO_0_2&1=out&2=none&49=closed&84=true&3.1=attn%20%40%20V&3.4=true&3.5=32&3.6=32&3.7=row%20major&3.8=&3.9=-1&3.10=1&3.11=0&3.2=none&12.13=vmprod&14.15=1&16.17=positive&16.18=left&16.19=bottom&16.20=back&21.1=attn&21.4=true&21.2=softmax(tril(x%2Fsqrt(k)))&22.1=Q&22.4=true&22.2=none&23.1=input_0_0&23.4=false&23.5=256&23.6=768&23.7=url&23.9=-1&23.10=1&23.11=0&23.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_input0_256_768.csv&23.0=&24.1=wQ_0_2&24.4=false&24.5=768&24.6=64&24.7=url&24.9=-1&24.10=1&24.11=0&24.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_wq2_768_64.csv&24.0=&25.13=none&26.15=1&27.17=positive&27.18=left&27.19=bottom&27.20=back&28.2=none&29.13=none&30.15=1&31.17=positive&31.18=right&31.19=top&31.20=back&32.1=wK_t_0_2&32.4=false&32.5=64&32.6=768&32.7=url&32.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_wk_t2_64_768.csv&32.9=-1&32.10=1&32.11=0&32.0=&33.1=input_t_0_0&33.4=false&33.5=768&33.6=256&33.7=url&33.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_input_t0_768_256.csv&33.9=-1&33.10=1&33.11=0&33.0=&28.1=K_t&28.4=true&34.13=none&35.15=1&36.17=negative&36.18=left&36.19=top&36.20=front&37.1=V&37.4=true&37.2=none&38.1=input_0_0&38.4=false&38.5=256&38.6=768&38.7=url&38.9=-1&38.10=1&38.11=0&38.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_input0_256_768.csv&38.0=&39.1=wV_0_2&39.4=false&39.5=768&39.6=64&39.7=url&39.9=-1&39.10=1&39.11=0&39.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_wv2_768_64.csv&39.0=&40.13=none&41.15=1&42.17=negative&42.18=right&42.19=top&42.20=back&43.1=wO_0_2&43.4=false&43.5=64&43.6=768&43.7=url&43.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_wo2_64_768.csv&43.9=-1&43.10=1&43.11=0&43.0=&44.45=sync&44.46=16&44.47=false&44.13=none&44.48=0&44.49=open&50.51=1&50.52=1&50.15=1&53.54=blocks&53.55=24&53.56=0&53.57=1&53.58=0&53.17=negative&53.18=left&53.19=top&53.20=front&59.60=6&59.61=true&59.62=4&59.63=0.73&59.64=0&59.65=0.5&59.66=12&59.67=false&59.68=false&59.49=open&69.70=local&69.71=0.2&69.72=0.2&69.73=0.9&69.74=2&69.75=0.75&69.76=0.75&69.77=0.03&69.49=open&78.8=&78.49=open&79.80=41.37507219272118&79.81=4.367136718959145&79.82=430.5595129727994&83.80=607.5332301692057&83.81=-2.548000389888877&83.82=-122.74351758382484&expr=0&name=1&epilog=2&left=3&matmul=4&h=5&w=6&init=7&url=8&min=9&max=10&dropout=11&left.anim=12&alg=13&left.block=14&k%20blocks=15&left.layout=16&polarity=17&left%20placement=18&right%20placement=19&result%20placement=20&left.left=21&left.left.left=22&left.left.left.left=23&left.left.left.right=24&left.left.left.anim=25&left.left.left.block=26&left.left.left.layout=27&left.left.right=28&left.left.right.anim=29&left.left.right.block=30&left.left.right.layout=31&left.left.right.left=32&left.left.right.right=33&left.left.anim=34&left.left.block=35&left.left.layout=36&left.right=37&left.right.left=38&left.right.right=39&left.right.anim=40&left.right.block=41&left.right.layout=42&right=43&anim=44&fuse=45&speed=46&hide%20inputs=47&spin=48&folder=49&block=50&i%20blocks=51&j%20blocks=52&layout=53&scheme=54&gap=55&scatter=56&molecule=57&blast=58&deco=59&legends=60&shape=61&spotlight=62&row%20guides=63&flow%20guides=64&lens%20size=65&magnification=66&interior%20spotlight=67&axes=68&viz=69&sensitivity=70&min%20size=71&min%20light=72&max%20light=73&elem%20scale=74&zero%20hue=75&hue%20gap=76&hue%20spread=77&diag=78&cam=79&x=80&y=81&z=82&cam.target=83&compress=84)
* the strong impression being that the bulk of the information being delivered by this attention head consists of properties which are shared by every token in the sequence. The composition of its [output projection weights](https://bhosmer.github.io/mm/index.html?0=out%20%3D%20(attn%20%3D%20(Q%20%3D%20input_0_0%20%40%20wQ_0_2)%20%40%20(K_t%20%3D%20wK_t_0_2%20%40%20input_t_0_0))%20%40%20(V%20%3D%20input_0_0%20%40%20wV_0_2)%20%40%20wO_0_2&1=out&2=none&49=closed&84=true&3.1=attn%20%40%20V&3.4=true&3.5=32&3.6=32&3.7=row%20major&3.8=&3.9=-1&3.10=1&3.11=0&3.2=none&12.13=vmprod&14.15=1&16.17=positive&16.18=left&16.19=bottom&16.20=back&21.1=attn&21.4=true&21.2=softmax(tril(x%2Fsqrt(k)))&22.1=Q&22.4=true&22.2=none&23.1=input_0_0&23.4=false&23.5=256&23.6=768&23.7=url&23.9=-1&23.10=1&23.11=0&23.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_input0_256_768.csv&23.0=&24.1=wQ_0_2&24.4=false&24.5=768&24.6=64&24.7=url&24.9=-1&24.10=1&24.11=0&24.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_wq2_768_64.csv&24.0=&25.13=none&26.15=1&27.17=positive&27.18=left&27.19=bottom&27.20=back&28.2=none&29.13=none&30.15=1&31.17=positive&31.18=right&31.19=top&31.20=back&32.1=wK_t_0_2&32.4=false&32.5=64&32.6=768&32.7=url&32.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_wk_t2_64_768.csv&32.9=-1&32.10=1&32.11=0&32.0=&33.1=input_t_0_0&33.4=false&33.5=768&33.6=256&33.7=url&33.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_input_t0_768_256.csv&33.9=-1&33.10=1&33.11=0&33.0=&28.1=K_t&28.4=true&34.13=none&35.15=1&36.17=negative&36.18=left&36.19=top&36.20=front&37.1=V&37.4=true&37.2=none&38.1=input_0_0&38.4=false&38.5=256&38.6=768&38.7=url&38.9=-1&38.10=1&38.11=0&38.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_input0_256_768.csv&38.0=&39.1=wV_0_2&39.4=false&39.5=768&39.6=64&39.7=url&39.9=-1&39.10=1&39.11=0&39.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_wv2_768_64.csv&39.0=&40.13=none&41.15=1&42.17=negative&42.18=right&42.19=top&42.20=back&43.1=wO_0_2&43.4=false&43.5=64&43.6=768&43.7=url&43.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_wo2_64_768.csv&43.9=-1&43.10=1&43.11=0&43.0=&44.45=sync&44.46=16&44.47=false&44.13=none&44.48=0&44.49=open&50.51=1&50.52=1&50.15=1&53.54=blocks&53.55=24&53.56=0&53.57=1&53.58=0&53.17=negative&53.18=left&53.19=top&53.20=front&59.60=6&59.61=true&59.62=4&59.63=0.73&59.64=0&59.65=0.5&59.66=12&59.67=false&59.68=false&59.49=open&69.70=local&69.71=0.2&69.72=0.2&69.73=0.9&69.74=2&69.75=0.75&69.76=0.75&69.77=0.03&69.49=open&78.8=&78.49=open&79.80=136.19712021298585&79.81=351.47497630691043&79.82=254.9066405965837&83.80=554.2569175811409&83.81=-39.63963114876448&83.82=-109.72659308933949&expr=0&name=1&epilog=2&left=3&matmul=4&h=5&w=6&init=7&url=8&min=9&max=10&dropout=11&left.anim=12&alg=13&left.block=14&k%20blocks=15&left.layout=16&polarity=17&left%20placement=18&right%20placement=19&result%20placement=20&left.left=21&left.left.left=22&left.left.left.left=23&left.left.left.right=24&left.left.left.anim=25&left.left.left.block=26&left.left.left.layout=27&left.left.right=28&left.left.right.anim=29&left.left.right.block=30&left.left.right.layout=31&left.left.right.left=32&left.left.right.right=33&left.left.anim=34&left.left.block=35&left.left.layout=36&left.right=37&left.right.left=38&left.right.right=39&left.right.anim=40&left.right.block=41&left.right.layout=42&right=43&anim=44&fuse=45&speed=46&hide%20inputs=47&spin=48&folder=49&block=50&i%20blocks=51&j%20blocks=52&layout=53&scheme=54&gap=55&scatter=56&molecule=57&blast=58&deco=59&legends=60&shape=61&spotlight=62&row%20guides=63&flow%20guides=64&lens%20size=65&magnification=66&interior%20spotlight=67&axes=68&viz=69&sensitivity=70&min%20size=71&min%20light=72&max%20light=73&elem%20scale=74&zero%20hue=75&hue%20gap=76&hue%20spread=77&diag=78&cam=79&x=80&y=81&z=82&cam.target=83&compress=84) reinforces this intuition.

Overall, it's hard to resist the idea that the extremely regular, highly structured information this attention head produces might be obtained by computational means that are a bit... less lavish. Of course this isn't an unexplored area, but the specificity and richness of signal of the visualized computation has been useful in generating new ideas, and reasoning about existing ones.


### 4d Revisiting the pitch: invariants for free

Stepping back, it's worth reiterating that the reason we can visualize nontrivially compound operations like attention heads and have them remain intuitive is that important algebraic properties - like how argument shapes are constrained, or which parallelization axes intersect which operations - _don't require additional thinking_: they arise directly from the geometry of the visualized object, rather than being additional rules to keep in mind.

For example, in these attention head visualizations it's immediately obvious that



* `Q` and `attn @ V` are the same length, `K` and `V` are the same length, and the lengths of these pairs are independent of each other
* `Q` and `K` are the same width, `V` and `attn @ V` are the same width, and the widths of these pairs are independent of each other.

These properties are true by construction, as a simple consequence of which parts of the compound structure the constituents inhabit and how they are oriented.

This "properties for free" benefit can be especially useful when exploring variations on a canonical structure - an obvious example being the one-row-high attention matrix in autoregressive token-at-a-time decoding ([open in mm](https://bhosmer.github.io/mm/index.html?0=out%20%3D%20(attn%20%3D%20(Q%20%3D%20input_0_5%20%40%20wQ_5_4)%20%40%20(K_t%20%3D%20wK_t_5_4%20%40%20input_t_0_5))%20%40%20(V%20%3D%20input_0_5%20%40%20wV_5_4)%20%40%20wO_5_4&1=out&2=none&24=closed&84=true&3.1=attn%20%40%20V&3.4=true&3.5=32&3.6=32&3.7=row%20major&3.8=&3.9=-1&3.10=1&3.11=0&3.2=none&12.13=vmprod&14.15=1&16.17=positive&16.18=left&16.19=bottom&16.20=back&21.1=attn&21.4=true&21.2=softmax(x%2Fsqrt(k))&22.1=Q&22.4=true&22.2=none&23.1=input_0_5&23.4=false&23.5=1&23.6=768&23.7=url&23.9=-1&23.10=1&23.11=0&23.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input0_256_768.csv&23.0=&23.24=open&25.1=wQ_5_4&25.4=false&25.5=768&25.6=64&25.7=url&25.9=-1&25.10=1&25.11=0&25.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wq4_768_64.csv&25.0=&26.13=vmprod&27.15=1&28.17=positive&28.18=left&28.19=bottom&28.20=back&22.24=open&29.2=none&30.13=none&31.15=1&32.17=positive&32.18=right&32.19=top&32.20=back&33.1=wK_t_5_4&33.4=false&33.5=64&33.6=768&33.7=url&33.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wk_t4_64_768.csv&33.9=-1&33.10=1&33.11=0&33.0=&34.1=input_t_0_5&34.4=false&34.5=768&34.6=256&34.7=url&34.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input_t0_768_256.csv&34.9=-1&34.10=1&34.11=0&34.0=&29.1=K_t&29.4=true&35.13=vmprod&36.15=1&37.17=negative&37.18=left&37.19=top&37.20=front&21.24=open&38.1=V&38.4=true&38.2=none&39.1=input_0_5&39.4=false&39.5=256&39.6=768&39.7=url&39.9=-1&39.10=1&39.11=0&39.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input0_256_768.csv&39.0=&40.1=wV_5_4&40.4=false&40.5=768&40.6=64&40.7=url&40.9=-1&40.10=1&40.11=0&40.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wv4_768_64.csv&40.0=&41.13=none&42.15=1&43.17=negative&43.18=right&43.19=top&43.20=back&3.24=closed&44.1=wO_5_4&44.4=false&44.5=64&44.6=768&44.7=url&44.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wo4_64_768.csv&44.9=-1&44.10=1&44.11=0&44.0=&45.46=sync&45.47=16&45.48=false&45.13=none&45.49=0&45.24=open&50.51=1&50.52=1&50.15=1&53.54=blocks&53.55=24&53.56=0&53.57=1&53.58=0&53.17=negative&53.18=left&53.19=top&53.20=front&59.60=10&59.61=true&59.62=4&59.63=0.394&59.64=0&59.65=0.5&59.66=12&59.67=false&59.68=false&59.24=open&69.70=local&69.71=0.05&69.72=0.2&69.73=0.9&69.74=2&69.75=0.75&69.76=0.75&69.77=0.03&78.8=&79.80=-289.3020871171715&79.81=176.55051931108687&79.82=202.12550566094345&83.80=6.09420901744693&83.81=-60.94451681776672&83.82=-55.94371166611936&expr=0&name=1&epilog=2&left=3&matmul=4&h=5&w=6&init=7&url=8&min=9&max=10&dropout=11&left.anim=12&alg=13&left.block=14&k%20blocks=15&left.layout=16&polarity=17&left%20placement=18&right%20placement=19&result%20placement=20&left.left=21&left.left.left=22&left.left.left.left=23&folder=24&left.left.left.right=25&left.left.left.anim=26&left.left.left.block=27&left.left.left.layout=28&left.left.right=29&left.left.right.anim=30&left.left.right.block=31&left.left.right.layout=32&left.left.right.left=33&left.left.right.right=34&left.left.anim=35&left.left.block=36&left.left.layout=37&left.right=38&left.right.left=39&left.right.right=40&left.right.anim=41&left.right.block=42&left.right.layout=43&right=44&anim=45&fuse=46&speed=47&hide%20inputs=48&spin=49&block=50&i%20blocks=51&j%20blocks=52&layout=53&scheme=54&gap=55&scatter=56&molecule=57&blast=58&deco=59&legends=60&shape=61&spotlight=62&row%20guides=63&flow%20guides=64&lens%20size=65&magnification=66&interior%20spotlight=67&axes=68&viz=69&sensitivity=70&min%20size=71&min%20light=72&max%20light=73&elem%20scale=74&zero%20hue=75&hue%20gap=76&hue%20spread=77&diag=78&cam=79&x=80&y=81&z=82&cam.target=83&compress=84)):

![the one-row-high attention matrix in autoregressive token-at-a-time decoding](/assets/images/inside-the-matrix/gpt2_decode2.jpg){:style="width:100%"}




## 5 Parallelizing attention

In the animation of head 5, layer 4 above, we visualize 4 of the 6 matmuls in the attention head

as a fused chain of vector-matrix products, confirming the geometric intuition that the entire left-associative chain from input to output is _laminar_ along the shared `i` axis, and can be parallelized.


### 5a Example: partitioning along <code>i</code>

To parallelize the computation in practice, we would partition the input into blocks along the `i` axis. We can visualize this partition in the tool, by specifying that a given axis be partitioned into a particular number of blocks - in these examples we'll use 8, but there's nothing special about that number.

Among other things, this visualization makes clear that `wQ` (for in-projection), `K_t` and `V` (for attention) and `wO` (for out-projection) are needed in their entirety by each parallel computation, since they're adjacent to the partitioned matrices along those matrices' unpartitioned dimensions ([open in mm](https://bhosmer.github.io/mm/index.html?0=out%20%3D%20(attn%20%3D%20(Q%20%3D%20input_0_5%20%40%20wQ_5_4)%20%40%20(K_t%20%3D%20wK_t_5_4%20%40%20input_t_0_5))%20%40%20(V%20%3D%20input_0_5%20%40%20wV_5_4)%20%40%20wO_5_4&1=out&2=none&49=closed&84=true&3.1=attn%20%40%20V&3.4=true&3.5=32&3.6=32&3.7=row%20major&3.8=&3.9=-1&3.10=1&3.11=0&3.2=none&12.13=vmprod&14.15=1&16.17=positive&16.18=left&16.19=bottom&16.20=back&21.1=attn&21.4=true&21.2=softmax(tril(x%2Fsqrt(k)))&22.1=Q&22.4=true&22.2=none&23.1=input_0_5&23.4=false&23.5=256&23.6=768&23.7=url&23.9=-1&23.10=1&23.11=0&23.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input0_256_768.csv&23.0=&24.1=wQ_5_4&24.4=false&24.5=768&24.6=64&24.7=url&24.9=-1&24.10=1&24.11=0&24.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wq4_768_64.csv&24.0=&25.13=vmprod&26.15=1&27.17=positive&27.18=left&27.19=bottom&27.20=back&28.2=none&29.13=none&30.15=1&31.17=positive&31.18=right&31.19=top&31.20=back&32.1=wK_t_5_4&32.4=false&32.5=64&32.6=768&32.7=url&32.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wk_t4_64_768.csv&32.9=-1&32.10=1&32.11=0&32.0=&33.1=input_t_0_5&33.4=false&33.5=768&33.6=256&33.7=url&33.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input_t0_768_256.csv&33.9=-1&33.10=1&33.11=0&33.0=&28.1=K_t&28.4=true&34.13=vmprod&35.15=1&36.17=negative&36.18=left&36.19=top&36.20=front&37.1=V&37.4=true&37.2=none&38.1=input_0_5&38.4=false&38.5=256&38.6=768&38.7=url&38.9=-1&38.10=1&38.11=0&38.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input0_256_768.csv&38.0=&39.1=wV_5_4&39.4=false&39.5=768&39.6=64&39.7=url&39.9=-1&39.10=1&39.11=0&39.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wv4_768_64.csv&39.0=&40.13=none&41.15=1&42.17=negative&42.18=right&42.19=top&42.20=back&43.1=wO_5_4&43.4=false&43.5=64&43.6=768&43.7=url&43.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wo4_64_768.csv&43.9=-1&43.10=1&43.11=0&43.0=&44.45=sync&44.46=16&44.47=false&44.13=none&44.48=0&44.49=closed&50.51=8&50.52=1&50.15=1&50.49=open&53.54=blocks&53.55=10&53.56=0&53.57=1&53.58=0&53.17=negative&53.18=left&53.19=top&53.20=front&53.49=closed&59.60=10&59.61=true&59.62=4&59.63=0.507&59.64=0&59.65=0.5&59.66=12&59.67=false&59.68=false&59.49=open&69.70=local&69.71=0.2&69.72=0.3&69.73=0.9&69.74=2&69.75=0.75&69.76=0.75&69.77=0.03&69.49=closed&78.8=&78.49=open&79.80=-452.09425433307837&79.81=-10.01467989007457&79.82=392.9851223674549&83.80=-27.91725760321879&83.81=-18.858991089590095&83.82=-140.6826497984033&expr=0&name=1&epilog=2&left=3&matmul=4&h=5&w=6&init=7&url=8&min=9&max=10&dropout=11&left.anim=12&alg=13&left.block=14&k%20blocks=15&left.layout=16&polarity=17&left%20placement=18&right%20placement=19&result%20placement=20&left.left=21&left.left.left=22&left.left.left.left=23&left.left.left.right=24&left.left.left.anim=25&left.left.left.block=26&left.left.left.layout=27&left.left.right=28&left.left.right.anim=29&left.left.right.block=30&left.left.right.layout=31&left.left.right.left=32&left.left.right.right=33&left.left.anim=34&left.left.block=35&left.left.layout=36&left.right=37&left.right.left=38&left.right.right=39&left.right.anim=40&left.right.block=41&left.right.layout=42&right=43&anim=44&fuse=45&speed=46&hide%20inputs=47&spin=48&folder=49&block=50&i%20blocks=51&j%20blocks=52&layout=53&scheme=54&gap=55&scatter=56&molecule=57&blast=58&deco=59&legends=60&shape=61&spotlight=62&row%20guides=63&flow%20guides=64&lens%20size=65&magnification=66&interior%20spotlight=67&axes=68&viz=69&sensitivity=70&min%20size=71&min%20light=72&max%20light=73&elem%20scale=74&zero%20hue=75&hue%20gap=76&hue%20spread=77&diag=78&cam=79&x=80&y=81&z=82&cam.target=83&compress=84)):

![wQ (for in-projection), K_t and V (for attention) and wO (for out-projection) are needed in their entirety by each parallel computation](/assets/images/inside-the-matrix/gpt2_parti.jpg){:style="width:100%"}



### 5b Example: double partitioning

As an example of partitioning along _multiple_ axes, we can visualize some recent work which innovates in this space ([Block Parallel Transformer](https://arxiv.org/pdf/2305.19370.pdf), building on work done in e.g. [Flash Attention](https://arxiv.org/pdf/2205.14135.pdf) and its antecedents).

First, BPT partitions along `i` as described above - and actually extends this horizontal partitioning of the sequence into chunks all the way through the second (FFN) half of the attention layer as well. (We'll visualize this in a later section.)

To fully attack the context length problem, a second partitioning is then added to MHA - that of the attention calculation itself (i.e., a partition along the `j` axis of `Q @ K_t`). The two partitions together divide attention into a grid of blocks ([open in mm](https://bhosmer.github.io/mm/index.html?0=out%20%3D%20(attn%20%3D%20(Q%20%3D%20input_0_5%20%40%20wQ_5_4)%20%40%20(K_t%20%3D%20wK_t_5_4%20%40%20input_t_0_5))%20%40%20(V%20%3D%20input_0_5%20%40%20wV_5_4)%20%40%20wO_5_4&1=out&2=none&16=closed&84=true&3.1=attn%20%40%20V&3.4=true&3.5=32&3.6=32&3.7=row%20major&3.8=&3.9=-1&3.10=1&3.11=0&3.2=none&12.13=vmprod&14.15=8&14.16=open&17.18=positive&17.19=left&17.20=bottom&17.21=back&22.1=attn&22.4=true&22.2=softmax(tril(x%2Fsqrt(k)))&23.1=Q&23.4=true&23.2=none&24.1=input_0_5&24.4=false&24.5=256&24.6=768&24.7=url&24.9=-1&24.10=1&24.11=0&24.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input0_256_768.csv&24.0=&25.1=wQ_5_4&25.4=false&25.5=768&25.6=64&25.7=url&25.9=-1&25.10=1&25.11=0&25.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wq4_768_64.csv&25.0=&26.13=vmprod&27.15=1&28.18=positive&28.19=left&28.20=bottom&28.21=back&29.2=none&30.13=none&31.15=1&32.18=positive&32.19=right&32.20=top&32.21=back&33.1=wK_t_5_4&33.4=false&33.5=64&33.6=768&33.7=url&33.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wk_t4_64_768.csv&33.9=-1&33.10=1&33.11=0&33.0=&34.1=input_t_0_5&34.4=false&34.5=768&34.6=256&34.7=url&34.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input_t0_768_256.csv&34.9=-1&34.10=1&34.11=0&34.0=&29.1=K_t&29.4=true&35.13=vmprod&36.15=1&37.18=negative&37.19=left&37.20=top&37.21=front&38.1=V&38.4=true&38.2=none&39.1=input_0_5&39.4=false&39.5=256&39.6=768&39.7=url&39.9=-1&39.10=1&39.11=0&39.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input0_256_768.csv&39.0=&40.1=wV_5_4&40.4=false&40.5=768&40.6=64&40.7=url&40.9=-1&40.10=1&40.11=0&40.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wv4_768_64.csv&40.0=&41.13=none&42.15=1&43.18=negative&43.19=right&43.20=top&43.21=back&3.16=open&44.1=wO_5_4&44.4=false&44.5=64&44.6=768&44.7=url&44.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wo4_64_768.csv&44.9=-1&44.10=1&44.11=0&44.0=&45.46=sync&45.47=16&45.48=false&45.13=none&45.49=0&45.16=closed&50.51=8&50.52=1&50.15=1&50.16=closed&53.54=blocks&53.55=10&53.56=0&53.57=1&53.58=0&53.18=negative&53.19=left&53.20=top&53.21=front&53.16=closed&59.60=10&59.61=true&59.62=4&59.63=0.507&59.64=0&59.65=0.5&59.66=12&59.67=false&59.68=false&59.16=open&69.70=local&69.71=0.2&69.72=0.3&69.73=0.9&69.74=2&69.75=0.75&69.76=0.75&69.77=0.03&69.16=closed&78.8=&78.16=open&79.80=-459.733038437248&79.81=-10.183892342609507&79.82=399.6251724834292&83.80=-27.91725760321879&83.81=-18.858991089590095&83.82=-140.6826497984033&expr=0&name=1&epilog=2&left=3&matmul=4&h=5&w=6&init=7&url=8&min=9&max=10&dropout=11&left.anim=12&alg=13&left.block=14&k%20blocks=15&folder=16&left.layout=17&polarity=18&left%20placement=19&right%20placement=20&result%20placement=21&left.left=22&left.left.left=23&left.left.left.left=24&left.left.left.right=25&left.left.left.anim=26&left.left.left.block=27&left.left.left.layout=28&left.left.right=29&left.left.right.anim=30&left.left.right.block=31&left.left.right.layout=32&left.left.right.left=33&left.left.right.right=34&left.left.anim=35&left.left.block=36&left.left.layout=37&left.right=38&left.right.left=39&left.right.right=40&left.right.anim=41&left.right.block=42&left.right.layout=43&right=44&anim=45&fuse=46&speed=47&hide%20inputs=48&spin=49&block=50&i%20blocks=51&j%20blocks=52&layout=53&scheme=54&gap=55&scatter=56&molecule=57&blast=58&deco=59&legends=60&shape=61&spotlight=62&row%20guides=63&flow%20guides=64&lens%20size=65&magnification=66&interior%20spotlight=67&axes=68&viz=69&sensitivity=70&min%20size=71&min%20light=72&max%20light=73&elem%20scale=74&zero%20hue=75&hue%20gap=76&hue%20spread=77&diag=78&cam=79&x=80&y=81&z=82&cam.target=83&compress=84)):

![The two partitions together divide attention into a grid of blocks](/assets/images/inside-the-matrix/gpt2_ik.jpg){:style="width:100%"}



This visualization makes clear



* the effectiveness of this double partitioning as an attack on the context length problem, since we've now visibly partitioned every occurrence of sequence length in the attention calculation
* the "reach" of this second partitioning: it's clear from the geometry that the in-projection computations of `K` and `V` can be partitioned along with the core double matmul

Note one subtlety: the visual implication here is that we can also parallelize the subsequent matmul `attn @ V` along `k` and sum the partial results [split-k style](https://github.com/NVIDIA/cutlass/blob/main/media/docs/efficient_gemm.md#parallelized-reductions), thus parallelizing the entire double matmul. But the row-wise softmax in `sdpa()` adds the requirement that each row have all its segments normalized before the corresponding row of `attn @ V` can be computed, adding an extra row-wise step between the attention calculation and the final matmul.


## 6 Sizes in an Attention Layer

The first (MHA) half of an attention layer is famously computationally demanding because of its quadratic complexity, but the second (FFN) half is demanding in its own right due to the width of its hidden dimension, typically 4 times that of the model's embedding dimension. Visualizing the biomass of a full attention layer can be useful in building intuition about how the two halves of the layer compare to each other.


### 6a Visualizing the full layer

Below is a full attention layer with the first half (MHA) in the background and the second (FFN) in the foreground. As usual, arrows point in the direction of computation.

Notes:



* This visualization doesn't depict individual attention heads, but instead shows the unsliced Q/K/V weights and projections surrounding a central double matmul. Of course this isn't a faithful visualization of the full MHA operation - but the goal here is to give a clearer sense of the relative matrix _sizes_ in the two halves of the layer, rather than the relative amounts of computation each half performs. (Also, randomized values are used rather than real weights.)
* The dimensions used here are downsized to keep the browser (relatively) happy, but the proportions are preserved (from [NanoGPT's small config](https://github.com/karpathy/nanoGPT/blob/master/model.py#L217)): model embedding dimension = 192 (from 768), FFN embedding dimension = 768 (from 3072), sequence length = 256 (from 1024), although sequence length is not fundamental to the model. (Visually, changes in sequence length would appear as changes in the width of the input blades, and consequently in the size of the attention hub and the height of the downstream vertical planes.)

[Open in mm](https://bhosmer.github.io/mm/index.html?0=layer_out%20%3D%20(attn_out%20%3D%20(attn%20%3D%20(Q%20%3D%20input%20%40%20wQ)%20%40%20(K_t%20%3D%20wK_t%20%40%20input_t))%20%40%20(V%20%3D%20input%20%40%20wV)%20%40%20wO)%20%40%20FFN_1%20%40%20FFN_2&1=layer_out&2=layernorm&16=closed&94=true&3.1=attn_out%20%40%20FFN_1&3.4=true&3.5=32&3.6=32&3.7=row%20major&3.8=&3.9=-1&3.10=1&3.11=0&3.2=gelu&12.13=inherit&14.15=1&14.16=open&17.18=positive&17.19=left&17.20=bottom&17.21=back&22.2=layernorm&23.13=inherit&24.15=1&24.16=open&25.18=negative&25.19=left&25.20=top&25.21=front&26.1=attn%20%40%20V&26.4=true&26.5=32&26.6=32&26.7=row%20major&26.8=&26.9=-1&26.10=1&26.11=0&26.2=none&27.13=vmprod&28.15=1&28.16=open&29.18=positive&29.19=left&29.20=bottom&29.21=back&30.1=attn&30.4=true&30.2=softmax(tril(x%2Fsqrt(k)))&31.1=Q&31.4=true&31.2=none&32.1=input&32.4=false&32.5=256&32.6=192&32.7=gaussian&32.9=-1&32.10=1&32.11=0&32.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input0_256_768.csv&32.0=&32.16=open&33.1=wQ&33.4=false&33.5=192&33.6=192&33.7=gaussian&33.9=-1&33.10=1&33.11=0&33.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wq4_768_64.csv&33.0=&33.16=open&34.13=vmprod&35.15=1&36.18=positive&36.19=left&36.20=bottom&36.21=back&31.16=closed&37.2=none&38.13=none&39.15=1&40.18=positive&40.19=right&40.20=top&40.21=back&41.1=wK_t&41.4=false&41.5=192&41.6=192&41.7=gaussian&41.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wk_t4_64_768.csv&41.9=-1&41.10=1&41.11=0&41.0=&41.16=open&42.1=input_t&42.4=false&42.5=192&42.6=256&42.7=gaussian&42.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input_t0_768_256.csv&42.9=-1&42.10=1&42.11=0&42.0=&42.16=open&37.1=K_t&37.4=true&37.16=closed&43.13=vmprod&44.15=1&44.16=open&45.18=negative&45.19=left&45.20=top&45.21=front&30.16=open&46.1=V&46.4=true&46.2=none&47.1=input&47.4=false&47.5=256&47.6=192&47.7=gaussian&47.9=-1&47.10=1&47.11=0&47.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input0_256_768.csv&47.0=&47.16=open&48.1=wV&48.4=false&48.5=192&48.6=192&48.7=gaussian&48.9=-1&48.10=1&48.11=0&48.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wv4_768_64.csv&48.0=&48.16=open&49.13=none&50.15=1&51.18=negative&51.19=right&51.20=top&51.21=back&46.16=open&26.16=open&52.1=wO&52.4=false&52.5=192&52.6=192&52.7=gaussian&52.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wo4_64_768.csv&52.9=-1&52.10=0.996&52.11=0&52.0=&52.16=closed&22.1=attn_out&22.4=true&22.16=open&53.1=FFN_1&53.4=false&53.5=192&53.6=768&53.7=gaussian&53.8=&53.9=-1&53.10=1&53.11=0&53.0=&53.16=closed&3.16=open&54.1=FFN_2&54.4=false&54.5=768&54.6=192&54.7=gaussian&54.8=&54.9=-1&54.10=1&54.11=0&54.0=&54.16=closed&55.56=sync&55.57=16&55.58=false&55.13=none&55.59=0&55.16=closed&60.61=1&60.62=1&60.15=1&60.16=closed&63.64=blocks&63.65=8&63.66=0&63.67=1&63.68=0&63.18=negative&63.19=left&63.20=top&63.21=front&63.16=closed&69.70=10&69.71=true&69.72=4&69.73=0.507&69.74=0.524&69.75=0.5&69.76=12&69.77=false&69.78=false&69.16=closed&79.80=local&79.81=0.1&79.82=0.2&79.83=0.9&79.84=2&79.85=0.75&79.86=0.75&79.87=0.03&79.16=closed&88.8=&88.16=open&89.90=-738.1526976199144&89.91=919.9001193338946&89.92=957.7418906526483&93.90=0&93.91=0&93.92=0&expr=0&name=1&epilog=2&left=3&matmul=4&h=5&w=6&init=7&url=8&min=9&max=10&dropout=11&left.anim=12&alg=13&left.block=14&k%20blocks=15&folder=16&left.layout=17&polarity=18&left%20placement=19&right%20placement=20&result%20placement=21&left.left=22&left.left.anim=23&left.left.block=24&left.left.layout=25&left.left.left=26&left.left.left.anim=27&left.left.left.block=28&left.left.left.layout=29&left.left.left.left=30&left.left.left.left.left=31&left.left.left.left.left.left=32&left.left.left.left.left.right=33&left.left.left.left.left.anim=34&left.left.left.left.left.block=35&left.left.left.left.left.layout=36&left.left.left.left.right=37&left.left.left.left.right.anim=38&left.left.left.left.right.block=39&left.left.left.left.right.layout=40&left.left.left.left.right.left=41&left.left.left.left.right.right=42&left.left.left.left.anim=43&left.left.left.left.block=44&left.left.left.left.layout=45&left.left.left.right=46&left.left.left.right.left=47&left.left.left.right.right=48&left.left.left.right.anim=49&left.left.left.right.block=50&left.left.left.right.layout=51&left.left.right=52&left.right=53&right=54&anim=55&fuse=56&speed=57&hide%20inputs=58&spin=59&block=60&i%20blocks=61&j%20blocks=62&layout=63&scheme=64&gap=65&scatter=66&molecule=67&blast=68&deco=69&legends=70&shape=71&spotlight=72&row%20guides=73&flow%20guides=74&lens%20size=75&magnification=76&interior%20spotlight=77&axes=78&viz=79&sensitivity=80&min%20size=81&min%20light=82&max%20light=83&elem%20scale=84&zero%20hue=85&hue%20gap=86&hue%20spread=87&diag=88&cam=89&x=90&y=91&z=92&cam.target=93&compress=94):

![a full attention layer with the first half (MHA) in the background and the second (FFN) in the foreground](/assets/images/inside-the-matrix/attnlayer2.jpg){:style="width:100%"}




### 6b Visualizing the BPT partitioned layer

Revisiting [Blockwise Parallel Transformer](https://arxiv.org/pdf/2305.19370.pdf) briefly, here we visualize BPT's parallelization scheme in the context of an entire attention layer (with individual heads elided per above). In particular, note how the partitioning along `i` (of sequence blocks) extends through both MHA and FFN halves ([open in mm](https://bhosmer.github.io/mm/index.html?0=layer_out%20%3D%20(attn_out%20%3D%20(attn%20%3D%20(Q%20%3D%20input%20%40%20wQ)%20%40%20(K_t%20%3D%20wK_t%20%40%20input_t))%20%40%20(V%20%3D%20input%20%40%20wV)%20%40%20wO)%20%40%20FFN_1%20%40%20FFN_2&1=layer_out&2=layernorm&16=closed&94=true&3.1=attn_out%20%40%20FFN_1&3.4=true&3.5=32&3.6=32&3.7=row%20major&3.8=&3.9=-1&3.10=1&3.11=0&3.2=gelu&12.13=inherit&14.15=1&14.16=closed&17.18=positive&17.19=left&17.20=bottom&17.21=back&22.2=layernorm&23.13=inherit&24.15=1&24.16=closed&25.18=negative&25.19=left&25.20=top&25.21=front&26.1=attn%20%40%20V&26.4=true&26.5=32&26.6=32&26.7=row%20major&26.8=&26.9=-1&26.10=1&26.11=0&26.2=none&27.13=vmprod&28.15=8&28.16=open&29.18=positive&29.19=left&29.20=bottom&29.21=back&30.1=attn&30.4=true&30.2=softmax(tril(x%2Fsqrt(k)))&31.1=Q&31.4=true&31.2=none&32.1=input&32.4=false&32.5=256&32.6=192&32.7=gaussian&32.9=-1&32.10=1&32.11=0&32.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input0_256_768.csv&32.0=&32.16=open&33.1=wQ&33.4=false&33.5=192&33.6=192&33.7=gaussian&33.9=-1&33.10=1&33.11=0&33.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wq4_768_64.csv&33.0=&33.16=open&34.13=vmprod&35.15=1&36.18=positive&36.19=left&36.20=bottom&36.21=back&31.16=closed&37.2=none&38.13=none&39.15=1&40.18=positive&40.19=right&40.20=top&40.21=back&41.1=wK_t&41.4=false&41.5=192&41.6=192&41.7=gaussian&41.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wk_t4_64_768.csv&41.9=-1&41.10=1&41.11=0&41.0=&41.16=open&42.1=input_t&42.4=false&42.5=192&42.6=256&42.7=gaussian&42.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input_t0_768_256.csv&42.9=-1&42.10=1&42.11=0&42.0=&42.16=open&37.1=K_t&37.4=true&37.16=closed&43.13=vmprod&44.15=1&44.16=open&45.18=negative&45.19=left&45.20=top&45.21=front&30.16=closed&46.1=V&46.4=true&46.2=none&47.1=input&47.4=false&47.5=256&47.6=192&47.7=gaussian&47.9=-1&47.10=1&47.11=0&47.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input0_256_768.csv&47.0=&47.16=open&48.1=wV&48.4=false&48.5=192&48.6=192&48.7=gaussian&48.9=-1&48.10=1&48.11=0&48.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wv4_768_64.csv&48.0=&48.16=open&49.13=none&50.15=1&51.18=negative&51.19=right&51.20=top&51.21=back&46.16=closed&26.16=open&52.1=wO&52.4=false&52.5=192&52.6=192&52.7=gaussian&52.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wo4_64_768.csv&52.9=-1&52.10=0.996&52.11=0&52.0=&52.16=closed&22.1=attn_out&22.4=true&22.16=open&53.1=FFN_1&53.4=false&53.5=192&53.6=768&53.7=gaussian&53.8=&53.9=-1&53.10=1&53.11=0&53.0=&53.16=closed&3.16=open&54.1=FFN_2&54.4=false&54.5=768&54.6=192&54.7=gaussian&54.8=&54.9=-1&54.10=1&54.11=0&54.0=&54.16=closed&55.56=sync&55.57=16&55.58=false&55.13=none&55.59=0&55.16=closed&60.61=8&60.62=1&60.15=1&60.16=open&63.64=blocks&63.65=8&63.66=0&63.67=1&63.68=0&63.18=negative&63.19=left&63.20=top&63.21=front&63.16=closed&69.70=10&69.71=true&69.72=4&69.73=0.507&69.74=0.524&69.75=0.5&69.76=12&69.77=false&69.78=false&69.16=closed&79.80=local&79.81=0.1&79.82=0.2&79.83=0.9&79.84=2&79.85=0.75&79.86=0.75&79.87=0.03&79.16=closed&88.8=&88.16=open&89.90=-766.4372214429399&89.91=955.1488380935747&89.92=994.4406298292719&93.90=0&93.91=0&93.92=0&expr=0&name=1&epilog=2&left=3&matmul=4&h=5&w=6&init=7&url=8&min=9&max=10&dropout=11&left.anim=12&alg=13&left.block=14&k%20blocks=15&folder=16&left.layout=17&polarity=18&left%20placement=19&right%20placement=20&result%20placement=21&left.left=22&left.left.anim=23&left.left.block=24&left.left.layout=25&left.left.left=26&left.left.left.anim=27&left.left.left.block=28&left.left.left.layout=29&left.left.left.left=30&left.left.left.left.left=31&left.left.left.left.left.left=32&left.left.left.left.left.right=33&left.left.left.left.left.anim=34&left.left.left.left.left.block=35&left.left.left.left.left.layout=36&left.left.left.left.right=37&left.left.left.left.right.anim=38&left.left.left.left.right.block=39&left.left.left.left.right.layout=40&left.left.left.left.right.left=41&left.left.left.left.right.right=42&left.left.left.left.anim=43&left.left.left.left.block=44&left.left.left.left.layout=45&left.left.left.right=46&left.left.left.right.left=47&left.left.left.right.right=48&left.left.left.right.anim=49&left.left.left.right.block=50&left.left.left.right.layout=51&left.left.right=52&left.right=53&right=54&anim=55&fuse=56&speed=57&hide%20inputs=58&spin=59&block=60&i%20blocks=61&j%20blocks=62&layout=63&scheme=64&gap=65&scatter=66&molecule=67&blast=68&deco=69&legends=70&shape=71&spotlight=72&row%20guides=73&flow%20guides=74&lens%20size=75&magnification=76&interior%20spotlight=77&axes=78&viz=79&sensitivity=80&min%20size=81&min%20light=82&max%20light=83&elem%20scale=84&zero%20hue=85&hue%20gap=86&hue%20spread=87&diag=88&cam=89&x=90&y=91&z=92&cam.target=93&compress=94)):


![visualize BPT's parallelization scheme in the context of an entire attention layer](/assets/images/inside-the-matrix/bptlayer.jpg){:style="width:100%"}




### 6c Partitioning the FFN

The visualization suggests an additional partitioning, orthogonal to the ones described above - in the FFN half of the attention layer, splitting the double matmul `(attn_out @ FFN_1) @ FFN_2`, first along `j` for `attn_out @ FFN_1`, then along `k` in the subsequent matmul with `FFN_2`. This partition slices both layers of `FFN` weights, reducing the capacity requirements of each participant in the computation at the cost of a final summation of the partial results.

Here's what this partition looks like applied to an otherwise unpartitioned attention layer ([open in mm](https://bhosmer.github.io/mm/index.html?0=layer_out+%3D+%28attn_out+%3D+%28attn+%3D+%28Q+%3D+input+%40+wQ%29+%40+%28K_t+%3D+wK_t+%40+input_t%29%29+%40+%28V+%3D+input+%40+wV%29+%40+wO%29+%40+FFN_1+%40+FFN_2&1=layer_out&2=layernorm&16=closed&94=true&3.1=attn_out+%40+FFN_1&3.4=true&3.5=32&3.6=32&3.7=row+major&3.8=&3.9=-1&3.10=1&3.11=0&3.2=gelu&12.13=inherit&14.15=1&14.16=open&14.17=1&14.18=8&19.20=positive&19.21=left&19.22=bottom&19.23=back&24.2=layernorm&25.13=inherit&26.15=1&26.16=closed&26.17=1&26.18=1&27.20=negative&27.21=left&27.22=top&27.23=front&28.1=attn+%40+V&28.4=true&28.5=32&28.6=32&28.7=row+major&28.8=&28.9=-1&28.10=1&28.11=0&28.2=none&29.13=vmprod&30.15=1&30.16=open&30.17=1&30.18=1&31.20=positive&31.21=left&31.22=bottom&31.23=back&32.1=attn&32.4=true&32.2=softmax%28tril%28x%2Fsqrt%28k%29%29%29&33.1=Q&33.4=true&33.2=none&34.1=input&34.4=false&34.5=256&34.6=192&34.7=gaussian&34.9=-1&34.10=1&34.11=0&34.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input0_256_768.csv&34.0=&34.16=open&35.1=wQ&35.4=false&35.5=192&35.6=192&35.7=gaussian&35.9=-1&35.10=1&35.11=0&35.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wq4_768_64.csv&35.0=&35.16=open&36.13=vmprod&37.15=1&37.17=1&37.18=1&38.20=positive&38.21=left&38.22=bottom&38.23=back&33.16=closed&39.2=none&40.13=none&41.15=1&41.17=1&41.18=1&42.20=positive&42.21=right&42.22=top&42.23=back&43.1=wK_t&43.4=false&43.5=192&43.6=192&43.7=gaussian&43.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wk_t4_64_768.csv&43.9=-1&43.10=1&43.11=0&43.0=&43.16=open&44.1=input_t&44.4=false&44.5=192&44.6=256&44.7=gaussian&44.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input_t0_768_256.csv&44.9=-1&44.10=1&44.11=0&44.0=&44.16=open&39.1=K_t&39.4=true&39.16=closed&45.13=vmprod&46.15=1&46.16=open&46.17=1&46.18=1&47.20=negative&47.21=left&47.22=top&47.23=front&32.16=closed&48.1=V&48.4=true&48.2=none&49.1=input&49.4=false&49.5=256&49.6=192&49.7=gaussian&49.9=-1&49.10=1&49.11=0&49.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input0_256_768.csv&49.0=&49.16=open&50.1=wV&50.4=false&50.5=192&50.6=192&50.7=gaussian&50.9=-1&50.10=1&50.11=0&50.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wv4_768_64.csv&50.0=&50.16=open&51.13=none&52.15=1&52.17=1&52.18=1&53.20=negative&53.21=right&53.22=top&53.23=back&48.16=closed&28.16=open&54.1=wO&54.4=false&54.5=192&54.6=192&54.7=gaussian&54.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wo4_64_768.csv&54.9=-1&54.10=0.996&54.11=0&54.0=&54.16=closed&24.1=attn_out&24.4=true&24.16=closed&55.1=FFN_1&55.4=false&55.5=192&55.6=768&55.7=gaussian&55.8=&55.9=-1&55.10=1&55.11=0&55.0=&55.16=closed&3.16=open&56.1=FFN_2&56.4=false&56.5=768&56.6=192&56.7=gaussian&56.8=&56.9=-1&56.10=1&56.11=0&56.0=&56.16=closed&57.58=sync&57.59=16&57.60=false&57.13=none&57.61=0&57.16=closed&62.17=1&62.15=8&62.18=1&62.16=closed&63.64=blocks&63.65=8&63.66=0&63.67=1&63.68=0&63.20=negative&63.21=left&63.22=top&63.23=front&63.16=closed&69.70=10&69.71=true&69.72=4&69.73=0.507&69.74=0.524&69.75=0.5&69.76=12&69.77=false&69.78=false&69.16=closed&79.80=local&79.81=0.1&79.82=0.2&79.83=0.9&79.84=2&79.85=0.75&79.86=0.75&79.87=0.03&79.16=closed&88.8=&88.16=open&89.90=-725.0392607527422&89.91=909.2543497392985&89.92=1420.9035091451585&93.90=84.4062135237143&93.91=2.295441349889614&93.92=60.16668289640925&expr=0&name=1&epilog=2&left=3&matmul=4&h=5&w=6&init=7&url=8&min=9&max=10&dropout=11&left.anim=12&alg=13&left.block=14&k+blocks=15&folder=16&i+blocks=17&j+blocks=18&left.layout=19&polarity=20&left+placement=21&right+placement=22&result+placement=23&left.left=24&left.left.anim=25&left.left.block=26&left.left.layout=27&left.left.left=28&left.left.left.anim=29&left.left.left.block=30&left.left.left.layout=31&left.left.left.left=32&left.left.left.left.left=33&left.left.left.left.left.left=34&left.left.left.left.left.right=35&left.left.left.left.left.anim=36&left.left.left.left.left.block=37&left.left.left.left.left.layout=38&left.left.left.left.right=39&left.left.left.left.right.anim=40&left.left.left.left.right.block=41&left.left.left.left.right.layout=42&left.left.left.left.right.left=43&left.left.left.left.right.right=44&left.left.left.left.anim=45&left.left.left.left.block=46&left.left.left.left.layout=47&left.left.left.right=48&left.left.left.right.left=49&left.left.left.right.right=50&left.left.left.right.anim=51&left.left.left.right.block=52&left.left.left.right.layout=53&left.left.right=54&left.right=55&right=56&anim=57&fuse=58&speed=59&hide+inputs=60&spin=61&block=62&layout=63&scheme=64&gap=65&scatter=66&molecule=67&blast=68&deco=69&legends=70&shape=71&spotlight=72&row+guides=73&flow+guides=74&lens+size=75&magnification=76&interior+spotlight=77&axes=78&viz=79&sensitivity=80&min+size=81&min+light=82&max+light=83&elem+scale=84&zero+hue=85&hue+gap=86&hue+spread=87&diag=88&cam=89&x=90&y=91&z=92&cam.target=93&compress=94)):

![what this partition looks like applied to an otherwise unpartitioned attention layer](/assets/images/inside-the-matrix/attnlayer_ffnsplitk.jpg){:style="width:100%"}



And here it is applied to a layer partitioned a la BPT ([open in mm](https://bhosmer.github.io/mm/index.html?0=layer_out+%3D+%28attn_out+%3D+%28attn+%3D+%28Q+%3D+input+%40+wQ%29+%40+%28K_t+%3D+wK_t+%40+input_t%29%29+%40+%28V+%3D+input+%40+wV%29+%40+wO%29+%40+FFN_1+%40+FFN_2&1=layer_out&2=layernorm&16=closed&94=true&3.1=attn_out+%40+FFN_1&3.4=true&3.5=32&3.6=32&3.7=row+major&3.8=&3.9=-1&3.10=1&3.11=0&3.2=gelu&12.13=inherit&14.15=1&14.16=open&14.17=8&14.18=8&19.20=positive&19.21=left&19.22=bottom&19.23=back&24.2=layernorm&25.13=inherit&26.15=1&26.16=closed&26.17=8&26.18=1&27.20=negative&27.21=left&27.22=top&27.23=front&28.1=attn+%40+V&28.4=true&28.5=32&28.6=32&28.7=row+major&28.8=&28.9=-1&28.10=1&28.11=0&28.2=none&29.13=vmprod&30.15=8&30.16=open&30.17=8&30.18=1&31.20=positive&31.21=left&31.22=bottom&31.23=back&32.1=attn&32.4=true&32.2=softmax%28tril%28x%2Fsqrt%28k%29%29%29&33.1=Q&33.4=true&33.2=none&34.1=input&34.4=false&34.5=256&34.6=192&34.7=gaussian&34.9=-1&34.10=1&34.11=0&34.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input0_256_768.csv&34.0=&34.16=open&35.1=wQ&35.4=false&35.5=192&35.6=192&35.7=gaussian&35.9=-1&35.10=1&35.11=0&35.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wq4_768_64.csv&35.0=&35.16=open&36.13=vmprod&37.15=1&37.17=8&37.18=1&38.20=positive&38.21=left&38.22=bottom&38.23=back&33.16=closed&39.2=none&40.13=none&41.15=1&41.17=1&41.18=1&42.20=positive&42.21=right&42.22=top&42.23=back&43.1=wK_t&43.4=false&43.5=192&43.6=192&43.7=gaussian&43.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wk_t4_64_768.csv&43.9=-1&43.10=1&43.11=0&43.0=&43.16=open&44.1=input_t&44.4=false&44.5=192&44.6=256&44.7=gaussian&44.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input_t0_768_256.csv&44.9=-1&44.10=1&44.11=0&44.0=&44.16=open&39.1=K_t&39.4=true&39.16=closed&45.13=vmprod&46.15=1&46.16=open&46.17=8&46.18=1&47.20=negative&47.21=left&47.22=top&47.23=front&32.16=closed&48.1=V&48.4=true&48.2=none&49.1=input&49.4=false&49.5=256&49.6=192&49.7=gaussian&49.9=-1&49.10=1&49.11=0&49.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input0_256_768.csv&49.0=&49.16=open&50.1=wV&50.4=false&50.5=192&50.6=192&50.7=gaussian&50.9=-1&50.10=1&50.11=0&50.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wv4_768_64.csv&50.0=&50.16=open&51.13=none&52.15=1&52.17=1&52.18=1&53.20=negative&53.21=right&53.22=top&53.23=back&48.16=closed&28.16=open&54.1=wO&54.4=false&54.5=192&54.6=192&54.7=gaussian&54.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wo4_64_768.csv&54.9=-1&54.10=0.996&54.11=0&54.0=&54.16=closed&24.1=attn_out&24.4=true&24.16=closed&55.1=FFN_1&55.4=false&55.5=192&55.6=768&55.7=gaussian&55.8=&55.9=-1&55.10=1&55.11=0&55.0=&55.16=closed&3.16=open&56.1=FFN_2&56.4=false&56.5=768&56.6=192&56.7=gaussian&56.8=&56.9=-1&56.10=1&56.11=0&56.0=&56.16=closed&57.58=sync&57.59=16&57.60=false&57.13=none&57.61=0&57.16=closed&62.17=8&62.15=8&62.18=1&62.16=open&63.64=blocks&63.65=8&63.66=0&63.67=1&63.68=0&63.20=negative&63.21=left&63.22=top&63.23=front&63.16=closed&69.70=10&69.71=true&69.72=4&69.73=0.507&69.74=0.524&69.75=0.5&69.76=12&69.77=false&69.78=false&69.16=closed&79.80=local&79.81=0.1&79.82=0.2&79.83=0.9&79.84=2&79.85=0.75&79.86=0.75&79.87=0.03&79.16=closed&88.8=&88.16=open&89.90=-908.5990219796431&89.91=1012.984380609292&89.92=1378.7815259698948&93.90=57.978218494193676&93.91=-30.847130586978256&93.92=41.66771129059017&expr=0&name=1&epilog=2&left=3&matmul=4&h=5&w=6&init=7&url=8&min=9&max=10&dropout=11&left.anim=12&alg=13&left.block=14&k+blocks=15&folder=16&i+blocks=17&j+blocks=18&left.layout=19&polarity=20&left+placement=21&right+placement=22&result+placement=23&left.left=24&left.left.anim=25&left.left.block=26&left.left.layout=27&left.left.left=28&left.left.left.anim=29&left.left.left.block=30&left.left.left.layout=31&left.left.left.left=32&left.left.left.left.left=33&left.left.left.left.left.left=34&left.left.left.left.left.right=35&left.left.left.left.left.anim=36&left.left.left.left.left.block=37&left.left.left.left.left.layout=38&left.left.left.left.right=39&left.left.left.left.right.anim=40&left.left.left.left.right.block=41&left.left.left.left.right.layout=42&left.left.left.left.right.left=43&left.left.left.left.right.right=44&left.left.left.left.anim=45&left.left.left.left.block=46&left.left.left.left.layout=47&left.left.left.right=48&left.left.left.right.left=49&left.left.left.right.right=50&left.left.left.right.anim=51&left.left.left.right.block=52&left.left.left.right.layout=53&left.left.right=54&left.right=55&right=56&anim=57&fuse=58&speed=59&hide+inputs=60&spin=61&block=62&layout=63&scheme=64&gap=65&scatter=66&molecule=67&blast=68&deco=69&legends=70&shape=71&spotlight=72&row+guides=73&flow+guides=74&lens+size=75&magnification=76&interior+spotlight=77&axes=78&viz=79&sensitivity=80&min+size=81&min+light=82&max+light=83&elem+scale=84&zero+hue=85&hue+gap=86&hue+spread=87&diag=88&cam=89&x=90&y=91&z=92&cam.target=93&compress=94)):

![applied to a layer partitioned a la BPT](/assets/images/inside-the-matrix/bptlayer_ffnsplitk.jpg){:style="width:100%"}



### 6d Visualizing token-at-a-time decoding

During autoregressive token-at-a-time decoding, the query vector consists of a single token. It's instructive to have a mental picture of what an attention layer looks like in that situation - a single embedding row working its way through an enormous tiled plane of weights.

Aside from the emphasizing the sheer immensity of weights compared to activations, this view is also evocative of the notion that `K_t` and `V` function like dynamically generated layers in a 6-layer MLP, although the mux/demux computations of MHA itself (papered over here, per above) make the correspondence inexact ([open in mm](https://bhosmer.github.io/mm/index.html?0=layer_out%20%3D%20(attn_out%20%3D%20(attn%20%3D%20(Q%20%3D%20input%20%40%20wQ)%20%40%20K_t)%20%40%20V%20%40%20wO)%20%40%20FFN_1%20%40%20FFN_2&1=layer_out&2=layernorm&16=closed&84=true&3.1=attn_out%20%40%20FFN_1&3.4=true&3.5=32&3.6=32&3.7=row%20major&3.8=&3.9=-1&3.10=1&3.11=0&3.2=gelu&12.13=inherit&14.15=1&14.16=open&17.18=positive&17.19=left&17.20=bottom&17.21=back&22.2=layernorm&23.13=inherit&24.15=1&24.16=open&25.18=negative&25.19=left&25.20=top&25.21=front&26.1=attn%20%40%20V&26.4=true&26.5=32&26.6=32&26.7=row%20major&26.8=&26.9=-1&26.10=1&26.11=0&26.2=none&27.13=vmprod&28.15=1&28.16=open&29.18=positive&29.19=left&29.20=bottom&29.21=back&30.1=attn&30.4=true&30.2=softmax(tril(x%2Fsqrt(k)))&31.1=Q&31.4=true&31.2=none&32.1=input&32.4=false&32.5=1&32.6=192&32.7=gaussian&32.9=-1&32.10=1&32.11=0&32.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input0_256_768.csv&32.0=&32.16=open&33.1=wQ&33.4=false&33.5=192&33.6=192&33.7=gaussian&33.9=-1&33.10=1&33.11=0&33.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wq4_768_64.csv&33.0=&33.16=open&34.13=vmprod&35.15=1&36.18=positive&36.19=left&36.20=bottom&36.21=back&31.16=open&37.1=K_t&37.4=false&37.5=192&37.6=256&37.7=gaussian&37.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_input_t0_768_256.csv&37.9=-1&37.10=1&37.11=0&37.0=&37.16=open&38.13=vmprod&39.15=1&39.16=open&40.18=negative&40.19=left&40.20=top&40.21=front&30.16=open&41.1=V&41.4=false&41.16=open&41.5=256&41.6=192&41.7=gaussian&41.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wv4_768_64.csv&41.0=&41.9=-1&41.10=1&41.11=0&26.16=open&42.1=wO&42.4=false&42.5=192&42.6=192&42.7=gaussian&42.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer5_wo4_64_768.csv&42.9=-1&42.10=0.996&42.11=0&42.0=&42.16=closed&22.1=attn_out&22.4=true&22.16=open&43.1=FFN_1&43.4=false&43.5=192&43.6=768&43.7=gaussian&43.8=&43.9=-1&43.10=1&43.11=0&43.0=&43.16=closed&3.16=open&44.1=FFN_2&44.4=false&44.5=768&44.6=192&44.7=gaussian&44.8=&44.9=-1&44.10=1&44.11=0&44.0=&44.16=closed&45.46=sync&45.47=16&45.48=false&45.13=none&45.49=0&45.16=closed&50.51=1&50.52=1&50.15=1&50.16=closed&53.54=blocks&53.55=8&53.56=0&53.57=1&53.58=0&53.18=negative&53.19=left&53.20=top&53.21=front&53.16=closed&59.60=10&59.61=true&59.62=4&59.63=0.507&59.64=0.524&59.65=0.5&59.66=12&59.67=false&59.68=false&59.16=closed&69.70=local&69.71=0.1&69.72=0.2&69.73=0.9&69.74=2&69.75=0.75&69.76=0.75&69.77=0.03&69.16=closed&78.8=&78.16=open&79.80=-621.3352100945762&79.81=774.3199147754915&79.82=806.172978523008&83.80=0&83.81=0&83.82=0&expr=0&name=1&epilog=2&left=3&matmul=4&h=5&w=6&init=7&url=8&min=9&max=10&dropout=11&left.anim=12&alg=13&left.block=14&k%20blocks=15&folder=16&left.layout=17&polarity=18&left%20placement=19&right%20placement=20&result%20placement=21&left.left=22&left.left.anim=23&left.left.block=24&left.left.layout=25&left.left.left=26&left.left.left.anim=27&left.left.left.block=28&left.left.left.layout=29&left.left.left.left=30&left.left.left.left.left=31&left.left.left.left.left.left=32&left.left.left.left.left.right=33&left.left.left.left.left.anim=34&left.left.left.left.left.block=35&left.left.left.left.left.layout=36&left.left.left.left.right=37&left.left.left.left.anim=38&left.left.left.left.block=39&left.left.left.left.layout=40&left.left.left.right=41&left.left.right=42&left.right=43&right=44&anim=45&fuse=46&speed=47&hide%20inputs=48&spin=49&block=50&i%20blocks=51&j%20blocks=52&layout=53&scheme=54&gap=55&scatter=56&molecule=57&blast=58&deco=59&legends=60&shape=61&spotlight=62&row%20guides=63&flow%20guides=64&lens%20size=65&magnification=66&interior%20spotlight=67&axes=68&viz=69&sensitivity=70&min%20size=71&min%20light=72&max%20light=73&elem%20scale=74&zero%20hue=75&hue%20gap=76&hue%20spread=77&diag=78&cam=79&x=80&y=81&z=82&cam.target=83&compress=84)):

![the mux/demux computations of MHA itself](/assets/images/inside-the-matrix/decoding.jpg){:style="width:100%"}




## 7 LoRA

The recent LoRA paper ([LoRA: Low-Rank Adaptation of Large Language Models](https://arxiv.org/pdf/2106.09685.pdf)) describes an efficient finetuning technique based on the idea that weight deltas introduced during finetuning are low-rank. Per the paper, this "allows us to train some dense layers in a neural network indirectly by optimizing rank decomposition matrices of the dense layers’ change during adaptation [...], while keeping the pre-trained weights frozen."


### 7a The basic idea

In a nutshell, the key move is to train the _factors_ of a weight matrix rather than the matrix itself: replace an `I x J` weights tensor with a matmul of an `I x K` tensor and a `K x J` tensor, holding `K` to some small number.

If `K` is small enough the size win can be huge, but the tradeoff is that lowering it lowers the rank of what the product can express. As a quick illustration of both the size savings and the structuring effect on the result, here's a matmul of random `128 x 4` left and `4 x 128` right arguments - a.k.a. a rank-4 factorization of a `128 x 128` matrix. Notice the vertical and horizontal patterning in `L @ R` ([open in mm](https://bhosmer.github.io/mm/?0=L%20%40%20R&1=L%20%40%20R&2=none&12=closed&59=true&3.1=L&3.4=false&3.5=128&3.6=4&3.7=gaussian&3.8=&3.9=-1&3.10=1&3.11=0&3.0=&3.12=open&13.1=R&13.4=false&13.5=4&13.6=128&13.7=gaussian&13.8=&13.9=-1&13.10=1&13.11=0&13.0=&14.15=none&14.16=1&14.17=false&14.18=none&14.19=0&14.20=1&14.21=1&14.22=1&23.20=1&23.22=1&23.21=1&24.25=blocks&24.26=11.214&24.27=0&24.28=1&24.29=0&24.30=negative&24.31=left&24.32=top&24.33=front&24.12=open&34.35=10&34.36=true&34.37=2&34.38=1&34.39=0&34.40=0.5&34.41=10&34.42=false&34.43=false&34.12=open&44.45=local&44.46=0.3&44.47=0.5&44.48=0.7&44.49=1.25&44.50=0.77&44.51=0.74&44.52=0.04&44.12=open&53.8=&54.55=-147.50937470998977&54.56=141.1312665550063&54.57=104.24779022699425&58.55=-7.97607936427614&58.56=3.391570600844088&58.57=-11.685048965074932&expr=0&name=1&epilog=2&left=3&matmul=4&h=5&w=6&init=7&url=8&min=9&max=10&dropout=11&folder=12&right=13&anim=14&fuse=15&speed=16&hide%20inputs=17&alg=18&spin=19&i%20blocks=20&k%20blocks=21&j%20blocks=22&block=23&layout=24&scheme=25&gap=26&scatter=27&molecule=28&blast=29&polarity=30&left%20placement=31&right%20placement=32&result%20placement=33&deco=34&legends=35&shape=36&spotlight=37&row%20guides=38&flow%20guides=39&lens%20size=40&magnification=41&interior%20spotlight=42&axes=43&viz=44&sensitivity=45&min%20size=46&min%20light=47&max%20light=48&elem%20scale=49&zero%20hue=50&hue%20gap=51&hue%20spread=52&diag=53&cam=54&x=55&y=56&z=57&cam.target=58&compress=59)):

![a matmul of random 128 x 4 left and 4 x 128 right arguments](/assets/images/inside-the-matrix/lora_single.jpg){:style="width:100%"}




### 7b Applying LoRA to an attention head

The way LoRA applies this factoring move to the fine tuning process is to



* create a low-rank factorization for each weight tensor to be fine-tuned and train the factors, keeping the original weights frozen
* after fine tuning, multiply each pair of low-rank factors to get a matrix in the shape of the original weights tensor, and add it to the original pretrained weights tensor

The following visualization shows an attention head with the weight tensors `wQ`, `wK_t`, `wV`, `wO` replaced by low rank factorizations `wQ_A @ wQ_B`, etc. Visually, the factor matrices show up as low fences along the edges of the windmill blades ([open in mm](https://bhosmer.github.io/mm/index.html?0=out%20%3D%20(attn%20%3D%20(Q%20%3D%20input%20%40%20(wQ%20%3D%20wQ_A%20%40%20wQ_B))%20%40%20(K_t%20%3D%20(wK_t%20%3D%20wK_t_A%20%40%20wK_t_B)%20%40%20input_t))%20%40%20(V%20%3D%20input%20%40%20(wV%20%3D%20wV_A%20%40%20wV_B))%20%40%20(wO%20%3D%20wO_A%20%40%20wO_B)&1=out&2=none&15=closed&104=true&3.1=attn%20%40%20V&3.4=true&3.5=32&3.6=32&3.7=rows&3.8=&3.9=-1&3.10=1&3.11=0&3.2=none&12.13=inherit&12.14=1&12.15=open&16.17=positive&16.18=left&16.19=bottom&16.20=back&21.1=attn&21.4=true&21.2=softmax(tril(x%2Fsqrt(k)))&22.1=Q&22.4=true&22.2=none&23.1=input&23.4=false&23.5=64&23.6=96&23.7=gaussian&23.9=-1&23.10=1&23.11=0&23.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_input0_256_768.csv&23.0=&23.15=closed&24.1=wQ&24.4=true&24.2=none&25.1=wQ_A&25.4=false&25.5=96&25.6=8&25.7=gaussian&25.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_wq0_768_64.csv&25.9=-1&25.10=1&25.11=0&25.0=&25.15=closed&26.1=wQ_B&26.4=false&26.5=8&26.6=32&26.7=gaussian&26.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_wq0_768_64.csv&26.9=-1&26.10=1&26.11=0&26.0=&26.15=open&27.13=inherit&27.14=1&27.15=closed&28.17=negative&28.18=right&28.19=top&28.20=back&29.30=1&24.15=closed&31.13=inherit&31.14=1&31.15=closed&32.17=positive&32.18=left&32.19=bottom&32.20=back&33.30=1&22.15=closed&34.2=none&35.13=inherit&35.14=1&35.15=closed&36.17=positive&36.18=right&36.19=top&36.20=back&37.1=wK_t&37.4=true&37.2=none&38.1=wK_t_A&38.4=false&38.5=32&38.6=8&38.7=gaussian&38.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_wk_t0_64_768.csv&38.9=-1&38.10=1&38.11=0&38.0=&38.15=open&39.1=wK_t_B&39.4=false&39.5=8&39.6=96&39.7=gaussian&39.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_wk_t0_64_768.csv&39.9=-1&39.10=1&39.11=0&39.0=&39.15=closed&40.13=inherit&40.14=1&40.15=open&41.17=negative&41.18=left&41.19=bottom&41.20=back&42.30=1&37.15=closed&43.1=input_t&43.4=false&43.5=96&43.6=64&43.7=gaussian&43.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_input_t0_768_256.csv&43.9=-1&43.10=1&43.11=0&43.0=&43.15=closed&34.1=K_t&34.4=true&44.30=1&34.15=closed&45.13=inherit&45.14=1&45.15=closed&46.17=negative&46.18=left&46.19=top&46.20=front&47.30=1&21.15=closed&48.1=V&48.4=true&48.2=none&49.1=input&49.4=false&49.5=64&49.6=96&49.7=gaussian&49.9=-1&49.10=1&49.11=0&49.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_input0_256_768.csv&49.0=&49.15=closed&50.1=wV&50.4=true&50.2=none&51.1=wV_A&51.4=false&51.5=96&51.6=8&51.7=gaussian&51.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_wv0_768_64.csv&51.9=-1&51.10=1&51.11=0&51.0=&51.15=open&52.1=wV_B&52.4=false&52.5=8&52.6=32&52.7=gaussian&52.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_wv0_768_64.csv&52.9=-1&52.10=1&52.11=0&52.0=&52.15=open&53.13=inherit&53.14=1&53.15=open&54.17=positive&54.18=left&54.19=bottom&54.20=back&55.30=1&50.15=closed&56.13=inherit&56.14=1&56.15=closed&57.17=negative&57.18=right&57.19=top&57.20=back&58.30=1&48.15=closed&3.15=closed&59.30=1&60.1=wO&60.4=true&60.5=32&60.6=32&60.7=cols&60.8=&60.9=-1&60.10=1&60.11=0&60.2=none&61.1=wO_A&61.4=false&61.5=32&61.6=8&61.7=gaussian&61.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_wo0_64_768.csv&61.9=-1&61.10=1&61.11=0&61.0=&61.15=open&62.1=wO_B&62.4=false&62.5=8&62.6=96&62.7=gaussian&62.8=https%3A%2F%2Fraw.githubusercontent.com%2Fbhosmer%2Ftestdata%2Fmain%2Fweights%2Fgpt2%2Flayer0_wo0_64_768.csv&62.9=-1&62.10=1&62.11=0&62.0=&62.15=closed&63.13=inherit&63.14=1&63.15=closed&64.17=positive&64.18=right&64.19=top&64.20=back&60.15=closed&65.30=1&66.67=none&66.68=100&66.69=false&66.13=none&66.70=-3&66.71=1&66.30=1&66.14=1&66.15=open&72.71=1&72.14=1&72.30=1&73.74=blocks&73.75=2&73.76=8&73.77=2&73.78=0&73.17=negative&73.18=left&73.19=top&73.20=front&73.15=closed&79.80=6.5&79.81=false&79.82=1&79.83=1&79.84=0.757&79.85=0.5&79.86=10&79.87=false&79.88=false&79.15=open&89.90=local&89.91=0.2&89.92=0.3&89.93=1&89.94=1.25&89.95=0.75&89.96=0.75&89.97=0.03&89.15=closed&98.8=&98.15=closed&99.100=-172.19348886030096&99.101=179.87607098671913&99.102=291.20723943546824&103.100=-6.083689158200286&103.101=-2.2203698054118064&103.102=-20.406063431589725&expr=0&name=1&epilog=2&left=3&matmul=4&h=5&w=6&init=7&url=8&min=9&max=10&dropout=11&left.anim=12&alg=13&j%20blocks=14&folder=15&left.layout=16&polarity=17&left%20placement=18&right%20placement=19&result%20placement=20&left.left=21&left.left.left=22&left.left.left.left=23&left.left.left.right=24&left.left.left.right.left=25&left.left.left.right.right=26&left.left.left.right.anim=27&left.left.left.right.layout=28&left.left.left.right.block=29&k%20blocks=30&left.left.left.anim=31&left.left.left.layout=32&left.left.left.block=33&left.left.right=34&left.left.right.anim=35&left.left.right.layout=36&left.left.right.left=37&left.left.right.left.left=38&left.left.right.left.right=39&left.left.right.left.anim=40&left.left.right.left.layout=41&left.left.right.left.block=42&left.left.right.right=43&left.left.right.block=44&left.left.anim=45&left.left.layout=46&left.left.block=47&left.right=48&left.right.left=49&left.right.right=50&left.right.right.left=51&left.right.right.right=52&left.right.right.anim=53&left.right.right.layout=54&left.right.right.block=55&left.right.anim=56&left.right.layout=57&left.right.block=58&left.block=59&right=60&right.left=61&right.right=62&right.anim=63&right.layout=64&right.block=65&anim=66&fuse=67&speed=68&hide%20inputs=69&spin=70&i%20blocks=71&block=72&layout=73&scheme=74&gap=75&scatter=76&molecule=77&blast=78&deco=79&legends=80&shape=81&spotlight=82&row%20guides=83&flow%20guides=84&lens%20size=85&magnification=86&interior%20spotlight=87&axes=88&viz=89&sensitivity=90&min%20size=91&min%20light=92&max%20light=93&elem%20scale=94&zero%20hue=95&hue%20gap=96&hue%20spread=97&diag=98&cam=99&x=100&y=101&z=102&cam.target=103&compress=104) - spacebar stops the spin): 

<p align="center">
  <video width="100%" controls>
    <source src="/assets/videos/inside-the-matrix/lora_spin4b.mp4" type="video/mp4">
  </video>
</p>

## 8 Wrapup


### 8a Call for feedback

I've found this way of visualizing matmul expressions extremely helpful for building intuition and reasoning about not just matrix multiplication itself, but also many aspects of ML models and their computation, from efficiency to interpretability.

if you try it out and have suggestions or comments, I definitely want to hear, either in the comments here or [in the repo](https://github.com/bhosmer/mm).


### 8b Next steps


* There's a [GPT2 attention head explorer](https://bhosmer.github.io/mm/examples/attngpt2/index.html) built on top of the tool which I'm currently using to inventory and classify the attention head traits found in that model. (This was the tool I used to find and explore the attention heads in this note.) Once complete I plan to post a note with the inventory.
* As mentioned up top, embedding these visualizations in Python notebooks is [dead simple](https://colab.research.google.com/drive/1wZIoU20eRWKtRNCW7e5Iugm3MhfaE1f7?usp=sharing). But session URLs can get... unwieldy, so it will be useful to have Python-side utilities for constructing them from configuration objects, similar to the simple JavaScript helpers used in the [reference guide](https://bhosmer.github.io/mm/ref.html).
* If you've got a use case you think might benefit from visualizations like this but it's not obvious how to use the tool to do it, get in touch! I'm not necessarily looking to expand its core visualization capabilities that much further (right tool for the job, etc.), but e.g. the API for driving it programmatically is pretty basic, there's plenty that can be done there.