


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta name="robots" content="noindex">
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>torch.onnx.verification &mdash; PyTorch 2.0 documentation</title>
  

  
  
  
  
    <link rel="canonical" href="https://pytorch.org/docs/stable/_modules/torch/onnx/verification.html"/>
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.css" type="text/css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/katex-math.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx-dropdown.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/panels-bootstrap.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/jit.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />


  <!-- Google Analytics -->
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-117752657-2"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-117752657-2');
    </script>
  
  <!-- End Google Analytics -->
  


  
  <script src="../../../_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>

          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li class="active docs-active">
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-orange-arrow">
                Docs
              </a>
              <div class="resources-dropdown-menu">
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/docs/stable/index.html">
                  <span class="dropdown-title">PyTorch</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/audio/stable/index.html">
                  <span class="dropdown-title">torchaudio</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/text/stable/index.html">
                  <span class="dropdown-title">torchtext</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/vision/stable/index.html">
                  <span class="dropdown-title">torchvision</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torcharrow">
                  <span class="dropdown-title">torcharrow</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/data">
                  <span class="dropdown-title">TorchData</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torchrec">
                  <span class="dropdown-title">TorchRec</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/serve/">
                  <span class="dropdown-title">TorchServe</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torchx/">
                  <span class="dropdown-title">TorchX</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/xla">
                  <span class="dropdown-title">PyTorch on XLA Devices</span>
                  <p></p>
                </a>
            </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-arrow">
                Resources
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/features">
                  <span class="dropdown-title">About</span>
                  <p>Learn about PyTorchâ€™s features and capabilities</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/foundation">
                  <span class="dropdown-title">PyTorch Foundation</span>
                  <p>Learn about the PyTorch foundation</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/#community-module">
                  <span class="dropdown-title">Community</span>
                  <p>Join the PyTorch developer community to contribute, learn, and get your questions answered.</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/community-stories">
                  <span class="dropdown-title">Community Stories</span>
                  <p>Learn how our community solves real, everyday machine learning problems with PyTorch.</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/resources">
                  <span class="dropdown-title">Developer Resources</span>
                  <p>Find resources and get questions answered</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/events">
                  <span class="dropdown-title">Events</span>
                  <p>Find events, webinars, and podcasts</p>
                </a>
                <a class="nav-dropdown-item" href="https://discuss.pytorch.org/" target="_blank">
                  <span class="dropdown-title">Forums</span>
                  <p>A place to discuss PyTorch code, issues, install, research</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/hub">
                  <span class="dropdown-title">Models (Beta)</span>
                  <p>Discover, publish, and reuse pre-trained models</p>
                </a>
              </div>
            </div>
          </li>

          <li>
            <a href="https://github.com/pytorch/pytorch">GitHub</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>

<body class="pytorch-body">

   

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            
    <div class="version">
      <a href='https://pytorch.org/docs/versions.html'>2.0 &#x25BC</a>
    </div>
    


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          </div>

          


            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Community</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../community/build_ci_governance.html">PyTorch Governance | Build + CI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/contribution_guide.html">PyTorch Contribution Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/design.html">PyTorch Design Philosophy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/governance.html">PyTorch Governance | Mechanics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/persons_of_interest.html">PyTorch Governance | Maintainers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/amp_examples.html">CUDA Automatic Mixed Precision examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/autograd.html">Autograd mechanics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/broadcasting.html">Broadcasting semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/cpu_threading_torchscript_inference.html">CPU threading and TorchScript inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/cuda.html">CUDA semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/ddp.html">Distributed Data Parallel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/extending.html">Extending PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/extending.func.html">Extending torch.func with autograd.Function</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/gradcheck.html">Gradcheck mechanics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/hip.html">HIP (ROCm) semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/large_scale_deployments.html">Features for large-scale deployments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/modules.html">Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/mps.html">MPS backend</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/multiprocessing.html">Multiprocessing best practices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/numerical_accuracy.html">Numerical accuracy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/randomness.html">Reproducibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/serialization.html">Serialization semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/windows.html">Windows FAQ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">torch.compile</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../dynamo/index.html">TorchDynamo Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dynamo/installation.html">Installing TorchDynamo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dynamo/get-started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dynamo/guards-overview.html">Guards Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dynamo/custom-backends.html">Custom Backends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dynamo/deep-dive.html">TorchDynamo Deeper Dive</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dynamo/troubleshooting.html">TorchDynamo Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dynamo/faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ir.html">IRs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Language Bindings</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../cpp_index.html">C++</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/javadoc/">Javadoc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../deploy.html">torch::deploy</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Python API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../torch.html">torch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nn.html">torch.nn</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nn.functional.html">torch.nn.functional</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tensors.html">torch.Tensor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tensor_attributes.html">Tensor Attributes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tensor_view.html">Tensor Views</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../amp.html">torch.amp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../autograd.html">torch.autograd</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../library.html">torch.library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cuda.html">torch.cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mps.html">torch.mps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../backends.html">torch.backends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.html">torch.distributed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.algorithms.join.html">torch.distributed.algorithms.join</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.elastic.html">torch.distributed.elastic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fsdp.html">torch.distributed.fsdp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.optim.html">torch.distributed.optim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.tensor.parallel.html">torch.distributed.tensor.parallel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.checkpoint.html">torch.distributed.checkpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributions.html">torch.distributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_dynamo.html">torch._dynamo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fft.html">torch.fft</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../func.html">torch.func</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../futures.html">torch.futures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fx.html">torch.fx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hub.html">torch.hub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../jit.html">torch.jit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../linalg.html">torch.linalg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../monitor.html">torch.monitor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../signal.html">torch.signal</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../special.html">torch.special</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../torch.overrides.html">torch.overrides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../package.html">torch.package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../profiler.html">torch.profiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nn.init.html">torch.nn.init</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../onnx.html">torch.onnx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../onnx_diagnostics.html">torch.onnx diagnostics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../optim.html">torch.optim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../complex_numbers.html">Complex Numbers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ddp_comm_hooks.html">DDP Communication Hooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pipeline.html">Pipeline Parallelism</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quantization.html">Quantization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rpc.html">Distributed RPC Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../random.html">torch.random</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../masked.html">torch.masked</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nested.html">torch.nested</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sparse.html">torch.sparse</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../storage.html">torch.Storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../testing.html">torch.testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../benchmark_utils.html">torch.utils.benchmark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../bottleneck.html">torch.utils.bottleneck</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../checkpoint.html">torch.utils.checkpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cpp_extension.html">torch.utils.cpp_extension</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data.html">torch.utils.data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../jit_utils.html">torch.utils.jit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dlpack.html">torch.utils.dlpack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mobile_optimizer.html">torch.utils.mobile_optimizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../model_zoo.html">torch.utils.model_zoo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tensorboard.html">torch.utils.tensorboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../type_info.html">Type Info</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../named_tensor.html">Named Tensors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../name_inference.html">Named Tensors operator coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../config_mod.html">torch.__config__</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Libraries</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/audio/stable">torchaudio</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/data">TorchData</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/torchrec">TorchRec</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/serve">TorchServe</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/text/stable">torchtext</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/vision/stable">torchvision</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/xla/">PyTorch on XLA Devices</a></li>
</ul>

            
          

        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="../../../index.html">
          
            Docs
          
        </a> &gt;
      </li>

        
          <li><a href="../../index.html">Module code</a> &gt;</li>
        
          <li><a href="../../torch.html">torch</a> &gt;</li>
        
          <li><a href="../onnx.html">torch.onnx</a> &gt;</li>
        
      <li>torch.onnx.verification</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">

        

          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <h1>Source code for torch.onnx.verification</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Functions to verify exported ONNX model is functionally equivalent to original PyTorch model.</span>

<span class="sd">ONNX Runtime is required, and is used as the ONNX backend for export verification.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">dataclasses</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">difflib</span>
<span class="kn">import</span> <span class="nn">enum</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">Collection</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">FrozenSet</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Mapping</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Sequence</span><span class="p">,</span>
    <span class="n">Set</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch._C._onnx</span> <span class="k">as</span> <span class="nn">_C_onnx</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">_C</span>
<span class="kn">from</span> <span class="nn">torch.onnx</span> <span class="kn">import</span> <span class="n">_constants</span><span class="p">,</span> <span class="n">_experimental</span><span class="p">,</span> <span class="n">_exporter_states</span><span class="p">,</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">torch.onnx._globals</span> <span class="kn">import</span> <span class="n">GLOBALS</span>
<span class="kn">from</span> <span class="nn">torch.onnx._internal</span> <span class="kn">import</span> <span class="n">_beartype</span><span class="p">,</span> <span class="n">onnx_proto_utils</span>
<span class="kn">from</span> <span class="nn">torch.types</span> <span class="kn">import</span> <span class="n">Number</span>

<span class="n">_ORT_PROVIDERS</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;CPUExecutionProvider&quot;</span><span class="p">,)</span>

<span class="n">_NumericType</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">Number</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
<span class="n">_ModelType</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">ScriptModule</span><span class="p">]</span>
<span class="n">_InputArgsType</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span>
<span class="n">_InputKwargsType</span> <span class="o">=</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
<span class="n">_OutputsType</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">_NumericType</span><span class="p">],</span> <span class="n">Sequence</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">OnnxBackend</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Enum class for ONNX backend used for export verification.&quot;&quot;&quot;</span>

    <span class="n">REFERENCE</span> <span class="o">=</span> <span class="s2">&quot;ONNXReferenceEvaluator&quot;</span>
    <span class="n">ONNX_RUNTIME_CPU</span> <span class="o">=</span> <span class="s2">&quot;CPUExecutionProvider&quot;</span>
    <span class="n">ONNX_RUNTIME_CUDA</span> <span class="o">=</span> <span class="s2">&quot;CUDAExecutionProvider&quot;</span>


<div class="viewcode-block" id="VerificationOptions"><a class="viewcode-back" href="../../../generated/torch.onnx.verification.VerificationOptions.html#torch.onnx.verification.VerificationOptions">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">VerificationOptions</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Options for ONNX export verification.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        flatten: If True, unpack nested list/tuple/dict inputs into a flattened list of</span>
<span class="sd">            Tensors for ONNX. Set this to False if nested structures are to be preserved</span>
<span class="sd">            for ONNX, which is usually the case with exporting ScriptModules. Default True.</span>
<span class="sd">        ignore_none: Whether to ignore None type in torch output, which is usually the</span>
<span class="sd">            case with tracing. Set this to False, if torch output should keep None type,</span>
<span class="sd">            which is usually the case with exporting ScriptModules. Default to True.</span>
<span class="sd">        check_shape: Whether to check the shapes between PyTorch and ONNX Runtime outputs</span>
<span class="sd">            are exactly the same. Set this to False to allow output shape broadcasting.</span>
<span class="sd">            Default to True.</span>
<span class="sd">        check_dtype: Whether to check the dtypes between PyTorch and ONNX Runtime outputs</span>
<span class="sd">            are consistent. Default to True.</span>
<span class="sd">        backend: ONNX backend for verification. Default to OnnxBackend.ONNX_RUNTIME_CPU.</span>
<span class="sd">        rtol: relative tolerance in comparison between ONNX and PyTorch outputs.</span>
<span class="sd">        atol: absolute tolerance in comparison between ONNX and PyTorch outputs.</span>
<span class="sd">        remained_onnx_input_idx: If provided, only the specified inputs will be passed</span>
<span class="sd">            to the ONNX model. Supply a list when there are unused inputs in the model.</span>
<span class="sd">            Since unused inputs will be removed in the exported ONNX model, supplying</span>
<span class="sd">            all inputs will cause an error on unexpected inputs. This parameter tells</span>
<span class="sd">            the verifier which inputs to pass into the ONNX model.</span>
<span class="sd">        acceptable_error_percentage: acceptable percentage of element mismatches in comparison.</span>
<span class="sd">            It should be a float of value between 0.0 and 1.0.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">flatten</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">ignore_none</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">check_shape</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">check_dtype</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">backend</span><span class="p">:</span> <span class="n">OnnxBackend</span> <span class="o">=</span> <span class="n">OnnxBackend</span><span class="o">.</span><span class="n">ONNX_RUNTIME_CPU</span>
    <span class="n">rtol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-3</span>
    <span class="n">atol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-7</span>
    <span class="n">remained_onnx_input_idx</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">acceptable_error_percentage</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></div>


<span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
<span class="k">def</span> <span class="nf">_flatten_tuples</span><span class="p">(</span><span class="n">elem</span><span class="p">):</span>
    <span class="n">flattened</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">elem</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">flattened</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_flatten_tuples</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flattened</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">flattened</span>


<span class="c1"># TODO(justinchuby): Add type checking by narrowing down the return type when input is None</span>
<span class="k">def</span> <span class="nf">_to_numpy</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">elem</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">elem</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">elem</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">_to_numpy</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span> <span class="k">for</span> <span class="n">inp</span> <span class="ow">in</span> <span class="n">elem</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">flattened</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">elem</span><span class="p">:</span>
            <span class="n">flattened</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">_to_numpy</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">_to_numpy</span><span class="p">(</span><span class="n">elem</span><span class="p">[</span><span class="n">k</span><span class="p">])])</span>
        <span class="k">return</span> <span class="n">flattened</span>
    <span class="k">return</span> <span class="n">elem</span>


<span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
<span class="k">def</span> <span class="nf">_inline_flatten_list</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">res_list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
        <span class="n">res_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
        <span class="p">)</span> <span class="k">else</span> <span class="n">_inline_flatten_list</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">res_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res_list</span>


<span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
<span class="k">def</span> <span class="nf">_unpack_to_numpy</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">cast_onnx_accepted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="n">value_unpacked</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
        <span class="n">value_unpacked</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">unpack_quantized_tensor</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">cast_onnx_accepted</span><span class="o">=</span><span class="n">cast_onnx_accepted</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">_to_numpy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value_unpacked</span><span class="p">]</span>


<span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
<span class="k">def</span> <span class="nf">_run_onnx</span><span class="p">(</span><span class="n">onnx_session</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_OutputsType</span><span class="p">:</span>
    <span class="n">kw_inputs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">inputs</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">kw_inputs</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">_unpack_to_numpy</span><span class="p">(</span><span class="n">_flatten_tuples</span><span class="p">(</span><span class="n">inputs</span><span class="p">))</span>
    <span class="n">ort_inputs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">input_name</span><span class="p">,</span> <span class="nb">input</span> <span class="ow">in</span> <span class="n">kw_inputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">ort_inputs</span><span class="p">[</span><span class="n">input_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">_to_numpy</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">_to_numpy</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">onnx_session</span><span class="p">,</span> <span class="s2">&quot;get_inputs&quot;</span><span class="p">):</span>
        <span class="c1"># onnxruntime.InferenceSession</span>
        <span class="n">input_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">onnx_session</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()]</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">onnx_session</span><span class="p">,</span> <span class="s2">&quot;input_names&quot;</span><span class="p">):</span>
        <span class="c1"># onnx.reference.ReferenceEvaluator</span>
        <span class="n">input_names</span> <span class="o">=</span> <span class="n">onnx_session</span><span class="o">.</span><span class="n">input_names</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown ONNX backend type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">onnx_session</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="nb">input</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inputs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_names</span><span class="p">)</span> <span class="ow">or</span> <span class="n">input_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">ort_inputs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;got too many positional inputs. inputs: </span><span class="si">{</span><span class="n">inputs</span><span class="si">}</span><span class="s2">. kw_inputs: </span><span class="si">{</span><span class="n">kw_inputs</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;input names: </span><span class="si">{</span><span class="n">input_names</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
        <span class="n">ort_inputs</span><span class="p">[</span><span class="n">input_names</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">input</span>
    <span class="n">onnx_outs</span> <span class="o">=</span> <span class="n">onnx_session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">ort_inputs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">onnx_outs</span>


<span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
<span class="k">def</span> <span class="nf">_ort_session</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">],</span> <span class="n">ort_providers</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">_ORT_PROVIDERS</span>
<span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">onnxruntime</span>  <span class="c1"># type: ignore[import]</span>
    <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;onnxruntime is required for export verification.&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

    <span class="k">if</span> <span class="n">ort_providers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ort_providers</span> <span class="o">=</span> <span class="n">_ORT_PROVIDERS</span>

    <span class="n">session_options</span> <span class="o">=</span> <span class="n">onnxruntime</span><span class="o">.</span><span class="n">SessionOptions</span><span class="p">()</span>
    <span class="c1"># suppress ort warnings.</span>
    <span class="c1"># 0:Verbose, 1:Info, 2:Warning. 3:Error, 4:Fatal. Default is 2.</span>
    <span class="n">session_options</span><span class="o">.</span><span class="n">log_severity_level</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">ort_session</span> <span class="o">=</span> <span class="n">onnxruntime</span><span class="o">.</span><span class="n">InferenceSession</span><span class="p">(</span>
        <span class="n">model</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">model</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span>
        <span class="n">session_options</span><span class="p">,</span>
        <span class="n">providers</span><span class="o">=</span><span class="n">ort_providers</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">ort_session</span>


<span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
<span class="k">def</span> <span class="nf">_onnx_reference_evaluator_session</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">]):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">onnx</span>
        <span class="kn">from</span> <span class="nn">onnx</span> <span class="kn">import</span> <span class="n">reference</span> <span class="k">as</span> <span class="n">onnx_reference</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;onnx &gt;= 1.13 is required for reference evaluator.&quot;</span><span class="p">)</span>

    <span class="n">proto</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">onnx</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="k">else</span> <span class="n">onnx</span><span class="o">.</span><span class="n">load_model_from_string</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
    <span class="p">)</span>
    <span class="n">onnx_session</span> <span class="o">=</span> <span class="n">onnx_reference</span><span class="o">.</span><span class="n">ReferenceEvaluator</span><span class="p">(</span><span class="n">proto</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">onnx_session</span>


<span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
<span class="k">def</span> <span class="nf">_onnx_backend_session</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">],</span> <span class="n">backend</span><span class="p">:</span> <span class="n">OnnxBackend</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">backend</span> <span class="o">==</span> <span class="n">OnnxBackend</span><span class="o">.</span><span class="n">REFERENCE</span><span class="p">:</span>
        <span class="n">onnx_session</span> <span class="o">=</span> <span class="n">_onnx_reference_evaluator_session</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">backend</span> <span class="ow">in</span> <span class="p">{</span><span class="n">OnnxBackend</span><span class="o">.</span><span class="n">ONNX_RUNTIME_CPU</span><span class="p">,</span> <span class="n">OnnxBackend</span><span class="o">.</span><span class="n">ONNX_RUNTIME_CUDA</span><span class="p">}:</span>
        <span class="n">onnx_session</span> <span class="o">=</span> <span class="n">_ort_session</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="p">(</span><span class="n">backend</span><span class="o">.</span><span class="n">value</span><span class="p">,))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported backend: </span><span class="si">{</span><span class="n">backend</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">onnx_session</span>


<span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
<span class="k">def</span> <span class="nf">_compare_onnx_pytorch_outputs_in_np</span><span class="p">(</span>
    <span class="n">onnx_outs</span><span class="p">:</span> <span class="n">_OutputsType</span><span class="p">,</span>
    <span class="n">pt_outs</span><span class="p">:</span> <span class="n">_OutputsType</span><span class="p">,</span>
    <span class="n">options</span><span class="p">:</span> <span class="n">VerificationOptions</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">onnx_outs</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span>
        <span class="n">pt_outs</span>
    <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Number of outputs differ ONNX runtime: (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">onnx_outs</span><span class="p">)</span><span class="si">}</span><span class="s2">) PyTorch: (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pt_outs</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
    <span class="n">acceptable_error_percentage</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">acceptable_error_percentage</span>
    <span class="k">if</span> <span class="n">acceptable_error_percentage</span> <span class="ow">and</span> <span class="p">(</span>
        <span class="n">acceptable_error_percentage</span> <span class="o">&gt;</span> <span class="mf">1.0</span> <span class="ow">or</span> <span class="n">acceptable_error_percentage</span> <span class="o">&lt;</span> <span class="mf">0.0</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;If set, acceptable_error_percentage should be between 0.0 and 1.0&quot;</span>
        <span class="p">)</span>

    <span class="k">for</span> <span class="n">ort_out</span><span class="p">,</span> <span class="n">pt_out</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">onnx_outs</span><span class="p">,</span> <span class="n">pt_outs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># TODO: Remove `check_shape` option once every shape inconsistent issue is addressed.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">check_shape</span><span class="p">:</span>
                <span class="c1"># Allow different but broadcastable output shapes.</span>
                <span class="n">ort_out</span><span class="p">,</span> <span class="n">pt_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_arrays</span><span class="p">(</span><span class="n">ort_out</span><span class="p">,</span> <span class="n">pt_out</span><span class="p">)</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_close</span><span class="p">(</span>
                <span class="n">ort_out</span><span class="p">,</span>
                <span class="n">pt_out</span><span class="p">,</span>
                <span class="n">rtol</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">rtol</span><span class="p">,</span>
                <span class="n">atol</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">atol</span><span class="p">,</span>
                <span class="n">check_dtype</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">check_dtype</span><span class="p">,</span>
                <span class="n">equal_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">acceptable_error_percentage</span><span class="p">:</span>
                <span class="n">error_percentage</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">ort_out</span><span class="p">,</span> <span class="n">pt_out</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">rtol</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">atol</span><span class="p">)</span>
                <span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">ort_out</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">error_percentage</span> <span class="o">&lt;=</span> <span class="n">acceptable_error_percentage</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Suppressed AssertionError:</span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Error percentage </span><span class="si">{</span><span class="n">error_percentage</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;within acceptable range </span><span class="si">{</span><span class="n">acceptable_error_percentage</span><span class="si">}</span><span class="s2">.&quot;</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>
            <span class="k">if</span> <span class="n">ort_out</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span> <span class="ow">or</span> <span class="n">ort_out</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;ONNX output is quantized&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pt_out</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span> <span class="ow">or</span> <span class="n">pt_out</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;PyTorch output is quantized&quot;</span><span class="p">)</span>
            <span class="k">raise</span>


<span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
<span class="k">def</span> <span class="nf">_compare_onnx_pytorch_outputs</span><span class="p">(</span>
    <span class="n">onnx_outs</span><span class="p">:</span> <span class="n">_OutputsType</span><span class="p">,</span>
    <span class="n">pt_outs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">options</span><span class="p">:</span> <span class="n">VerificationOptions</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compare ONNX and PyTorch outputs.</span>

<span class="sd">    Args:</span>
<span class="sd">        onnx_outs: outputs from ONNX backend.</span>
<span class="sd">        pt_outs: outputs from PyTorch.</span>
<span class="sd">        options: options for verification.</span>

<span class="sd">    Raises:</span>
<span class="sd">        AssertionError: if outputs from ONNX model and PyTorch model are not</span>
<span class="sd">            equal up to specified precision.</span>
<span class="sd">        ValueError: if arguments provided are invalid.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">ignore_none</span><span class="p">:</span>
        <span class="c1"># torch.jit._flatten filters None type</span>
        <span class="n">pt_outs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">_flatten</span><span class="p">(</span><span class="n">pt_outs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pt_outs</span> <span class="o">=</span> <span class="n">_inline_flatten_list</span><span class="p">([</span><span class="n">pt_outs</span><span class="p">],</span> <span class="p">[])</span>
    <span class="n">pt_outs_np</span> <span class="o">=</span> <span class="n">_unpack_to_numpy</span><span class="p">(</span><span class="n">pt_outs</span><span class="p">,</span> <span class="n">cast_onnx_accepted</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">onnx_outs</span> <span class="o">=</span> <span class="n">_inline_flatten_list</span><span class="p">(</span><span class="n">onnx_outs</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">_compare_onnx_pytorch_outputs_in_np</span><span class="p">(</span><span class="n">onnx_outs</span><span class="p">,</span> <span class="n">pt_outs_np</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>


<span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
<span class="k">def</span> <span class="nf">_prepare_input_for_pytorch</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Prepare input for PyTorch model execution.</span>

<span class="sd">    Any future changes/formatting to the input before dispatching to the PyTorch</span>
<span class="sd">    model should be made in this function.</span>

<span class="sd">    Args:</span>
<span class="sd">        args: positional arguments for PyTorch model forward method.</span>
<span class="sd">        kwargs: keyword arguments for PyTorch model forward method.</span>

<span class="sd">    Returns:</span>
<span class="sd">        args: positional arguments for PyTorch model forward method.</span>
<span class="sd">        kwargs: keyword arguments for PyTorch model forward method.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">args</span><span class="p">,)</span>
    <span class="c1"># In-place operators will update input tensor data as well.</span>
    <span class="c1"># Thus inputs are replicated before every forward call.</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">return</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span>


<span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
<span class="k">def</span> <span class="nf">_prepare_input_for_export</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Prepare input for ONNX model export.</span>

<span class="sd">    Any future changes/formatting to the input before dispatching to the</span>
<span class="sd">    :func:`torch.onnx.export` api should be made in this function.</span>

<span class="sd">    Args:</span>
<span class="sd">        args: positional arguments for PyTorch model forward method.</span>
<span class="sd">        kwargs: keyword arguments for PyTorch model forward method.</span>

<span class="sd">    Returns:</span>
<span class="sd">        onnx_inputs: positional arguments for ONNX model export, as `args` in</span>
<span class="sd">            :func:`torch.onnx.export`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">_prepare_input_for_pytorch</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">onnx_inputs</span> <span class="o">=</span> <span class="n">args</span> <span class="o">+</span> <span class="p">({},)</span>
    <span class="k">elif</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">onnx_inputs</span> <span class="o">=</span> <span class="n">args</span> <span class="o">+</span> <span class="p">(</span><span class="n">kwargs</span><span class="p">,)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">onnx_inputs</span> <span class="o">=</span> <span class="n">args</span>
    <span class="k">return</span> <span class="n">onnx_inputs</span>


<span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
<span class="k">def</span> <span class="nf">_prepare_input_for_onnx</span><span class="p">(</span>
    <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">remained_onnx_input_idx</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span> <span class="n">flatten</span><span class="p">:</span> <span class="nb">bool</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Prepare input for ONNX model execution in ONNX backend.</span>

<span class="sd">    Any future changes/formatting to the input before dispatching to the ONNX backend</span>
<span class="sd">    run should be made in this function.</span>

<span class="sd">    Args:</span>
<span class="sd">        args: positional arguments for PyTorch model forward method.</span>
<span class="sd">        kwargs: keyword arguments for PyTorch model forward method.</span>
<span class="sd">        remained_onnx_input_idx: indices of inputs to be used for ONNX model execution.</span>
<span class="sd">        flatten: whether to flatten the input before dispatching to the ONNX model execution.</span>

<span class="sd">    Returns:</span>
<span class="sd">        onnx_inputs: positional arguments for ONNX model execution in ONNX backend.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">onnx_inputs</span> <span class="o">=</span> <span class="n">_prepare_input_for_export</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">flatten</span><span class="p">:</span>
        <span class="n">onnx_inputs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">_flatten</span><span class="p">(</span><span class="n">onnx_inputs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">onnx_inputs</span> <span class="ow">and</span> <span class="n">onnx_inputs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="p">{}:</span>
        <span class="c1"># Handle empty kwargs (normally removed by flatten).</span>
        <span class="n">onnx_inputs</span> <span class="o">=</span> <span class="n">onnx_inputs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">remained_onnx_input_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">onnx_inputs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">remained_onnx_input_idx</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">onnx_inputs</span>


<span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
<span class="k">def</span> <span class="nf">_try_clone_model</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Used for preserving original model in case forward mutates model states.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;Failed to clone model. Model state might be mutated during verification.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">model</span>


<span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
<span class="k">def</span> <span class="nf">_compare_onnx_pytorch_model</span><span class="p">(</span>
    <span class="n">pt_model</span><span class="p">:</span> <span class="n">_ModelType</span><span class="p">,</span>
    <span class="n">onnx_model_f</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">],</span>
    <span class="n">input_args</span><span class="p">:</span> <span class="n">_InputArgsType</span><span class="p">,</span>
    <span class="n">input_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_InputKwargsType</span><span class="p">],</span>
    <span class="n">additional_test_inputs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">_InputArgsType</span><span class="p">]],</span>
    <span class="n">options</span><span class="p">:</span> <span class="n">VerificationOptions</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compare outputs from ONNX model runs with outputs from PyTorch model runs.</span>

<span class="sd">    Args:</span>
<span class="sd">        pt_model: PyTorch model.</span>
<span class="sd">        onnx_model_f: ONNX model file path or file-like object.</span>
<span class="sd">        input_args: positional arguments for PyTorch model forward method.</span>
<span class="sd">        input_kwargs: keyword arguments for PyTorch model forward method.</span>
<span class="sd">        additional_test_inputs: additional positional arguments for PyTorch model</span>
<span class="sd">            forward method.</span>
<span class="sd">        options: options for verification.</span>

<span class="sd">    Raises:</span>
<span class="sd">        AssertionError: if outputs from ONNX model and PyTorch model are not</span>
<span class="sd">            equal up to specified precision.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">onnx_session</span> <span class="o">=</span> <span class="n">_onnx_backend_session</span><span class="p">(</span><span class="n">onnx_model_f</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">backend</span><span class="p">)</span>

    <span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
    <span class="k">def</span> <span class="nf">compare_onnx_pytorch_model_with_input</span><span class="p">(</span><span class="n">input_args</span><span class="p">,</span> <span class="n">input_kwargs</span><span class="p">):</span>
        <span class="n">pt_args</span><span class="p">,</span> <span class="n">pt_kwargs</span> <span class="o">=</span> <span class="n">_prepare_input_for_pytorch</span><span class="p">(</span><span class="n">input_args</span><span class="p">,</span> <span class="n">input_kwargs</span><span class="p">)</span>
        <span class="c1"># TODO: remove this and treat mutating model separately. See #77679</span>
        <span class="n">pt_model_copy</span> <span class="o">=</span> <span class="n">_try_clone_model</span><span class="p">(</span><span class="n">pt_model</span><span class="p">)</span>
        <span class="n">pt_outs</span> <span class="o">=</span> <span class="n">pt_model_copy</span><span class="p">(</span><span class="o">*</span><span class="n">pt_args</span><span class="p">,</span> <span class="o">**</span><span class="n">pt_kwargs</span><span class="p">)</span>

        <span class="n">onnx_inputs</span> <span class="o">=</span> <span class="n">_prepare_input_for_onnx</span><span class="p">(</span>
            <span class="n">input_args</span><span class="p">,</span> <span class="n">input_kwargs</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">remained_onnx_input_idx</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">flatten</span>
        <span class="p">)</span>

        <span class="n">onnx_outs</span> <span class="o">=</span> <span class="n">_run_onnx</span><span class="p">(</span><span class="n">onnx_session</span><span class="p">,</span> <span class="n">onnx_inputs</span><span class="p">)</span>

        <span class="n">_compare_onnx_pytorch_outputs</span><span class="p">(</span>
            <span class="n">onnx_outs</span><span class="o">=</span><span class="n">onnx_outs</span><span class="p">,</span>
            <span class="n">pt_outs</span><span class="o">=</span><span class="n">pt_outs</span><span class="p">,</span>
            <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">compare_onnx_pytorch_model_with_input</span><span class="p">(</span><span class="n">input_args</span><span class="p">,</span> <span class="n">input_kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">additional_test_inputs</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">test_input_args</span> <span class="ow">in</span> <span class="n">additional_test_inputs</span><span class="p">:</span>
            <span class="n">compare_onnx_pytorch_model_with_input</span><span class="p">(</span><span class="n">test_input_args</span><span class="p">,</span> <span class="p">{})</span>


<span class="k">class</span> <span class="nc">_GraphDiff</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A class to represent the difference between two graphs.&quot;&quot;&quot;</span>

    <span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_a</span><span class="p">:</span> <span class="n">_C</span><span class="o">.</span><span class="n">Graph</span><span class="p">,</span> <span class="n">graph_b</span><span class="p">:</span> <span class="n">_C</span><span class="o">.</span><span class="n">Graph</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct a _GraphDiff object.</span>

<span class="sd">        Args:</span>
<span class="sd">            graph_a (_C.Graph): First graph to compare.</span>
<span class="sd">            graph_b (_C.Graph): Second graph to compare.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph_a</span> <span class="o">=</span> <span class="n">graph_a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph_b</span> <span class="o">=</span> <span class="n">graph_b</span>

    <span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;See function :func:`diff_report`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">diff_report</span><span class="p">()</span>

    <span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
    <span class="k">def</span> <span class="nf">_indent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()])</span>

    <span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
    <span class="k">def</span> <span class="nf">diff_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return a string representation of the graph difference.</span>

<span class="sd">        The report shows the first pair of nodes that diverges. It also shows the source</span>
<span class="sd">        location of the pair of nodes.</span>

<span class="sd">        Returns:</span>
<span class="sd">            graph_diff_report (str): A string representation of the graph difference.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">graph_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_a</span>
        <span class="n">graph_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_b</span>

        <span class="n">graph_a_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">graph_a</span><span class="p">)</span>
        <span class="n">graph_b_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">graph_b</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">graph_a_str</span> <span class="o">==</span> <span class="n">graph_b_str</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

        <span class="n">graph_diff</span> <span class="o">=</span> <span class="n">difflib</span><span class="o">.</span><span class="n">ndiff</span><span class="p">(</span>
            <span class="n">graph_a_str</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">graph_b_str</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">graph_diff_report</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Graph diff:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indent</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">graph_diff</span><span class="p">))]</span>

        <span class="k">for</span> <span class="n">node_a</span><span class="p">,</span> <span class="n">node_b</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">zip_longest</span><span class="p">(</span><span class="n">graph_a</span><span class="o">.</span><span class="n">nodes</span><span class="p">(),</span> <span class="n">graph_b</span><span class="o">.</span><span class="n">nodes</span><span class="p">()):</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">node_a</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">node_b</span><span class="p">):</span>
                <span class="n">graph_diff_report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;First diverging operator:&quot;</span><span class="p">)</span>
                <span class="n">node_diff</span> <span class="o">=</span> <span class="n">difflib</span><span class="o">.</span><span class="n">ndiff</span><span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">node_a</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">node_b</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">source_printout</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;node diff:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indent</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">node_diff</span><span class="p">))]</span>

                <span class="n">stack_a</span> <span class="o">=</span> <span class="n">node_a</span><span class="o">.</span><span class="n">sourceRange</span><span class="p">()</span> <span class="k">if</span> <span class="n">node_a</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">stack_a</span><span class="p">:</span>
                    <span class="n">source_printout</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                        <span class="p">[</span><span class="s2">&quot;Former source location:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indent</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">stack_a</span><span class="p">))]</span>
                    <span class="p">)</span>
                <span class="n">stack_b</span> <span class="o">=</span> <span class="n">node_b</span><span class="o">.</span><span class="n">sourceRange</span><span class="p">()</span> <span class="k">if</span> <span class="n">node_b</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">stack_b</span><span class="p">:</span>
                    <span class="n">source_printout</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                        <span class="p">[</span><span class="s2">&quot;Latter source location:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indent</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">stack_b</span><span class="p">))]</span>
                    <span class="p">)</span>

                <span class="n">graph_diff_report</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">source_printout</span><span class="p">)</span>

                <span class="k">break</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">graph_diff_report</span><span class="p">)</span>


<span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
<span class="k">def</span> <span class="nf">_check_graph_diff</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">ScriptModule</span><span class="p">],</span>
    <span class="n">test_input_groups</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]],</span>
    <span class="n">export_options</span><span class="p">:</span> <span class="n">_experimental</span><span class="o">.</span><span class="n">ExportOptions</span><span class="p">,</span>
    <span class="n">model_to_graph_func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
        <span class="p">[</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span>
            <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
            <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
            <span class="n">_experimental</span><span class="o">.</span><span class="n">ExportOptions</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">_C</span><span class="o">.</span><span class="n">Graph</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Check if graph produced by `model_to_graph_func` is the same across `test_input_groups`.</span>

<span class="sd">    Args:</span>
<span class="sd">        model: See :func:`check_export_model_diff`.</span>
<span class="sd">        test_input_groups: See :func:`check_export_model_diff`.</span>
<span class="sd">        export_options: See :func:`check_export_model_diff`.</span>
<span class="sd">        model_to_graph_func: A function to convert a PyTorch model to a JIT IR graph.</span>

<span class="sd">    Returns:</span>
<span class="sd">        graph_diff_report (str): A string representation of the graph difference.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_input_groups</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Need at least two groups of test inputs to compare.&quot;</span><span class="p">)</span>

    <span class="n">ref_jit_graph</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="ow">in</span> <span class="n">test_input_groups</span><span class="p">:</span>
        <span class="n">jit_graph</span> <span class="o">=</span> <span class="n">model_to_graph_func</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">export_options</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ref_jit_graph</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ref_jit_graph</span> <span class="o">=</span> <span class="n">jit_graph</span>
            <span class="k">continue</span>

        <span class="n">graph_diff_report</span> <span class="o">=</span> <span class="n">_GraphDiff</span><span class="p">(</span><span class="n">ref_jit_graph</span><span class="p">,</span> <span class="n">jit_graph</span><span class="p">)</span><span class="o">.</span><span class="n">diff_report</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">graph_diff_report</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">graph_diff_report</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span>


<span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
<span class="k">def</span> <span class="nf">_traced_graph_from_model</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">ScriptModule</span><span class="p">],</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
    <span class="n">kwargs</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">export_options</span><span class="p">:</span> <span class="n">_experimental</span><span class="o">.</span><span class="n">ExportOptions</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_C</span><span class="o">.</span><span class="n">Graph</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;As part of the ONNX export steps, create a traced JIT graph from a PyTorch model.</span>

<span class="sd">    Args:</span>
<span class="sd">        model: See :func:`check_export_model_diff`.</span>
<span class="sd">        args: See :func:`check_export_model_diff`.</span>
<span class="sd">        kwargs: See :func:`check_export_model_diff`.</span>
<span class="sd">        export_options: See :func:`check_export_model_diff`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        jit_graph (_C.Graph): A traced JIT graph.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">training</span> <span class="o">=</span> <span class="n">export_options</span><span class="o">.</span><span class="n">training</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">export_options</span><span class="o">.</span><span class="n">verbose</span>

    <span class="k">with</span> <span class="n">utils</span><span class="o">.</span><span class="n">exporter_context</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">training</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
        <span class="n">export_inputs</span> <span class="o">=</span> <span class="n">_prepare_input_for_export</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">_pre_trace_quant_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">export_inputs</span><span class="p">)</span>
        <span class="n">jit_graph</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">_create_jit_graph</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">export_inputs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jit_graph</span>


<span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
<span class="k">def</span> <span class="nf">_onnx_graph_from_model</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">ScriptModule</span><span class="p">],</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
    <span class="n">kwargs</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">export_options</span><span class="p">:</span> <span class="n">_experimental</span><span class="o">.</span><span class="n">ExportOptions</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_C</span><span class="o">.</span><span class="n">Graph</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;As part of the ONNX export steps, export an ONNX JIT graph from a PyTorch model.</span>

<span class="sd">    Args:</span>
<span class="sd">        model: See :func:`check_export_model_diff`.</span>
<span class="sd">        args: See :func:`check_export_model_diff`.</span>
<span class="sd">        kwargs: See :func:`check_export_model_diff`.</span>
<span class="sd">        export_options: See :func:`check_export_model_diff`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        onnx_graph (_C.Graph): An ONNX JIT graph.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: refactor utils.py to remove duplicated code of context setup. See #78834</span>
    <span class="n">opset_version</span> <span class="o">=</span> <span class="n">export_options</span><span class="o">.</span><span class="n">opset_version</span>
    <span class="n">operator_export_type</span> <span class="o">=</span> <span class="n">export_options</span><span class="o">.</span><span class="n">operator_export_type</span>
    <span class="n">export_modules_as_functions</span> <span class="o">=</span> <span class="n">export_options</span><span class="o">.</span><span class="n">export_modules_as_functions</span>
    <span class="n">training</span> <span class="o">=</span> <span class="n">export_options</span><span class="o">.</span><span class="n">training</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">export_options</span><span class="o">.</span><span class="n">verbose</span>
    <span class="n">dynamic_axes</span> <span class="o">=</span> <span class="n">export_options</span><span class="o">.</span><span class="n">dynamic_axes</span>
    <span class="n">input_names</span> <span class="o">=</span> <span class="n">export_options</span><span class="o">.</span><span class="n">input_names</span>
    <span class="n">output_names</span> <span class="o">=</span> <span class="n">export_options</span><span class="o">.</span><span class="n">output_names</span>

    <span class="k">if</span> <span class="n">opset_version</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">opset_version</span> <span class="o">=</span> <span class="n">_constants</span><span class="o">.</span><span class="n">ONNX_DEFAULT_OPSET</span>

    <span class="n">utils</span><span class="o">.</span><span class="n">_setup_trace_module_map</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">export_modules_as_functions</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">operator_export_type</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_C_onnx</span><span class="o">.</span><span class="n">_CAFFE2_ATEN_FALLBACK</span><span class="p">:</span>
            <span class="n">operator_export_type</span> <span class="o">=</span> <span class="n">_C_onnx</span><span class="o">.</span><span class="n">OperatorExportTypes</span><span class="o">.</span><span class="n">ONNX_ATEN_FALLBACK</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">operator_export_type</span> <span class="o">=</span> <span class="n">_C_onnx</span><span class="o">.</span><span class="n">OperatorExportTypes</span><span class="o">.</span><span class="n">ONNX</span>

    <span class="n">GLOBALS</span><span class="o">.</span><span class="n">export_onnx_opset_version</span> <span class="o">=</span> <span class="n">opset_version</span>
    <span class="n">GLOBALS</span><span class="o">.</span><span class="n">operator_export_type</span> <span class="o">=</span> <span class="n">operator_export_type</span>

    <span class="k">with</span> <span class="n">utils</span><span class="o">.</span><span class="n">exporter_context</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">training</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
        <span class="n">do_constant_folding</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">_decide_constant_folding</span><span class="p">(</span>
            <span class="n">export_options</span><span class="o">.</span><span class="n">do_constant_folding</span><span class="p">,</span> <span class="n">operator_export_type</span><span class="p">,</span> <span class="n">training</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">dynamic_axes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dynamic_axes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">_validate_dynamic_axes</span><span class="p">(</span><span class="n">dynamic_axes</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">input_names</span><span class="p">,</span> <span class="n">output_names</span><span class="p">)</span>

        <span class="n">export_inputs</span> <span class="o">=</span> <span class="n">_prepare_input_for_export</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="n">export_inputs</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">_decide_input_format</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">export_inputs</span><span class="p">)</span>
        <span class="n">onnx_graph</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">_model_to_graph</span><span class="p">(</span>
            <span class="n">model</span><span class="p">,</span>
            <span class="n">export_inputs</span><span class="p">,</span>
            <span class="n">verbose</span><span class="p">,</span>
            <span class="n">input_names</span><span class="p">,</span>
            <span class="n">output_names</span><span class="p">,</span>
            <span class="n">operator_export_type</span><span class="p">,</span>
            <span class="n">do_constant_folding</span><span class="p">,</span>
            <span class="n">training</span><span class="o">=</span><span class="n">training</span><span class="p">,</span>
            <span class="n">dynamic_axes</span><span class="o">=</span><span class="n">dynamic_axes</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">onnx_graph</span>


<span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
<span class="k">def</span> <span class="nf">_onnx_graph_from_aten_graph</span><span class="p">(</span>
    <span class="n">graph</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Graph</span><span class="p">,</span>
    <span class="n">export_options</span><span class="p">:</span> <span class="n">_experimental</span><span class="o">.</span><span class="n">ExportOptions</span><span class="p">,</span>
    <span class="n">params_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Graph</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="k">if</span> <span class="n">params_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">params_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">operator_export_type</span> <span class="o">=</span> <span class="n">export_options</span><span class="o">.</span><span class="n">operator_export_type</span>
    <span class="n">dynamic_axes</span> <span class="o">=</span> <span class="n">export_options</span><span class="o">.</span><span class="n">dynamic_axes</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="n">input_names</span> <span class="o">=</span> <span class="n">export_options</span><span class="o">.</span><span class="n">input_names</span>
    <span class="n">training</span> <span class="o">=</span> <span class="n">export_options</span><span class="o">.</span><span class="n">training</span>
    <span class="n">do_constant_folding</span> <span class="o">=</span> <span class="n">export_options</span><span class="o">.</span><span class="n">do_constant_folding</span>
    <span class="n">opset_version</span> <span class="o">=</span> <span class="n">export_options</span><span class="o">.</span><span class="n">opset_version</span> <span class="ow">or</span> <span class="n">_constants</span><span class="o">.</span><span class="n">ONNX_DEFAULT_OPSET</span>

    <span class="n">GLOBALS</span><span class="o">.</span><span class="n">export_onnx_opset_version</span> <span class="o">=</span> <span class="n">opset_version</span>
    <span class="n">GLOBALS</span><span class="o">.</span><span class="n">operator_export_type</span> <span class="o">=</span> <span class="n">operator_export_type</span>

    <span class="n">do_constant_folding</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">_decide_constant_folding</span><span class="p">(</span>
        <span class="n">do_constant_folding</span><span class="p">,</span> <span class="n">operator_export_type</span><span class="p">,</span> <span class="n">training</span>
    <span class="p">)</span>

    <span class="c1"># TODO: Below is doing aten graph to onnx. It should be abstracted as a</span>
    <span class="c1"># function in torch/onnx/utils.py.</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">_optimize_graph</span><span class="p">(</span>
        <span class="n">graph</span><span class="p">,</span>
        <span class="n">operator_export_type</span><span class="p">,</span>
        <span class="n">params_dict</span><span class="o">=</span><span class="n">params_dict</span><span class="p">,</span>
        <span class="n">dynamic_axes</span><span class="o">=</span><span class="n">dynamic_axes</span><span class="p">,</span>
        <span class="n">input_names</span><span class="o">=</span><span class="n">input_names</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">training</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">training</span> <span class="o">==</span> <span class="n">_C_onnx</span><span class="o">.</span><span class="n">TrainingMode</span><span class="o">.</span><span class="n">EVAL</span><span class="p">:</span>
        <span class="n">params_dict</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">_jit_pass_onnx_eval_peephole</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">params_dict</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="n">do_constant_folding</span>
        <span class="ow">and</span> <span class="n">opset_version</span> <span class="o">&gt;=</span> <span class="n">_constants</span><span class="o">.</span><span class="n">ONNX_CONSTANT_FOLDING_MIN_OPSET</span>
    <span class="p">):</span>
        <span class="n">params_dict</span> <span class="o">=</span> <span class="n">_C</span><span class="o">.</span><span class="n">_jit_pass_onnx_constant_fold</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">params_dict</span><span class="p">,</span> <span class="n">opset_version</span><span class="p">)</span>
        <span class="n">_C</span><span class="o">.</span><span class="n">_jit_pass_dce_allow_deleting_nodes_with_side_effects</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">GLOBALS</span><span class="o">.</span><span class="n">onnx_shape_inference</span><span class="p">:</span>
        <span class="n">_C</span><span class="o">.</span><span class="n">_jit_pass_onnx_graph_shape_type_inference</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">params_dict</span><span class="p">,</span> <span class="n">opset_version</span><span class="p">)</span>

    <span class="n">params_dict</span> <span class="o">=</span> <span class="n">_C</span><span class="o">.</span><span class="n">_jit_pass_onnx_eliminate_unused_items</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">params_dict</span><span class="p">)</span>

    <span class="c1"># For ONNX opset &lt; 9, constants only have three data types: float16, float, double.</span>
    <span class="c1"># In this pass transform constants of other data types to float/double + cast operator.</span>
    <span class="k">if</span> <span class="n">opset_version</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">:</span>
        <span class="n">_C</span><span class="o">.</span><span class="n">_jit_pass_onnx_cast_all_constant_to_floating</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>

    <span class="n">params_dict</span> <span class="o">=</span> <span class="n">_C</span><span class="o">.</span><span class="n">_jit_pass_filter_non_tensor_arguments</span><span class="p">(</span><span class="n">params_dict</span><span class="p">)</span>
    <span class="n">_C</span><span class="o">.</span><span class="n">_jit_decay_packed_param_input_types</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>

    <span class="n">_C</span><span class="o">.</span><span class="n">_jit_pass_dce_allow_deleting_nodes_with_side_effects</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">export_options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ONNX graph: &quot;</span><span class="p">,</span> <span class="n">graph</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">graph</span><span class="p">,</span> <span class="n">params_dict</span>


<span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
<span class="k">def</span> <span class="nf">_onnx_proto_from_onnx_graph</span><span class="p">(</span>
    <span class="n">onnx_graph</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Graph</span><span class="p">,</span>
    <span class="n">export_options</span><span class="p">:</span> <span class="n">_experimental</span><span class="o">.</span><span class="n">ExportOptions</span><span class="p">,</span>
    <span class="n">params_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]:</span>
    <span class="n">opset_version</span> <span class="o">=</span> <span class="n">export_options</span><span class="o">.</span><span class="n">opset_version</span> <span class="ow">or</span> <span class="n">_constants</span><span class="o">.</span><span class="n">ONNX_DEFAULT_OPSET</span>
    <span class="n">dynamic_axes</span> <span class="o">=</span> <span class="n">export_options</span><span class="o">.</span><span class="n">dynamic_axes</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="n">operator_export_type</span> <span class="o">=</span> <span class="n">export_options</span><span class="o">.</span><span class="n">operator_export_type</span>
    <span class="n">val_keep_init_as_ip</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">_decide_keep_init_as_input</span><span class="p">(</span>
        <span class="n">export_options</span><span class="o">.</span><span class="n">keep_initializers_as_inputs</span><span class="p">,</span>
        <span class="n">operator_export_type</span><span class="p">,</span>
        <span class="n">opset_version</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">val_add_node_names</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">_decide_add_node_names</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">operator_export_type</span><span class="p">)</span>
    <span class="n">custom_opsets</span> <span class="o">=</span> <span class="n">export_options</span><span class="o">.</span><span class="n">custom_opsets</span> <span class="ow">or</span> <span class="p">{}</span>

    <span class="n">proto</span><span class="p">,</span> <span class="n">export_map</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">onnx_graph</span><span class="o">.</span><span class="n">_export_onnx</span><span class="p">(</span>  <span class="c1"># type: ignore[attr-defined]</span>
        <span class="n">params_dict</span><span class="p">,</span>
        <span class="n">opset_version</span><span class="p">,</span>
        <span class="n">dynamic_axes</span><span class="p">,</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="n">operator_export_type</span><span class="p">,</span>
        <span class="ow">not</span> <span class="n">export_options</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
        <span class="n">val_keep_init_as_ip</span><span class="p">,</span>
        <span class="n">custom_opsets</span><span class="p">,</span>
        <span class="n">val_add_node_names</span><span class="p">,</span>
        <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="p">{},</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">proto</span><span class="p">,</span> <span class="n">export_map</span>


<span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
<span class="k">def</span> <span class="nf">check_export_model_diff</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">ScriptModule</span><span class="p">],</span>
    <span class="n">test_input_groups</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]],</span>
    <span class="n">export_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_experimental</span><span class="o">.</span><span class="n">ExportOptions</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Verify exported model discrepancy between different groups of inputs.</span>

<span class="sd">    A graph is exported for each group of inputs. The exported graphs are then compared</span>
<span class="sd">    to each other, and discrepancies of first pair of nodes are reported. This function</span>
<span class="sd">    first checks the jit graph. If no discrepancies were found, it then checks the onnx</span>
<span class="sd">    graph.</span>

<span class="sd">    Unless otherwise specified, the jit/ONNX graph is expected to be the same, regardless</span>
<span class="sd">    of the inputs used for exporting. A discrepancy implies the graph exported is</span>
<span class="sd">    not accurate when run on other groups of inputs, which will typically results in</span>
<span class="sd">    runtime errors or mismatching output.</span>

<span class="sd">    Args:</span>
<span class="sd">        model (torch.nn.Module or torch.jit.ScriptModule): The model to be exported.</span>
<span class="sd">        test_input_groups (Sequence[Tuple[Tuple[Any, ...], Mapping[str, Any]]]): A sequence</span>
<span class="sd">            of input groups to be used to export the model. Each input group is a pair of</span>
<span class="sd">            (args, kwargs).</span>
<span class="sd">        export_options (_experimental.ExportOptions, optional): An _experimental.ExportOptions</span>
<span class="sd">            object that controls the export behavior.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: A string containing the diff of the exported models.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">export_options</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">_experimental</span><span class="o">.</span><span class="n">ExportOptions</span><span class="p">()</span> <span class="k">if</span> <span class="n">export_options</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">export_options</span>
    <span class="p">)</span>

    <span class="n">jit_diff_report</span> <span class="o">=</span> <span class="n">_check_graph_diff</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">test_input_groups</span><span class="p">,</span> <span class="n">export_options</span><span class="p">,</span> <span class="n">_traced_graph_from_model</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">jit_diff_report</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jit_diff_report</span>

    <span class="k">return</span> <span class="n">_check_graph_diff</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">test_input_groups</span><span class="p">,</span> <span class="n">export_options</span><span class="p">,</span> <span class="n">_onnx_graph_from_model</span>
    <span class="p">)</span>


<span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
<span class="k">def</span> <span class="nf">verify</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">_ModelType</span><span class="p">,</span>
    <span class="n">input_args</span><span class="p">:</span> <span class="n">_InputArgsType</span><span class="p">,</span>
    <span class="n">input_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_InputKwargsType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">do_constant_folding</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">dynamic_axes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
        <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]]</span>
    <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">input_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">training</span><span class="p">:</span> <span class="n">_C_onnx</span><span class="o">.</span><span class="n">TrainingMode</span> <span class="o">=</span> <span class="n">_C_onnx</span><span class="o">.</span><span class="n">TrainingMode</span><span class="o">.</span><span class="n">EVAL</span><span class="p">,</span>
    <span class="n">opset_version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">keep_initializers_as_inputs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">fixed_batch_size</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">use_external_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">additional_test_inputs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">_InputArgsType</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">VerificationOptions</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Verify model export to ONNX against original PyTorch model.</span>

<span class="sd">    Args:</span>
<span class="sd">        model (torch.nn.Module or torch.jit.ScriptModule): See :func:`torch.onnx.export`.</span>
<span class="sd">        input_args (tuple): See :func:`torch.onnx.export`.</span>
<span class="sd">        input_kwargs (dict): See :func:`torch.onnx.export`.</span>
<span class="sd">        do_constant_folding (bool, optional): See :func:`torch.onnx.export`.</span>
<span class="sd">        dynamic_axes (dict, optional): See :func:`torch.onnx.export`.</span>
<span class="sd">        input_names (list, optional): See :func:`torch.onnx.export`.</span>
<span class="sd">        output_names (list, optional): See :func:`torch.onnx.export`.</span>
<span class="sd">        training (torch.onnx.TrainingMode): See :func:`torch.onnx.export`.</span>
<span class="sd">        opset_version (int, optional): See :func:`torch.onnx.export`.</span>
<span class="sd">        keep_initializers_as_inputs (bool, optional): See :func:`torch.onnx.export`.</span>
<span class="sd">        verbose (bool, optional): See :func:`torch.onnx.export`.</span>
<span class="sd">        fixed_batch_size (bool, optional): Legacy argument, used only by rnn test cases.</span>
<span class="sd">        use_external_data (bool, optional): Explicitly specify whether to export the</span>
<span class="sd">            model with external data.</span>
<span class="sd">        additional_test_inputs (list, optional): List of tuples. Each tuple is a group of</span>
<span class="sd">            input arguments to test. Currently only *args are supported.</span>
<span class="sd">        options (_VerificationOptions, optional): A _VerificationOptions object that</span>
<span class="sd">            controls the verification behavior.</span>

<span class="sd">    Raises:</span>
<span class="sd">        AssertionError: if outputs from ONNX model and PyTorch model are not</span>
<span class="sd">            equal up to specified precision.</span>
<span class="sd">        ValueError: if arguments provided are invalid.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">options</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">VerificationOptions</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">training</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">onnx</span><span class="o">.</span><span class="n">TrainingMode</span><span class="o">.</span><span class="n">TRAINING</span><span class="p">:</span>
        <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">training</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">onnx</span><span class="o">.</span><span class="n">TrainingMode</span><span class="o">.</span><span class="n">EVAL</span><span class="p">:</span>
        <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">(),</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">ExitStack</span><span class="p">()</span> <span class="k">as</span> <span class="n">stack</span><span class="p">:</span>
        <span class="n">model_f</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">]</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">use_external_data</span><span class="p">:</span>
            <span class="n">tmpdir_path</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">())</span>
            <span class="n">model_f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdir_path</span><span class="p">,</span> <span class="s2">&quot;model.onnx&quot;</span><span class="p">)</span>

        <span class="n">inputs_for_export</span> <span class="o">=</span> <span class="n">_prepare_input_for_export</span><span class="p">(</span><span class="n">input_args</span><span class="p">,</span> <span class="n">input_kwargs</span><span class="p">)</span>

        <span class="c1"># TODO(#77679): remove this and treat mutating model separately.</span>
        <span class="n">model_copy</span> <span class="o">=</span> <span class="n">_try_clone_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">_export</span><span class="p">(</span>
            <span class="n">model</span><span class="p">,</span>
            <span class="n">inputs_for_export</span><span class="p">,</span>
            <span class="n">model_f</span><span class="p">,</span>
            <span class="n">opset_version</span><span class="o">=</span><span class="n">opset_version</span><span class="p">,</span>
            <span class="n">do_constant_folding</span><span class="o">=</span><span class="n">do_constant_folding</span><span class="p">,</span>
            <span class="n">keep_initializers_as_inputs</span><span class="o">=</span><span class="n">keep_initializers_as_inputs</span><span class="p">,</span>
            <span class="n">dynamic_axes</span><span class="o">=</span><span class="n">dynamic_axes</span><span class="p">,</span>
            <span class="n">input_names</span><span class="o">=</span><span class="n">input_names</span><span class="p">,</span>
            <span class="n">output_names</span><span class="o">=</span><span class="n">output_names</span><span class="p">,</span>
            <span class="n">fixed_batch_size</span><span class="o">=</span><span class="n">fixed_batch_size</span><span class="p">,</span>
            <span class="n">training</span><span class="o">=</span><span class="n">training</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">_compare_onnx_pytorch_model</span><span class="p">(</span>
            <span class="n">pt_model</span><span class="o">=</span><span class="n">model_copy</span><span class="p">,</span>
            <span class="n">onnx_model_f</span><span class="o">=</span><span class="n">model_f</span><span class="p">,</span>
            <span class="n">input_args</span><span class="o">=</span><span class="n">input_args</span><span class="p">,</span>
            <span class="n">input_kwargs</span><span class="o">=</span><span class="n">input_kwargs</span><span class="p">,</span>
            <span class="n">additional_test_inputs</span><span class="o">=</span><span class="n">additional_test_inputs</span><span class="p">,</span>
            <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
        <span class="p">)</span>


<span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
<span class="k">def</span> <span class="nf">verify_aten_graph</span><span class="p">(</span>
    <span class="n">graph</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Graph</span><span class="p">,</span>
    <span class="n">input_args</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
    <span class="n">export_options</span><span class="p">:</span> <span class="n">_experimental</span><span class="o">.</span><span class="n">ExportOptions</span><span class="p">,</span>
    <span class="n">params_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">verification_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">VerificationOptions</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="ne">AssertionError</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Graph</span><span class="p">,</span> <span class="n">_OutputsType</span><span class="p">,</span> <span class="n">_OutputsType</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">verification_options</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">verification_options</span> <span class="o">=</span> <span class="n">VerificationOptions</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">params_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">params_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">original_jit_graph</span> <span class="o">=</span> <span class="n">graph</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Execute aten graph and get reference torch jit outputs.</span>
    <span class="n">graph_inputs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">inputs</span><span class="p">())</span>
    <span class="n">jit_inputs</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">arg</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">input_args</span> <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">])</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">params_dict</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">debugName</span><span class="p">()]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">graph_inputs</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">jit_inputs</span><span class="p">)</span> <span class="p">:]]</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">w</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">weights</span><span class="p">])</span>
    <span class="c1"># TODO: Only copy the argument if mutation is detected in Graph.</span>
    <span class="n">jit_inputs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">jit_inputs</span><span class="p">)</span>
    <span class="n">jit_input_and_parameters</span> <span class="o">=</span> <span class="n">jit_inputs</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
    <span class="n">jit_outs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">_jit_interpret_graph</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">jit_input_and_parameters</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">jit_outs</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">jit_outs</span> <span class="o">=</span> <span class="p">[</span><span class="n">jit_outs</span><span class="p">]</span>

    <span class="c1"># Convert aten graph to onnx graph.</span>
    <span class="n">graph</span><span class="p">,</span> <span class="n">onnx_params_dict</span> <span class="o">=</span> <span class="n">_onnx_graph_from_aten_graph</span><span class="p">(</span>
        <span class="n">graph</span><span class="p">,</span> <span class="n">export_options</span><span class="p">,</span> <span class="n">params_dict</span>
    <span class="p">)</span>

    <span class="n">proto</span><span class="p">,</span> <span class="n">export_map</span> <span class="o">=</span> <span class="n">_onnx_proto_from_onnx_graph</span><span class="p">(</span>
        <span class="n">graph</span><span class="p">,</span> <span class="n">export_options</span><span class="p">,</span> <span class="n">onnx_params_dict</span>
    <span class="p">)</span>
    <span class="n">model_f</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">]</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
    <span class="n">export_type</span> <span class="o">=</span> <span class="n">_exporter_states</span><span class="o">.</span><span class="n">ExportTypes</span><span class="o">.</span><span class="n">PROTOBUF_FILE</span>
    <span class="n">onnx_proto_utils</span><span class="o">.</span><span class="n">_export_file</span><span class="p">(</span><span class="n">proto</span><span class="p">,</span> <span class="n">model_f</span><span class="p">,</span> <span class="n">export_type</span><span class="p">,</span> <span class="n">export_map</span><span class="p">)</span>

    <span class="c1"># NOTE: Verification is unstable. Try catch to emit information for debugging.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># NOTE: Input might be dce&#39;ed, so we need to remove those from the input args.</span>
        <span class="n">new_input_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="o">.</span><span class="n">debugName</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">inputs</span><span class="p">()}</span>
        <span class="n">new_input_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">original_jit_graph</span><span class="o">.</span><span class="n">inputs</span><span class="p">(),</span> <span class="n">input_args</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">debugName</span><span class="p">()</span> <span class="ow">in</span> <span class="n">new_input_names</span><span class="p">:</span>
                <span class="n">new_input_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
        <span class="n">input_args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">new_input_args</span><span class="p">)</span>

        <span class="n">onnx_inputs</span> <span class="o">=</span> <span class="n">_prepare_input_for_onnx</span><span class="p">(</span>
            <span class="n">input_args</span><span class="p">,</span>
            <span class="p">{},</span>
            <span class="n">verification_options</span><span class="o">.</span><span class="n">remained_onnx_input_idx</span><span class="p">,</span>
            <span class="n">verification_options</span><span class="o">.</span><span class="n">flatten</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">onnx_session</span> <span class="o">=</span> <span class="n">_onnx_backend_session</span><span class="p">(</span><span class="n">model_f</span><span class="p">,</span> <span class="n">verification_options</span><span class="o">.</span><span class="n">backend</span><span class="p">)</span>
        <span class="n">onnx_outs</span> <span class="o">=</span> <span class="n">_run_onnx</span><span class="p">(</span><span class="n">onnx_session</span><span class="p">,</span> <span class="n">onnx_inputs</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">onnx_session</span>  <span class="c1"># To free device memory</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">_compare_onnx_pytorch_outputs</span><span class="p">(</span>
                <span class="n">onnx_outs</span><span class="o">=</span><span class="n">onnx_outs</span><span class="p">,</span>
                <span class="n">pt_outs</span><span class="o">=</span><span class="n">jit_outs</span><span class="p">,</span>
                <span class="n">options</span><span class="o">=</span><span class="n">verification_options</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">e</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">jit_outs</span><span class="p">,</span> <span class="n">onnx_outs</span>

        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">jit_outs</span><span class="p">,</span> <span class="n">onnx_outs</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unexpected error during verification.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;jit graph: &quot;</span><span class="p">,</span> <span class="n">original_jit_graph</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;onnx graph: &quot;</span><span class="p">,</span> <span class="n">graph</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">e</span>


<span class="k">class</span> <span class="nc">GraphInfoPrettyPrinter</span><span class="p">:</span>
    <span class="n">graph_info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GraphInfo</span><span class="p">]</span>
    <span class="n">upper_printer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GraphInfoPrettyPrinter</span><span class="p">]</span>
    <span class="n">lower_printer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GraphInfoPrettyPrinter</span><span class="p">]</span>

    <span class="n">graph_str_lambdas</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
    <span class="n">connector_str_lambdas</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
    <span class="n">children_str_lambdas</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GraphInfo</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph_info</span> <span class="o">=</span> <span class="n">graph_info</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">graph_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">graph_info</span><span class="o">.</span><span class="n">upper_graph_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">graph_info</span><span class="o">.</span><span class="n">lower_graph_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">upper_printer</span> <span class="o">=</span> <span class="n">GraphInfoPrettyPrinter</span><span class="p">(</span><span class="n">graph_info</span><span class="o">.</span><span class="n">upper_graph_info</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lower_printer</span> <span class="o">=</span> <span class="n">GraphInfoPrettyPrinter</span><span class="p">(</span><span class="n">graph_info</span><span class="o">.</span><span class="n">lower_graph_info</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">upper_printer</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lower_printer</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
    <span class="k">def</span> <span class="nf">_total_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper_printer</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_printer</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">upper_printer</span><span class="o">.</span><span class="n">_total_rows</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_printer</span><span class="o">.</span><span class="n">_total_rows</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="mi">2</span>  <span class="c1"># Two lines: node count + id.</span>

    <span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
    <span class="k">def</span> <span class="nf">_node_count_segment_str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;...&quot;</span>
        <span class="n">node_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_info</span><span class="o">.</span><span class="n">essential_node_count</span><span class="p">()</span>
        <span class="n">has_mismatch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_info</span><span class="o">.</span><span class="n">has_mismatch</span><span class="p">()</span>
        <span class="n">error_node_kind</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_info</span><span class="o">.</span><span class="n">essential_node_kinds</span><span class="p">()</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="k">if</span> <span class="n">node_count</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">has_mismatch</span>
            <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node_count</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;X&#39;</span> <span class="k">if</span> <span class="n">has_mismatch</span> <span class="k">else</span> <span class="s1">&#39;âœ“&#39;</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">error_node_kind</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
    <span class="k">def</span> <span class="nf">_graph_id_segment_str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;id: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_info</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
    <span class="k">def</span> <span class="nf">_max_segment_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_node_count_segment_str</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_id_segment_str</span><span class="p">()))</span>
        <span class="p">)</span>

    <span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
    <span class="k">def</span> <span class="nf">_graph_segment_str_at_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the string representation of the graph segment at the given line.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">result_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_node_count_segment_str</span><span class="p">()</span>
            <span class="n">result_str</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_segment_columns</span><span class="p">()</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_str</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">result_str</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">result_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_id_segment_str</span><span class="p">()</span>
            <span class="n">result_str</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_segment_columns</span><span class="p">()</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_str</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">result_str</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">line</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_total_rows</span><span class="p">():</span>
            <span class="k">return</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_segment_columns</span><span class="p">()</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
    <span class="k">def</span> <span class="nf">_connector_segment_str_at_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the connector segment string at the given line.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper_printer</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_printer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="n">upper_total_rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper_printer</span><span class="o">.</span><span class="n">_total_rows</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper_printer</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="n">lower_total_rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_printer</span><span class="o">.</span><span class="n">_total_rows</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_printer</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;  __&quot;</span>
        <span class="k">elif</span> <span class="n">line</span> <span class="o">&lt;</span> <span class="n">upper_total_rows</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot; |  &quot;</span>
        <span class="k">elif</span> <span class="n">line</span> <span class="o">==</span> <span class="n">upper_total_rows</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot; |__&quot;</span>
        <span class="k">elif</span> <span class="n">line</span> <span class="o">&lt;</span> <span class="n">upper_total_rows</span> <span class="o">+</span> <span class="n">lower_total_rows</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;    &quot;</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
    <span class="k">def</span> <span class="nf">_children_str_at_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the string representation of the children at the given line.</span>

<span class="sd">        Recursively calls `_str_at_line` on children nodes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper_printer</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_printer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="n">upper_total_rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper_printer</span><span class="o">.</span><span class="n">_total_rows</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper_printer</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="n">lower_total_rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_printer</span><span class="o">.</span><span class="n">_total_rows</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_printer</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">line</span> <span class="o">&lt;</span> <span class="n">upper_total_rows</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">upper_printer</span><span class="o">.</span><span class="n">_str_at_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper_printer</span> <span class="k">else</span> <span class="s2">&quot;...&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">upper_total_rows</span> <span class="o">&lt;</span> <span class="n">line</span> <span class="o">&lt;</span> <span class="n">upper_total_rows</span> <span class="o">+</span> <span class="n">lower_total_rows</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lower_printer</span><span class="o">.</span><span class="n">_str_at_line</span><span class="p">(</span><span class="n">line</span> <span class="o">-</span> <span class="n">upper_total_rows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_printer</span>
                <span class="k">else</span> <span class="s2">&quot;...&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
    <span class="k">def</span> <span class="nf">_str_at_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the string representation of the graph at the given line.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_graph_segment_str_at_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connector_segment_str_at_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_children_str_at_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">pretty_print</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># Print tree.</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Tree: &quot;</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">))</span>
        <span class="n">total_rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_total_rows</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">total_rows</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_str_at_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_info</span><span class="o">.</span><span class="n">has_mismatch</span><span class="p">():</span>
            <span class="c1"># Summarize leaf subgraphs with mismatch.</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Mismatch leaf subgraphs: &quot;</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">graph_info</span><span class="o">.</span><span class="n">id</span>
                    <span class="k">for</span> <span class="n">graph_info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_info</span><span class="o">.</span><span class="n">all_mismatch_leaf_graph_info</span><span class="p">()</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="c1"># Summarize node kinds with mismatch.</span>
            <span class="n">mismatch_node_kinds</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">graph_info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_info</span><span class="o">.</span><span class="n">all_mismatch_leaf_graph_info</span><span class="p">():</span>
                <span class="n">node_kinds</span> <span class="o">=</span> <span class="n">graph_info</span><span class="o">.</span><span class="n">essential_node_kinds</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">node_kinds</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">node_kind</span> <span class="o">=</span> <span class="n">node_kinds</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                    <span class="n">mismatch_node_kinds</span><span class="p">[</span><span class="n">node_kind</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">mismatch_node_kinds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node_kind</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Mismatch node kinds: &quot;</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">mismatch_node_kinds</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; No mismatch found. &quot;</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">OnnxTestCaseRepro</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repro_dir</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repro_dir</span> <span class="o">=</span> <span class="n">repro_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="n">onnx_proto_utils</span><span class="o">.</span><span class="n">load_test_case</span><span class="p">(</span>
            <span class="n">repro_dir</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
    <span class="k">def</span> <span class="nf">create_test_case_repro</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">proto</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="nb">dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a repro under &quot;{dir}/test_{name}&quot; for an ONNX test case.</span>

<span class="sd">        The test case contains the model and the inputs/outputs data. The directory</span>
<span class="sd">        structure is as follows:</span>

<span class="sd">        dir</span>
<span class="sd">        â”œâ”€â”€ test_&lt;name&gt;</span>
<span class="sd">        â”‚   â”œâ”€â”€ model.onnx</span>
<span class="sd">        â”‚   â””â”€â”€ test_data_set_0</span>
<span class="sd">        â”‚       â”œâ”€â”€ input_0.pb</span>
<span class="sd">        â”‚       â”œâ”€â”€ input_1.pb</span>
<span class="sd">        â”‚       â”œâ”€â”€ output_0.pb</span>
<span class="sd">        â”‚       â””â”€â”€ output_1.pb</span>

<span class="sd">        Args:</span>
<span class="sd">            proto: ONNX model proto.</span>
<span class="sd">            inputs: Inputs to the model.</span>
<span class="sd">            outputs: Outputs of the model.</span>
<span class="sd">            dir: Directory to save the repro.</span>
<span class="sd">            name: Name of the test case. If not specified, a name based on current time</span>
<span class="sd">                will be generated.</span>
<span class="sd">        Returns:</span>
<span class="sd">            Path to the repro.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y_%m_</span><span class="si">%d</span><span class="s2">_%H_%M_%S_</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">onnx_proto_utils</span><span class="o">.</span><span class="n">export_as_test_case</span><span class="p">(</span>
            <span class="n">proto</span><span class="p">,</span>
            <span class="n">_to_numpy</span><span class="p">(</span><span class="n">inputs</span><span class="p">),</span>
            <span class="n">_to_numpy</span><span class="p">(</span><span class="n">outputs</span><span class="p">),</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="nb">dir</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">:</span> <span class="n">VerificationOptions</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the ONNX test case with options.backend, and compare with the expected outputs.</span>

<span class="sd">        Args:</span>
<span class="sd">            options: Options for validation.</span>

<span class="sd">        Raise:</span>
<span class="sd">            AssertionError: if outputs from options.backend and expected outputs are not</span>
<span class="sd">                equal up to specified precision.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">onnx_session</span> <span class="o">=</span> <span class="n">_onnx_backend_session</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">),</span> <span class="n">options</span><span class="o">.</span><span class="n">backend</span><span class="p">)</span>
        <span class="n">run_outputs</span> <span class="o">=</span> <span class="n">onnx_session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">onnx_session</span><span class="p">,</span> <span class="s2">&quot;get_outputs&quot;</span><span class="p">):</span>
            <span class="n">output_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">onnx_session</span><span class="o">.</span><span class="n">get_outputs</span><span class="p">()]</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">onnx_session</span><span class="p">,</span> <span class="s2">&quot;output_names&quot;</span><span class="p">):</span>
            <span class="n">output_names</span> <span class="o">=</span> <span class="n">onnx_session</span><span class="o">.</span><span class="n">output_names</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown onnx session type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">onnx_session</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">expected_outs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">output_names</span><span class="p">]</span>
        <span class="n">_compare_onnx_pytorch_outputs_in_np</span><span class="p">(</span><span class="n">run_outputs</span><span class="p">,</span> <span class="n">expected_outs</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>


<div class="viewcode-block" id="GraphInfo"><a class="viewcode-back" href="../../../generated/torch.onnx.verification.GraphInfo.html#torch.onnx.verification.GraphInfo">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">GraphInfo</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;GraphInfo contains validation information of a TorchScript graph and its converted ONNX graph.&quot;&quot;&quot;</span>

    <span class="n">graph</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Graph</span>
    <span class="n">input_args</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
    <span class="n">params_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="n">export_options</span><span class="p">:</span> <span class="n">_experimental</span><span class="o">.</span><span class="n">ExportOptions</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="n">_experimental</span><span class="o">.</span><span class="n">ExportOptions</span>
    <span class="p">)</span>
    <span class="n">mismatch_error</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="ne">AssertionError</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="n">pt_outs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">_NumericType</span><span class="p">]]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="n">upper_graph_info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GraphInfo</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">lower_graph_info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GraphInfo</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">_onnx_graph</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Graph</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="n">_EXCLUDED_NODE_KINDS</span><span class="p">:</span> <span class="n">FrozenSet</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;prim::Constant&quot;</span><span class="p">,</span> <span class="s2">&quot;prim::ListConstruct&quot;</span><span class="p">,</span> <span class="s2">&quot;aten::ScalarImplicit&quot;</span><span class="p">}</span>
    <span class="p">)</span>

<div class="viewcode-block" id="GraphInfo.clear"><a class="viewcode-back" href="../../../generated/torch.onnx.verification.GraphInfo.html#torch.onnx.verification.GraphInfo.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clear states and results of previous verification.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mismatch_error</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pt_outs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_onnx_graph</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">upper_graph_info</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lower_graph_info</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="GraphInfo.pretty_print_tree"><a class="viewcode-back" href="../../../generated/torch.onnx.verification.GraphInfo.html#torch.onnx.verification.GraphInfo.pretty_print_tree">[docs]</a>    <span class="k">def</span> <span class="nf">pretty_print_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pretty print `GraphInfo` tree.</span>

<span class="sd">        Each node represents a subgraph, showing the number of nodes in the subgraph and</span>
<span class="sd">        a check mark if the subgraph has output mismatch between torch and ONNX.</span>

<span class="sd">        The id of the subgraph is shown under the node. The `GraphInfo` object for any</span>
<span class="sd">        subgraph can be retrieved by calling `graph_info.find_partition(id)`.</span>

<span class="sd">        Example::</span>

<span class="sd">            ==================================== Tree: =====================================</span>
<span class="sd">            5 X   __2 X    __1 âœ“</span>
<span class="sd">            id:  |  id: 0 |  id: 00</span>
<span class="sd">                 |        |</span>
<span class="sd">                 |        |__1 X (aten::relu)</span>
<span class="sd">                 |           id: 01</span>
<span class="sd">                 |</span>
<span class="sd">                 |__3 X    __1 âœ“</span>
<span class="sd">                    id: 1 |  id: 10</span>
<span class="sd">                          |</span>
<span class="sd">                          |__2 X     __1 X (aten::relu)</span>
<span class="sd">                             id: 11 |  id: 110</span>
<span class="sd">                                    |</span>
<span class="sd">                                    |__1 âœ“</span>
<span class="sd">                                       id: 111</span>
<span class="sd">            =========================== Mismatch leaf subgraphs: ===========================</span>
<span class="sd">            [&#39;01&#39;, &#39;110&#39;]</span>
<span class="sd">            ============================= Mismatch node kinds: =============================</span>
<span class="sd">            {&#39;aten::relu&#39;: 2}</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">GraphInfoPrettyPrinter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">pretty_print</span><span class="p">()</span></div>

<div class="viewcode-block" id="GraphInfo.pretty_print_mismatch"><a class="viewcode-back" href="../../../generated/torch.onnx.verification.GraphInfo.html#torch.onnx.verification.GraphInfo.pretty_print_mismatch">[docs]</a>    <span class="k">def</span> <span class="nf">pretty_print_mismatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pretty print details of the mismatch between torch and ONNX.</span>

<span class="sd">        Args:</span>
<span class="sd">            graph: If True, print the ATen JIT graph and ONNX graph.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Mismatch info for graph partition </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">: &quot;</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">graph</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; ATen JIT graph &quot;</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">))</span>
            <span class="c1"># TODO: A more compact graph printer.</span>
            <span class="c1">#   * Drop stride, grad, device information.</span>
            <span class="c1">#   * Show source location on a separate line.</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_onnx_graph</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; ONNX graph &quot;</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_onnx_graph</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_mismatch</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Mismatch error &quot;</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mismatch_error</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; No mismatch &quot;</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="GraphInfo.has_mismatch"><a class="viewcode-back" href="../../../generated/torch.onnx.verification.GraphInfo.html#torch.onnx.verification.GraphInfo.has_mismatch">[docs]</a>    <span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
    <span class="k">def</span> <span class="nf">has_mismatch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return True if the subgraph has output mismatch between torch and ONNX.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mismatch_error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="GraphInfo.essential_node_count"><a class="viewcode-back" href="../../../generated/torch.onnx.verification.GraphInfo.html#torch.onnx.verification.GraphInfo.essential_node_count">[docs]</a>    <span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
    <span class="k">def</span> <span class="nf">essential_node_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return the number of nodes in the subgraph excluding those in `_EXCLUDED_NODE_KINDS`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="mi">1</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">()</span> <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">kind</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EXCLUDED_NODE_KINDS</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="GraphInfo.essential_node_kinds"><a class="viewcode-back" href="../../../generated/torch.onnx.verification.GraphInfo.html#torch.onnx.verification.GraphInfo.essential_node_kinds">[docs]</a>    <span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
    <span class="k">def</span> <span class="nf">essential_node_kinds</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return the set of node kinds in the subgraph excluding those in `_EXCLUDED_NODE_KINDS`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">n</span><span class="o">.</span><span class="n">kind</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">kind</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EXCLUDED_NODE_KINDS</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="GraphInfo.all_mismatch_leaf_graph_info"><a class="viewcode-back" href="../../../generated/torch.onnx.verification.GraphInfo.html#torch.onnx.verification.GraphInfo.all_mismatch_leaf_graph_info">[docs]</a>    <span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
    <span class="k">def</span> <span class="nf">all_mismatch_leaf_graph_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;GraphInfo&quot;</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return a list of all leaf `GraphInfo` objects that have mismatch.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_mismatch</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">no_mismatch_children</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">upper_graph_info</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper_graph_info</span><span class="o">.</span><span class="n">has_mismatch</span><span class="p">()</span>
        <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lower_graph_info</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_graph_info</span><span class="o">.</span><span class="n">has_mismatch</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">no_mismatch_children</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="p">]</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper_graph_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper_graph_info</span><span class="o">.</span><span class="n">all_mismatch_leaf_graph_info</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_graph_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_graph_info</span><span class="o">.</span><span class="n">all_mismatch_leaf_graph_info</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="GraphInfo.find_partition"><a class="viewcode-back" href="../../../generated/torch.onnx.verification.GraphInfo.html#torch.onnx.verification.GraphInfo.find_partition">[docs]</a>    <span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
    <span class="k">def</span> <span class="nf">find_partition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;GraphInfo&quot;</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Find the `GraphInfo` object with the given id.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="n">current_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">current_length</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">id</span><span class="p">[</span><span class="n">current_length</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper_graph_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper_graph_info</span><span class="o">.</span><span class="n">find_partition</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">id</span><span class="p">[</span><span class="n">current_length</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_graph_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_graph_info</span><span class="o">.</span><span class="n">find_partition</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="GraphInfo.export_repro"><a class="viewcode-back" href="../../../generated/torch.onnx.verification.GraphInfo.html#torch.onnx.verification.GraphInfo.export_repro">[docs]</a>    <span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
    <span class="k">def</span> <span class="nf">export_repro</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">repro_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Export the subgraph to ONNX along with the input/output data for repro.</span>

<span class="sd">        The repro directory will contain the following files::</span>

<span class="sd">            dir</span>
<span class="sd">            â”œâ”€â”€ test_&lt;name&gt;</span>
<span class="sd">            â”‚   â”œâ”€â”€ model.onnx</span>
<span class="sd">            â”‚   â””â”€â”€ test_data_set_0</span>
<span class="sd">            â”‚       â”œâ”€â”€ input_0.pb</span>
<span class="sd">            â”‚       â”œâ”€â”€ input_1.pb</span>
<span class="sd">            â”‚       â”œâ”€â”€ output_0.pb</span>
<span class="sd">            â”‚       â””â”€â”€ output_1.pb</span>

<span class="sd">        Args:</span>
<span class="sd">            repro_dir: The directory to export the repro files to. Defaults to current</span>
<span class="sd">                working directory if None.</span>
<span class="sd">            name: An optional name for the test case folder: &quot;test_{name}&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The path to the exported repro directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">repro_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">repro_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">repro_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">repro_dir</span><span class="p">,</span> <span class="s2">&quot;onnx_debug&quot;</span><span class="p">)</span>

        <span class="n">onnx_graph</span><span class="p">,</span> <span class="n">onnx_params_dict</span> <span class="o">=</span> <span class="n">_onnx_graph_from_aten_graph</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">export_options</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_dict</span>
        <span class="p">)</span>

        <span class="n">proto</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_onnx_proto_from_onnx_graph</span><span class="p">(</span>
            <span class="n">onnx_graph</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">export_options</span><span class="p">,</span> <span class="n">onnx_params_dict</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">OnnxTestCaseRepro</span><span class="o">.</span><span class="n">create_test_case_repro</span><span class="p">(</span>
            <span class="n">proto</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pt_outs</span><span class="p">,</span> <span class="n">repro_dir</span><span class="p">,</span> <span class="n">name</span>
        <span class="p">)</span></div>

    <span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
    <span class="k">def</span> <span class="nf">_graph_partition_pivot</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Find the pivot index to partition the graph.</span>

<span class="sd">        The pivot is the node that splits the graph into two parts. Each part should</span>
<span class="sd">        have the similar amount of nodes, excluding non essential ops, defined in</span>
<span class="sd">        `_EXCLUDED_NODE_KINDS`, such as `prim::Constant`.</span>
<span class="sd">        If the graph has an odd number of nodes, the upper part will have one more node.</span>
<span class="sd">        If the graph does not have any node that can be partitioned, return -1.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The index of the pivot node.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">included_node_indices</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">i</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">kind</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EXCLUDED_NODE_KINDS</span>
        <span class="p">]</span>
        <span class="n">half_idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">included_node_indices</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">half_idx</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">included_node_indices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">half_idx</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">included_node_indices</span><span class="p">[</span><span class="n">half_idx</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

    <span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
    <span class="k">def</span> <span class="nf">_partition_upper_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Graph</span><span class="p">:</span>
        <span class="n">pivot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_partition_pivot</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">pivot</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># Copy to not mutate parent graph.</span>
        <span class="n">original_outputs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">outputs</span><span class="p">())</span>

        <span class="k">def</span> <span class="nf">_process_bridge_value_for_upper</span><span class="p">(</span>
            <span class="n">new_outputs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Value</span><span class="p">],</span> <span class="n">bridge_value</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Value</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Value</span><span class="p">:</span>
            <span class="c1"># Add bridge values as upper graph outputs.</span>
            <span class="n">new_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bridge_value</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">bridge_value</span>

        <span class="n">new_outputs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Value</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">process_bridge_value_for_upper</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
            <span class="n">_process_bridge_value_for_upper</span><span class="p">,</span> <span class="n">new_outputs</span>
        <span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">dropped_nodes</span><span class="p">,</span> <span class="n">complete_upper_nodes_set</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_partition_nodes</span><span class="p">(</span>
            <span class="n">graph</span><span class="p">,</span> <span class="n">pivot</span><span class="p">,</span> <span class="n">process_bridge_value_for_upper</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">original_outputs</span><span class="p">):</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">eraseOutput</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">new_outputs</span><span class="p">:</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">registerOutput</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">dropped_nodes</span><span class="p">):</span>
            <span class="n">node</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="nb">input</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">inputs</span><span class="p">())))):</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="n">_has_uses_by_nodes</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">complete_upper_nodes_set</span><span class="p">)</span>
                <span class="ow">and</span> <span class="nb">input</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_outputs</span>
            <span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">graph</span><span class="o">.</span><span class="n">eraseInput</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">graph</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">e</span>

        <span class="k">return</span> <span class="n">graph</span>

    <span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
    <span class="k">def</span> <span class="nf">_partition_lower_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Graph</span><span class="p">:</span>
        <span class="n">pivot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_partition_pivot</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">pivot</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># Copy to not mutate parent graph.</span>
        <span class="n">original_outputs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">outputs</span><span class="p">())</span>
        <span class="n">original_inputs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">inputs</span><span class="p">())</span>

        <span class="n">new_outputs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">_process_bridge_value_for_lower</span><span class="p">(</span>
            <span class="n">graph</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Graph</span><span class="p">,</span> <span class="n">bridge_value</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Value</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Value</span><span class="p">:</span>
            <span class="c1"># Add bridge values as lower graph inputs.</span>
            <span class="n">new_input</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">addInput</span><span class="p">()</span>
            <span class="n">bridge_value</span><span class="o">.</span><span class="n">replaceAllUsesWith</span><span class="p">(</span><span class="n">new_input</span><span class="p">)</span>
            <span class="n">new_input</span><span class="o">.</span><span class="n">copyMetadata</span><span class="p">(</span><span class="n">bridge_value</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">new_input</span>

        <span class="n">process_bridge_value_for_lower</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
            <span class="n">_process_bridge_value_for_lower</span><span class="p">,</span> <span class="n">graph</span>
        <span class="p">)</span>

        <span class="n">upper_nodes</span><span class="p">,</span> <span class="n">lower_nodes</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">complete_lower_nodes_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_partition_nodes</span><span class="p">(</span>
            <span class="n">graph</span><span class="p">,</span> <span class="n">pivot</span><span class="p">,</span> <span class="n">process_bridge_value_for_lower</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">original_outputs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_produced_by</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">lower_nodes</span><span class="p">):</span>
                <span class="n">new_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">original_outputs</span><span class="p">):</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">eraseOutput</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">new_outputs</span><span class="p">:</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">registerOutput</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

        <span class="k">for</span> <span class="nb">input</span> <span class="ow">in</span> <span class="n">original_inputs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_has_uses_by_nodes</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">complete_lower_nodes_set</span><span class="p">):</span>
                <span class="n">new_input</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">addInput</span><span class="p">()</span>
                <span class="nb">input</span><span class="o">.</span><span class="n">replaceAllUsesWith</span><span class="p">(</span><span class="n">new_input</span><span class="p">)</span>
                <span class="n">new_input</span><span class="o">.</span><span class="n">copyMetadata</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">upper_nodes</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">complete_lower_nodes_set</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">graph</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">e</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">original_inputs</span><span class="p">:</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">eraseInput</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">graph</span>

    <span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
    <span class="k">def</span> <span class="nf">_partition_node</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">node</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span>
        <span class="n">complete_upper_nodes_set</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Node</span><span class="p">],</span>
        <span class="n">complete_lower_nodes_set</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Node</span><span class="p">],</span>
        <span class="n">original_graph_outputs</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Value</span><span class="p">],</span>
        <span class="n">covered_bridge_values</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Value</span><span class="p">],</span>
        <span class="n">process_bridge_value</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">torch</span><span class="o">.</span><span class="n">Value</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Value</span><span class="p">],</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">complete_lower_nodes_set</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">_node_has_uses_by</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">complete_lower_nodes_set</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">kind</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EXCLUDED_NODE_KINDS</span>
        <span class="p">):</span>
            <span class="n">complete_lower_nodes_set</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_all_nodes</span><span class="p">([</span><span class="n">node</span><span class="p">]))</span>
            <span class="k">for</span> <span class="nb">input</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">inputs</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">input</span> <span class="ow">in</span> <span class="n">covered_bridge_values</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_partition_node</span><span class="p">(</span>
                    <span class="nb">input</span><span class="o">.</span><span class="n">node</span><span class="p">(),</span>
                    <span class="n">complete_upper_nodes_set</span><span class="p">,</span>
                    <span class="n">complete_lower_nodes_set</span><span class="p">,</span>
                    <span class="n">original_graph_outputs</span><span class="p">,</span>
                    <span class="n">covered_bridge_values</span><span class="p">,</span>
                    <span class="n">process_bridge_value</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">outputs</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">covered_bridge_values</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">_has_uses_by_nodes</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">complete_lower_nodes_set</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">original_graph_outputs</span>
                <span class="p">):</span>
                    <span class="n">covered_bridge_values</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">process_bridge_value</span><span class="p">(</span><span class="n">output</span><span class="p">))</span>

    <span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
    <span class="k">def</span> <span class="nf">_partition_nodes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">graph</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Graph</span><span class="p">,</span>
        <span class="n">pivot</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">process_bridge_value</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">torch</span><span class="o">.</span><span class="n">Value</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Value</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Node</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Node</span><span class="p">],</span> <span class="n">Set</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Node</span><span class="p">],</span> <span class="n">Set</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Node</span><span class="p">]]:</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">())</span>
        <span class="n">upper_nodes</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[:</span><span class="n">pivot</span><span class="p">]</span>
        <span class="n">lower_nodes</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="n">pivot</span><span class="p">:]</span>
        <span class="c1"># `upper_nodes` and `complete_upper_nodes_set` differs in that the latter</span>
        <span class="c1"># recursively contains nodes in subblock of `upper_nodes`.</span>
        <span class="c1"># The same applies for `lower_nodes` and `complete_lower_nodes_set`.</span>
        <span class="c1"># With addition that `complete_lower_nodes_set` will include nodes that</span>
        <span class="c1"># are determined to be copied from `upper_nodes` to `lower_nodes`.</span>
        <span class="n">complete_upper_nodes_set</span> <span class="o">=</span> <span class="n">_all_nodes</span><span class="p">(</span><span class="n">upper_nodes</span><span class="p">)</span>
        <span class="n">complete_lower_nodes_set</span> <span class="o">=</span> <span class="n">_all_nodes</span><span class="p">(</span><span class="n">lower_nodes</span><span class="p">)</span>
        <span class="n">original_graph_outputs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">outputs</span><span class="p">())</span>
        <span class="c1"># Bridge values are values produced from upper graph, and consumed</span>
        <span class="c1"># by lower graph. These values need to be become upper graph outputs</span>
        <span class="c1"># and lower graph inputs, to bridge the interaction.</span>
        <span class="c1"># Start with all graph inputs marked as covered. If any graph input is</span>
        <span class="c1"># needed by lower graph, just keep it in lower graph inputs later.</span>
        <span class="n">covered_bridge_values</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">inputs</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">upper_nodes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_partition_node</span><span class="p">(</span>
                <span class="n">node</span><span class="p">,</span>
                <span class="n">complete_upper_nodes_set</span><span class="p">,</span>
                <span class="n">complete_lower_nodes_set</span><span class="p">,</span>
                <span class="n">original_graph_outputs</span><span class="p">,</span>
                <span class="n">covered_bridge_values</span><span class="p">,</span>
                <span class="n">process_bridge_value</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">upper_nodes</span><span class="p">,</span>
            <span class="n">lower_nodes</span><span class="p">,</span>
            <span class="n">complete_upper_nodes_set</span><span class="p">,</span>
            <span class="n">complete_lower_nodes_set</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
    <span class="k">def</span> <span class="nf">_bridge_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pt_outs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pt_outs</span>
        <span class="n">graph_outputs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">outputs</span><span class="p">())</span>
        <span class="k">assert</span> <span class="n">pt_outs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">graph_outputs</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">pt_outs</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">graph_outputs</span><span class="p">)</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pt_outs</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">Graph: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">v</span><span class="o">.</span><span class="n">debugName</span><span class="p">():</span> <span class="n">o</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">graph_outputs</span><span class="p">,</span> <span class="n">pt_outs</span><span class="p">)}</span>

    <span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
    <span class="k">def</span> <span class="nf">_args_and_params_for_partition_graph</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">graph</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Graph</span><span class="p">,</span>
        <span class="n">bridge_kwargs</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NumericType</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">_NumericType</span><span class="p">]]],</span>
        <span class="n">full_kwargs</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
        <span class="n">full_params</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
    <span class="p">):</span>
        <span class="n">input_names</span> <span class="o">=</span> <span class="p">[</span><span class="nb">input</span><span class="o">.</span><span class="n">debugName</span><span class="p">()</span> <span class="k">for</span> <span class="nb">input</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">inputs</span><span class="p">()]</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">bridge_kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">input_names</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">bridge_kwargs</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">+=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">full_kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">input_names</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">full_kwargs</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">full_params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">input_names</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">full_params</span><span class="p">}</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">input_names</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="si">}</span><span class="s2"> + </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">input_names</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">input_names</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">args</span><span class="p">,</span> <span class="n">params</span>

<div class="viewcode-block" id="GraphInfo.verify_export"><a class="viewcode-back" href="../../../generated/torch.onnx.verification.GraphInfo.html#torch.onnx.verification.GraphInfo.verify_export">[docs]</a>    <span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
    <span class="k">def</span> <span class="nf">verify_export</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">:</span> <span class="n">VerificationOptions</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="ne">AssertionError</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Graph</span><span class="p">,</span> <span class="n">_OutputsType</span><span class="p">,</span> <span class="n">_OutputsType</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify the export from TorchScript IR graph to ONNX.</span>

<span class="sd">        Export the TorchScript IR graph to ONNX, with the inputs, parameters and export</span>
<span class="sd">        options recorded in this object. Then verify the exported ONNX graph against</span>
<span class="sd">        the original TorchScript IR graph under the provided verification options.</span>

<span class="sd">        Args:</span>
<span class="sd">            options: The verification options.</span>

<span class="sd">        Returns:</span>
<span class="sd">            error: The AssertionError raised during the verification. Returns None if no</span>
<span class="sd">            error is raised.</span>
<span class="sd">            onnx_graph: The exported ONNX graph in TorchScript IR format.</span>
<span class="sd">            onnx_outs: The outputs from running exported ONNX model under the onnx</span>
<span class="sd">            backend in `options`.</span>
<span class="sd">            pt_outs: The outputs from running the TorchScript IR graph.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">verify_aten_graph</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">,</span>
            <span class="n">input_args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">input_args</span><span class="p">,</span>
            <span class="n">params_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params_dict</span><span class="p">,</span>
            <span class="n">export_options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">export_options</span><span class="p">,</span>
            <span class="n">verification_options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="GraphInfo.find_mismatch"><a class="viewcode-back" href="../../../generated/torch.onnx.verification.GraphInfo.html#torch.onnx.verification.GraphInfo.find_mismatch">[docs]</a>    <span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
    <span class="k">def</span> <span class="nf">find_mismatch</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">VerificationOptions</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find all mismatches between the TorchScript IR graph and the exported onnx model.</span>

<span class="sd">        Binary searches the model graph to find the minimal subgraph that exhibits the</span>
<span class="sd">        mismatch. A `GraphInfo` object is created for each subgraph, recording the test</span>
<span class="sd">        inputs and export options, as well as the validation results.</span>

<span class="sd">        Args:</span>
<span class="sd">            options: The verification options.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">options</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">options</span> <span class="o">=</span> <span class="n">VerificationOptions</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">export_options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">outputs</span><span class="p">()))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_args</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params_dict</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">inputs</span><span class="p">())</span>
        <span class="p">),</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Number of graph inputs(</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">inputs</span><span class="p">()))</span><span class="si">}</span><span class="s2">) does not match &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;the provided tensor arguments(</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_args</span><span class="p">)</span><span class="si">}</span><span class="s2"> + </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params_dict</span><span class="p">)</span><span class="si">}</span><span class="s2">).&quot;</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mismatch_error</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_onnx_graph</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pt_outs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verify_export</span><span class="p">(</span>
            <span class="n">options</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mismatch_error</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># No mismatch found in graph.</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">essential_node_count</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Reached leaf node, no more partitioning.</span>
            <span class="k">return</span>

        <span class="n">full_kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="o">.</span><span class="n">debugName</span><span class="p">():</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">inputs</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_args</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">full_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_dict</span>

        <span class="n">upper_graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_partition_upper_graph</span><span class="p">()</span>
        <span class="n">upper_args</span><span class="p">,</span> <span class="n">upper_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args_and_params_for_partition_graph</span><span class="p">(</span>
            <span class="n">upper_graph</span><span class="p">,</span> <span class="p">{},</span> <span class="n">full_kwargs</span><span class="p">,</span> <span class="n">full_params</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">upper_graph_info</span> <span class="o">=</span> <span class="n">GraphInfo</span><span class="p">(</span>
            <span class="n">upper_graph</span><span class="p">,</span>
            <span class="n">upper_args</span><span class="p">,</span>
            <span class="n">upper_params</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">export_options</span><span class="p">,</span>
            <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">upper_graph_info</span><span class="o">.</span><span class="n">find_mismatch</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

        <span class="n">bridge_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper_graph_info</span><span class="o">.</span><span class="n">_bridge_kwargs</span><span class="p">()</span>
        <span class="n">lower_graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_partition_lower_graph</span><span class="p">()</span>
        <span class="n">lower_args</span><span class="p">,</span> <span class="n">lower_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args_and_params_for_partition_graph</span><span class="p">(</span>
            <span class="n">lower_graph</span><span class="p">,</span> <span class="n">bridge_kwargs</span><span class="p">,</span> <span class="n">full_kwargs</span><span class="p">,</span> <span class="n">full_params</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lower_graph_info</span> <span class="o">=</span> <span class="n">GraphInfo</span><span class="p">(</span>
            <span class="n">lower_graph</span><span class="p">,</span>
            <span class="n">lower_args</span><span class="p">,</span>
            <span class="n">lower_params</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">export_options</span><span class="p">,</span>
            <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lower_graph_info</span><span class="o">.</span><span class="n">find_mismatch</span><span class="p">(</span><span class="n">options</span><span class="p">)</span></div></div>


<span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
<span class="k">def</span> <span class="nf">_all_nodes</span><span class="p">(</span><span class="n">nodes</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Node</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Node</span><span class="p">]:</span>
    <span class="n">all_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">n</span><span class="o">.</span><span class="n">blocks</span><span class="p">():</span>
            <span class="n">all_nodes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_all_nodes</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">nodes</span><span class="p">())))</span>
    <span class="k">return</span> <span class="n">all_nodes</span>


<span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
<span class="k">def</span> <span class="nf">_has_uses_by_nodes</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Value</span><span class="p">,</span> <span class="n">nodes</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Node</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">use</span><span class="o">.</span><span class="n">user</span> <span class="ow">in</span> <span class="n">nodes</span> <span class="k">for</span> <span class="n">use</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">uses</span><span class="p">()):</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span>


<span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
<span class="k">def</span> <span class="nf">_node_has_uses_by</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">nodes</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Node</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">outputs</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">_has_uses_by_nodes</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">nodes</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span>


<span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
<span class="k">def</span> <span class="nf">_produced_by</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Value</span><span class="p">,</span> <span class="n">nodes</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Node</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">node</span><span class="p">()</span> <span class="ow">in</span> <span class="n">nodes</span>


<div class="viewcode-block" id="find_mismatch"><a class="viewcode-back" href="../../../onnx.html#torch.onnx.verification.find_mismatch">[docs]</a><span class="nd">@_beartype</span><span class="o">.</span><span class="n">beartype</span>
<span class="k">def</span> <span class="nf">find_mismatch</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">ScriptModule</span><span class="p">],</span>
    <span class="n">input_args</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
    <span class="n">do_constant_folding</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">training</span><span class="p">:</span> <span class="n">_C_onnx</span><span class="o">.</span><span class="n">TrainingMode</span> <span class="o">=</span> <span class="n">_C_onnx</span><span class="o">.</span><span class="n">TrainingMode</span><span class="o">.</span><span class="n">EVAL</span><span class="p">,</span>
    <span class="n">opset_version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">keep_initializers_as_inputs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">VerificationOptions</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GraphInfo</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Find all mismatches between the original model and the exported model.</span>

<span class="sd">    Experimental. The API is subject to change.</span>

<span class="sd">    This tool helps debug the mismatch between the original PyTorch model and exported</span>
<span class="sd">    ONNX model. It binary searches the model graph to find the minimal subgraph that</span>
<span class="sd">    exhibits the mismatch.</span>

<span class="sd">    Args:</span>
<span class="sd">        model: The model to be exported.</span>
<span class="sd">        input_args: The input arguments to the model.</span>
<span class="sd">        do_constant_folding: Same as `do_constant_folding` in :func:`torch.onnx.export`.</span>
<span class="sd">        training: Same as `training` in :func:`torch.onnx.export`.</span>
<span class="sd">        opset_version: Same as `opset_version` in :func:`torch.onnx.export`.</span>
<span class="sd">        keep_initializers_as_inputs: Same as `keep_initializers_as_inputs` in :func:`torch.onnx.export`.</span>
<span class="sd">        verbose: Same as `verbose` in :func:`torch.onnx.export`.</span>
<span class="sd">        options: The options for the mismatch verification.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A GraphInfo object that contains the mismatch information.</span>

<span class="sd">    Example::</span>

<span class="sd">        &gt;&gt;&gt; import torch</span>
<span class="sd">        &gt;&gt;&gt; import torch.onnx.verification</span>
<span class="sd">        &gt;&gt;&gt; torch.manual_seed(0)</span>
<span class="sd">        &gt;&gt;&gt; opset_version = 15</span>
<span class="sd">        &gt;&gt;&gt; # Define a custom symbolic function for aten::relu.</span>
<span class="sd">        &gt;&gt;&gt; # The custom symbolic function is incorrect, which will result in mismatches.</span>
<span class="sd">        &gt;&gt;&gt; def incorrect_relu_symbolic_function(g, self):</span>
<span class="sd">        ...     return self</span>
<span class="sd">        &gt;&gt;&gt; torch.onnx.register_custom_op_symbolic(</span>
<span class="sd">        ...     &quot;aten::relu&quot;,</span>
<span class="sd">        ...     incorrect_relu_symbolic_function,</span>
<span class="sd">        ...     opset_version=opset_version,</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; class Model(torch.nn.Module):</span>
<span class="sd">        ...     def __init__(self):</span>
<span class="sd">        ...         super().__init__()</span>
<span class="sd">        ...         self.layers = torch.nn.Sequential(</span>
<span class="sd">        ...             torch.nn.Linear(3, 4),</span>
<span class="sd">        ...             torch.nn.ReLU(),</span>
<span class="sd">        ...             torch.nn.Linear(4, 5),</span>
<span class="sd">        ...             torch.nn.ReLU(),</span>
<span class="sd">        ...             torch.nn.Linear(5, 6),</span>
<span class="sd">        ...         )</span>
<span class="sd">        ...     def forward(self, x):</span>
<span class="sd">        ...         return self.layers(x)</span>
<span class="sd">        &gt;&gt;&gt; # xdoctest: +REQUIRES(env:TORCH_DOCTEST_ONNX)</span>
<span class="sd">        &gt;&gt;&gt; graph_info = torch.onnx.verification.find_mismatch(</span>
<span class="sd">        ...     Model(),</span>
<span class="sd">        ...     (torch.randn(2, 3),),</span>
<span class="sd">        ...     opset_version=opset_version,</span>
<span class="sd">        ... )</span>
<span class="sd">        ===================== Mismatch info for graph partition : ======================</span>
<span class="sd">        ================================ Mismatch error ================================</span>
<span class="sd">        Tensor-likes are not close!</span>
<span class="sd">        Mismatched elements: 12 / 12 (100.0%)</span>
<span class="sd">        Greatest absolute difference: 0.2328854203224182 at index (1, 2) (up to 1e-07 allowed)</span>
<span class="sd">        Greatest relative difference: 0.699536174352349 at index (1, 3) (up to 0.001 allowed)</span>
<span class="sd">        ==================================== Tree: =====================================</span>
<span class="sd">        5 X   __2 X    __1 âœ“</span>
<span class="sd">        id:  |  id: 0 |  id: 00</span>
<span class="sd">             |        |</span>
<span class="sd">             |        |__1 X (aten::relu)</span>
<span class="sd">             |           id: 01</span>
<span class="sd">             |</span>
<span class="sd">             |__3 X    __1 âœ“</span>
<span class="sd">                id: 1 |  id: 10</span>
<span class="sd">                      |</span>
<span class="sd">                      |__2 X     __1 X (aten::relu)</span>
<span class="sd">                         id: 11 |  id: 110</span>
<span class="sd">                                |</span>
<span class="sd">                                |__1 âœ“</span>
<span class="sd">                                   id: 111</span>
<span class="sd">        =========================== Mismatch leaf subgraphs: ===========================</span>
<span class="sd">        [&#39;01&#39;, &#39;110&#39;]</span>
<span class="sd">        ============================= Mismatch node kinds: =============================</span>
<span class="sd">        {&#39;aten::relu&#39;: 2}</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">options</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">VerificationOptions</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">opset_version</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">opset_version</span> <span class="o">=</span> <span class="n">_constants</span><span class="o">.</span><span class="n">ONNX_DEFAULT_OPSET</span>
    <span class="sd">&quot;&quot;&quot;From aten graph, do binary search on graph partition to find operator export discrepancy.&quot;&quot;&quot;</span>
    <span class="c1"># TODO: Copied from utils.py `export` until `_optimize_graph`.</span>
    <span class="k">if</span> <span class="n">training</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">onnx</span><span class="o">.</span><span class="n">TrainingMode</span><span class="o">.</span><span class="n">TRAINING</span><span class="p">:</span>
        <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">training</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">onnx</span><span class="o">.</span><span class="n">TrainingMode</span><span class="o">.</span><span class="n">EVAL</span><span class="p">:</span>
        <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">inputs_for_export</span> <span class="o">=</span> <span class="n">_prepare_input_for_export</span><span class="p">(</span><span class="n">input_args</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">_decide_input_format</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">inputs_for_export</span><span class="p">)</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">_pre_trace_quant_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="n">graph</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">torch_out</span><span class="p">,</span> <span class="n">module</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">_create_jit_graph</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="n">params_dict</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">_get_named_param_dict</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

        <span class="n">utils</span><span class="o">.</span><span class="n">_apply_friendly_debug_names</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">params_dict</span><span class="p">)</span>

        <span class="n">graph_info</span> <span class="o">=</span> <span class="n">GraphInfo</span><span class="p">(</span>
            <span class="n">graph</span><span class="p">,</span>
            <span class="n">input_args</span><span class="p">,</span>
            <span class="n">params_dict</span><span class="p">,</span>
            <span class="n">_experimental</span><span class="o">.</span><span class="n">ExportOptions</span><span class="p">(</span>
                <span class="n">do_constant_folding</span><span class="o">=</span><span class="n">do_constant_folding</span><span class="p">,</span>
                <span class="n">training</span><span class="o">=</span><span class="n">training</span><span class="p">,</span>
                <span class="n">opset_version</span><span class="o">=</span><span class="n">opset_version</span><span class="p">,</span>
                <span class="n">keep_initializers_as_inputs</span><span class="o">=</span><span class="n">keep_initializers_as_inputs</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">graph_info</span><span class="o">.</span><span class="n">find_mismatch</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
        <span class="n">graph_info</span><span class="o">.</span><span class="n">pretty_print_mismatch</span><span class="p">()</span>
        <span class="n">graph_info</span><span class="o">.</span><span class="n">pretty_print_tree</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">graph_info</span></div>
</pre></div>

             </article>
             
            </div>
            <footer>
  

  

    <hr>

  

  <div role="contentinfo">
    <p>
        &copy; Copyright 2023, PyTorch Contributors.

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>
     

</footer>

          </div>
<script>

var match = window.location.href.match(/\/_[a-zA-Z0-9_]*.html|_dynamo/gi);
var url = window.location.href.lastIndexOf(match[match.length-1]);

if (url)
  {
    var div = '<div class="admonition note"><p class="admonition-title">Note</p><p><i class="fa fa-exclamation-circle" aria-hidden="true">&nbsp</i> This page describes an internal API which is not intended to be used outside of the PyTorch codebase and can be modified or removed without notice.</p></div>'
    document.getElementById("pytorch-article").insertAdjacentHTML('afterBegin', div)
  }
</script>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              
            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
         <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
         <script src="../../../_static/jquery.js"></script>
         <script src="../../../_static/underscore.js"></script>
         <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
         <script src="../../../_static/doctools.js"></script>
         <script src="../../../_static/clipboard.min.js"></script>
         <script src="../../../_static/copybutton.js"></script>
     

  

  <script type="text/javascript" src="../../../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 
<script script type="text/javascript">
  var collapsedSections = ['Developer Notes', 'Language Bindings', 'Libraries', 'Community'];
</script>

<img height="1" width="1" style="border-style:none;" alt="" src="https://www.googleadservices.com/pagead/conversion/795629140/?label=txkmCPmdtosBENSssfsC&amp;guid=ON&amp;script=0"/>


  <!-- Begin Footer -->

  <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
    <div class="container">
      <div class="row">
        <div class="col-md-4 text-center">
          <h2>Docs</h2>
          <p>Access comprehensive developer documentation for PyTorch</p>
          <a class="with-right-arrow" href="https://pytorch.org/docs/stable/index.html">View Docs</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Tutorials</h2>
          <p>Get in-depth tutorials for beginners and advanced developers</p>
          <a class="with-right-arrow" href="https://pytorch.org/tutorials">View Tutorials</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Resources</h2>
          <p>Find development resources and get your questions answered</p>
          <a class="with-right-arrow" href="https://pytorch.org/resources">View Resources</a>
        </div>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container footer-container">
      <div class="footer-logo-wrapper">
        <a href="https://pytorch.org/" class="footer-logo"></a>
      </div>

      <div class="footer-links-wrapper">
        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/">PyTorch</a></li>
            <li><a href="https://pytorch.org/get-started">Get Started</a></li>
            <li><a href="https://pytorch.org/features">Features</a></li>
            <li><a href="https://pytorch.org/ecosystem">Ecosystem</a></li>
            <li><a href="https://pytorch.org/blog/">Blog</a></li>
            <li><a href="https://github.com/pytorch/pytorch/blob/master/CONTRIBUTING.md">Contributing</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/resources">Resources</a></li>
            <li><a href="https://pytorch.org/tutorials">Tutorials</a></li>
            <li><a href="https://pytorch.org/docs/stable/index.html">Docs</a></li>
            <li><a href="https://discuss.pytorch.org" target="_blank">Discuss</a></li>
            <li><a href="https://github.com/pytorch/pytorch/issues" target="_blank">Github Issues</a></li>
            <li><a href="https://pytorch.org/assets/brand-guidelines/PyTorch-Brand-Guidelines.pdf" target="_blank">Brand Guidelines</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title">Stay up to date</li>
            <li><a href="https://www.facebook.com/pytorch" target="_blank">Facebook</a></li>
            <li><a href="https://twitter.com/pytorch" target="_blank">Twitter</a></li>
            <li><a href="https://www.youtube.com/pytorch" target="_blank">YouTube</a></li>
            <li><a href="https://www.linkedin.com/company/pytorch" target="_blank">LinkedIn</a></li>
          </ul>  
          </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title">PyTorch Podcasts</li>
            <li><a href="https://open.spotify.com/show/6UzHKeiy368jKfQMKKvJY5" target="_blank">Spotify</a></li>
            <li><a href="https://podcasts.apple.com/us/podcast/pytorch-developer-podcast/id1566080008" target="_blank">Apple</a></li>
            <li><a href="https://www.google.com/podcasts?feed=aHR0cHM6Ly9mZWVkcy5zaW1wbGVjYXN0LmNvbS9PQjVGa0lsOA%3D%3D" target="_blank">Google</a></li>
            <li><a href="https://music.amazon.com/podcasts/7a4e6f0e-26c2-49e9-a478-41bd244197d0/PyTorch-Developer-Podcast?" target="_blank">Amazon</a></li>
          </ul>
         </div>
        </div>
        
        <div class="privacy-policy">
          <ul>
            <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/terms/" target="_blank">Terms</a></li>
            <li class="privacy-policy-links">|</li>
            <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/privacy-policy/" target="_blank">Privacy</a></li>
          </ul>
        </div>
        <div class="copyright">
        <p>Â© Copyright The Linux Foundation. The PyTorch Foundation is a project of The Linux Foundation.
          For web site terms of use, trademark policy and other policies applicable to The PyTorch Foundation please see
          <a href="www.linuxfoundation.org/policies/">www.linuxfoundation.org/policies/</a>. The PyTorch Foundation supports the PyTorch open source
          project, which has been established as PyTorch Project a Series of LF Projects, LLC. For policies applicable to the PyTorch Project a Series of LF Projects, LLC,
          please see <a href="www.lfprojects.org/policies/">www.lfprojects.org/policies/</a>.</p>
      </div>
     </div>

  </footer>

  <div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebookâ€™s Cookies Policy applies. Learn more, including about available controls: <a href="https://www.facebook.com/policies/cookies/">Cookies Policy</a>.</p>
    <img class="close-button" src="../../../_static/images/pytorch-x.svg">
  </div>
</div>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>
            
          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li class="resources-mobile-menu-title" class="active">
            Docs
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/docs/stable/index.html">PyTorch</a>
            </li>

            <li>
              <a href="https://pytorch.org/audio/stable/index.html">torchaudio</a>
            </li>

            <li>
              <a href="https://pytorch.org/text/stable/index.html">torchtext</a>
            </li>

            <li>
              <a href="https://pytorch.org/vision/stable/index.html">torchvision</a>
            </li>

            <li>
              <a href="https://pytorch.org/torcharrow">torcharrow</a>
            </li>

            <li>
              <a href="https://pytorch.org/data">TorchData</a>
            </li>

            <li>
              <a href="https://pytorch.org/torchrec">TorchRec</a>
            </li>

            <li>
              <a href="https://pytorch.org/serve/">TorchServe</a>
            </li>

            <li>
              <a href="https://pytorch.org/torchx/">TorchX</a>
            </li>

            <li>
              <a href="https://pytorch.org/xla">PyTorch on XLA Devices</a>
            </li>
          </ul>

          <li class="resources-mobile-menu-title">
            Resources
          </li>
            
           <ul class="resources-mobile-menu-items">

            <li>
              <a href="https://pytorch.org/features">About</a>
            </li>

            <li>
              <a href="https://pytorch.org/foundation">PyTorch Foundation</a>
            </li>

            <li>
              <a href="https://pytorch.org/#community-module">Community</a>
            </li>

            <li>
              <a href="https://pytorch.org/community-stories">Community Stories</a>
            </li>

            <li>
              <a href="https://pytorch.org/resources">Developer Resources</a>
            </li>

            <li>
              <a href="https://pytorch.org/events">Events</a>
            </li>

            <li>
              <a href="https://discuss.pytorch.org/">Forums</a>
            </li>

            <li>
              <a href="https://pytorch.org/hub">Models (Beta)</a>
            </li>
          </ul>

          <li>
            <a href="https://github.com/pytorch/pytorch">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="../../../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>