


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta name="robots" content="noindex">
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>torch.testing._comparison &mdash; PyTorch 2.0 documentation</title>
  

  
  
  
  
    <link rel="canonical" href="https://pytorch.org/docs/stable/_modules/torch/testing/_comparison.html"/>
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.css" type="text/css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/katex-math.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx-dropdown.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/panels-bootstrap.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/jit.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />


  <!-- Google Analytics -->
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-117752657-2"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-117752657-2');
    </script>
  
  <!-- End Google Analytics -->
  


  
  <script src="../../../_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>

          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li class="active docs-active">
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-orange-arrow">
                Docs
              </a>
              <div class="resources-dropdown-menu">
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/docs/stable/index.html">
                  <span class="dropdown-title">PyTorch</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/audio/stable/index.html">
                  <span class="dropdown-title">torchaudio</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/text/stable/index.html">
                  <span class="dropdown-title">torchtext</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/vision/stable/index.html">
                  <span class="dropdown-title">torchvision</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torcharrow">
                  <span class="dropdown-title">torcharrow</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/data">
                  <span class="dropdown-title">TorchData</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torchrec">
                  <span class="dropdown-title">TorchRec</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/serve/">
                  <span class="dropdown-title">TorchServe</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torchx/">
                  <span class="dropdown-title">TorchX</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/xla">
                  <span class="dropdown-title">PyTorch on XLA Devices</span>
                  <p></p>
                </a>
            </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-arrow">
                Resources
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/features">
                  <span class="dropdown-title">About</span>
                  <p>Learn about PyTorchâ€™s features and capabilities</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/foundation">
                  <span class="dropdown-title">PyTorch Foundation</span>
                  <p>Learn about the PyTorch foundation</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/#community-module">
                  <span class="dropdown-title">Community</span>
                  <p>Join the PyTorch developer community to contribute, learn, and get your questions answered.</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/community-stories">
                  <span class="dropdown-title">Community Stories</span>
                  <p>Learn how our community solves real, everyday machine learning problems with PyTorch.</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/resources">
                  <span class="dropdown-title">Developer Resources</span>
                  <p>Find resources and get questions answered</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/events">
                  <span class="dropdown-title">Events</span>
                  <p>Find events, webinars, and podcasts</p>
                </a>
                <a class="nav-dropdown-item" href="https://discuss.pytorch.org/" target="_blank">
                  <span class="dropdown-title">Forums</span>
                  <p>A place to discuss PyTorch code, issues, install, research</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/hub">
                  <span class="dropdown-title">Models (Beta)</span>
                  <p>Discover, publish, and reuse pre-trained models</p>
                </a>
              </div>
            </div>
          </li>

          <li>
            <a href="https://github.com/pytorch/pytorch">GitHub</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>

<body class="pytorch-body">

   

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            
    <div class="version">
      <a href='https://pytorch.org/docs/versions.html'>2.0 &#x25BC</a>
    </div>
    


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          </div>

          


            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Community</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../community/build_ci_governance.html">PyTorch Governance | Build + CI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/contribution_guide.html">PyTorch Contribution Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/design.html">PyTorch Design Philosophy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/governance.html">PyTorch Governance | Mechanics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/persons_of_interest.html">PyTorch Governance | Maintainers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/amp_examples.html">CUDA Automatic Mixed Precision examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/autograd.html">Autograd mechanics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/broadcasting.html">Broadcasting semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/cpu_threading_torchscript_inference.html">CPU threading and TorchScript inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/cuda.html">CUDA semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/ddp.html">Distributed Data Parallel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/extending.html">Extending PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/extending.func.html">Extending torch.func with autograd.Function</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/gradcheck.html">Gradcheck mechanics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/hip.html">HIP (ROCm) semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/large_scale_deployments.html">Features for large-scale deployments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/modules.html">Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/mps.html">MPS backend</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/multiprocessing.html">Multiprocessing best practices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/numerical_accuracy.html">Numerical accuracy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/randomness.html">Reproducibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/serialization.html">Serialization semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/windows.html">Windows FAQ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">torch.compile</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../dynamo/index.html">TorchDynamo Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dynamo/installation.html">Installing TorchDynamo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dynamo/get-started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dynamo/guards-overview.html">Guards Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dynamo/custom-backends.html">Custom Backends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dynamo/deep-dive.html">TorchDynamo Deeper Dive</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dynamo/troubleshooting.html">TorchDynamo Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dynamo/faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ir.html">IRs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Language Bindings</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../cpp_index.html">C++</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/javadoc/">Javadoc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../deploy.html">torch::deploy</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Python API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../torch.html">torch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nn.html">torch.nn</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nn.functional.html">torch.nn.functional</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tensors.html">torch.Tensor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tensor_attributes.html">Tensor Attributes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tensor_view.html">Tensor Views</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../amp.html">torch.amp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../autograd.html">torch.autograd</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../library.html">torch.library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cuda.html">torch.cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mps.html">torch.mps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../backends.html">torch.backends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.html">torch.distributed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.algorithms.join.html">torch.distributed.algorithms.join</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.elastic.html">torch.distributed.elastic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fsdp.html">torch.distributed.fsdp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.optim.html">torch.distributed.optim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.tensor.parallel.html">torch.distributed.tensor.parallel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.checkpoint.html">torch.distributed.checkpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributions.html">torch.distributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_dynamo.html">torch._dynamo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fft.html">torch.fft</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../func.html">torch.func</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../futures.html">torch.futures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fx.html">torch.fx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hub.html">torch.hub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../jit.html">torch.jit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../linalg.html">torch.linalg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../monitor.html">torch.monitor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../signal.html">torch.signal</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../special.html">torch.special</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../torch.overrides.html">torch.overrides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../package.html">torch.package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../profiler.html">torch.profiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nn.init.html">torch.nn.init</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../onnx.html">torch.onnx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../onnx_diagnostics.html">torch.onnx diagnostics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../optim.html">torch.optim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../complex_numbers.html">Complex Numbers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ddp_comm_hooks.html">DDP Communication Hooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pipeline.html">Pipeline Parallelism</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quantization.html">Quantization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rpc.html">Distributed RPC Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../random.html">torch.random</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../masked.html">torch.masked</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nested.html">torch.nested</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sparse.html">torch.sparse</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../storage.html">torch.Storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../testing.html">torch.testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../benchmark_utils.html">torch.utils.benchmark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../bottleneck.html">torch.utils.bottleneck</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../checkpoint.html">torch.utils.checkpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cpp_extension.html">torch.utils.cpp_extension</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data.html">torch.utils.data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../jit_utils.html">torch.utils.jit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dlpack.html">torch.utils.dlpack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mobile_optimizer.html">torch.utils.mobile_optimizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../model_zoo.html">torch.utils.model_zoo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tensorboard.html">torch.utils.tensorboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../type_info.html">Type Info</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../named_tensor.html">Named Tensors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../name_inference.html">Named Tensors operator coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../config_mod.html">torch.__config__</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Libraries</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/audio/stable">torchaudio</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/data">TorchData</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/torchrec">TorchRec</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/serve">TorchServe</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/text/stable">torchtext</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/vision/stable">torchvision</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/xla/">PyTorch on XLA Devices</a></li>
</ul>

            
          

        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="../../../index.html">
          
            Docs
          
        </a> &gt;
      </li>

        
          <li><a href="../../index.html">Module code</a> &gt;</li>
        
          <li><a href="../../torch.html">torch</a> &gt;</li>
        
      <li>torch.testing._comparison</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">

        

          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <h1>Source code for torch.testing._comparison</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">cmath</span>
<span class="kn">import</span> <span class="nn">collections.abc</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">Collection</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">NoReturn</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Sequence</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">Type</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">torch</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

    <span class="n">NUMPY_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
    <span class="n">NUMPY_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>


<span class="k">class</span> <span class="nc">ErrorMeta</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Internal testing exception that makes that carries error metadata.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="ne">Exception</span><span class="p">],</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">()</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="s2">&quot;If you are a user and see this message during normal operation &quot;</span>
            <span class="s2">&quot;please file an issue at https://github.com/pytorch/pytorch/issues. &quot;</span>
            <span class="s2">&quot;If you are a developer and working on the comparison functions, please `raise ErrorMeta().to_error()` &quot;</span>
            <span class="s2">&quot;for user facing errors.&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>

    <span class="k">def</span> <span class="nf">to_error</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">generated_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                <span class="n">generated_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">The failure occurred for item </span><span class="si">{</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">([</span><span class="n">item</span><span class="p">])</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="p">(</span><span class="n">generated_msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">else</span> <span class="n">generated_msg</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>


<span class="c1"># Some analysis of tolerance by logging tests from test_torch.py can be found in</span>
<span class="c1"># https://github.com/pytorch/pytorch/pull/32538.</span>
<span class="c1"># {dtype: (rtol, atol)}</span>
<span class="n">_DTYPE_PRECISIONS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">float16</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">1e-5</span><span class="p">),</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.016</span><span class="p">,</span> <span class="mf">1e-5</span><span class="p">),</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">:</span> <span class="p">(</span><span class="mf">1.3e-6</span><span class="p">,</span> <span class="mf">1e-5</span><span class="p">),</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span> <span class="p">(</span><span class="mf">1e-7</span><span class="p">,</span> <span class="mf">1e-7</span><span class="p">),</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">complex32</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">1e-5</span><span class="p">),</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">complex64</span><span class="p">:</span> <span class="p">(</span><span class="mf">1.3e-6</span><span class="p">,</span> <span class="mf">1e-5</span><span class="p">),</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">complex128</span><span class="p">:</span> <span class="p">(</span><span class="mf">1e-7</span><span class="p">,</span> <span class="mf">1e-7</span><span class="p">),</span>
<span class="p">}</span>
<span class="c1"># The default tolerances of torch.float32 are used for quantized dtypes, because quantized tensors are compared in</span>
<span class="c1"># their dequantized and floating point representation. For more details see `TensorLikePair._compare_quantized_values`</span>
<span class="n">_DTYPE_PRECISIONS</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="n">dtype</span><span class="p">:</span> <span class="n">_DTYPE_PRECISIONS</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">quint8</span><span class="p">,</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">quint2x4</span><span class="p">,</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">quint4x2</span><span class="p">,</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">qint8</span><span class="p">,</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">qint32</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">}</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">default_tolerances</span><span class="p">(</span>
    <span class="o">*</span><span class="n">inputs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">dtype</span><span class="p">],</span>
    <span class="n">dtype_precisions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Returns the default absolute and relative testing tolerances for a set of inputs based on the dtype.</span>

<span class="sd">    See :func:`assert_close` for a table of the default tolerance for each dtype.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (Tuple[float, float]): Loosest tolerances of all input dtypes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dtypes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="nb">input</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="n">dtypes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">dtype</span><span class="p">):</span>
            <span class="n">dtypes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Expected a torch.Tensor or a torch.dtype, but got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span><span class="si">}</span><span class="s2"> instead.&quot;</span>
            <span class="p">)</span>
    <span class="n">dtype_precisions</span> <span class="o">=</span> <span class="n">dtype_precisions</span> <span class="ow">or</span> <span class="n">_DTYPE_PRECISIONS</span>
    <span class="n">rtols</span><span class="p">,</span> <span class="n">atols</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">dtype_precisions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span> <span class="k">for</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">dtypes</span><span class="p">])</span>
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">rtols</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">atols</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_tolerances</span><span class="p">(</span>
    <span class="o">*</span><span class="n">inputs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">dtype</span><span class="p">],</span>
    <span class="n">rtol</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
    <span class="n">atol</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
    <span class="nb">id</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Gets absolute and relative to be used for numeric comparisons.</span>

<span class="sd">    If both ``rtol`` and ``atol`` are specified, this is a no-op. If both are not specified, the return value of</span>
<span class="sd">    :func:`default_tolerances` is used.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ErrorMeta: With :class:`ValueError`, if only ``rtol`` or ``atol`` is specified.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (Tuple[float, float]): Valid absolute and relative tolerances.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rtol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">atol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1"># We require both tolerance to be omitted or specified, because specifying only one might lead to surprising</span>
        <span class="c1"># results. Imagine setting atol=0.0 and the tensors still match because rtol&gt;0.0.</span>
        <span class="k">raise</span> <span class="n">ErrorMeta</span><span class="p">(</span>
            <span class="ne">ValueError</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Both &#39;rtol&#39; and &#39;atol&#39; must be either specified or omitted, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;but got no </span><span class="si">{</span><span class="s1">&#39;rtol&#39;</span> <span class="k">if</span> <span class="n">rtol</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;atol&#39;</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
            <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">rtol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">atol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">rtol</span><span class="p">,</span> <span class="n">atol</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">default_tolerances</span><span class="p">(</span><span class="o">*</span><span class="n">inputs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_make_mismatch_msg</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">default_identifier</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">identifier</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">extra</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">abs_diff</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">abs_diff_idx</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">atol</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">rel_diff</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">rel_diff_idx</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">rtol</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Makes a mismatch error message for numeric values.</span>

<span class="sd">    Args:</span>
<span class="sd">        default_identifier (str): Default description of the compared values, e.g. &quot;Tensor-likes&quot;.</span>
<span class="sd">        identifier (Optional[Union[str, Callable[[str], str]]]): Optional identifier that overrides</span>
<span class="sd">            ``default_identifier``. Can be passed as callable in which case it will be called with</span>
<span class="sd">            ``default_identifier`` to create the description at runtime.</span>
<span class="sd">        extra (Optional[str]): Extra information to be placed after the message header and the mismatch statistics.</span>
<span class="sd">        abs_diff (float): Absolute difference.</span>
<span class="sd">        abs_diff_idx (Optional[Union[int, Tuple[int, ...]]]): Optional index of the absolute difference.</span>
<span class="sd">        atol (float): Allowed absolute tolerance. Will only be added to mismatch statistics if it or ``rtol`` are</span>
<span class="sd">            ``&gt; 0``.</span>
<span class="sd">        rel_diff (float): Relative difference.</span>
<span class="sd">        rel_diff_idx (Optional[Union[int, Tuple[int, ...]]]): Optional index of the relative difference.</span>
<span class="sd">        rtol (float): Allowed relative tolerance. Will only be added to mismatch statistics if it or ``atol`` are</span>
<span class="sd">            ``&gt; 0``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">equality</span> <span class="o">=</span> <span class="n">rtol</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">atol</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">make_diff_msg</span><span class="p">(</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">diff</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">idx</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]]],</span>
        <span class="n">tol</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="si">}</span><span class="s2"> difference: </span><span class="si">{</span><span class="n">diff</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Greatest </span><span class="si">{</span><span class="nb">type</span><span class="si">}</span><span class="s2"> difference: </span><span class="si">{</span><span class="n">diff</span><span class="si">}</span><span class="s2"> at index </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">equality</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; (up to </span><span class="si">{</span><span class="n">tol</span><span class="si">}</span><span class="s2"> allowed)&quot;</span>
        <span class="k">return</span> <span class="n">msg</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="n">identifier</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="n">default_identifier</span>
    <span class="k">elif</span> <span class="n">callable</span><span class="p">(</span><span class="n">identifier</span><span class="p">):</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="n">identifier</span><span class="p">(</span><span class="n">default_identifier</span><span class="p">)</span>

    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">identifier</span><span class="si">}</span><span class="s2"> are not </span><span class="si">{</span><span class="s1">&#39;equal&#39;</span> <span class="k">if</span> <span class="n">equality</span> <span class="k">else</span> <span class="s1">&#39;close&#39;</span><span class="si">}</span><span class="s2">!</span><span class="se">\n\n</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="n">extra</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">extra</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="n">msg</span> <span class="o">+=</span> <span class="n">make_diff_msg</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;absolute&quot;</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="n">abs_diff</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="n">abs_diff_idx</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">atol</span><span class="p">)</span>
    <span class="n">msg</span> <span class="o">+=</span> <span class="n">make_diff_msg</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;relative&quot;</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="n">rel_diff</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="n">rel_diff_idx</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">rtol</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">msg</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">make_scalar_mismatch_msg</span><span class="p">(</span>
    <span class="n">actual</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">],</span>
    <span class="n">expected</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">],</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">rtol</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">atol</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">identifier</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Makes a mismatch error message for scalars.</span>

<span class="sd">    Args:</span>
<span class="sd">        actual (Union[int, float, complex]): Actual scalar.</span>
<span class="sd">        expected (Union[int, float, complex]): Expected scalar.</span>
<span class="sd">        rtol (float): Relative tolerance.</span>
<span class="sd">        atol (float): Absolute tolerance.</span>
<span class="sd">        identifier (Optional[Union[str, Callable[[str], str]]]): Optional description for the scalars. Can be passed</span>
<span class="sd">            as callable in which case it will be called by the default value to create the description at runtime.</span>
<span class="sd">            Defaults to &quot;Scalars&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">abs_diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">actual</span> <span class="o">-</span> <span class="n">expected</span><span class="p">)</span>
    <span class="n">rel_diff</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">expected</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">abs_diff</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">expected</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_make_mismatch_msg</span><span class="p">(</span>
        <span class="n">default_identifier</span><span class="o">=</span><span class="s2">&quot;Scalars&quot;</span><span class="p">,</span>
        <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="p">,</span>
        <span class="n">abs_diff</span><span class="o">=</span><span class="n">abs_diff</span><span class="p">,</span>
        <span class="n">atol</span><span class="o">=</span><span class="n">atol</span><span class="p">,</span>
        <span class="n">rel_diff</span><span class="o">=</span><span class="n">rel_diff</span><span class="p">,</span>
        <span class="n">rtol</span><span class="o">=</span><span class="n">rtol</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">make_tensor_mismatch_msg</span><span class="p">(</span>
    <span class="n">actual</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">expected</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">mismatches</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">rtol</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">atol</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">identifier</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Makes a mismatch error message for tensors.</span>

<span class="sd">    Args:</span>
<span class="sd">        actual (torch.Tensor): Actual tensor.</span>
<span class="sd">        expected (torch.Tensor): Expected tensor.</span>
<span class="sd">        mismatches (torch.Tensor): Boolean mask of the same shape as ``actual`` and ``expected`` that indicates the</span>
<span class="sd">            location of mismatches.</span>
<span class="sd">        rtol (float): Relative tolerance.</span>
<span class="sd">        atol (float): Absolute tolerance.</span>
<span class="sd">        identifier (Optional[Union[str, Callable[[str], str]]]): Optional description for the tensors. Can be passed</span>
<span class="sd">            as callable in which case it will be called by the default value to create the description at runtime.</span>
<span class="sd">            Defaults to &quot;Tensor-likes&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">unravel_flat_index</span><span class="p">(</span><span class="n">flat_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mismatches</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">()</span>

        <span class="n">inverse_index</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">mismatches</span><span class="o">.</span><span class="n">shape</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">div</span><span class="p">,</span> <span class="n">mod</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">flat_index</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
            <span class="n">flat_index</span> <span class="o">=</span> <span class="n">div</span>
            <span class="n">inverse_index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">inverse_index</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">number_of_elements</span> <span class="o">=</span> <span class="n">mismatches</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span>
    <span class="n">total_mismatches</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mismatches</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="n">extra</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Mismatched elements: </span><span class="si">{</span><span class="n">total_mismatches</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="n">number_of_elements</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">total_mismatches</span> <span class="o">/</span> <span class="n">number_of_elements</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">)&quot;</span>
    <span class="p">)</span>

    <span class="n">a_flat</span> <span class="o">=</span> <span class="n">actual</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">b_flat</span> <span class="o">=</span> <span class="n">expected</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">matches_flat</span> <span class="o">=</span> <span class="o">~</span><span class="n">mismatches</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="n">abs_diff</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a_flat</span> <span class="o">-</span> <span class="n">b_flat</span><span class="p">)</span>
    <span class="c1"># Ensure that only mismatches are used for the max_abs_diff computation</span>
    <span class="n">abs_diff</span><span class="p">[</span><span class="n">matches_flat</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">max_abs_diff</span><span class="p">,</span> <span class="n">max_abs_diff_flat_idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">abs_diff</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">rel_diff</span> <span class="o">=</span> <span class="n">abs_diff</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">b_flat</span><span class="p">)</span>
    <span class="c1"># Ensure that only mismatches are used for the max_rel_diff computation</span>
    <span class="n">rel_diff</span><span class="p">[</span><span class="n">matches_flat</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">max_rel_diff</span><span class="p">,</span> <span class="n">max_rel_diff_flat_idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">rel_diff</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_make_mismatch_msg</span><span class="p">(</span>
        <span class="n">default_identifier</span><span class="o">=</span><span class="s2">&quot;Tensor-likes&quot;</span><span class="p">,</span>
        <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="p">,</span>
        <span class="n">extra</span><span class="o">=</span><span class="n">extra</span><span class="p">,</span>
        <span class="n">abs_diff</span><span class="o">=</span><span class="n">max_abs_diff</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
        <span class="n">abs_diff_idx</span><span class="o">=</span><span class="n">unravel_flat_index</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">max_abs_diff_flat_idx</span><span class="p">)),</span>
        <span class="n">atol</span><span class="o">=</span><span class="n">atol</span><span class="p">,</span>
        <span class="n">rel_diff</span><span class="o">=</span><span class="n">max_rel_diff</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
        <span class="n">rel_diff_idx</span><span class="o">=</span><span class="n">unravel_flat_index</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">max_rel_diff_flat_idx</span><span class="p">)),</span>
        <span class="n">rtol</span><span class="o">=</span><span class="n">rtol</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">class</span> <span class="nc">UnsupportedInputs</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>  <span class="c1"># noqa: B903</span>
    <span class="sd">&quot;&quot;&quot;Exception to be raised during the construction of a :class:`Pair` in case it doesn&#39;t support the inputs.&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">Pair</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;ABC for all comparison pairs to be used in conjunction with :func:`assert_equal`.</span>

<span class="sd">    Each subclass needs to overwrite :meth:`Pair.compare` that performs the actual comparison.</span>

<span class="sd">    Each pair receives **all** options, so select the ones applicable for the subclass and forward the rest to the</span>
<span class="sd">    super class. Raising an :class:`UnsupportedInputs` during constructions indicates that the pair is not able to</span>
<span class="sd">    handle the inputs and the next pair type will be tried.</span>

<span class="sd">    All other errors should be raised as :class:`ErrorMeta`. After the instantiation, :meth:`Pair._make_error_meta` can</span>
<span class="sd">    be used to automatically handle overwriting the message with a user supplied one and id handling.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">actual</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">expected</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
        <span class="o">**</span><span class="n">unknown_parameters</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actual</span> <span class="o">=</span> <span class="n">actual</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expected</span> <span class="o">=</span> <span class="n">expected</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unknown_parameters</span> <span class="o">=</span> <span class="n">unknown_parameters</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_inputs_not_supported</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UnsupportedInputs</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_check_inputs_isinstance</span><span class="p">(</span><span class="o">*</span><span class="n">inputs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="bp">cls</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Type</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Type</span><span class="p">,</span> <span class="o">...</span><span class="p">]]):</span>
        <span class="sd">&quot;&quot;&quot;Checks if all inputs are instances of a given class and raise :class:`UnsupportedInputs` otherwise.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span> <span class="k">for</span> <span class="nb">input</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">):</span>
            <span class="n">Pair</span><span class="o">.</span><span class="n">_inputs_not_supported</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_fail</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="ne">Exception</span><span class="p">],</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">()</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Raises an :class:`ErrorMeta` from a given exception type and message and the stored id.</span>

<span class="sd">        .. warning::</span>

<span class="sd">            If you use this before the ``super().__init__(...)`` call in the constructor, you have to pass the ``id``</span>
<span class="sd">            explicitly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">ErrorMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">id</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="nb">id</span><span class="p">)</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">compare</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Compares the inputs and raises an :class`ErrorMeta` in case they mismatch.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">extra_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
        <span class="sd">&quot;&quot;&quot;Returns extra information that will be included in the representation.</span>

<span class="sd">        Should be overwritten by all subclasses that use additional options. The representation of the object will only</span>
<span class="sd">        be surfaced in case we encounter an unexpected error and thus should help debug the issue. Can be a sequence of</span>
<span class="sd">        key-value-pairs or attribute names.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">head</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(&quot;</span>
        <span class="n">tail</span> <span class="o">=</span> <span class="s2">&quot;)&quot;</span>
        <span class="n">body</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">value</span><span class="si">!s}</span><span class="s2">,&quot;</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;actual&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">actual</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;expected&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected</span><span class="p">),</span>
                <span class="o">*</span><span class="p">[</span>
                    <span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extra</span><span class="p">))</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">extra</span>
                    <span class="k">for</span> <span class="n">extra</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_repr</span><span class="p">()</span>
                <span class="p">],</span>
            <span class="p">]</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">head</span><span class="p">,</span> <span class="o">*</span><span class="n">body</span><span class="p">,</span> <span class="o">*</span><span class="n">tail</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">ObjectPair</span><span class="p">(</span><span class="n">Pair</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Pair for any type of inputs that will be compared with the `==` operator.</span>

<span class="sd">    .. note::</span>

<span class="sd">        Since this will instantiate for any kind of inputs, it should only be used as fallback after all other pairs</span>
<span class="sd">        couldn&#39;t handle the inputs.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">compare</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">equal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">actual</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="c1"># We are not using `self._raise_error_meta` here since we need the exception chaining</span>
            <span class="k">raise</span> <span class="n">ErrorMeta</span><span class="p">(</span>
                <span class="ne">ValueError</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">actual</span><span class="si">}</span><span class="s2"> == </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expected</span><span class="si">}</span><span class="s2"> failed with:</span><span class="se">\n</span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
                <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">error</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">equal</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fail</span><span class="p">(</span><span class="ne">AssertionError</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">actual</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expected</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">NonePair</span><span class="p">(</span><span class="n">Pair</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Pair for ``None`` inputs.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">actual</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">expected</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">other_parameters</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">actual</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">expected</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inputs_not_supported</span><span class="p">()</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="o">**</span><span class="n">other_parameters</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compare</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">actual</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fail</span><span class="p">(</span>
                <span class="ne">AssertionError</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;None mismatch: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">actual</span><span class="si">}</span><span class="s2"> is not </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expected</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>


<span class="k">class</span> <span class="nc">BooleanPair</span><span class="p">(</span><span class="n">Pair</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Pair for :class:`bool` inputs.</span>

<span class="sd">    .. note::</span>

<span class="sd">        If ``numpy`` is available, also handles :class:`numpy.bool_` inputs.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">actual</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">expected</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
        <span class="o">**</span><span class="n">other_parameters</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">actual</span><span class="p">,</span> <span class="n">expected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_inputs</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="o">**</span><span class="n">other_parameters</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_supported_types</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Type</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Type</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">bool</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">NUMPY_AVAILABLE</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_process_inputs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">actual</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">expected</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs_isinstance</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_supported_types</span><span class="p">)</span>
        <span class="n">actual</span><span class="p">,</span> <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_to_bool</span><span class="p">(</span><span class="n">bool_like</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span> <span class="k">for</span> <span class="n">bool_like</span> <span class="ow">in</span> <span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">actual</span><span class="p">,</span> <span class="n">expected</span>

    <span class="k">def</span> <span class="nf">_to_bool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bool_like</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bool_like</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">bool_like</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bool_like</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">bool_like</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ErrorMeta</span><span class="p">(</span>
                <span class="ne">TypeError</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Unknown boolean type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">bool_like</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">compare</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">actual</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fail</span><span class="p">(</span>
                <span class="ne">AssertionError</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;Booleans mismatch: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">actual</span><span class="si">}</span><span class="s2"> is not </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expected</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>


<span class="k">class</span> <span class="nc">NumberPair</span><span class="p">(</span><span class="n">Pair</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Pair for Python number (:class:`int`, :class:`float`, and :class:`complex`) inputs.</span>

<span class="sd">    .. note::</span>

<span class="sd">        If ``numpy`` is available, also handles :class:`numpy.number` inputs.</span>

<span class="sd">    Kwargs:</span>
<span class="sd">        rtol (Optional[float]): Relative tolerance. If specified ``atol`` must also be specified. If omitted, default</span>
<span class="sd">            values based on the type are selected with the below table.</span>
<span class="sd">        atol (Optional[float]): Absolute tolerance. If specified ``rtol`` must also be specified. If omitted, default</span>
<span class="sd">            values based on the type are selected with the below table.</span>
<span class="sd">        equal_nan (bool): If ``True``, two ``NaN`` values are considered equal. Defaults to ``False``.</span>
<span class="sd">        check_dtype (bool): If ``True``, the type of the inputs will be checked for equality. Defaults to ``False``.</span>

<span class="sd">    The following table displays correspondence between Python number type and the ``torch.dtype``&#39;s. See</span>
<span class="sd">    :func:`assert_close` for the corresponding tolerances.</span>

<span class="sd">    +------------------+-------------------------------+</span>
<span class="sd">    | ``type``         | corresponding ``torch.dtype`` |</span>
<span class="sd">    +==================+===============================+</span>
<span class="sd">    | :class:`int`     | :attr:`~torch.int64`          |</span>
<span class="sd">    +------------------+-------------------------------+</span>
<span class="sd">    | :class:`float`   | :attr:`~torch.float64`        |</span>
<span class="sd">    +------------------+-------------------------------+</span>
<span class="sd">    | :class:`complex` | :attr:`~torch.complex64`      |</span>
<span class="sd">    +------------------+-------------------------------+</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_TYPE_TO_DTYPE</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nb">int</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span>
        <span class="nb">float</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
        <span class="nb">complex</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">complex128</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">_NUMBER_TYPES</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">_TYPE_TO_DTYPE</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">actual</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">expected</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
        <span class="n">rtol</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">atol</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">equal_nan</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">check_dtype</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">other_parameters</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">actual</span><span class="p">,</span> <span class="n">expected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_inputs</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="o">**</span><span class="n">other_parameters</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rtol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atol</span> <span class="o">=</span> <span class="n">get_tolerances</span><span class="p">(</span>
            <span class="o">*</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_TYPE_TO_DTYPE</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="nb">input</span><span class="p">)]</span> <span class="k">for</span> <span class="nb">input</span> <span class="ow">in</span> <span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">)],</span>
            <span class="n">rtol</span><span class="o">=</span><span class="n">rtol</span><span class="p">,</span>
            <span class="n">atol</span><span class="o">=</span><span class="n">atol</span><span class="p">,</span>
            <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equal_nan</span> <span class="o">=</span> <span class="n">equal_nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_dtype</span> <span class="o">=</span> <span class="n">check_dtype</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_supported_types</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Type</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_NUMBER_TYPES</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">NUMPY_AVAILABLE</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_process_inputs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">actual</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">expected</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">],</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">]]:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs_isinstance</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_supported_types</span><span class="p">)</span>
        <span class="n">actual</span><span class="p">,</span> <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_to_number</span><span class="p">(</span><span class="n">number_like</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span> <span class="k">for</span> <span class="n">number_like</span> <span class="ow">in</span> <span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">actual</span><span class="p">,</span> <span class="n">expected</span>

    <span class="k">def</span> <span class="nf">_to_number</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">number_like</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">NUMPY_AVAILABLE</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">number_like</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">number_like</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">number_like</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_NUMBER_TYPES</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">number_like</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ErrorMeta</span><span class="p">(</span>
                <span class="ne">TypeError</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Unknown number type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">number_like</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">compare</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_dtype</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">actual</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expected</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fail</span><span class="p">(</span>
                <span class="ne">AssertionError</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;The (d)types do not match: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">actual</span><span class="p">)</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expected</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">actual</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">equal_nan</span> <span class="ow">and</span> <span class="n">cmath</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">actual</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cmath</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expected</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="n">abs_diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">actual</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected</span><span class="p">)</span>
        <span class="n">tolerance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atol</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rtol</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expected</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cmath</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">abs_diff</span><span class="p">)</span> <span class="ow">and</span> <span class="n">abs_diff</span> <span class="o">&lt;=</span> <span class="n">tolerance</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_fail</span><span class="p">(</span>
            <span class="ne">AssertionError</span><span class="p">,</span>
            <span class="n">make_scalar_mismatch_msg</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">actual</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rtol</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">atol</span>
            <span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">extra_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="s2">&quot;rtol&quot;</span><span class="p">,</span>
            <span class="s2">&quot;atol&quot;</span><span class="p">,</span>
            <span class="s2">&quot;equal_nan&quot;</span><span class="p">,</span>
            <span class="s2">&quot;check_dtype&quot;</span><span class="p">,</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">TensorLikePair</span><span class="p">(</span><span class="n">Pair</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Pair for :class:`torch.Tensor`-like inputs.</span>

<span class="sd">    Kwargs:</span>
<span class="sd">        allow_subclasses (bool):</span>
<span class="sd">        rtol (Optional[float]): Relative tolerance. If specified ``atol`` must also be specified. If omitted, default</span>
<span class="sd">            values based on the type are selected. See :func:assert_close: for details.</span>
<span class="sd">        atol (Optional[float]): Absolute tolerance. If specified ``rtol`` must also be specified. If omitted, default</span>
<span class="sd">            values based on the type are selected. See :func:assert_close: for details.</span>
<span class="sd">        equal_nan (bool): If ``True``, two ``NaN`` values are considered equal. Defaults to ``False``.</span>
<span class="sd">        check_device (bool): If ``True`` (default), asserts that corresponding tensors are on the same</span>
<span class="sd">            :attr:`~torch.Tensor.device`. If this check is disabled, tensors on different</span>
<span class="sd">            :attr:`~torch.Tensor.device`&#39;s are moved to the CPU before being compared.</span>
<span class="sd">        check_dtype (bool): If ``True`` (default), asserts that corresponding tensors have the same ``dtype``. If this</span>
<span class="sd">            check is disabled, tensors with different ``dtype``&#39;s are promoted  to a common ``dtype`` (according to</span>
<span class="sd">            :func:`torch.promote_types`) before being compared.</span>
<span class="sd">        check_layout (bool): If ``True`` (default), asserts that corresponding tensors have the same ``layout``. If this</span>
<span class="sd">            check is disabled, tensors with different ``layout``&#39;s are converted to strided tensors before being</span>
<span class="sd">            compared.</span>
<span class="sd">        check_stride (bool): If ``True`` and corresponding tensors are strided, asserts that they have the same stride.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">actual</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">expected</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
        <span class="n">allow_subclasses</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">rtol</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">atol</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">equal_nan</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">check_device</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">check_dtype</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">check_layout</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">check_stride</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">other_parameters</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">actual</span><span class="p">,</span> <span class="n">expected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_inputs</span><span class="p">(</span>
            <span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">allow_subclasses</span><span class="o">=</span><span class="n">allow_subclasses</span>
        <span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="o">**</span><span class="n">other_parameters</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rtol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atol</span> <span class="o">=</span> <span class="n">get_tolerances</span><span class="p">(</span>
            <span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="n">rtol</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">atol</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equal_nan</span> <span class="o">=</span> <span class="n">equal_nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_device</span> <span class="o">=</span> <span class="n">check_device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_dtype</span> <span class="o">=</span> <span class="n">check_dtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_layout</span> <span class="o">=</span> <span class="n">check_layout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_stride</span> <span class="o">=</span> <span class="n">check_stride</span>

    <span class="k">def</span> <span class="nf">_process_inputs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">actual</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">expected</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">allow_subclasses</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
        <span class="n">directly_related</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">expected</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">expected</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">actual</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">directly_related</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inputs_not_supported</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_subclasses</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">actual</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">expected</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inputs_not_supported</span><span class="p">()</span>

        <span class="n">actual</span><span class="p">,</span> <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_to_tensor</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span> <span class="k">for</span> <span class="nb">input</span> <span class="ow">in</span> <span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">tensor</span> <span class="ow">in</span> <span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_supported</span><span class="p">(</span><span class="n">tensor</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">actual</span><span class="p">,</span> <span class="n">expected</span>

    <span class="k">def</span> <span class="nf">_to_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tensor_like</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tensor_like</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">tensor_like</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">tensor_like</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inputs_not_supported</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_check_supported</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tensor</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tensor</span><span class="o">.</span><span class="n">layout</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">strided</span><span class="p">,</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">sparse_coo</span><span class="p">,</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">sparse_csr</span><span class="p">,</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">sparse_csc</span><span class="p">,</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">sparse_bsr</span><span class="p">,</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">sparse_bsc</span><span class="p">,</span>
        <span class="p">}:</span>
            <span class="k">raise</span> <span class="n">ErrorMeta</span><span class="p">(</span>
                <span class="ne">ValueError</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Unsupported tensor layout </span><span class="si">{</span><span class="n">tensor</span><span class="o">.</span><span class="n">layout</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">compare</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">actual</span><span class="p">,</span> <span class="n">expected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">actual</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_compare_attributes</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;meta&quot;</span> <span class="k">for</span> <span class="nb">input</span> <span class="ow">in</span> <span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">)):</span>
            <span class="k">return</span>

        <span class="n">actual</span><span class="p">,</span> <span class="n">expected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_equalize_attributes</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compare_values</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compare_attributes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">actual</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">expected</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Checks if the attributes of two tensors match.</span>

<span class="sd">        Always checks</span>

<span class="sd">        - the :attr:`~torch.Tensor.shape`,</span>
<span class="sd">        - whether both inputs are quantized or not,</span>
<span class="sd">        - and if they use the same quantization scheme.</span>

<span class="sd">        Checks for</span>

<span class="sd">        - :attr:`~torch.Tensor.layout`,</span>
<span class="sd">        - :meth:`~torch.Tensor.stride`,</span>
<span class="sd">        - :attr:`~torch.Tensor.device`, and</span>
<span class="sd">        - :attr:`~torch.Tensor.dtype`</span>

<span class="sd">        are optional and can be disabled through the corresponding ``check_*`` flag during construction of the pair.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">raise_mismatch_error</span><span class="p">(</span>
            <span class="n">attribute_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">actual_value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">expected_value</span><span class="p">:</span> <span class="n">Any</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fail</span><span class="p">(</span>
                <span class="ne">AssertionError</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;The values for attribute &#39;</span><span class="si">{</span><span class="n">attribute_name</span><span class="si">}</span><span class="s2">&#39; do not match: </span><span class="si">{</span><span class="n">actual_value</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="n">expected_value</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">actual</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">expected</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="n">raise_mismatch_error</span><span class="p">(</span><span class="s2">&quot;shape&quot;</span><span class="p">,</span> <span class="n">actual</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">expected</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">actual</span><span class="o">.</span><span class="n">is_quantized</span> <span class="o">!=</span> <span class="n">expected</span><span class="o">.</span><span class="n">is_quantized</span><span class="p">:</span>
            <span class="n">raise_mismatch_error</span><span class="p">(</span>
                <span class="s2">&quot;is_quantized&quot;</span><span class="p">,</span> <span class="n">actual</span><span class="o">.</span><span class="n">is_quantized</span><span class="p">,</span> <span class="n">expected</span><span class="o">.</span><span class="n">is_quantized</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">actual</span><span class="o">.</span><span class="n">is_quantized</span> <span class="ow">and</span> <span class="n">actual</span><span class="o">.</span><span class="n">qscheme</span><span class="p">()</span> <span class="o">!=</span> <span class="n">expected</span><span class="o">.</span><span class="n">qscheme</span><span class="p">():</span>
            <span class="n">raise_mismatch_error</span><span class="p">(</span><span class="s2">&quot;qscheme()&quot;</span><span class="p">,</span> <span class="n">actual</span><span class="o">.</span><span class="n">qscheme</span><span class="p">(),</span> <span class="n">expected</span><span class="o">.</span><span class="n">qscheme</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">actual</span><span class="o">.</span><span class="n">layout</span> <span class="o">!=</span> <span class="n">expected</span><span class="o">.</span><span class="n">layout</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_layout</span><span class="p">:</span>
                <span class="n">raise_mismatch_error</span><span class="p">(</span><span class="s2">&quot;layout&quot;</span><span class="p">,</span> <span class="n">actual</span><span class="o">.</span><span class="n">layout</span><span class="p">,</span> <span class="n">expected</span><span class="o">.</span><span class="n">layout</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="n">actual</span><span class="o">.</span><span class="n">layout</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">strided</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_stride</span>
            <span class="ow">and</span> <span class="n">actual</span><span class="o">.</span><span class="n">stride</span><span class="p">()</span> <span class="o">!=</span> <span class="n">expected</span><span class="o">.</span><span class="n">stride</span><span class="p">()</span>
        <span class="p">):</span>
            <span class="n">raise_mismatch_error</span><span class="p">(</span><span class="s2">&quot;stride()&quot;</span><span class="p">,</span> <span class="n">actual</span><span class="o">.</span><span class="n">stride</span><span class="p">(),</span> <span class="n">expected</span><span class="o">.</span><span class="n">stride</span><span class="p">())</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_device</span> <span class="ow">and</span> <span class="n">actual</span><span class="o">.</span><span class="n">device</span> <span class="o">!=</span> <span class="n">expected</span><span class="o">.</span><span class="n">device</span><span class="p">:</span>
            <span class="n">raise_mismatch_error</span><span class="p">(</span><span class="s2">&quot;device&quot;</span><span class="p">,</span> <span class="n">actual</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">expected</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_dtype</span> <span class="ow">and</span> <span class="n">actual</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">expected</span><span class="o">.</span><span class="n">dtype</span><span class="p">:</span>
            <span class="n">raise_mismatch_error</span><span class="p">(</span><span class="s2">&quot;dtype&quot;</span><span class="p">,</span> <span class="n">actual</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">expected</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_equalize_attributes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">actual</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">expected</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Equalizes some attributes of two tensors for value comparison.</span>

<span class="sd">        If ``actual`` and ``expected`` are ...</span>

<span class="sd">        - ... not on the same :attr:`~torch.Tensor.device`, they are moved CPU memory.</span>
<span class="sd">        - ... not of the same ``dtype``, they are promoted  to a common ``dtype`` (according to</span>
<span class="sd">            :func:`torch.promote_types`).</span>
<span class="sd">        - ... not of the same ``layout``, they are converted to strided tensors.</span>

<span class="sd">        Args:</span>
<span class="sd">            actual (Tensor): Actual tensor.</span>
<span class="sd">            expected (Tensor): Expected tensor.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (Tuple[Tensor, Tensor]): Equalized tensors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The comparison logic uses operators currently not supported by the MPS backends.</span>
        <span class="c1">#  See https://github.com/pytorch/pytorch/issues/77144 for details.</span>
        <span class="c1"># TODO: Remove this conversion as soon as all operations are supported natively by the MPS backend</span>
        <span class="k">if</span> <span class="n">actual</span><span class="o">.</span><span class="n">is_mps</span> <span class="ow">or</span> <span class="n">expected</span><span class="o">.</span><span class="n">is_mps</span><span class="p">:</span>  <span class="c1"># type: ignore[attr-defined]</span>
            <span class="n">actual</span> <span class="o">=</span> <span class="n">actual</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
            <span class="n">expected</span> <span class="o">=</span> <span class="n">expected</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">actual</span><span class="o">.</span><span class="n">device</span> <span class="o">!=</span> <span class="n">expected</span><span class="o">.</span><span class="n">device</span><span class="p">:</span>
            <span class="n">actual</span> <span class="o">=</span> <span class="n">actual</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
            <span class="n">expected</span> <span class="o">=</span> <span class="n">expected</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">actual</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">expected</span><span class="o">.</span><span class="n">dtype</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">promote_types</span><span class="p">(</span><span class="n">actual</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">expected</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">actual</span> <span class="o">=</span> <span class="n">actual</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">expected</span> <span class="o">=</span> <span class="n">expected</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">actual</span><span class="o">.</span><span class="n">layout</span> <span class="o">!=</span> <span class="n">expected</span><span class="o">.</span><span class="n">layout</span><span class="p">:</span>
            <span class="c1"># These checks are needed, since Tensor.to_dense() fails on tensors that are already strided</span>
            <span class="n">actual</span> <span class="o">=</span> <span class="n">actual</span><span class="o">.</span><span class="n">to_dense</span><span class="p">()</span> <span class="k">if</span> <span class="n">actual</span><span class="o">.</span><span class="n">layout</span> <span class="o">!=</span> <span class="n">torch</span><span class="o">.</span><span class="n">strided</span> <span class="k">else</span> <span class="n">actual</span>
            <span class="n">expected</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">expected</span><span class="o">.</span><span class="n">to_dense</span><span class="p">()</span> <span class="k">if</span> <span class="n">expected</span><span class="o">.</span><span class="n">layout</span> <span class="o">!=</span> <span class="n">torch</span><span class="o">.</span><span class="n">strided</span> <span class="k">else</span> <span class="n">expected</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">actual</span><span class="p">,</span> <span class="n">expected</span>

    <span class="k">def</span> <span class="nf">_compare_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">actual</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">expected</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">actual</span><span class="o">.</span><span class="n">is_quantized</span><span class="p">:</span>
            <span class="n">compare_fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compare_quantized_values</span>
        <span class="k">elif</span> <span class="n">actual</span><span class="o">.</span><span class="n">is_sparse</span><span class="p">:</span>
            <span class="n">compare_fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compare_sparse_coo_values</span>
        <span class="k">elif</span> <span class="n">actual</span><span class="o">.</span><span class="n">layout</span> <span class="ow">in</span> <span class="p">{</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">sparse_csr</span><span class="p">,</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">sparse_csc</span><span class="p">,</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">sparse_bsr</span><span class="p">,</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">sparse_bsc</span><span class="p">,</span>
        <span class="p">}:</span>
            <span class="n">compare_fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compare_sparse_compressed_values</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">compare_fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compare_regular_values_close</span>

        <span class="n">compare_fn</span><span class="p">(</span>
            <span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rtol</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">atol</span><span class="p">,</span> <span class="n">equal_nan</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">equal_nan</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compare_quantized_values</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">actual</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">expected</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">rtol</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">atol</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">equal_nan</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Compares quantized tensors by comparing the :meth:`~torch.Tensor.dequantize`&#39;d variants for closeness.</span>

<span class="sd">        .. note::</span>

<span class="sd">            A detailed discussion about why only the dequantized variant is checked for closeness rather than checking</span>
<span class="sd">            the individual quantization parameters for closeness and the integer representation for equality can be</span>
<span class="sd">            found in https://github.com/pytorch/pytorch/issues/68548.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compare_regular_values_close</span><span class="p">(</span>
            <span class="n">actual</span><span class="o">.</span><span class="n">dequantize</span><span class="p">(),</span>
            <span class="n">expected</span><span class="o">.</span><span class="n">dequantize</span><span class="p">(),</span>
            <span class="n">rtol</span><span class="o">=</span><span class="n">rtol</span><span class="p">,</span>
            <span class="n">atol</span><span class="o">=</span><span class="n">atol</span><span class="p">,</span>
            <span class="n">equal_nan</span><span class="o">=</span><span class="n">equal_nan</span><span class="p">,</span>
            <span class="n">identifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">default_identifier</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Quantized </span><span class="si">{</span><span class="n">default_identifier</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compare_sparse_coo_values</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">actual</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">expected</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">rtol</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">atol</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">equal_nan</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Compares sparse COO tensors by comparing</span>

<span class="sd">        - the number of sparse dimensions,</span>
<span class="sd">        - the number of non-zero elements (nnz) for equality,</span>
<span class="sd">        - the indices for equality, and</span>
<span class="sd">        - the values for closeness.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">actual</span><span class="o">.</span><span class="n">sparse_dim</span><span class="p">()</span> <span class="o">!=</span> <span class="n">expected</span><span class="o">.</span><span class="n">sparse_dim</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fail</span><span class="p">(</span>
                <span class="ne">AssertionError</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The number of sparse dimensions in sparse COO tensors does not match: &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">actual</span><span class="o">.</span><span class="n">sparse_dim</span><span class="p">()</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="n">expected</span><span class="o">.</span><span class="n">sparse_dim</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">),</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">actual</span><span class="o">.</span><span class="n">_nnz</span><span class="p">()</span> <span class="o">!=</span> <span class="n">expected</span><span class="o">.</span><span class="n">_nnz</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fail</span><span class="p">(</span>
                <span class="ne">AssertionError</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The number of specified values in sparse COO tensors does not match: &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">actual</span><span class="o">.</span><span class="n">_nnz</span><span class="p">()</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="n">expected</span><span class="o">.</span><span class="n">_nnz</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">),</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_compare_regular_values_equal</span><span class="p">(</span>
            <span class="n">actual</span><span class="o">.</span><span class="n">_indices</span><span class="p">(),</span>
            <span class="n">expected</span><span class="o">.</span><span class="n">_indices</span><span class="p">(),</span>
            <span class="n">identifier</span><span class="o">=</span><span class="s2">&quot;Sparse COO indices&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compare_regular_values_close</span><span class="p">(</span>
            <span class="n">actual</span><span class="o">.</span><span class="n">_values</span><span class="p">(),</span>
            <span class="n">expected</span><span class="o">.</span><span class="n">_values</span><span class="p">(),</span>
            <span class="n">rtol</span><span class="o">=</span><span class="n">rtol</span><span class="p">,</span>
            <span class="n">atol</span><span class="o">=</span><span class="n">atol</span><span class="p">,</span>
            <span class="n">equal_nan</span><span class="o">=</span><span class="n">equal_nan</span><span class="p">,</span>
            <span class="n">identifier</span><span class="o">=</span><span class="s2">&quot;Sparse COO values&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compare_sparse_compressed_values</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">actual</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">expected</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">rtol</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">atol</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">equal_nan</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Compares sparse compressed tensors by comparing</span>

<span class="sd">        - the number of non-zero elements (nnz) for equality,</span>
<span class="sd">        - the plain indices for equality,</span>
<span class="sd">        - the compressed indices for equality, and</span>
<span class="sd">        - the values for closeness.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">format_name</span><span class="p">,</span> <span class="n">compressed_indices_method</span><span class="p">,</span> <span class="n">plain_indices_method</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">sparse_csr</span><span class="p">:</span> <span class="p">(</span>
                <span class="s2">&quot;CSR&quot;</span><span class="p">,</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="o">.</span><span class="n">crow_indices</span><span class="p">,</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="o">.</span><span class="n">col_indices</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">sparse_csc</span><span class="p">:</span> <span class="p">(</span>
                <span class="s2">&quot;CSC&quot;</span><span class="p">,</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="o">.</span><span class="n">ccol_indices</span><span class="p">,</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="o">.</span><span class="n">row_indices</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">sparse_bsr</span><span class="p">:</span> <span class="p">(</span>
                <span class="s2">&quot;BSR&quot;</span><span class="p">,</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="o">.</span><span class="n">crow_indices</span><span class="p">,</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="o">.</span><span class="n">col_indices</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">sparse_bsc</span><span class="p">:</span> <span class="p">(</span>
                <span class="s2">&quot;BSC&quot;</span><span class="p">,</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="o">.</span><span class="n">ccol_indices</span><span class="p">,</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="o">.</span><span class="n">row_indices</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">}[</span><span class="n">actual</span><span class="o">.</span><span class="n">layout</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">actual</span><span class="o">.</span><span class="n">_nnz</span><span class="p">()</span> <span class="o">!=</span> <span class="n">expected</span><span class="o">.</span><span class="n">_nnz</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fail</span><span class="p">(</span>
                <span class="ne">AssertionError</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The number of specified values in sparse </span><span class="si">{</span><span class="n">format_name</span><span class="si">}</span><span class="s2"> tensors does not match: &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">actual</span><span class="o">.</span><span class="n">_nnz</span><span class="p">()</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="n">expected</span><span class="o">.</span><span class="n">_nnz</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">),</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_compare_regular_values_equal</span><span class="p">(</span>
            <span class="n">compressed_indices_method</span><span class="p">(</span><span class="n">actual</span><span class="p">),</span>
            <span class="n">compressed_indices_method</span><span class="p">(</span><span class="n">expected</span><span class="p">),</span>
            <span class="n">identifier</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Sparse </span><span class="si">{</span><span class="n">format_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">compressed_indices_method</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compare_regular_values_equal</span><span class="p">(</span>
            <span class="n">plain_indices_method</span><span class="p">(</span><span class="n">actual</span><span class="p">),</span>
            <span class="n">plain_indices_method</span><span class="p">(</span><span class="n">expected</span><span class="p">),</span>
            <span class="n">identifier</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Sparse </span><span class="si">{</span><span class="n">format_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">plain_indices_method</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compare_regular_values_close</span><span class="p">(</span>
            <span class="n">actual</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
            <span class="n">expected</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
            <span class="n">rtol</span><span class="o">=</span><span class="n">rtol</span><span class="p">,</span>
            <span class="n">atol</span><span class="o">=</span><span class="n">atol</span><span class="p">,</span>
            <span class="n">equal_nan</span><span class="o">=</span><span class="n">equal_nan</span><span class="p">,</span>
            <span class="n">identifier</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Sparse </span><span class="si">{</span><span class="n">format_name</span><span class="si">}</span><span class="s2"> values&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compare_regular_values_equal</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">actual</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">expected</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">equal_nan</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">identifier</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Checks if the values of two tensors are equal.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compare_regular_values_close</span><span class="p">(</span>
            <span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">equal_nan</span><span class="o">=</span><span class="n">equal_nan</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compare_regular_values_close</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">actual</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">expected</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">rtol</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">atol</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">equal_nan</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">identifier</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Checks if the values of two tensors are close up to a desired tolerance.&quot;&quot;&quot;</span>
        <span class="n">actual</span><span class="p">,</span> <span class="n">expected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_promote_for_comparison</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span>
            <span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="n">rtol</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">atol</span><span class="p">,</span> <span class="n">equal_nan</span><span class="o">=</span><span class="n">equal_nan</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">matches</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">actual</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([]):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">make_scalar_mismatch_msg</span><span class="p">(</span>
                <span class="n">actual</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
                <span class="n">expected</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
                <span class="n">rtol</span><span class="o">=</span><span class="n">rtol</span><span class="p">,</span>
                <span class="n">atol</span><span class="o">=</span><span class="n">atol</span><span class="p">,</span>
                <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">make_tensor_mismatch_msg</span><span class="p">(</span>
                <span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="o">~</span><span class="n">matches</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="n">rtol</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">atol</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fail</span><span class="p">(</span><span class="ne">AssertionError</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_promote_for_comparison</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">actual</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">expected</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Promotes the inputs to the comparison dtype based on the input dtype.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Inputs promoted to the highest precision dtype of the same dtype category. :class:`torch.bool` is treated</span>
<span class="sd">            as integral dtype.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># This is called after self._equalize_attributes() and thus `actual` and `expected` already have the same dtype.</span>
        <span class="k">if</span> <span class="n">actual</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">is_complex</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">complex128</span>
        <span class="k">elif</span> <span class="n">actual</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">is_floating_point</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">int64</span>
        <span class="k">return</span> <span class="n">actual</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="p">),</span> <span class="n">expected</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">extra_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="s2">&quot;rtol&quot;</span><span class="p">,</span>
            <span class="s2">&quot;atol&quot;</span><span class="p">,</span>
            <span class="s2">&quot;equal_nan&quot;</span><span class="p">,</span>
            <span class="s2">&quot;check_device&quot;</span><span class="p">,</span>
            <span class="s2">&quot;check_dtype&quot;</span><span class="p">,</span>
            <span class="s2">&quot;check_layout&quot;</span><span class="p">,</span>
            <span class="s2">&quot;check_stride&quot;</span><span class="p">,</span>
        <span class="p">)</span>


<span class="k">def</span> <span class="nf">originate_pairs</span><span class="p">(</span>
    <span class="n">actual</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">expected</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">pair_types</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Pair</span><span class="p">]],</span>
    <span class="n">sequence_types</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Type</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">,),</span>
    <span class="n">mapping_types</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Type</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Mapping</span><span class="p">,),</span>
    <span class="nb">id</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
    <span class="o">**</span><span class="n">options</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Pair</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Originates pairs from the individual inputs.</span>

<span class="sd">    ``actual`` and ``expected`` can be possibly nested :class:`~collections.abc.Sequence`&#39;s or</span>
<span class="sd">    :class:`~collections.abc.Mapping`&#39;s. In this case the pairs are originated by recursing through them.</span>

<span class="sd">    Args:</span>
<span class="sd">        actual (Any): Actual input.</span>
<span class="sd">        expected (Any): Expected input.</span>
<span class="sd">        pair_types (Sequence[Type[Pair]]): Sequence of pair types that will be tried to construct with the inputs.</span>
<span class="sd">            First successful pair will be used.</span>
<span class="sd">        sequence_types (Tuple[Type, ...]): Optional types treated as sequences that will be checked elementwise.</span>
<span class="sd">        mapping_types (Tuple[Type, ...]): Optional types treated as mappings that will be checked elementwise.</span>
<span class="sd">        id (Tuple[Any, ...]): Optional id of a pair that will be included in an error message.</span>
<span class="sd">        **options (Any): Options passed to each pair during construction.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ErrorMeta: With :class`AssertionError`, if the inputs are :class:`~collections.abc.Sequence`&#39;s, but their</span>
<span class="sd">            length does not match.</span>
<span class="sd">        ErrorMeta: With :class`AssertionError`, if the inputs are :class:`~collections.abc.Mapping`&#39;s, but their set of</span>
<span class="sd">            keys do not match.</span>
<span class="sd">        ErrorMeta: With :class`TypeError`, if no pair is able to handle the inputs.</span>
<span class="sd">        ErrorMeta: With any expected exception that happens during the construction of a pair.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (List[Pair]): Originated pairs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># We explicitly exclude str&#39;s here since they are self-referential and would cause an infinite recursion loop:</span>
    <span class="c1"># &quot;a&quot; == &quot;a&quot;[0][0]...</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="nb">isinstance</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">sequence_types</span><span class="p">)</span>
        <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">sequence_types</span><span class="p">)</span>
        <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="n">actual_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">actual</span><span class="p">)</span>
        <span class="n">expected_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">expected</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">actual_len</span> <span class="o">!=</span> <span class="n">expected_len</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ErrorMeta</span><span class="p">(</span>
                <span class="ne">AssertionError</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;The length of the sequences mismatch: </span><span class="si">{</span><span class="n">actual_len</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="n">expected_len</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">pairs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">actual_len</span><span class="p">):</span>
            <span class="n">pairs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="n">originate_pairs</span><span class="p">(</span>
                    <span class="n">actual</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                    <span class="n">expected</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                    <span class="n">pair_types</span><span class="o">=</span><span class="n">pair_types</span><span class="p">,</span>
                    <span class="n">sequence_types</span><span class="o">=</span><span class="n">sequence_types</span><span class="p">,</span>
                    <span class="n">mapping_types</span><span class="o">=</span><span class="n">mapping_types</span><span class="p">,</span>
                    <span class="nb">id</span><span class="o">=</span><span class="p">(</span><span class="o">*</span><span class="nb">id</span><span class="p">,</span> <span class="n">idx</span><span class="p">),</span>
                    <span class="o">**</span><span class="n">options</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">pairs</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">mapping_types</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">mapping_types</span><span class="p">):</span>
        <span class="n">actual_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">actual</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">expected_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">expected</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">actual_keys</span> <span class="o">!=</span> <span class="n">expected_keys</span><span class="p">:</span>
            <span class="n">missing_keys</span> <span class="o">=</span> <span class="n">expected_keys</span> <span class="o">-</span> <span class="n">actual_keys</span>
            <span class="n">additional_keys</span> <span class="o">=</span> <span class="n">actual_keys</span> <span class="o">-</span> <span class="n">expected_keys</span>
            <span class="k">raise</span> <span class="n">ErrorMeta</span><span class="p">(</span>
                <span class="ne">AssertionError</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The keys of the mappings do not match:</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Missing keys in the actual mapping: </span><span class="si">{</span><span class="nb">sorted</span><span class="p">(</span><span class="n">missing_keys</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Additional keys in the actual mapping: </span><span class="si">{</span><span class="nb">sorted</span><span class="p">(</span><span class="n">additional_keys</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">),</span>
                <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">keys</span><span class="p">:</span> <span class="n">Collection</span> <span class="o">=</span> <span class="n">actual_keys</span>
        <span class="c1"># Since the origination aborts after the first failure, we try to be deterministic</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>

        <span class="n">pairs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">pairs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="n">originate_pairs</span><span class="p">(</span>
                    <span class="n">actual</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
                    <span class="n">expected</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
                    <span class="n">pair_types</span><span class="o">=</span><span class="n">pair_types</span><span class="p">,</span>
                    <span class="n">sequence_types</span><span class="o">=</span><span class="n">sequence_types</span><span class="p">,</span>
                    <span class="n">mapping_types</span><span class="o">=</span><span class="n">mapping_types</span><span class="p">,</span>
                    <span class="nb">id</span><span class="o">=</span><span class="p">(</span><span class="o">*</span><span class="nb">id</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span>
                    <span class="o">**</span><span class="n">options</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">pairs</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">pair_type</span> <span class="ow">in</span> <span class="n">pair_types</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">pair_type</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)]</span>
            <span class="c1"># Raising an `UnsupportedInputs` during origination indicates that the pair type is not able to handle the</span>
            <span class="c1"># inputs. Thus, we try the next pair type.</span>
            <span class="k">except</span> <span class="n">UnsupportedInputs</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># Raising an `ErrorMeta` during origination is the orderly way to abort and so we simply re-raise it. This</span>
            <span class="c1"># is only in a separate branch, because the one below would also except it.</span>
            <span class="k">except</span> <span class="n">ErrorMeta</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="c1"># Raising any other exception during origination is unexpected and will give some extra information about</span>
            <span class="c1"># what happened. If applicable, the exception should be expected in the future.</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Originating a </span><span class="si">{</span><span class="n">pair_type</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">() at item </span><span class="si">{</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">([</span><span class="n">item</span><span class="p">])</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">id</span><span class="p">)</span><span class="si">}</span><span class="s2"> with</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">actual</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(): </span><span class="si">{</span><span class="n">actual</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;and</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">expected</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(): </span><span class="si">{</span><span class="n">expected</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;resulted in the unexpected exception above. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;If you are a user and see this message during normal operation &quot;</span>
                    <span class="s2">&quot;please file an issue at https://github.com/pytorch/pytorch/issues. &quot;</span>
                    <span class="s2">&quot;If you are a developer and working on the comparison functions, &quot;</span>
                    <span class="s2">&quot;please except the previous error and raise an expressive `ErrorMeta` instead.&quot;</span>
                <span class="p">)</span> <span class="kn">from</span> <span class="nn">error</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ErrorMeta</span><span class="p">(</span>
                <span class="ne">TypeError</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;No comparison pair was able to handle inputs of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">actual</span><span class="p">)</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">expected</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
                <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span>
            <span class="p">)</span>


<span class="k">def</span> <span class="nf">not_close_error_metas</span><span class="p">(</span>
    <span class="n">actual</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">expected</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">pair_types</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Pair</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ObjectPair</span><span class="p">,),</span>
    <span class="n">sequence_types</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Type</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">,),</span>
    <span class="n">mapping_types</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Type</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Mapping</span><span class="p">,),</span>
    <span class="o">**</span><span class="n">options</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ErrorMeta</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Asserts that inputs are equal.</span>

<span class="sd">    ``actual`` and ``expected`` can be possibly nested :class:`~collections.abc.Sequence`&#39;s or</span>
<span class="sd">    :class:`~collections.abc.Mapping`&#39;s. In this case the comparison happens elementwise by recursing through them.</span>

<span class="sd">    Args:</span>
<span class="sd">        actual (Any): Actual input.</span>
<span class="sd">        expected (Any): Expected input.</span>
<span class="sd">        pair_types (Sequence[Type[Pair]]): Sequence of :class:`Pair` types that will be tried to construct with the</span>
<span class="sd">            inputs. First successful pair will be used. Defaults to only using :class:`ObjectPair`.</span>
<span class="sd">        sequence_types (Tuple[Type, ...]): Optional types treated as sequences that will be checked elementwise.</span>
<span class="sd">        mapping_types (Tuple[Type, ...]): Optional types treated as mappings that will be checked elementwise.</span>
<span class="sd">        **options (Any): Options passed to each pair during construction.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Hide this function from `pytest`&#39;s traceback</span>
    <span class="n">__tracebackhide__</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">pairs</span> <span class="o">=</span> <span class="n">originate_pairs</span><span class="p">(</span>
            <span class="n">actual</span><span class="p">,</span>
            <span class="n">expected</span><span class="p">,</span>
            <span class="n">pair_types</span><span class="o">=</span><span class="n">pair_types</span><span class="p">,</span>
            <span class="n">sequence_types</span><span class="o">=</span><span class="n">sequence_types</span><span class="p">,</span>
            <span class="n">mapping_types</span><span class="o">=</span><span class="n">mapping_types</span><span class="p">,</span>
            <span class="o">**</span><span class="n">options</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="n">ErrorMeta</span> <span class="k">as</span> <span class="n">error_meta</span><span class="p">:</span>
        <span class="c1"># Explicitly raising from None to hide the internal traceback</span>
        <span class="k">raise</span> <span class="n">error_meta</span><span class="o">.</span><span class="n">to_error</span><span class="p">()</span> <span class="kn">from</span> <span class="bp">None</span>

    <span class="n">error_metas</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ErrorMeta</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pair</span><span class="o">.</span><span class="n">compare</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">ErrorMeta</span> <span class="k">as</span> <span class="n">error_meta</span><span class="p">:</span>
            <span class="n">error_metas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_meta</span><span class="p">)</span>
        <span class="c1"># Raising any exception besides `ErrorMeta` while comparing is unexpected and will give some extra information</span>
        <span class="c1"># about what happened. If applicable, the exception should be expected in the future.</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Comparing</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pair</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;resulted in the unexpected exception above. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;If you are a user and see this message during normal operation &quot;</span>
                <span class="s2">&quot;please file an issue at https://github.com/pytorch/pytorch/issues. &quot;</span>
                <span class="s2">&quot;If you are a developer and working on the comparison functions, &quot;</span>
                <span class="s2">&quot;please except the previous error and raise an expressive `ErrorMeta` instead.&quot;</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">error</span>

    <span class="k">return</span> <span class="n">error_metas</span>


<div class="viewcode-block" id="assert_close"><a class="viewcode-back" href="../../../testing.html#torch.testing.assert_close">[docs]</a><span class="k">def</span> <span class="nf">assert_close</span><span class="p">(</span>
    <span class="n">actual</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">expected</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">allow_subclasses</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">rtol</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">atol</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">equal_nan</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">check_device</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">check_dtype</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">check_layout</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">check_stride</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">msg</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Asserts that ``actual`` and ``expected`` are close.</span>

<span class="sd">    If ``actual`` and ``expected`` are strided, non-quantized, real-valued, and finite, they are considered close if</span>

<span class="sd">    .. math::</span>

<span class="sd">        \lvert \text{actual} - \text{expected} \rvert \le \texttt{atol} + \texttt{rtol} \cdot \lvert \text{expected} \rvert</span>

<span class="sd">    Non-finite values (``-inf`` and ``inf``) are only considered close if and only if they are equal. ``NaN``&#39;s are</span>
<span class="sd">    only considered equal to each other if ``equal_nan`` is ``True``.</span>

<span class="sd">    In addition, they are only considered close if they have the same</span>

<span class="sd">    - :attr:`~torch.Tensor.device` (if ``check_device`` is ``True``),</span>
<span class="sd">    - ``dtype`` (if ``check_dtype`` is ``True``),</span>
<span class="sd">    - ``layout`` (if ``check_layout`` is ``True``), and</span>
<span class="sd">    - stride (if ``check_stride`` is ``True``).</span>

<span class="sd">    If either ``actual`` or ``expected`` is a meta tensor, only the attribute checks will be performed.</span>

<span class="sd">    If ``actual`` and ``expected`` are sparse (either having COO, CSR, CSC, BSR, or BSC layout), their strided members are</span>
<span class="sd">    checked individually. Indices, namely ``indices`` for COO, ``crow_indices`` and ``col_indices`` for CSR and BSR,</span>
<span class="sd">    or ``ccol_indices``  and ``row_indices`` for CSC and BSC layouts, respectively,</span>
<span class="sd">    are always checked for equality whereas the values are checked for closeness according to the definition above.</span>

<span class="sd">    If ``actual`` and ``expected`` are quantized, they are considered close if they have the same</span>
<span class="sd">    :meth:`~torch.Tensor.qscheme` and the result of :meth:`~torch.Tensor.dequantize` is close according to the</span>
<span class="sd">    definition above.</span>

<span class="sd">    ``actual`` and ``expected`` can be :class:`~torch.Tensor`&#39;s or any tensor-or-scalar-likes from which</span>
<span class="sd">    :class:`torch.Tensor`&#39;s can be constructed with :func:`torch.as_tensor`. Except for Python scalars the input types</span>
<span class="sd">    have to be directly related. In addition, ``actual`` and ``expected`` can be :class:`~collections.abc.Sequence`&#39;s</span>
<span class="sd">    or :class:`~collections.abc.Mapping`&#39;s in which case they are considered close if their structure matches and all</span>
<span class="sd">    their elements are considered close according to the above definition.</span>

<span class="sd">    .. note::</span>

<span class="sd">        Python scalars are an exception to the type relation requirement, because their :func:`type`, i.e.</span>
<span class="sd">        :class:`int`, :class:`float`, and :class:`complex`, is equivalent to the ``dtype`` of a tensor-like. Thus,</span>
<span class="sd">        Python scalars of different types can be checked, but require ``check_dtype=False``.</span>

<span class="sd">    Args:</span>
<span class="sd">        actual (Any): Actual input.</span>
<span class="sd">        expected (Any): Expected input.</span>
<span class="sd">        allow_subclasses (bool): If ``True`` (default) and except for Python scalars, inputs of directly related types</span>
<span class="sd">            are allowed. Otherwise type equality is required.</span>
<span class="sd">        rtol (Optional[float]): Relative tolerance. If specified ``atol`` must also be specified. If omitted, default</span>
<span class="sd">            values based on the :attr:`~torch.Tensor.dtype` are selected with the below table.</span>
<span class="sd">        atol (Optional[float]): Absolute tolerance. If specified ``rtol`` must also be specified. If omitted, default</span>
<span class="sd">            values based on the :attr:`~torch.Tensor.dtype` are selected with the below table.</span>
<span class="sd">        equal_nan (Union[bool, str]): If ``True``, two ``NaN`` values will be considered equal.</span>
<span class="sd">        check_device (bool): If ``True`` (default), asserts that corresponding tensors are on the same</span>
<span class="sd">            :attr:`~torch.Tensor.device`. If this check is disabled, tensors on different</span>
<span class="sd">            :attr:`~torch.Tensor.device`&#39;s are moved to the CPU before being compared.</span>
<span class="sd">        check_dtype (bool): If ``True`` (default), asserts that corresponding tensors have the same ``dtype``. If this</span>
<span class="sd">            check is disabled, tensors with different ``dtype``&#39;s are promoted  to a common ``dtype`` (according to</span>
<span class="sd">            :func:`torch.promote_types`) before being compared.</span>
<span class="sd">        check_layout (bool): If ``True`` (default), asserts that corresponding tensors have the same ``layout``. If this</span>
<span class="sd">            check is disabled, tensors with different ``layout``&#39;s are converted to strided tensors before being</span>
<span class="sd">            compared.</span>
<span class="sd">        check_stride (bool): If ``True`` and corresponding tensors are strided, asserts that they have the same stride.</span>
<span class="sd">        msg (Optional[Union[str, Callable[[str], str]]]): Optional error message to use in case a failure occurs during</span>
<span class="sd">            the comparison. Can also passed as callable in which case it will be called with the generated message and</span>
<span class="sd">            should return the new message.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If no :class:`torch.Tensor` can be constructed from an input.</span>
<span class="sd">        ValueError: If only ``rtol`` or ``atol`` is specified.</span>
<span class="sd">        AssertionError: If corresponding inputs are not Python scalars and are not directly related.</span>
<span class="sd">        AssertionError: If ``allow_subclasses`` is ``False``, but corresponding inputs are not Python scalars and have</span>
<span class="sd">            different types.</span>
<span class="sd">        AssertionError: If the inputs are :class:`~collections.abc.Sequence`&#39;s, but their length does not match.</span>
<span class="sd">        AssertionError: If the inputs are :class:`~collections.abc.Mapping`&#39;s, but their set of keys do not match.</span>
<span class="sd">        AssertionError: If corresponding tensors do not have the same :attr:`~torch.Tensor.shape`.</span>
<span class="sd">        AssertionError: If ``check_layout`` is ``True``, but corresponding tensors do not have the same</span>
<span class="sd">            :attr:`~torch.Tensor.layout`.</span>
<span class="sd">        AssertionError: If only one of corresponding tensors is quantized.</span>
<span class="sd">        AssertionError: If corresponding tensors are quantized, but have different :meth:`~torch.Tensor.qscheme`&#39;s.</span>
<span class="sd">        AssertionError: If ``check_device`` is ``True``, but corresponding tensors are not on the same</span>
<span class="sd">            :attr:`~torch.Tensor.device`.</span>
<span class="sd">        AssertionError: If ``check_dtype`` is ``True``, but corresponding tensors do not have the same ``dtype``.</span>
<span class="sd">        AssertionError: If ``check_stride`` is ``True``, but corresponding strided tensors do not have the same stride.</span>
<span class="sd">        AssertionError: If the values of corresponding tensors are not close according to the definition above.</span>

<span class="sd">    The following table displays the default ``rtol`` and ``atol`` for different ``dtype``&#39;s. In case of mismatching</span>
<span class="sd">    ``dtype``&#39;s, the maximum of both tolerances is used.</span>

<span class="sd">    +---------------------------+------------+----------+</span>
<span class="sd">    | ``dtype``                 | ``rtol``   | ``atol`` |</span>
<span class="sd">    +===========================+============+==========+</span>
<span class="sd">    | :attr:`~torch.float16`    | ``1e-3``   | ``1e-5`` |</span>
<span class="sd">    +---------------------------+------------+----------+</span>
<span class="sd">    | :attr:`~torch.bfloat16`   | ``1.6e-2`` | ``1e-5`` |</span>
<span class="sd">    +---------------------------+------------+----------+</span>
<span class="sd">    | :attr:`~torch.float32`    | ``1.3e-6`` | ``1e-5`` |</span>
<span class="sd">    +---------------------------+------------+----------+</span>
<span class="sd">    | :attr:`~torch.float64`    | ``1e-7``   | ``1e-7`` |</span>
<span class="sd">    +---------------------------+------------+----------+</span>
<span class="sd">    | :attr:`~torch.complex32`  | ``1e-3``   | ``1e-5`` |</span>
<span class="sd">    +---------------------------+------------+----------+</span>
<span class="sd">    | :attr:`~torch.complex64`  | ``1.3e-6`` | ``1e-5`` |</span>
<span class="sd">    +---------------------------+------------+----------+</span>
<span class="sd">    | :attr:`~torch.complex128` | ``1e-7``   | ``1e-7`` |</span>
<span class="sd">    +---------------------------+------------+----------+</span>
<span class="sd">    | :attr:`~torch.quint8`     | ``1.3e-6`` | ``1e-5`` |</span>
<span class="sd">    +---------------------------+------------+----------+</span>
<span class="sd">    | :attr:`~torch.quint2x4`   | ``1.3e-6`` | ``1e-5`` |</span>
<span class="sd">    +---------------------------+------------+----------+</span>
<span class="sd">    | :attr:`~torch.quint4x2`   | ``1.3e-6`` | ``1e-5`` |</span>
<span class="sd">    +---------------------------+------------+----------+</span>
<span class="sd">    | :attr:`~torch.qint8`      | ``1.3e-6`` | ``1e-5`` |</span>
<span class="sd">    +---------------------------+------------+----------+</span>
<span class="sd">    | :attr:`~torch.qint32`     | ``1.3e-6`` | ``1e-5`` |</span>
<span class="sd">    +---------------------------+------------+----------+</span>
<span class="sd">    | other                     | ``0.0``    | ``0.0``  |</span>
<span class="sd">    +---------------------------+------------+----------+</span>

<span class="sd">    .. note::</span>

<span class="sd">        :func:`~torch.testing.assert_close` is highly configurable with strict default settings. Users are encouraged</span>
<span class="sd">        to :func:`~functools.partial` it to fit their use case. For example, if an equality check is needed, one might</span>
<span class="sd">        define an ``assert_equal`` that uses zero tolerances for every ``dtype`` by default:</span>

<span class="sd">        &gt;&gt;&gt; import functools</span>
<span class="sd">        &gt;&gt;&gt; assert_equal = functools.partial(torch.testing.assert_close, rtol=0, atol=0)</span>
<span class="sd">        &gt;&gt;&gt; assert_equal(1e-9, 1e-10)</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        AssertionError: Scalars are not equal!</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        Absolute difference: 9.000000000000001e-10</span>
<span class="sd">        Relative difference: 9.0</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; # tensor to tensor comparison</span>
<span class="sd">        &gt;&gt;&gt; expected = torch.tensor([1e0, 1e-1, 1e-2])</span>
<span class="sd">        &gt;&gt;&gt; actual = torch.acos(torch.cos(expected))</span>
<span class="sd">        &gt;&gt;&gt; torch.testing.assert_close(actual, expected)</span>

<span class="sd">        &gt;&gt;&gt; # scalar to scalar comparison</span>
<span class="sd">        &gt;&gt;&gt; import math</span>
<span class="sd">        &gt;&gt;&gt; expected = math.sqrt(2.0)</span>
<span class="sd">        &gt;&gt;&gt; actual = 2.0 / math.sqrt(2.0)</span>
<span class="sd">        &gt;&gt;&gt; torch.testing.assert_close(actual, expected)</span>

<span class="sd">        &gt;&gt;&gt; # numpy array to numpy array comparison</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        &gt;&gt;&gt; expected = np.array([1e0, 1e-1, 1e-2])</span>
<span class="sd">        &gt;&gt;&gt; actual = np.arccos(np.cos(expected))</span>
<span class="sd">        &gt;&gt;&gt; torch.testing.assert_close(actual, expected)</span>

<span class="sd">        &gt;&gt;&gt; # sequence to sequence comparison</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        &gt;&gt;&gt; # The types of the sequences do not have to match. They only have to have the same</span>
<span class="sd">        &gt;&gt;&gt; # length and their elements have to match.</span>
<span class="sd">        &gt;&gt;&gt; expected = [torch.tensor([1.0]), 2.0, np.array(3.0)]</span>
<span class="sd">        &gt;&gt;&gt; actual = tuple(expected)</span>
<span class="sd">        &gt;&gt;&gt; torch.testing.assert_close(actual, expected)</span>

<span class="sd">        &gt;&gt;&gt; # mapping to mapping comparison</span>
<span class="sd">        &gt;&gt;&gt; from collections import OrderedDict</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        &gt;&gt;&gt; foo = torch.tensor(1.0)</span>
<span class="sd">        &gt;&gt;&gt; bar = 2.0</span>
<span class="sd">        &gt;&gt;&gt; baz = np.array(3.0)</span>
<span class="sd">        &gt;&gt;&gt; # The types and a possible ordering of mappings do not have to match. They only</span>
<span class="sd">        &gt;&gt;&gt; # have to have the same set of keys and their elements have to match.</span>
<span class="sd">        &gt;&gt;&gt; expected = OrderedDict([(&quot;foo&quot;, foo), (&quot;bar&quot;, bar), (&quot;baz&quot;, baz)])</span>
<span class="sd">        &gt;&gt;&gt; actual = {&quot;baz&quot;: baz, &quot;bar&quot;: bar, &quot;foo&quot;: foo}</span>
<span class="sd">        &gt;&gt;&gt; torch.testing.assert_close(actual, expected)</span>

<span class="sd">        &gt;&gt;&gt; expected = torch.tensor([1.0, 2.0, 3.0])</span>
<span class="sd">        &gt;&gt;&gt; actual = expected.clone()</span>
<span class="sd">        &gt;&gt;&gt; # By default, directly related instances can be compared</span>
<span class="sd">        &gt;&gt;&gt; torch.testing.assert_close(torch.nn.Parameter(actual), expected)</span>
<span class="sd">        &gt;&gt;&gt; # This check can be made more strict with allow_subclasses=False</span>
<span class="sd">        &gt;&gt;&gt; torch.testing.assert_close(</span>
<span class="sd">        ...     torch.nn.Parameter(actual), expected, allow_subclasses=False</span>
<span class="sd">        ... )</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        TypeError: No comparison pair was able to handle inputs of type</span>
<span class="sd">        &lt;class &#39;torch.nn.parameter.Parameter&#39;&gt; and &lt;class &#39;torch.Tensor&#39;&gt;.</span>
<span class="sd">        &gt;&gt;&gt; # If the inputs are not directly related, they are never considered close</span>
<span class="sd">        &gt;&gt;&gt; torch.testing.assert_close(actual.numpy(), expected)</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        TypeError: No comparison pair was able to handle inputs of type &lt;class &#39;numpy.ndarray&#39;&gt;</span>
<span class="sd">        and &lt;class &#39;torch.Tensor&#39;&gt;.</span>
<span class="sd">        &gt;&gt;&gt; # Exceptions to these rules are Python scalars. They can be checked regardless of</span>
<span class="sd">        &gt;&gt;&gt; # their type if check_dtype=False.</span>
<span class="sd">        &gt;&gt;&gt; torch.testing.assert_close(1.0, 1, check_dtype=False)</span>

<span class="sd">        &gt;&gt;&gt; # NaN != NaN by default.</span>
<span class="sd">        &gt;&gt;&gt; expected = torch.tensor(float(&quot;Nan&quot;))</span>
<span class="sd">        &gt;&gt;&gt; actual = expected.clone()</span>
<span class="sd">        &gt;&gt;&gt; torch.testing.assert_close(actual, expected)</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        AssertionError: Scalars are not close!</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        Absolute difference: nan (up to 1e-05 allowed)</span>
<span class="sd">        Relative difference: nan (up to 1.3e-06 allowed)</span>
<span class="sd">        &gt;&gt;&gt; torch.testing.assert_close(actual, expected, equal_nan=True)</span>

<span class="sd">        &gt;&gt;&gt; expected = torch.tensor([1.0, 2.0, 3.0])</span>
<span class="sd">        &gt;&gt;&gt; actual = torch.tensor([1.0, 4.0, 5.0])</span>
<span class="sd">        &gt;&gt;&gt; # The default error message can be overwritten.</span>
<span class="sd">        &gt;&gt;&gt; torch.testing.assert_close(actual, expected, msg=&quot;Argh, the tensors are not close!&quot;)</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        AssertionError: Argh, the tensors are not close!</span>
<span class="sd">        &gt;&gt;&gt; # If msg is a callable, it can be used to augment the generated message with</span>
<span class="sd">        &gt;&gt;&gt; # extra information</span>
<span class="sd">        &gt;&gt;&gt; torch.testing.assert_close(</span>
<span class="sd">        ...     actual, expected, msg=lambda msg: f&quot;Header\n\n{msg}\n\nFooter&quot;</span>
<span class="sd">        ... )</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        AssertionError: Header</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        Tensor-likes are not close!</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        Mismatched elements: 2 / 3 (66.7%)</span>
<span class="sd">        Greatest absolute difference: 2.0 at index (1,) (up to 1e-05 allowed)</span>
<span class="sd">        Greatest relative difference: 1.0 at index (1,) (up to 1.3e-06 allowed)</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        Footer</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Hide this function from `pytest`&#39;s traceback</span>
    <span class="n">__tracebackhide__</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">error_metas</span> <span class="o">=</span> <span class="n">not_close_error_metas</span><span class="p">(</span>
        <span class="n">actual</span><span class="p">,</span>
        <span class="n">expected</span><span class="p">,</span>
        <span class="n">pair_types</span><span class="o">=</span><span class="p">(</span>
            <span class="n">NonePair</span><span class="p">,</span>
            <span class="n">BooleanPair</span><span class="p">,</span>
            <span class="n">NumberPair</span><span class="p">,</span>
            <span class="n">TensorLikePair</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">allow_subclasses</span><span class="o">=</span><span class="n">allow_subclasses</span><span class="p">,</span>
        <span class="n">rtol</span><span class="o">=</span><span class="n">rtol</span><span class="p">,</span>
        <span class="n">atol</span><span class="o">=</span><span class="n">atol</span><span class="p">,</span>
        <span class="n">equal_nan</span><span class="o">=</span><span class="n">equal_nan</span><span class="p">,</span>
        <span class="n">check_device</span><span class="o">=</span><span class="n">check_device</span><span class="p">,</span>
        <span class="n">check_dtype</span><span class="o">=</span><span class="n">check_dtype</span><span class="p">,</span>
        <span class="n">check_layout</span><span class="o">=</span><span class="n">check_layout</span><span class="p">,</span>
        <span class="n">check_stride</span><span class="o">=</span><span class="n">check_stride</span><span class="p">,</span>
        <span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">error_metas</span><span class="p">:</span>
        <span class="c1"># TODO: compose all metas into one AssertionError</span>
        <span class="k">raise</span> <span class="n">error_metas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>


<div class="viewcode-block" id="assert_allclose"><a class="viewcode-back" href="../../../testing.html#torch.testing.assert_allclose">[docs]</a><span class="k">def</span> <span class="nf">assert_allclose</span><span class="p">(</span>
    <span class="n">actual</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">expected</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">rtol</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">atol</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">equal_nan</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    .. warning::</span>

<span class="sd">       :func:`torch.testing.assert_allclose` is deprecated since ``1.12`` and will be removed in a future release.</span>
<span class="sd">       Please use :func:`torch.testing.assert_close` instead. You can find detailed upgrade instructions</span>
<span class="sd">       `here &lt;https://github.com/pytorch/pytorch/issues/61844&gt;`_.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
        <span class="s2">&quot;`torch.testing.assert_allclose()` is deprecated since 1.12 and will be removed in a future release. &quot;</span>
        <span class="s2">&quot;Please use `torch.testing.assert_close()` instead. &quot;</span>
        <span class="s2">&quot;You can find detailed upgrade instructions in https://github.com/pytorch/pytorch/issues/61844.&quot;</span><span class="p">,</span>
        <span class="ne">FutureWarning</span><span class="p">,</span>
        <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">actual</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">actual</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">rtol</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">atol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rtol</span><span class="p">,</span> <span class="n">atol</span> <span class="o">=</span> <span class="n">default_tolerances</span><span class="p">(</span>
            <span class="n">actual</span><span class="p">,</span>
            <span class="n">expected</span><span class="p">,</span>
            <span class="n">dtype_precisions</span><span class="o">=</span><span class="p">{</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">float16</span><span class="p">:</span> <span class="p">(</span><span class="mf">1e-3</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">),</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">:</span> <span class="p">(</span><span class="mf">1e-4</span><span class="p">,</span> <span class="mf">1e-5</span><span class="p">),</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span> <span class="p">(</span><span class="mf">1e-5</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">),</span>
            <span class="p">},</span>
        <span class="p">)</span>

    <span class="n">torch</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_close</span><span class="p">(</span>
        <span class="n">actual</span><span class="p">,</span>
        <span class="n">expected</span><span class="p">,</span>
        <span class="n">rtol</span><span class="o">=</span><span class="n">rtol</span><span class="p">,</span>
        <span class="n">atol</span><span class="o">=</span><span class="n">atol</span><span class="p">,</span>
        <span class="n">equal_nan</span><span class="o">=</span><span class="n">equal_nan</span><span class="p">,</span>
        <span class="n">check_device</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">check_dtype</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">check_stride</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">msg</span><span class="o">=</span><span class="n">msg</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span></div>
</pre></div>

             </article>
             
            </div>
            <footer>
  

  

    <hr>

  

  <div role="contentinfo">
    <p>
        &copy; Copyright 2023, PyTorch Contributors.

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>
     

</footer>

          </div>
<script>

var match = window.location.href.match(/\/_[a-zA-Z0-9_]*.html|_dynamo/gi);
var url = window.location.href.lastIndexOf(match[match.length-1]);

if (url)
  {
    var div = '<div class="admonition note"><p class="admonition-title">Note</p><p><i class="fa fa-exclamation-circle" aria-hidden="true">&nbsp</i> This page describes an internal API which is not intended to be used outside of the PyTorch codebase and can be modified or removed without notice.</p></div>'
    document.getElementById("pytorch-article").insertAdjacentHTML('afterBegin', div)
  }
</script>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              
            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
         <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
         <script src="../../../_static/jquery.js"></script>
         <script src="../../../_static/underscore.js"></script>
         <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
         <script src="../../../_static/doctools.js"></script>
         <script src="../../../_static/clipboard.min.js"></script>
         <script src="../../../_static/copybutton.js"></script>
     

  

  <script type="text/javascript" src="../../../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 
<script script type="text/javascript">
  var collapsedSections = ['Developer Notes', 'Language Bindings', 'Libraries', 'Community'];
</script>

<img height="1" width="1" style="border-style:none;" alt="" src="https://www.googleadservices.com/pagead/conversion/795629140/?label=txkmCPmdtosBENSssfsC&amp;guid=ON&amp;script=0"/>


  <!-- Begin Footer -->

  <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
    <div class="container">
      <div class="row">
        <div class="col-md-4 text-center">
          <h2>Docs</h2>
          <p>Access comprehensive developer documentation for PyTorch</p>
          <a class="with-right-arrow" href="https://pytorch.org/docs/stable/index.html">View Docs</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Tutorials</h2>
          <p>Get in-depth tutorials for beginners and advanced developers</p>
          <a class="with-right-arrow" href="https://pytorch.org/tutorials">View Tutorials</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Resources</h2>
          <p>Find development resources and get your questions answered</p>
          <a class="with-right-arrow" href="https://pytorch.org/resources">View Resources</a>
        </div>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container footer-container">
      <div class="footer-logo-wrapper">
        <a href="https://pytorch.org/" class="footer-logo"></a>
      </div>

      <div class="footer-links-wrapper">
        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/">PyTorch</a></li>
            <li><a href="https://pytorch.org/get-started">Get Started</a></li>
            <li><a href="https://pytorch.org/features">Features</a></li>
            <li><a href="https://pytorch.org/ecosystem">Ecosystem</a></li>
            <li><a href="https://pytorch.org/blog/">Blog</a></li>
            <li><a href="https://github.com/pytorch/pytorch/blob/master/CONTRIBUTING.md">Contributing</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/resources">Resources</a></li>
            <li><a href="https://pytorch.org/tutorials">Tutorials</a></li>
            <li><a href="https://pytorch.org/docs/stable/index.html">Docs</a></li>
            <li><a href="https://discuss.pytorch.org" target="_blank">Discuss</a></li>
            <li><a href="https://github.com/pytorch/pytorch/issues" target="_blank">Github Issues</a></li>
            <li><a href="https://pytorch.org/assets/brand-guidelines/PyTorch-Brand-Guidelines.pdf" target="_blank">Brand Guidelines</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title">Stay up to date</li>
            <li><a href="https://www.facebook.com/pytorch" target="_blank">Facebook</a></li>
            <li><a href="https://twitter.com/pytorch" target="_blank">Twitter</a></li>
            <li><a href="https://www.youtube.com/pytorch" target="_blank">YouTube</a></li>
            <li><a href="https://www.linkedin.com/company/pytorch" target="_blank">LinkedIn</a></li>
          </ul>  
          </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title">PyTorch Podcasts</li>
            <li><a href="https://open.spotify.com/show/6UzHKeiy368jKfQMKKvJY5" target="_blank">Spotify</a></li>
            <li><a href="https://podcasts.apple.com/us/podcast/pytorch-developer-podcast/id1566080008" target="_blank">Apple</a></li>
            <li><a href="https://www.google.com/podcasts?feed=aHR0cHM6Ly9mZWVkcy5zaW1wbGVjYXN0LmNvbS9PQjVGa0lsOA%3D%3D" target="_blank">Google</a></li>
            <li><a href="https://music.amazon.com/podcasts/7a4e6f0e-26c2-49e9-a478-41bd244197d0/PyTorch-Developer-Podcast?" target="_blank">Amazon</a></li>
          </ul>
         </div>
        </div>
        
        <div class="privacy-policy">
          <ul>
            <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/terms/" target="_blank">Terms</a></li>
            <li class="privacy-policy-links">|</li>
            <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/privacy-policy/" target="_blank">Privacy</a></li>
          </ul>
        </div>
        <div class="copyright">
        <p>Â© Copyright The Linux Foundation. The PyTorch Foundation is a project of The Linux Foundation.
          For web site terms of use, trademark policy and other policies applicable to The PyTorch Foundation please see
          <a href="www.linuxfoundation.org/policies/">www.linuxfoundation.org/policies/</a>. The PyTorch Foundation supports the PyTorch open source
          project, which has been established as PyTorch Project a Series of LF Projects, LLC. For policies applicable to the PyTorch Project a Series of LF Projects, LLC,
          please see <a href="www.lfprojects.org/policies/">www.lfprojects.org/policies/</a>.</p>
      </div>
     </div>

  </footer>

  <div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebookâ€™s Cookies Policy applies. Learn more, including about available controls: <a href="https://www.facebook.com/policies/cookies/">Cookies Policy</a>.</p>
    <img class="close-button" src="../../../_static/images/pytorch-x.svg">
  </div>
</div>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>
            
          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li class="resources-mobile-menu-title" class="active">
            Docs
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/docs/stable/index.html">PyTorch</a>
            </li>

            <li>
              <a href="https://pytorch.org/audio/stable/index.html">torchaudio</a>
            </li>

            <li>
              <a href="https://pytorch.org/text/stable/index.html">torchtext</a>
            </li>

            <li>
              <a href="https://pytorch.org/vision/stable/index.html">torchvision</a>
            </li>

            <li>
              <a href="https://pytorch.org/torcharrow">torcharrow</a>
            </li>

            <li>
              <a href="https://pytorch.org/data">TorchData</a>
            </li>

            <li>
              <a href="https://pytorch.org/torchrec">TorchRec</a>
            </li>

            <li>
              <a href="https://pytorch.org/serve/">TorchServe</a>
            </li>

            <li>
              <a href="https://pytorch.org/torchx/">TorchX</a>
            </li>

            <li>
              <a href="https://pytorch.org/xla">PyTorch on XLA Devices</a>
            </li>
          </ul>

          <li class="resources-mobile-menu-title">
            Resources
          </li>
            
           <ul class="resources-mobile-menu-items">

            <li>
              <a href="https://pytorch.org/features">About</a>
            </li>

            <li>
              <a href="https://pytorch.org/foundation">PyTorch Foundation</a>
            </li>

            <li>
              <a href="https://pytorch.org/#community-module">Community</a>
            </li>

            <li>
              <a href="https://pytorch.org/community-stories">Community Stories</a>
            </li>

            <li>
              <a href="https://pytorch.org/resources">Developer Resources</a>
            </li>

            <li>
              <a href="https://pytorch.org/events">Events</a>
            </li>

            <li>
              <a href="https://discuss.pytorch.org/">Forums</a>
            </li>

            <li>
              <a href="https://pytorch.org/hub">Models (Beta)</a>
            </li>
          </ul>

          <li>
            <a href="https://github.com/pytorch/pytorch">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="../../../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>