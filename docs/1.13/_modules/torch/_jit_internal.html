


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta name="robots" content="noindex">
  <meta name="robots" content="noindex">
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>torch._jit_internal &mdash; PyTorch 1.13 documentation</title>
  

  
  
  
  
    <link rel="canonical" href="https://pytorch.org/docs/stable/_modules/torch/_jit_internal.html"/>
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.css" type="text/css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/katex-math.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/sphinx-dropdown.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/panels-bootstrap.min.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/jit.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />


  <!-- Google Analytics -->
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-117752657-2"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-117752657-2');
    </script>
  
  <!-- End Google Analytics -->
  


  
  <script src="../../_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../../_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>

          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li class="active docs-active">
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-orange-arrow">
                Docs
              </a>
              <div class="resources-dropdown-menu">
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/docs/stable/index.html">
                  <span class="dropdown-title">PyTorch</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/audio/stable/index.html">
                  <span class="dropdown-title">torchaudio</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/text/stable/index.html">
                  <span class="dropdown-title">torchtext</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/vision/stable/index.html">
                  <span class="dropdown-title">torchvision</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torcharrow">
                  <span class="dropdown-title">torcharrow</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/data">
                  <span class="dropdown-title">TorchData</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torchrec">
                  <span class="dropdown-title">TorchRec</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/serve/">
                  <span class="dropdown-title">TorchServe</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torchx/">
                  <span class="dropdown-title">TorchX</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/xla">
                  <span class="dropdown-title">PyTorch on XLA Devices</span>
                  <p></p>
                </a>
            </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-arrow">
                Resources
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/features">
                  <span class="dropdown-title">About</span>
                  <p>Learn about PyTorchâ€™s features and capabilities</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/foundation">
                  <span class="dropdown-title">PyTorch Foundation</span>
                  <p>Learn about the PyTorch foundation</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/#community-module">
                  <span class="dropdown-title">Community</span>
                  <p>Join the PyTorch developer community to contribute, learn, and get your questions answered.</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/community-stories">
                  <span class="dropdown-title">Community Stories</span>
                  <p>Learn how our community solves real, everyday machine learning problems with PyTorch.</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/resources">
                  <span class="dropdown-title">Developer Resources</span>
                  <p>Find resources and get questions answered</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/events">
                  <span class="dropdown-title">Events</span>
                  <p>Find events, webinars, and podcasts</p>
                </a>
                <a class="nav-dropdown-item" href="https://discuss.pytorch.org/" target="_blank">
                  <span class="dropdown-title">Forums</span>
                  <p>A place to discuss PyTorch code, issues, install, research</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/hub">
                  <span class="dropdown-title">Models (Beta)</span>
                  <p>Discover, publish, and reuse pre-trained models</p>
                </a>
              </div>
            </div>
          </li>

          <li>
            <a href="https://github.com/pytorch/pytorch">GitHub</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>

<body class="pytorch-body">

   

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            
    <div class="version">
      <a href='https://pytorch.org/docs/versions.html'>1.13 &#x25BC</a>
    </div>
    


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          </div>

          


            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Community</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../community/build_ci_governance.html">PyTorch Governance | Build + CI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../community/contribution_guide.html">PyTorch Contribution Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../community/design.html">PyTorch Design Philosophy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../community/governance.html">PyTorch Governance | Mechanics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../community/persons_of_interest.html">PyTorch Governance | Maintainers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../notes/amp_examples.html">CUDA Automatic Mixed Precision examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/autograd.html">Autograd mechanics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/broadcasting.html">Broadcasting semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/cpu_threading_torchscript_inference.html">CPU threading and TorchScript inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/cuda.html">CUDA semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/ddp.html">Distributed Data Parallel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/extending.html">Extending PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/gradcheck.html">Gradcheck mechanics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/hip.html">HIP (ROCm) semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/large_scale_deployments.html">Features for large-scale deployments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/modules.html">Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/mps.html">MPS backend</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/multiprocessing.html">Multiprocessing best practices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/numerical_accuracy.html">Numerical accuracy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/randomness.html">Reproducibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/serialization.html">Serialization semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/windows.html">Windows FAQ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Language Bindings</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../cpp_index.html">C++</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/javadoc/">Javadoc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deploy.html">torch::deploy</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Python API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../torch.html">torch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nn.html">torch.nn</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nn.functional.html">torch.nn.functional</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tensors.html">torch.Tensor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tensor_attributes.html">Tensor Attributes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tensor_view.html">Tensor Views</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../amp.html">torch.amp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../autograd.html">torch.autograd</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../library.html">torch.library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cuda.html">torch.cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../backends.html">torch.backends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../distributed.html">torch.distributed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../distributed.algorithms.join.html">torch.distributed.algorithms.join</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../distributed.elastic.html">torch.distributed.elastic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fsdp.html">torch.distributed.fsdp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../distributed.optim.html">torch.distributed.optim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../distributions.html">torch.distributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fft.html">torch.fft</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../futures.html">torch.futures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fx.html">torch.fx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hub.html">torch.hub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../jit.html">torch.jit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../linalg.html">torch.linalg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../monitor.html">torch.monitor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../special.html">torch.special</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../torch.overrides.html">torch.overrides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../package.html">torch.package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../profiler.html">torch.profiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nn.init.html">torch.nn.init</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../onnx.html">torch.onnx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../optim.html">torch.optim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../complex_numbers.html">Complex Numbers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ddp_comm_hooks.html">DDP Communication Hooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pipeline.html">Pipeline Parallelism</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quantization.html">Quantization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rpc.html">Distributed RPC Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../random.html">torch.random</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../masked.html">torch.masked</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nested.html">torch.nested</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sparse.html">torch.sparse</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../storage.html">torch.Storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing.html">torch.testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../benchmark_utils.html">torch.utils.benchmark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bottleneck.html">torch.utils.bottleneck</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../checkpoint.html">torch.utils.checkpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cpp_extension.html">torch.utils.cpp_extension</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data.html">torch.utils.data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../jit_utils.html">torch.utils.jit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dlpack.html">torch.utils.dlpack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mobile_optimizer.html">torch.utils.mobile_optimizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_zoo.html">torch.utils.model_zoo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tensorboard.html">torch.utils.tensorboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../type_info.html">Type Info</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../named_tensor.html">Named Tensors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../name_inference.html">Named Tensors operator coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../config_mod.html">torch.__config__</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Libraries</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/audio/stable">torchaudio</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/data">TorchData</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/torchrec">TorchRec</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/serve">TorchServe</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/text/stable">torchtext</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/vision/stable">torchvision</a></li>
<li class="toctree-l1"><a class="reference external" href="http://pytorch.org/xla/">PyTorch on XLA Devices</a></li>
</ul>

            
          

        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="../../index.html">
          
            Docs
          
        </a> &gt;
      </li>

        
          <li><a href="../index.html">Module code</a> &gt;</li>
        
          <li><a href="../torch.html">torch</a> &gt;</li>
        
      <li>torch._jit_internal</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">

        
          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <h1>Source code for torch._jit_internal</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The weak_script annotation needs to be here instead of inside torch/jit/ so it</span>
<span class="sd">can be used in other places in torch/ (namely torch.nn) without running into</span>
<span class="sd">circular dependency problems</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">builtins</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">enum</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">weakref</span>
<span class="kn">from</span> <span class="nn">textwrap</span> <span class="kn">import</span> <span class="n">dedent</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>  <span class="c1"># noqa: F401</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Generic</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">Type</span><span class="p">,</span>
    <span class="n">TypeVar</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">torch</span>

<span class="c1"># This is needed. `torch._jit_internal` is imported before `torch.distributed.__init__`.</span>
<span class="c1"># Explicitly ask to import `torch.distributed.__init__` first.</span>
<span class="c1"># Otherwise, &quot;AttributeError: module &#39;torch&#39; has no attribute &#39;distributed&#39;&quot; is raised.</span>
<span class="kn">import</span> <span class="nn">torch.distributed.rpc</span>
<span class="kn">import</span> <span class="nn">torch.package._mangling</span> <span class="k">as</span> <span class="nn">package_mangling</span>
<span class="kn">from</span> <span class="nn">torch._C</span> <span class="kn">import</span> <span class="n">Future</span> <span class="k">as</span> <span class="n">CFuture</span>
<span class="kn">from</span> <span class="nn">torch._sources</span> <span class="kn">import</span> <span class="n">fake_range</span><span class="p">,</span> <span class="n">get_source_lines_and_file</span><span class="p">,</span> <span class="n">parse_def</span>
<span class="kn">from</span> <span class="nn">torch.futures</span> <span class="kn">import</span> <span class="n">Future</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Final</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">typing_extensions</span> <span class="kn">import</span> <span class="n">Final</span>

<span class="n">LockType</span><span class="p">:</span> <span class="n">Type</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">_thread</span>

    <span class="n">LockType</span> <span class="o">=</span> <span class="n">_thread</span><span class="o">.</span><span class="n">LockType</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">_dummy_thread</span>

    <span class="n">LockType</span> <span class="o">=</span> <span class="n">_dummy_thread</span><span class="o">.</span><span class="n">LockType</span>

<span class="c1"># Wrapper functions that can call either of 2 functions depending on a boolean</span>
<span class="c1"># argument</span>
<span class="n">boolean_dispatched</span><span class="p">:</span> <span class="s2">&quot;weakref.WeakKeyDictionary[Callable, Dict[str, Callable]]&quot;</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">()</span>
<span class="p">)</span>  <span class="c1"># noqa: T484</span>


<span class="n">FAKE_FILENAME_PREFIX</span> <span class="o">=</span> <span class="s2">&quot;__torch_jit_dataclass&quot;</span>


<span class="k">class</span> <span class="nc">SourceLoader</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="n">fn</span><span class="p">]</span> <span class="o">=</span> <span class="n">source</span>

    <span class="k">def</span> <span class="nf">get_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>


<span class="n">loader</span> <span class="o">=</span> <span class="n">SourceLoader</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">createResolutionCallbackFromEnv</span><span class="p">(</span><span class="n">lookup_base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a resolution callback that will look up qualified names in an</span>
<span class="sd">    environment, starting with `lookup_base` for the base of any qualified</span>
<span class="sd">    names, then proceeding down the lookup chain with the resolved object.</span>

<span class="sd">    You should not use this directly, it should only be used from the other</span>
<span class="sd">    createResolutionCallbackFrom* functions.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">lookupInModule</span><span class="p">(</span><span class="n">qualified_name</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">qualified_name</span><span class="p">:</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">qualified_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
            <span class="n">base</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">remaining_pieces</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="n">module_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">lookupInModule</span><span class="p">(</span><span class="n">remaining_pieces</span><span class="p">,</span> <span class="n">module_value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">qualified_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">parseNestedExpr</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">module</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span> <span class="ow">and</span> <span class="n">expr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;[&quot;</span><span class="p">,</span> <span class="s2">&quot;]&quot;</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Special case logic for the empty Tuple as a subscript (used</span>
        <span class="c1"># in the type annotation `Tuple[()]`)</span>
        <span class="k">if</span> <span class="n">expr</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;()&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(),</span> <span class="n">i</span>

        <span class="n">base</span> <span class="o">=</span> <span class="n">lookupInModule</span><span class="p">(</span><span class="n">expr</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">module</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Unresolvable type </span><span class="si">{</span><span class="n">expr</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span> <span class="ow">or</span> <span class="n">expr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;[&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">base</span><span class="p">,</span> <span class="n">i</span>

        <span class="k">assert</span> <span class="n">expr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;[&quot;</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="n">expr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;]&quot;</span><span class="p">:</span>
            <span class="n">part_len</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">part</span><span class="p">,</span> <span class="n">part_len</span> <span class="o">=</span> <span class="n">parseNestedExpr</span><span class="p">(</span><span class="n">expr</span><span class="p">[</span><span class="n">i</span><span class="p">:],</span> <span class="n">module</span><span class="p">)</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="n">part_len</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">base</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">parts</span><span class="p">)],</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">base</span><span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">parseExpr</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span><span class="p">,</span> <span class="n">len_parsed</span> <span class="o">=</span> <span class="n">parseNestedExpr</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">module</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">len_parsed</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span>
                <span class="n">expr</span>
            <span class="p">),</span> <span class="s2">&quot;whole expression was not parsed, falling back to c++ parser&quot;</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            The python resolver fails in several cases in known unit tests, and is intended</span>
<span class="sd">            to fall back gracefully to the c++ resolver in general.  For example, python 2 style</span>
<span class="sd">            annotations which are frequent in our unit tests often fail with types e.g. int not</span>
<span class="sd">            resolvable from the calling frame.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="k">lambda</span> <span class="n">expr</span><span class="p">:</span> <span class="n">parseExpr</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">lookup_base</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">createResolutionCallbackFromFrame</span><span class="p">(</span><span class="n">frames_up</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a function which, given a string variable name,</span>
<span class="sd">    returns the value of the variable in the scope of the caller of</span>
<span class="sd">    the function which called createResolutionCallbackFromFrame (by default).</span>

<span class="sd">    This is used to enable access in-scope Python variables inside</span>
<span class="sd">    TorchScript fragments.</span>

<span class="sd">    frames_up is number of additional frames to go up on the stack.</span>
<span class="sd">    The default value is 0, which correspond to the frame of the caller</span>
<span class="sd">    of createResolutionCallbackFromFrame. Also for example, if frames_up is set</span>
<span class="sd">    to 1, then the frame of the caller&#39;s caller of createResolutionCallbackFromFrame</span>
<span class="sd">    will be taken.</span>

<span class="sd">    For example, the following program prints 2::</span>

<span class="sd">        def bar():</span>
<span class="sd">            cb = createResolutionCallbackFromFrame(1)</span>
<span class="sd">            print(cb(&quot;foo&quot;))</span>

<span class="sd">        def baz():</span>
<span class="sd">            foo = 2</span>
<span class="sd">            bar()</span>

<span class="sd">        baz()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">frame</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">frames_up</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">frame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_back</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">assert</span> <span class="n">frame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="n">f_locals</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span>
    <span class="n">f_globals</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_globals</span>

    <span class="k">class</span> <span class="nc">env</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f_locals</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">f_locals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f_globals</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">f_globals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">builtins</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">builtins</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">createResolutionCallbackFromEnv</span><span class="p">(</span><span class="n">env</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">get_closure</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a dictionary of closed over variables from a function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">captures</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">captures</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">captured_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="vm">__code__</span><span class="o">.</span><span class="n">co_freevars</span><span class="p">):</span>
        <span class="n">captures</span><span class="p">[</span><span class="n">captured_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="vm">__closure__</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">cell_contents</span>

    <span class="k">return</span> <span class="n">captures</span>


<span class="c1"># [local resolution in python]</span>
<span class="c1"># Depending on where a variable is defined, and where it is used, we may</span>
<span class="c1"># or may not be able to recover its value when recursively compiling a</span>
<span class="c1"># script function. Remember in the general case, a module or function is</span>
<span class="c1"># first defined and then later scripted. This means we do not have a</span>
<span class="c1"># chance to capture the active frames when the function is defined. Hence any</span>
<span class="c1"># name resolution has to happen later on the created closure. The way</span>
<span class="c1"># python captures type annotations restricts what we can recover. The</span>
<span class="c1"># follow example illustrates the different cases:</span>
<span class="c1">#</span>
<span class="c1">#         class MyGlobalClass:</span>
<span class="c1">#         ...</span>
<span class="c1">#         def my_local_scope():</span>
<span class="c1">#             @torch.jit.script</span>
<span class="c1">#             class MyClass:</span>
<span class="c1">#                 ...</span>
<span class="c1">#             @torch.jit.script</span>
<span class="c1">#             class MyClassUsedAsVar:</span>
<span class="c1">#                 ...</span>
<span class="c1">#             def eg(x: MyClass, y: MyGlobalClass):</span>
<span class="c1">#                 a_local_capture : Foo</span>
<span class="c1">#                 return MyClassUsedAsVar(x)</span>
<span class="c1">#</span>
<span class="c1"># MyGlobalClass is defined in the __globals__ dictionary of function</span>
<span class="c1"># &#39;eg&#39;, so it is always recoverable. my_local_scope introduces a new local</span>
<span class="c1"># variable scope in the function. Classes defined here are only visible as</span>
<span class="c1"># local variables. For the case of MyClassUsedAsVar, it is captured</span>
<span class="c1"># because it is used as a variable inside the body of the function, and we</span>
<span class="c1"># can resolve it using the captures returned from `get_closure`. However,</span>
<span class="c1"># the type annotations are not captured by the closure. In Python</span>
<span class="c1"># 3.0--3.9, the _value_ of MyClass and MyGlobalClass will be available as</span>
<span class="c1"># annotations on `eg``, but starting in Python 4.0, they will represented as</span>
<span class="c1"># strings and no longer present. Furthermore, since the body of `eg` does</span>
<span class="c1"># not reference those names, they do not appear in the list of closed over</span>
<span class="c1"># variables. In Python 2.x, type annotations are in comments, leading to a</span>
<span class="c1"># similar situation where their definitions are not available. We anticipate</span>
<span class="c1"># that most users will not run into this issue because their modules and</span>
<span class="c1"># functions will be defined at a global scope like MyGlobalClass. In cases</span>
<span class="c1"># where they are not, it is possible to work around issues by declaring the</span>
<span class="c1"># values global in the function.</span>
<span class="c1"># In Python 3.9 declaring class as global will make it invisible to</span>
<span class="c1"># `inspect.getsource`, see https://bugs.python.org/issue42666 .</span>
<span class="c1"># This could be worked around by manualy adding it to `global()` dictionary.</span>


<span class="k">def</span> <span class="nf">createResolutionCallbackFromClosure</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a resolutionCallback by introspecting the function instead of</span>
<span class="sd">    looking up the stack for the enclosing scope</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">closure</span> <span class="o">=</span> <span class="n">get_closure</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">closure_lookup</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="c1"># This is a class since `closure` is a dict and it&#39;s easier in</span>
        <span class="c1"># `env_helper` if everything just works with `getattr` calls</span>
        <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">closure</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">closure</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">typing</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">typing</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">builtins</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">builtins</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">createResolutionCallbackFromEnv</span><span class="p">(</span><span class="n">closure_lookup</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">can_compile_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="c1"># If any of the functions on a type don&#39;t have a code object, this type can&#39;t</span>
    <span class="c1"># be compiled and is probably a builtin / bound from C</span>
    <span class="k">if</span> <span class="n">is_ignored_fn</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Ignore the following list of built-in classes.</span>
    <span class="n">ignored_builtin_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">ignored_builtin_classes</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">names</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span>
    <span class="n">fns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isroutine</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
    <span class="p">]</span>
    <span class="n">has_code</span> <span class="o">=</span> <span class="p">[</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s2">&quot;__code__&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">fns</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">has_code</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_callable_argument_names</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets names of all POSITIONAL_OR_KEYWORD arguments for callable `fn`.</span>
<span class="sd">    Returns an empty list when other types of arguments are present.</span>

<span class="sd">    This is used by `torch.jit.trace` to assign meaningful argument names to</span>
<span class="sd">    traced functions and modules.</span>

<span class="sd">    Args:</span>
<span class="sd">        fn: A callable.</span>
<span class="sd">    Returns:</span>
<span class="sd">        Argument names: List[str]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># inspect.signature may fail, give up in that case.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">callable_signature</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="n">argument_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">callable_signature</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># All four other types of arguments do not map to individual values</span>
        <span class="c1"># with a keyword as name.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">param</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">param</span><span class="o">.</span><span class="n">POSITIONAL_OR_KEYWORD</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">argument_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">argument_names</span>


<span class="k">def</span> <span class="nf">get_annotation_str</span><span class="p">(</span><span class="n">annotation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert an AST node containing a type annotation to the string present in the source</span>
<span class="sd">    that represents the same annotation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">annotation</span><span class="o">.</span><span class="n">id</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Attribute</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">get_annotation_str</span><span class="p">(</span><span class="n">annotation</span><span class="o">.</span><span class="n">value</span><span class="p">),</span> <span class="n">annotation</span><span class="o">.</span><span class="n">attr</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Subscript</span><span class="p">):</span>
        <span class="c1"># In Python3.9+ subscript indicies are not wrapped in ast.Index</span>
        <span class="n">subscript_slice</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="n">slice</span> <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="k">else</span> <span class="n">annotation</span><span class="o">.</span><span class="n">slice</span><span class="o">.</span><span class="n">value</span>  <span class="c1"># type: ignore[attr-defined]</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">get_annotation_str</span><span class="p">(</span><span class="n">annotation</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">get_annotation_str</span><span class="p">(</span><span class="n">subscript_slice</span><span class="p">)</span><span class="si">}</span><span class="s2">]&quot;</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Tuple</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">get_annotation_str</span><span class="p">(</span><span class="n">elt</span><span class="p">)</span> <span class="k">for</span> <span class="n">elt</span> <span class="ow">in</span> <span class="n">annotation</span><span class="o">.</span><span class="n">elts</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Constant</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="n">annotation</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">NameConstant</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">annotation</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># If an AST node is not handled here, it&#39;s probably handled in ScriptTypeParser.</span>
    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">get_type_hint_captures</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a dictionary containing type resolution mappings necessary to resolve types</span>
<span class="sd">    for the literal annotations on &#39;fn&#39;. These are not considered to be closed-over by fn</span>
<span class="sd">    and must be obtained separately (e.g. using this function).</span>

<span class="sd">    Args:</span>
<span class="sd">        fn: A callable.</span>
<span class="sd">    Returns:</span>
<span class="sd">        A Dict[str, Any] containing a mapping from the literal annotations used on</span>
<span class="sd">        fn to the Python objects they refer to.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># First, try to get the source of the function. We&#39;ll need to parse it to find the actual string names</span>
    <span class="c1"># that were used to annotate the types, since inspect.signature() will only return the class object that</span>
    <span class="c1"># the annotation refers to, not the string name. If we can&#39;t get the source, simply return an empty dict.</span>
    <span class="c1"># This may happen in cases where the function is synthesized dynamically at runtime.</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_source</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">src</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

    <span class="c1"># Gather a dictionary of parameter name -&gt; type, skipping any parameters whose annotated</span>
    <span class="c1"># types are strings. These are only understood by TorchScript in the context of a type annotation</span>
    <span class="c1"># that refers to a class in its own definition, but trying to include a mapping for this in the result</span>
    <span class="c1"># function would cause infinite recursion because the class is currently being compiled.</span>
    <span class="c1"># In addition, there is logic in ScriptTypeParser to handle this.</span>
    <span class="n">signature</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="n">name_to_type</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">parameter</span><span class="o">.</span><span class="n">annotation</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">signature</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">parameter</span><span class="o">.</span><span class="n">annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span>
        <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parameter</span><span class="o">.</span><span class="n">annotation</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1"># Then, get the literal type annotations from the function declaration</span>
    <span class="c1"># by source inspection. This accounts for the case in which aliases are used</span>
    <span class="c1"># to annotate the arguments (e.g device_t = torch.device, and then d: device_t).</span>
    <span class="c1"># frontend.py cannot be used here because it includes _jit_internal, so use ast instead.</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">dedent</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">body</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2"> to be a function&quot;</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Prepare a dictionary of source annotation -&gt; type, which will be the final result of this function,</span>
    <span class="c1"># by using the parsed AST (f) to reconstruct source annotations as strings for each parameter and mapping</span>
    <span class="c1"># them to the type object corresponding to the annotation via name_to_type using the parameter name.</span>
    <span class="n">annotation_to_type</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="c1"># Get the source type annotation string for this argument if possible.</span>
        <span class="n">arg_annotation_str</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">get_annotation_str</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">annotation</span><span class="p">)</span> <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">annotation</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>

        <span class="c1"># If the argument has no annotation or get_annotation_str cannot convert it to a string,</span>
        <span class="c1"># arg_annotation_str will be None. Skip this arg; ScriptTypeParser will probably handle</span>
        <span class="c1"># this in the latter case.</span>
        <span class="k">if</span> <span class="n">arg_annotation_str</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Insert {arg_annotation_str: type} into annotation_to_type if possible. One reason arg_name may not</span>
        <span class="c1"># be present in name_to_type is that the annotation itself is a string and not a type object</span>
        <span class="c1"># (common for self-refential annotations in classes). Once again, let ScriptTypeParser handle this.</span>
        <span class="n">arg_name</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">arg</span>
        <span class="k">if</span> <span class="n">arg_name</span> <span class="ow">in</span> <span class="n">name_to_type</span><span class="p">:</span>
            <span class="n">annotation_to_type</span><span class="p">[</span><span class="n">arg_annotation_str</span><span class="p">]</span> <span class="o">=</span> <span class="n">name_to_type</span><span class="p">[</span><span class="n">arg_name</span><span class="p">]</span>

    <span class="c1"># If there is a valid return annotation, include it in annotation_to_type. As with argument annotations,</span>
    <span class="c1"># the literal annotation has to be convertible to a string by get_annotation_str, and the actual type</span>
    <span class="c1"># of the annotation cannot be a string.</span>
    <span class="n">literal_return_annotation</span> <span class="o">=</span> <span class="n">get_annotation_str</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">returns</span><span class="p">)</span>
    <span class="n">valid_literal_annotation</span> <span class="o">=</span> <span class="n">literal_return_annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="n">return_annotation</span> <span class="o">=</span> <span class="n">signature</span><span class="o">.</span><span class="n">return_annotation</span>
    <span class="n">valid_return_annotation_type</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">return_annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span>
        <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">return_annotation</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">valid_literal_annotation</span> <span class="ow">and</span> <span class="n">valid_return_annotation_type</span><span class="p">:</span>
        <span class="n">annotation_to_type</span><span class="p">[</span><span class="n">literal_return_annotation</span><span class="p">]</span> <span class="o">=</span> <span class="n">return_annotation</span>

    <span class="k">return</span> <span class="n">annotation_to_type</span>


<span class="k">def</span> <span class="nf">createResolutionCallbackForClassMethods</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This looks at all the methods defined in a class and pulls their closed-over</span>
<span class="sd">    variables into a dictionary and uses that to resolve variables.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># cls is a type here, so `ismethod` is false since the methods on the type</span>
    <span class="c1"># aren&#39;t bound to anything, so Python treats them as regular functions</span>
    <span class="n">fns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isroutine</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
    <span class="p">]</span>
    <span class="n">captures</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">fns</span><span class="p">:</span>
        <span class="n">captures</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">get_closure</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>
        <span class="n">captures</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">get_type_hint_captures</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">lookup_in_class</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">captures</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">captures</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">builtins</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">lookup_in_class</span>


<span class="k">def</span> <span class="nf">boolean_dispatch</span><span class="p">(</span>
    <span class="n">arg_name</span><span class="p">,</span> <span class="n">arg_index</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">if_true</span><span class="p">,</span> <span class="n">if_false</span><span class="p">,</span> <span class="n">module_name</span><span class="p">,</span> <span class="n">func_name</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dispatches to either of 2 script functions based on a boolean argument.</span>
<span class="sd">    In TorchScript, the boolean argument must be constant so that the correct</span>
<span class="sd">    function to use can be determined at compile time.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">dispatch_flag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">arg_name</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">dispatch_flag</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">arg_name</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">arg_index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="n">dispatch_flag</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="n">arg_index</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">dispatch_flag</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">if_true</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">if_false</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">if_true</span><span class="o">.</span><span class="vm">__doc__</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">if_false</span><span class="o">.</span><span class="vm">__doc__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">if_false</span><span class="o">.</span><span class="vm">__doc__</span>
        <span class="n">if_true</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">doc</span>
    <span class="k">elif</span> <span class="n">if_false</span><span class="o">.</span><span class="vm">__doc__</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">if_true</span><span class="o">.</span><span class="vm">__doc__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">if_true</span><span class="o">.</span><span class="vm">__doc__</span>
        <span class="n">if_false</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">doc</span>
    <span class="k">elif</span> <span class="n">if_false</span><span class="o">.</span><span class="vm">__doc__</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">if_true</span><span class="o">.</span><span class="vm">__doc__</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># neither function has a docstring</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;only one function can have a docstring&quot;</span><span class="p">)</span>
    <span class="n">fn</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">doc</span>

    <span class="k">if</span> <span class="n">module_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fn</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">=</span> <span class="n">module_name</span>
    <span class="k">if</span> <span class="n">func_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="n">func_name</span>

    <span class="n">boolean_dispatched</span><span class="p">[</span><span class="n">fn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;if_true&quot;</span><span class="p">:</span> <span class="n">if_true</span><span class="p">,</span>
        <span class="s2">&quot;if_false&quot;</span><span class="p">:</span> <span class="n">if_false</span><span class="p">,</span>
        <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">arg_index</span><span class="p">,</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="n">default</span><span class="p">,</span>
        <span class="s2">&quot;arg_name&quot;</span><span class="p">:</span> <span class="n">arg_name</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">fn</span>


<span class="k">class</span> <span class="nc">FunctionModifiers</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Used to denote the behavior of a function in TorchScript. See export() and</span>
<span class="sd">    ignore() for details.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">UNUSED</span> <span class="o">=</span> <span class="s2">&quot;unused (ignored and replaced with raising of an exception)&quot;</span>
    <span class="n">IGNORE</span> <span class="o">=</span> <span class="s2">&quot;ignore (leave as a call to Python, cannot be torch.jit.save&#39;d)&quot;</span>
    <span class="n">EXPORT</span> <span class="o">=</span> <span class="s2">&quot;export (compile this function even if nothing calls it)&quot;</span>
    <span class="n">DEFAULT</span> <span class="o">=</span> <span class="s2">&quot;default (compile if called from a exported function / forward)&quot;</span>
    <span class="n">COPY_TO_SCRIPT_WRAPPER</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;if this method is not scripted, copy the python method onto the scripted model&quot;</span>
    <span class="p">)</span>


<div class="viewcode-block" id="export"><a class="viewcode-back" href="../../jit.html#torch.jit.export">[docs]</a><span class="k">def</span> <span class="nf">export</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This decorator indicates that a method on an ``nn.Module`` is used as an entry point into a</span>
<span class="sd">    :class:`ScriptModule` and should be compiled.</span>

<span class="sd">    ``forward`` implicitly is assumed to be an entry point, so it does not need this decorator.</span>
<span class="sd">    Functions and methods called from ``forward`` are compiled as they are seen</span>
<span class="sd">    by the compiler, so they do not need this decorator either.</span>

<span class="sd">    Example (using ``@torch.jit.export`` on a method):</span>

<span class="sd">    .. testcode::</span>

<span class="sd">        import torch</span>
<span class="sd">        import torch.nn as nn</span>

<span class="sd">        class MyModule(nn.Module):</span>
<span class="sd">            def implicitly_compiled_method(self, x):</span>
<span class="sd">                return x + 99</span>

<span class="sd">            # `forward` is implicitly decorated with `@torch.jit.export`,</span>
<span class="sd">            # so adding it here would have no effect</span>
<span class="sd">            def forward(self, x):</span>
<span class="sd">                return x + 10</span>

<span class="sd">            @torch.jit.export</span>
<span class="sd">            def another_forward(self, x):</span>
<span class="sd">                # When the compiler sees this call, it will compile</span>
<span class="sd">                # `implicitly_compiled_method`</span>
<span class="sd">                return self.implicitly_compiled_method(x)</span>

<span class="sd">            def unused_method(self, x):</span>
<span class="sd">                return x - 20</span>

<span class="sd">        # `m` will contain compiled methods:</span>
<span class="sd">        #     `forward`</span>
<span class="sd">        #     `another_forward`</span>
<span class="sd">        #     `implicitly_compiled_method`</span>
<span class="sd">        # `unused_method` will not be compiled since it was not called from</span>
<span class="sd">        # any compiled methods and wasn&#39;t decorated with `@torch.jit.export`</span>
<span class="sd">        m = torch.jit.script(MyModule())</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fn</span><span class="o">.</span><span class="n">_torchscript_modifier</span> <span class="o">=</span> <span class="n">FunctionModifiers</span><span class="o">.</span><span class="n">EXPORT</span>
    <span class="k">return</span> <span class="n">fn</span></div>


<div class="viewcode-block" id="unused"><a class="viewcode-back" href="../../generated/torch.jit.unused.html#torch.jit.unused">[docs]</a><span class="k">def</span> <span class="nf">unused</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This decorator indicates to the compiler that a function or method should</span>
<span class="sd">    be ignored and replaced with the raising of an exception. This allows you</span>
<span class="sd">    to leave code in your model that is not yet TorchScript compatible and still</span>
<span class="sd">    export your model.</span>

<span class="sd">        Example (using ``@torch.jit.unused`` on a method)::</span>

<span class="sd">            import torch</span>
<span class="sd">            import torch.nn as nn</span>

<span class="sd">            class MyModule(nn.Module):</span>
<span class="sd">                def __init__(self, use_memory_efficient):</span>
<span class="sd">                    super(MyModule, self).__init__()</span>
<span class="sd">                    self.use_memory_efficient = use_memory_efficient</span>

<span class="sd">                @torch.jit.unused</span>
<span class="sd">                def memory_efficient(self, x):</span>
<span class="sd">                    import pdb</span>
<span class="sd">                    pdb.set_trace()</span>
<span class="sd">                    return x + 10</span>

<span class="sd">                def forward(self, x):</span>
<span class="sd">                    # Use not-yet-scriptable memory efficient mode</span>
<span class="sd">                    if self.use_memory_efficient:</span>
<span class="sd">                        return self.memory_efficient(x)</span>
<span class="sd">                    else:</span>
<span class="sd">                        return x + 10</span>

<span class="sd">            m = torch.jit.script(MyModule(use_memory_efficient=False))</span>
<span class="sd">            m.save(&quot;m.pt&quot;)</span>

<span class="sd">            m = torch.jit.script(MyModule(use_memory_efficient=True))</span>
<span class="sd">            # exception raised</span>
<span class="sd">            m(torch.rand(100))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="nb">property</span><span class="p">):</span>
        <span class="n">prop</span> <span class="o">=</span> <span class="n">fn</span>
        <span class="nb">setattr</span><span class="p">(</span>  <span class="c1"># noqa: B010</span>
            <span class="n">prop</span><span class="o">.</span><span class="n">fget</span><span class="p">,</span> <span class="s2">&quot;_torchscript_modifier&quot;</span><span class="p">,</span> <span class="n">FunctionModifiers</span><span class="o">.</span><span class="n">UNUSED</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">prop</span><span class="o">.</span><span class="n">fset</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span>  <span class="c1"># noqa: B010</span>
                <span class="n">prop</span><span class="o">.</span><span class="n">fset</span><span class="p">,</span> <span class="s2">&quot;_torchscript_modifier&quot;</span><span class="p">,</span> <span class="n">FunctionModifiers</span><span class="o">.</span><span class="n">UNUSED</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">prop</span>

    <span class="n">fn</span><span class="o">.</span><span class="n">_torchscript_modifier</span> <span class="o">=</span> <span class="n">FunctionModifiers</span><span class="o">.</span><span class="n">UNUSED</span>
    <span class="k">return</span> <span class="n">fn</span></div>


<span class="c1"># No op context manager from python side</span>
<span class="k">class</span> <span class="nc">_IgnoreContextManager</span><span class="p">(</span><span class="n">contextlib</span><span class="o">.</span><span class="n">AbstractContextManager</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">traceback</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>


<div class="viewcode-block" id="ignore"><a class="viewcode-back" href="../../generated/torch.jit.ignore.html#torch.jit.ignore">[docs]</a><span class="k">def</span> <span class="nf">ignore</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This decorator indicates to the compiler that a function or method should</span>
<span class="sd">    be ignored and left as a Python function. This allows you to leave code in</span>
<span class="sd">    your model that is not yet TorchScript compatible. If called from TorchScript,</span>
<span class="sd">    ignored functions will dispatch the call to the Python interpreter. Models with ignored</span>
<span class="sd">    functions cannot be exported; use :func:`@torch.jit.unused &lt;torch.jit.unused&gt;` instead.</span>

<span class="sd">    Example (using ``@torch.jit.ignore`` on a method)::</span>

<span class="sd">        import torch</span>
<span class="sd">        import torch.nn as nn</span>

<span class="sd">        class MyModule(nn.Module):</span>
<span class="sd">            @torch.jit.ignore</span>
<span class="sd">            def debugger(self, x):</span>
<span class="sd">                import pdb</span>
<span class="sd">                pdb.set_trace()</span>

<span class="sd">            def forward(self, x):</span>
<span class="sd">                x += 10</span>
<span class="sd">                # The compiler would normally try to compile `debugger`,</span>
<span class="sd">                # but since it is `@ignore`d, it will be left as a call</span>
<span class="sd">                # to Python</span>
<span class="sd">                self.debugger(x)</span>
<span class="sd">                return x</span>

<span class="sd">        m = torch.jit.script(MyModule())</span>

<span class="sd">        # Error! The call `debugger` cannot be saved since it calls into Python</span>
<span class="sd">        m.save(&quot;m.pt&quot;)</span>

<span class="sd">    Example (using ``@torch.jit.ignore(drop=True)`` on a method):</span>

<span class="sd">    .. testcode::</span>

<span class="sd">        import torch</span>
<span class="sd">        import torch.nn as nn</span>

<span class="sd">        class MyModule(nn.Module):</span>
<span class="sd">            @torch.jit.ignore(drop=True)</span>
<span class="sd">            def training_method(self, x):</span>
<span class="sd">                import pdb</span>
<span class="sd">                pdb.set_trace()</span>

<span class="sd">            def forward(self, x):</span>
<span class="sd">                if self.training:</span>
<span class="sd">                    self.training_method(x)</span>
<span class="sd">                return x</span>

<span class="sd">        m = torch.jit.script(MyModule())</span>

<span class="sd">        # This is OK since `training_method` is not saved, the call is replaced</span>
<span class="sd">        # with a `raise`.</span>
<span class="sd">        m.save(&quot;m.pt&quot;)</span>

<span class="sd">    .. testcleanup::</span>

<span class="sd">        import os</span>
<span class="sd">        os.remove(&#39;m.pt&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">drop</span><span class="p">):</span>
        <span class="c1"># used without any args, so drop is actually a function</span>
        <span class="c1">#   @torch.jit.ignore</span>
        <span class="c1">#   def fn(...):</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">drop</span>
        <span class="n">fn</span><span class="o">.</span><span class="n">_torchscript_modifier</span> <span class="o">=</span> <span class="n">FunctionModifiers</span><span class="o">.</span><span class="n">IGNORE</span>
        <span class="k">return</span> <span class="n">fn</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">drop</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;Argument to @torch.jit.ignore must be a bool or &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;a function but got </span><span class="si">{</span><span class="n">drop</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="c1"># for backwards compat</span>
    <span class="n">drop_on_export</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;drop_on_export&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">drop_on_export</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;ignore(drop_on_export=True) has been deprecated. TorchScript will now drop the function &quot;</span>
            <span class="s2">&quot;call on compilation. Use torch.jit.unused now. </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">drop</span> <span class="o">=</span> <span class="n">drop_on_export</span>
    <span class="k">elif</span> <span class="n">drop</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;ignore(True) has been deprecated. TorchScript will now drop the function &quot;</span>
            <span class="s2">&quot;call on compilation. Use torch.jit.unused now. </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">drop</span><span class="p">:</span>
            <span class="n">fn</span><span class="o">.</span><span class="n">_torchscript_modifier</span> <span class="o">=</span> <span class="n">FunctionModifiers</span><span class="o">.</span><span class="n">UNUSED</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fn</span><span class="o">.</span><span class="n">_torchscript_modifier</span> <span class="o">=</span> <span class="n">FunctionModifiers</span><span class="o">.</span><span class="n">IGNORE</span>
        <span class="k">return</span> <span class="n">fn</span>

    <span class="k">return</span> <span class="n">decorator</span></div>


<span class="k">def</span> <span class="nf">_copy_to_script_wrapper</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="n">fn</span><span class="o">.</span><span class="n">_torchscript_modifier</span> <span class="o">=</span> <span class="n">FunctionModifiers</span><span class="o">.</span><span class="n">COPY_TO_SCRIPT_WRAPPER</span>
    <span class="k">return</span> <span class="n">fn</span>


<span class="k">def</span> <span class="nf">module_has_exports</span><span class="p">(</span><span class="n">mod</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">mod</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="n">item</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">get_torchscript_modifier</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="ow">is</span> <span class="n">FunctionModifiers</span><span class="o">.</span><span class="n">EXPORT</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span>


<span class="c1"># WARNING: should_drop is currently being used by our JIT code coverage plug-in to mark JIT&#39;d code as covered. If you</span>
<span class="c1"># rename this function, please update references in tools/coverage_plugins_package/src/coverage_plugins/jit_plugin.py to</span>
<span class="c1"># allow JIT&#39;d code to still be covered.</span>
<span class="k">def</span> <span class="nf">should_drop</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">attr</span> <span class="o">=</span> <span class="n">get_torchscript_modifier</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">attr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">attr</span> <span class="ow">is</span> <span class="n">FunctionModifiers</span><span class="o">.</span><span class="n">UNUSED</span>


<span class="k">def</span> <span class="nf">is_ignored_fn</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">mod</span> <span class="o">=</span> <span class="n">get_torchscript_modifier</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mod</span> <span class="ow">is</span> <span class="n">FunctionModifiers</span><span class="o">.</span><span class="n">UNUSED</span> <span class="ow">or</span> <span class="n">mod</span> <span class="ow">is</span> <span class="n">FunctionModifiers</span><span class="o">.</span><span class="n">IGNORE</span>


<span class="k">def</span> <span class="nf">is_static_fn</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getattr_static</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span> <span class="nb">staticmethod</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_static_fn</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getattr_static</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span><span class="o">.</span><span class="vm">__func__</span>


<span class="k">def</span> <span class="nf">get_torchscript_modifier</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s2">&quot;__func__&quot;</span><span class="p">):</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="vm">__func__</span>
    <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s2">&quot;_torchscript_modifier&quot;</span><span class="p">,</span> <span class="n">FunctionModifiers</span><span class="o">.</span><span class="n">DEFAULT</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">copy_torchscript_modifier</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">attr</span> <span class="o">=</span> <span class="n">get_torchscript_modifier</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">attr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">new</span><span class="o">.</span><span class="n">_torchscript_modifier</span> <span class="o">=</span> <span class="n">attr</span>


<span class="c1"># overloading registration</span>
<span class="c1"># overloads get registered in this file, and compiled in torch/jit/__init__.py</span>
<span class="c1"># so that they can be imported in nn/functional.py without an import cycle</span>

<span class="c1"># qualified_name =&gt; list[overload_functions]</span>
<span class="n">_overloaded_fns</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># noqa: T484</span>


<span class="n">_OVERLOAD_EXAMPLE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Example usage of overload function:</span>
<span class="s2">@torch.jit._overload</span>
<span class="s2">def my_function(x: type0) -&gt; type0: # decl 1</span>
<span class="s2">    pass</span>

<span class="s2">@torch.jit._overload</span>
<span class="s2">def my_function(x: type1) -&gt; type1: # decl 2</span>
<span class="s2">    pass</span>

<span class="s2">def my_function(x):                 # implementation</span>
<span class="s2">    if isinstance(x, type0):</span>
<span class="s2">        return x</span>
<span class="s2">    elif isinstance(x, type1):</span>
<span class="s2">        return x</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="k">def</span> <span class="nf">get_overload_no_implementation_error_message</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="n">sourcelines</span><span class="p">,</span> <span class="n">file_lineno</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">get_source_lines_and_file</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;Implementation for the </span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="s1"> &quot;</span><span class="si">{</span><span class="n">_qualified_name</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot; is missing. Please make &#39;</span>
        <span class="sa">f</span><span class="s2">&quot;sure a definition is provided and defined after all overload declarations.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s1">&#39;File &quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">&quot;, line </span><span class="si">{</span><span class="n">file_lineno</span><span class="si">}</span><span class="s1">:</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sourcelines</span><span class="p">)</span>
        <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="o">+</span> <span class="n">_OVERLOAD_EXAMPLE</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_check_overload_body</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">parsed_def</span> <span class="o">=</span> <span class="n">parse_def</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Parsing the function definition can raise an OSError if source is unavailable.</span>
        <span class="c1"># Since this is just an initial check, just raise a warning if this is the case.</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unable to retrieve source for @torch.jit._overload function: </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span>

    <span class="n">body</span> <span class="o">=</span> <span class="n">parsed_def</span><span class="o">.</span><span class="n">ast</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">body</span>

    <span class="k">def</span> <span class="nf">is_pass</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Pass</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_ellipsis</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Expr</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Ellipsis</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="n">is_pass</span><span class="p">(</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="n">is_ellipsis</span><span class="p">(</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Only `pass` statement or `...` can be the body of overload declaration:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parsed_def</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[:</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot; &lt;- Expecting `pass` or `...` here!</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">_OVERLOAD_EXAMPLE</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_overload</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="n">_check_overload_body</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="n">qual_name</span> <span class="o">=</span> <span class="n">_qualified_name</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">global</span> <span class="n">_overloaded_fns</span>
    <span class="n">fn_overload_list</span> <span class="o">=</span> <span class="n">_overloaded_fns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">qual_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fn_overload_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fn_overload_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">_overloaded_fns</span><span class="p">[</span><span class="n">qual_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">fn_overload_list</span>
    <span class="n">fn_overload_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">func</span>


<span class="k">def</span> <span class="nf">_get_fn_overloads</span><span class="p">(</span><span class="n">qual_name</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_overloaded_fns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">qual_name</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_clear_fn_overloads</span><span class="p">(</span><span class="n">qual_name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">del</span> <span class="n">_overloaded_fns</span><span class="p">[</span><span class="n">qual_name</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">get_class_name_lineno</span><span class="p">(</span><span class="n">method</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
    <span class="n">current_frame</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span>

    <span class="c1"># one for the get_class_name call, one for _overload_method call</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">current_frame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">)</span>  <span class="c1"># assert current frame is not an Optional[FrameType]</span>
        <span class="n">current_frame</span> <span class="o">=</span> <span class="n">current_frame</span><span class="o">.</span><span class="n">f_back</span>

    <span class="k">assert</span> <span class="n">current_frame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>  <span class="c1"># same here</span>
    <span class="n">class_name</span> <span class="o">=</span> <span class="n">current_frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span>
    <span class="n">line_no</span> <span class="o">=</span> <span class="n">current_frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_firstlineno</span>
    <span class="k">return</span> <span class="n">class_name</span><span class="p">,</span> <span class="n">line_no</span>


<span class="c1"># At the the point the decorator is applied to class methods the method</span>
<span class="c1"># has no reference to its owning class. _qualified_name would not include</span>
<span class="c1"># the class it is defined in, so any methods with the same name in the same file</span>
<span class="c1"># would have the same _qualified_name, even if they were defined in different</span>
<span class="c1"># classes. This problem only exists in python 2.</span>
<span class="c1"># We get around this problem by looking at the stack frame and identifying</span>
<span class="c1"># the class name, and throwing an error whenever overloads are used</span>
<span class="c1"># when modules of the same name are in the same file</span>

<span class="c1"># qualified_name =&gt; class name =&gt; list[overload_functions]</span>
<span class="n">_overloaded_methods</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># noqa: T484</span>


<span class="c1"># (qualified_name, class name) =&gt; class_fileno</span>
<span class="n">_overloaded_method_class_fileno</span> <span class="o">=</span> <span class="p">{}</span>


<span class="k">def</span> <span class="nf">_overload_method</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="n">_check_overload_body</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="n">qual_name</span> <span class="o">=</span> <span class="n">_qualified_name</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">global</span> <span class="n">_overloaded_methods</span>
    <span class="n">class_name_map</span> <span class="o">=</span> <span class="n">_overloaded_methods</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">qual_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">class_name_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">class_name_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">_overloaded_methods</span><span class="p">[</span><span class="n">qual_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">class_name_map</span>

    <span class="n">class_name</span><span class="p">,</span> <span class="n">line_no</span> <span class="o">=</span> <span class="n">get_class_name_lineno</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="n">method_overloads</span> <span class="o">=</span> <span class="n">class_name_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">class_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">method_overloads</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">method_overloads</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">class_name_map</span><span class="p">[</span><span class="n">class_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">method_overloads</span>
        <span class="n">_overloaded_method_class_fileno</span><span class="p">[(</span><span class="n">qual_name</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)]</span> <span class="o">=</span> <span class="n">line_no</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">existing_lineno</span> <span class="o">=</span> <span class="n">_overloaded_method_class_fileno</span><span class="p">[(</span><span class="n">qual_name</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">existing_lineno</span> <span class="o">!=</span> <span class="n">line_no</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot currently overload the same method name in two different&quot;</span>
                <span class="s2">&quot; classes with the same name in the same module&quot;</span>
            <span class="p">)</span>

    <span class="n">method_overloads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">func</span>


<span class="k">def</span> <span class="nf">_get_overloaded_methods</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">mod_class</span><span class="p">):</span>
    <span class="c1"># TODO: __name__ not set for submodules in recursive script</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">qual_name</span> <span class="o">=</span> <span class="n">_qualified_name</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
    <span class="n">class_name_map</span> <span class="o">=</span> <span class="n">_overloaded_methods</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">qual_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">class_name_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">overloads</span> <span class="o">=</span> <span class="n">class_name_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mod_class</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">overloads</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">method_line_no</span> <span class="o">=</span> <span class="n">get_source_lines_and_file</span><span class="p">(</span><span class="n">method</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">mod_class_fileno</span> <span class="o">=</span> <span class="n">get_source_lines_and_file</span><span class="p">(</span><span class="n">mod_class</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">mod_end_fileno</span> <span class="o">=</span> <span class="n">mod_class_fileno</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">get_source_lines_and_file</span><span class="p">(</span><span class="n">mod_class</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">method_line_no</span> <span class="o">&gt;=</span> <span class="n">mod_class_fileno</span> <span class="ow">and</span> <span class="n">method_line_no</span> <span class="o">&lt;=</span> <span class="n">mod_end_fileno</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="s2">&quot;Overloads are not useable when a module is redeclared within the same file: &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">overloads</span>


<span class="k">def</span> <span class="nf">is_tuple</span><span class="p">(</span><span class="n">ann</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">ann</span> <span class="ow">is</span> <span class="n">Tuple</span><span class="p">:</span>
        <span class="n">raise_error_container_parameter_missing</span><span class="p">(</span><span class="s2">&quot;Tuple&quot;</span><span class="p">)</span>

    <span class="c1"># For some reason Python 3.7 violates the Type[A, B].__origin__ == Type rule</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ann</span><span class="p">,</span> <span class="s2">&quot;__module__&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">ann</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">==</span> <span class="s2">&quot;typing&quot;</span> <span class="ow">and</span> <span class="p">(</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="n">ann</span><span class="p">,</span> <span class="s2">&quot;__origin__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Tuple</span>
        <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ann</span><span class="p">,</span> <span class="s2">&quot;__origin__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">is_list</span><span class="p">(</span><span class="n">ann</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">ann</span> <span class="ow">is</span> <span class="n">List</span><span class="p">:</span>
        <span class="n">raise_error_container_parameter_missing</span><span class="p">(</span><span class="s2">&quot;List&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ann</span><span class="p">,</span> <span class="s2">&quot;__module__&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">ann</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">==</span> <span class="s2">&quot;typing&quot;</span> <span class="ow">and</span> <span class="p">(</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="n">ann</span><span class="p">,</span> <span class="s2">&quot;__origin__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="n">List</span>
        <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ann</span><span class="p">,</span> <span class="s2">&quot;__origin__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">is_dict</span><span class="p">(</span><span class="n">ann</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">ann</span> <span class="ow">is</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">raise_error_container_parameter_missing</span><span class="p">(</span><span class="s2">&quot;Dict&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ann</span><span class="p">,</span> <span class="s2">&quot;__module__&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">ann</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">==</span> <span class="s2">&quot;typing&quot;</span> <span class="ow">and</span> <span class="p">(</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="n">ann</span><span class="p">,</span> <span class="s2">&quot;__origin__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Dict</span>
        <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ann</span><span class="p">,</span> <span class="s2">&quot;__origin__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">is_union</span><span class="p">(</span><span class="n">ann</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ann</span> <span class="ow">is</span> <span class="n">Union</span><span class="p">:</span>
        <span class="n">raise_error_container_parameter_missing</span><span class="p">(</span><span class="s2">&quot;Union&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="nb">hasattr</span><span class="p">(</span><span class="n">ann</span><span class="p">,</span> <span class="s2">&quot;__module__&quot;</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">ann</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">==</span> <span class="s2">&quot;typing&quot;</span>
        <span class="ow">and</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">ann</span><span class="p">,</span> <span class="s2">&quot;__origin__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Union</span><span class="p">)</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">is_optional</span><span class="p">(</span><span class="n">ann</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ann</span> <span class="ow">is</span> <span class="n">Optional</span><span class="p">:</span>
        <span class="n">raise_error_container_parameter_missing</span><span class="p">(</span><span class="s2">&quot;Optional&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_optional_as_optional</span><span class="p">(</span><span class="n">ann</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="nb">hasattr</span><span class="p">(</span><span class="n">ann</span><span class="p">,</span> <span class="s2">&quot;__module__&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">ann</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">==</span> <span class="s2">&quot;typing&quot;</span>
            <span class="ow">and</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">ann</span><span class="p">,</span> <span class="s2">&quot;__origin__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Optional</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_union_as_optional</span><span class="p">(</span><span class="n">ann</span><span class="p">):</span>
        <span class="n">ann_args</span> <span class="o">=</span> <span class="n">ann</span><span class="o">.</span><span class="n">__args__</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">ann_args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="p">(</span><span class="kc">None</span> <span class="ow">in</span> <span class="n">ann_args</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ann_args</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">is_optional_as_optional</span><span class="p">(</span><span class="n">ann</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">is_union</span><span class="p">(</span><span class="n">ann</span><span class="p">)</span> <span class="ow">and</span> <span class="n">is_union_as_optional</span><span class="p">(</span><span class="n">ann</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">is_future</span><span class="p">(</span><span class="n">ann</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">ann</span> <span class="ow">is</span> <span class="n">Future</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;Attempted to use Future without a &quot;</span>
            <span class="s2">&quot;contained type. Please add a contained type, e.g. &quot;</span>
            <span class="s2">&quot;Future[int]&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ann</span><span class="p">,</span> <span class="s2">&quot;__origin__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Future</span>


<span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">torch._C._distributed_rpc</span> <span class="kn">import</span> <span class="n">PyRRef</span>
    <span class="kn">from</span> <span class="nn">torch.distributed.rpc</span> <span class="kn">import</span> <span class="n">RRef</span>

    <span class="k">def</span> <span class="nf">is_rref</span><span class="p">(</span><span class="n">ann</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ann</span> <span class="ow">is</span> <span class="n">RRef</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Attempted to use RRef without a &quot;</span>
                <span class="s2">&quot;contained type. Please add a contained type, e.g. &quot;</span>
                <span class="s2">&quot;RRef[int]&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ann</span><span class="p">,</span> <span class="s2">&quot;__origin__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="n">RRef</span>

    <span class="k">def</span> <span class="nf">is_rref_instance</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">PyRRef</span><span class="p">)</span>

<span class="k">else</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">is_rref_instance</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="c1"># If the RPC module doesn&#39;t exist then RRefs don&#39;t exist either.</span>
        <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">is_final</span><span class="p">(</span><span class="n">ann</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">ann</span><span class="o">.</span><span class="vm">__module__</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;typing&quot;</span><span class="p">,</span> <span class="s2">&quot;typing_extensions&quot;</span><span class="p">}</span> <span class="ow">and</span> <span class="p">(</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="n">ann</span><span class="p">,</span> <span class="s2">&quot;__origin__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Final</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ann</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">Final</span><span class="p">))</span>
    <span class="p">)</span>


<span class="c1"># allows BroadcastingList instance to be subscriptable</span>
<span class="k">class</span> <span class="nc">BroadcastingListCls</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">types</span><span class="p">):</span>
        <span class="k">return</span>


<span class="c1"># mypy doesn&#39;t support parameters on types, so we have to explicitly type each</span>
<span class="c1"># list size</span>
<span class="n">BroadcastingList1</span> <span class="o">=</span> <span class="n">BroadcastingListCls</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>
    <span class="nb">globals</span><span class="p">()[</span><span class="sa">f</span><span class="s2">&quot;BroadcastingList</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BroadcastingList1</span>


<div class="viewcode-block" id="is_scripting"><a class="viewcode-back" href="../../jit_language_reference.html#torch.jit.is_scripting">[docs]</a><span class="k">def</span> <span class="nf">is_scripting</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function that returns True when in compilation and False otherwise. This</span>
<span class="sd">    is useful especially with the @unused decorator to leave code in your</span>
<span class="sd">    model that is not yet TorchScript compatible.</span>
<span class="sd">    .. testcode::</span>

<span class="sd">        import torch</span>

<span class="sd">        @torch.jit.unused</span>
<span class="sd">        def unsupported_linear_op(x):</span>
<span class="sd">            return x</span>

<span class="sd">        def linear(x):</span>
<span class="sd">           if torch.jit.is_scripting():</span>
<span class="sd">              return torch.linear(x)</span>
<span class="sd">           else:</span>
<span class="sd">              return unsupported_linear_op(x)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="kc">False</span></div>


<span class="c1"># Retrieves a fully-qualified name (module hierarchy + classname) for a given obj.</span>
<span class="k">def</span> <span class="nf">_qualified_name</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">mangle_name</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="c1"># This special case allows us to override the qualified name on a type.</span>
    <span class="c1"># It&#39;s currently used in conjunction with tracing, where we create a</span>
    <span class="c1"># fake module to filter only supported attributes. However, since this</span>
    <span class="c1"># new type is defined as a local class, we need a mechanism to override</span>
    <span class="c1"># its qualname so it appears correctly in the TorchScript system. This,</span>
    <span class="c1"># we set &#39;_jit_override_qualname&#39; with the original traced module&#39;s</span>
    <span class="c1"># qualified name, which is picked up here</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;_jit_override_qualname&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">_jit_override_qualname</span>
    <span class="c1"># short-circuit in cases where the object already has a known qualified name</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">ScriptFunction</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">qualified_name</span>

    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="c1"># Enum classes do not have `__name__` attr, instead they have `name`.</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Could not get name of python class object&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;&lt;lambda&gt;&quot;</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;_lambda&quot;</span>  <span class="c1"># make name a valid identifier</span>

    <span class="n">module_name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__module__</span>

    <span class="c1"># If the module is actually a torchbind module, then we should short circuit</span>
    <span class="k">if</span> <span class="n">module_name</span> <span class="o">==</span> <span class="s2">&quot;torch._classes&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">qualified_name</span>

    <span class="c1"># The Python docs are very clear that `__module__` can be None, but I can&#39;t</span>
    <span class="c1"># figure out when it actually would be.</span>
    <span class="k">if</span> <span class="n">module_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Could not get qualified name for class &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: &quot;</span>
            <span class="s2">&quot;__module__ can&#39;t be None.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># if getattr(sys.modules[module_name], name) is not obj:</span>
    <span class="c1">#     raise RuntimeError(f&quot;Could not get qualified name for class &#39;{name}&#39;: &quot;</span>
    <span class="c1">#                        f&quot;the attr {name} on module {module_name} is not the the class&quot;)</span>

    <span class="c1"># torch.package and TorchScript have separate mangling schemes to avoid</span>
    <span class="c1"># name collisions from multiple packages. To avoid them interfering with</span>
    <span class="c1"># each other, normalize the package manging here.</span>
    <span class="k">if</span> <span class="n">package_mangling</span><span class="o">.</span><span class="n">is_mangled</span><span class="p">(</span><span class="n">module_name</span><span class="p">):</span>
        <span class="n">module_name</span> <span class="o">=</span> <span class="n">module_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="n">module_name</span> <span class="o">=</span> <span class="n">module_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>

    <span class="c1"># The PythonExceptionValue C++ class in torch/csrc/jit/python/python_sugared_value.h</span>
    <span class="c1"># does not need mangle the python class name.</span>
    <span class="k">if</span> <span class="n">mangle_name</span><span class="p">:</span>
        <span class="c1"># __main__ is a builtin module, so rewrite it to &quot;__torch__&quot;.</span>
        <span class="k">if</span> <span class="n">module_name</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
            <span class="n">module_name</span> <span class="o">=</span> <span class="s2">&quot;__torch__&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Everything else gets a &quot;__torch__&quot; prefix to avoid name collisions</span>
            <span class="c1"># with the names of user values.</span>
            <span class="n">module_name</span> <span class="o">=</span> <span class="s2">&quot;__torch__.&quot;</span> <span class="o">+</span> <span class="n">module_name</span>

    <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Could not get qualified name for class &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; is not a valid identifier&quot;</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">module_name</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">name</span>


<span class="k">def</span> <span class="nf">_try_get_dispatched_fn</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">boolean_dispatched</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_named_tuple_properties</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;_fields&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;_field_defaults&quot;</span><span class="p">):</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_field_defaults</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">_fields</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">_field_defaults</span>
        <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># In 3.10 recommended way to get annotations is to call `inspect.get_annotations` function</span>
    <span class="c1"># Also, annotations from base class are not inherited so they need to be queried explicitly</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
        <span class="n">obj_annotations</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__annotations__&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">obj_annotations</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj_annotations</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__base__&quot;</span><span class="p">):</span>
            <span class="n">obj_annotations</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">__base__</span><span class="p">)</span>

    <span class="n">annotations</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">obj_annotations</span><span class="p">:</span>
            <span class="n">the_type</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">ann_to_type</span><span class="p">(</span>
                <span class="n">obj_annotations</span><span class="p">[</span><span class="n">field</span><span class="p">],</span> <span class="n">fake_range</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">annotations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">the_type</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">annotations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">TensorType</span><span class="o">.</span><span class="n">getInferred</span><span class="p">())</span>
    <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">_fields</span><span class="p">,</span> <span class="n">annotations</span><span class="p">,</span> <span class="n">defaults</span>


<span class="k">def</span> <span class="nf">_create_named_tuple</span><span class="p">(</span>
    <span class="n">t</span><span class="p">,</span> <span class="n">unqual_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">field_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">defaults</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
<span class="p">):</span>
    <span class="c1"># mypy: namedtuple() expects a string literal as the first argument</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">TupleType</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="n">unqual_name</span><span class="p">,</span> <span class="n">field_names</span><span class="p">)</span>  <span class="c1"># type: ignore[no-redef, misc]</span>
        <span class="n">TupleType</span><span class="o">.</span><span class="fm">__new__</span><span class="o">.</span><span class="vm">__defaults__</span> <span class="o">=</span> <span class="n">defaults</span>  <span class="c1"># type: ignore[attr-defined]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">TupleType</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="n">unqual_name</span><span class="p">,</span> <span class="n">field_names</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="n">defaults</span><span class="p">)</span>  <span class="c1"># type: ignore[call-arg, no-redef, misc]</span>
    <span class="k">return</span> <span class="n">TupleType</span><span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>


<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">_disable_emit_hooks</span><span class="p">():</span>
    <span class="n">hooks</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">_jit_get_emit_hooks</span><span class="p">()</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">_jit_set_emit_hooks</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">yield</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">_jit_set_emit_hooks</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">hooks</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_disable_emit_hooks_decorator</span><span class="p">(</span><span class="n">_DecoratorContextManager</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># noqa: F811</span>
    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hooks</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">_jit_get_emit_hooks</span><span class="p">()</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">_jit_set_emit_hooks</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">_jit_set_emit_hooks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hooks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">hooks</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_is_exception</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">raise_error_container_parameter_missing</span><span class="p">(</span><span class="n">target_type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">target_type</span> <span class="o">==</span> <span class="s2">&quot;Dict&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;Attempted to use Dict without &quot;</span>
            <span class="s2">&quot;contained types. Please add contained type, e.g. &quot;</span>
            <span class="s2">&quot;Dict[int, int]&quot;</span>
        <span class="p">)</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Attempted to use </span><span class="si">{</span><span class="n">target_type</span><span class="si">}</span><span class="s2"> without a &quot;</span>
        <span class="s2">&quot;contained type. Please add a contained type, e.g. &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target_type</span><span class="si">}</span><span class="s2">[int]&quot;</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">get_origin</span><span class="p">(</span><span class="n">target_type</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">target_type</span><span class="p">,</span> <span class="s2">&quot;__origin__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_args</span><span class="p">(</span><span class="n">target_type</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">target_type</span><span class="p">,</span> <span class="s2">&quot;__args__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">check_args_exist</span><span class="p">(</span><span class="n">target_type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">target_type</span> <span class="ow">is</span> <span class="n">List</span> <span class="ow">or</span> <span class="n">target_type</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">raise_error_container_parameter_missing</span><span class="p">(</span><span class="s2">&quot;List&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">target_type</span> <span class="ow">is</span> <span class="n">Tuple</span> <span class="ow">or</span> <span class="n">target_type</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="n">raise_error_container_parameter_missing</span><span class="p">(</span><span class="s2">&quot;Tuple&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">target_type</span> <span class="ow">is</span> <span class="n">Dict</span> <span class="ow">or</span> <span class="n">target_type</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">raise_error_container_parameter_missing</span><span class="p">(</span><span class="s2">&quot;Dict&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">target_type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">target_type</span> <span class="ow">is</span> <span class="n">Optional</span><span class="p">:</span>
        <span class="n">raise_error_container_parameter_missing</span><span class="p">(</span><span class="s2">&quot;Optional&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">check_empty_containers</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">obj</span> <span class="o">==</span> <span class="p">[]</span> <span class="ow">or</span> <span class="n">obj</span> <span class="o">==</span> <span class="p">{}</span> <span class="ow">or</span> <span class="n">obj</span> <span class="o">==</span> <span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;The inner type of a container is lost when &quot;</span>
            <span class="s2">&quot;calling torch.jit.isinstance in eager mode. For &quot;</span>
            <span class="s2">&quot;example, List[int] would become list and &quot;</span>
            <span class="s2">&quot;therefore falsely return True for List[float] or&quot;</span>
            <span class="s2">&quot; List[str].&quot;</span>
        <span class="p">)</span>


<span class="c1"># supports List/Dict/Tuple and Optional types</span>
<span class="c1"># TODO support future</span>
<span class="k">def</span> <span class="nf">container_checker</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">target_type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">origin_type</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">target_type</span><span class="p">)</span>
    <span class="n">check_args_exist</span><span class="p">(</span><span class="n">target_type</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">origin_type</span> <span class="ow">is</span> <span class="nb">list</span> <span class="ow">or</span> <span class="n">origin_type</span> <span class="ow">is</span> <span class="n">List</span><span class="p">:</span>
        <span class="n">check_empty_containers</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">arg_type</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">target_type</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">arg_origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">arg_type</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
            <span class="c1"># check if nested container, ex: List[List[str]]</span>
            <span class="k">if</span> <span class="n">arg_origin</span><span class="p">:</span>  <span class="c1"># processes nested container, ex: List[List[str]]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">container_checker</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">arg_type</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">arg_type</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">origin_type</span> <span class="ow">is</span> <span class="n">Dict</span> <span class="ow">or</span> <span class="n">origin_type</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">check_empty_containers</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">key_type</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">target_type</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">val_type</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">target_type</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># check if keys are of right type</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">key_type</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="n">val_origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">val_type</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val_origin</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">container_checker</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">val_type</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">val_type</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">origin_type</span> <span class="ow">is</span> <span class="n">Tuple</span> <span class="ow">or</span> <span class="n">origin_type</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="n">check_empty_containers</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">arg_types</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">target_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg_types</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">el</span><span class="p">,</span> <span class="n">el_type</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">arg_types</span><span class="p">):</span>
            <span class="n">el_origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">el_type</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">el_origin</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">container_checker</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">el_type</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">el_type</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">origin_type</span> <span class="ow">is</span> <span class="n">Union</span><span class="p">:</span>  <span class="c1"># also handles Optional</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># check before recursion because None is always fine</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="n">inner_types</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">target_type</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">inner_types</span><span class="p">:</span>
            <span class="n">t_origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t_origin</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">container_checker</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">_isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">target_type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target_type</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Container</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target_type</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;The second argument to &quot;</span>
                <span class="s2">&quot;`torch.jit.isinstance` must be a type &quot;</span>
                <span class="s2">&quot;or a tuple of types&quot;</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">t_type</span> <span class="ow">in</span> <span class="n">target_type</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">t_type</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">origin_type</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">target_type</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">origin_type</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">container_checker</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">target_type</span><span class="p">)</span>

    <span class="c1"># Check to handle non-typed optional origin returns as none instead</span>
    <span class="c1">#    of as optional in 3.7-3.8</span>
    <span class="n">check_args_exist</span><span class="p">(</span><span class="n">target_type</span><span class="p">)</span>

    <span class="c1"># handle non-containers</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">target_type</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_TensorExtractor</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">Pickler</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">tensors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tensors</span> <span class="o">=</span> <span class="n">tensors</span>

    <span class="k">def</span> <span class="nf">persistent_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tensors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="c1"># Since we just want to extract tensors, we don&#39;t mind if an object is</span>
        <span class="c1"># unpicklable if it doesn&#39;t contain tensors, as we can just ignore/skip</span>
        <span class="c1"># it. To play it safe, we only do so for common objects that we&#39;re sure</span>
        <span class="c1"># don&#39;t contain tensors. Feel free to add new types here. Note also that</span>
        <span class="c1"># even if a type isn&#39;t listed here this won&#39;t block users, since thet</span>
        <span class="c1"># can just add a __getstate__ or __reduce__ method to their class.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">LockType</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="c1"># Futures and RRefs don&#39;t technically contain a value, they just offer</span>
        <span class="c1"># the means to access a value.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">CFuture</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_rref_instance</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Event</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">_extract_tensors</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is exclusively called from C++.</span>
<span class="sd">    See ``torch/csrc/jit/python/python_ivalue.h``.</span>

<span class="sd">    It extracts the tensors contained in the given object, through pickling.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tensors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">extractor</span> <span class="o">=</span> <span class="n">_TensorExtractor</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(),</span> <span class="n">protocol</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">tensors</span><span class="o">=</span><span class="n">tensors</span><span class="p">)</span>
    <span class="n">extractor</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tensors</span>
</pre></div>

             </article>
             
            </div>
            <footer>
  

  

    <hr>

  

  <div role="contentinfo">
    <p>
        &copy; Copyright 2022, PyTorch Contributors.

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>
     

</footer>

          </div>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              
            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
         <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
         <script src="../../_static/jquery.js"></script>
         <script src="../../_static/underscore.js"></script>
         <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
         <script src="../../_static/doctools.js"></script>
         <script src="../../_static/clipboard.min.js"></script>
         <script src="../../_static/copybutton.js"></script>
     

  

  <script type="text/javascript" src="../../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../../_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 
<script script type="text/javascript">
  var collapsedSections = ['Developer Notes', 'Language Bindings', 'Libraries', 'Community'];
</script>

<img height="1" width="1" style="border-style:none;" alt="" src="https://www.googleadservices.com/pagead/conversion/795629140/?label=txkmCPmdtosBENSssfsC&amp;guid=ON&amp;script=0"/>


  <!-- Begin Footer -->

  <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
    <div class="container">
      <div class="row">
        <div class="col-md-4 text-center">
          <h2>Docs</h2>
          <p>Access comprehensive developer documentation for PyTorch</p>
          <a class="with-right-arrow" href="https://pytorch.org/docs/stable/index.html">View Docs</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Tutorials</h2>
          <p>Get in-depth tutorials for beginners and advanced developers</p>
          <a class="with-right-arrow" href="https://pytorch.org/tutorials">View Tutorials</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Resources</h2>
          <p>Find development resources and get your questions answered</p>
          <a class="with-right-arrow" href="https://pytorch.org/resources">View Resources</a>
        </div>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container footer-container">
      <div class="footer-logo-wrapper">
        <a href="https://pytorch.org/" class="footer-logo"></a>
      </div>

      <div class="footer-links-wrapper">
        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/">PyTorch</a></li>
            <li><a href="https://pytorch.org/get-started">Get Started</a></li>
            <li><a href="https://pytorch.org/features">Features</a></li>
            <li><a href="https://pytorch.org/ecosystem">Ecosystem</a></li>
            <li><a href="https://pytorch.org/blog/">Blog</a></li>
            <li><a href="https://github.com/pytorch/pytorch/blob/master/CONTRIBUTING.md">Contributing</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/resources">Resources</a></li>
            <li><a href="https://pytorch.org/tutorials">Tutorials</a></li>
            <li><a href="https://pytorch.org/docs/stable/index.html">Docs</a></li>
            <li><a href="https://discuss.pytorch.org" target="_blank">Discuss</a></li>
            <li><a href="https://github.com/pytorch/pytorch/issues" target="_blank">Github Issues</a></li>
            <li><a href="https://pytorch.org/assets/brand-guidelines/PyTorch-Brand-Guidelines.pdf" target="_blank">Brand Guidelines</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title">Stay up to date</li>
            <li><a href="https://www.facebook.com/pytorch" target="_blank">Facebook</a></li>
            <li><a href="https://twitter.com/pytorch" target="_blank">Twitter</a></li>
            <li><a href="https://www.youtube.com/pytorch" target="_blank">YouTube</a></li>
            <li><a href="https://www.linkedin.com/company/pytorch" target="_blank">LinkedIn</a></li>
          </ul>  
          </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title">PyTorch Podcasts</li>
            <li><a href="https://open.spotify.com/show/6UzHKeiy368jKfQMKKvJY5" target="_blank">Spotify</a></li>
            <li><a href="https://podcasts.apple.com/us/podcast/pytorch-developer-podcast/id1566080008" target="_blank">Apple</a></li>
            <li><a href="https://www.google.com/podcasts?feed=aHR0cHM6Ly9mZWVkcy5zaW1wbGVjYXN0LmNvbS9PQjVGa0lsOA%3D%3D" target="_blank">Google</a></li>
            <li><a href="https://music.amazon.com/podcasts/7a4e6f0e-26c2-49e9-a478-41bd244197d0/PyTorch-Developer-Podcast?" target="_blank">Amazon</a></li>
          </ul>
         </div>
        </div>
        
        <div class="privacy-policy">
          <ul>
            <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/terms/" target="_blank">Terms</a></li>
            <li class="privacy-policy-links">|</li>
            <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/privacy-policy/" target="_blank">Privacy</a></li>
          </ul>
        </div>
        <div class="copyright">
        <p>Â© Copyright The Linux Foundation. The PyTorch Foundation is a project of The Linux Foundation.
          For web site terms of use, trademark policy and other policies applicable to The PyTorch Foundation please see
          <a href="www.linuxfoundation.org/policies/">www.linuxfoundation.org/policies/</a>. The PyTorch Foundation supports the PyTorch open source
          project, which has been established as PyTorch Project a Series of LF Projects, LLC. For policies applicable to the PyTorch Project a Series of LF Projects, LLC,
          please see <a href="www.lfprojects.org/policies/">www.lfprojects.org/policies/</a>.</p>
      </div>
     </div>

  </footer>

  <div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebookâ€™s Cookies Policy applies. Learn more, including about available controls: <a href="https://www.facebook.com/policies/cookies/">Cookies Policy</a>.</p>
    <img class="close-button" src="../../_static/images/pytorch-x.svg">
  </div>
</div>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>
            
          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li class="resources-mobile-menu-title" class="active">
            Docs
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/docs/stable/index.html">PyTorch</a>
            </li>

            <li>
              <a href="https://pytorch.org/audio/stable/index.html">torchaudio</a>
            </li>

            <li>
              <a href="https://pytorch.org/text/stable/index.html">torchtext</a>
            </li>

            <li>
              <a href="https://pytorch.org/vision/stable/index.html">torchvision</a>
            </li>

            <li>
              <a href="https://pytorch.org/torcharrow">torcharrow</a>
            </li>

            <li>
              <a href="https://pytorch.org/data">TorchData</a>
            </li>

            <li>
              <a href="https://pytorch.org/torchrec">TorchRec</a>
            </li>

            <li>
              <a href="https://pytorch.org/serve/">TorchServe</a>
            </li>

            <li>
              <a href="https://pytorch.org/torchx/">TorchX</a>
            </li>

            <li>
              <a href="https://pytorch.org/xla">PyTorch on XLA Devices</a>
            </li>
          </ul>

          <li class="resources-mobile-menu-title">
            Resources
          </li>
            
           <ul class="resources-mobile-menu-items">

            <li>
              <a href="https://pytorch.org/features">About</a>
            </li>

            <li>
              <a href="https://pytorch.org/foundation">PyTorch Foundation</a>
            </li>

            <li>
              <a href="https://pytorch.org/#community-module">Community</a>
            </li>

            <li>
              <a href="https://pytorch.org/community-stories">Community Stories</a>
            </li>

            <li>
              <a href="https://pytorch.org/resources">Developer Resources</a>
            </li>

            <li>
              <a href="https://pytorch.org/events">Events</a>
            </li>

            <li>
              <a href="https://discuss.pytorch.org/">Forums</a>
            </li>

            <li>
              <a href="https://pytorch.org/hub">Models (Beta)</a>
            </li>
          </ul>

          <li>
            <a href="https://github.com/pytorch/pytorch">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="../../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>