


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta name="robots" content="noindex">
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>torch.utils.checkpoint &mdash; PyTorch master documentation</title>
  

  
  
  
  
    <link rel="canonical" href="https://pytorch.org/docs/stable/_modules/torch/utils/checkpoint.html"/>
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.css" type="text/css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/katex-math.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx-dropdown.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/panels-bootstrap.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/jit.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />

<!--
  Search engines should not index the master version of documentation.
  Stable documentation are built without release == 'master'.
-->
<meta name="robots" content="noindex">


  <!-- Google Analytics -->
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-117752657-2"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-117752657-2');
    </script>
  
  <!-- End Google Analytics -->
  


  
  <script src="../../../_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>

          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li class="active docs-active">
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-orange-arrow">
                Docs
              </a>
              <div class="resources-dropdown-menu">
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/docs/stable/index.html">
                  <span class="dropdown-title">PyTorch</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/audio/stable/index.html">
                  <span class="dropdown-title">torchaudio</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/text/stable/index.html">
                  <span class="dropdown-title">torchtext</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/vision/stable/index.html">
                  <span class="dropdown-title">torchvision</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torcharrow">
                  <span class="dropdown-title">torcharrow</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/data">
                  <span class="dropdown-title">TorchData</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torchrec">
                  <span class="dropdown-title">TorchRec</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/serve/">
                  <span class="dropdown-title">TorchServe</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torchx/">
                  <span class="dropdown-title">TorchX</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/xla">
                  <span class="dropdown-title">PyTorch on XLA Devices</span>
                  <p></p>
                </a>
            </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-arrow">
                Resources
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/features">
                  <span class="dropdown-title">About</span>
                  <p>Learn about PyTorchâ€™s features and capabilities</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/foundation">
                  <span class="dropdown-title">PyTorch Foundation</span>
                  <p>Learn about the PyTorch foundation</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/#community-module">
                  <span class="dropdown-title">Community</span>
                  <p>Join the PyTorch developer community to contribute, learn, and get your questions answered.</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/community-stories">
                  <span class="dropdown-title">Community Stories</span>
                  <p>Learn how our community solves real, everyday machine learning problems with PyTorch.</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/resources">
                  <span class="dropdown-title">Developer Resources</span>
                  <p>Find resources and get questions answered</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/events">
                  <span class="dropdown-title">Events</span>
                  <p>Find events, webinars, and podcasts</p>
                </a>
                <a class="nav-dropdown-item" href="https://discuss.pytorch.org/" target="_blank">
                  <span class="dropdown-title">Forums</span>
                  <p>A place to discuss PyTorch code, issues, install, research</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/hub">
                  <span class="dropdown-title">Models (Beta)</span>
                  <p>Discover, publish, and reuse pre-trained models</p>
                </a>
              </div>
            </div>
          </li>

          <li>
            <a href="https://github.com/pytorch/pytorch">GitHub</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>

<body class="pytorch-body">

   

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            
    <div class="version">
      <a href='https://pytorch.org/docs/versions.html'>master (2.1.0a0+gitbe0b12e ) &#x25BC</a>
    </div>
    


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          </div>

          

<div>
  <a style="color:#F05732" href="https://pytorch.org/docs/stable/_modules/torch/utils/checkpoint.html">
    You are viewing unstable developer preview docs.
    Click here to view docs for latest stable release.
  </a>
</div>


            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Community</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../community/build_ci_governance.html">PyTorch Governance | Build + CI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/contribution_guide.html">PyTorch Contribution Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/design.html">PyTorch Design Philosophy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/governance.html">PyTorch Governance | Mechanics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/persons_of_interest.html">PyTorch Governance | Maintainers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/amp_examples.html">CUDA Automatic Mixed Precision examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/autograd.html">Autograd mechanics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/broadcasting.html">Broadcasting semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/cpu_threading_torchscript_inference.html">CPU threading and TorchScript inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/cuda.html">CUDA semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/ddp.html">Distributed Data Parallel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/extending.html">Extending PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/extending.func.html">Extending torch.func with autograd.Function</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/gradcheck.html">Gradcheck mechanics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/hip.html">HIP (ROCm) semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/large_scale_deployments.html">Features for large-scale deployments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/modules.html">Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/mps.html">MPS backend</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/multiprocessing.html">Multiprocessing best practices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/numerical_accuracy.html">Numerical accuracy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/randomness.html">Reproducibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/serialization.html">Serialization semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/windows.html">Windows FAQ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">torch.compile</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/index.html">torch.compile</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/get-started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/troubleshooting.html">PyTorch 2.0 Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/technical-overview.html">Technical Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/guards-overview.html">Guards Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/custom-backends.html">Custom Backends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/deep-dive.html">TorchDynamo Deeper Dive</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ir.html">IRs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Language Bindings</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../cpp_index.html">C++</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/javadoc/">Javadoc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../deploy.html">torch::deploy</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Python API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../torch.html">torch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nn.html">torch.nn</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nn.functional.html">torch.nn.functional</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tensors.html">torch.Tensor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tensor_attributes.html">Tensor Attributes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tensor_view.html">Tensor Views</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../amp.html">torch.amp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../autograd.html">torch.autograd</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../library.html">torch.library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cuda.html">torch.cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mps.html">torch.mps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../backends.html">torch.backends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.html">torch.distributed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.algorithms.join.html">torch.distributed.algorithms.join</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.elastic.html">torch.distributed.elastic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fsdp.html">torch.distributed.fsdp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.optim.html">torch.distributed.optim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.tensor.parallel.html">torch.distributed.tensor.parallel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.checkpoint.html">torch.distributed.checkpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributions.html">torch.distributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_dynamo.html">torch._dynamo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fft.html">torch.fft</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../func.html">torch.func</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../futures.html">torch.futures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fx.html">torch.fx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hub.html">torch.hub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../jit.html">torch.jit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../linalg.html">torch.linalg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../monitor.html">torch.monitor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../signal.html">torch.signal</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../special.html">torch.special</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../torch.overrides.html">torch.overrides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../package.html">torch.package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../profiler.html">torch.profiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nn.init.html">torch.nn.init</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../onnx.html">torch.onnx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../onnx_diagnostics.html">torch.onnx diagnostics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../optim.html">torch.optim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../complex_numbers.html">Complex Numbers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ddp_comm_hooks.html">DDP Communication Hooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pipeline.html">Pipeline Parallelism</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quantization.html">Quantization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rpc.html">Distributed RPC Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../random.html">torch.random</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../masked.html">torch.masked</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nested.html">torch.nested</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sparse.html">torch.sparse</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../storage.html">torch.Storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../testing.html">torch.testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../benchmark_utils.html">torch.utils.benchmark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../bottleneck.html">torch.utils.bottleneck</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../checkpoint.html">torch.utils.checkpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cpp_extension.html">torch.utils.cpp_extension</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data.html">torch.utils.data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../jit_utils.html">torch.utils.jit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dlpack.html">torch.utils.dlpack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mobile_optimizer.html">torch.utils.mobile_optimizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../model_zoo.html">torch.utils.model_zoo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tensorboard.html">torch.utils.tensorboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../type_info.html">Type Info</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../named_tensor.html">Named Tensors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../name_inference.html">Named Tensors operator coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../config_mod.html">torch.__config__</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Libraries</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/audio/stable">torchaudio</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/data">TorchData</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/torchrec">TorchRec</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/serve">TorchServe</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/text/stable">torchtext</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/vision/stable">torchvision</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/xla/">PyTorch on XLA Devices</a></li>
</ul>

            
          

        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="../../../index.html">
          
            Docs
          
        </a> &gt;
      </li>

        
          <li><a href="../../index.html">Module code</a> &gt;</li>
        
          <li><a href="../../torch.html">torch</a> &gt;</li>
        
      <li>torch.utils.checkpoint</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">

        

          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <h1>Source code for torch.utils.checkpoint</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">weakref</span>
<span class="kn">from</span> <span class="nn">weakref</span> <span class="kn">import</span> <span class="n">ReferenceType</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">ContextManager</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">DefaultDict</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">contextlib</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;checkpoint&quot;</span><span class="p">,</span> <span class="s2">&quot;checkpoint_sequential&quot;</span><span class="p">,</span> <span class="s2">&quot;CheckpointFunction&quot;</span><span class="p">,</span>
    <span class="s2">&quot;check_backward_validity&quot;</span><span class="p">,</span> <span class="s2">&quot;detach_variable&quot;</span><span class="p">,</span> <span class="s2">&quot;get_device_states&quot;</span><span class="p">,</span>
    <span class="s2">&quot;set_device_states&quot;</span><span class="p">,</span> <span class="s2">&quot;noop_context_fn&quot;</span><span class="p">,</span> <span class="s2">&quot;set_checkpoint_early_stop&quot;</span>
<span class="p">]</span>

<span class="k">def</span> <span class="nf">detach_variable</span><span class="p">(</span><span class="n">inputs</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">inp</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">x</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
            <span class="n">x</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">requires_grad</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;Only tuple of tensors is supported. Got Unsupported input type: &quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">check_backward_validity</span><span class="p">(</span><span class="n">inputs</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">inp</span><span class="o">.</span><span class="n">requires_grad</span> <span class="k">for</span> <span class="n">inp</span> <span class="ow">in</span> <span class="n">inputs</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;None of the inputs have requires_grad=True. Gradients will be None&quot;</span><span class="p">)</span>


<span class="c1"># We can&#39;t know if the run_fn will internally move some args to different devices,</span>
<span class="c1"># which would require logic to preserve rng states for those devices as well.</span>
<span class="c1"># We could paranoically stash and restore ALL the rng states for all visible devices,</span>
<span class="c1"># but that seems very wasteful for most cases.  Compromise:  Stash the RNG state for</span>
<span class="c1"># the device of all Tensor args.</span>
<span class="c1">#</span>
<span class="c1"># To consider:  maybe get_device_states and set_device_states should reside in torch/random.py?</span>
<span class="k">def</span> <span class="nf">get_device_states</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]:</span>
    <span class="c1"># This will not error out if &quot;arg&quot; is a CPU tensor or a non-tensor type because</span>
    <span class="c1"># the conditionals short-circuit.</span>
    <span class="n">fwd_gpu_devices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">({</span><span class="n">arg</span><span class="o">.</span><span class="n">get_device</span><span class="p">()</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="ow">and</span> <span class="n">arg</span><span class="o">.</span><span class="n">is_cuda</span><span class="p">})</span>

    <span class="n">fwd_gpu_states</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">fwd_gpu_devices</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">device</span><span class="p">):</span>
            <span class="n">fwd_gpu_states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">get_rng_state</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">fwd_gpu_devices</span><span class="p">,</span> <span class="n">fwd_gpu_states</span>


<span class="k">def</span> <span class="nf">set_device_states</span><span class="p">(</span><span class="n">devices</span><span class="p">,</span> <span class="n">states</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">device</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">devices</span><span class="p">,</span> <span class="n">states</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">device</span><span class="p">):</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">set_rng_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_get_autocast_kwargs</span><span class="p">():</span>
    <span class="n">gpu_autocast_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_autocast_enabled</span><span class="p">(),</span>
                           <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">get_autocast_gpu_dtype</span><span class="p">(),</span>
                           <span class="s2">&quot;cache_enabled&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_autocast_cache_enabled</span><span class="p">()}</span>

    <span class="n">cpu_autocast_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_autocast_cpu_enabled</span><span class="p">(),</span>
                           <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">get_autocast_cpu_dtype</span><span class="p">(),</span>
                           <span class="s2">&quot;cache_enabled&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_autocast_cache_enabled</span><span class="p">()}</span>

    <span class="k">return</span> <span class="n">gpu_autocast_kwargs</span><span class="p">,</span> <span class="n">cpu_autocast_kwargs</span>

<span class="k">class</span> <span class="nc">CheckpointFunction</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">Function</span><span class="p">):</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">run_function</span><span class="p">,</span> <span class="n">preserve_rng_state</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">check_backward_validity</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">run_function</span> <span class="o">=</span> <span class="n">run_function</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">preserve_rng_state</span> <span class="o">=</span> <span class="n">preserve_rng_state</span>
        <span class="c1"># Accommodates the (remote) possibility that autocast is enabled for cpu AND gpu.</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">gpu_autocast_kwargs</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">cpu_autocast_kwargs</span> <span class="o">=</span> <span class="n">_get_autocast_kwargs</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">preserve_rng_state</span><span class="p">:</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">fwd_cpu_state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">get_rng_state</span><span class="p">()</span>
            <span class="c1"># Don&#39;t eagerly initialize the cuda context by accident.</span>
            <span class="c1"># (If the user intends that the context is initialized later, within their</span>
            <span class="c1"># run_function, we SHOULD actually stash the cuda state here.  Unfortunately,</span>
            <span class="c1"># we have no way to anticipate this will happen before we run the function.)</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">had_cuda_in_fwd</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">_initialized</span><span class="p">:</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">had_cuda_in_fwd</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">fwd_gpu_devices</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">fwd_gpu_states</span> <span class="o">=</span> <span class="n">get_device_states</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

        <span class="c1"># Save non-tensor inputs in ctx, keep a placeholder None for tensors</span>
        <span class="c1"># to be filled out during the backward.</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">tensor_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tensor_inputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
                <span class="n">tensor_inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">tensor_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>

        <span class="n">ctx</span><span class="o">.</span><span class="n">save_for_backward</span><span class="p">(</span><span class="o">*</span><span class="n">tensor_inputs</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="n">run_function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outputs</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">backward</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">_is_checkpoint_valid</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Checkpointing is not compatible with .grad() or when an `inputs` parameter&quot;</span>
                <span class="s2">&quot; is passed to .backward(). Please use .backward() and do not pass its `inputs`&quot;</span>
                <span class="s2">&quot; argument.&quot;</span><span class="p">)</span>
        <span class="c1"># Copy the list to avoid modifying original list.</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span>
        <span class="n">tensor_indices</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">tensor_indices</span>
        <span class="n">tensors</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">saved_tensors</span>

        <span class="c1"># Fill in inputs with appropriate saved tensors.</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tensor_indices</span><span class="p">):</span>
            <span class="n">inputs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">tensors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># Stash the surrounding rng state, and mimic the state that was</span>
        <span class="c1"># present at this time during forward.  Restore the surrounding state</span>
        <span class="c1"># when we&#39;re done.</span>
        <span class="n">rng_devices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">preserve_rng_state</span> <span class="ow">and</span> <span class="n">ctx</span><span class="o">.</span><span class="n">had_cuda_in_fwd</span><span class="p">:</span>
            <span class="n">rng_devices</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">fwd_gpu_devices</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">fork_rng</span><span class="p">(</span><span class="n">devices</span><span class="o">=</span><span class="n">rng_devices</span><span class="p">,</span> <span class="n">enabled</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">preserve_rng_state</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">preserve_rng_state</span><span class="p">:</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">set_rng_state</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">fwd_cpu_state</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">had_cuda_in_fwd</span><span class="p">:</span>
                    <span class="n">set_device_states</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">fwd_gpu_devices</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">fwd_gpu_states</span><span class="p">)</span>
            <span class="n">detached_inputs</span> <span class="o">=</span> <span class="n">detach_variable</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">inputs</span><span class="p">))</span>
            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">enable_grad</span><span class="p">(),</span> \
                 <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="o">**</span><span class="n">ctx</span><span class="o">.</span><span class="n">gpu_autocast_kwargs</span><span class="p">),</span> \
                 <span class="n">torch</span><span class="o">.</span><span class="n">cpu</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="o">**</span><span class="n">ctx</span><span class="o">.</span><span class="n">cpu_autocast_kwargs</span><span class="p">):</span>
                <span class="n">outputs</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">run_function</span><span class="p">(</span><span class="o">*</span><span class="n">detached_inputs</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="p">(</span><span class="n">outputs</span><span class="p">,)</span>

        <span class="c1"># run backward() with only tensor that requires grad</span>
        <span class="n">outputs_with_grad</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">args_with_grad</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">outputs</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="ow">and</span> <span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">:</span>
                <span class="n">outputs_with_grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">args_with_grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outputs_with_grad</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;none of output has requires_grad=True,&quot;</span>
                <span class="s2">&quot; this checkpoint() is not necessary&quot;</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">outputs_with_grad</span><span class="p">,</span> <span class="n">args_with_grad</span><span class="p">)</span>
        <span class="n">grads</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">inp</span><span class="o">.</span><span class="n">grad</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
                      <span class="k">for</span> <span class="n">inp</span> <span class="ow">in</span> <span class="n">detached_inputs</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">+</span> <span class="n">grads</span>


<span class="k">def</span> <span class="nf">noop_context_fn</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">nullcontext</span><span class="p">(),</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">nullcontext</span><span class="p">()</span>


<div class="viewcode-block" id="checkpoint"><a class="viewcode-back" href="../../../checkpoint.html#torch.utils.checkpoint.checkpoint">[docs]</a><span class="k">def</span> <span class="nf">checkpoint</span><span class="p">(</span>
    <span class="n">function</span><span class="p">,</span>
    <span class="o">*</span><span class="n">args</span><span class="p">,</span>
    <span class="n">use_reentrant</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">context_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">ContextManager</span><span class="p">,</span> <span class="n">ContextManager</span><span class="p">]]</span> <span class="o">=</span> <span class="n">noop_context_fn</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Checkpoint a model or part of the model</span>

<span class="sd">    Checkpointing is a technique that trades compute for memory. Instead of</span>
<span class="sd">    storing all intermediate activations of the entire computation graph for</span>
<span class="sd">    the backward pass, the checkpointed part omits saving intermediate</span>
<span class="sd">    activations and recomputes them during the backward pass. This can be</span>
<span class="sd">    applied to any part of a model.</span>

<span class="sd">    There are currently two checkpointing implementations available, determined</span>
<span class="sd">    by the :attr:`use_reentrant` parameter. It is recommended that you use</span>
<span class="sd">    ``use_reentrant=False``. Please refer the note below for a discussion of</span>
<span class="sd">    their differences.</span>

<span class="sd">    .. warning::</span>

<span class="sd">        If the :attr:`function` invocation during the backward pass differs</span>
<span class="sd">        from the forward pass, e.g., due to a global variable, the checkpointed</span>
<span class="sd">        checkpointed version may not be equivalent, potentially causing an</span>
<span class="sd">        error being raised or leading to silently incorrect gradients.</span>

<span class="sd">    .. warning::</span>

<span class="sd">        If you are using the ``use_reentrant=True`` variant (this is currently</span>
<span class="sd">        the default), please refer to the note below for important</span>
<span class="sd">        considerations and potential limitations.</span>

<span class="sd">    .. note::</span>

<span class="sd">        The reentrant variant of checkpoint (``use_reentrant=True``) and</span>
<span class="sd">        the non-reentrant variant of checkpoint (``use_reentrant=False``)</span>
<span class="sd">        differ in the following ways:</span>

<span class="sd">        * Non-reentrant checkpoint stops recomputation as soon as all needed</span>
<span class="sd">          intermediate activations have been recomputed. This feature is enabled</span>
<span class="sd">          by default, but can be disabled with :func:`set_checkpoint_early_stop`.</span>
<span class="sd">          Reentrant checkpoint always recomputes :attr:`function` in its</span>
<span class="sd">          entirety during the backward pass.</span>

<span class="sd">       * The reentrant variant does not record the autograd graph during the</span>
<span class="sd">          forward pass, as it runs with the forward pass under</span>
<span class="sd">          :func:`torch.no_grad`. The non-reentrant version does record the</span>
<span class="sd">          autograd graph, allowing one to perform backward on the graph within</span>
<span class="sd">          checkpointed regions.</span>

<span class="sd">        * The reentrant checkpoint only supports the</span>
<span class="sd">          :func:`torch.autograd.backward` API for the backward pass without its</span>
<span class="sd">          `inputs` argument, while the non-reentrant version supports all ways</span>
<span class="sd">          of performing the backward pass.</span>

<span class="sd">        * At least one input and output must have ``requires_grad=True`` for the</span>
<span class="sd">          reentrant variant. If this condition is unmet, the checkpointed part</span>
<span class="sd">          of the model will not have gradients. The non-reentrant version does</span>
<span class="sd">          not have this requirement.</span>

<span class="sd">        * The reentrant version does not consider tensors in nested structures</span>
<span class="sd">          (e.g., custom objects, lists, dicts, etc) as participating in</span>
<span class="sd">          autograd, while the non-reentrant version does.</span>

<span class="sd">        * The reentrant checkpoint does not support checkpointed regions with</span>
<span class="sd">          detached tensors from the computational graph, whereas the</span>
<span class="sd">          non-reentrant version does. For the reentrant variant, if the</span>
<span class="sd">          checkpointed segment contains tensors detached using ``detach()`` or</span>
<span class="sd">          with :func:`torch.no_grad`, the backward pass will raise an error.</span>
<span class="sd">          This is because ``checkpoint`` makes all the outputs require gradients</span>
<span class="sd">          and this causes issues when a tensor is defined to have no gradient in</span>
<span class="sd">          the model. To avoid this, detach the tensors outside of the</span>
<span class="sd">          ``checkpoint`` function.</span>

<span class="sd">    Args:</span>
<span class="sd">        function: describes what to run in the forward pass of the model or</span>
<span class="sd">            part of the model. It should also know how to handle the inputs</span>
<span class="sd">            passed as the tuple. For example, in LSTM, if user passes</span>
<span class="sd">            ``(activation, hidden)``, :attr:`function` should correctly use the</span>
<span class="sd">            first input as ``activation`` and the second input as ``hidden``</span>
<span class="sd">        preserve_rng_state(bool, optional):  Omit stashing and restoring</span>
<span class="sd">            the RNG state during each checkpoint.</span>
<span class="sd">            Default: ``True``</span>
<span class="sd">        use_reentrant(bool, optional): Use checkpointing</span>
<span class="sd">            implementation that requires re-entrant autograd.</span>
<span class="sd">            If ``use_reentrant=False`` is specified, ``checkpoint`` will use an</span>
<span class="sd">            implementation that does not require re-entrant autograd. This</span>
<span class="sd">            allows ``checkpoint`` to support additional functionality, such as</span>
<span class="sd">            working as expected with ``torch.autograd.grad`` and support for</span>
<span class="sd">            keyword arguments input into the checkpointed function. Note that future</span>
<span class="sd">            versions of PyTorch will default to ``use_reentrant=False``.</span>
<span class="sd">            Default: ``True``</span>
<span class="sd">        context_fn(Callable, optional): A callable returning a tuple of two</span>
<span class="sd">            context managers. The function and its recomputation will be run</span>
<span class="sd">            under the first and second context managers respectively.</span>
<span class="sd">            This argument is only supported if ``use_reentrant=False``.</span>
<span class="sd">        args: tuple containing inputs to the :attr:`function`</span>

<span class="sd">    Returns:</span>
<span class="sd">        Output of running :attr:`function` on :attr:`*args`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Hack to mix *args with **kwargs in a python 2.7-compliant way</span>
    <span class="n">preserve</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;preserve_rng_state&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="n">use_reentrant</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unexpected keyword arguments: &quot;</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arg</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">use_reentrant</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">context_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">noop_context_fn</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Passing context_fn is only supported when use_reentrant=False.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">CheckpointFunction</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">preserve</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_checkpoint_without_reentrant</span><span class="p">(</span>
            <span class="n">function</span><span class="p">,</span>
            <span class="n">preserve</span><span class="p">,</span>
            <span class="n">context_fn</span><span class="p">,</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="checkpoint_sequential"><a class="viewcode-back" href="../../../checkpoint.html#torch.utils.checkpoint.checkpoint_sequential">[docs]</a><span class="k">def</span> <span class="nf">checkpoint_sequential</span><span class="p">(</span><span class="n">functions</span><span class="p">,</span> <span class="n">segments</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">use_reentrant</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;A helper function for checkpointing sequential models.</span>

<span class="sd">    Sequential models execute a list of modules/functions in order</span>
<span class="sd">    (sequentially). Therefore, we can divide such a model in various segments</span>
<span class="sd">    and checkpoint each segment. All segments except the last will not store</span>
<span class="sd">    the intermediate  activations. The inputs of each checkpointed segment will</span>
<span class="sd">    be saved for re-running the segment in the backward pass.</span>

<span class="sd">    .. warning::</span>
<span class="sd">        If you are using the ``use_reentrant=True` variant (this is the</span>
<span class="sd">        default), please see :func:`~torch.utils.checkpoint.checkpoint` for</span>
<span class="sd">        the important considerations and limitations of this variant. It is</span>
<span class="sd">        recommended that you use ``use_reentrant=False``.</span>

<span class="sd">    .. warning:</span>
<span class="sd">        Since PyTorch 1.4, it allows only one Tensor as the input and</span>
<span class="sd">        intermediate outputs, just like :class:`torch.nn.Sequential`.</span>

<span class="sd">    Args:</span>
<span class="sd">        functions: A :class:`torch.nn.Sequential` or the list of modules or</span>
<span class="sd">            functions (comprising the model) to run sequentially.</span>
<span class="sd">        segments: Number of chunks to create in the model</span>
<span class="sd">        input: A Tensor that is input to :attr:`functions`</span>
<span class="sd">        preserve_rng_state(bool, optional):  Omit stashing and restoring</span>
<span class="sd">            the RNG state during each checkpoint.</span>
<span class="sd">            Default: ``True``</span>
<span class="sd">        use_reentrant(bool, optional): Use checkpointing</span>
<span class="sd">            implementation that requires re-entrant autograd.</span>
<span class="sd">            If ``use_reentrant=False`` is specified, ``checkpoint`` will use an</span>
<span class="sd">            implementation that does not require re-entrant autograd. This</span>
<span class="sd">            allows ``checkpoint`` to support additional functionality, such as</span>
<span class="sd">            working as expected with ``torch.autograd.grad`` and support for</span>
<span class="sd">            keyword arguments input into the checkpointed function.</span>
<span class="sd">            Default: ``True``</span>

<span class="sd">    Returns:</span>
<span class="sd">        Output of running :attr:`functions` sequentially on :attr:`*inputs`</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # xdoctest: +SKIP(&quot;stub&quot;)</span>
<span class="sd">        &gt;&gt;&gt; model = nn.Sequential(...)</span>
<span class="sd">        &gt;&gt;&gt; input_var = checkpoint_sequential(model, chunks, input_var)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Hack for keyword-only parameter in a python 2.7-compliant way</span>
    <span class="n">preserve</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;preserve_rng_state&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unexpected keyword arguments: &quot;</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arg</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">run_function</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">functions</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="nb">input</span> <span class="o">=</span> <span class="n">functions</span><span class="p">[</span><span class="n">j</span><span class="p">](</span><span class="nb">input</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">input</span>
        <span class="k">return</span> <span class="n">forward</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">functions</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">):</span>
        <span class="n">functions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">functions</span><span class="o">.</span><span class="n">children</span><span class="p">())</span>

    <span class="n">segment_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">functions</span><span class="p">)</span> <span class="o">//</span> <span class="n">segments</span>
    <span class="c1"># the last chunk has to be non-volatile</span>
    <span class="n">end</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">start</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">segment_size</span> <span class="o">*</span> <span class="p">(</span><span class="n">segments</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">segment_size</span><span class="p">):</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">segment_size</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="nb">input</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">(</span>
            <span class="n">run_function</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">functions</span><span class="p">),</span>
            <span class="nb">input</span><span class="p">,</span>
            <span class="n">use_reentrant</span><span class="o">=</span><span class="n">use_reentrant</span><span class="p">,</span>
            <span class="n">preserve_rng_state</span><span class="o">=</span><span class="n">preserve</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">run_function</span><span class="p">(</span><span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">functions</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">functions</span><span class="p">)(</span><span class="nb">input</span><span class="p">)</span></div>

<span class="c1"># NOTE [ Nestable Checkpoint ]</span>
<span class="c1">#</span>
<span class="c1"># The semantics of nested checkpoint can be defined by two basic rules.</span>
<span class="c1"># Following the two rules leads to an important implication that is central</span>
<span class="c1"># to motivating the design.</span>
<span class="c1">#</span>
<span class="c1"># Rule 1. Saved tensors are managed by inner-most checkpoint only and hidden</span>
<span class="c1">#         from any outer layers of checkpoint.</span>
<span class="c1">#</span>
<span class="c1"># Rule 2. The inputs of inner checkpoints are treated as tensors saved to its</span>
<span class="c1">#         parent checkpoint.</span>
<span class="c1">#</span>
<span class="c1"># Implication: To recompute any given saved tensor, we need to recompute all of</span>
<span class="c1">#              the checkpoints wrapping it.</span>
<span class="c1">#</span>
<span class="c1"># Why is this implied? To unpack a saved tensor X during backward we need to</span>
<span class="c1"># recompute the inner-most checkpoint (#1), and in order to recompute that</span>
<span class="c1"># checkpoint I need to have its inputs, which are managed by that checkpoint&#39;s</span>
<span class="c1"># parent (#2), which thus also needs to be recomputed first. Continue this line</span>
<span class="c1"># of reasoning and we realize that in order to unpack X, all checkpoints that</span>
<span class="c1"># were active at the time X was saved need to be recomputed. (unless we have</span>
<span class="c1"># already done so in that backward for some other saved tensor).</span>
<span class="c1">#</span>
<span class="c1"># In practice, we use a noop autograd Function to save inputs as saved tensors.</span>
<span class="c1"># During unpack calling ctx.saved_tensor triggers the parent checkpoint to</span>
<span class="c1"># recompute.</span>
<span class="c1">#</span>
<span class="c1"># Rule 3. We should start recomputation as if there are no checkpoints currently</span>
<span class="c1">#         active. Checkpoints encountered during recomputation are still</span>
<span class="c1">#         respected.</span>
<span class="c1">#</span>
<span class="c1"># When we start recomputation, we push the saved variable hook meant for</span>
<span class="c1"># recomputation on the stack. See examples in Rule 6 for more context.</span>
<span class="c1">#</span>
<span class="c1">#                                  * * * *</span>
<span class="c1">#</span>
<span class="c1"># Beyond the basic semantics specific to nested checkpoint, we impose several</span>
<span class="c1"># more constraints that may apply to checkpointing in general.</span>
<span class="c1">#</span>
<span class="c1"># Rule 4. Lifetime of recomputed tensors</span>
<span class="c1">#</span>
<span class="c1">#         Recomputed tensors are considered specific to particular invocations</span>
<span class="c1">#         of backward and are always cleared immediately as they are unpacked</span>
<span class="c1">#         Particularly, we require this to happen even if retain_graph=True.</span>
<span class="c1">#</span>
<span class="c1"># [ Implementation details of Rule 4 ]</span>
<span class="c1">#</span>
<span class="c1"># If we were okay with recomputed tensors staying alive after backward is run</span>
<span class="c1"># with retain_graph=True, we would store recomputed variables as the values of a</span>
<span class="c1"># WeakKeyDictionary and pack strong references to the keys, so that as we</span>
<span class="c1"># backward, those packed keys would be cleared as long as retain_graph=False.</span>
<span class="c1"># Clearing the packed key clears the corresponding entry in the WKD.</span>
<span class="c1">#</span>
<span class="c1"># If we wish recomputed variables to be immediately cleared as we unpack them in</span>
<span class="c1"># the retain_graph=True case, we cannot rely on the packed keys to be cleared by</span>
<span class="c1"># backward automatically. Instead of packing the strong reference to the key</span>
<span class="c1"># directly, we pack a container object, which we manually clear as we unpack.</span>
<span class="c1">#</span>
<span class="c1"># An important detail is that if a second backward happens, the second</span>
<span class="c1"># recomputation needs to reset the container with a newly created key.</span>
<span class="c1">#</span>
<span class="c1"># Rule 5. Stop recomputation as soon as we&#39;ve recomputed the saved tensors we</span>
<span class="c1">#         know we need.</span>
<span class="c1">#</span>
<span class="c1"># [ Implementation details of Rule 5 ]</span>
<span class="c1">#</span>
<span class="c1"># During recomputation, raise an exception if the number of recomputed tensors</span>
<span class="c1"># matches the number of tensors that we expected to recompute. We wrap the</span>
<span class="c1"># recomputation call with a try-catch to catch this specific exception. See</span>
<span class="c1"># Rule #6 below for some examples.</span>
<span class="c1">#</span>
<span class="c1"># Rule 6. We support doing backward inside checkpoint context</span>
<span class="c1">#</span>
<span class="c1"># This section is just a bunch of random examples that we&#39;d like to support,</span>
<span class="c1"># and comments on how that forced us to make certain design decisions.</span>
<span class="c1">#</span>
<span class="c1"># [ Basic case ]</span>
<span class="c1">#</span>
<span class="c1"># def fn(x):</span>
<span class="c1">#   y = x.sin()</span>
<span class="c1">#   z = y.cos()</span>
<span class="c1">#   gx, = torch.autograd.grad(z, x, retains_grad=True)</span>
<span class="c1">#   return gx, z</span>
<span class="c1">#</span>
<span class="c1"># out = checkpoint(fn)(inp)</span>
<span class="c1"># out.backward()</span>
<span class="c1">#</span>
<span class="c1"># Because z is saved by cos while checkpoint is enabled, it would not be</span>
<span class="c1"># actually saved, and so the .grad() call inside must trigger a recomputation.</span>
<span class="c1">#</span>
<span class="c1"># During recomputation the &quot;inner pack hook&quot; has two responsibilities:</span>
<span class="c1">#</span>
<span class="c1"># 1) As usual, populating the WeakKeyDictionary storing recomputed tensors</span>
<span class="c1"># 2) Pack the actual tensor (detached) so that one may perform backward on the</span>
<span class="c1">#    recomputed graph. The tensors saved to this graph will live until the end</span>
<span class="c1">#    of recomputation, or die earlier if someone performs backward with</span>
<span class="c1">#    retain_graph=False.</span>
<span class="c1">#</span>
<span class="c1"># More generally performing backward on the recomputed graph occurs in the</span>
<span class="c1"># following cases:</span>
<span class="c1"># - If backward is performed inside forward,</span>
<span class="c1">#   - During the original forward IF early-stop is disabled</span>
<span class="c1">#   - During the original backward</span>
<span class="c1"># - If there are multiple .grad()/.backward() calls, we would perform backward</span>
<span class="c1">#   on the recomputed graph even if early-stop is enabled (see the example below)</span>
<span class="c1">#</span>
<span class="c1"># [ Multiple backwards ]</span>
<span class="c1">#</span>
<span class="c1"># The example below shows what happens if during recomputation we find that some</span>
<span class="c1"># of the tensors we are trying to recompute have already been cleared.</span>
<span class="c1">#</span>
<span class="c1"># Spoiler: we don&#39;t do anything special, we just skip over them!</span>
<span class="c1">#</span>
<span class="c1"># def fn(x):</span>
<span class="c1">#   y = x.sin()                           # (1)</span>
<span class="c1">#   z = y.cos()                           # (2)</span>
<span class="c1">#   gx, = torch.autograd.grad(z, x)       # (3)</span>
<span class="c1">#   w = x.sin()                           # (4)</span>
<span class="c1">#   v = w.cos()                           # (5)</span>
<span class="c1">#   gx2, = torch.autograd.grad(v, x)      # (6)</span>
<span class="c1">#   return x * gx * gx2</span>
<span class="c1">#</span>
<span class="c1"># out = checkpoint(fn)(inp)</span>
<span class="c1">#</span>
<span class="c1"># In the code above fn is computed (potentially partially) 4 times in total.</span>
<span class="c1">#</span>
<span class="c1"># 1. Don&#39;t save x and y since we are inside a checkpoint.</span>
<span class="c1"># 2. Trigger a recompute of fn as we reach (3) since x and y weren&#39;t saved.</span>
<span class="c1"># 3. If early stop is enabled, stop at (2)</span>
<span class="c1"># 4. Continue original forward at (4), not saving x and w.</span>
<span class="c1"># 5. (5) triggers a recompute of fn</span>
<span class="c1"># 6. During recompute, we see that in the original graph, gx has already</span>
<span class="c1">#    cleared x and y since backward is run at (3) without retain_graph=True</span>
<span class="c1">#    We save x and w, however.</span>
<span class="c1"># 7. Continue with returning</span>

<span class="n">_enable_checkpoint_early_stop</span> <span class="o">=</span> <span class="kc">True</span>

<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">set_checkpoint_early_stop</span><span class="p">(</span><span class="n">enable</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Context manager that sets whether checkpoint should stop recomputation</span>
<span class="sd">    early.</span>

<span class="sd">    By default, non-reentrant checkpoint stops recomputation as soon as it</span>
<span class="sd">    has computed all needed Tensors. This context manager can be used to disable</span>
<span class="sd">    that feature if it is problematic for your specific application.</span>

<span class="sd">    This context manager only needs to be active when forward is run. It does</span>
<span class="sd">    not need to be active during backward.</span>

<span class="sd">    Example::</span>

<span class="sd">    &gt;&gt;&gt; # xdoctest: +SKIP(failing)</span>
<span class="sd">    &gt;&gt;&gt; message = &quot;saved tensors default hooks are disabled&quot;</span>
<span class="sd">    &gt;&gt;&gt; with set_checkpoint_early_stop(False):</span>
<span class="sd">    ...     # Any checkpoint under this context manager will respect this</span>
<span class="sd">    ...     # context manager, even if its backward is performed outside.</span>
<span class="sd">    ...     out = checkpoint(fn, inputs)</span>
<span class="sd">    ...</span>
<span class="sd">    &gt;&gt;&gt; out.backward()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_enable_checkpoint_early_stop</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="n">_enable_checkpoint_early_stop</span>
        <span class="n">_enable_checkpoint_early_stop</span> <span class="o">=</span> <span class="n">enable</span>
        <span class="k">yield</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">_enable_checkpoint_early_stop</span> <span class="o">=</span> <span class="n">prev</span>

<span class="k">class</span> <span class="nc">_Handle</span><span class="p">():</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">_Holder</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handles</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_Handle</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">_NoopSaveInputs</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">Function</span><span class="p">):</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">setup_context</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">output</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Only tensors can be saved with ctx.save_for_backward, everything else</span>
        <span class="c1"># is captured by get_args, which is saved directly on ctx</span>
        <span class="n">tensor_indices</span><span class="p">,</span> <span class="n">tensors</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)])</span>
        <span class="n">idx2saved_idx</span> <span class="o">=</span> <span class="p">{</span><span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tensor_indices</span><span class="p">)}</span>
        <span class="c1"># args but with tensors replaced with None as placeholders</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="k">else</span> <span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">get_args</span><span class="p">(</span><span class="n">saved_tensors</span><span class="p">):</span>
            <span class="c1"># restore the placeholders with the original tensors grabbed from</span>
            <span class="c1"># ctx.saved_tensors (which may be saved on a parent checkpoint if</span>
            <span class="c1"># this checkpoint is nested, and that would trigger a recursive</span>
            <span class="c1"># unpack!)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="p">[</span><span class="n">saved_tensors</span><span class="p">[</span><span class="n">idx2saved_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tensor_indices</span> <span class="k">else</span> <span class="n">o</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="p">)]</span>
            <span class="c1"># grab the tail since we also saved the dummy to avoid having to explicitly</span>
            <span class="c1"># handle the case where there are no tensor inputs</span>
            <span class="k">return</span> <span class="n">ret</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="n">ctx</span><span class="o">.</span><span class="n">get_args</span> <span class="o">=</span> <span class="n">get_args</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">save_for_backward</span><span class="p">(</span><span class="o">*</span><span class="n">tensors</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">backward</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">*</span><span class="n">grad_outputs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Did not expect to backward on this graph&quot;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">_CheckpointFrame</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute_fn</span><span class="p">,</span> <span class="n">early_stop</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recompute_fn</span> <span class="o">=</span> <span class="n">recompute_fn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_saver</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weak_holders</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ReferenceType</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># We store this as a weakkeydictionary so that in the case of a partial</span>
        <span class="c1"># backward, the entries in the dict are cleared alongside the Holder</span>
        <span class="c1"># which will be removed when the SavedVariable is cleared.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recomputed</span><span class="p">:</span> <span class="n">DefaultDict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">[</span><span class="n">_Handle</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> \
            <span class="n">defaultdict</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">)</span>
        <span class="c1"># We need both recomp_counter and recomputed since they can diverge</span>
        <span class="c1"># https://github.com/pytorch/pytorch/pull/90105#discussion_r1135889885</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recomp_counter</span><span class="p">:</span> <span class="n">DefaultDict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_recomputed</span><span class="p">:</span> <span class="n">DefaultDict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>

        <span class="c1"># See Rule 5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">early_stop</span> <span class="o">=</span> <span class="n">early_stop</span>

<span class="c1"># See Rule 5</span>
<span class="k">class</span> <span class="nc">_StopRecomputationError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">_recomputation_hook</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">saved_tensors_hooks</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_frame_ref</span><span class="p">:</span> <span class="n">ReferenceType</span><span class="p">,</span> <span class="n">gid</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">pack_hook</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="n">target_frame</span> <span class="o">=</span> <span class="n">target_frame_ref</span><span class="p">()</span>
            <span class="k">assert</span> <span class="n">target_frame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">recomp_idx</span> <span class="o">=</span> <span class="n">target_frame</span><span class="o">.</span><span class="n">recomp_counter</span><span class="p">[</span><span class="n">gid</span><span class="p">]</span>
            <span class="n">target_frame</span><span class="o">.</span><span class="n">recomp_counter</span><span class="p">[</span><span class="n">gid</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">recomp_idx</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_frame</span><span class="o">.</span><span class="n">weak_holders</span><span class="p">):</span>
                <span class="c1"># We run into this case when early stop is not enabled and do</span>
                <span class="c1"># grad within checkpoint.</span>
                <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
            <span class="n">holder</span> <span class="o">=</span> <span class="n">target_frame</span><span class="o">.</span><span class="n">weak_holders</span><span class="p">[</span><span class="n">recomp_idx</span><span class="p">]()</span>

            <span class="k">if</span> <span class="n">holder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># See Rule 6: [ Multiple backwards ] above</span>
                <span class="k">if</span> <span class="n">holder</span><span class="o">.</span><span class="n">handles</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">gid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">holder</span><span class="o">.</span><span class="n">handles</span><span class="p">[</span><span class="n">gid</span><span class="p">]</span> <span class="o">=</span> <span class="n">_Handle</span><span class="p">()</span>
                <span class="n">target_frame</span><span class="o">.</span><span class="n">recomputed</span><span class="p">[</span><span class="n">gid</span><span class="p">][</span><span class="n">holder</span><span class="o">.</span><span class="n">handles</span><span class="p">[</span><span class="n">gid</span><span class="p">]]</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">target_frame</span><span class="o">.</span><span class="n">early_stop</span> <span class="ow">and</span> \
               <span class="n">target_frame</span><span class="o">.</span><span class="n">recomp_counter</span><span class="p">[</span><span class="n">gid</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_frame</span><span class="o">.</span><span class="n">weak_holders</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">_StopRecomputationError</span><span class="p">()</span>
            <span class="c1"># See Rule 6: [ Basic case ] above</span>
            <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">unpack_hook</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="c1"># See Rule 6: [ Basic case ] above for an example of when the graph</span>
            <span class="c1"># created during recomputation could be backwarded.</span>
            <span class="k">return</span> <span class="n">x</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">pack_hook</span><span class="p">,</span> <span class="n">unpack_hook</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">_checkpoint_hook</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">saved_tensors_hooks</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">pack_hook</span><span class="p">(</span><span class="n">_unused_x</span><span class="p">):</span>
            <span class="c1"># See Rule 4 above</span>
            <span class="n">holder</span> <span class="o">=</span> <span class="n">_Holder</span><span class="p">()</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">weak_holders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">holder</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">holder</span>

        <span class="k">def</span> <span class="nf">unpack_hook</span><span class="p">(</span><span class="n">holder</span><span class="p">):</span>
            <span class="n">gid</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">_current_graph_task_id</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">gid</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="c1"># generate a temporary id if we trigger unpack outside of a backward call</span>
                <span class="n">gid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">frame</span><span class="o">.</span><span class="n">is_recomputed</span><span class="p">[</span><span class="n">gid</span><span class="p">]:</span>
                <span class="n">ctx</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">input_saver</span><span class="o">.</span><span class="n">grad_fn</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get_args</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">saved_tensors</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">_recomputation_hook</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">frame</span><span class="p">),</span> <span class="n">gid</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">enable_grad</span><span class="p">():</span>
                        <span class="n">frame</span><span class="o">.</span><span class="n">recompute_fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">early_stop</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;if early stop is enabled, we don&#39;t expect to reach here&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">_StopRecomputationError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="n">frame</span><span class="o">.</span><span class="n">is_recomputed</span><span class="p">[</span><span class="n">gid</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">holder</span><span class="o">.</span><span class="n">handles</span><span class="p">[</span><span class="n">gid</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s2">&quot;If you are calling ctx.saved_tensor in backward, make sure to do so only once. &quot;</span>
                    <span class="s2">&quot;Otherwise please open an issue with details on your use case.&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">holder</span><span class="o">.</span><span class="n">handles</span><span class="p">[</span><span class="n">gid</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">frame</span><span class="o">.</span><span class="n">recomputed</span><span class="p">[</span><span class="n">gid</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s2">&quot;Attempt to retrieve a tensor saved by autograd multiple times without checkpoint&quot;</span>
                    <span class="s2">&quot; recomputation being triggered in between, this is not currently supported. Please&quot;</span>
                    <span class="s2">&quot; open an issue with details on your use case.&quot;</span>
                <span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">recomputed</span><span class="p">[</span><span class="n">gid</span><span class="p">][</span><span class="n">holder</span><span class="o">.</span><span class="n">handles</span><span class="p">[</span><span class="n">gid</span><span class="p">]]</span>
            <span class="n">holder</span><span class="o">.</span><span class="n">handles</span><span class="p">[</span><span class="n">gid</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">ret</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">pack_hook</span><span class="p">,</span> <span class="n">unpack_hook</span><span class="p">)</span>

<span class="c1"># NB: this helper wraps fn before calling checkpoint_impl. kwargs and</span>
<span class="c1">#     saving/restoring of global state is handled here.</span>
<span class="k">def</span> <span class="nf">_checkpoint_without_reentrant</span><span class="p">(</span>
    <span class="n">fn</span><span class="p">,</span>
    <span class="n">preserve_rng_state</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">context_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">ContextManager</span><span class="p">,</span> <span class="n">ContextManager</span><span class="p">]]</span> <span class="o">=</span> <span class="n">noop_context_fn</span><span class="p">,</span>
    <span class="o">*</span><span class="n">args</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Checkpointining without re-entrant autograd</span>
<span class="sd">    Args:</span>
<span class="sd">        function: describes what to run in the forward pass of the model or</span>
<span class="sd">            part of the model. It should also know how to handle the inputs</span>
<span class="sd">            passed as the tuple. For example, in LSTM, if user passes</span>
<span class="sd">            ``(activation, hidden)``, :attr:`function` should correctly use the</span>
<span class="sd">            first input as ``activation`` and the second input as ``hidden``</span>
<span class="sd">        preserve_rng_state(bool, optional):  Omit stashing and restoring</span>
<span class="sd">            the RNG state during each checkpoint.</span>
<span class="sd">            Default: ``True``</span>
<span class="sd">        context_fn(Callable, optional): A callable returning a tuple of two</span>
<span class="sd">            context managers. The function and its recomputation will be run</span>
<span class="sd">            under the first and second context managers respectively.</span>
<span class="sd">        *args: Arguments to pass in to the given ``function``.</span>
<span class="sd">        **kwargs: Keyword arguments to pass into the given ``function``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">forward_context</span><span class="p">,</span> <span class="n">recompute_context</span> <span class="o">=</span> <span class="n">context_fn</span><span class="p">()</span>
    <span class="c1"># Accommodates the (remote) possibility that autocast is enabled for cpu AND gpu.</span>
    <span class="n">gpu_autocast_kwargs</span><span class="p">,</span> <span class="n">cpu_autocast_kwargs</span> <span class="o">=</span> <span class="n">_get_autocast_kwargs</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">preserve_rng_state</span><span class="p">:</span>
        <span class="n">fwd_cpu_state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">get_rng_state</span><span class="p">()</span>
        <span class="c1"># Don&#39;t eagerly initialize the cuda context by accident.</span>
        <span class="c1"># (If the user intends that the context is initialized later, within their</span>
        <span class="c1"># run_function, we SHOULD actually stash the cuda state here.  Unfortunately,</span>
        <span class="c1"># we have no way to anticipate this will happen before we run the function.</span>
        <span class="c1"># If they do so, we raise an error.)</span>
        <span class="n">had_cuda_in_fwd</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">_initialized</span><span class="p">:</span>
            <span class="n">had_cuda_in_fwd</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">fwd_gpu_devices</span><span class="p">,</span> <span class="n">fwd_gpu_states</span> <span class="o">=</span> <span class="n">get_device_states</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">recompute_fn</span><span class="p">(</span><span class="o">*</span><span class="n">inputs</span><span class="p">):</span>
        <span class="n">kwargs</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="n">inputs</span>
        <span class="c1"># This will be called later during recomputation. This wrapping enables</span>
        <span class="c1"># the necessary global state to be captured.</span>
        <span class="n">rng_devices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">preserve_rng_state</span> <span class="ow">and</span> <span class="n">had_cuda_in_fwd</span><span class="p">:</span>
            <span class="n">rng_devices</span> <span class="o">=</span> <span class="n">fwd_gpu_devices</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">fork_rng</span><span class="p">(</span><span class="n">devices</span><span class="o">=</span><span class="n">rng_devices</span><span class="p">,</span> <span class="n">enabled</span><span class="o">=</span><span class="n">preserve_rng_state</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">preserve_rng_state</span><span class="p">:</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">set_rng_state</span><span class="p">(</span><span class="n">fwd_cpu_state</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">had_cuda_in_fwd</span><span class="p">:</span>
                    <span class="n">set_device_states</span><span class="p">(</span><span class="n">fwd_gpu_devices</span><span class="p">,</span> <span class="n">fwd_gpu_states</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="o">**</span><span class="n">gpu_autocast_kwargs</span><span class="p">),</span> \
                 <span class="n">torch</span><span class="o">.</span><span class="n">cpu</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="o">**</span><span class="n">cpu_autocast_kwargs</span><span class="p">),</span> \
                 <span class="n">recompute_context</span><span class="p">:</span>
                <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">new_frame</span> <span class="o">=</span> <span class="n">_CheckpointFrame</span><span class="p">(</span><span class="n">recompute_fn</span><span class="p">,</span> <span class="n">_enable_checkpoint_early_stop</span><span class="p">)</span>
    <span class="n">dummy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,),</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">new_frame</span><span class="o">.</span><span class="n">input_saver</span> <span class="o">=</span> <span class="n">_NoopSaveInputs</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">dummy</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="c1"># When ambient grad_mode is False</span>
    <span class="k">if</span> <span class="n">new_frame</span><span class="o">.</span><span class="n">input_saver</span><span class="o">.</span><span class="n">grad_fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">_checkpoint_hook</span><span class="p">(</span><span class="n">new_frame</span><span class="p">),</span> \
         <span class="n">forward_context</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">_initialized</span> <span class="ow">and</span> <span class="n">preserve_rng_state</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">had_cuda_in_fwd</span><span class="p">:</span>
        <span class="c1"># Cuda was not initialized before running the forward, so we didn&#39;t</span>
        <span class="c1"># stash the CUDA state.</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;PyTorch&#39;s CUDA state was initialized in the forward pass &quot;</span>
            <span class="s2">&quot;of a Checkpoint, which is not allowed. Please open an issue &quot;</span>
            <span class="s2">&quot;if you need this feature.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ret</span>
</pre></div>

             </article>
             
            </div>
            <footer>
  

  

    <hr>

  

  <div role="contentinfo">
    <p>
        &copy; Copyright 2023, PyTorch Contributors.

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>
     

</footer>

          </div>
<script>

var match = window.location.href.match(/\/_[a-zA-Z0-9_]*.html|_dynamo/gi);
var url = window.location.href.lastIndexOf(match[match.length-1]);

if (url)
  {
    var div = '<div class="admonition note"><p class="admonition-title">Note</p><p><i class="fa fa-exclamation-circle" aria-hidden="true">&nbsp</i> This page describes an internal API which is not intended to be used outside of the PyTorch codebase and can be modified or removed without notice.</p></div>'
    document.getElementById("pytorch-article").insertAdjacentHTML('afterBegin', div)
  }
</script>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              
            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
         <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
         <script src="../../../_static/jquery.js"></script>
         <script src="../../../_static/underscore.js"></script>
         <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
         <script src="../../../_static/doctools.js"></script>
         <script src="../../../_static/clipboard.min.js"></script>
         <script src="../../../_static/copybutton.js"></script>
     

  

  <script type="text/javascript" src="../../../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 
<script script type="text/javascript">
  var collapsedSections = ['Developer Notes', 'Language Bindings', 'Libraries', 'Community'];
</script>

<img height="1" width="1" style="border-style:none;" alt="" src="https://www.googleadservices.com/pagead/conversion/795629140/?label=txkmCPmdtosBENSssfsC&amp;guid=ON&amp;script=0"/>


  <!-- Begin Footer -->

  <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
    <div class="container">
      <div class="row">
        <div class="col-md-4 text-center">
          <h2>Docs</h2>
          <p>Access comprehensive developer documentation for PyTorch</p>
          <a class="with-right-arrow" href="https://pytorch.org/docs/stable/index.html">View Docs</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Tutorials</h2>
          <p>Get in-depth tutorials for beginners and advanced developers</p>
          <a class="with-right-arrow" href="https://pytorch.org/tutorials">View Tutorials</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Resources</h2>
          <p>Find development resources and get your questions answered</p>
          <a class="with-right-arrow" href="https://pytorch.org/resources">View Resources</a>
        </div>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container footer-container">
      <div class="footer-logo-wrapper">
        <a href="https://pytorch.org/" class="footer-logo"></a>
      </div>

      <div class="footer-links-wrapper">
        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/">PyTorch</a></li>
            <li><a href="https://pytorch.org/get-started">Get Started</a></li>
            <li><a href="https://pytorch.org/features">Features</a></li>
            <li><a href="https://pytorch.org/ecosystem">Ecosystem</a></li>
            <li><a href="https://pytorch.org/blog/">Blog</a></li>
            <li><a href="https://github.com/pytorch/pytorch/blob/master/CONTRIBUTING.md">Contributing</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/resources">Resources</a></li>
            <li><a href="https://pytorch.org/tutorials">Tutorials</a></li>
            <li><a href="https://pytorch.org/docs/stable/index.html">Docs</a></li>
            <li><a href="https://discuss.pytorch.org" target="_blank">Discuss</a></li>
            <li><a href="https://github.com/pytorch/pytorch/issues" target="_blank">Github Issues</a></li>
            <li><a href="https://pytorch.org/assets/brand-guidelines/PyTorch-Brand-Guidelines.pdf" target="_blank">Brand Guidelines</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title">Stay up to date</li>
            <li><a href="https://www.facebook.com/pytorch" target="_blank">Facebook</a></li>
            <li><a href="https://twitter.com/pytorch" target="_blank">Twitter</a></li>
            <li><a href="https://www.youtube.com/pytorch" target="_blank">YouTube</a></li>
            <li><a href="https://www.linkedin.com/company/pytorch" target="_blank">LinkedIn</a></li>
          </ul>  
          </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title">PyTorch Podcasts</li>
            <li><a href="https://open.spotify.com/show/6UzHKeiy368jKfQMKKvJY5" target="_blank">Spotify</a></li>
            <li><a href="https://podcasts.apple.com/us/podcast/pytorch-developer-podcast/id1566080008" target="_blank">Apple</a></li>
            <li><a href="https://www.google.com/podcasts?feed=aHR0cHM6Ly9mZWVkcy5zaW1wbGVjYXN0LmNvbS9PQjVGa0lsOA%3D%3D" target="_blank">Google</a></li>
            <li><a href="https://music.amazon.com/podcasts/7a4e6f0e-26c2-49e9-a478-41bd244197d0/PyTorch-Developer-Podcast?" target="_blank">Amazon</a></li>
          </ul>
         </div>
        </div>
        
        <div class="privacy-policy">
          <ul>
            <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/terms/" target="_blank">Terms</a></li>
            <li class="privacy-policy-links">|</li>
            <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/privacy-policy/" target="_blank">Privacy</a></li>
          </ul>
        </div>
        <div class="copyright">
        <p>Â© Copyright The Linux Foundation. The PyTorch Foundation is a project of The Linux Foundation.
          For web site terms of use, trademark policy and other policies applicable to The PyTorch Foundation please see
          <a href="www.linuxfoundation.org/policies/">www.linuxfoundation.org/policies/</a>. The PyTorch Foundation supports the PyTorch open source
          project, which has been established as PyTorch Project a Series of LF Projects, LLC. For policies applicable to the PyTorch Project a Series of LF Projects, LLC,
          please see <a href="www.lfprojects.org/policies/">www.lfprojects.org/policies/</a>.</p>
      </div>
     </div>

  </footer>

  <div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebookâ€™s Cookies Policy applies. Learn more, including about available controls: <a href="https://www.facebook.com/policies/cookies/">Cookies Policy</a>.</p>
    <img class="close-button" src="../../../_static/images/pytorch-x.svg">
  </div>
</div>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>
            
          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li class="resources-mobile-menu-title" class="active">
            Docs
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/docs/stable/index.html">PyTorch</a>
            </li>

            <li>
              <a href="https://pytorch.org/audio/stable/index.html">torchaudio</a>
            </li>

            <li>
              <a href="https://pytorch.org/text/stable/index.html">torchtext</a>
            </li>

            <li>
              <a href="https://pytorch.org/vision/stable/index.html">torchvision</a>
            </li>

            <li>
              <a href="https://pytorch.org/torcharrow">torcharrow</a>
            </li>

            <li>
              <a href="https://pytorch.org/data">TorchData</a>
            </li>

            <li>
              <a href="https://pytorch.org/torchrec">TorchRec</a>
            </li>

            <li>
              <a href="https://pytorch.org/serve/">TorchServe</a>
            </li>

            <li>
              <a href="https://pytorch.org/torchx/">TorchX</a>
            </li>

            <li>
              <a href="https://pytorch.org/xla">PyTorch on XLA Devices</a>
            </li>
          </ul>

          <li class="resources-mobile-menu-title">
            Resources
          </li>
            
           <ul class="resources-mobile-menu-items">

            <li>
              <a href="https://pytorch.org/features">About</a>
            </li>

            <li>
              <a href="https://pytorch.org/foundation">PyTorch Foundation</a>
            </li>

            <li>
              <a href="https://pytorch.org/#community-module">Community</a>
            </li>

            <li>
              <a href="https://pytorch.org/community-stories">Community Stories</a>
            </li>

            <li>
              <a href="https://pytorch.org/resources">Developer Resources</a>
            </li>

            <li>
              <a href="https://pytorch.org/events">Events</a>
            </li>

            <li>
              <a href="https://discuss.pytorch.org/">Forums</a>
            </li>

            <li>
              <a href="https://pytorch.org/hub">Models (Beta)</a>
            </li>
          </ul>

          <li>
            <a href="https://github.com/pytorch/pytorch">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="../../../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>