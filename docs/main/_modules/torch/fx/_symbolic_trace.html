


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta name="robots" content="noindex">
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>torch.fx._symbolic_trace &mdash; PyTorch main documentation</title>
  

  
  
  
  
    <link rel="canonical" href="https://pytorch.org/docs/stable/_modules/torch/fx/_symbolic_trace.html"/>
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.css" type="text/css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/katex-math.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx-dropdown.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/panels-bootstrap.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/jit.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />

<!--
  Search engines should not index the main version of documentation.
  Stable documentation are built without release == 'main'.
-->
<meta name="robots" content="noindex">


  <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-T8XT4PS');</script>
    <!-- End Google Tag Manager -->
  


  
  <script src="../../../_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>

          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li class="active docs-active">
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-orange-arrow">
                Docs
              </a>
              <div class="resources-dropdown-menu">
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/docs/stable/index.html">
                  <span class="dropdown-title">PyTorch</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/audio/stable/index.html">
                  <span class="dropdown-title">torchaudio</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/text/stable/index.html">
                  <span class="dropdown-title">torchtext</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/vision/stable/index.html">
                  <span class="dropdown-title">torchvision</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torcharrow">
                  <span class="dropdown-title">torcharrow</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/data">
                  <span class="dropdown-title">TorchData</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torchrec">
                  <span class="dropdown-title">TorchRec</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/serve/">
                  <span class="dropdown-title">TorchServe</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torchx/">
                  <span class="dropdown-title">TorchX</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/xla">
                  <span class="dropdown-title">PyTorch on XLA Devices</span>
                  <p></p>
                </a>
            </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-arrow">
                Resources
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/features">
                  <span class="dropdown-title">About</span>
                  <p>Learn about PyTorchâ€™s features and capabilities</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/foundation">
                  <span class="dropdown-title">PyTorch Foundation</span>
                  <p>Learn about the PyTorch foundation</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/#community-module">
                  <span class="dropdown-title">Community</span>
                  <p>Join the PyTorch developer community to contribute, learn, and get your questions answered.</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/community-stories">
                  <span class="dropdown-title">Community Stories</span>
                  <p>Learn how our community solves real, everyday machine learning problems with PyTorch.</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/resources">
                  <span class="dropdown-title">Developer Resources</span>
                  <p>Find resources and get questions answered</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/events">
                  <span class="dropdown-title">Events</span>
                  <p>Find events, webinars, and podcasts</p>
                </a>
                <a class="nav-dropdown-item" href="https://discuss.pytorch.org/" target="_blank">
                  <span class="dropdown-title">Forums</span>
                  <p>A place to discuss PyTorch code, issues, install, research</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/hub">
                  <span class="dropdown-title">Models (Beta)</span>
                  <p>Discover, publish, and reuse pre-trained models</p>
                </a>
              </div>
            </div>
          </li>

          <li>
            <a href="https://github.com/pytorch/pytorch">GitHub</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>

<body class="pytorch-body">

   

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            
    <div class="version">
      <a href='https://pytorch.org/docs/versions.html'>main (2.1.0a0+git707d265 ) &#x25BC</a>
    </div>
    


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          </div>

          

<div>
  <a style="color:#F05732" href="https://pytorch.org/docs/stable/_modules/torch/fx/_symbolic_trace.html">
    You are viewing unstable developer preview docs.
    Click here to view docs for latest stable release.
  </a>
</div>


            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Community</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../community/build_ci_governance.html">PyTorch Governance | Build + CI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/contribution_guide.html">PyTorch Contribution Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/design.html">PyTorch Design Philosophy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/governance.html">PyTorch Governance | Mechanics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/persons_of_interest.html">PyTorch Governance | Maintainers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/amp_examples.html">CUDA Automatic Mixed Precision examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/autograd.html">Autograd mechanics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/broadcasting.html">Broadcasting semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/cpu_threading_torchscript_inference.html">CPU threading and TorchScript inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/cuda.html">CUDA semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/ddp.html">Distributed Data Parallel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/extending.html">Extending PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/extending.func.html">Extending torch.func with autograd.Function</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/gradcheck.html">Gradcheck mechanics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/hip.html">HIP (ROCm) semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/large_scale_deployments.html">Features for large-scale deployments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/modules.html">Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/mps.html">MPS backend</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/multiprocessing.html">Multiprocessing best practices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/numerical_accuracy.html">Numerical accuracy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/randomness.html">Reproducibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/serialization.html">Serialization semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/windows.html">Windows FAQ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">torch.compile</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/index.html">torch.compile</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/get-started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/troubleshooting.html">PyTorch 2.0 Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/technical-overview.html">Technical Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/guards-overview.html">Guards Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/custom-backends.html">Custom Backends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/fine_grained_apis.html">TorchDynamo APIs to control fine-grained tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/profiling_torch_compile.html">Profiling to understand torch.compile performance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/inductor_profiling.html">TorchInductor GPU Profiling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/deep-dive.html">TorchDynamo Deeper Dive</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/cudagraph_trees.html">CUDAGraph Trees</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/performance-dashboard.html">PyTorch 2.0 Performance Dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/torchfunc-and-torchcompile.html">torch.func interaction with torch.compile</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ir.html">IRs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/dynamic-shapes.html">Dynamic shapes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/fake-tensor.html">Fake tensor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../logging.html">torch._logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/transformations.html">Writing Graph Transformations on ATen IR</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Language Bindings</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../cpp_index.html">C++</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/javadoc/">Javadoc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../deploy.html">torch::deploy</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Python API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../torch.html">torch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nn.html">torch.nn</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nn.functional.html">torch.nn.functional</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tensors.html">torch.Tensor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tensor_attributes.html">Tensor Attributes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tensor_view.html">Tensor Views</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../amp.html">torch.amp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../autograd.html">torch.autograd</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../library.html">torch.library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cuda.html">torch.cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mps.html">torch.mps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../backends.html">torch.backends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../export.html">torch._export.export</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.html">torch.distributed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.algorithms.join.html">torch.distributed.algorithms.join</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.elastic.html">torch.distributed.elastic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fsdp.html">torch.distributed.fsdp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.optim.html">torch.distributed.optim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.tensor.parallel.html">torch.distributed.tensor.parallel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.checkpoint.html">torch.distributed.checkpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributions.html">torch.distributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compiler.html">torch.compiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fft.html">torch.fft</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../func.html">torch.func</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../futures.html">torch.futures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fx.html">torch.fx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hub.html">torch.hub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../jit.html">torch.jit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../linalg.html">torch.linalg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../monitor.html">torch.monitor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../signal.html">torch.signal</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../special.html">torch.special</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../torch.overrides.html">torch.overrides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../package.html">torch.package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../profiler.html">torch.profiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nn.init.html">torch.nn.init</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../onnx.html">torch.onnx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../onnx_diagnostics.html">torch.onnx diagnostics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../optim.html">torch.optim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../complex_numbers.html">Complex Numbers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ddp_comm_hooks.html">DDP Communication Hooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pipeline.html">Pipeline Parallelism</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quantization.html">Quantization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rpc.html">Distributed RPC Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../random.html">torch.random</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../masked.html">torch.masked</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nested.html">torch.nested</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sparse.html">torch.sparse</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../storage.html">torch.Storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../testing.html">torch.testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../benchmark_utils.html">torch.utils.benchmark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../bottleneck.html">torch.utils.bottleneck</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../checkpoint.html">torch.utils.checkpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cpp_extension.html">torch.utils.cpp_extension</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data.html">torch.utils.data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../jit_utils.html">torch.utils.jit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dlpack.html">torch.utils.dlpack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mobile_optimizer.html">torch.utils.mobile_optimizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../model_zoo.html">torch.utils.model_zoo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tensorboard.html">torch.utils.tensorboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../type_info.html">Type Info</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../named_tensor.html">Named Tensors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../name_inference.html">Named Tensors operator coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../config_mod.html">torch.__config__</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../logging.html">torch._logging</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Libraries</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/audio/stable">torchaudio</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/data">TorchData</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/torchrec">TorchRec</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/serve">TorchServe</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/text/stable">torchtext</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/vision/stable">torchvision</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/xla/">PyTorch on XLA Devices</a></li>
</ul>

            
          

        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="../../../index.html">
          
            Docs
          
        </a> &gt;
      </li>

        
          <li><a href="../../index.html">Module code</a> &gt;</li>
        
          <li><a href="../../torch.html">torch</a> &gt;</li>
        
      <li>torch.fx._symbolic_trace</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">

        

          <!-- Google Tag Manager (noscript) -->
          <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T8XT4PS"
          height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
          <!-- End Google Tag Manager (noscript) -->
          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <h1>Source code for torch.fx._symbolic_trace</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">builtins</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>
<span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">CodeType</span><span class="p">,</span> <span class="n">FunctionType</span><span class="p">,</span> <span class="n">ModuleType</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">NamedTuple</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Set</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">Type</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.utils._pytree</span> <span class="k">as</span> <span class="nn">pytree</span>
<span class="kn">from</span> <span class="nn">torch._C</span> <span class="kn">import</span> <span class="n">ScriptObject</span>  <span class="c1"># type: ignore[attr-defined]</span>

<span class="kn">from</span> <span class="nn">._compatibility</span> <span class="kn">import</span> <span class="n">compatibility</span>
<span class="kn">from</span> <span class="nn">.graph</span> <span class="kn">import</span> <span class="n">_PyTreeCodeGen</span><span class="p">,</span> <span class="n">_PyTreeInfo</span><span class="p">,</span> <span class="n">Graph</span>
<span class="kn">from</span> <span class="nn">.graph_module</span> <span class="kn">import</span> <span class="n">GraphModule</span>
<span class="kn">from</span> <span class="nn">.node</span> <span class="kn">import</span> <span class="n">Argument</span><span class="p">,</span> <span class="n">base_types</span><span class="p">,</span> <span class="n">map_aggregate</span>
<span class="kn">from</span> <span class="nn">.proxy</span> <span class="kn">import</span> <span class="n">ParameterProxy</span><span class="p">,</span> <span class="n">Proxy</span><span class="p">,</span> <span class="n">TracerBase</span><span class="p">,</span> <span class="n">Scope</span><span class="p">,</span> <span class="n">ScopeContextManager</span>

<span class="n">HAS_VARSTUFF</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">CO_VARARGS</span> <span class="o">|</span> <span class="n">inspect</span><span class="o">.</span><span class="n">CO_VARKEYWORDS</span>

<span class="c1"># These need to run in global scope to handle nested calls correctly</span>
<span class="n">_orig_module_call</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="o">.</span><span class="fm">__call__</span>
<span class="n">_orig_module_getattr</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="o">.</span><span class="fm">__getattr__</span>

<span class="n">_proxyable_classes</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Type</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">_is_fx_tracing_flag</span> <span class="o">=</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">is_fx_tracing</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">_is_fx_tracing_flag</span>

<span class="nd">@compatibility</span><span class="p">(</span><span class="n">is_backward_compatible</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ProxyableClassMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ProxyableClassMeta allows you to make construction of a given Python class</span>
<span class="sd">    symbolically traceable. For example::</span>

<span class="sd">        import torch</span>
<span class="sd">        import torch.fx</span>

<span class="sd">        class TensorPair(metaclass=torch.fx.ProxyableClassMeta):</span>
<span class="sd">            def __init__(self, left, right):</span>
<span class="sd">                self.left, self.right = left, right</span>

<span class="sd">            def add(self, other):</span>
<span class="sd">                l = self.left + other.left</span>
<span class="sd">                r = self.right + other.right</span>
<span class="sd">                return TensorPair(l, r)</span>

<span class="sd">            def mul(self, other):</span>
<span class="sd">                l = self.left * other.left</span>
<span class="sd">                r = self.right * other.right</span>
<span class="sd">                return TensorPair(l, r)</span>

<span class="sd">        def use_tensor_pair_ctor(x : TensorPair, y : torch.Tensor):</span>
<span class="sd">            s = x.add(TensorPair(y, y))</span>
<span class="sd">            return s.mul(x)</span>

<span class="sd">        x = TensorPair(torch.randn(5, 3), torch.randn(5, 3))</span>
<span class="sd">        y = torch.randn(5, 3)</span>
<span class="sd">        ref_out = use_tensor_pair_ctor(x, y)</span>

<span class="sd">        traced = torch.fx.symbolic_trace(use_tensor_pair_ctor)</span>
<span class="sd">        print(traced.code)</span>
<span class="sd">        &#39;&#39;&#39;</span>
<span class="sd">        def forward(self, x : __main___TensorPair, y : torch.Tensor):</span>
<span class="sd">            tensor_pair = __main___TensorPair(y, y);  y = None</span>
<span class="sd">            add = x.add(tensor_pair);  tensor_pair = None</span>
<span class="sd">            mul = add.mul(x);  add = x = None</span>
<span class="sd">            return mul</span>
<span class="sd">        &#39;&#39;&#39;</span>

<span class="sd">    From this example, we can see that construction of a class (``TensorPair``)</span>
<span class="sd">    defined with ``ProxyableClassMeta`` as metaclass can be recorded in symbolic</span>
<span class="sd">    tracing.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="n">_proxyable_classes</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>  <span class="c1"># type: ignore[call-overload]</span>

        <span class="n">found_proxies</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">check_proxy</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">Proxy</span><span class="p">):</span>
                <span class="n">found_proxies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

        <span class="n">map_aggregate</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">check_proxy</span><span class="p">)</span>
        <span class="n">map_aggregate</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">check_proxy</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">found_proxies</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">tracer</span> <span class="o">=</span> <span class="n">found_proxies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tracer</span>
            <span class="k">return</span> <span class="n">tracer</span><span class="o">.</span><span class="n">create_proxy</span><span class="p">(</span><span class="s2">&quot;call_function&quot;</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># type: ignore[misc]</span>
            <span class="k">return</span> <span class="n">instance</span>


<span class="k">def</span> <span class="nf">_patch_function</span><span class="p">(</span><span class="n">fn</span><span class="p">:</span> <span class="n">FunctionType</span><span class="p">,</span> <span class="n">nargs</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FunctionType</span><span class="p">:</span>
    <span class="n">co</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="vm">__code__</span>
    <span class="n">co_flags</span> <span class="o">=</span> <span class="n">co</span><span class="o">.</span><span class="n">co_flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">HAS_VARSTUFF</span>
    <span class="n">co_args</span><span class="p">:</span> <span class="nb">tuple</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">co</span><span class="p">,</span> <span class="s2">&quot;co_qualname&quot;</span><span class="p">):</span>
        <span class="c1"># Python-3.11+ code signature</span>
        <span class="n">co_args</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">nargs</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="n">co</span><span class="o">.</span><span class="n">co_nlocals</span><span class="p">,</span>
            <span class="n">co</span><span class="o">.</span><span class="n">co_stacksize</span><span class="p">,</span>
            <span class="n">co_flags</span><span class="p">,</span>
            <span class="n">co</span><span class="o">.</span><span class="n">co_code</span><span class="p">,</span>
            <span class="n">co</span><span class="o">.</span><span class="n">co_consts</span><span class="p">,</span>
            <span class="n">co</span><span class="o">.</span><span class="n">co_names</span><span class="p">,</span>
            <span class="n">co</span><span class="o">.</span><span class="n">co_varnames</span><span class="p">,</span>
            <span class="n">co</span><span class="o">.</span><span class="n">co_filename</span><span class="p">,</span>
            <span class="n">co</span><span class="o">.</span><span class="n">co_name</span><span class="p">,</span>
            <span class="n">co</span><span class="o">.</span><span class="n">co_qualname</span><span class="p">,</span>  <span class="c1"># type: ignore[attr-defined]</span>
            <span class="n">co</span><span class="o">.</span><span class="n">co_firstlineno</span><span class="p">,</span>
            <span class="n">co</span><span class="o">.</span><span class="n">co_lnotab</span><span class="p">,</span>
            <span class="n">co</span><span class="o">.</span><span class="n">co_exceptiontable</span><span class="p">,</span>  <span class="c1"># type: ignore[attr-defined]</span>
            <span class="n">co</span><span class="o">.</span><span class="n">co_freevars</span><span class="p">,</span>
            <span class="n">co</span><span class="o">.</span><span class="n">co_cellvars</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">co</span><span class="p">,</span> <span class="s2">&quot;co_posonlyargcount&quot;</span><span class="p">):</span>
        <span class="n">co_args</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">nargs</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="n">co</span><span class="o">.</span><span class="n">co_nlocals</span><span class="p">,</span>
            <span class="n">co</span><span class="o">.</span><span class="n">co_stacksize</span><span class="p">,</span>
            <span class="n">co_flags</span><span class="p">,</span>
            <span class="n">co</span><span class="o">.</span><span class="n">co_code</span><span class="p">,</span>
            <span class="n">co</span><span class="o">.</span><span class="n">co_consts</span><span class="p">,</span>
            <span class="n">co</span><span class="o">.</span><span class="n">co_names</span><span class="p">,</span>
            <span class="n">co</span><span class="o">.</span><span class="n">co_varnames</span><span class="p">,</span>
            <span class="n">co</span><span class="o">.</span><span class="n">co_filename</span><span class="p">,</span>
            <span class="n">co</span><span class="o">.</span><span class="n">co_name</span><span class="p">,</span>
            <span class="n">co</span><span class="o">.</span><span class="n">co_firstlineno</span><span class="p">,</span>
            <span class="n">co</span><span class="o">.</span><span class="n">co_lnotab</span><span class="p">,</span>
            <span class="n">co</span><span class="o">.</span><span class="n">co_freevars</span><span class="p">,</span>
            <span class="n">co</span><span class="o">.</span><span class="n">co_cellvars</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">co_args</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">nargs</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="n">co</span><span class="o">.</span><span class="n">co_nlocals</span><span class="p">,</span>
            <span class="n">co</span><span class="o">.</span><span class="n">co_stacksize</span><span class="p">,</span>
            <span class="n">co_flags</span><span class="p">,</span>
            <span class="n">co</span><span class="o">.</span><span class="n">co_code</span><span class="p">,</span>
            <span class="n">co</span><span class="o">.</span><span class="n">co_consts</span><span class="p">,</span>
            <span class="n">co</span><span class="o">.</span><span class="n">co_names</span><span class="p">,</span>
            <span class="n">co</span><span class="o">.</span><span class="n">co_varnames</span><span class="p">,</span>
            <span class="n">co</span><span class="o">.</span><span class="n">co_filename</span><span class="p">,</span>
            <span class="n">co</span><span class="o">.</span><span class="n">co_name</span><span class="p">,</span>
            <span class="n">co</span><span class="o">.</span><span class="n">co_firstlineno</span><span class="p">,</span>
            <span class="n">co</span><span class="o">.</span><span class="n">co_lnotab</span><span class="p">,</span>
            <span class="n">co</span><span class="o">.</span><span class="n">co_freevars</span><span class="p">,</span>
            <span class="n">co</span><span class="o">.</span><span class="n">co_cellvars</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">new_code</span> <span class="o">=</span> <span class="n">CodeType</span><span class="p">(</span><span class="o">*</span><span class="n">co_args</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>
    <span class="k">return</span> <span class="n">FunctionType</span><span class="p">(</span>
        <span class="n">new_code</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="vm">__defaults__</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="vm">__closure__</span>
    <span class="p">)</span>

    <span class="c1"># we need to insert placeholder nodes for *args and **kwargs</span>
    <span class="c1"># we can&#39;t call this function normally, otherwise it would try to unpack them</span>
    <span class="c1"># instead, let&#39;s make python think that args and kwargs are normal variables</span>


<span class="nd">@compatibility</span><span class="p">(</span><span class="n">is_backward_compatible</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">PHBase</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Object representing an input placeholder to `concrete_args`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;PH&quot;</span>


<span class="n">PH</span> <span class="o">=</span> <span class="n">PHBase</span><span class="p">()</span>


<span class="nd">@compatibility</span><span class="p">(</span><span class="n">is_backward_compatible</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">PHWithMeta</span><span class="p">(</span><span class="n">PHBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Object representing an input placeholder to `concrete_args`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ph_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Provide a hey for user to identify placeholder node during analysis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ph_key</span> <span class="o">=</span> <span class="n">ph_key</span>


<div class="viewcode-block" id="Tracer"><a class="viewcode-back" href="../../../fx.html#torch.fx.Tracer">[docs]</a><span class="nd">@compatibility</span><span class="p">(</span><span class="n">is_backward_compatible</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Tracer</span><span class="p">(</span><span class="n">TracerBase</span><span class="p">):</span>
    <span class="c1"># Reference: https://github.com/pytorch/pytorch/issues/54354</span>
    <span class="c1"># The first line of this docstring overrides the one Sphinx generates for the</span>
    <span class="c1"># documentation. We need it so that Sphinx doesn&#39;t leak `math`s path from the</span>
    <span class="c1"># build environment (e.g. `&lt;module &#39;math&#39; from &#39;/leaked/path&#39;).</span>

    <span class="sd">&quot;&quot;&quot;Tracer(autowrap_modules=(math,), autowrap_functions=())</span>

<span class="sd">    ``Tracer`` is the class that implements the symbolic tracing functionality</span>
<span class="sd">    of ``torch.fx.symbolic_trace``. A call to ``symbolic_trace(m)`` is equivalent</span>
<span class="sd">    to ``Tracer().trace(m)``.</span>

<span class="sd">    Tracer can be subclassed to override various behaviors of the tracing</span>
<span class="sd">    process. The different behaviors that can be overridden are described</span>
<span class="sd">    in the docstrings of the methods on this class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Not checking BC on this API because the default value for `autowrap_modules`</span>
    <span class="c1"># includes the local filepath to the `math` module, which would jitter</span>
    <span class="c1"># across machines.</span>
    <span class="nd">@compatibility</span><span class="p">(</span><span class="n">is_backward_compatible</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">autowrap_modules</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">ModuleType</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">math</span><span class="p">,),</span>
        <span class="n">autowrap_functions</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
        <span class="n">param_shapes_constant</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># This method&#39;s signature is overridden by the first line of this class&#39;</span>
        <span class="c1"># docstring. If this method&#39;s signature is modified, the signature that</span>
        <span class="c1"># overrides it also should be modified accordingly.</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct a Tracer object.</span>

<span class="sd">        Args:</span>

<span class="sd">            autowrap_modules (Tuple[ModuleType]): defaults to `(math, )`,</span>
<span class="sd">                Python modules whose functions should be wrapped automatically</span>
<span class="sd">                without needing to use fx.wrap(). Backward-compatibility for</span>
<span class="sd">                this parameter is guaranteed.</span>

<span class="sd">            autowrap_functions (Tuple[Callable, ...]): defaults to `()`,</span>
<span class="sd">                Python functions that should be wrapped automatically without</span>
<span class="sd">                needing to use fx.wrap(). Backward compatibility for this</span>
<span class="sd">                parameter is guaranteed.</span>

<span class="sd">            param_shapes_constant (bool): When this flag is set,  calls to shape,</span>
<span class="sd">                size and a few other shape like attributes of a module&#39;s parameter</span>
<span class="sd">                will be evaluated directly, rather than returning a new Proxy value</span>
<span class="sd">                for an attribute access. Backward compatibility for this parameter</span>
<span class="sd">                is guaranteed.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Functions we will eagerly wrap when we see them while tracing</span>
        <span class="c1"># this captures both `math.sqrt()` and `from math import sqrt` automatically</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_autowrap_function_ids</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nb">id</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">autowrap_modules</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">callable</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_autowrap_function_ids</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="nb">id</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">autowrap_functions</span><span class="p">})</span>

        <span class="c1"># Python modules to apply autowrap to at the start, in addition to</span>
        <span class="c1"># modules we see while tracing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_autowrap_search</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ModuleType</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">autowrap_modules</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_shapes_constant</span> <span class="o">=</span> <span class="n">param_shapes_constant</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">submodule_paths</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root_module_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="c1"># Maps the containing module&#39;s name to the operator name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope</span> <span class="o">=</span> <span class="n">Scope</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># Records the module call stack</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module_stack</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="c1"># Mapping of node name to module scope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_name_to_scope</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">type</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="Tracer.create_arg"><a class="viewcode-back" href="../../../fx.html#torch.fx.Tracer.create_arg">[docs]</a>    <span class="nd">@compatibility</span><span class="p">(</span><span class="n">is_backward_compatible</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">create_arg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Argument&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A method to specify the behavior of tracing when preparing values to</span>
<span class="sd">        be used as arguments to nodes in the ``Graph``.</span>

<span class="sd">        By default, the behavior includes:</span>

<span class="sd">        #. Iterate through collection types (e.g. tuple, list, dict) and recursively</span>
<span class="sd">           call ``create_args`` on the elements.</span>
<span class="sd">        #. Given a Proxy object, return a reference to the underlying IR ``Node``</span>
<span class="sd">        #. Given a non-Proxy Tensor object, emit IR for various cases:</span>

<span class="sd">            * For a Parameter, emit a ``get_attr`` node referring to that Parameter</span>
<span class="sd">            * For a non-Parameter Tensor, store the Tensor away in a special</span>
<span class="sd">              attribute referring to that attribute.</span>

<span class="sd">        This method can be overridden to support more types.</span>

<span class="sd">        Args:</span>

<span class="sd">            a (Any): The value to be emitted as an ``Argument`` in the ``Graph``.</span>


<span class="sd">        Returns:</span>

<span class="sd">            The value ``a`` converted into the appropriate ``Argument``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The base tracer is used to construct Graphs when there is no associated</span>
        <span class="c1"># module hierarchy, so it can never create parameter references.</span>
        <span class="c1"># The default tracer adds the ability to refer to parameters when</span>
        <span class="c1"># tracing modules.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="n">p</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s2">&quot;get_attr&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="p">(),</span> <span class="p">{})</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s2">&quot;parameter is not a member of this module&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">n_</span><span class="p">,</span> <span class="n">p_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">named_buffers</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="n">p_</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s2">&quot;get_attr&quot;</span><span class="p">,</span> <span class="n">n_</span><span class="p">,</span> <span class="p">(),</span> <span class="p">{})</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">n_</span><span class="p">,</span> <span class="n">p_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">named_modules</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="n">p_</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s2">&quot;get_attr&quot;</span><span class="p">,</span> <span class="n">n_</span><span class="p">,</span> <span class="p">(),</span> <span class="p">{})</span>
        <span class="c1"># For NamedTuple instances that appear literally as args, we emit</span>
        <span class="c1"># a node to construct the NamedTuple and use that Node as the argument.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s2">&quot;_fields&quot;</span><span class="p">):</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">create_arg</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">a</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s2">&quot;call_function&quot;</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="p">{})</span>

        <span class="c1"># Tensors do not have a reliable string repr() from which they can be</span>
        <span class="c1"># constructed (and we probably don&#39;t want to rely on that, either), so</span>
        <span class="c1"># for any constant Tensor values we encounter, first search for if they</span>
        <span class="c1"># are an attribute of some module in the module hierarchy. If so, emit</span>
        <span class="c1"># a get_attr to retrieve that tensor. Otherwise, we&#39;ll store away the</span>
        <span class="c1"># tensor value into a special attribute on the Module s.t. we can</span>
        <span class="c1"># retrieve it with a get_attr.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">ScriptObject</span><span class="p">)):</span>
            <span class="n">qualname</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

            <span class="c1"># Tensor was not found in the Module hierarchy, stow it away in a</span>
            <span class="c1"># special attribute and set the qualname to refer to that</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">qualname</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">qualname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_tensor_constant</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">qualname</span><span class="p">):</span>
                        <span class="k">break</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tensor_attrs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">qualname</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">qualname</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s2">&quot;get_attr&quot;</span><span class="p">,</span> <span class="n">qualname</span><span class="p">,</span> <span class="p">(),</span> <span class="p">{})</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="ow">in</span> <span class="n">_proxyable_classes</span><span class="p">:</span>
            <span class="c1"># This is an instance of a proxyable class for which we did not</span>
            <span class="c1"># witness its construction. Intern this as a constant attribute</span>

            <span class="c1"># TODO: binary search</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">qualname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">a</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">_constant_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">qualname</span><span class="p">):</span>
                    <span class="k">break</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">qualname</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s2">&quot;get_attr&quot;</span><span class="p">,</span> <span class="n">qualname</span><span class="p">,</span> <span class="p">(),</span> <span class="p">{})</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">create_arg</span><span class="p">(</span><span class="n">a</span><span class="p">)</span></div>

<div class="viewcode-block" id="Tracer.is_leaf_module"><a class="viewcode-back" href="../../../fx.html#torch.fx.Tracer.is_leaf_module">[docs]</a>    <span class="nd">@compatibility</span><span class="p">(</span><span class="n">is_backward_compatible</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">is_leaf_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">module_qualified_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A method to specify whether a given ``nn.Module`` is a &quot;leaf&quot; module.</span>

<span class="sd">        Leaf modules are the atomic units that appear in</span>
<span class="sd">        the IR, referenced by ``call_module`` calls. By default,</span>
<span class="sd">        Modules in the PyTorch standard library namespace (torch.nn)</span>
<span class="sd">        are leaf modules. All other modules are traced through and</span>
<span class="sd">        their constituent ops are recorded, unless specified otherwise</span>
<span class="sd">        via this parameter.</span>

<span class="sd">        Args:</span>

<span class="sd">            m (Module): The module being queried about</span>
<span class="sd">            module_qualified_name (str): The path to root of this module. For example,</span>
<span class="sd">                if you have a module hierarchy where submodule ``foo`` contains</span>
<span class="sd">                submodule ``bar``, which contains submodule ``baz``, that module will</span>
<span class="sd">                appear with the qualified name ``foo.bar.baz`` here.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="vm">__module__</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;torch.nn&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">m</span><span class="o">.</span><span class="vm">__module__</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;torch.ao.nn&quot;</span><span class="p">))</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Tracer.path_of_module"><a class="viewcode-back" href="../../../fx.html#torch.fx.Tracer.path_of_module">[docs]</a>    <span class="nd">@compatibility</span><span class="p">(</span><span class="n">is_backward_compatible</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">path_of_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mod</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper method to find the qualified name of ``mod`` in the Module hierarchy</span>
<span class="sd">        of ``root``. For example, if ``root`` has a submodule named ``foo``, which has</span>
<span class="sd">        a submodule named ``bar``, passing ``bar`` into this function will return</span>
<span class="sd">        the string &quot;foo.bar&quot;.</span>

<span class="sd">        Args:</span>

<span class="sd">            mod (str): The ``Module`` to retrieve the qualified name for.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Prefer the O(1) algorithm</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">submodule_paths</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">submodule_paths</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s2">&quot;module is not installed as a submodule&quot;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">path</span>
        <span class="c1"># O(N^2) fallback in the case that we didn&#39;t store the submodule</span>
        <span class="c1"># paths.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">named_modules</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">mod</span> <span class="ow">is</span> <span class="n">p</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">n</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s2">&quot;module is not installed as a submodule&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Tracer.call_module"><a class="viewcode-back" href="../../../fx.html#torch.fx.Tracer.call_module">[docs]</a>    <span class="nd">@compatibility</span><span class="p">(</span><span class="n">is_backward_compatible</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">call_module</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">m</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span>
        <span class="n">forward</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">args</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
        <span class="n">kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method that specifies the behavior of this ``Tracer`` when it encounters</span>
<span class="sd">        a call to an ``nn.Module`` instance.</span>

<span class="sd">        By default, the behavior is to check if the called module is a leaf module</span>
<span class="sd">        via ``is_leaf_module``. If it is, emit a ``call_module`` node referring to</span>
<span class="sd">        ``m`` in the ``Graph``. Otherwise, call the ``Module`` normally, tracing through</span>
<span class="sd">        the operations in its ``forward`` function.</span>

<span class="sd">        This method can be overridden to--for example--create nested traced</span>
<span class="sd">        GraphModules, or any other behavior you would want while tracing across</span>
<span class="sd">        ``Module`` boundaries.</span>

<span class="sd">        Args:</span>

<span class="sd">            m (Module): The module for which a call is being emitted</span>
<span class="sd">            forward (Callable): The forward() method of the ``Module`` to be invoked</span>
<span class="sd">            args (Tuple): args of the module callsite</span>
<span class="sd">            kwargs (Dict): kwargs of the module callsite</span>

<span class="sd">        Return:</span>

<span class="sd">            The return value from the Module call. In the case that a ``call_module``</span>
<span class="sd">            node was emitted, this is a ``Proxy`` value. Otherwise, it is whatever</span>
<span class="sd">            value was returned from the ``Module`` invocation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">module_qualified_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_of_module</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">ScopeContextManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span> <span class="n">Scope</span><span class="p">(</span><span class="n">module_qualified_name</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">m</span><span class="p">)))</span> <span class="k">as</span> <span class="n">_scope</span><span class="p">:</span>
            <span class="c1"># module_stack is an ordered dict so writing then deleting the</span>
            <span class="c1"># entry is equivalent to push/pop on a list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module_stack</span><span class="p">[</span><span class="n">_scope</span><span class="o">.</span><span class="n">module_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">_scope</span><span class="o">.</span><span class="n">module_type</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_leaf_module</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">module_qualified_name</span><span class="p">):</span>
                <span class="n">ret_val</span> <span class="o">=</span> <span class="n">forward</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ret_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_proxy</span><span class="p">(</span><span class="s2">&quot;call_module&quot;</span><span class="p">,</span> <span class="n">module_qualified_name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_stack</span><span class="o">.</span><span class="n">popitem</span><span class="p">(</span><span class="n">last</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">key</span> <span class="o">==</span> <span class="n">_scope</span><span class="o">.</span><span class="n">module_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot; Unexpected key </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="n">ret_val</span></div>

<div class="viewcode-block" id="Tracer.getattr"><a class="viewcode-back" href="../../../fx.html#torch.fx.Tracer.getattr">[docs]</a>    <span class="nd">@compatibility</span><span class="p">(</span><span class="n">is_backward_compatible</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">attr_val</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">parameter_proxy_cache</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method that specifies the behavior of this ``Tracer`` when we call getattr</span>
<span class="sd">        on a call to an ``nn.Module`` instance.</span>

<span class="sd">        By default, the behavior is to return a proxy value for the attribute. It</span>
<span class="sd">        also stores the proxy value in the ``parameter_proxy_cache``, so that future</span>
<span class="sd">        calls will reuse the proxy rather than creating a new one.</span>

<span class="sd">        This method can be overridden to --for example-- not return proxies when</span>
<span class="sd">        querying parameters.</span>

<span class="sd">        Args:</span>

<span class="sd">            attr (str): The name of the attribute being queried</span>
<span class="sd">            attr_val (Any): The value of the attribute</span>
<span class="sd">            parameter_proxy_cache (Dict[str, Any]): A cache of attr names to proxies</span>

<span class="sd">        Return:</span>

<span class="sd">            The return value from the getattr call.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">maybe_get_proxy_for_attr</span><span class="p">(</span>
            <span class="n">attr_val</span><span class="p">,</span> <span class="n">collection_to_search</span><span class="p">,</span> <span class="n">parameter_proxy_cache</span>
        <span class="p">):</span>
            <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">collection_to_search</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attr_val</span> <span class="ow">is</span> <span class="n">p</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">parameter_proxy_cache</span><span class="p">:</span>
                        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">if</span> <span class="p">(</span>
                            <span class="s2">&quot;proxy_factory_fn&quot;</span>
                            <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">create_proxy</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span>
                        <span class="p">):</span>
                            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;proxy_factory_fn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="kc">None</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_shapes_constant</span>
                                <span class="k">else</span> <span class="k">lambda</span> <span class="n">node</span><span class="p">:</span> <span class="n">ParameterProxy</span><span class="p">(</span>
                                    <span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">attr_val</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                        <span class="n">val_proxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_proxy</span><span class="p">(</span><span class="s2">&quot;get_attr&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="p">(),</span> <span class="p">{},</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>
                        <span class="n">parameter_proxy_cache</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">val_proxy</span>
                    <span class="k">return</span> <span class="n">parameter_proxy_cache</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr_val</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">):</span>
            <span class="n">maybe_parameter_proxy</span> <span class="o">=</span> <span class="n">maybe_get_proxy_for_attr</span><span class="p">(</span>
                <span class="n">attr_val</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">(),</span> <span class="n">parameter_proxy_cache</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">maybe_parameter_proxy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">maybe_parameter_proxy</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_buffer_attributes</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr_val</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="n">maybe_buffer_proxy</span> <span class="o">=</span> <span class="n">maybe_get_proxy_for_attr</span><span class="p">(</span>
                <span class="n">attr_val</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">named_buffers</span><span class="p">(),</span> <span class="n">parameter_proxy_cache</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">maybe_buffer_proxy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">maybe_buffer_proxy</span>

        <span class="k">return</span> <span class="n">attr_val</span></div>

    <span class="c1"># This method will be refactored</span>
<div class="viewcode-block" id="Tracer.create_args_for_root"><a class="viewcode-back" href="../../../fx.html#torch.fx.Tracer.create_args_for_root">[docs]</a>    <span class="nd">@compatibility</span><span class="p">(</span><span class="n">is_backward_compatible</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">create_args_for_root</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root_fn</span><span class="p">,</span> <span class="n">is_module</span><span class="p">,</span> <span class="n">concrete_args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create ``placeholder`` nodes corresponding to the signature of the ``root``</span>
<span class="sd">        Module. This method introspects root&#39;s signature and emits those</span>
<span class="sd">        nodes accordingly, also supporting ``*args`` and ``**kwargs``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># In some cases, a function or method has been decorated with a wrapper</span>
        <span class="c1"># defined via ``functools.wraps``. In this case, the outer code object</span>
        <span class="c1"># will likely not contain the actual parameters we care about, so unwrap</span>
        <span class="c1"># the function to get to the innermost callable.</span>
        <span class="n">fn_for_analysis</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">root_fn</span><span class="p">)</span>
        <span class="n">co</span> <span class="o">=</span> <span class="n">fn_for_analysis</span><span class="o">.</span><span class="vm">__code__</span>
        <span class="n">total_args</span> <span class="o">=</span> <span class="n">co</span><span class="o">.</span><span class="n">co_argcount</span> <span class="o">+</span> <span class="n">co</span><span class="o">.</span><span class="n">co_kwonlyargcount</span>
        <span class="n">orig_args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">co</span><span class="o">.</span><span class="n">co_varnames</span><span class="p">)</span>
        <span class="n">names_iter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">co</span><span class="o">.</span><span class="n">co_varnames</span><span class="p">)</span>
        <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">skip_arg_idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">is_module</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">total_args</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s2">&quot;``self`` argument cannot be part of *args expansion!&quot;</span>
                <span class="p">)</span>
            <span class="n">skip_arg_idx</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="nb">next</span><span class="p">(</span><span class="n">names_iter</span><span class="p">)</span>  <span class="c1"># skip self</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>

        <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">fn_for_analysis</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">proxy_placeholder</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">concrete_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">concrete_args</span><span class="p">:</span>
                <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">def</span> <span class="nf">replace_ph</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                    <span class="k">nonlocal</span> <span class="n">cnt</span>
                    <span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">param</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                    <span class="n">default</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="p">()</span>
                        <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span>
                        <span class="k">else</span> <span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">default</span><span class="p">,)</span>
                    <span class="p">)</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_proxy</span><span class="p">(</span>
                        <span class="s2">&quot;placeholder&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">cnt</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="p">{}</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">PHBase</span><span class="p">):</span>
                        <span class="k">def</span> <span class="nf">transfer_attrs</span><span class="p">(</span><span class="n">fr</span><span class="p">,</span> <span class="n">to</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">fr</span><span class="p">):</span>
                                <span class="n">attr_val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">fr</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>
                                <span class="k">if</span> <span class="p">(</span>
                                    <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">attr_val</span><span class="p">)</span>
                                    <span class="ow">and</span> <span class="ow">not</span> <span class="n">attr_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">)</span>
                                    <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>
                                <span class="p">):</span>
                                    <span class="nb">setattr</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">attr_val</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">PH</span><span class="p">:</span>
                            <span class="c1"># Transfer attrs in the case where you&#39;re using a placeholder other</span>
                            <span class="c1"># than the singleton PH (PH has no attributes to transfer).</span>
                            <span class="c1"># Proxies were created out of the placeholders.</span>
                            <span class="c1"># Transfer any metadata (put on the placeholders in the form of</span>
                            <span class="c1"># attributes set by the user) from the placeholder to the</span>
                            <span class="c1"># underlying nodes (the proxy is unwrapped by the user, but</span>
                            <span class="c1"># the metadata should hold).</span>
                            <span class="n">transfer_attrs</span><span class="p">(</span><span class="n">fr</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="n">out</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>

                        <span class="k">return</span> <span class="n">out</span>
                    <span class="c1"># Union[int, bool] == bool in Python &lt;= 3.6</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">bool</span>
                        <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">in</span> <span class="n">base_types</span>
                        <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>
                    <span class="p">):</span>
                        <span class="n">torch</span><span class="o">.</span><span class="n">_assert</span><span class="p">(</span>
                            <span class="n">out</span> <span class="o">==</span> <span class="n">x</span><span class="p">,</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> has been specialized to have value </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2"> but got another value&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">out</span><span class="p">,</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> has been specialized to have value None but got another value&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">create_proxy</span><span class="p">(</span><span class="s2">&quot;call_function&quot;</span><span class="p">,</span> <span class="n">_assert_is_none</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Was not able to add assertion to guarantee correct input </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> to &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;specialized function. It is up to the user to make sure that your inputs match the &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;inputs you specialized the function with.&quot;</span>
                        <span class="p">)</span>

                    <span class="k">return</span> <span class="n">x</span>

                <span class="k">return</span> <span class="n">pytree</span><span class="o">.</span><span class="n">tree_map</span><span class="p">(</span><span class="n">replace_ph</span><span class="p">,</span> <span class="n">concrete_args</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span><span class="p">:</span>
                <span class="n">default</span> <span class="o">=</span> <span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">param</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="n">default</span> <span class="o">=</span> <span class="p">()</span> <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span> <span class="k">else</span> <span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">default</span><span class="p">,)</span>  <span class="c1"># type: ignore[assignment]</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_proxy</span><span class="p">(</span>
                <span class="s2">&quot;placeholder&quot;</span><span class="p">,</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="n">default</span><span class="p">,</span>
                <span class="p">{},</span>
                <span class="n">type_expr</span><span class="o">=</span><span class="n">fn_for_analysis</span><span class="o">.</span><span class="vm">__annotations__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="n">arg_names</span> <span class="o">=</span> <span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="n">names_iter</span><span class="p">)</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">skip_arg_idx</span><span class="p">,</span> <span class="n">total_args</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">concrete_args</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg_names</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">concrete_args</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Tracing expected </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">arg_names</span><span class="p">)</span><span class="si">}</span><span class="s2"> arguments but got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">concrete_args</span><span class="p">)</span><span class="si">}</span><span class="s2"> concrete arguments&quot;</span>
                <span class="p">)</span>
            <span class="n">concrete_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">arg_names</span><span class="p">,</span> <span class="n">concrete_args</span><span class="p">))</span>
        <span class="n">args</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">proxy_placeholder</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="k">for</span> <span class="n">names</span> <span class="ow">in</span> <span class="n">arg_names</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">co</span><span class="o">.</span><span class="n">co_kwonlyargcount</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">co</span><span class="o">.</span><span class="n">co_flags</span> <span class="o">&amp;</span> <span class="n">HAS_VARSTUFF</span><span class="p">:</span>
            <span class="c1"># TODO: type annotations for *args and **kwargs</span>
            <span class="k">if</span> <span class="n">co</span><span class="o">.</span><span class="n">co_flags</span> <span class="o">&amp;</span> <span class="n">inspect</span><span class="o">.</span><span class="n">CO_VARARGS</span><span class="p">:</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proxy_placeholder</span><span class="p">(</span><span class="s2">&quot;*&quot;</span> <span class="o">+</span> <span class="nb">next</span><span class="p">(</span><span class="n">names_iter</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">co</span><span class="o">.</span><span class="n">co_flags</span> <span class="o">&amp;</span> <span class="n">inspect</span><span class="o">.</span><span class="n">CO_VARKEYWORDS</span><span class="p">:</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proxy_placeholder</span><span class="p">(</span><span class="s2">&quot;**&quot;</span> <span class="o">+</span> <span class="nb">next</span><span class="p">(</span><span class="n">names_iter</span><span class="p">)))</span>
            <span class="n">root_fn</span> <span class="o">=</span> <span class="n">_patch_function</span><span class="p">(</span><span class="n">root_fn</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>

        <span class="n">flat_args</span><span class="p">,</span> <span class="n">in_spec</span> <span class="o">=</span> <span class="n">pytree</span><span class="o">.</span><span class="n">tree_flatten</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">pytree</span><span class="o">.</span><span class="n">LeafSpec</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">in_spec</span><span class="o">.</span><span class="n">children_specs</span><span class="p">):</span>
            <span class="c1"># In the case that we have pytree-flattened inputs in</span>
            <span class="c1"># `concrete_args`, generate a flattening wrapper around the</span>
            <span class="c1"># original root function and return that.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">_codegen</span> <span class="o">=</span> <span class="n">_PyTreeCodeGen</span><span class="p">(</span>
                <span class="n">_PyTreeInfo</span><span class="p">(</span><span class="n">orig_args</span><span class="p">[:</span><span class="n">total_args</span><span class="p">],</span> <span class="n">in_spec</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">def</span> <span class="nf">flatten_fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
                <span class="n">tree_args</span> <span class="o">=</span> <span class="n">pytree</span><span class="o">.</span><span class="n">tree_unflatten</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="n">in_spec</span><span class="p">)</span>
                <span class="n">tree_out</span> <span class="o">=</span> <span class="n">root_fn</span><span class="p">(</span><span class="o">*</span><span class="n">tree_args</span><span class="p">)</span>
                <span class="n">out_args</span><span class="p">,</span> <span class="n">out_spec</span> <span class="o">=</span> <span class="n">pytree</span><span class="o">.</span><span class="n">tree_flatten</span><span class="p">(</span><span class="n">tree_out</span><span class="p">)</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">_codegen</span><span class="p">,</span> <span class="n">_PyTreeCodeGen</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">_codegen</span><span class="o">.</span><span class="n">pytree_info</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">_codegen</span><span class="o">.</span><span class="n">pytree_info</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">out_spec</span><span class="o">=</span><span class="n">out_spec</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">out_args</span>

            <span class="k">return</span> <span class="n">flatten_fn</span><span class="p">,</span> <span class="n">flat_args</span>
        <span class="k">return</span> <span class="n">root_fn</span><span class="p">,</span> <span class="n">args</span></div>

<div class="viewcode-block" id="Tracer.trace"><a class="viewcode-back" href="../../../fx.html#torch.fx.Tracer.trace">[docs]</a>    <span class="nd">@compatibility</span><span class="p">(</span><span class="n">is_backward_compatible</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nd">@torch</span><span class="o">.</span><span class="n">_disable_dynamo</span>
    <span class="k">def</span> <span class="nf">trace</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">root</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">concrete_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Graph</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Trace ``root`` and return the corresponding FX ``Graph`` representation. ``root``</span>
<span class="sd">        can either be an ``nn.Module`` instance or a Python callable.</span>

<span class="sd">        Note that after this call, ``self.root`` may be different from the ``root`` passed</span>
<span class="sd">        in here. For example, when a free function is passed to ``trace()``, we will</span>
<span class="sd">        create an ``nn.Module`` instance to use as the root and add embedded constants</span>
<span class="sd">        to.</span>


<span class="sd">        Args:</span>

<span class="sd">            root (Union[Module, Callable]): Either a ``Module`` or a function to be</span>
<span class="sd">                traced through. Backwards-compatibility for this parameter is</span>
<span class="sd">                guaranteed.</span>
<span class="sd">            concrete_args (Optional[Dict[str, any]]): Concrete arguments that should</span>
<span class="sd">                not be treated as Proxies. This parameter is experimental and</span>
<span class="sd">                its backwards-compatibility is *NOT* guaranteed.</span>

<span class="sd">        Returns:</span>

<span class="sd">            A ``Graph`` representing the semantics of the passed-in ``root``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">global</span> <span class="n">_is_fx_tracing_flag</span>
        <span class="n">old_is_fx_tracing_flag</span> <span class="o">=</span> <span class="n">_is_fx_tracing_flag</span>
        <span class="n">_is_fx_tracing_flag</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span>

                <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span>
                    <span class="nb">type</span><span class="p">(</span><span class="n">root</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">traced_func_name</span>
                <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;traced_func_name=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">traced_func_name</span><span class="si">}</span><span class="s2"> doesn&#39;t exist in </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">root</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>

                <span class="n">fn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">root</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">traced_func_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">root_module_name</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">_get_name</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">submodule_paths</span> <span class="o">=</span> <span class="p">{</span><span class="n">mod</span><span class="p">:</span> <span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">mod</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">named_modules</span><span class="p">()}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">()</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="n">root</span>

            <span class="n">tracer_cls</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="s2">&quot;Tracer&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;__class__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="n">Graph</span><span class="p">(</span><span class="n">tracer_cls</span><span class="o">=</span><span class="n">tracer_cls</span><span class="p">)</span>

            <span class="c1"># When we encounter a Tensor value that&#39;s not a parameter, we look if it</span>
            <span class="c1"># is some other attribute on the model. Construct a dict mapping Tensor</span>
            <span class="c1"># values to the qualified name here for efficiency. This is used downstream</span>
            <span class="c1"># in create_arg</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tensor_attrs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">ScriptObject</span><span class="p">],</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">def</span> <span class="nf">collect_tensor_attrs</span><span class="p">(</span><span class="n">m</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">prefix_atoms</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">ScriptObject</span><span class="p">)):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">tensor_attrs</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prefix_atoms</span> <span class="o">+</span> <span class="p">[</span><span class="n">k</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">named_children</span><span class="p">():</span>
                    <span class="n">collect_tensor_attrs</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">prefix_atoms</span> <span class="o">+</span> <span class="p">[</span><span class="n">k</span><span class="p">])</span>

            <span class="n">collect_tensor_attrs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="p">[])</span>

            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">FunctionType</span><span class="p">)</span>

            <span class="n">fn_globals</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="vm">__globals__</span>  <span class="c1"># run before it gets patched</span>
            <span class="n">fn</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_args_for_root</span><span class="p">(</span>
                <span class="n">fn</span><span class="p">,</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">),</span> <span class="n">concrete_args</span>
            <span class="p">)</span>

            <span class="n">parameter_proxy_cache</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span>
                <span class="nb">str</span><span class="p">,</span> <span class="n">Proxy</span>
            <span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Reduce number of get_attr calls</span>

            <span class="c1"># Method dispatch on parameters is not recorded unless it&#39;s directly used.</span>
            <span class="c1"># Thus, we need to insert a proxy when __getattr__ requests a parameter.</span>
            <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">_orig_module_getattr</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">module_getattr_wrapper</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
                <span class="n">attr_val</span> <span class="o">=</span> <span class="n">_orig_module_getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getattr</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">attr_val</span><span class="p">,</span> <span class="n">parameter_proxy_cache</span><span class="p">)</span>

            <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">_orig_module_call</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">module_call_wrapper</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">_orig_module_call</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

                <span class="n">_autowrap_check</span><span class="p">(</span>
                    <span class="n">patcher</span><span class="p">,</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="s2">&quot;forward&quot;</span><span class="p">,</span> <span class="n">mod</span><span class="p">),</span> <span class="s2">&quot;__globals__&quot;</span><span class="p">,</span> <span class="p">{}),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_autowrap_function_ids</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_module</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">forward</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">_Patcher</span><span class="p">()</span> <span class="k">as</span> <span class="n">patcher</span><span class="p">:</span>
                <span class="c1"># allow duplicate patches to support the case of nested calls</span>
                <span class="n">patcher</span><span class="o">.</span><span class="n">patch_method</span><span class="p">(</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span>
                    <span class="s2">&quot;__getattr__&quot;</span><span class="p">,</span>
                    <span class="n">module_getattr_wrapper</span><span class="p">,</span>
                    <span class="n">deduplicate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">patcher</span><span class="o">.</span><span class="n">patch_method</span><span class="p">(</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="s2">&quot;__call__&quot;</span><span class="p">,</span> <span class="n">module_call_wrapper</span><span class="p">,</span> <span class="n">deduplicate</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
                <span class="n">_patch_wrapped_functions</span><span class="p">(</span><span class="n">patcher</span><span class="p">)</span>
                <span class="n">_autowrap_check</span><span class="p">(</span><span class="n">patcher</span><span class="p">,</span> <span class="n">fn_globals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_autowrap_function_ids</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_autowrap_search</span><span class="p">:</span>
                    <span class="n">_autowrap_check</span><span class="p">(</span>
                        <span class="n">patcher</span><span class="p">,</span> <span class="n">module</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_autowrap_function_ids</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span>
                    <span class="s2">&quot;output&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;output&quot;</span><span class="p">,</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">create_arg</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)),),</span>
                    <span class="p">{},</span>
                    <span class="n">type_expr</span><span class="o">=</span><span class="n">fn</span><span class="o">.</span><span class="vm">__annotations__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;return&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">submodule_paths</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">_is_fx_tracing_flag</span> <span class="o">=</span> <span class="n">old_is_fx_tracing_flag</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span></div>

    <span class="k">def</span> <span class="nf">__deepcopy__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="c1"># _autowrap_search contains modules, which cannot be deepcopied.</span>
        <span class="n">new_tracer</span> <span class="o">=</span> <span class="n">Tracer</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">Tracer</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;_autowrap_search&#39;</span><span class="p">}:</span>
                <span class="n">new_obj</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_obj</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span>

            <span class="n">new_tracer</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_obj</span>

        <span class="k">return</span> <span class="n">new_tracer</span></div>


<span class="c1"># List of pairs of (global dict, function name) functions</span>
<span class="c1"># to patch for the purposes of the wrap() API.</span>
<span class="n">_wrapped_fns_to_patch</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># List of methods on classes to wrap (class type, function name)</span>
<span class="c1"># this currently only works for Tensor.* methods that aren&#39;t traced properly</span>
<span class="n">_wrapped_methods_to_patch</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">type</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;FX_PATCH_GETITEM&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span>
    <span class="c1"># This change is needed to trace models like PositionalEmbedding from BERT:</span>
    <span class="c1"># https://github.com/pytorch/benchmark/blob/master/torchbenchmark/models/BERT_pytorch/bert_pytorch/model/embedding/position.py</span>
    <span class="c1"># but causes issues in quantization documented here:</span>
    <span class="c1"># https://github.com/pytorch/pytorch/issues/50710</span>
    <span class="c1"># once that is fixed we can make this the default behavior.</span>
    <span class="n">_wrapped_methods_to_patch</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;__getitem__&quot;</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_find_proxy</span><span class="p">(</span><span class="o">*</span><span class="n">objects_to_search</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Recursively search a data structure for a Proxy() and return it,</span>
<span class="sd">    return None if not found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">proxy</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">find_proxy</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">nonlocal</span> <span class="n">proxy</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Proxy</span><span class="p">):</span>
            <span class="n">proxy</span> <span class="o">=</span> <span class="n">x</span>

    <span class="n">map_aggregate</span><span class="p">(</span><span class="n">objects_to_search</span><span class="p">,</span> <span class="n">find_proxy</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">proxy</span>


<span class="k">def</span> <span class="nf">_create_wrapped_func</span><span class="p">(</span><span class="n">orig_fn</span><span class="p">):</span>
    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">orig_fn</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given an closed-over ``orig_function`` to invoke, search the args and kwargs for</span>
<span class="sd">        a Proxy object. If there is one, emit a ``call_function`` node to preserve the</span>
<span class="sd">        call to this leaf function directly. Otherwise, just return the results of</span>
<span class="sd">        this function call, as this function is not being traced.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">proxy</span> <span class="o">=</span> <span class="n">_find_proxy</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">proxy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">return_proxy</span> <span class="o">=</span> <span class="n">proxy</span><span class="o">.</span><span class="n">tracer</span><span class="o">.</span><span class="n">create_proxy</span><span class="p">(</span>
                <span class="s2">&quot;call_function&quot;</span><span class="p">,</span> <span class="n">orig_fn</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span>
            <span class="p">)</span>
            <span class="n">return_proxy</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;is_wrapped&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="n">return_proxy</span>
        <span class="k">return</span> <span class="n">orig_fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">wrapped</span>


<span class="k">def</span> <span class="nf">_create_wrapped_method</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="n">orig_fn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">orig_fn</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Search the args and kwargs for a Proxy object. If there is one,</span>
<span class="sd">        emit a ``call_method`` node to preserve the call to this method</span>
<span class="sd">        directly. Otherwise, just return the results of this function</span>
<span class="sd">        call, as this function is not being traced.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">proxy</span> <span class="o">=</span> <span class="n">_find_proxy</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">proxy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">proxy</span><span class="o">.</span><span class="n">tracer</span><span class="o">.</span><span class="n">create_proxy</span><span class="p">(</span><span class="s2">&quot;call_method&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">orig_fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">wrapped</span>


<span class="k">class</span> <span class="nc">_PatchedFn</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="n">frame_dict</span><span class="p">:</span> <span class="n">Any</span>
    <span class="n">fn_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">orig_fn</span><span class="p">:</span> <span class="n">Any</span>

    <span class="k">def</span> <span class="nf">revert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">_PatchedFnSetItem</span><span class="p">(</span><span class="n">_PatchedFn</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">revert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fn_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_fn</span>


<span class="k">class</span> <span class="nc">_PatchedFnDel</span><span class="p">(</span><span class="n">_PatchedFn</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">revert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fn_name</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">_PatchedFnSetAttr</span><span class="p">(</span><span class="n">_PatchedFn</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">revert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame_dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_fn</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_Patcher</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patches_made</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">_PatchedFn</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visited</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">patch</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">frame_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">new_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
        <span class="n">deduplicate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Replace frame_dict[name] with new_fn until we exit the context manager.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_fn</span><span class="o">.</span><span class="n">__fx_already_patched</span> <span class="o">=</span> <span class="n">deduplicate</span>  <span class="c1"># type: ignore[attr-defined]</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">frame_dict</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">builtins</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">patches_made</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_PatchedFnDel</span><span class="p">(</span><span class="n">frame_dict</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">frame_dict</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="s2">&quot;__fx_already_patched&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">return</span>  <span class="c1"># already patched, no need to do it again</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">patches_made</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">_PatchedFnSetItem</span><span class="p">(</span><span class="n">frame_dict</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">frame_dict</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="n">frame_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_fn</span>

    <span class="k">def</span> <span class="nf">patch_method</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">:</span> <span class="nb">type</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">deduplicate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Replace object_or_dict.name with new_fn until we exit the context manager.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_fn</span><span class="o">.</span><span class="n">__fx_already_patched</span> <span class="o">=</span> <span class="n">deduplicate</span>  <span class="c1"># type: ignore[attr-defined]</span>
        <span class="n">orig_fn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">orig_fn</span><span class="p">,</span> <span class="s2">&quot;__fx_already_patched&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">return</span>  <span class="c1"># already patched, no need to do it again</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patches_made</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_PatchedFnSetAttr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">orig_fn</span><span class="p">))</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">new_fn</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_once</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thing</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return True on the first call to with thing, otherwise false&quot;&quot;&quot;</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">visited</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Undo all the changes made via self.patch() and self.patch_method()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">patches_made</span><span class="p">:</span>
            <span class="c1"># unpatch in reverse order to handle duplicates correctly</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">patches_made</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span><span class="o">.</span><span class="n">revert</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visited</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_patch_wrapped_functions</span><span class="p">(</span><span class="n">patcher</span><span class="p">:</span> <span class="n">_Patcher</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Go through ``_wrapped_fn_patch_table`` and, for each frame object, wrap</span>
<span class="sd">    the listed global functions in the `_create_wrapped_func` wrapper.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">frame_dict</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">_wrapped_fns_to_patch</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">frame_dict</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">builtins</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="n">orig_fn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">builtins</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">orig_fn</span> <span class="o">=</span> <span class="n">frame_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="n">patcher</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">frame_dict</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">_create_wrapped_func</span><span class="p">(</span><span class="n">orig_fn</span><span class="p">))</span>

    <span class="k">for</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">_wrapped_methods_to_patch</span><span class="p">:</span>
        <span class="n">patcher</span><span class="o">.</span><span class="n">patch_method</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">_create_wrapped_method</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_autowrap_check</span><span class="p">(</span>
    <span class="n">patcher</span><span class="p">:</span> <span class="n">_Patcher</span><span class="p">,</span> <span class="n">frame_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">function_ids</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Some methods, like `math.sqrt` are common enough we want to automatically wrap them as we see them.</span>
<span class="sd">    This method searches a scope for them and patches them if found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">patcher</span><span class="o">.</span><span class="n">visit_once</span><span class="p">(</span><span class="n">frame_dict</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">frame_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">callable</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="ow">and</span> <span class="nb">id</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">function_ids</span>
            <span class="p">):</span>
                <span class="n">patcher</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">frame_dict</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">_create_wrapped_func</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>


<div class="viewcode-block" id="wrap"><a class="viewcode-back" href="../../../fx.html#torch.fx.wrap">[docs]</a><span class="nd">@compatibility</span><span class="p">(</span><span class="n">is_backward_compatible</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">fn_or_name</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function can be called at module-level scope to register fn_or_name as a &quot;leaf function&quot;.</span>
<span class="sd">    A &quot;leaf function&quot; will be preserved as a CallFunction node in the FX trace instead of being</span>
<span class="sd">    traced through::</span>

<span class="sd">        # foo/bar/baz.py</span>
<span class="sd">        def my_custom_function(x, y):</span>
<span class="sd">            return x * x + y * y</span>

<span class="sd">        torch.fx.wrap(&#39;my_custom_function&#39;)</span>

<span class="sd">        def fn_to_be_traced(x, y):</span>
<span class="sd">            # When symbolic tracing, the below call to my_custom_function will be inserted into</span>
<span class="sd">            # the graph rather than tracing it.</span>
<span class="sd">            return my_custom_function(x, y)</span>

<span class="sd">    This function can also equivalently be used as a decorator::</span>

<span class="sd">        # foo/bar/baz.py</span>
<span class="sd">        @torch.fx.wrap</span>
<span class="sd">        def my_custom_function(x, y):</span>
<span class="sd">            return x * x + y * y</span>

<span class="sd">    A wrapped function can be thought of a &quot;leaf function&quot;, analogous to the concept of</span>
<span class="sd">    &quot;leaf modules&quot;, that is, they are functions that are left as calls in the FX trace</span>
<span class="sd">    rather than traced through.</span>

<span class="sd">    Args:</span>

<span class="sd">        fn_or_name (Union[str, Callable]): The function or name of the global function to insert into the</span>
<span class="sd">            graph when it&#39;s called</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">fn_or_name</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fn_or_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;Unsupported type for global function! Must be either a callable or &quot;</span>
            <span class="s2">&quot;string name&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">fn_or_name</span><span class="p">):</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fn_or_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>  <span class="c1"># to make mypy happy</span>
        <span class="n">fn_name</span> <span class="o">=</span> <span class="n">fn_or_name</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">fn_or_name</span><span class="p">,</span> <span class="nb">str</span>
        <span class="p">),</span> <span class="s2">&quot;fn_or_name must be a global function or string name&quot;</span>
        <span class="n">fn_name</span> <span class="o">=</span> <span class="n">fn_or_name</span>

    <span class="n">currentframe</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">currentframe</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">currentframe</span><span class="o">.</span><span class="n">f_back</span>
    <span class="k">assert</span> <span class="n">f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span> <span class="o">!=</span> <span class="s2">&quot;&lt;module&gt;&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;wrap must be called at the top level of a module&quot;</span><span class="p">)</span>

    <span class="c1"># consider implementing Callable version of this via _autowrap_function_ids / _autowrap_search</span>
    <span class="c1"># semantics would be slightly different, but would add support `from x import wrapped_function`</span>
    <span class="n">_wrapped_fns_to_patch</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">f</span><span class="o">.</span><span class="n">f_globals</span><span class="p">,</span> <span class="n">fn_name</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">fn_or_name</span></div>


<div class="viewcode-block" id="symbolic_trace"><a class="viewcode-back" href="../../../fx.html#torch.fx.symbolic_trace">[docs]</a><span class="nd">@compatibility</span><span class="p">(</span><span class="n">is_backward_compatible</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">symbolic_trace</span><span class="p">(</span>
    <span class="n">root</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="n">concrete_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GraphModule</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Symbolic tracing API</span>

<span class="sd">    Given an ``nn.Module`` or function instance ``root``, this function will return a ``GraphModule``</span>
<span class="sd">    constructed by recording operations seen while tracing through ``root``.</span>

<span class="sd">    ``concrete_args`` allows you to partially specialize your function, whether it&#39;s to remove control flow or data structures.</span>

<span class="sd">    For example::</span>

<span class="sd">        def f(a, b):</span>
<span class="sd">            if b == True:</span>
<span class="sd">                return a</span>
<span class="sd">            else:</span>
<span class="sd">                return a*2</span>

<span class="sd">    FX can typically not trace through this due to the presence of control</span>
<span class="sd">    flow. However, we can use `concrete_args` to specialize on the value of</span>
<span class="sd">    `b` to trace through this::</span>

<span class="sd">        f = fx.symbolic_trace(f, concrete_args={&#39;b&#39;: False})</span>
<span class="sd">        assert f(3, False)  == 6</span>

<span class="sd">    Note that although you can still pass in different values of `b`, they will be ignored.</span>

<span class="sd">    We can also use `concrete_args` to eliminate data-structure handling from</span>
<span class="sd">    our function. This will use pytrees to flatten your input. To avoid</span>
<span class="sd">    overspecializing, pass in `fx.PH` for values that shouldn&#39;t be</span>
<span class="sd">    specialized. For example::</span>

<span class="sd">        def f(x):</span>
<span class="sd">            out = 0</span>
<span class="sd">            for v in x.values():</span>
<span class="sd">                out += v</span>
<span class="sd">            return out</span>
<span class="sd">        f = fx.symbolic_trace(f, concrete_args={&#39;x&#39;: {&#39;a&#39;: fx.PH, &#39;b&#39;: fx.PH, &#39;c&#39;: fx.PH}})</span>
<span class="sd">        assert f({&#39;a&#39;: 1, &#39;b&#39;: 2, &#39;c&#39;: 4}) == 7</span>


<span class="sd">    Args:</span>
<span class="sd">        root (Union[torch.nn.Module, Callable]): Module or function to be traced and converted</span>
<span class="sd">            into a Graph representation.</span>
<span class="sd">        concrete_args (Optional[Dict[str, any]]): Inputs to be partially specialized</span>

<span class="sd">    Returns:</span>
<span class="sd">        GraphModule: a Module created from the recorded operations from ``root``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tracer</span> <span class="o">=</span> <span class="n">Tracer</span><span class="p">()</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">tracer</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">concrete_args</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">root</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">)</span> <span class="k">else</span> <span class="n">root</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">GraphModule</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span></div>


<span class="nd">@wrap</span>
<span class="k">def</span> <span class="nf">_assert_is_none</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="n">msg</span>
</pre></div>

             </article>
             
            </div>
            <footer>
  

  

    <hr>

  

  <div role="contentinfo">
    <p>
        &copy; Copyright 2023, PyTorch Contributors.

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>
     

</footer>

          </div>
<script>

var match = window.location.href.match(/\/_[a-zA-Z0-9_]*.html|_dynamo/gi);
var url = window.location.href.lastIndexOf(match[match.length-1]);

if (url)
  {
    var div = '<div class="admonition note"><p class="admonition-title">Note</p><p><i class="fa fa-exclamation-circle" aria-hidden="true">&nbsp</i> This page describes an internal API which is not intended to be used outside of the PyTorch codebase and can be modified or removed without notice.</p></div>'
    document.getElementById("pytorch-article").insertAdjacentHTML('afterBegin', div)
  }
</script>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              
            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
         <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
         <script src="../../../_static/jquery.js"></script>
         <script src="../../../_static/underscore.js"></script>
         <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
         <script src="../../../_static/doctools.js"></script>
         <script src="../../../_static/sphinx_highlight.js"></script>
         <script src="../../../_static/clipboard.min.js"></script>
         <script src="../../../_static/copybutton.js"></script>
     

  

  <script type="text/javascript" src="../../../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 
<script script type="text/javascript">
  var collapsedSections = ['Developer Notes', 'Language Bindings', 'Libraries', 'Community'];
</script>

<img height="1" width="1" style="border-style:none;" alt="" src="https://www.googleadservices.com/pagead/conversion/795629140/?label=txkmCPmdtosBENSssfsC&amp;guid=ON&amp;script=0"/>


  <!-- Begin Footer -->

  <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
    <div class="container">
      <div class="row">
        <div class="col-md-4 text-center">
          <h2>Docs</h2>
          <p>Access comprehensive developer documentation for PyTorch</p>
          <a class="with-right-arrow" href="https://pytorch.org/docs/stable/index.html">View Docs</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Tutorials</h2>
          <p>Get in-depth tutorials for beginners and advanced developers</p>
          <a class="with-right-arrow" href="https://pytorch.org/tutorials">View Tutorials</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Resources</h2>
          <p>Find development resources and get your questions answered</p>
          <a class="with-right-arrow" href="https://pytorch.org/resources">View Resources</a>
        </div>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container footer-container">
      <div class="footer-logo-wrapper">
        <a href="https://pytorch.org/" class="footer-logo"></a>
      </div>

      <div class="footer-links-wrapper">
        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/">PyTorch</a></li>
            <li><a href="https://pytorch.org/get-started">Get Started</a></li>
            <li><a href="https://pytorch.org/features">Features</a></li>
            <li><a href="https://pytorch.org/ecosystem">Ecosystem</a></li>
            <li><a href="https://pytorch.org/blog/">Blog</a></li>
            <li><a href="https://github.com/pytorch/pytorch/blob/master/CONTRIBUTING.md">Contributing</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/resources">Resources</a></li>
            <li><a href="https://pytorch.org/tutorials">Tutorials</a></li>
            <li><a href="https://pytorch.org/docs/stable/index.html">Docs</a></li>
            <li><a href="https://discuss.pytorch.org" target="_blank">Discuss</a></li>
            <li><a href="https://github.com/pytorch/pytorch/issues" target="_blank">Github Issues</a></li>
            <li><a href="https://pytorch.org/assets/brand-guidelines/PyTorch-Brand-Guidelines.pdf" target="_blank">Brand Guidelines</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title">Stay up to date</li>
            <li><a href="https://www.facebook.com/pytorch" target="_blank">Facebook</a></li>
            <li><a href="https://twitter.com/pytorch" target="_blank">Twitter</a></li>
            <li><a href="https://www.youtube.com/pytorch" target="_blank">YouTube</a></li>
            <li><a href="https://www.linkedin.com/company/pytorch" target="_blank">LinkedIn</a></li>
          </ul>  
          </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title">PyTorch Podcasts</li>
            <li><a href="https://open.spotify.com/show/6UzHKeiy368jKfQMKKvJY5" target="_blank">Spotify</a></li>
            <li><a href="https://podcasts.apple.com/us/podcast/pytorch-developer-podcast/id1566080008" target="_blank">Apple</a></li>
            <li><a href="https://www.google.com/podcasts?feed=aHR0cHM6Ly9mZWVkcy5zaW1wbGVjYXN0LmNvbS9PQjVGa0lsOA%3D%3D" target="_blank">Google</a></li>
            <li><a href="https://music.amazon.com/podcasts/7a4e6f0e-26c2-49e9-a478-41bd244197d0/PyTorch-Developer-Podcast?" target="_blank">Amazon</a></li>
          </ul>
         </div>
        </div>
        
        <div class="privacy-policy">
          <ul>
            <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/terms/" target="_blank">Terms</a></li>
            <li class="privacy-policy-links">|</li>
            <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/privacy-policy/" target="_blank">Privacy</a></li>
          </ul>
        </div>
        <div class="copyright">
        <p>Â© Copyright The Linux Foundation. The PyTorch Foundation is a project of The Linux Foundation.
          For web site terms of use, trademark policy and other policies applicable to The PyTorch Foundation please see
          <a href="www.linuxfoundation.org/policies/">www.linuxfoundation.org/policies/</a>. The PyTorch Foundation supports the PyTorch open source
          project, which has been established as PyTorch Project a Series of LF Projects, LLC. For policies applicable to the PyTorch Project a Series of LF Projects, LLC,
          please see <a href="www.lfprojects.org/policies/">www.lfprojects.org/policies/</a>.</p>
      </div>
     </div>

  </footer>

  <div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebookâ€™s Cookies Policy applies. Learn more, including about available controls: <a href="https://www.facebook.com/policies/cookies/">Cookies Policy</a>.</p>
    <img class="close-button" src="../../../_static/images/pytorch-x.svg">
  </div>
</div>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>
            
          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li class="resources-mobile-menu-title" class="active">
            Docs
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/docs/stable/index.html">PyTorch</a>
            </li>

            <li>
              <a href="https://pytorch.org/audio/stable/index.html">torchaudio</a>
            </li>

            <li>
              <a href="https://pytorch.org/text/stable/index.html">torchtext</a>
            </li>

            <li>
              <a href="https://pytorch.org/vision/stable/index.html">torchvision</a>
            </li>

            <li>
              <a href="https://pytorch.org/torcharrow">torcharrow</a>
            </li>

            <li>
              <a href="https://pytorch.org/data">TorchData</a>
            </li>

            <li>
              <a href="https://pytorch.org/torchrec">TorchRec</a>
            </li>

            <li>
              <a href="https://pytorch.org/serve/">TorchServe</a>
            </li>

            <li>
              <a href="https://pytorch.org/torchx/">TorchX</a>
            </li>

            <li>
              <a href="https://pytorch.org/xla">PyTorch on XLA Devices</a>
            </li>
          </ul>

          <li class="resources-mobile-menu-title">
            Resources
          </li>
            
           <ul class="resources-mobile-menu-items">

            <li>
              <a href="https://pytorch.org/features">About</a>
            </li>

            <li>
              <a href="https://pytorch.org/foundation">PyTorch Foundation</a>
            </li>

            <li>
              <a href="https://pytorch.org/#community-module">Community</a>
            </li>

            <li>
              <a href="https://pytorch.org/community-stories">Community Stories</a>
            </li>

            <li>
              <a href="https://pytorch.org/resources">Developer Resources</a>
            </li>

            <li>
              <a href="https://pytorch.org/events">Events</a>
            </li>

            <li>
              <a href="https://discuss.pytorch.org/">Forums</a>
            </li>

            <li>
              <a href="https://pytorch.org/hub">Models (Beta)</a>
            </li>
          </ul>

          <li>
            <a href="https://github.com/pytorch/pytorch">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="../../../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>