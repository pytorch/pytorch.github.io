


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta name="robots" content="noindex">
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>torch.autograd.function &mdash; PyTorch main documentation</title>
  

  
  
  
  
    <link rel="canonical" href="https://pytorch.org/docs/stable/_modules/torch/autograd/function.html"/>
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.css" type="text/css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/katex-math.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx-dropdown.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/panels-bootstrap.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/jit.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />

<!--
  Search engines should not index the main version of documentation.
  Stable documentation are built without release == 'main'.
-->
<meta name="robots" content="noindex">


  <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-T8XT4PS');</script>
    <!-- End Google Tag Manager -->
  


  
  <script src="../../../_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>

          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li class="active docs-active">
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-orange-arrow">
                Docs
              </a>
              <div class="resources-dropdown-menu">
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/docs/stable/index.html">
                  <span class="dropdown-title">PyTorch</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/audio/stable/index.html">
                  <span class="dropdown-title">torchaudio</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/text/stable/index.html">
                  <span class="dropdown-title">torchtext</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/vision/stable/index.html">
                  <span class="dropdown-title">torchvision</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torcharrow">
                  <span class="dropdown-title">torcharrow</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/data">
                  <span class="dropdown-title">TorchData</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torchrec">
                  <span class="dropdown-title">TorchRec</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/serve/">
                  <span class="dropdown-title">TorchServe</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torchx/">
                  <span class="dropdown-title">TorchX</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/xla">
                  <span class="dropdown-title">PyTorch on XLA Devices</span>
                  <p></p>
                </a>
            </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-arrow">
                Resources
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/features">
                  <span class="dropdown-title">About</span>
                  <p>Learn about PyTorchâ€™s features and capabilities</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/foundation">
                  <span class="dropdown-title">PyTorch Foundation</span>
                  <p>Learn about the PyTorch foundation</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/#community-module">
                  <span class="dropdown-title">Community</span>
                  <p>Join the PyTorch developer community to contribute, learn, and get your questions answered.</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/community-stories">
                  <span class="dropdown-title">Community Stories</span>
                  <p>Learn how our community solves real, everyday machine learning problems with PyTorch.</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/resources">
                  <span class="dropdown-title">Developer Resources</span>
                  <p>Find resources and get questions answered</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/events">
                  <span class="dropdown-title">Events</span>
                  <p>Find events, webinars, and podcasts</p>
                </a>
                <a class="nav-dropdown-item" href="https://discuss.pytorch.org/" target="_blank">
                  <span class="dropdown-title">Forums</span>
                  <p>A place to discuss PyTorch code, issues, install, research</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/hub">
                  <span class="dropdown-title">Models (Beta)</span>
                  <p>Discover, publish, and reuse pre-trained models</p>
                </a>
              </div>
            </div>
          </li>

          <li>
            <a href="https://github.com/pytorch/pytorch">GitHub</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>

<body class="pytorch-body">

   

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            
    <div class="version">
      <a href='https://pytorch.org/docs/versions.html'>main (2.1.0a0+git707d265 ) &#x25BC</a>
    </div>
    


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          </div>

          

<div>
  <a style="color:#F05732" href="https://pytorch.org/docs/stable/_modules/torch/autograd/function.html">
    You are viewing unstable developer preview docs.
    Click here to view docs for latest stable release.
  </a>
</div>


            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Community</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../community/build_ci_governance.html">PyTorch Governance | Build + CI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/contribution_guide.html">PyTorch Contribution Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/design.html">PyTorch Design Philosophy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/governance.html">PyTorch Governance | Mechanics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/persons_of_interest.html">PyTorch Governance | Maintainers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/amp_examples.html">CUDA Automatic Mixed Precision examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/autograd.html">Autograd mechanics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/broadcasting.html">Broadcasting semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/cpu_threading_torchscript_inference.html">CPU threading and TorchScript inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/cuda.html">CUDA semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/ddp.html">Distributed Data Parallel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/extending.html">Extending PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/extending.func.html">Extending torch.func with autograd.Function</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/gradcheck.html">Gradcheck mechanics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/hip.html">HIP (ROCm) semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/large_scale_deployments.html">Features for large-scale deployments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/modules.html">Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/mps.html">MPS backend</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/multiprocessing.html">Multiprocessing best practices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/numerical_accuracy.html">Numerical accuracy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/randomness.html">Reproducibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/serialization.html">Serialization semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/windows.html">Windows FAQ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">torch.compile</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/index.html">torch.compile</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/get-started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/troubleshooting.html">PyTorch 2.0 Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/technical-overview.html">Technical Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/guards-overview.html">Guards Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/custom-backends.html">Custom Backends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/fine_grained_apis.html">TorchDynamo APIs to control fine-grained tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/profiling_torch_compile.html">Profiling to understand torch.compile performance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/inductor_profiling.html">TorchInductor GPU Profiling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/deep-dive.html">TorchDynamo Deeper Dive</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/cudagraph_trees.html">CUDAGraph Trees</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/performance-dashboard.html">PyTorch 2.0 Performance Dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/torchfunc-and-torchcompile.html">torch.func interaction with torch.compile</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ir.html">IRs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/dynamic-shapes.html">Dynamic shapes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/fake-tensor.html">Fake tensor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../logging.html">torch._logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/transformations.html">Writing Graph Transformations on ATen IR</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Language Bindings</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../cpp_index.html">C++</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/javadoc/">Javadoc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../deploy.html">torch::deploy</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Python API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../torch.html">torch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nn.html">torch.nn</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nn.functional.html">torch.nn.functional</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tensors.html">torch.Tensor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tensor_attributes.html">Tensor Attributes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tensor_view.html">Tensor Views</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../amp.html">torch.amp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../autograd.html">torch.autograd</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../library.html">torch.library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cuda.html">torch.cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mps.html">torch.mps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../backends.html">torch.backends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../export.html">torch._export.export</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.html">torch.distributed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.algorithms.join.html">torch.distributed.algorithms.join</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.elastic.html">torch.distributed.elastic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fsdp.html">torch.distributed.fsdp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.optim.html">torch.distributed.optim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.tensor.parallel.html">torch.distributed.tensor.parallel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.checkpoint.html">torch.distributed.checkpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributions.html">torch.distributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compiler.html">torch.compiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fft.html">torch.fft</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../func.html">torch.func</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../futures.html">torch.futures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fx.html">torch.fx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hub.html">torch.hub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../jit.html">torch.jit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../linalg.html">torch.linalg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../monitor.html">torch.monitor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../signal.html">torch.signal</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../special.html">torch.special</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../torch.overrides.html">torch.overrides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../package.html">torch.package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../profiler.html">torch.profiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nn.init.html">torch.nn.init</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../onnx.html">torch.onnx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../onnx_diagnostics.html">torch.onnx diagnostics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../optim.html">torch.optim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../complex_numbers.html">Complex Numbers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ddp_comm_hooks.html">DDP Communication Hooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pipeline.html">Pipeline Parallelism</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quantization.html">Quantization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rpc.html">Distributed RPC Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../random.html">torch.random</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../masked.html">torch.masked</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nested.html">torch.nested</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sparse.html">torch.sparse</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../storage.html">torch.Storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../testing.html">torch.testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../benchmark_utils.html">torch.utils.benchmark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../bottleneck.html">torch.utils.bottleneck</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../checkpoint.html">torch.utils.checkpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cpp_extension.html">torch.utils.cpp_extension</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data.html">torch.utils.data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../jit_utils.html">torch.utils.jit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dlpack.html">torch.utils.dlpack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mobile_optimizer.html">torch.utils.mobile_optimizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../model_zoo.html">torch.utils.model_zoo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tensorboard.html">torch.utils.tensorboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../type_info.html">Type Info</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../named_tensor.html">Named Tensors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../name_inference.html">Named Tensors operator coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../config_mod.html">torch.__config__</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../logging.html">torch._logging</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Libraries</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/audio/stable">torchaudio</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/data">TorchData</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/torchrec">TorchRec</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/serve">TorchServe</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/text/stable">torchtext</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/vision/stable">torchvision</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/xla/">PyTorch on XLA Devices</a></li>
</ul>

            
          

        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="../../../index.html">
          
            Docs
          
        </a> &gt;
      </li>

        
          <li><a href="../../index.html">Module code</a> &gt;</li>
        
          <li><a href="../../torch.html">torch</a> &gt;</li>
        
          <li><a href="../autograd.html">torch.autograd</a> &gt;</li>
        
      <li>torch.autograd.function</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">

        

          <!-- Google Tag Manager (noscript) -->
          <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T8XT4PS"
          height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
          <!-- End Google Tag Manager (noscript) -->
          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <h1>Source code for torch.autograd.function</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch._C</span> <span class="k">as</span> <span class="nn">_C</span>
<span class="kn">from</span> <span class="nn">torch._C</span> <span class="kn">import</span> <span class="n">_functions</span>
<span class="kn">import</span> <span class="nn">torch._functorch</span> <span class="k">as</span> <span class="nn">_functorch</span>
<span class="kn">import</span> <span class="nn">torch.utils.hooks</span> <span class="k">as</span> <span class="nn">hooks</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="nn">torch._functorch.autograd_function</span> <span class="kn">import</span> <span class="n">custom_function_call</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;FunctionCtx&quot;</span><span class="p">,</span> <span class="s2">&quot;BackwardCFunction&quot;</span><span class="p">,</span> <span class="s2">&quot;FunctionMeta&quot;</span><span class="p">,</span> <span class="s2">&quot;Function&quot;</span><span class="p">,</span> <span class="s2">&quot;once_differentiable&quot;</span><span class="p">,</span> <span class="s2">&quot;traceable&quot;</span><span class="p">,</span>
           <span class="s2">&quot;InplaceFunction&quot;</span><span class="p">,</span> <span class="s2">&quot;NestedIOFunction&quot;</span><span class="p">]</span>

<span class="c1"># Formerly known as: _ContextMethodMixin</span>
<span class="k">class</span> <span class="nc">FunctionCtx</span><span class="p">:</span>

<div class="viewcode-block" id="FunctionCtx.save_for_backward"><a class="viewcode-back" href="../../../generated/torch.autograd.function.FunctionCtx.save_for_backward.html#torch.autograd.FunctionCtx.save_for_backward">[docs]</a>    <span class="k">def</span> <span class="nf">save_for_backward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">tensors</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Saves given tensors for a future call to :func:`~Function.backward`.</span>

<span class="sd">        ``save_for_backward`` should be called at most once, only from inside the</span>
<span class="sd">        :func:`forward` method, and only with tensors.</span>

<span class="sd">        All tensors intended to be used in the backward pass should be saved</span>
<span class="sd">        with ``save_for_backward`` (as opposed to directly on ``ctx``) to prevent</span>
<span class="sd">        incorrect gradients and memory leaks, and enable the application of saved</span>
<span class="sd">        tensor hooks. See :class:`torch.autograd.graph.saved_tensors_hooks`.</span>

<span class="sd">        Note that if intermediary tensors, tensors that are neither inputs</span>
<span class="sd">        nor outputs of :func:`forward`, are saved for backward, your custom Function</span>
<span class="sd">        may not support double backward.</span>
<span class="sd">        Custom Functions that do not support double backward should decorate their</span>
<span class="sd">        :func:`backward` method with ``@once_differentiable`` so that performing</span>
<span class="sd">        double backward raises an error. If you&#39;d like to support double backward,</span>
<span class="sd">        you can either recompute intermediaries based on the inputs during backward</span>
<span class="sd">        or return the intermediaries as the outputs of the custom Function. See the</span>
<span class="sd">        `double backward tutorial &lt;https://pytorch.org/tutorials/intermediate/custom_function_double_backward_tutorial.html&gt;`_</span>
<span class="sd">        for more details.</span>

<span class="sd">        In :func:`backward`, saved tensors can be accessed through the :attr:`saved_tensors`</span>
<span class="sd">        attribute. Before returning them to the user, a check is made to ensure</span>
<span class="sd">        they weren&#39;t used in any in-place operation that modified their content.</span>

<span class="sd">        Arguments can also be ``None``. This is a no-op.</span>

<span class="sd">        See :ref:`extending-autograd` for more details on how to use this method.</span>

<span class="sd">        Example::</span>
<span class="sd">            &gt;&gt;&gt; # xdoctest: +REQUIRES(env:TORCH_DOCTEST_AUTOGRAD)</span>
<span class="sd">            &gt;&gt;&gt; class Func(Function):</span>
<span class="sd">            &gt;&gt;&gt;     @staticmethod</span>
<span class="sd">            &gt;&gt;&gt;     def forward(ctx, x: torch.Tensor, y: torch.Tensor, z: int):</span>
<span class="sd">            &gt;&gt;&gt;         w = x * z</span>
<span class="sd">            &gt;&gt;&gt;         out = x * y + y * z + w * y</span>
<span class="sd">            &gt;&gt;&gt;         ctx.save_for_backward(x, y, w, out)</span>
<span class="sd">            &gt;&gt;&gt;         ctx.z = z  # z is not a tensor</span>
<span class="sd">            &gt;&gt;&gt;         return out</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt;     @staticmethod</span>
<span class="sd">            &gt;&gt;&gt;     @once_differentiable</span>
<span class="sd">            &gt;&gt;&gt;     def backward(ctx, grad_out):</span>
<span class="sd">            &gt;&gt;&gt;         x, y, w, out = ctx.saved_tensors</span>
<span class="sd">            &gt;&gt;&gt;         z = ctx.z</span>
<span class="sd">            &gt;&gt;&gt;         gx = grad_out * (y + y * z)</span>
<span class="sd">            &gt;&gt;&gt;         gy = grad_out * (x + z + w)</span>
<span class="sd">            &gt;&gt;&gt;         gz = None</span>
<span class="sd">            &gt;&gt;&gt;         return gx, gy, gz</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; a = torch.tensor(1., requires_grad=True, dtype=torch.double)</span>
<span class="sd">            &gt;&gt;&gt; b = torch.tensor(2., requires_grad=True, dtype=torch.double)</span>
<span class="sd">            &gt;&gt;&gt; c = 4</span>
<span class="sd">            &gt;&gt;&gt; d = Func.apply(a, b, c)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">to_save</span> <span class="o">=</span> <span class="n">tensors</span></div>

    <span class="k">def</span> <span class="nf">save_for_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">tensors</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Saves given tensors for a future call to :func:`~Function.jvp`.</span>

<span class="sd">        ``save_for_forward`` should be only called once, from inside the :func:`forward`</span>
<span class="sd">        method, and only be called with tensors.</span>

<span class="sd">        In :func:`jvp`, saved objects can be accessed through the :attr:`saved_tensors`</span>
<span class="sd">        attribute.</span>

<span class="sd">        Arguments can also be ``None``. This is a no-op.</span>

<span class="sd">        See :ref:`extending-autograd` for more details on how to use this method.</span>

<span class="sd">        Example::</span>
<span class="sd">            &gt;&gt;&gt; # xdoctest: +SKIP</span>
<span class="sd">            &gt;&gt;&gt; class Func(torch.autograd.Function):</span>
<span class="sd">            &gt;&gt;&gt;     @staticmethod</span>
<span class="sd">            &gt;&gt;&gt;     def forward(ctx, x: torch.Tensor, y: torch.Tensor, z: int):</span>
<span class="sd">            &gt;&gt;&gt;         ctx.save_for_backward(x, y)</span>
<span class="sd">            &gt;&gt;&gt;         ctx.save_for_forward(x, y)</span>
<span class="sd">            &gt;&gt;&gt;         ctx.z = z</span>
<span class="sd">            &gt;&gt;&gt;         return x * y * z</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt;     @staticmethod</span>
<span class="sd">            &gt;&gt;&gt;     def jvp(ctx, x_t, y_t, _):</span>
<span class="sd">            &gt;&gt;&gt;         x, y = ctx.saved_tensors</span>
<span class="sd">            &gt;&gt;&gt;         z = ctx.z</span>
<span class="sd">            &gt;&gt;&gt;         return z * (y * x_t + x * y_t)</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt;     @staticmethod</span>
<span class="sd">            &gt;&gt;&gt;     def vjp(ctx, grad_out):</span>
<span class="sd">            &gt;&gt;&gt;         x, y = ctx.saved_tensors</span>
<span class="sd">            &gt;&gt;&gt;         z = ctx.z</span>
<span class="sd">            &gt;&gt;&gt;         return z * grad_out * y, z * grad_out * x, None</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt;     a = torch.tensor(1., requires_grad=True, dtype=torch.double)</span>
<span class="sd">            &gt;&gt;&gt;     t = torch.tensor(1., dtype=torch.double)</span>
<span class="sd">            &gt;&gt;&gt;     b = torch.tensor(2., requires_grad=True, dtype=torch.double)</span>
<span class="sd">            &gt;&gt;&gt;     c = 4</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt;     with fwAD.dual_level():</span>
<span class="sd">            &gt;&gt;&gt;         a_dual = fwAD.make_dual(a, t)</span>
<span class="sd">            &gt;&gt;&gt;         d = Func.apply(a_dual, b, c)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">tensor</span> <span class="ow">in</span> <span class="n">tensors</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="ow">or</span> <span class="n">tensor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="p">(</span>
                <span class="s2">&quot;save_for_forward expects all arguments to be tensors; you should &quot;</span>
                <span class="s2">&quot;save non-tensors as attributes on ctx.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">saved_for_forward</span> <span class="o">=</span> <span class="n">tensors</span>

<div class="viewcode-block" id="FunctionCtx.mark_dirty"><a class="viewcode-back" href="../../../generated/torch.autograd.function.FunctionCtx.mark_dirty.html#torch.autograd.FunctionCtx.mark_dirty">[docs]</a>    <span class="k">def</span> <span class="nf">mark_dirty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Marks given tensors as modified in an in-place operation.</span>

<span class="sd">        **This should be called at most once, only from inside the**</span>
<span class="sd">        :func:`forward` **method, and all arguments should be inputs.**</span>

<span class="sd">        Every tensor that&#39;s been modified in-place in a call to :func:`forward`</span>
<span class="sd">        should be given to this function, to ensure correctness of our checks.</span>
<span class="sd">        It doesn&#39;t matter whether the function is called before or after</span>
<span class="sd">        modification.</span>

<span class="sd">        Examples::</span>
<span class="sd">            &gt;&gt;&gt; # xdoctest: +REQUIRES(env:TORCH_DOCTEST_AUTOGRAD)</span>
<span class="sd">            &gt;&gt;&gt; class Inplace(Function):</span>
<span class="sd">            &gt;&gt;&gt;     @staticmethod</span>
<span class="sd">            &gt;&gt;&gt;     def forward(ctx, x):</span>
<span class="sd">            &gt;&gt;&gt;         x_npy = x.numpy() # x_npy shares storage with x</span>
<span class="sd">            &gt;&gt;&gt;         x_npy += 1</span>
<span class="sd">            &gt;&gt;&gt;         ctx.mark_dirty(x)</span>
<span class="sd">            &gt;&gt;&gt;         return x</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt;     @staticmethod</span>
<span class="sd">            &gt;&gt;&gt;     @once_differentiable</span>
<span class="sd">            &gt;&gt;&gt;     def backward(ctx, grad_output):</span>
<span class="sd">            &gt;&gt;&gt;         return grad_output</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; a = torch.tensor(1., requires_grad=True, dtype=torch.double).clone()</span>
<span class="sd">            &gt;&gt;&gt; b = a * a</span>
<span class="sd">            &gt;&gt;&gt; Inplace.apply(a)  # This would lead to wrong gradients!</span>
<span class="sd">            &gt;&gt;&gt;                   # but the engine would not know unless we mark_dirty</span>
<span class="sd">            &gt;&gt;&gt; # xdoctest: +SKIP</span>
<span class="sd">            &gt;&gt;&gt; b.backward() # RuntimeError: one of the variables needed for gradient</span>
<span class="sd">            &gt;&gt;&gt;              # computation has been modified by an inplace operation</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dirty_tensors</span> <span class="o">=</span> <span class="n">args</span></div>

    <span class="k">def</span> <span class="nf">mark_shared_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">pairs</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s1">&#39;mark_shared_storage is deprecated. &#39;</span>
            <span class="s1">&#39;Tensors with shared storages are automatically tracked. Note &#39;</span>
            <span class="s1">&#39;that calls to `set_()` are not tracked&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="FunctionCtx.mark_non_differentiable"><a class="viewcode-back" href="../../../generated/torch.autograd.function.FunctionCtx.mark_non_differentiable.html#torch.autograd.FunctionCtx.mark_non_differentiable">[docs]</a>    <span class="k">def</span> <span class="nf">mark_non_differentiable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Marks outputs as non-differentiable.</span>

<span class="sd">        **This should be called at most once, only from inside the**</span>
<span class="sd">        :func:`forward` **method, and all arguments should be tensor outputs.**</span>

<span class="sd">        This will mark outputs as not requiring gradients, increasing the</span>
<span class="sd">        efficiency of backward computation. You still need to accept a gradient</span>
<span class="sd">        for each output in :meth:`~Function.backward`, but it&#39;s always going to</span>
<span class="sd">        be a zero tensor with the same shape as the shape of a corresponding</span>
<span class="sd">        output.</span>

<span class="sd">        This is used e.g. for indices returned from a sort. See example::</span>
<span class="sd">            &gt;&gt;&gt; class Func(Function):</span>
<span class="sd">            &gt;&gt;&gt;     @staticmethod</span>
<span class="sd">            &gt;&gt;&gt;     def forward(ctx, x):</span>
<span class="sd">            &gt;&gt;&gt;         sorted, idx = x.sort()</span>
<span class="sd">            &gt;&gt;&gt;         ctx.mark_non_differentiable(idx)</span>
<span class="sd">            &gt;&gt;&gt;         ctx.save_for_backward(x, idx)</span>
<span class="sd">            &gt;&gt;&gt;         return sorted, idx</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt;     @staticmethod</span>
<span class="sd">            &gt;&gt;&gt;     @once_differentiable</span>
<span class="sd">            &gt;&gt;&gt;     def backward(ctx, g1, g2):  # still need to accept g2</span>
<span class="sd">            &gt;&gt;&gt;         x, idx = ctx.saved_tensors</span>
<span class="sd">            &gt;&gt;&gt;         grad_input = torch.zeros_like(x)</span>
<span class="sd">            &gt;&gt;&gt;         grad_input.index_add_(0, idx, g1)</span>
<span class="sd">            &gt;&gt;&gt;         return grad_input</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">non_differentiable</span> <span class="o">=</span> <span class="n">args</span></div>

<div class="viewcode-block" id="FunctionCtx.set_materialize_grads"><a class="viewcode-back" href="../../../generated/torch.autograd.function.FunctionCtx.set_materialize_grads.html#torch.autograd.FunctionCtx.set_materialize_grads">[docs]</a>    <span class="k">def</span> <span class="nf">set_materialize_grads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Sets whether to materialize grad tensors. Default is ``True``.</span>

<span class="sd">        **This should be called only from inside the** :func:`forward` **method**</span>

<span class="sd">        If ``True``, undefined grad tensors will be expanded to tensors full of zeros</span>
<span class="sd">        prior to calling the :func:`backward` and :func:`jvp` methods.</span>

<span class="sd">        Example::</span>
<span class="sd">            &gt;&gt;&gt; # xdoctest: +REQUIRES(env:TORCH_DOCTEST_AUTOGRAD)</span>
<span class="sd">            &gt;&gt;&gt; class SimpleFunc(Function):</span>
<span class="sd">            &gt;&gt;&gt;     @staticmethod</span>
<span class="sd">            &gt;&gt;&gt;     def forward(ctx, x):</span>
<span class="sd">            &gt;&gt;&gt;         return x.clone(), x.clone()</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt;     @staticmethod</span>
<span class="sd">            &gt;&gt;&gt;     @once_differentiable</span>
<span class="sd">            &gt;&gt;&gt;     def backward(ctx, g1, g2):</span>
<span class="sd">            &gt;&gt;&gt;         return g1 + g2  # No check for None necessary</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; # We modify SimpleFunc to handle non-materialized grad outputs</span>
<span class="sd">            &gt;&gt;&gt; class Func(Function):</span>
<span class="sd">            &gt;&gt;&gt;     @staticmethod</span>
<span class="sd">            &gt;&gt;&gt;     def forward(ctx, x):</span>
<span class="sd">            &gt;&gt;&gt;         ctx.set_materialize_grads(False)</span>
<span class="sd">            &gt;&gt;&gt;         ctx.save_for_backward(x)</span>
<span class="sd">            &gt;&gt;&gt;         return x.clone(), x.clone()</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt;     @staticmethod</span>
<span class="sd">            &gt;&gt;&gt;     @once_differentiable</span>
<span class="sd">            &gt;&gt;&gt;     def backward(ctx, g1, g2):</span>
<span class="sd">            &gt;&gt;&gt;         x, = ctx.saved_tensors</span>
<span class="sd">            &gt;&gt;&gt;         grad_input = torch.zeros_like(x)</span>
<span class="sd">            &gt;&gt;&gt;         if g1 is not None:  # We must check for None now</span>
<span class="sd">            &gt;&gt;&gt;             grad_input += g1</span>
<span class="sd">            &gt;&gt;&gt;         if g2 is not None:</span>
<span class="sd">            &gt;&gt;&gt;             grad_input += g2</span>
<span class="sd">            &gt;&gt;&gt;         return grad_input</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; a = torch.tensor(1., requires_grad=True)</span>
<span class="sd">            &gt;&gt;&gt; b, _ = Func.apply(a)  # induces g2 to be undefined</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">materialize_grads</span> <span class="o">=</span> <span class="n">value</span></div>

<span class="c1"># DO NOT USE: This is only defined to be able to load old serialized models</span>
<span class="n">_ContextMethodMixin</span> <span class="o">=</span> <span class="n">FunctionCtx</span>

<span class="k">class</span> <span class="nc">_HookMixin</span><span class="p">:</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_register_hook</span><span class="p">(</span><span class="n">backward_hooks</span><span class="p">,</span> <span class="n">hook</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">backward_hooks</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">backward_hooks</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="n">hooks</span><span class="o">.</span><span class="n">RemovableHandle</span><span class="p">(</span><span class="n">backward_hooks</span><span class="p">)</span>
        <span class="n">backward_hooks</span><span class="p">[</span><span class="n">handle</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">hook</span>
        <span class="k">return</span> <span class="n">backward_hooks</span><span class="p">,</span> <span class="n">handle</span>


<span class="k">class</span> <span class="nc">BackwardCFunction</span><span class="p">(</span><span class="n">_C</span><span class="o">.</span><span class="n">_FunctionBase</span><span class="p">,</span> <span class="n">FunctionCtx</span><span class="p">,</span> <span class="n">_HookMixin</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="c1"># _forward_cls is defined by derived class</span>
        <span class="c1"># The user should define either backward or vjp but never both.</span>
        <span class="n">backward_fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward_cls</span><span class="o">.</span><span class="n">backward</span>  <span class="c1"># type: ignore[attr-defined]</span>
        <span class="n">vjp_fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward_cls</span><span class="o">.</span><span class="n">vjp</span>  <span class="c1"># type: ignore[attr-defined]</span>
        <span class="k">if</span> <span class="n">backward_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Function</span><span class="o">.</span><span class="n">backward</span> <span class="ow">and</span> <span class="n">vjp_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Function</span><span class="o">.</span><span class="n">vjp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Implementing both &#39;backward&#39; and &#39;vjp&#39; for a custom &quot;</span>
                               <span class="s2">&quot;Function is not allowed. You should only implement one &quot;</span>
                               <span class="s2">&quot;of them.&quot;</span><span class="p">)</span>
        <span class="n">user_fn</span> <span class="o">=</span> <span class="n">vjp_fn</span> <span class="k">if</span> <span class="n">vjp_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Function</span><span class="o">.</span><span class="n">vjp</span> <span class="k">else</span> <span class="n">backward_fn</span>
        <span class="k">return</span> <span class="n">user_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">apply_jvp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="c1"># _forward_cls is defined by derived class</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward_cls</span><span class="o">.</span><span class="n">jvp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>


<span class="k">class</span> <span class="nc">FunctionMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function metaclass.</span>

<span class="sd">    This metaclass sets up the following properties:</span>
<span class="sd">        _backward_cls: The Function class corresponding to the differentiated</span>
<span class="sd">            version of this function (which is generated on the fly by this</span>
<span class="sd">            metaclass).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="n">backward_fn</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;Backward&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">BackwardCFunction</span><span class="p">,),</span> <span class="p">{</span><span class="s1">&#39;_forward_cls&#39;</span><span class="p">:</span> <span class="bp">cls</span><span class="p">})</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_backward_cls</span> <span class="o">=</span> <span class="n">backward_fn</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">FunctionMeta</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_SingleLevelFunction</span><span class="p">(</span><span class="n">_C</span><span class="o">.</span><span class="n">_FunctionBase</span><span class="p">,</span> <span class="n">FunctionCtx</span><span class="p">,</span> <span class="n">_HookMixin</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">FunctionMeta</span><span class="p">):</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function is to be overridden by all subclasses. There are two ways</span>
<span class="sd">        to define forward:</span>

<span class="sd">        Usage 1 (Combined forward and ctx)::</span>

<span class="sd">            @staticmethod</span>
<span class="sd">            def forward(ctx: Any, *args: Any, **kwargs: Any) -&gt; Any:</span>
<span class="sd">                pass</span>

<span class="sd">        - It must accept a context ctx as the first argument, followed by any</span>
<span class="sd">          number of arguments (tensors or other types).</span>
<span class="sd">        - See :ref:`combining-forward-context` for more details</span>

<span class="sd">        Usage 2 (Separate forward and ctx)::</span>

<span class="sd">            @staticmethod</span>
<span class="sd">            def forward(*args: Any, **kwargs: Any) -&gt; Any:</span>
<span class="sd">                pass</span>

<span class="sd">            @staticmethod</span>
<span class="sd">            def setup_context(ctx: Any, inputs: Tuple[Any, ...], output: Any) -&gt; None:</span>
<span class="sd">                pass</span>

<span class="sd">        - The forward no longer accepts a ctx argument.</span>
<span class="sd">        - Instead, you must also override the :meth:`torch.autograd.Function.setup_context`</span>
<span class="sd">          staticmethod to handle setting up the ``ctx`` object.</span>
<span class="sd">          ``output`` is the output of the forward, ``inputs`` are a Tuple of inputs</span>
<span class="sd">          to the forward.</span>
<span class="sd">        - See :ref:`extending-autograd` for more details</span>

<span class="sd">        The context can be used to store arbitrary data that can be then</span>
<span class="sd">        retrieved during the backward pass. Tensors should not be stored</span>
<span class="sd">        directly on `ctx` (though this is not currently enforced for</span>
<span class="sd">        backward compatibility). Instead, tensors should be saved either with</span>
<span class="sd">        :func:`ctx.save_for_backward` if they are intended to be used in</span>
<span class="sd">        ``backward`` (equivalently, ``vjp``) or :func:`ctx.save_for_forward`</span>
<span class="sd">        if they are intended to be used for in ``jvp``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;You must implement the forward function for custom&quot;</span>
                                  <span class="s2">&quot; autograd.Function.&quot;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">setup_context</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">output</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;There are two ways to define the forward pass of an autograd.Function.</span>

<span class="sd">        Either:</span>

<span class="sd">        1. Override forward with the signature forward(ctx, *args, **kwargs).</span>
<span class="sd">           ``setup_context`` is not overridden. Setting up the ctx for backward</span>
<span class="sd">           happens inside the ``forward``.</span>
<span class="sd">        2. Override forward with the signature forward(*args, **kwargs) and</span>
<span class="sd">           override ``setup_context``. Setting up the ctx for backward happens</span>
<span class="sd">           inside ``setup_context`` (as opposed to inside the ``forward``)</span>

<span class="sd">        See :meth:`torch.autograd.Function.forward` and :ref:`extending-autograd` for more details.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;setup_context is not implemented.&quot;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">backward</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">*</span><span class="n">grad_outputs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Defines a formula for differentiating the operation with backward mode</span>
<span class="sd">        automatic differentiation (alias to the vjp function).</span>

<span class="sd">        This function is to be overridden by all subclasses.</span>

<span class="sd">        It must accept a context :attr:`ctx` as the first argument, followed by</span>
<span class="sd">        as many outputs as the :func:`forward` returned (None will be passed in</span>
<span class="sd">        for non tensor outputs of the forward function),</span>
<span class="sd">        and it should return as many tensors, as there were inputs to</span>
<span class="sd">        :func:`forward`. Each argument is the gradient w.r.t the given output,</span>
<span class="sd">        and each returned value should be the gradient w.r.t. the</span>
<span class="sd">        corresponding input. If an input is not a Tensor or is a Tensor not</span>
<span class="sd">        requiring grads, you can just pass None as a gradient for that input.</span>

<span class="sd">        The context can be used to retrieve tensors saved during the forward</span>
<span class="sd">        pass. It also has an attribute :attr:`ctx.needs_input_grad` as a tuple</span>
<span class="sd">        of booleans representing whether each input needs gradient. E.g.,</span>
<span class="sd">        :func:`backward` will have ``ctx.needs_input_grad[0] = True`` if the</span>
<span class="sd">        first input to :func:`forward` needs gradient computed w.r.t. the</span>
<span class="sd">        output.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;You must implement either the backward or vjp method for &quot;</span>
                                  <span class="s2">&quot;your custom autograd.Function to use it with backward &quot;</span>
                                  <span class="s2">&quot;mode AD.&quot;</span><span class="p">)</span>

    <span class="c1"># vjp and backward are alias of each other</span>
    <span class="n">vjp</span> <span class="o">=</span> <span class="n">backward</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">jvp</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">*</span><span class="n">grad_inputs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Defines a formula for differentiating the operation with forward mode</span>
<span class="sd">        automatic differentiation.</span>
<span class="sd">        This function is to be overridden by all subclasses.</span>
<span class="sd">        It must accept a context :attr:`ctx` as the first argument, followed by</span>
<span class="sd">        as many inputs as the :func:`forward` got (None will be passed in</span>
<span class="sd">        for non tensor inputs of the forward function),</span>
<span class="sd">        and it should return as many tensors as there were outputs to</span>
<span class="sd">        :func:`forward`. Each argument is the gradient w.r.t the given input,</span>
<span class="sd">        and each returned value should be the gradient w.r.t. the</span>
<span class="sd">        corresponding output. If an output is not a Tensor or the function is not</span>
<span class="sd">        differentiable with respect to that output, you can just pass None as a</span>
<span class="sd">        gradient for that input.</span>

<span class="sd">        You can use the :attr:`ctx` object to pass any value from the forward to this</span>
<span class="sd">        functions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;You must implement the jvp function for custom &quot;</span>
                                  <span class="s2">&quot;autograd.Function to use it with forward mode AD.&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="Function"><a class="viewcode-back" href="../../../autograd.html#torch.autograd.Function">[docs]</a><span class="k">class</span> <span class="nc">Function</span><span class="p">(</span><span class="n">_SingleLevelFunction</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Base class to create custom `autograd.Function`</span>

<span class="sd">    To create a custom `autograd.Function`, subclass this class and implement</span>
<span class="sd">    the :meth:`forward` and :meth:`backward` static methods. Then, to use your custom</span>
<span class="sd">    op in the forward pass, call the class method ``apply``. Do not call</span>
<span class="sd">    :meth:`forward` directly.</span>

<span class="sd">    To ensure correctness and best performance, make sure you are calling the</span>
<span class="sd">    correct methods on ``ctx`` and validating your backward function using</span>
<span class="sd">    :func:`torch.autograd.gradcheck`.</span>

<span class="sd">    See :ref:`extending-autograd` for more details on how to use this class.</span>

<span class="sd">    Examples::</span>

<span class="sd">        &gt;&gt;&gt; # xdoctest: +REQUIRES(env:TORCH_DOCTEST_AUTOGRAD)</span>
<span class="sd">        &gt;&gt;&gt; class Exp(Function):</span>
<span class="sd">        &gt;&gt;&gt;     @staticmethod</span>
<span class="sd">        &gt;&gt;&gt;     def forward(ctx, i):</span>
<span class="sd">        &gt;&gt;&gt;         result = i.exp()</span>
<span class="sd">        &gt;&gt;&gt;         ctx.save_for_backward(result)</span>
<span class="sd">        &gt;&gt;&gt;         return result</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt;     @staticmethod</span>
<span class="sd">        &gt;&gt;&gt;     def backward(ctx, grad_output):</span>
<span class="sd">        &gt;&gt;&gt;         result, = ctx.saved_tensors</span>
<span class="sd">        &gt;&gt;&gt;         return grad_output * result</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Use it by calling the apply method:</span>
<span class="sd">        &gt;&gt;&gt; # xdoctest: +SKIP</span>
<span class="sd">        &gt;&gt;&gt; output = Exp.apply(input)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s2"> should not be instantiated. Methods on autograd functions&quot;</span>
                      <span class="s2">&quot;are all static, so you should invoke them on the class itself. &quot;</span>
                      <span class="s2">&quot;Instantiating an autograd function will raise an &quot;</span>
                      <span class="s2">&quot;error in a future version of PyTorch.&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;Legacy autograd function with non-static forward method is deprecated. &quot;</span>
            <span class="s2">&quot;Please use new-style autograd function with static forward method. &quot;</span>
            <span class="s2">&quot;(Example: https://pytorch.org/docs/stable/autograd.html#torch.autograd.Function)&quot;</span><span class="p">)</span>

    <span class="c1"># for the tracer</span>
    <span class="n">is_traceable</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Bool that specifies if PyTorch should attempt to autogenerate</span>
<span class="sd">    :func:`torch.vmap` support for this autograd.Function. You may set this to</span>
<span class="sd">    True only if this autograd.Function&#39;s forward, backward, and jvp (if they</span>
<span class="sd">    exist) are written using PyTorch operations; otherwise, please override</span>
<span class="sd">    :meth:`torch.autograd.Function.vmap` to add support for :func:`torch.vmap`.</span>

<span class="sd">    Please see :ref:`func-autograd-function` for more details.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">generate_vmap_rule</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="Function.vmap"><a class="viewcode-back" href="../../../generated/torch.autograd.Function.vmap.html#torch.autograd.Function.vmap">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">vmap</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">in_dims</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Defines a rule for the behavior of this autograd.Function underneath</span>
<span class="sd">        :func:`torch.vmap`. For a :func:`torch.autograd.Function` to support</span>
<span class="sd">        :func:`torch.vmap`, you must either override this staticmethod, or set</span>
<span class="sd">        ``generate_vmap_rule`` to ``True`` (you may not do both).</span>

<span class="sd">        If you choose to override this staticmethod: it must accept</span>

<span class="sd">        - an ``info`` object as the first argument. ``info.batch_size``</span>
<span class="sd">          specifies the size of the dimension being vmapped over,</span>
<span class="sd">          while ``info.randomness`` is the randomness option passed to</span>
<span class="sd">          :func:`torch.vmap`.</span>
<span class="sd">        - an ``in_dims`` tuple as the second argument.</span>
<span class="sd">          For each arg in ``args``, ``in_dims`` has a corresponding</span>
<span class="sd">          ``Optional[int]``. It is ``None`` if the arg is not a Tensor or if</span>
<span class="sd">          the arg is not being vmapped over, otherwise, it is an integer</span>
<span class="sd">          specifying what dimension of the Tensor is being vmapped over.</span>
<span class="sd">        - ``*args``, which is the same as the args to :meth:`~Function.forward`.</span>

<span class="sd">        The return of the vmap staticmethod is a tuple of ``(output, out_dims)``.</span>
<span class="sd">        Similar to ``in_dims``, ``out_dims`` should be of the same structure as</span>
<span class="sd">        ``output`` and contain one ``out_dim`` per output that specifies if the</span>
<span class="sd">        output has the vmapped dimension and what index it is in.</span>

<span class="sd">        Please see :ref:`func-autograd-function` for more details.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;To use autograd.Function with vmap, you must either override the &quot;</span>
            <span class="s2">&quot;vmap staticmethod or set generate_vmap_rule=True.&quot;</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">_are_functorch_transforms_active</span><span class="p">():</span>
            <span class="c1"># See NOTE: [functorch vjp and autograd interaction]</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">_functorch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">unwrap_dead_wrappers</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># type: ignore[misc]</span>

        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">setup_context</span> <span class="o">==</span> <span class="n">_SingleLevelFunction</span><span class="o">.</span><span class="n">setup_context</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s1">&#39;In order to use an autograd.Function with functorch transforms &#39;</span>
                <span class="s1">&#39;(vmap, grad, jvp, jacrev, ...), it must override the setup_context &#39;</span>
                <span class="s1">&#39;staticmethod. For more details, please see &#39;</span>
                <span class="s1">&#39;https://pytorch.org/docs/master/notes/extending.func.html&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">custom_function_call</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">once_differentiable</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_grad_enabled</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">outputs</span>

        <span class="c1"># If any of the inputs have requires_grad=True, we force the outputs</span>
        <span class="c1"># to have requires_grad=True but point to a grad_fn which throws an</span>
        <span class="c1"># error message during (double) back-propagation.</span>
        <span class="c1"># XXX: this is only an approximation of requires_grad - there&#39;s no way</span>
        <span class="c1"># to figure out if fn didn&#39;t use ctx.saved_tensors and as a result</span>
        <span class="c1"># some Tensors might require grad, even if no args do.</span>
        <span class="c1"># Unfortunately, this leads to unexpected error messages (&quot;no nodes</span>
        <span class="c1"># require computing gradients&quot;), but I don&#39;t have a better idea.</span>
        <span class="c1"># These functions would raise an error in backward anyway.</span>
        <span class="n">requires_grad</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="ow">and</span> <span class="n">arg</span><span class="o">.</span><span class="n">requires_grad</span>
                            <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">requires_grad</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">outputs</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="p">(</span><span class="n">outputs</span><span class="p">,)</span>

        <span class="n">err_fn</span> <span class="o">=</span> <span class="n">_functions</span><span class="o">.</span><span class="n">DelayedError</span><span class="p">(</span>
            <span class="sa">b</span><span class="s2">&quot;trying to differentiate twice a function that was marked &quot;</span>
            <span class="sa">b</span><span class="s2">&quot;with @once_differentiable&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">outputs</span><span class="p">))</span>

        <span class="c1"># Create aliases of each output that has requires_grad=True. We need</span>
        <span class="c1"># at least one of the inputs to err_fn to require grad so that the</span>
        <span class="c1"># output will have a grad_fn.</span>
        <span class="k">def</span> <span class="nf">fake_requires_grad</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">var</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
                <span class="n">var</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="n">var</span>

        <span class="k">return</span> <span class="n">err_fn</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">fake_requires_grad</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">wrapper</span>


<span class="k">def</span> <span class="nf">traceable</span><span class="p">(</span><span class="n">fn_cls</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Marks Function as traceable for the JIT.</span>

<span class="sd">    Traceable functions have additional restrictions - they can&#39;t pass any</span>
<span class="sd">    data-dependent values to backward (e.g. Prod passes the output, which makes</span>
<span class="sd">    it non-traceable), and their backward should be implemented entirely in terms</span>
<span class="sd">    of operations on autograd Tensors in all cases.</span>

<span class="sd">    DON&#39;T USE THIS DECORATOR. IT IS FOR INTERNAL USE ONLY AND SHOULD BE HANDLED WITH</span>
<span class="sd">    CARE (or can give incorrect results otherwise).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fn_cls</span><span class="o">.</span><span class="n">is_traceable</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">fn_cls</span>


<span class="k">class</span> <span class="nc">InplaceFunction</span><span class="p">(</span><span class="n">Function</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inplace</span> <span class="o">=</span> <span class="n">inplace</span>


<span class="k">def</span> <span class="nf">_nested_map</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">condition_msg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_map</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">condition</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">fn</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">mapped</span> <span class="o">=</span> <span class="p">(</span><span class="n">_map</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;_fields&#39;</span><span class="p">):</span>
                <span class="c1"># obj is namedtuple</span>
                <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)(</span><span class="o">*</span><span class="n">mapped</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)(</span><span class="n">mapped</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">x</span> <span class="p">:</span> <span class="n">_map</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="n">x</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Auto nesting doesn&#39;t know how to process &quot;</span>
                             <span class="s2">&quot;an input object of type &quot;</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">typename</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">+</span>
                             <span class="p">(</span><span class="s2">&quot;. Accepted types: &quot;</span> <span class="o">+</span> <span class="n">condition_msg</span> <span class="o">+</span>
                              <span class="s2">&quot;, or lists/tuples of them&quot;</span>
                              <span class="k">if</span> <span class="n">condition_msg</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">_map</span>


<span class="k">def</span> <span class="nf">_jit_unwrap_structured</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;_jit_unwrap&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">_jit_unwrap</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">obj</span>


<span class="k">def</span> <span class="nf">_iter_filter</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">allow_unknown</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">condition_msg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">conversion</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_iter</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">conversion</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">conversion</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">condition</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">obj</span>
        <span class="k">elif</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
                <span class="k">yield from</span> <span class="n">_iter</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c1"># We only accept primitive key types, so we needn&#39;t inspect them</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">yield from</span> <span class="n">_iter</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">allow_unknown</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">obj</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Auto nesting doesn&#39;t know how to process &quot;</span>
                             <span class="s2">&quot;an input object of type &quot;</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">typename</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">+</span>
                             <span class="p">(</span><span class="s2">&quot;. Accepted types: &quot;</span> <span class="o">+</span> <span class="n">condition_msg</span> <span class="o">+</span>
                              <span class="s2">&quot;, or lists/tuples of them&quot;</span>
                              <span class="k">if</span> <span class="n">condition_msg</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">_iter</span>


<span class="k">def</span> <span class="nf">_unflatten</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">proto</span><span class="p">):</span>
    <span class="c1"># unflatten a list or tuple input into a nested list/tuple structure</span>
    <span class="c1"># specified by proto</span>
    <span class="k">def</span> <span class="nf">unflatten_helper</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">proto</span><span class="p">):</span>
        <span class="n">res</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">proto</span><span class="p">,</span> <span class="s2">&quot;_jit_wrap&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">proto</span><span class="o">.</span><span class="n">_jit_wrap</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">proto</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">return</span> <span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">input</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">proto</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res_e</span><span class="p">,</span> <span class="nb">input</span> <span class="o">=</span> <span class="n">unflatten_helper</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res_e</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">proto</span><span class="p">)(</span><span class="n">res</span><span class="p">),</span> <span class="nb">input</span>

    <span class="k">return</span> <span class="n">unflatten_helper</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">proto</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>


<span class="n">_iter_jit_values</span> <span class="o">=</span> <span class="n">_iter_filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">o</span><span class="p">:</span> <span class="n">o</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">Value</span><span class="p">),</span>
                                <span class="n">condition_msg</span><span class="o">=</span><span class="s2">&quot;jit&#39;s Values or None&quot;</span><span class="p">)</span>
<span class="n">_iter_tensors</span> <span class="o">=</span> <span class="n">_iter_filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">),</span> <span class="n">condition_msg</span><span class="o">=</span><span class="s2">&quot;Tensors&quot;</span><span class="p">,</span>
                             <span class="n">conversion</span><span class="o">=</span><span class="n">_jit_unwrap_structured</span><span class="p">)</span>
<span class="n">_iter_tensors_permissive</span> <span class="o">=</span> <span class="n">_iter_filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">),</span>
                                        <span class="n">allow_unknown</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                        <span class="n">condition_msg</span><span class="o">=</span><span class="s2">&quot;Tensors (permissive)&quot;</span><span class="p">)</span>
<span class="n">_iter_None_tensors</span> <span class="o">=</span> <span class="n">_iter_filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">o</span><span class="p">:</span> <span class="n">o</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">),</span>
                                  <span class="n">condition_msg</span><span class="o">=</span><span class="s2">&quot;Tensors or None&quot;</span><span class="p">)</span>
<span class="n">_map_tensor_data</span> <span class="o">=</span> <span class="n">_nested_map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">),</span> <span class="k">lambda</span> <span class="n">o</span><span class="p">:</span> <span class="n">o</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                               <span class="n">condition_msg</span><span class="o">=</span><span class="s2">&quot;Tensors&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">NestedIOFunction</span><span class="p">(</span><span class="n">Function</span><span class="p">):</span>
    <span class="c1"># The &#39;type: ignore&#39; statements are needed here because these functions are declared as &#39;@staticmethod&#39; in the</span>
    <span class="c1"># superclass (Function) but are instance methods here, which mypy reports as incompatible.</span>

    <span class="k">def</span> <span class="nf">_do_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="nb">input</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nested_input</span> <span class="o">=</span> <span class="nb">input</span>
        <span class="n">flat_input</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">_iter_tensors</span><span class="p">(</span><span class="nb">input</span><span class="p">))</span>
        <span class="n">flat_output</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_do_forward</span><span class="p">(</span><span class="o">*</span><span class="n">flat_input</span><span class="p">)</span>  <span class="c1"># type: ignore[misc]</span>
        <span class="n">nested_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nested_output</span>
        <span class="n">nested_tensors</span> <span class="o">=</span> <span class="n">_unflatten</span><span class="p">(</span><span class="n">flat_output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nested_output</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nested_tensors</span>

    <span class="k">def</span> <span class="nf">_do_backward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gradients</span><span class="p">,</span> <span class="n">retain_variables</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retain_variables</span> <span class="o">=</span> <span class="n">retain_variables</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_do_backward</span><span class="p">(</span><span class="n">gradients</span><span class="p">,</span> <span class="n">retain_variables</span><span class="p">)</span>  <span class="c1"># type: ignore[misc]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">retain_variables</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nested_output</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_save_nested</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">backward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">gradients</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>  <span class="c1"># type: ignore[override]</span>
        <span class="n">nested_gradients</span> <span class="o">=</span> <span class="n">_unflatten</span><span class="p">(</span><span class="n">gradients</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nested_output</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backward_extended</span><span class="p">(</span><span class="o">*</span><span class="n">nested_gradients</span><span class="p">)</span>  <span class="c1"># type: ignore[func-returns-value]</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">_iter_None_tensors</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>

    <span class="fm">__call__</span> <span class="o">=</span> <span class="n">_do_forward</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>  <span class="c1"># type: ignore[override]</span>
        <span class="n">nested_tensors</span> <span class="o">=</span> <span class="n">_map_tensor_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nested_input</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward_extended</span><span class="p">(</span><span class="o">*</span><span class="n">nested_tensors</span><span class="p">)</span>  <span class="c1"># type: ignore[func-returns-value]</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nested_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nested_output</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">_iter_tensors</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">save_for_backward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">to_save</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">_iter_tensors</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_to_save_nested</span> <span class="o">=</span> <span class="n">args</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">saved_tensors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">flat_tensors</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">saved_tensors</span>  <span class="c1"># type: ignore[misc]</span>
        <span class="k">return</span> <span class="n">_unflatten</span><span class="p">(</span><span class="n">flat_tensors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_save_nested</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">mark_dirty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dirty_tensors</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">_iter_tensors</span><span class="p">((</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">mark_non_differentiable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">non_differentiable</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">_iter_tensors</span><span class="p">((</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">forward_extended</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="nb">input</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">backward_extended</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">grad_output</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</pre></div>

             </article>
             
            </div>
            <footer>
  

  

    <hr>

  

  <div role="contentinfo">
    <p>
        &copy; Copyright 2023, PyTorch Contributors.

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>
     

</footer>

          </div>
<script>

var match = window.location.href.match(/\/_[a-zA-Z0-9_]*.html|_dynamo/gi);
var url = window.location.href.lastIndexOf(match[match.length-1]);

if (url)
  {
    var div = '<div class="admonition note"><p class="admonition-title">Note</p><p><i class="fa fa-exclamation-circle" aria-hidden="true">&nbsp</i> This page describes an internal API which is not intended to be used outside of the PyTorch codebase and can be modified or removed without notice.</p></div>'
    document.getElementById("pytorch-article").insertAdjacentHTML('afterBegin', div)
  }
</script>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              
            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
         <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
         <script src="../../../_static/jquery.js"></script>
         <script src="../../../_static/underscore.js"></script>
         <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
         <script src="../../../_static/doctools.js"></script>
         <script src="../../../_static/sphinx_highlight.js"></script>
         <script src="../../../_static/clipboard.min.js"></script>
         <script src="../../../_static/copybutton.js"></script>
     

  

  <script type="text/javascript" src="../../../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 
<script script type="text/javascript">
  var collapsedSections = ['Developer Notes', 'Language Bindings', 'Libraries', 'Community'];
</script>

<img height="1" width="1" style="border-style:none;" alt="" src="https://www.googleadservices.com/pagead/conversion/795629140/?label=txkmCPmdtosBENSssfsC&amp;guid=ON&amp;script=0"/>


  <!-- Begin Footer -->

  <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
    <div class="container">
      <div class="row">
        <div class="col-md-4 text-center">
          <h2>Docs</h2>
          <p>Access comprehensive developer documentation for PyTorch</p>
          <a class="with-right-arrow" href="https://pytorch.org/docs/stable/index.html">View Docs</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Tutorials</h2>
          <p>Get in-depth tutorials for beginners and advanced developers</p>
          <a class="with-right-arrow" href="https://pytorch.org/tutorials">View Tutorials</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Resources</h2>
          <p>Find development resources and get your questions answered</p>
          <a class="with-right-arrow" href="https://pytorch.org/resources">View Resources</a>
        </div>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container footer-container">
      <div class="footer-logo-wrapper">
        <a href="https://pytorch.org/" class="footer-logo"></a>
      </div>

      <div class="footer-links-wrapper">
        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/">PyTorch</a></li>
            <li><a href="https://pytorch.org/get-started">Get Started</a></li>
            <li><a href="https://pytorch.org/features">Features</a></li>
            <li><a href="https://pytorch.org/ecosystem">Ecosystem</a></li>
            <li><a href="https://pytorch.org/blog/">Blog</a></li>
            <li><a href="https://github.com/pytorch/pytorch/blob/master/CONTRIBUTING.md">Contributing</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/resources">Resources</a></li>
            <li><a href="https://pytorch.org/tutorials">Tutorials</a></li>
            <li><a href="https://pytorch.org/docs/stable/index.html">Docs</a></li>
            <li><a href="https://discuss.pytorch.org" target="_blank">Discuss</a></li>
            <li><a href="https://github.com/pytorch/pytorch/issues" target="_blank">Github Issues</a></li>
            <li><a href="https://pytorch.org/assets/brand-guidelines/PyTorch-Brand-Guidelines.pdf" target="_blank">Brand Guidelines</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title">Stay up to date</li>
            <li><a href="https://www.facebook.com/pytorch" target="_blank">Facebook</a></li>
            <li><a href="https://twitter.com/pytorch" target="_blank">Twitter</a></li>
            <li><a href="https://www.youtube.com/pytorch" target="_blank">YouTube</a></li>
            <li><a href="https://www.linkedin.com/company/pytorch" target="_blank">LinkedIn</a></li>
          </ul>  
          </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title">PyTorch Podcasts</li>
            <li><a href="https://open.spotify.com/show/6UzHKeiy368jKfQMKKvJY5" target="_blank">Spotify</a></li>
            <li><a href="https://podcasts.apple.com/us/podcast/pytorch-developer-podcast/id1566080008" target="_blank">Apple</a></li>
            <li><a href="https://www.google.com/podcasts?feed=aHR0cHM6Ly9mZWVkcy5zaW1wbGVjYXN0LmNvbS9PQjVGa0lsOA%3D%3D" target="_blank">Google</a></li>
            <li><a href="https://music.amazon.com/podcasts/7a4e6f0e-26c2-49e9-a478-41bd244197d0/PyTorch-Developer-Podcast?" target="_blank">Amazon</a></li>
          </ul>
         </div>
        </div>
        
        <div class="privacy-policy">
          <ul>
            <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/terms/" target="_blank">Terms</a></li>
            <li class="privacy-policy-links">|</li>
            <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/privacy-policy/" target="_blank">Privacy</a></li>
          </ul>
        </div>
        <div class="copyright">
        <p>Â© Copyright The Linux Foundation. The PyTorch Foundation is a project of The Linux Foundation.
          For web site terms of use, trademark policy and other policies applicable to The PyTorch Foundation please see
          <a href="www.linuxfoundation.org/policies/">www.linuxfoundation.org/policies/</a>. The PyTorch Foundation supports the PyTorch open source
          project, which has been established as PyTorch Project a Series of LF Projects, LLC. For policies applicable to the PyTorch Project a Series of LF Projects, LLC,
          please see <a href="www.lfprojects.org/policies/">www.lfprojects.org/policies/</a>.</p>
      </div>
     </div>

  </footer>

  <div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebookâ€™s Cookies Policy applies. Learn more, including about available controls: <a href="https://www.facebook.com/policies/cookies/">Cookies Policy</a>.</p>
    <img class="close-button" src="../../../_static/images/pytorch-x.svg">
  </div>
</div>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>
            
          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li class="resources-mobile-menu-title" class="active">
            Docs
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/docs/stable/index.html">PyTorch</a>
            </li>

            <li>
              <a href="https://pytorch.org/audio/stable/index.html">torchaudio</a>
            </li>

            <li>
              <a href="https://pytorch.org/text/stable/index.html">torchtext</a>
            </li>

            <li>
              <a href="https://pytorch.org/vision/stable/index.html">torchvision</a>
            </li>

            <li>
              <a href="https://pytorch.org/torcharrow">torcharrow</a>
            </li>

            <li>
              <a href="https://pytorch.org/data">TorchData</a>
            </li>

            <li>
              <a href="https://pytorch.org/torchrec">TorchRec</a>
            </li>

            <li>
              <a href="https://pytorch.org/serve/">TorchServe</a>
            </li>

            <li>
              <a href="https://pytorch.org/torchx/">TorchX</a>
            </li>

            <li>
              <a href="https://pytorch.org/xla">PyTorch on XLA Devices</a>
            </li>
          </ul>

          <li class="resources-mobile-menu-title">
            Resources
          </li>
            
           <ul class="resources-mobile-menu-items">

            <li>
              <a href="https://pytorch.org/features">About</a>
            </li>

            <li>
              <a href="https://pytorch.org/foundation">PyTorch Foundation</a>
            </li>

            <li>
              <a href="https://pytorch.org/#community-module">Community</a>
            </li>

            <li>
              <a href="https://pytorch.org/community-stories">Community Stories</a>
            </li>

            <li>
              <a href="https://pytorch.org/resources">Developer Resources</a>
            </li>

            <li>
              <a href="https://pytorch.org/events">Events</a>
            </li>

            <li>
              <a href="https://discuss.pytorch.org/">Forums</a>
            </li>

            <li>
              <a href="https://pytorch.org/hub">Models (Beta)</a>
            </li>
          </ul>

          <li>
            <a href="https://github.com/pytorch/pytorch">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="../../../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>