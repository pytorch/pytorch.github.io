


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta name="robots" content="noindex">
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>torch.package.package_exporter &mdash; PyTorch main documentation</title>
  

  
  
  
  
    <link rel="canonical" href="https://pytorch.org/docs/stable/_modules/torch/package/package_exporter.html"/>
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.css" type="text/css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/katex-math.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx-dropdown.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/panels-bootstrap.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/jit.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />

<!--
  Search engines should not index the main version of documentation.
  Stable documentation are built without release == 'main'.
-->
<meta name="robots" content="noindex">


  <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-T8XT4PS');</script>
    <!-- End Google Tag Manager -->
  


  
  <script src="../../../_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>

          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li class="active docs-active">
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-orange-arrow">
                Docs
              </a>
              <div class="resources-dropdown-menu">
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/docs/stable/index.html">
                  <span class="dropdown-title">PyTorch</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/audio/stable/index.html">
                  <span class="dropdown-title">torchaudio</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/text/stable/index.html">
                  <span class="dropdown-title">torchtext</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/vision/stable/index.html">
                  <span class="dropdown-title">torchvision</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torcharrow">
                  <span class="dropdown-title">torcharrow</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/data">
                  <span class="dropdown-title">TorchData</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torchrec">
                  <span class="dropdown-title">TorchRec</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/serve/">
                  <span class="dropdown-title">TorchServe</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torchx/">
                  <span class="dropdown-title">TorchX</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/xla">
                  <span class="dropdown-title">PyTorch on XLA Devices</span>
                  <p></p>
                </a>
            </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-arrow">
                Resources
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/features">
                  <span class="dropdown-title">About</span>
                  <p>Learn about PyTorchâ€™s features and capabilities</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/foundation">
                  <span class="dropdown-title">PyTorch Foundation</span>
                  <p>Learn about the PyTorch foundation</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/#community-module">
                  <span class="dropdown-title">Community</span>
                  <p>Join the PyTorch developer community to contribute, learn, and get your questions answered.</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/community-stories">
                  <span class="dropdown-title">Community Stories</span>
                  <p>Learn how our community solves real, everyday machine learning problems with PyTorch.</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/resources">
                  <span class="dropdown-title">Developer Resources</span>
                  <p>Find resources and get questions answered</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/events">
                  <span class="dropdown-title">Events</span>
                  <p>Find events, webinars, and podcasts</p>
                </a>
                <a class="nav-dropdown-item" href="https://discuss.pytorch.org/" target="_blank">
                  <span class="dropdown-title">Forums</span>
                  <p>A place to discuss PyTorch code, issues, install, research</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/hub">
                  <span class="dropdown-title">Models (Beta)</span>
                  <p>Discover, publish, and reuse pre-trained models</p>
                </a>
              </div>
            </div>
          </li>

          <li>
            <a href="https://github.com/pytorch/pytorch">GitHub</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>

<body class="pytorch-body">

   

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            
    <div class="version">
      <a href='https://pytorch.org/docs/versions.html'>main (2.1.0a0+git707d265 ) &#x25BC</a>
    </div>
    


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          </div>

          

<div>
  <a style="color:#F05732" href="https://pytorch.org/docs/stable/_modules/torch/package/package_exporter.html">
    You are viewing unstable developer preview docs.
    Click here to view docs for latest stable release.
  </a>
</div>


            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Community</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../community/build_ci_governance.html">PyTorch Governance | Build + CI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/contribution_guide.html">PyTorch Contribution Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/design.html">PyTorch Design Philosophy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/governance.html">PyTorch Governance | Mechanics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/persons_of_interest.html">PyTorch Governance | Maintainers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/amp_examples.html">CUDA Automatic Mixed Precision examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/autograd.html">Autograd mechanics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/broadcasting.html">Broadcasting semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/cpu_threading_torchscript_inference.html">CPU threading and TorchScript inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/cuda.html">CUDA semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/ddp.html">Distributed Data Parallel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/extending.html">Extending PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/extending.func.html">Extending torch.func with autograd.Function</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/gradcheck.html">Gradcheck mechanics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/hip.html">HIP (ROCm) semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/large_scale_deployments.html">Features for large-scale deployments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/modules.html">Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/mps.html">MPS backend</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/multiprocessing.html">Multiprocessing best practices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/numerical_accuracy.html">Numerical accuracy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/randomness.html">Reproducibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/serialization.html">Serialization semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/windows.html">Windows FAQ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">torch.compile</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/index.html">torch.compile</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/get-started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/troubleshooting.html">PyTorch 2.0 Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/technical-overview.html">Technical Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/guards-overview.html">Guards Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/custom-backends.html">Custom Backends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/fine_grained_apis.html">TorchDynamo APIs to control fine-grained tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/profiling_torch_compile.html">Profiling to understand torch.compile performance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/inductor_profiling.html">TorchInductor GPU Profiling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/deep-dive.html">TorchDynamo Deeper Dive</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/cudagraph_trees.html">CUDAGraph Trees</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/performance-dashboard.html">PyTorch 2.0 Performance Dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/torchfunc-and-torchcompile.html">torch.func interaction with torch.compile</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ir.html">IRs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/dynamic-shapes.html">Dynamic shapes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/fake-tensor.html">Fake tensor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../logging.html">torch._logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compile/transformations.html">Writing Graph Transformations on ATen IR</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Language Bindings</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../cpp_index.html">C++</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/javadoc/">Javadoc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../deploy.html">torch::deploy</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Python API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../torch.html">torch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nn.html">torch.nn</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nn.functional.html">torch.nn.functional</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tensors.html">torch.Tensor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tensor_attributes.html">Tensor Attributes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tensor_view.html">Tensor Views</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../amp.html">torch.amp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../autograd.html">torch.autograd</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../library.html">torch.library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cuda.html">torch.cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mps.html">torch.mps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../backends.html">torch.backends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../export.html">torch._export.export</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.html">torch.distributed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.algorithms.join.html">torch.distributed.algorithms.join</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.elastic.html">torch.distributed.elastic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fsdp.html">torch.distributed.fsdp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.optim.html">torch.distributed.optim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.tensor.parallel.html">torch.distributed.tensor.parallel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.checkpoint.html">torch.distributed.checkpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributions.html">torch.distributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compiler.html">torch.compiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fft.html">torch.fft</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../func.html">torch.func</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../futures.html">torch.futures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fx.html">torch.fx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hub.html">torch.hub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../jit.html">torch.jit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../linalg.html">torch.linalg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../monitor.html">torch.monitor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../signal.html">torch.signal</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../special.html">torch.special</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../torch.overrides.html">torch.overrides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../package.html">torch.package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../profiler.html">torch.profiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nn.init.html">torch.nn.init</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../onnx.html">torch.onnx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../onnx_diagnostics.html">torch.onnx diagnostics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../optim.html">torch.optim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../complex_numbers.html">Complex Numbers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ddp_comm_hooks.html">DDP Communication Hooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pipeline.html">Pipeline Parallelism</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quantization.html">Quantization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rpc.html">Distributed RPC Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../random.html">torch.random</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../masked.html">torch.masked</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nested.html">torch.nested</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sparse.html">torch.sparse</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../storage.html">torch.Storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../testing.html">torch.testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../benchmark_utils.html">torch.utils.benchmark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../bottleneck.html">torch.utils.bottleneck</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../checkpoint.html">torch.utils.checkpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cpp_extension.html">torch.utils.cpp_extension</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data.html">torch.utils.data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../jit_utils.html">torch.utils.jit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dlpack.html">torch.utils.dlpack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mobile_optimizer.html">torch.utils.mobile_optimizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../model_zoo.html">torch.utils.model_zoo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tensorboard.html">torch.utils.tensorboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../type_info.html">Type Info</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../named_tensor.html">Named Tensors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../name_inference.html">Named Tensors operator coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../config_mod.html">torch.__config__</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../logging.html">torch._logging</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Libraries</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/audio/stable">torchaudio</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/data">TorchData</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/torchrec">TorchRec</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/serve">TorchServe</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/text/stable">torchtext</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/vision/stable">torchvision</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/xla/">PyTorch on XLA Devices</a></li>
</ul>

            
          

        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="../../../index.html">
          
            Docs
          
        </a> &gt;
      </li>

        
          <li><a href="../../index.html">Module code</a> &gt;</li>
        
          <li><a href="../../torch.html">torch</a> &gt;</li>
        
      <li>torch.package.package_exporter</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">

        

          <!-- Google Tag Manager (noscript) -->
          <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T8XT4PS"
          height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
          <!-- End Google Tag Manager (noscript) -->
          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <h1>Source code for torch.package.package_exporter</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">importlib.machinery</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">linecache</span>
<span class="kn">import</span> <span class="nn">pickletools</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">importlib.machinery</span> <span class="kn">import</span> <span class="n">SourceFileLoader</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">BinaryIO</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">cast</span><span class="p">,</span>
    <span class="n">DefaultDict</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Sequence</span><span class="p">,</span>
    <span class="n">Set</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch.serialization</span> <span class="kn">import</span> <span class="n">location_tag</span><span class="p">,</span> <span class="n">normalize_storage_type</span>
<span class="kn">from</span> <span class="nn">torch.types</span> <span class="kn">import</span> <span class="n">Storage</span>
<span class="kn">from</span> <span class="nn">torch.utils.hooks</span> <span class="kn">import</span> <span class="n">RemovableHandle</span>

<span class="kn">from</span> <span class="nn">._digraph</span> <span class="kn">import</span> <span class="n">DiGraph</span>
<span class="kn">from</span> <span class="nn">._importlib</span> <span class="kn">import</span> <span class="n">_normalize_path</span>
<span class="kn">from</span> <span class="nn">._mangling</span> <span class="kn">import</span> <span class="n">demangle</span><span class="p">,</span> <span class="n">is_mangled</span>
<span class="kn">from</span> <span class="nn">._package_pickler</span> <span class="kn">import</span> <span class="n">create_pickler</span>
<span class="kn">from</span> <span class="nn">._stdlib</span> <span class="kn">import</span> <span class="n">is_stdlib_module</span>
<span class="kn">from</span> <span class="nn">.find_file_dependencies</span> <span class="kn">import</span> <span class="n">find_files_source_depends_on</span>
<span class="kn">from</span> <span class="nn">.glob_group</span> <span class="kn">import</span> <span class="n">GlobGroup</span><span class="p">,</span> <span class="n">GlobPattern</span>
<span class="kn">from</span> <span class="nn">.importer</span> <span class="kn">import</span> <span class="n">Importer</span><span class="p">,</span> <span class="n">OrderedImporter</span><span class="p">,</span> <span class="n">sys_importer</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;PackagingErrorReason&quot;</span><span class="p">,</span>
    <span class="s2">&quot;EmptyMatchError&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PackagingError&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PackageExporter&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">_gate_torchscript_serialization</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">ActionHook</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[[</span><span class="s2">&quot;PackageExporter&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">_ModuleProviderAction</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represents one of the actions that :class:`PackageExporter` can take on a module.</span>

<span class="sd">    See :meth:`PackageExporter.extern` and friends for a description of what the actions do.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">INTERN</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">EXTERN</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">MOCK</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">DENY</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="c1"># Special case: when a module is mocked, PackageExporter writes out a</span>
    <span class="c1"># `_mock` module that implements our mocking stubs. If we re-package code,</span>
    <span class="c1"># we may encounter a `_mock` module from the original package. If we do,</span>
    <span class="c1"># just ignore it and write a `_mock` module once.</span>
    <span class="n">REPACKAGED_MOCK_MODULE</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="c1"># Special case: PackageImporter adds a fake module</span>
    <span class="c1"># (`torch_package_importer`) that allows packaged code to access it. Don&#39;t</span>
    <span class="c1"># re-export this.</span>
    <span class="n">SKIP</span> <span class="o">=</span> <span class="mi">6</span>


<span class="k">class</span> <span class="nc">PackagingErrorReason</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Listing of different reasons a dependency may fail to package.</span>

<span class="sd">    This enum is used to provide good error messages when</span>
<span class="sd">    :class:`PackagingError` is raised.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="n">IS_EXTENSION_MODULE</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Module is a C extension module. torch.package supports Python modules only.&quot;</span>
    <span class="p">)</span>
    <span class="n">NO_DUNDER_FILE</span> <span class="o">=</span> <span class="s2">&quot;Module had no __file__ defined.&quot;</span>
    <span class="n">SOURCE_FILE_NOT_FOUND</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Module had a __file__, but we could not find it in your filesystem.&quot;</span>
    <span class="p">)</span>
    <span class="n">DEPENDENCY_RESOLUTION_FAILED</span> <span class="o">=</span> <span class="s2">&quot;Dependency resolution failed.&quot;</span>
    <span class="n">NO_ACTION</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Module did not match against any action pattern. Extern, mock, or intern it.&quot;</span>
    <span class="p">)</span>
    <span class="n">DENIED</span> <span class="o">=</span> <span class="s2">&quot;Module was denied by a pattern.&quot;</span>
    <span class="n">MOCKED_BUT_STILL_USED</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Module was mocked out, but is still being used in the package. &quot;</span>
        <span class="s2">&quot;Please intern or extern the mocked modules if objects are supposed to be in &quot;</span>
        <span class="s2">&quot;the package.&quot;</span>
    <span class="p">)</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">_PatternInfo</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Holds :class:`PackageExporter`-specific info about how to execute matches against&quot;&quot;&quot;</span>

    <span class="c1"># What action to take on a module that matches this pattern.</span>
    <span class="n">action</span><span class="p">:</span> <span class="n">_ModuleProviderAction</span>
    <span class="c1"># The value of `allow_empty` the user gave when specifying the pattern.</span>
    <span class="n">allow_empty</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="c1"># Whether this pattern has been matched during packaging.</span>
    <span class="n">was_matched</span><span class="p">:</span> <span class="nb">bool</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">allow_empty</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">action</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allow_empty</span> <span class="o">=</span> <span class="n">allow_empty</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">was_matched</span> <span class="o">=</span> <span class="kc">False</span>


<div class="viewcode-block" id="EmptyMatchError"><a class="viewcode-back" href="../../../package.html#torch.package.EmptyMatchError">[docs]</a><span class="k">class</span> <span class="nc">EmptyMatchError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This is an exception that is thrown when a mock or extern is marked as</span>
<span class="sd">    ``allow_empty=False``, and is not matched with any module during packaging.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">pass</span></div>


<div class="viewcode-block" id="PackagingError"><a class="viewcode-back" href="../../../package.html#torch.package.PackagingError">[docs]</a><span class="k">class</span> <span class="nc">PackagingError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This exception is raised when there is an issue with exporting a package.</span>
<span class="sd">    ``PackageExporter`` will attempt to gather up all the errors and present</span>
<span class="sd">    them to you at once.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dependency_graph</span><span class="p">:</span> <span class="n">DiGraph</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># Group errors by reason.</span>
        <span class="n">broken</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">PackagingErrorReason</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">module_name</span><span class="p">,</span> <span class="n">attrs</span> <span class="ow">in</span> <span class="n">dependency_graph</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">error</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">error</span> <span class="o">==</span> <span class="n">PackagingErrorReason</span><span class="o">.</span><span class="n">NO_ACTION</span><span class="p">:</span>
                <span class="k">assert</span> <span class="s2">&quot;action&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">attrs</span>
            <span class="n">broken</span><span class="p">[</span><span class="n">error</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>

        <span class="n">message</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
        <span class="n">message</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">reason</span><span class="p">,</span> <span class="n">module_names</span> <span class="ow">in</span> <span class="n">broken</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">message</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;* </span><span class="si">{</span><span class="n">reason</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">module_name</span> <span class="ow">in</span> <span class="n">module_names</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Print additional context if it&#39;s provided.</span>
                <span class="n">error_context</span> <span class="o">=</span> <span class="n">dependency_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">module_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error_context&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">error_context</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">message</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      Context: </span><span class="si">{</span><span class="n">error_context</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">module_name</span> <span class="ow">in</span> <span class="n">_DISALLOWED_MODULES</span><span class="p">:</span>
                    <span class="n">message</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="p">(</span>
                            <span class="s2">&quot;      Note: While we usually use modules in the python standard library &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;from the local environment, `</span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2">` has a lot of system &quot;</span>
                            <span class="s2">&quot;level access and therefore can pose a security risk. We heavily &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;recommend removing `</span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2">` from your packaged code. However, if that &quot;</span>
                            <span class="s2">&quot;is not possible, add it to the extern list by calling &quot;</span>
                            <span class="sa">f</span><span class="s1">&#39;PackageExporter.extern(&quot;`</span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s1">`&quot;)</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                    <span class="n">module_path</span> <span class="o">=</span> <span class="n">dependency_graph</span><span class="o">.</span><span class="n">first_path</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
                    <span class="n">message</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;      A path to </span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="s1">&#39; -&gt; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">module_path</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">message</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">message</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s2">&quot;Set debug=True when invoking PackageExporter for a visualization of where &quot;</span>
                    <span class="s2">&quot;broken modules are coming from!</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="c1"># Save the dependency graph so that tooling can get at it.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dependency_graph</span> <span class="o">=</span> <span class="n">dependency_graph</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span></div>


<div class="viewcode-block" id="PackageExporter"><a class="viewcode-back" href="../../../package.html#torch.package.PackageExporter">[docs]</a><span class="k">class</span> <span class="nc">PackageExporter</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Exporters allow you to write packages of code, pickled Python data, and</span>
<span class="sd">    arbitrary binary and text resources into a self-contained package.</span>

<span class="sd">    Imports can load this code in a hermetic way, such that code is loaded</span>
<span class="sd">    from the package rather than the normal Python import system. This allows</span>
<span class="sd">    for the packaging of PyTorch model code and data so that it can be run</span>
<span class="sd">    on a server or used in the future for transfer learning.</span>

<span class="sd">    The code contained in packages is copied file-by-file from the original</span>
<span class="sd">    source when it is created, and the file format is a specially organized</span>
<span class="sd">    zip file. Future users of the package can unzip the package, and edit the code</span>
<span class="sd">    in order to perform custom modifications to it.</span>

<span class="sd">    The importer for packages ensures that code in the module can only be loaded from</span>
<span class="sd">    within the package, except for modules explicitly listed as external using :meth:`extern`.</span>
<span class="sd">    The file ``extern_modules`` in the zip archive lists all the modules that a package externally depends on.</span>
<span class="sd">    This prevents &quot;implicit&quot; dependencies where the package runs locally because it is importing</span>
<span class="sd">    a locally-installed package, but then fails when the package is copied to another machine.</span>

<span class="sd">    When source code is added to the package, the exporter can optionally scan it</span>
<span class="sd">    for further code dependencies (``dependencies=True``). It looks for import statements,</span>
<span class="sd">    resolves relative references to qualified module names, and performs an action specified by the user</span>
<span class="sd">    (See: :meth:`extern`, :meth:`mock`, and :meth:`intern`).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="sd">&quot;&quot;&quot;A importer that will be searched in order to find the modules referenced by other modules or by</span>
<span class="sd">    pickled objects. The default module environment just uses sys_importer, which searches the Python environment.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">importer</span><span class="p">:</span> <span class="n">Importer</span>

<div class="viewcode-block" id="PackageExporter.__init__"><a class="viewcode-back" href="../../../package.html#torch.package.PackageExporter.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">f</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">,</span> <span class="n">BinaryIO</span><span class="p">],</span>
        <span class="n">importer</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Importer</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Importer</span><span class="p">]]</span> <span class="o">=</span> <span class="n">sys_importer</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an exporter.</span>

<span class="sd">        Args:</span>
<span class="sd">            f: The location to export to. Can be a  ``string``/``Path`` object containing a filename</span>
<span class="sd">                or a binary I/O object.</span>
<span class="sd">            importer: If a single Importer is passed, use that to search for modules.</span>
<span class="sd">                If a sequence of importers are passed, an ``OrderedImporter`` will be constructed out of them.</span>
<span class="sd">            debug: If set to True, add path of broken modules to PackagingErrors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">_log_api_usage_once</span><span class="p">(</span><span class="s2">&quot;torch.package.PackageExporter&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BinaryIO</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># is a byte buffer</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">f</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">zip_file</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">PyTorchFileWriter</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zip_file</span><span class="o">.</span><span class="n">set_min_version</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_written_files</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">serialized_reduces</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># A graph tracking all the modules and pickle objects added to this</span>
        <span class="c1"># package and the dependencies between them.</span>
        <span class="c1"># - Each node is a module name (or a pickle name that looks like &#39;&lt;foo.obj.pkl&gt;&#39;)</span>
        <span class="c1"># - Each directed edge (u, v) means u depends on v.</span>
        <span class="c1"># - Nodes may contain metadata that describe how to write the thing to the zipfile.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dependency_graph</span> <span class="o">=</span> <span class="n">DiGraph</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">script_module_serializer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">ScriptModuleSerializer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zip_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">script_module_serializer</span><span class="o">.</span><span class="n">storage_context</span><span class="p">()</span>

        <span class="c1"># These are OrderedDicts for compatibility with RemovableHandle.</span>
        <span class="c1"># Generic OrderedDict type annotations are not present until 3.7.</span>
        <span class="c1"># The real type signature is OrderedDict[int, Callable[[PackageExporter, str], None]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extern_hooks</span><span class="p">:</span> <span class="n">OrderedDict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mock_hooks</span><span class="p">:</span> <span class="n">OrderedDict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_intern_hooks</span><span class="p">:</span> <span class="n">OrderedDict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">importer</span><span class="p">,</span> <span class="n">Importer</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">importer</span> <span class="o">=</span> <span class="n">importer</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">importer</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s2">&quot;importer arg should be an Importer or a sequence of Importers, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">importer</span><span class="p">)</span><span class="si">}</span><span class="s2"> instead.&quot;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">importer</span> <span class="o">=</span> <span class="n">OrderedImporter</span><span class="p">(</span><span class="o">*</span><span class="n">importer</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">patterns</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">GlobGroup</span><span class="p">,</span> <span class="n">_PatternInfo</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unique_id</span> <span class="o">=</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="PackageExporter.save_source_file"><a class="viewcode-back" href="../../../package.html#torch.package.PackageExporter.save_source_file">[docs]</a>    <span class="k">def</span> <span class="nf">save_source_file</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">module_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">file_or_directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dependencies</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds the local file system ``file_or_directory`` to the source package to provide the code</span>
<span class="sd">        for ``module_name``.</span>

<span class="sd">        Args:</span>
<span class="sd">            module_name (str): e.g. ``&quot;my_package.my_subpackage&quot;``, code will be saved to provide code for this package.</span>
<span class="sd">            file_or_directory (str): the path to a file or directory of code. When a directory, all python files in the directory</span>
<span class="sd">                are recursively copied using :meth:`save_source_file`. If a file is named ``&quot;/__init__.py&quot;`` the code is treated</span>
<span class="sd">                as a package.</span>
<span class="sd">            dependencies (bool, optional): If ``True``, we scan the source for dependencies.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">file_or_directory</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
            <span class="n">to_save</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of tuples with arguments to save_source_string</span>
            <span class="n">module_path</span> <span class="o">=</span> <span class="n">module_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;**/*.py&quot;</span><span class="p">):</span>
                <span class="n">relative_path</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>
                <span class="n">archivename</span> <span class="o">=</span> <span class="n">module_path</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">relative_path</span>
                <span class="n">submodule_name</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;__init__.py&quot;</span><span class="p">:</span>
                    <span class="n">submodule_name</span> <span class="o">=</span> <span class="n">archivename</span><span class="p">[:</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot;/__init__.py&quot;</span><span class="p">)]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                        <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span>
                    <span class="p">)</span>
                    <span class="n">is_package</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">submodule_name</span> <span class="o">=</span> <span class="n">archivename</span><span class="p">[:</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot;.py&quot;</span><span class="p">)]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>
                    <span class="n">is_package</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="c1"># we delay the call to save_source_string so that we record all the source files</span>
                <span class="c1"># being provided by this directory structure _before_ attempting to resolve the dependencies</span>
                <span class="c1"># on the source. This makes sure we don&#39;t try to copy over modules that will just get</span>
                <span class="c1"># overwritten by this directory blob</span>
                <span class="n">to_save</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="n">submodule_name</span><span class="p">,</span>
                        <span class="n">_read_file</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">filename</span><span class="p">)),</span>
                        <span class="n">is_package</span><span class="p">,</span>
                        <span class="n">dependencies</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">to_save</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save_source_string</span><span class="p">(</span><span class="o">*</span><span class="n">item</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">is_package</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;__init__.py&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_source_string</span><span class="p">(</span>
                <span class="n">module_name</span><span class="p">,</span>
                <span class="n">_read_file</span><span class="p">(</span><span class="n">file_or_directory</span><span class="p">),</span>
                <span class="n">is_package</span><span class="p">,</span>
                <span class="n">dependencies</span><span class="p">,</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="PackageExporter.get_unique_id"><a class="viewcode-back" href="../../../package.html#torch.package.PackageExporter.get_unique_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_unique_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get an id. This id is guaranteed to only be handed out once for this package.&quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unique_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unique_id</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">ret</span></div>

    <span class="k">def</span> <span class="nf">_get_dependencies</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">module_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">is_package</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return all modules that this source code depends on.</span>

<span class="sd">        Dependencies are found by scanning the source code for import-like statements.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            src: The Python source code to analyze for dependencies.</span>
<span class="sd">            module_name: The name of the module that ``src`` corresponds to.</span>
<span class="sd">            is_package: Whether this module should be treated as a package.</span>
<span class="sd">                See :py:meth:`save_source_string` for more info.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list containing modules detected as direct dependencies in</span>
<span class="sd">            ``src``.  The items in the list are guaranteed to be unique.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">package_name</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">module_name</span> <span class="k">if</span> <span class="n">is_package</span> <span class="k">else</span> <span class="n">module_name</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dep_pairs</span> <span class="o">=</span> <span class="n">find_files_source_depends_on</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">package_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dependency_graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span>
                <span class="n">module_name</span><span class="p">,</span>
                <span class="n">error</span><span class="o">=</span><span class="n">PackagingErrorReason</span><span class="o">.</span><span class="n">DEPENDENCY_RESOLUTION_FAILED</span><span class="p">,</span>
                <span class="n">error_context</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># Use a dict to get uniquing but also deterministic order</span>
        <span class="n">dependencies</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">dep_module_name</span><span class="p">,</span> <span class="n">dep_module_obj</span> <span class="ow">in</span> <span class="n">dep_pairs</span><span class="p">:</span>
            <span class="c1"># handle the case where someone did something like `from pack import sub`</span>
            <span class="c1"># where `sub` is a submodule. In this case we don&#39;t have to save pack, just sub.</span>
            <span class="c1"># this ensures we don&#39;t pick up additional dependencies on pack.</span>
            <span class="c1"># However, in the case where `sub` is not a submodule but an object, then we do have</span>
            <span class="c1"># to save pack.</span>
            <span class="k">if</span> <span class="n">dep_module_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">possible_submodule</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dep_module_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">dep_module_obj</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_module_exists</span><span class="p">(</span><span class="n">possible_submodule</span><span class="p">):</span>
                    <span class="n">dependencies</span><span class="p">[</span><span class="n">possible_submodule</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># we don&#39;t need to save `pack`</span>
                    <span class="k">continue</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_module_exists</span><span class="p">(</span><span class="n">dep_module_name</span><span class="p">):</span>
                <span class="n">dependencies</span><span class="p">[</span><span class="n">dep_module_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">dependencies</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<div class="viewcode-block" id="PackageExporter.save_source_string"><a class="viewcode-back" href="../../../package.html#torch.package.PackageExporter.save_source_string">[docs]</a>    <span class="k">def</span> <span class="nf">save_source_string</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">module_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">is_package</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">dependencies</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds ``src`` as the source code for ``module_name`` in the exported package.</span>

<span class="sd">        Args:</span>
<span class="sd">            module_name (str): e.g. ``my_package.my_subpackage``, code will be saved to provide code for this package.</span>
<span class="sd">            src (str): The Python source code to save for this package.</span>
<span class="sd">            is_package (bool, optional): If ``True``, this module is treated as a package. Packages are allowed to have submodules</span>
<span class="sd">                (e.g. ``my_package.my_subpackage.my_subsubpackage``), and resources can be saved inside them. Defaults to ``False``.</span>
<span class="sd">            dependencies (bool, optional): If ``True``, we scan the source for dependencies.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dependency_graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span>
            <span class="n">module_name</span><span class="p">,</span>
            <span class="n">source</span><span class="o">=</span><span class="n">src</span><span class="p">,</span>
            <span class="n">is_package</span><span class="o">=</span><span class="n">is_package</span><span class="p">,</span>
            <span class="n">provided</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="n">_ModuleProviderAction</span><span class="o">.</span><span class="n">INTERN</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">dependencies</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dependencies</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">module_name</span><span class="p">,</span> <span class="n">is_package</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dependency_graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">dep</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_dependency</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_write_source_string</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">module_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">is_package</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write ``src`` as the source code for ``module_name`` in the zip archive.</span>

<span class="sd">        Arguments are otherwise the same as for :meth:`save_source_string`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">extension</span> <span class="o">=</span> <span class="s2">&quot;/__init__.py&quot;</span> <span class="k">if</span> <span class="n">is_package</span> <span class="k">else</span> <span class="s2">&quot;.py&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">module_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">extension</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_import_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">importer</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ModuleNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_mangled</span><span class="p">(</span><span class="n">module_name</span><span class="p">):</span>
                <span class="k">raise</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Module not found: &#39;</span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2">&#39;. Make sure the PackageImporter that &quot;</span>
                <span class="s2">&quot;created this module is present in `self.importer`&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ModuleNotFoundError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="kn">from</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_module_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_import_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_get_source_of_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s2">&quot;__spec__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">loader</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="s2">&quot;loader&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">loader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loader</span><span class="p">,</span> <span class="n">SourceFileLoader</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_filename</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s2">&quot;__file__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.py&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">linecache</span><span class="o">.</span><span class="n">getlines</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">module</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="PackageExporter.add_dependency"><a class="viewcode-back" href="../../../package.html#torch.package.PackageExporter.add_dependency">[docs]</a>    <span class="k">def</span> <span class="nf">add_dependency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dependencies</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Given a module, add it to the dependency graph according to patterns</span>
<span class="sd">        specified by the user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">module_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependency_graph</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependency_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">module_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;provided&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span>
        <span class="p">):</span>
            <span class="k">return</span>

        <span class="c1"># Special case: PackageImporter provides a special module called</span>
        <span class="c1"># `torch_package_importer` that allows packaged modules to reference</span>
        <span class="c1"># their PackageImporter. We don&#39;t want to re-export this.</span>
        <span class="k">if</span> <span class="n">module_name</span> <span class="o">==</span> <span class="s2">&quot;torch_package_importer&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dependency_graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span>
                <span class="n">module_name</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="n">_ModuleProviderAction</span><span class="o">.</span><span class="n">SKIP</span><span class="p">,</span>
                <span class="n">provided</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">module_name</span> <span class="o">==</span> <span class="s2">&quot;_mock&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dependency_graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span>
                <span class="n">module_name</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="n">_ModuleProviderAction</span><span class="o">.</span><span class="n">REPACKAGED_MOCK_MODULE</span><span class="p">,</span>
                <span class="n">provided</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_can_implicitly_extern</span><span class="p">(</span><span class="n">module_name</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dependency_graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span>
                <span class="n">module_name</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">_ModuleProviderAction</span><span class="o">.</span><span class="n">EXTERN</span><span class="p">,</span> <span class="n">provided</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">pattern_info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">patterns</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">matches</span><span class="p">(</span><span class="n">module_name</span><span class="p">):</span>
                <span class="n">pattern_info</span><span class="o">.</span><span class="n">was_matched</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dependency_graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span>
                    <span class="n">module_name</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">pattern_info</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="n">provided</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">pattern_info</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="n">_ModuleProviderAction</span><span class="o">.</span><span class="n">DENY</span><span class="p">:</span>
                    <span class="c1"># Requiring a denied module just adds an error to the graph.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dependency_graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span>
                        <span class="n">module_name</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="n">PackagingErrorReason</span><span class="o">.</span><span class="n">DENIED</span>
                    <span class="p">)</span>

                <span class="c1"># If we are interning this module, we need to retrieve its</span>
                <span class="c1"># dependencies and package those as well.</span>
                <span class="k">if</span> <span class="n">pattern_info</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="n">_ModuleProviderAction</span><span class="o">.</span><span class="n">INTERN</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_intern_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">dependencies</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="c1"># No patterns have matched. Explicitly add this as an error.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dependency_graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span>
            <span class="n">module_name</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="n">PackagingErrorReason</span><span class="o">.</span><span class="n">NO_ACTION</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="PackageExporter.save_module"><a class="viewcode-back" href="../../../package.html#torch.package.PackageExporter.save_module">[docs]</a>    <span class="k">def</span> <span class="nf">save_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dependencies</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save the code for ``module`` into the package. Code for the module is resolved using the ``importers`` path to find the</span>
<span class="sd">        module object, and then using its ``__file__`` attribute to find the source code.</span>

<span class="sd">        Args:</span>
<span class="sd">            module_name (str): e.g. ``my_package.my_subpackage``, code will be saved to provide code</span>
<span class="sd">                for this package.</span>
<span class="sd">            dependencies (bool, optional): If ``True``, we scan the source for dependencies.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;save_module() expects a string input, did you perhaps mean to pass `__name__`?&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_intern_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">dependencies</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_intern_module</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">module_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">dependencies</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds the module to the dependency graph as an interned module,</span>
<span class="sd">        along with any metadata needed to write it out to the zipfile at serialization time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">module_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_import_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
        <span class="c1"># Subtle: if the import above succeeded, either:</span>
        <span class="c1">#   1. The module name is not mangled, and this was just a regular import, or</span>
        <span class="c1">#   2. The module name is mangled, but one of the importers was able to</span>
        <span class="c1">#      recognize the mangling and import it.</span>
        <span class="c1"># Either way, it is now safe to demangle this name so that we don&#39;t</span>
        <span class="c1"># serialize the mangled version to the package.</span>
        <span class="n">module_name</span> <span class="o">=</span> <span class="n">demangle</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>

        <span class="c1"># Find dependencies of this module and require them as well.</span>
        <span class="n">is_package</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module_obj</span><span class="p">,</span> <span class="s2">&quot;__path__&quot;</span><span class="p">)</span>
        <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_source_of_module</span><span class="p">(</span><span class="n">module_obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Couldn&#39;t find a source!  Add it to our dependency graph as broken</span>
            <span class="c1"># and continue.</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module_obj</span><span class="p">,</span> <span class="s2">&quot;__file__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">error_context</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">packaging_error</span> <span class="o">=</span> <span class="n">PackagingErrorReason</span><span class="o">.</span><span class="n">NO_DUNDER_FILE</span>
            <span class="k">elif</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">importlib</span><span class="o">.</span><span class="n">machinery</span><span class="o">.</span><span class="n">EXTENSION_SUFFIXES</span><span class="p">)):</span>
                <span class="n">packaging_error</span> <span class="o">=</span> <span class="n">PackagingErrorReason</span><span class="o">.</span><span class="n">IS_EXTENSION_MODULE</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">packaging_error</span> <span class="o">=</span> <span class="n">PackagingErrorReason</span><span class="o">.</span><span class="n">SOURCE_FILE_NOT_FOUND</span>
                <span class="n">error_context</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;filename: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dependency_graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span>
                <span class="n">module_name</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="n">_ModuleProviderAction</span><span class="o">.</span><span class="n">INTERN</span><span class="p">,</span>
                <span class="n">is_package</span><span class="o">=</span><span class="n">is_package</span><span class="p">,</span>
                <span class="n">error</span><span class="o">=</span><span class="n">packaging_error</span><span class="p">,</span>
                <span class="n">error_context</span><span class="o">=</span><span class="n">error_context</span><span class="p">,</span>
                <span class="n">provided</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dependency_graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span>
            <span class="n">module_name</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="n">_ModuleProviderAction</span><span class="o">.</span><span class="n">INTERN</span><span class="p">,</span>
            <span class="n">is_package</span><span class="o">=</span><span class="n">is_package</span><span class="p">,</span>
            <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
            <span class="n">provided</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">dependencies</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dependencies</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">module_name</span><span class="p">,</span> <span class="n">is_package</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dependency_graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">dep</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_dependency</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span>

<div class="viewcode-block" id="PackageExporter.save_pickle"><a class="viewcode-back" href="../../../package.html#torch.package.PackageExporter.save_pickle">[docs]</a>    <span class="k">def</span> <span class="nf">save_pickle</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">package</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">resource</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">dependencies</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">pickle_protocol</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save a python object to the archive using pickle. Equivalent to :func:`torch.save` but saving into</span>
<span class="sd">        the archive rather than a stand-alone file. Standard pickle does not save the code, only the objects.</span>
<span class="sd">        If ``dependencies`` is true, this method will also scan the pickled objects for which modules are required</span>
<span class="sd">        to reconstruct them and save the relevant code.</span>

<span class="sd">        To be able to save an object where ``type(obj).__name__`` is ``my_module.MyObject``,</span>
<span class="sd">        ``my_module.MyObject`` must resolve to the class of the object according to the ``importer`` order. When saving objects that</span>
<span class="sd">        have previously been packaged, the importer&#39;s ``import_module`` method will need to be present in the ``importer`` list</span>
<span class="sd">        for this to work.</span>

<span class="sd">        Args:</span>
<span class="sd">            package (str): The name of module package this resource should go in (e.g. ``&quot;my_package.my_subpackage&quot;``).</span>
<span class="sd">            resource (str): A unique name for the resource, used to identify it to load.</span>
<span class="sd">            obj (Any): The object to save, must be picklable.</span>
<span class="sd">            dependencies (bool, optional): If ``True``, we scan the source for dependencies.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="p">(</span><span class="n">pickle_protocol</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="n">pickle_protocol</span> <span class="o">==</span> <span class="mi">3</span>
        <span class="p">),</span> <span class="s2">&quot;torch.package only supports pickle protocols 3 and 4&quot;</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="n">resource</span><span class="p">)</span>
        <span class="c1"># Write the pickle data for `obj`</span>
        <span class="n">data_buf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
        <span class="n">pickler</span> <span class="o">=</span> <span class="n">create_pickler</span><span class="p">(</span><span class="n">data_buf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">importer</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="n">pickle_protocol</span><span class="p">)</span>
        <span class="n">pickler</span><span class="o">.</span><span class="n">persistent_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_persistent_id</span>
        <span class="n">pickler</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">data_value</span> <span class="o">=</span> <span class="n">data_buf</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
        <span class="n">mocked_modules</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">name_in_dependency_graph</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="n">package</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">resource</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dependency_graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span>
            <span class="n">name_in_dependency_graph</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="n">_ModuleProviderAction</span><span class="o">.</span><span class="n">INTERN</span><span class="p">,</span>
            <span class="n">provided</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">is_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">def</span> <span class="nf">_check_mocked_error</span><span class="p">(</span><span class="n">module</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">field</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            checks if an object (field) comes from a mocked module and then adds</span>
<span class="sd">            the pair to mocked_modules which contains mocked modules paired with their</span>
<span class="sd">            list of mocked objects present in the pickle.</span>

<span class="sd">            We also hold the invariant that the first user defined rule that applies</span>
<span class="sd">            to the module is the one we use.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_can_implicitly_extern</span><span class="p">(</span><span class="n">module</span><span class="p">):</span>
                <span class="k">return</span>
            <span class="k">for</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">pattern_info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">patterns</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">matches</span><span class="p">(</span><span class="n">module</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">pattern_info</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="n">_ModuleProviderAction</span><span class="o">.</span><span class="n">MOCK</span><span class="p">:</span>
                        <span class="n">mocked_modules</span><span class="p">[</span><span class="n">module</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                    <span class="k">return</span>

        <span class="k">if</span> <span class="n">dependencies</span><span class="p">:</span>
            <span class="n">all_dependencies</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">module</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">field</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">memo</span><span class="p">:</span> <span class="n">DefaultDict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">memo_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># pickletools.dis(data_value)</span>
            <span class="k">for</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">pickletools</span><span class="o">.</span><span class="n">genops</span><span class="p">(</span><span class="n">data_value</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">pickle_protocol</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">opcode</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;SHORT_BINUNICODE&quot;</span>
                        <span class="ow">or</span> <span class="n">opcode</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;BINUNICODE&quot;</span>
                        <span class="ow">or</span> <span class="n">opcode</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;BINUNICODE8&quot;</span>
                    <span class="p">):</span>
                        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                        <span class="n">module</span> <span class="o">=</span> <span class="n">field</span>
                        <span class="n">field</span> <span class="o">=</span> <span class="n">arg</span>
                        <span class="n">memo</span><span class="p">[</span><span class="n">memo_count</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span>
                    <span class="k">elif</span> <span class="p">(</span>
                        <span class="n">opcode</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;LONG_BINGET&quot;</span>
                        <span class="ow">or</span> <span class="n">opcode</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;BINGET&quot;</span>
                        <span class="ow">or</span> <span class="n">opcode</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span>
                    <span class="p">):</span>
                        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
                        <span class="n">module</span> <span class="o">=</span> <span class="n">field</span>
                        <span class="n">field</span> <span class="o">=</span> <span class="n">memo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">opcode</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;MEMOIZE&quot;</span><span class="p">:</span>
                        <span class="n">memo_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="n">opcode</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;STACK_GLOBAL&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">module</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="c1"># If not module was passed on in the entries preceeding this one, continue.</span>
                            <span class="k">continue</span>
                        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">module</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_dependencies</span><span class="p">:</span>
                            <span class="n">all_dependencies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
                        <span class="n">_check_mocked_error</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
                <span class="k">elif</span> <span class="p">(</span>
                    <span class="n">pickle_protocol</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">opcode</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;GLOBAL&quot;</span>
                <span class="p">):</span>  <span class="c1"># a global reference</span>
                    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                    <span class="n">module</span><span class="p">,</span> <span class="n">field</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">module</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_dependencies</span><span class="p">:</span>
                        <span class="n">all_dependencies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
                    <span class="n">_check_mocked_error</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">module_name</span> <span class="ow">in</span> <span class="n">all_dependencies</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dependency_graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">name_in_dependency_graph</span><span class="p">,</span> <span class="n">module_name</span><span class="p">)</span>

                <span class="sd">&quot;&quot;&quot; If an object happens to come from a mocked module, then we collect these errors and spit them</span>
<span class="sd">                    out with the other errors found by package exporter.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="k">if</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">mocked_modules</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                    <span class="n">fields</span> <span class="o">=</span> <span class="n">mocked_modules</span><span class="p">[</span><span class="n">module</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dependency_graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span>
                        <span class="n">module_name</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="n">_ModuleProviderAction</span><span class="o">.</span><span class="n">MOCK</span><span class="p">,</span>
                        <span class="n">error</span><span class="o">=</span><span class="n">PackagingErrorReason</span><span class="o">.</span><span class="n">MOCKED_BUT_STILL_USED</span><span class="p">,</span>
                        <span class="n">error_context</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Object(s) &#39;</span><span class="si">{</span><span class="n">fields</span><span class="si">}</span><span class="s2">&#39; from module `</span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2">` was mocked out during packaging &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;but is being used in resource - `</span><span class="si">{</span><span class="n">resource</span><span class="si">}</span><span class="s2">` in package `</span><span class="si">{</span><span class="n">package</span><span class="si">}</span><span class="s2">`. &quot;</span><span class="p">,</span>
                        <span class="n">provided</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_dependency</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">data_value</span><span class="p">)</span></div>

<div class="viewcode-block" id="PackageExporter.save_text"><a class="viewcode-back" href="../../../package.html#torch.package.PackageExporter.save_text">[docs]</a>    <span class="k">def</span> <span class="nf">save_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">resource</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save text data to the package.</span>

<span class="sd">        Args:</span>
<span class="sd">            package (str): The name of module package this resource should go it (e.g. ``&quot;my_package.my_subpackage&quot;``).</span>
<span class="sd">            resource (str): A unique name for the resource, used to identify it to load.</span>
<span class="sd">            text (str): The contents to save.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_binary</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">text</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="PackageExporter.save_binary"><a class="viewcode-back" href="../../../package.html#torch.package.PackageExporter.save_binary">[docs]</a>    <span class="k">def</span> <span class="nf">save_binary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">binary</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save raw bytes to the package.</span>

<span class="sd">        Args:</span>
<span class="sd">            package (str): The name of module package this resource should go it (e.g. ``&quot;my_package.my_subpackage&quot;``).</span>
<span class="sd">            resource (str): A unique name for the resource, used to identify it to load.</span>
<span class="sd">            binary (str): The data to save.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="n">resource</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">binary</span><span class="p">)</span></div>

<div class="viewcode-block" id="PackageExporter.register_extern_hook"><a class="viewcode-back" href="../../../package.html#torch.package.PackageExporter.register_extern_hook">[docs]</a>    <span class="k">def</span> <span class="nf">register_extern_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hook</span><span class="p">:</span> <span class="n">ActionHook</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RemovableHandle</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Registers an extern hook on the exporter.</span>

<span class="sd">        The hook will be called each time a module matches against an :meth:`extern` pattern.</span>
<span class="sd">        It should have the following signature::</span>

<span class="sd">            hook(exporter: PackageExporter, module_name: str) -&gt; None</span>

<span class="sd">        Hooks will be called in order of registration.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :class:`torch.utils.hooks.RemovableHandle`:</span>
<span class="sd">                A handle that can be used to remove the added hook by calling</span>
<span class="sd">                ``handle.remove()``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="n">RemovableHandle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_extern_hooks</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extern_hooks</span><span class="p">[</span><span class="n">handle</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">hook</span>
        <span class="k">return</span> <span class="n">handle</span></div>

<div class="viewcode-block" id="PackageExporter.register_mock_hook"><a class="viewcode-back" href="../../../package.html#torch.package.PackageExporter.register_mock_hook">[docs]</a>    <span class="k">def</span> <span class="nf">register_mock_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hook</span><span class="p">:</span> <span class="n">ActionHook</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RemovableHandle</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Registers a mock hook on the exporter.</span>

<span class="sd">        The hook will be called each time a module matches against a :meth:`mock` pattern.</span>
<span class="sd">        It should have the following signature::</span>

<span class="sd">            hook(exporter: PackageExporter, module_name: str) -&gt; None</span>

<span class="sd">        Hooks will be called in order of registration.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :class:`torch.utils.hooks.RemovableHandle`:</span>
<span class="sd">                A handle that can be used to remove the added hook by calling</span>
<span class="sd">                ``handle.remove()``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="n">RemovableHandle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mock_hooks</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mock_hooks</span><span class="p">[</span><span class="n">handle</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">hook</span>
        <span class="k">return</span> <span class="n">handle</span></div>

<div class="viewcode-block" id="PackageExporter.register_intern_hook"><a class="viewcode-back" href="../../../package.html#torch.package.PackageExporter.register_intern_hook">[docs]</a>    <span class="k">def</span> <span class="nf">register_intern_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hook</span><span class="p">:</span> <span class="n">ActionHook</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RemovableHandle</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Registers an intern hook on the exporter.</span>

<span class="sd">        The hook will be called each time a module matches against an :meth:`intern` pattern.</span>
<span class="sd">        It should have the following signature::</span>

<span class="sd">            hook(exporter: PackageExporter, module_name: str) -&gt; None</span>

<span class="sd">        Hooks will be called in order of registration.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :class:`torch.utils.hooks.RemovableHandle`:</span>
<span class="sd">                A handle that can be used to remove the added hook by calling</span>
<span class="sd">                ``handle.remove()``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="n">RemovableHandle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_intern_hooks</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_intern_hooks</span><span class="p">[</span><span class="n">handle</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">hook</span>
        <span class="k">return</span> <span class="n">handle</span></div>

<div class="viewcode-block" id="PackageExporter.intern"><a class="viewcode-back" href="../../../package.html#torch.package.PackageExporter.intern">[docs]</a>    <span class="k">def</span> <span class="nf">intern</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">include</span><span class="p">:</span> <span class="s2">&quot;GlobPattern&quot;</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">exclude</span><span class="p">:</span> <span class="s2">&quot;GlobPattern&quot;</span> <span class="o">=</span> <span class="p">(),</span>
        <span class="n">allow_empty</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Specify modules that should be packaged. A module must match some ``intern`` pattern in order to be</span>
<span class="sd">        included in the package and have its dependencies processed recursively.</span>

<span class="sd">        Args:</span>
<span class="sd">            include (Union[List[str], str]): A string e.g. &quot;my_package.my_subpackage&quot;, or list of strings</span>
<span class="sd">                for the names of the modules to be externed. This can also be a glob-style pattern, as described in :meth:`mock`.</span>

<span class="sd">            exclude (Union[List[str], str]): An optional pattern that excludes some patterns that match the include string.</span>

<span class="sd">            allow_empty (bool): An optional flag that specifies whether the intern modules specified by this call</span>
<span class="sd">                to the ``intern`` method must be matched to some module during packaging. If an ``intern`` module glob</span>
<span class="sd">                pattern is added with ``allow_empty=False``, and :meth:`close` is called (either explicitly or via ``__exit__``)</span>
<span class="sd">                before any modules match that pattern, an exception is thrown. If ``allow_empty=True``, no such exception is thrown.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patterns</span><span class="p">[</span><span class="n">GlobGroup</span><span class="p">(</span><span class="n">include</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">)]</span> <span class="o">=</span> <span class="n">_PatternInfo</span><span class="p">(</span>
            <span class="n">_ModuleProviderAction</span><span class="o">.</span><span class="n">INTERN</span><span class="p">,</span> <span class="n">allow_empty</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="PackageExporter.mock"><a class="viewcode-back" href="../../../package.html#torch.package.PackageExporter.mock">[docs]</a>    <span class="k">def</span> <span class="nf">mock</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">include</span><span class="p">:</span> <span class="s2">&quot;GlobPattern&quot;</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">exclude</span><span class="p">:</span> <span class="s2">&quot;GlobPattern&quot;</span> <span class="o">=</span> <span class="p">(),</span>
        <span class="n">allow_empty</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Replace some required modules with a mock implementation.  Mocked modules will return a fake</span>
<span class="sd">        object for any attribute accessed from it. Because we copy file-by-file, the dependency resolution will sometimes</span>
<span class="sd">        find files that are imported by model files but whose functionality is never used</span>
<span class="sd">        (e.g. custom serialization code or training helpers).</span>
<span class="sd">        Use this function to mock this functionality out without having to modify the original code.</span>

<span class="sd">        Args:</span>
<span class="sd">            include (Union[List[str], str]): A string e.g. ``&quot;my_package.my_subpackage&quot;``, or list of strings</span>
<span class="sd">                for the names of the modules to be mocked out. Strings can also be a glob-style pattern</span>
<span class="sd">                string that may match multiple modules. Any required dependencies that match this pattern</span>
<span class="sd">                string will be mocked out automatically.</span>

<span class="sd">                Examples :</span>
<span class="sd">                    ``&#39;torch.**&#39;`` -- matches ``torch`` and all submodules of torch, e.g. ``&#39;torch.nn&#39;``</span>
<span class="sd">                    and ``&#39;torch.nn.functional&#39;``</span>

<span class="sd">                    ``&#39;torch.*&#39;`` -- matches ``&#39;torch.nn&#39;`` or ``&#39;torch.functional&#39;``, but not</span>
<span class="sd">                    ``&#39;torch.nn.functional&#39;``</span>

<span class="sd">            exclude (Union[List[str], str]): An optional pattern that excludes some patterns that match the include string.</span>
<span class="sd">                e.g. ``include=&#39;torch.**&#39;, exclude=&#39;torch.foo&#39;`` will mock all torch packages except ``&#39;torch.foo&#39;``,</span>
<span class="sd">                Default: is ``[]``.</span>

<span class="sd">            allow_empty (bool): An optional flag that specifies whether the mock implementation(s) specified by this call</span>
<span class="sd">                to the :meth:`mock` method must be matched to some module during packaging. If a mock is added with</span>
<span class="sd">                ``allow_empty=False``, and :meth:`close` is called (either explicitly or via ``__exit__``) and the mock has</span>
<span class="sd">                not been matched to a module used by the package being exported, an exception is thrown.</span>
<span class="sd">                If ``allow_empty=True``, no such exception is thrown.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patterns</span><span class="p">[</span><span class="n">GlobGroup</span><span class="p">(</span><span class="n">include</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">)]</span> <span class="o">=</span> <span class="n">_PatternInfo</span><span class="p">(</span>
            <span class="n">_ModuleProviderAction</span><span class="o">.</span><span class="n">MOCK</span><span class="p">,</span> <span class="n">allow_empty</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="PackageExporter.extern"><a class="viewcode-back" href="../../../package.html#torch.package.PackageExporter.extern">[docs]</a>    <span class="k">def</span> <span class="nf">extern</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">include</span><span class="p">:</span> <span class="s2">&quot;GlobPattern&quot;</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">exclude</span><span class="p">:</span> <span class="s2">&quot;GlobPattern&quot;</span> <span class="o">=</span> <span class="p">(),</span>
        <span class="n">allow_empty</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Include ``module`` in the list of external modules the package can import.</span>
<span class="sd">        This will prevent dependency discovery from saving</span>
<span class="sd">        it in the package. The importer will load an external module directly from the standard import system.</span>
<span class="sd">        Code for extern modules must also exist in the process loading the package.</span>

<span class="sd">        Args:</span>
<span class="sd">            include (Union[List[str], str]): A string e.g. ``&quot;my_package.my_subpackage&quot;``, or list of strings</span>
<span class="sd">                for the names of the modules to be externed. This can also be a glob-style pattern, as</span>
<span class="sd">                described in :meth:`mock`.</span>

<span class="sd">            exclude (Union[List[str], str]): An optional pattern that excludes some patterns that match the</span>
<span class="sd">                include string.</span>

<span class="sd">            allow_empty (bool): An optional flag that specifies whether the extern modules specified by this call</span>
<span class="sd">                to the ``extern`` method must be matched to some module during packaging. If an extern module glob</span>
<span class="sd">                pattern is added with ``allow_empty=False``, and :meth:`close` is called (either explicitly or via</span>
<span class="sd">                ``__exit__``) before any modules match that pattern, an exception is thrown. If ``allow_empty=True``,</span>
<span class="sd">                no such exception is thrown.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patterns</span><span class="p">[</span><span class="n">GlobGroup</span><span class="p">(</span><span class="n">include</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">)]</span> <span class="o">=</span> <span class="n">_PatternInfo</span><span class="p">(</span>
            <span class="n">_ModuleProviderAction</span><span class="o">.</span><span class="n">EXTERN</span><span class="p">,</span> <span class="n">allow_empty</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="PackageExporter.deny"><a class="viewcode-back" href="../../../package.html#torch.package.PackageExporter.deny">[docs]</a>    <span class="k">def</span> <span class="nf">deny</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include</span><span class="p">:</span> <span class="s2">&quot;GlobPattern&quot;</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">exclude</span><span class="p">:</span> <span class="s2">&quot;GlobPattern&quot;</span> <span class="o">=</span> <span class="p">()):</span>
        <span class="sd">&quot;&quot;&quot;Blocklist modules who names match the given glob patterns from the list of modules the package can import.</span>
<span class="sd">        If a dependency on any matching packages is found, a :class:`PackagingError` is raised.</span>

<span class="sd">        Args:</span>
<span class="sd">            include (Union[List[str], str]): A string e.g. ``&quot;my_package.my_subpackage&quot;``, or list of strings</span>
<span class="sd">                for the names of the modules to be externed. This can also be a glob-style pattern, as described in :meth:`mock`.</span>

<span class="sd">            exclude (Union[List[str], str]): An optional pattern that excludes some patterns that match the include string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patterns</span><span class="p">[</span><span class="n">GlobGroup</span><span class="p">(</span><span class="n">include</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">)]</span> <span class="o">=</span> <span class="n">_PatternInfo</span><span class="p">(</span>
            <span class="n">_ModuleProviderAction</span><span class="o">.</span><span class="n">DENY</span><span class="p">,</span> <span class="n">allow_empty</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_persistent_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_storage</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">TypedStorage</span><span class="p">):</span>
            <span class="n">storage</span><span class="p">:</span> <span class="n">Storage</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">TypedStorage</span><span class="p">):</span>
                <span class="c1"># TODO: Once we decide to break serialization FC, we can</span>
                <span class="c1"># remove this case</span>
                <span class="n">untyped_storage</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_untyped_storage</span>
                <span class="n">storage_type_str</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">pickle_storage_type</span><span class="p">()</span>
                <span class="n">storage_type</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">torch</span><span class="p">,</span> <span class="n">storage_type_str</span><span class="p">)</span>
                <span class="n">storage</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Storage</span><span class="p">,</span> <span class="n">untyped_storage</span><span class="p">)</span>
                <span class="n">storage_numel</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">UntypedStorage</span><span class="p">):</span>
                <span class="n">untyped_storage</span> <span class="o">=</span> <span class="n">obj</span>
                <span class="n">storage</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Storage</span><span class="p">,</span> <span class="n">untyped_storage</span><span class="p">)</span>
                <span class="n">storage_type</span> <span class="o">=</span> <span class="n">normalize_storage_type</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">storage</span><span class="p">))</span>
                <span class="n">storage_numel</span> <span class="o">=</span> <span class="n">storage</span><span class="o">.</span><span class="n">nbytes</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;storage type not recognized: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">location</span> <span class="o">=</span> <span class="n">location_tag</span><span class="p">(</span><span class="n">storage</span><span class="p">)</span>

            <span class="c1"># serialize storage if not already written</span>
            <span class="n">storage_present</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_context</span><span class="o">.</span><span class="n">has_storage</span><span class="p">(</span><span class="n">storage</span><span class="p">)</span>
            <span class="n">storage_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_context</span><span class="o">.</span><span class="n">get_or_add_storage</span><span class="p">(</span><span class="n">storage</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">storage_present</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">storage</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s2">&quot;cpu&quot;</span><span class="p">:</span>
                    <span class="n">storage</span> <span class="o">=</span> <span class="n">storage</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
                <span class="n">num_bytes</span> <span class="o">=</span> <span class="n">storage</span><span class="o">.</span><span class="n">nbytes</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">zip_file</span><span class="o">.</span><span class="n">write_record</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;.data/</span><span class="si">{</span><span class="n">storage_id</span><span class="si">}</span><span class="s2">.storage&quot;</span><span class="p">,</span> <span class="n">storage</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">(),</span> <span class="n">num_bytes</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;storage&quot;</span><span class="p">,</span> <span class="n">storage_type</span><span class="p">,</span> <span class="n">storage_id</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">storage_numel</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__reduce_package__&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">_gate_torchscript_serialization</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">obj</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">RecursiveScriptModule</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;Serializing ScriptModules directly into a package is a beta feature. &quot;</span>
                    <span class="s2">&quot;To use, set global &quot;</span>
                    <span class="s2">&quot;`torch.package.package_exporter._gate_torchscript_serialization` to `False`.&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">serialized_reduces</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">serialized_reduces</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">obj</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;reduce_package&quot;</span><span class="p">,</span>
                    <span class="nb">id</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span>
                    <span class="o">*</span><span class="n">obj</span><span class="o">.</span><span class="n">__reduce_package__</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
                <span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">serialized_reduces</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">obj</span><span class="p">)]</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="c1"># If __exit__ was called because an exception was raised, we do not</span>
        <span class="c1"># attempt to finalize the package. Instead, control is returned to the</span>
        <span class="c1"># caller to continue raising the exception.</span>
        <span class="k">if</span> <span class="n">exc_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Do the bare minimum to leave the open buffer in a valid state.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_finalize_zip</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">str_or_bytes</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_written_files</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Tried to write file &#39;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&#39;, but it already exists in this archive. &quot;</span>
                <span class="s2">&quot;Please file a bug.&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_written_files</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_mangled</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Tried to save a torch.package&#39;d module as &#39;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
                <span class="s2">&quot;Directly saving torch.package&#39;d modules is not allowed.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">str_or_bytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">str_or_bytes</span> <span class="o">=</span> <span class="n">str_or_bytes</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zip_file</span><span class="o">.</span><span class="n">write_record</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">str_or_bytes</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">str_or_bytes</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_validate_dependency_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># 1. Check the graph for any errors inserted during dependency analysis.</span>
        <span class="k">for</span> <span class="n">module_name</span><span class="p">,</span> <span class="n">attrs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependency_graph</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PackagingError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dependency_graph</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">)</span>

        <span class="c1"># 2. Check that all patterns for which allow_empty=False have been matched at least once.</span>
        <span class="k">for</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">pattern_info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">patterns</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pattern_info</span><span class="o">.</span><span class="n">allow_empty</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pattern_info</span><span class="o">.</span><span class="n">was_matched</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">EmptyMatchError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Exporter did not match any modules to </span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">, which was marked as allow_empty=False&quot;</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_write_mock_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;_mock.py&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_written_files</span><span class="p">:</span>
            <span class="n">mock_file</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;_mock.py&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_source_string</span><span class="p">(</span><span class="s2">&quot;_mock&quot;</span><span class="p">,</span> <span class="n">_read_file</span><span class="p">(</span><span class="n">mock_file</span><span class="p">),</span> <span class="n">is_package</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_execute_dependency_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Takes a finalized dependency graph describing how to package all</span>
<span class="sd">        modules and executes it, writing to the ZIP archive.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_dependency_graph</span><span class="p">()</span>

        <span class="n">extern_modules</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">module_name</span><span class="p">,</span> <span class="n">attrs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependency_graph</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="n">_ModuleProviderAction</span><span class="o">.</span><span class="n">EXTERN</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extern_hooks</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module_name</span><span class="p">)</span>

                <span class="n">extern_modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="n">_ModuleProviderAction</span><span class="o">.</span><span class="n">MOCK</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mock_hooks</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module_name</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_write_mock_file</span><span class="p">()</span>

                <span class="n">is_package</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_import_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">),</span> <span class="s2">&quot;__path__&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_source_string</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">_MOCK_IMPL</span><span class="p">,</span> <span class="n">is_package</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="n">_ModuleProviderAction</span><span class="o">.</span><span class="n">INTERN</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_intern_hooks</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module_name</span><span class="p">)</span>

                <span class="c1"># The node in the dependency graph contains metadata that tells us</span>
                <span class="c1"># how to intern the module.</span>
                <span class="k">if</span> <span class="s2">&quot;provided&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Module was marked `intern` but not provided: </span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

                <span class="k">if</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;is_pickle&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="c1"># This node came from save_pickle, we don&#39;t need to write any source for it.</span>
                    <span class="k">continue</span>

                <span class="n">is_package</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;is_package&quot;</span><span class="p">]</span>
                <span class="n">source</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_source_string</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">is_package</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="n">_ModuleProviderAction</span><span class="o">.</span><span class="n">REPACKAGED_MOCK_MODULE</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_mock_file</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="n">_ModuleProviderAction</span><span class="o">.</span><span class="n">SKIP</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Invalid action: </span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2">. Please report a bug to PyTorch.&quot;</span>
                <span class="p">)</span>

        <span class="n">extern_file_contents</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">extern_modules</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="s2">&quot;.data/extern_modules&quot;</span><span class="p">,</span> <span class="n">extern_file_contents</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_write_python_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Writes the python version that the package was created with to .data/python_version&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="s2">&quot;.data/python_version&quot;</span><span class="p">,</span> <span class="n">platform</span><span class="o">.</span><span class="n">python_version</span><span class="p">())</span>

<div class="viewcode-block" id="PackageExporter.close"><a class="viewcode-back" href="../../../package.html#torch.package.PackageExporter.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write the package to the filesystem. Any calls after :meth:`close` are now invalid.</span>
<span class="sd">        It is preferable to use resource guard syntax instead::</span>

<span class="sd">            with PackageExporter(&quot;file.zip&quot;) as e:</span>
<span class="sd">                ...</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_execute_dependency_graph</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_python_version</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">script_module_serializer</span><span class="o">.</span><span class="n">write_files</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finalize_zip</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_finalize_zip</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called at the very end of packaging to leave the zipfile in a closed but valid state.&quot;&quot;&quot;</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">zip_file</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package</span><span class="p">,</span> <span class="n">resource</span><span class="p">):</span>
        <span class="n">package_path</span> <span class="o">=</span> <span class="n">package</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="n">_normalize_path</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">package_path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">resource</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="nf">_can_implicitly_extern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">top_level_package_name</span> <span class="o">=</span> <span class="n">module_name</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">top_level_package_name</span> <span class="o">==</span> <span class="s2">&quot;torch&quot;</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="n">top_level_package_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_DISALLOWED_MODULES</span>
            <span class="ow">and</span> <span class="n">is_stdlib_module</span><span class="p">(</span><span class="n">top_level_package_name</span><span class="p">)</span>
        <span class="p">)</span>

<div class="viewcode-block" id="PackageExporter.dependency_graph_string"><a class="viewcode-back" href="../../../package.html#torch.package.PackageExporter.dependency_graph_string">[docs]</a>    <span class="k">def</span> <span class="nf">dependency_graph_string</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns digraph string representation of dependencies in package.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A string representation of dependencies in package.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependency_graph</span><span class="o">.</span><span class="n">to_dot</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_nodes_with_action_type</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ModuleProviderAction</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">node_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependency_graph</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">node_action</span> <span class="o">=</span> <span class="n">node_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">node_action</span> <span class="o">==</span> <span class="n">action</span> <span class="ow">and</span> <span class="s2">&quot;is_pickle&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">node_dict</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>

<div class="viewcode-block" id="PackageExporter.externed_modules"><a class="viewcode-back" href="../../../package.html#torch.package.PackageExporter.externed_modules">[docs]</a>    <span class="k">def</span> <span class="nf">externed_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return all modules that are currently externed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list containing the names of modules which will be</span>
<span class="sd">            externed in this package.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes_with_action_type</span><span class="p">(</span><span class="n">_ModuleProviderAction</span><span class="o">.</span><span class="n">EXTERN</span><span class="p">)</span></div>

<div class="viewcode-block" id="PackageExporter.interned_modules"><a class="viewcode-back" href="../../../package.html#torch.package.PackageExporter.interned_modules">[docs]</a>    <span class="k">def</span> <span class="nf">interned_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return all modules that are currently interned.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list containing the names of modules which will be</span>
<span class="sd">            interned in this package.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes_with_action_type</span><span class="p">(</span><span class="n">_ModuleProviderAction</span><span class="o">.</span><span class="n">INTERN</span><span class="p">)</span></div>

<div class="viewcode-block" id="PackageExporter.mocked_modules"><a class="viewcode-back" href="../../../package.html#torch.package.PackageExporter.mocked_modules">[docs]</a>    <span class="k">def</span> <span class="nf">mocked_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return all modules that are currently mocked.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list containing the names of modules which will be</span>
<span class="sd">            mocked in this package.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes_with_action_type</span><span class="p">(</span><span class="n">_ModuleProviderAction</span><span class="o">.</span><span class="n">MOCK</span><span class="p">)</span></div>

<div class="viewcode-block" id="PackageExporter.denied_modules"><a class="viewcode-back" href="../../../package.html#torch.package.PackageExporter.denied_modules">[docs]</a>    <span class="k">def</span> <span class="nf">denied_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return all modules that are currently denied.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list containing the names of modules which will be</span>
<span class="sd">            denied in this package.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes_with_action_type</span><span class="p">(</span><span class="n">_ModuleProviderAction</span><span class="o">.</span><span class="n">DENY</span><span class="p">)</span></div>

<div class="viewcode-block" id="PackageExporter.get_rdeps"><a class="viewcode-back" href="../../../package.html#torch.package.PackageExporter.get_rdeps">[docs]</a>    <span class="k">def</span> <span class="nf">get_rdeps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return a list of all modules which depend on the module ``module_name``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list containing the names of modules which depend on ``module_name``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">module_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependency_graph</span><span class="o">.</span><span class="n">_pred</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dependency_graph</span><span class="o">.</span><span class="n">_pred</span><span class="p">[</span><span class="n">module_name</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="PackageExporter.all_paths"><a class="viewcode-back" href="../../../package.html#torch.package.PackageExporter.all_paths">[docs]</a>    <span class="k">def</span> <span class="nf">all_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return a dot representation of the subgraph</span>
<span class="sd">           that has all paths from src to dst.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A dot representation containing all paths from src to dst.</span>
<span class="sd">            (https://graphviz.org/doc/info/lang.html)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependency_graph</span><span class="o">.</span><span class="n">all_paths</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span></div></div>


<span class="c1"># even though these are in the standard library, we do not allow them to be</span>
<span class="c1"># automatically externed since they offer a lot of system level access</span>
<span class="n">_DISALLOWED_MODULES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sys&quot;</span><span class="p">,</span> <span class="s2">&quot;io&quot;</span><span class="p">]</span>

<span class="n">_MOCK_IMPL</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">from _mock import MockedObject</span>
<span class="s2">def __getattr__(attr: str):</span>
<span class="s2">    return MockedObject(__name__ + &#39;.&#39; + attr, _suppress_err=True)</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="k">def</span> <span class="nf">_read_file</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">b</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
</pre></div>

             </article>
             
            </div>
            <footer>
  

  

    <hr>

  

  <div role="contentinfo">
    <p>
        &copy; Copyright 2023, PyTorch Contributors.

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>
     

</footer>

          </div>
<script>

var match = window.location.href.match(/\/_[a-zA-Z0-9_]*.html|_dynamo/gi);
var url = window.location.href.lastIndexOf(match[match.length-1]);

if (url)
  {
    var div = '<div class="admonition note"><p class="admonition-title">Note</p><p><i class="fa fa-exclamation-circle" aria-hidden="true">&nbsp</i> This page describes an internal API which is not intended to be used outside of the PyTorch codebase and can be modified or removed without notice.</p></div>'
    document.getElementById("pytorch-article").insertAdjacentHTML('afterBegin', div)
  }
</script>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              
            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
         <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
         <script src="../../../_static/jquery.js"></script>
         <script src="../../../_static/underscore.js"></script>
         <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
         <script src="../../../_static/doctools.js"></script>
         <script src="../../../_static/sphinx_highlight.js"></script>
         <script src="../../../_static/clipboard.min.js"></script>
         <script src="../../../_static/copybutton.js"></script>
     

  

  <script type="text/javascript" src="../../../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 
<script script type="text/javascript">
  var collapsedSections = ['Developer Notes', 'Language Bindings', 'Libraries', 'Community'];
</script>

<img height="1" width="1" style="border-style:none;" alt="" src="https://www.googleadservices.com/pagead/conversion/795629140/?label=txkmCPmdtosBENSssfsC&amp;guid=ON&amp;script=0"/>


  <!-- Begin Footer -->

  <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
    <div class="container">
      <div class="row">
        <div class="col-md-4 text-center">
          <h2>Docs</h2>
          <p>Access comprehensive developer documentation for PyTorch</p>
          <a class="with-right-arrow" href="https://pytorch.org/docs/stable/index.html">View Docs</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Tutorials</h2>
          <p>Get in-depth tutorials for beginners and advanced developers</p>
          <a class="with-right-arrow" href="https://pytorch.org/tutorials">View Tutorials</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Resources</h2>
          <p>Find development resources and get your questions answered</p>
          <a class="with-right-arrow" href="https://pytorch.org/resources">View Resources</a>
        </div>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container footer-container">
      <div class="footer-logo-wrapper">
        <a href="https://pytorch.org/" class="footer-logo"></a>
      </div>

      <div class="footer-links-wrapper">
        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/">PyTorch</a></li>
            <li><a href="https://pytorch.org/get-started">Get Started</a></li>
            <li><a href="https://pytorch.org/features">Features</a></li>
            <li><a href="https://pytorch.org/ecosystem">Ecosystem</a></li>
            <li><a href="https://pytorch.org/blog/">Blog</a></li>
            <li><a href="https://github.com/pytorch/pytorch/blob/master/CONTRIBUTING.md">Contributing</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/resources">Resources</a></li>
            <li><a href="https://pytorch.org/tutorials">Tutorials</a></li>
            <li><a href="https://pytorch.org/docs/stable/index.html">Docs</a></li>
            <li><a href="https://discuss.pytorch.org" target="_blank">Discuss</a></li>
            <li><a href="https://github.com/pytorch/pytorch/issues" target="_blank">Github Issues</a></li>
            <li><a href="https://pytorch.org/assets/brand-guidelines/PyTorch-Brand-Guidelines.pdf" target="_blank">Brand Guidelines</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title">Stay up to date</li>
            <li><a href="https://www.facebook.com/pytorch" target="_blank">Facebook</a></li>
            <li><a href="https://twitter.com/pytorch" target="_blank">Twitter</a></li>
            <li><a href="https://www.youtube.com/pytorch" target="_blank">YouTube</a></li>
            <li><a href="https://www.linkedin.com/company/pytorch" target="_blank">LinkedIn</a></li>
          </ul>  
          </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title">PyTorch Podcasts</li>
            <li><a href="https://open.spotify.com/show/6UzHKeiy368jKfQMKKvJY5" target="_blank">Spotify</a></li>
            <li><a href="https://podcasts.apple.com/us/podcast/pytorch-developer-podcast/id1566080008" target="_blank">Apple</a></li>
            <li><a href="https://www.google.com/podcasts?feed=aHR0cHM6Ly9mZWVkcy5zaW1wbGVjYXN0LmNvbS9PQjVGa0lsOA%3D%3D" target="_blank">Google</a></li>
            <li><a href="https://music.amazon.com/podcasts/7a4e6f0e-26c2-49e9-a478-41bd244197d0/PyTorch-Developer-Podcast?" target="_blank">Amazon</a></li>
          </ul>
         </div>
        </div>
        
        <div class="privacy-policy">
          <ul>
            <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/terms/" target="_blank">Terms</a></li>
            <li class="privacy-policy-links">|</li>
            <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/privacy-policy/" target="_blank">Privacy</a></li>
          </ul>
        </div>
        <div class="copyright">
        <p>Â© Copyright The Linux Foundation. The PyTorch Foundation is a project of The Linux Foundation.
          For web site terms of use, trademark policy and other policies applicable to The PyTorch Foundation please see
          <a href="www.linuxfoundation.org/policies/">www.linuxfoundation.org/policies/</a>. The PyTorch Foundation supports the PyTorch open source
          project, which has been established as PyTorch Project a Series of LF Projects, LLC. For policies applicable to the PyTorch Project a Series of LF Projects, LLC,
          please see <a href="www.lfprojects.org/policies/">www.lfprojects.org/policies/</a>.</p>
      </div>
     </div>

  </footer>

  <div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebookâ€™s Cookies Policy applies. Learn more, including about available controls: <a href="https://www.facebook.com/policies/cookies/">Cookies Policy</a>.</p>
    <img class="close-button" src="../../../_static/images/pytorch-x.svg">
  </div>
</div>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>
            
          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li class="resources-mobile-menu-title" class="active">
            Docs
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/docs/stable/index.html">PyTorch</a>
            </li>

            <li>
              <a href="https://pytorch.org/audio/stable/index.html">torchaudio</a>
            </li>

            <li>
              <a href="https://pytorch.org/text/stable/index.html">torchtext</a>
            </li>

            <li>
              <a href="https://pytorch.org/vision/stable/index.html">torchvision</a>
            </li>

            <li>
              <a href="https://pytorch.org/torcharrow">torcharrow</a>
            </li>

            <li>
              <a href="https://pytorch.org/data">TorchData</a>
            </li>

            <li>
              <a href="https://pytorch.org/torchrec">TorchRec</a>
            </li>

            <li>
              <a href="https://pytorch.org/serve/">TorchServe</a>
            </li>

            <li>
              <a href="https://pytorch.org/torchx/">TorchX</a>
            </li>

            <li>
              <a href="https://pytorch.org/xla">PyTorch on XLA Devices</a>
            </li>
          </ul>

          <li class="resources-mobile-menu-title">
            Resources
          </li>
            
           <ul class="resources-mobile-menu-items">

            <li>
              <a href="https://pytorch.org/features">About</a>
            </li>

            <li>
              <a href="https://pytorch.org/foundation">PyTorch Foundation</a>
            </li>

            <li>
              <a href="https://pytorch.org/#community-module">Community</a>
            </li>

            <li>
              <a href="https://pytorch.org/community-stories">Community Stories</a>
            </li>

            <li>
              <a href="https://pytorch.org/resources">Developer Resources</a>
            </li>

            <li>
              <a href="https://pytorch.org/events">Events</a>
            </li>

            <li>
              <a href="https://discuss.pytorch.org/">Forums</a>
            </li>

            <li>
              <a href="https://pytorch.org/hub">Models (Beta)</a>
            </li>
          </ul>

          <li>
            <a href="https://github.com/pytorch/pytorch">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="../../../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>