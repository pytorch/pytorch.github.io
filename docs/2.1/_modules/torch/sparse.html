


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta name="robots" content="noindex">
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>torch.sparse &mdash; PyTorch 2.1 documentation</title>
  

  
  
  
  
    <link rel="canonical" href="https://pytorch.org/docs/stable/_modules/torch/sparse.html"/>
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.css" type="text/css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/katex-math.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/sphinx-dropdown.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/panels-bootstrap.min.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/jit.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />


  <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-T8XT4PS');</script>
    <!-- End Google Tag Manager -->
  


  
  <script src="../../_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../../_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>

          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li class="active docs-active">
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-orange-arrow">
                Docs
              </a>
              <div class="resources-dropdown-menu">
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/docs/stable/index.html">
                  <span class="dropdown-title">PyTorch</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/audio/stable/index.html">
                  <span class="dropdown-title">torchaudio</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/text/stable/index.html">
                  <span class="dropdown-title">torchtext</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/vision/stable/index.html">
                  <span class="dropdown-title">torchvision</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torcharrow">
                  <span class="dropdown-title">torcharrow</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/data">
                  <span class="dropdown-title">TorchData</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torchrec">
                  <span class="dropdown-title">TorchRec</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/serve/">
                  <span class="dropdown-title">TorchServe</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torchx/">
                  <span class="dropdown-title">TorchX</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/xla">
                  <span class="dropdown-title">PyTorch on XLA Devices</span>
                  <p></p>
                </a>
            </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-arrow">
                Resources
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/features">
                  <span class="dropdown-title">About</span>
                  <p>Learn about PyTorchâ€™s features and capabilities</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/foundation">
                  <span class="dropdown-title">PyTorch Foundation</span>
                  <p>Learn about the PyTorch foundation</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/#community-module">
                  <span class="dropdown-title">Community</span>
                  <p>Join the PyTorch developer community to contribute, learn, and get your questions answered.</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/community-stories">
                  <span class="dropdown-title">Community Stories</span>
                  <p>Learn how our community solves real, everyday machine learning problems with PyTorch.</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/resources">
                  <span class="dropdown-title">Developer Resources</span>
                  <p>Find resources and get questions answered</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/events">
                  <span class="dropdown-title">Events</span>
                  <p>Find events, webinars, and podcasts</p>
                </a>
                <a class="nav-dropdown-item" href="https://discuss.pytorch.org/" target="_blank">
                  <span class="dropdown-title">Forums</span>
                  <p>A place to discuss PyTorch code, issues, install, research</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/hub">
                  <span class="dropdown-title">Models (Beta)</span>
                  <p>Discover, publish, and reuse pre-trained models</p>
                </a>
              </div>
            </div>
          </li>

          <li>
            <a href="https://github.com/pytorch/pytorch">GitHub</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>

<body class="pytorch-body">

   

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            
    <div class="version">
      <a href='https://pytorch.org/docs/versions.html'>2.1 &#x25BC</a>
    </div>
    


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          </div>

          


            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Community</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../community/build_ci_governance.html">PyTorch Governance | Build + CI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../community/contribution_guide.html">PyTorch Contribution Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../community/design.html">PyTorch Design Philosophy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../community/governance.html">PyTorch Governance | Mechanics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../community/persons_of_interest.html">PyTorch Governance | Maintainers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../notes/amp_examples.html">CUDA Automatic Mixed Precision examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/autograd.html">Autograd mechanics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/broadcasting.html">Broadcasting semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/cpu_threading_torchscript_inference.html">CPU threading and TorchScript inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/cuda.html">CUDA semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/ddp.html">Distributed Data Parallel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/extending.html">Extending PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/extending.func.html">Extending torch.func with autograd.Function</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/gradcheck.html">Gradcheck mechanics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/hip.html">HIP (ROCm) semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/large_scale_deployments.html">Features for large-scale deployments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/modules.html">Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/mps.html">MPS backend</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/multiprocessing.html">Multiprocessing best practices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/numerical_accuracy.html">Numerical accuracy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/randomness.html">Reproducibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/serialization.html">Serialization semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/windows.html">Windows FAQ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Language Bindings</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../cpp_index.html">C++</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/javadoc/">Javadoc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deploy.html">torch::deploy</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Python API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../torch.html">torch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nn.html">torch.nn</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nn.functional.html">torch.nn.functional</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tensors.html">torch.Tensor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tensor_attributes.html">Tensor Attributes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tensor_view.html">Tensor Views</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../amp.html">torch.amp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../autograd.html">torch.autograd</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../library.html">torch.library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cpu.html">torch.cpu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cuda.html">torch.cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../torch_cuda_memory.html">Understanding CUDA Memory Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../torch_cuda_memory.html#generating-a-snapshot">Generating a Snapshot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../torch_cuda_memory.html#using-the-visualizer">Using the visualizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../torch_cuda_memory.html#snapshot-api-reference">Snapshot API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mps.html">torch.mps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../backends.html">torch.backends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../export.html">torch.export</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../distributed.html">torch.distributed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../distributed.algorithms.join.html">torch.distributed.algorithms.join</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../distributed.elastic.html">torch.distributed.elastic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fsdp.html">torch.distributed.fsdp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../distributed.optim.html">torch.distributed.optim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../distributed.tensor.parallel.html">torch.distributed.tensor.parallel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../distributed.checkpoint.html">torch.distributed.checkpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../distributions.html">torch.distributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../torch.compiler.html">torch.compiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fft.html">torch.fft</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../func.html">torch.func</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../futures.html">torch.futures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fx.html">torch.fx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hub.html">torch.hub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../jit.html">torch.jit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../linalg.html">torch.linalg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../monitor.html">torch.monitor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../signal.html">torch.signal</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../special.html">torch.special</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../torch.overrides.html">torch.overrides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../package.html">torch.package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../profiler.html">torch.profiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nn.init.html">torch.nn.init</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../onnx.html">torch.onnx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../optim.html">torch.optim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../complex_numbers.html">Complex Numbers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ddp_comm_hooks.html">DDP Communication Hooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pipeline.html">Pipeline Parallelism</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quantization.html">Quantization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rpc.html">Distributed RPC Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../random.html">torch.random</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../masked.html">torch.masked</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nested.html">torch.nested</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sparse.html">torch.sparse</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../storage.html">torch.Storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing.html">torch.testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../utils.html">torch.utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../benchmark_utils.html">torch.utils.benchmark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bottleneck.html">torch.utils.bottleneck</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../checkpoint.html">torch.utils.checkpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cpp_extension.html">torch.utils.cpp_extension</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data.html">torch.utils.data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../jit_utils.html">torch.utils.jit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dlpack.html">torch.utils.dlpack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mobile_optimizer.html">torch.utils.mobile_optimizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_zoo.html">torch.utils.model_zoo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tensorboard.html">torch.utils.tensorboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../type_info.html">Type Info</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../named_tensor.html">Named Tensors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../name_inference.html">Named Tensors operator coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../config_mod.html">torch.__config__</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../logging.html">torch._logging</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Libraries</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/audio/stable">torchaudio</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/data">TorchData</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/torchrec">TorchRec</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/serve">TorchServe</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/text/stable">torchtext</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/vision/stable">torchvision</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/xla/">PyTorch on XLA Devices</a></li>
</ul>

            
          

        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="../../index.html">
          
            Docs
          
        </a> &gt;
      </li>

        
          <li><a href="../index.html">Module code</a> &gt;</li>
        
          <li><a href="../torch.html">torch</a> &gt;</li>
        
      <li>torch.sparse</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">

        

          <!-- Google Tag Manager (noscript) -->
          <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T8XT4PS"
          height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
          <!-- End Google Tag Manager (noscript) -->
          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <h1>Source code for torch.sparse</h1><div class="highlight"><pre>
<span></span><span class="c1"># The Tensor classes are added to this module by python_tensor.cpp</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Any</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch._C</span> <span class="kn">import</span> <span class="n">_add_docstr</span><span class="p">,</span> <span class="n">_sparse</span>  <span class="c1"># type: ignore[attr-defined]</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">Tensor</span>

<span class="c1"># Semi structured sparsity support</span>
<span class="kn">from</span> <span class="nn">.semi_structured</span> <span class="kn">import</span> <span class="n">SparseSemiStructuredTensor</span><span class="p">,</span> <span class="n">to_sparse_semi_structured</span>

<span class="c1"># A workaround to support both TorchScript and MyPy:</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span>
<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">torch.types</span> <span class="kn">import</span> <span class="n">_dtype</span> <span class="k">as</span> <span class="n">DType</span>
    <span class="n">DimOrDims</span> <span class="o">=</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># The JIT doesn&#39;t understand Union, nor torch.dtype here</span>
    <span class="n">DType</span> <span class="o">=</span> <span class="nb">int</span>
    <span class="n">DimOrDims</span> <span class="o">=</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;addmm&#39;</span><span class="p">,</span>
    <span class="s1">&#39;check_sparse_tensor_invariants&#39;</span><span class="p">,</span>
    <span class="s1">&#39;mm&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sum&#39;</span><span class="p">,</span>
    <span class="s1">&#39;softmax&#39;</span><span class="p">,</span>
    <span class="s1">&#39;log_softmax&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SparseSemiStructuredTensor&#39;</span><span class="p">,</span>
    <span class="s1">&#39;to_sparse_semi_structured&#39;</span><span class="p">,</span>
    <span class="s1">&#39;as_sparse_gradcheck&#39;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">addmm</span> <span class="o">=</span> <span class="n">_add_docstr</span><span class="p">(</span><span class="n">_sparse</span><span class="o">.</span><span class="n">_sparse_addmm</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">sparse.addmm(mat, mat1, mat2, *, beta=1., alpha=1.) -&gt; Tensor</span>

<span class="s2">This function does exact same thing as :func:`torch.addmm` in the forward,</span>
<span class="s2">except that it supports backward for sparse COO matrix :attr:`mat1`.</span>
<span class="s2">When :attr:`mat1` is a COO tensor it must have `sparse_dim = 2`.</span>
<span class="s2">When inputs are COO tensors, this function also supports backward for both inputs.</span>

<span class="s2">Supports both CSR and COO storage formats.</span>

<span class="s2">.. note::</span>
<span class="s2">    This function doesn&#39;t support computing derivaties with respect to CSR matrices.</span>

<span class="s2">Args:</span>
<span class="s2">    mat (Tensor): a dense matrix to be added</span>
<span class="s2">    mat1 (Tensor): a sparse matrix to be multiplied</span>
<span class="s2">    mat2 (Tensor): a dense matrix to be multiplied</span>
<span class="s2">    beta (Number, optional): multiplier for :attr:`mat` (:math:`\beta`)</span>
<span class="s2">    alpha (Number, optional): multiplier for :math:`mat1 @ mat2` (:math:`\alpha`)</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>


<span class="n">mm</span> <span class="o">=</span> <span class="n">_add_docstr</span><span class="p">(</span><span class="n">_sparse</span><span class="o">.</span><span class="n">_sparse_mm</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Performs a matrix multiplication of the sparse matrix :attr:`mat1`</span>
<span class="s2">    and the (sparse or strided) matrix :attr:`mat2`. Similar to :func:`torch.mm`, if :attr:`mat1` is a</span>
<span class="s2">    :math:`(n \times m)` tensor, :attr:`mat2` is a :math:`(m \times p)` tensor, out will be a</span>
<span class="s2">    :math:`(n \times p)` tensor.</span>
<span class="s2">    When :attr:`mat1` is a COO tensor it must have `sparse_dim = 2`.</span>
<span class="s2">    When inputs are COO tensors, this function also supports backward for both inputs.</span>

<span class="s2">    Supports both CSR and COO storage formats.</span>

<span class="s2">.. note::</span>
<span class="s2">    This function doesn&#39;t support computing derivaties with respect to CSR matrices.</span>

<span class="s2">    This function also additionally accepts an optional :attr:`reduce` argument that allows</span>
<span class="s2">    specification of an optional reduction operation, mathematically performs the following operation:</span>

<span class="s2">.. math::</span>

<span class="s2">    z_</span><span class="si">{ij}</span><span class="s2"> = \bigoplus_{k = 0}^{K - 1} x_</span><span class="si">{ik}</span><span class="s2"> y_</span><span class="si">{kj}</span>

<span class="s2">where :math:`\bigoplus` defines the reduce operator. :attr:`reduce` is implemented only for</span>
<span class="s2">CSR storage format on CPU device.</span>

<span class="s2">Args:</span>
<span class="s2">    mat1 (Tensor): the first sparse matrix to be multiplied</span>
<span class="s2">    mat2 (Tensor): the second matrix to be multiplied, which could be sparse or dense</span>
<span class="s2">    reduce (str, optional): the reduction operation to apply for non-unique indices</span>
<span class="s2">        (:obj:`&quot;sum&quot;`, :obj:`&quot;mean&quot;`, :obj:`&quot;amax&quot;`, :obj:`&quot;amin&quot;`). Default :obj:`&quot;sum&quot;`.</span>

<span class="s2">Shape:</span>
<span class="s2">    The format of the output tensor of this function follows:</span>
<span class="s2">    - sparse x sparse -&gt; sparse</span>
<span class="s2">    - sparse x dense -&gt; dense</span>

<span class="s2">Example::</span>

<span class="s2">    &gt;&gt;&gt; a = torch.tensor([[1., 0, 2], [0, 3, 0]]).to_sparse().requires_grad_()</span>
<span class="s2">    &gt;&gt;&gt; a</span>
<span class="s2">    tensor(indices=tensor([[0, 0, 1],</span>
<span class="s2">                           [0, 2, 1]]),</span>
<span class="s2">           values=tensor([1., 2., 3.]),</span>
<span class="s2">           size=(2, 3), nnz=3, layout=torch.sparse_coo, requires_grad=True)</span>
<span class="s2">    &gt;&gt;&gt; b = torch.tensor([[0, 1.], [2, 0], [0, 0]], requires_grad=True)</span>
<span class="s2">    &gt;&gt;&gt; b</span>
<span class="s2">    tensor([[0., 1.],</span>
<span class="s2">            [2., 0.],</span>
<span class="s2">            [0., 0.]], requires_grad=True)</span>
<span class="s2">    &gt;&gt;&gt; y = torch.sparse.mm(a, b)</span>
<span class="s2">    &gt;&gt;&gt; y</span>
<span class="s2">    tensor([[0., 1.],</span>
<span class="s2">            [6., 0.]], grad_fn=&lt;SparseAddmmBackward0&gt;)</span>
<span class="s2">    &gt;&gt;&gt; y.sum().backward()</span>
<span class="s2">    &gt;&gt;&gt; a.grad</span>
<span class="s2">    tensor(indices=tensor([[0, 0, 1],</span>
<span class="s2">                           [0, 2, 1]]),</span>
<span class="s2">           values=tensor([1., 0., 2.]),</span>
<span class="s2">           size=(2, 3), nnz=3, layout=torch.sparse_coo)</span>
<span class="s2">    &gt;&gt;&gt; c = a.detach().to_sparse_csr()</span>
<span class="s2">    &gt;&gt;&gt; c</span>
<span class="s2">    tensor(crow_indices=tensor([0, 2, 3]),</span>
<span class="s2">           col_indices=tensor([0, 2, 1]),</span>
<span class="s2">           values=tensor([1., 2., 3.]), size=(2, 3), nnz=3,</span>
<span class="s2">           layout=torch.sparse_csr)</span>
<span class="s2">    &gt;&gt;&gt; y1 = torch.sparse.mm(c, b, &#39;sum&#39;)</span>
<span class="s2">    &gt;&gt;&gt; y1</span>
<span class="s2">    tensor([[0., 1.],</span>
<span class="s2">            [6., 0.]], grad_fn=&lt;SparseMmReduceImplBackward0&gt;)</span>
<span class="s2">    &gt;&gt;&gt; y2 = torch.sparse.mm(c, b, &#39;max&#39;)</span>
<span class="s2">    &gt;&gt;&gt; y2</span>
<span class="s2">    tensor([[0., 1.],</span>
<span class="s2">            [6., 0.]], grad_fn=&lt;SparseMmReduceImplBackward0&gt;)</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>


<span class="n">sampled_addmm</span> <span class="o">=</span> <span class="n">_add_docstr</span><span class="p">(</span><span class="n">_sparse</span><span class="o">.</span><span class="n">sparse_sampled_addmm</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">sparse.sampled_addmm(input, mat1, mat2, *, beta=1., alpha=1., out=None) -&gt; Tensor</span>

<span class="s2">Performs a matrix multiplication of the dense matrices :attr:`mat1` and :attr:`mat2` at the locations</span>
<span class="s2">specified by the sparsity pattern of :attr:`input`. The matrix :attr:`input` is added to the final result.</span>

<span class="s2">Mathematically this performs the following operation:</span>

<span class="s2">.. math::</span>

<span class="s2">    \text</span><span class="si">{out}</span><span class="s2"> = \alpha\ (\text</span><span class="si">{mat1}</span><span class="s2"> \mathbin{@} \text</span><span class="si">{mat2}</span><span class="s2">)*\text</span><span class="si">{spy}</span><span class="s2">(\text</span><span class="si">{input}</span><span class="s2">) + \beta\ \text</span><span class="si">{input}</span>

<span class="s2">where :math:`\text</span><span class="si">{spy}</span><span class="s2">(\text</span><span class="si">{input}</span><span class="s2">)` is the sparsity pattern matrix of :attr:`input`, :attr:`alpha`</span>
<span class="s2">and :attr:`beta` are the scaling factors.</span>
<span class="s2">:math:`\text</span><span class="si">{spy}</span><span class="s2">(\text</span><span class="si">{input}</span><span class="s2">)` has value 1 at the positions where :attr:`input` has non-zero values, and 0 elsewhere.</span>

<span class="s2">.. note::</span>
<span class="s2">    :attr:`input` must be a sparse CSR tensor. :attr:`mat1` and :attr:`mat2` must be dense tensors.</span>

<span class="s2">Args:</span>
<span class="s2">    input (Tensor): a sparse CSR matrix of shape `(m, n)` to be added and used to compute</span>
<span class="s2">        the sampled matrix multiplication</span>
<span class="s2">    mat1 (Tensor): a dense matrix of shape `(m, k)` to be multiplied</span>
<span class="s2">    mat2 (Tensor): a dense matrix of shape `(k, n)` to be multiplied</span>

<span class="s2">Keyword args:</span>
<span class="s2">    beta (Number, optional): multiplier for :attr:`input` (:math:`\beta`)</span>
<span class="s2">    alpha (Number, optional): multiplier for :math:`mat1 @ mat2` (:math:`\alpha`)</span>
<span class="s2">    out (Tensor, optional): output tensor. Ignored if `None`. Default: `None`.</span>

<span class="s2">Examples::</span>

<span class="s2">    &gt;&gt;&gt; input = torch.eye(3, device=&#39;cuda&#39;).to_sparse_csr()</span>
<span class="s2">    &gt;&gt;&gt; mat1 = torch.randn(3, 5, device=&#39;cuda&#39;)</span>
<span class="s2">    &gt;&gt;&gt; mat2 = torch.randn(5, 3, device=&#39;cuda&#39;)</span>
<span class="s2">    &gt;&gt;&gt; torch.sparse.sampled_addmm(input, mat1, mat2)</span>
<span class="s2">    tensor(crow_indices=tensor([0, 1, 2, 3]),</span>
<span class="s2">        col_indices=tensor([0, 1, 2]),</span>
<span class="s2">        values=tensor([ 0.2847, -0.7805, -0.1900]), device=&#39;cuda:0&#39;,</span>
<span class="s2">        size=(3, 3), nnz=3, layout=torch.sparse_csr)</span>
<span class="s2">    &gt;&gt;&gt; torch.sparse.sampled_addmm(input, mat1, mat2).to_dense()</span>
<span class="s2">    tensor([[ 0.2847,  0.0000,  0.0000],</span>
<span class="s2">        [ 0.0000, -0.7805,  0.0000],</span>
<span class="s2">        [ 0.0000,  0.0000, -0.1900]], device=&#39;cuda:0&#39;)</span>
<span class="s2">    &gt;&gt;&gt; torch.sparse.sampled_addmm(input, mat1, mat2, beta=0.5, alpha=0.5)</span>
<span class="s2">    tensor(crow_indices=tensor([0, 1, 2, 3]),</span>
<span class="s2">        col_indices=tensor([0, 1, 2]),</span>
<span class="s2">        values=tensor([ 0.1423, -0.3903, -0.0950]), device=&#39;cuda:0&#39;,</span>
<span class="s2">        size=(3, 3), nnz=3, layout=torch.sparse_csr)</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="sum"><a class="viewcode-back" href="../../generated/torch.sparse.sum.html#torch.sparse.sum">[docs]</a><span class="k">def</span> <span class="nf">sum</span><span class="p">(</span><span class="nb">input</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">dim</span><span class="p">:</span> <span class="n">DimOrDims</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the sum of each row of the sparse tensor :attr:`input` in the given</span>
<span class="sd">    dimensions :attr:`dim`. If :attr:`dim` is a list of dimensions,</span>
<span class="sd">    reduce over all of them. When sum over all ``sparse_dim``, this method</span>
<span class="sd">    returns a dense tensor instead of a sparse tensor.</span>

<span class="sd">    All summed :attr:`dim` are squeezed (see :func:`torch.squeeze`), resulting an output</span>
<span class="sd">    tensor having :attr:`dim` fewer dimensions than :attr:`input`.</span>

<span class="sd">    During backward, only gradients at ``nnz`` locations of :attr:`input`</span>
<span class="sd">    will propagate back. Note that the gradients of :attr:`input` is coalesced.</span>

<span class="sd">    Args:</span>
<span class="sd">        input (Tensor): the input sparse tensor</span>
<span class="sd">        dim (int or tuple of ints): a dimension or a list of dimensions to reduce. Default: reduce</span>
<span class="sd">            over all dims.</span>
<span class="sd">        dtype (:class:`torch.dtype`, optional): the desired data type of returned Tensor.</span>
<span class="sd">            Default: dtype of :attr:`input`.</span>

<span class="sd">    Example::</span>

<span class="sd">        &gt;&gt;&gt; nnz = 3</span>
<span class="sd">        &gt;&gt;&gt; dims = [5, 5, 2, 3]</span>
<span class="sd">        &gt;&gt;&gt; I = torch.cat([torch.randint(0, dims[0], size=(nnz,)),</span>
<span class="sd">                           torch.randint(0, dims[1], size=(nnz,))], 0).reshape(2, nnz)</span>
<span class="sd">        &gt;&gt;&gt; V = torch.randn(nnz, dims[2], dims[3])</span>
<span class="sd">        &gt;&gt;&gt; size = torch.Size(dims)</span>
<span class="sd">        &gt;&gt;&gt; # xdoctest: +IGNORE_WANT(&quot;non-deterministic&quot;)</span>
<span class="sd">        &gt;&gt;&gt; S = torch.sparse_coo_tensor(I, V, size)</span>
<span class="sd">        &gt;&gt;&gt; S</span>
<span class="sd">        tensor(indices=tensor([[2, 0, 3],</span>
<span class="sd">                               [2, 4, 1]]),</span>
<span class="sd">               values=tensor([[[-0.6438, -1.6467,  1.4004],</span>
<span class="sd">                               [ 0.3411,  0.0918, -0.2312]],</span>

<span class="sd">                              [[ 0.5348,  0.0634, -2.0494],</span>
<span class="sd">                               [-0.7125, -1.0646,  2.1844]],</span>

<span class="sd">                              [[ 0.1276,  0.1874, -0.6334],</span>
<span class="sd">                               [-1.9682, -0.5340,  0.7483]]]),</span>
<span class="sd">               size=(5, 5, 2, 3), nnz=3, layout=torch.sparse_coo)</span>

<span class="sd">        # when sum over only part of sparse_dims, return a sparse tensor</span>
<span class="sd">        &gt;&gt;&gt; torch.sparse.sum(S, [1, 3])</span>
<span class="sd">        tensor(indices=tensor([[0, 2, 3]]),</span>
<span class="sd">               values=tensor([[-1.4512,  0.4073],</span>
<span class="sd">                              [-0.8901,  0.2017],</span>
<span class="sd">                              [-0.3183, -1.7539]]),</span>
<span class="sd">               size=(5, 2), nnz=3, layout=torch.sparse_coo)</span>

<span class="sd">        # when sum over all sparse dim, return a dense tensor</span>
<span class="sd">        # with summed dims squeezed</span>
<span class="sd">        &gt;&gt;&gt; torch.sparse.sum(S, [0, 1, 3])</span>
<span class="sd">        tensor([-2.6596, -1.1450])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">_sparse_sum</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">_sparse_sum</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">_sparse_sum</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">_sparse_sum</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span></div>


<span class="n">softmax</span> <span class="o">=</span> <span class="n">_add_docstr</span><span class="p">(</span><span class="n">_sparse</span><span class="o">.</span><span class="n">_sparse_softmax</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">sparse.softmax(input, dim, *, dtype=None) -&gt; Tensor</span>

<span class="s2">Applies a softmax function.</span>

<span class="s2">Softmax is defined as:</span>

<span class="s2">:math:`\text</span><span class="si">{Softmax}</span><span class="s2">(x_</span><span class="si">{i}</span><span class="s2">) = \frac{exp(x_i)}{\sum_j exp(x_j)}`</span>

<span class="s2">where :math:`i, j` run over sparse tensor indices and unspecified</span>
<span class="s2">entries are ignores. This is equivalent to defining unspecified</span>
<span class="s2">entries as negative infinity so that :math:`exp(x_k) = 0` when the</span>
<span class="s2">entry with index :math:`k` has not specified.</span>

<span class="s2">It is applied to all slices along `dim`, and will re-scale them so</span>
<span class="s2">that the elements lie in the range `[0, 1]` and sum to 1.</span>

<span class="s2">Args:</span>
<span class="s2">    input (Tensor): input</span>
<span class="s2">    dim (int): A dimension along which softmax will be computed.</span>
<span class="s2">    dtype (:class:`torch.dtype`, optional): the desired data type</span>
<span class="s2">        of returned tensor.  If specified, the input tensor is</span>
<span class="s2">        casted to :attr:`dtype` before the operation is</span>
<span class="s2">        performed. This is useful for preventing data type</span>
<span class="s2">        overflows. Default: None</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>


<span class="n">log_softmax</span> <span class="o">=</span> <span class="n">_add_docstr</span><span class="p">(</span><span class="n">_sparse</span><span class="o">.</span><span class="n">_sparse_log_softmax</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">sparse.log_softmax(input, dim, *, dtype=None) -&gt; Tensor</span>

<span class="s2">Applies a softmax function followed by logarithm.</span>

<span class="s2">See :class:`~torch.sparse.softmax` for more details.</span>

<span class="s2">Args:</span>
<span class="s2">    input (Tensor): input</span>
<span class="s2">    dim (int): A dimension along which softmax will be computed.</span>
<span class="s2">    dtype (:class:`torch.dtype`, optional): the desired data type</span>
<span class="s2">        of returned tensor.  If specified, the input tensor is</span>
<span class="s2">        casted to :attr:`dtype` before the operation is</span>
<span class="s2">        performed. This is useful for preventing data type</span>
<span class="s2">        overflows. Default: None</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>


<span class="n">spdiags</span> <span class="o">=</span> <span class="n">_add_docstr</span><span class="p">(</span>
    <span class="n">_sparse</span><span class="o">.</span><span class="n">_spdiags</span><span class="p">,</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">sparse.spdiags(diagonals, offsets, shape, layout=None) -&gt; Tensor</span>

<span class="sd">Creates a sparse 2D tensor by placing the values from rows of</span>
<span class="sd">:attr:`diagonals` along specified diagonals of the output</span>

<span class="sd">The :attr:`offsets` tensor controls which diagonals are set.</span>

<span class="sd">- If :attr:`offsets[i]` = 0, it is the main diagonal</span>
<span class="sd">- If :attr:`offsets[i]` &lt; 0, it is below the main diagonal</span>
<span class="sd">- If :attr:`offsets[i]` &gt; 0, it is above the main diagonal</span>

<span class="sd">The number of rows in :attr:`diagonals` must match the length of :attr:`offsets`,</span>
<span class="sd">and an offset may not be repeated.</span>

<span class="sd">Args:</span>
<span class="sd">    diagonals (Tensor): Matrix storing diagonals row-wise</span>
<span class="sd">    offsets (Tensor): The diagonals to be set, stored as a vector</span>
<span class="sd">    shape (2-tuple of ints): The desired shape of the result</span>
<span class="sd">Keyword args:</span>
<span class="sd">    layout (:class:`torch.layout`, optional): The desired layout of the</span>
<span class="sd">        returned tensor. ``torch.sparse_coo``, ``torch.sparse_csc`` and ``torch.sparse_csr``</span>
<span class="sd">        are supported. Default: ``torch.sparse_coo``</span>

<span class="sd">Examples:</span>

<span class="sd">Set the main and first two lower diagonals of a matrix::</span>

<span class="sd">    &gt;&gt;&gt; diags = torch.arange(9).reshape(3, 3)</span>
<span class="sd">    &gt;&gt;&gt; diags</span>
<span class="sd">    tensor([[0, 1, 2],</span>
<span class="sd">            [3, 4, 5],</span>
<span class="sd">            [6, 7, 8]])</span>
<span class="sd">    &gt;&gt;&gt; s = torch.sparse.spdiags(diags, torch.tensor([0, -1, -2]), (3, 3))</span>
<span class="sd">    &gt;&gt;&gt; s</span>
<span class="sd">    tensor(indices=tensor([[0, 1, 2, 1, 2, 2],</span>
<span class="sd">                           [0, 1, 2, 0, 1, 0]]),</span>
<span class="sd">           values=tensor([0, 1, 2, 3, 4, 6]),</span>
<span class="sd">           size=(3, 3), nnz=6, layout=torch.sparse_coo)</span>
<span class="sd">    &gt;&gt;&gt; s.to_dense()</span>
<span class="sd">    tensor([[0, 0, 0],</span>
<span class="sd">            [3, 1, 0],</span>
<span class="sd">            [6, 4, 2]])</span>


<span class="sd">Change the output layout::</span>

<span class="sd">    &gt;&gt;&gt; diags = torch.arange(9).reshape(3, 3)</span>
<span class="sd">    &gt;&gt;&gt; diags</span>
<span class="sd">    tensor([[0, 1, 2],[3, 4, 5], [6, 7, 8])</span>
<span class="sd">    &gt;&gt;&gt; s = torch.sparse.spdiags(diags, torch.tensor([0, -1, -2]), (3, 3), layout=torch.sparse_csr)</span>
<span class="sd">    &gt;&gt;&gt; s</span>
<span class="sd">    tensor(crow_indices=tensor([0, 1, 3, 6]),</span>
<span class="sd">           col_indices=tensor([0, 0, 1, 0, 1, 2]),</span>
<span class="sd">           values=tensor([0, 3, 1, 6, 4, 2]), size=(3, 3), nnz=6,</span>
<span class="sd">           layout=torch.sparse_csr)</span>
<span class="sd">    &gt;&gt;&gt; s.to_dense()</span>
<span class="sd">    tensor([[0, 0, 0],</span>
<span class="sd">            [3, 1, 0],</span>
<span class="sd">            [6, 4, 2]])</span>

<span class="sd">Set partial diagonals of a large output::</span>

<span class="sd">    &gt;&gt;&gt; diags = torch.tensor([[1, 2], [3, 4]])</span>
<span class="sd">    &gt;&gt;&gt; offsets = torch.tensor([0, -1])</span>
<span class="sd">    &gt;&gt;&gt; torch.sparse.spdiags(diags, offsets, (5, 5)).to_dense()</span>
<span class="sd">    tensor([[1, 0, 0, 0, 0],</span>
<span class="sd">            [3, 2, 0, 0, 0],</span>
<span class="sd">            [0, 4, 0, 0, 0],</span>
<span class="sd">            [0, 0, 0, 0, 0],</span>
<span class="sd">            [0, 0, 0, 0, 0]])</span>

<span class="sd">.. note::</span>

<span class="sd">    When setting the values along a given diagonal the index into the diagonal</span>
<span class="sd">    and the index into the row of :attr:`diagonals` is taken as the</span>
<span class="sd">    column index in the output. This has the effect that when setting a diagonal</span>
<span class="sd">    with a positive offset `k` the first value along that diagonal will be</span>
<span class="sd">    the value in position `k` of the row of :attr:`diagonals`</span>

<span class="sd">Specifying a positive offset::</span>

<span class="sd">    &gt;&gt;&gt; diags = torch.tensor([[1, 2, 3], [1, 2, 3], [1, 2, 3]])</span>
<span class="sd">    &gt;&gt;&gt; torch.sparse.spdiags(diags, torch.tensor([0, 1, 2]), (5, 5)).to_dense()</span>
<span class="sd">    tensor([[1, 2, 3, 0, 0],</span>
<span class="sd">            [0, 2, 3, 0, 0],</span>
<span class="sd">            [0, 0, 3, 0, 0],</span>
<span class="sd">            [0, 0, 0, 0, 0],</span>
<span class="sd">            [0, 0, 0, 0, 0]])</span>
<span class="sd">&quot;&quot;&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="check_sparse_tensor_invariants"><a class="viewcode-back" href="../../generated/torch.sparse.check_sparse_tensor_invariants.html#torch.sparse.check_sparse_tensor_invariants">[docs]</a><span class="k">class</span> <span class="nc">check_sparse_tensor_invariants</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A tool to control checking sparse tensor invariants.</span>

<span class="sd">The following options exists to manage sparsr tensor invariants</span>
<span class="sd">checking in sparse tensor construction:</span>

<span class="sd">1. Using a context manager:</span>

<span class="sd">   .. code:: python</span>

<span class="sd">       with torch.sparse.check_sparse_tensor_invariants():</span>
<span class="sd">           run_my_model()</span>

<span class="sd">2. Using a procedural approach:</span>

<span class="sd">   .. code:: python</span>

<span class="sd">       prev_checks_enabled = torch.sparse.check_sparse_tensor_invariants.is_enabled()</span>
<span class="sd">       torch.sparse.check_sparse_tensor_invariants.enable()</span>

<span class="sd">       run_my_model()</span>

<span class="sd">       if not prev_checks_enabled:</span>
<span class="sd">           torch.sparse.check_sparse_tensor_invariants.disable()</span>

<span class="sd">3. Using function decoration:</span>

<span class="sd">   .. code:: python</span>

<span class="sd">       @torch.sparse.check_sparse_tensor_invariants()</span>
<span class="sd">       def run_my_model():</span>
<span class="sd">           ...</span>

<span class="sd">       run_my_model()</span>

<span class="sd">4. Using ``check_invariants`` keyword argument in sparse tensor constructor call.</span>
<span class="sd">   For example:</span>

<span class="sd">   &gt;&gt;&gt; torch.sparse_csr_tensor([0, 1, 3], [0, 1], [1, 2], check_invariants=True)</span>
<span class="sd">   Traceback (most recent call last):</span>
<span class="sd">     File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</span>
<span class="sd">   RuntimeError: `crow_indices[..., -1] == nnz` is not satisfied.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="check_sparse_tensor_invariants.is_enabled"><a class="viewcode-back" href="../../generated/torch.sparse.check_sparse_tensor_invariants.html#torch.sparse.check_sparse_tensor_invariants.is_enabled">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">is_enabled</span><span class="p">():</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Returns True if the sparse tensor invariants checking is enabled.</span>

<span class="sd">.. note::</span>

<span class="sd">    Use :func:`torch.sparse.check_sparse_tensor_invariants.enable` or</span>
<span class="sd">    :func:`torch.sparse.check_sparse_tensor_invariants.disable` to</span>
<span class="sd">    manage the state of the sparse tensor invariants checks.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">_check_sparse_tensor_invariants</span><span class="p">()</span></div>

<div class="viewcode-block" id="check_sparse_tensor_invariants.enable"><a class="viewcode-back" href="../../generated/torch.sparse.check_sparse_tensor_invariants.html#torch.sparse.check_sparse_tensor_invariants.enable">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">enable</span><span class="p">():</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Enable sparse tensor invariants checking in sparse tensor constructors.</span>

<span class="sd">.. note::</span>

<span class="sd">    By default, the sparse tensor invariants checks are disabled. Use</span>
<span class="sd">    :func:`torch.sparse.check_sparse_tensor_invariants.is_enabled` to</span>
<span class="sd">    retrieve the current state of sparse tensor invariants checking.</span>

<span class="sd">.. note::</span>

<span class="sd">    The sparse tensor invariants check flag is effective to all sparse</span>
<span class="sd">    tensor constructors, both in Python and ATen.</span>

<span class="sd">    The flag can be locally overridden by the ``check_invariants``</span>
<span class="sd">    optional argument of the sparse tensor constructor functions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">_set_check_sparse_tensor_invariants</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="check_sparse_tensor_invariants.disable"><a class="viewcode-back" href="../../generated/torch.sparse.check_sparse_tensor_invariants.html#torch.sparse.check_sparse_tensor_invariants.disable">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">disable</span><span class="p">():</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Disable sparse tensor invariants checking in sparse tensor constructors.</span>

<span class="sd">See :func:`torch.sparse.check_sparse_tensor_invariants.enable` for more information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">_set_check_sparse_tensor_invariants</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span></div>

    <span class="c1"># context manager support</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enable</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">enable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved_state</span> <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;This context manager instance is already activated.&#39;</span>
                               <span class="s1">&#39; Use a different context manager instance for context nesting.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_enabled</span><span class="p">()</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">_set_check_sparse_tensor_invariants</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">_set_check_sparse_tensor_invariants</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved_state</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># decorator support</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mth</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">test_mth</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">mth</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">test_mth</span></div>


<div class="viewcode-block" id="as_sparse_gradcheck"><a class="viewcode-back" href="../../generated/torch.sparse.as_sparse_gradcheck.html#torch.sparse.as_sparse_gradcheck">[docs]</a><span class="k">def</span> <span class="nf">as_sparse_gradcheck</span><span class="p">(</span><span class="n">gradcheck</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator for torch.autograd.gradcheck or its functools.partial</span>
<span class="sd">    variants that extends the gradcheck function with support to input</span>
<span class="sd">    functions that operate on or/and return sparse tensors.</span>

<span class="sd">    The specified gradcheck function itself is guaranteed to operate</span>
<span class="sd">    on strided tensors only.</span>

<span class="sd">    For example:</span>

<span class="sd">    &gt;&gt;&gt; gradcheck = torch.sparse.as_sparse_gradcheck(torch.autograd.gradcheck)</span>
<span class="sd">    &gt;&gt;&gt; x = torch.tensor([[0, 1], [2, 3]], dtype=torch.float64).to_sparse_coo().requires_grad_(True)</span>
<span class="sd">    &gt;&gt;&gt; gradcheck(lambda x: x.to_sparse_csr(), x)</span>
<span class="sd">    True</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">gradcheck_with_sparse_support</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Same as :func:`torch.autograd.gradcheck` but with sparse tensors</span>
<span class="sd">        inputs and outputs support.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">masked</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;masked&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">sparse_layouts</span> <span class="o">=</span> <span class="p">{</span><span class="n">torch</span><span class="o">.</span><span class="n">sparse_coo</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">sparse_csr</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">sparse_csc</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">sparse_bsr</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">sparse_bsc</span><span class="p">}</span>
        <span class="n">sparse_compressed_layouts</span> <span class="o">=</span> <span class="p">{</span><span class="n">torch</span><span class="o">.</span><span class="n">sparse_csr</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">sparse_csc</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">sparse_bsr</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">sparse_bsc</span><span class="p">}</span>
        <span class="n">sparse_block_layouts</span> <span class="o">=</span> <span class="p">{</span><span class="n">torch</span><span class="o">.</span><span class="n">sparse_bsr</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">sparse_bsc</span><span class="p">}</span>
        <span class="n">STRIDED_REPRESENTATION</span> <span class="o">=</span> <span class="s1">&#39;__STRIDED_REPRESENTATION__&#39;</span>

        <span class="k">def</span> <span class="nf">convert_to_strided_representation</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Convert differentiable non-strided tensors to a representation</span>
<span class="sd">            containing differentiable strided tensors.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">,</span>
            <span class="n">new_args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">requires_grad</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">layout</span> <span class="ow">in</span> <span class="n">sparse_layouts</span><span class="p">:</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">layout</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">layout</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">masked</span><span class="p">:</span>
                        <span class="c1"># Materialize unspecified elements with zero values</span>
                        <span class="n">batch_dim</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">ndim</span> <span class="o">-</span> <span class="n">obj</span><span class="o">.</span><span class="n">dense_dim</span><span class="p">()</span> <span class="o">-</span> <span class="n">obj</span><span class="o">.</span><span class="n">sparse_dim</span><span class="p">()</span>
                        <span class="n">blocksize</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">values</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">batch_dim</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">batch_dim</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">layout</span> <span class="ow">in</span> <span class="n">sparse_block_layouts</span> <span class="k">else</span> <span class="kc">None</span>
                        <span class="n">full_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span><span class="o">.</span><span class="n">to_sparse</span><span class="p">(</span>
                            <span class="n">layout</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">layout</span><span class="p">,</span> <span class="n">blocksize</span><span class="o">=</span><span class="n">blocksize</span><span class="p">,</span> <span class="n">dense_dim</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">dense_dim</span><span class="p">())</span>
                        <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">to_dense</span><span class="p">()</span><span class="o">.</span><span class="n">sparse_mask</span><span class="p">(</span><span class="n">full_mask</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">layout</span> <span class="ow">is</span> <span class="n">torch</span><span class="o">.</span><span class="n">sparse_coo</span><span class="p">:</span>
                        <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">indices</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">_indices</span><span class="p">(),</span> <span class="n">is_coalesced</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">is_coalesced</span><span class="p">())</span>
                        <span class="n">values</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_values</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="n">obj</span><span class="o">.</span><span class="n">layout</span> <span class="ow">in</span> <span class="p">{</span><span class="n">torch</span><span class="o">.</span><span class="n">sparse_csr</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">sparse_bsr</span><span class="p">}:</span>
                        <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">compressed_indices</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">crow_indices</span><span class="p">(),</span> <span class="n">plain_indices</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">col_indices</span><span class="p">())</span>
                        <span class="n">values</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">compressed_indices</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">ccol_indices</span><span class="p">(),</span> <span class="n">plain_indices</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">row_indices</span><span class="p">())</span>
                        <span class="n">values</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                    <span class="n">new_args</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="n">STRIDED_REPRESENTATION</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">values</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">new_args</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">restore_from_strided_representation</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Restore non-strided differentiable tensosr from their strided</span>
<span class="sd">            representations.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">new_args</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">args</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">STRIDED_REPRESENTATION</span><span class="p">:</span>
                    <span class="n">d</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;layout&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="n">torch</span><span class="o">.</span><span class="n">sparse_coo</span><span class="p">:</span>
                        <span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sparse_coo_tensor</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">],</span> <span class="n">values</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">],</span> <span class="n">is_coalesced</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;is_coalesced&#39;</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;layout&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">sparse_compressed_layouts</span><span class="p">:</span>
                        <span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sparse_compressed_tensor</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;compressed_indices&#39;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;plain_indices&#39;</span><span class="p">],</span> <span class="n">values</span><span class="p">,</span>
                                                           <span class="n">size</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">],</span> <span class="n">layout</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;layout&#39;</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;conversion of </span><span class="si">{</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;layout&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> strided representation to tensor&#39;</span><span class="p">)</span>
                <span class="n">new_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">new_args</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">func_wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">restored_args</span> <span class="o">=</span> <span class="n">restore_from_strided_representation</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

            <span class="c1"># convert differentiable output sparse tensors to strided</span>
            <span class="c1"># tensors:</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">restored_args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="n">strided_outputs</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="k">else</span> <span class="p">(</span><span class="n">outputs</span><span class="p">,)</span>
            <span class="n">strided_outputs</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="n">o</span><span class="o">.</span><span class="n">to_dense</span><span class="p">(</span><span class="n">masked_grad</span><span class="o">=</span><span class="n">masked</span><span class="p">)</span>
                                     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="ow">and</span> <span class="n">o</span><span class="o">.</span><span class="n">requires_grad</span> <span class="ow">and</span> <span class="n">o</span><span class="o">.</span><span class="n">layout</span> <span class="ow">in</span> <span class="n">sparse_layouts</span> <span class="k">else</span> <span class="n">o</span><span class="p">)</span>
                                    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">strided_outputs</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">strided_outputs</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="k">else</span> <span class="n">strided_outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">func_wrapper</span><span class="p">,</span> <span class="n">convert_to_strided_representation</span><span class="p">(</span><span class="n">inputs</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">gradcheck</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">gradcheck_with_sparse_support</span></div>
</pre></div>

             </article>
             
            </div>
            <footer>
  

  

    <hr>

  

  <div role="contentinfo">
    <p>
        &copy; Copyright 2023, PyTorch Contributors.

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>
     

</footer>

          </div>
<script>

var match = window.location.href.match(/\/_[a-zA-Z0-9_]*.html|_dynamo/gi);
var url = window.location.href.lastIndexOf(match[match.length-1]);

if (url)
  {
    var div = '<div class="admonition note"><p class="admonition-title">Note</p><p><i class="fa fa-exclamation-circle" aria-hidden="true">&nbsp</i> This page describes an internal API which is not intended to be used outside of the PyTorch codebase and can be modified or removed without notice.</p></div>'
    document.getElementById("pytorch-article").insertAdjacentHTML('afterBegin', div)
  }
</script>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              
            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
         <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
         <script src="../../_static/jquery.js"></script>
         <script src="../../_static/underscore.js"></script>
         <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
         <script src="../../_static/doctools.js"></script>
         <script src="../../_static/sphinx_highlight.js"></script>
         <script src="../../_static/clipboard.min.js"></script>
         <script src="../../_static/copybutton.js"></script>
     

  

  <script type="text/javascript" src="../../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../../_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 
<script script type="text/javascript">
  var collapsedSections = ['Developer Notes', 'Language Bindings', 'Libraries', 'Community'];
</script>

<img height="1" width="1" style="border-style:none;" alt="" src="https://www.googleadservices.com/pagead/conversion/795629140/?label=txkmCPmdtosBENSssfsC&amp;guid=ON&amp;script=0"/>


  <!-- Begin Footer -->

  <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
    <div class="container">
      <div class="row">
        <div class="col-md-4 text-center">
          <h2>Docs</h2>
          <p>Access comprehensive developer documentation for PyTorch</p>
          <a class="with-right-arrow" href="https://pytorch.org/docs/stable/index.html">View Docs</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Tutorials</h2>
          <p>Get in-depth tutorials for beginners and advanced developers</p>
          <a class="with-right-arrow" href="https://pytorch.org/tutorials">View Tutorials</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Resources</h2>
          <p>Find development resources and get your questions answered</p>
          <a class="with-right-arrow" href="https://pytorch.org/resources">View Resources</a>
        </div>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container footer-container">
      <div class="footer-logo-wrapper">
        <a href="https://pytorch.org/" class="footer-logo"></a>
      </div>

      <div class="footer-links-wrapper">
        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/">PyTorch</a></li>
            <li><a href="https://pytorch.org/get-started">Get Started</a></li>
            <li><a href="https://pytorch.org/features">Features</a></li>
            <li><a href="https://pytorch.org/ecosystem">Ecosystem</a></li>
            <li><a href="https://pytorch.org/blog/">Blog</a></li>
            <li><a href="https://github.com/pytorch/pytorch/blob/master/CONTRIBUTING.md">Contributing</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/resources">Resources</a></li>
            <li><a href="https://pytorch.org/tutorials">Tutorials</a></li>
            <li><a href="https://pytorch.org/docs/stable/index.html">Docs</a></li>
            <li><a href="https://discuss.pytorch.org" target="_blank">Discuss</a></li>
            <li><a href="https://github.com/pytorch/pytorch/issues" target="_blank">Github Issues</a></li>
            <li><a href="https://pytorch.org/assets/brand-guidelines/PyTorch-Brand-Guidelines.pdf" target="_blank">Brand Guidelines</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title">Stay up to date</li>
            <li><a href="https://www.facebook.com/pytorch" target="_blank">Facebook</a></li>
            <li><a href="https://twitter.com/pytorch" target="_blank">Twitter</a></li>
            <li><a href="https://www.youtube.com/pytorch" target="_blank">YouTube</a></li>
            <li><a href="https://www.linkedin.com/company/pytorch" target="_blank">LinkedIn</a></li>
          </ul>  
          </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title">PyTorch Podcasts</li>
            <li><a href="https://open.spotify.com/show/6UzHKeiy368jKfQMKKvJY5" target="_blank">Spotify</a></li>
            <li><a href="https://podcasts.apple.com/us/podcast/pytorch-developer-podcast/id1566080008" target="_blank">Apple</a></li>
            <li><a href="https://www.google.com/podcasts?feed=aHR0cHM6Ly9mZWVkcy5zaW1wbGVjYXN0LmNvbS9PQjVGa0lsOA%3D%3D" target="_blank">Google</a></li>
            <li><a href="https://music.amazon.com/podcasts/7a4e6f0e-26c2-49e9-a478-41bd244197d0/PyTorch-Developer-Podcast?" target="_blank">Amazon</a></li>
          </ul>
         </div>
        </div>
        
        <div class="privacy-policy">
          <ul>
            <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/terms/" target="_blank">Terms</a></li>
            <li class="privacy-policy-links">|</li>
            <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/privacy-policy/" target="_blank">Privacy</a></li>
          </ul>
        </div>
        <div class="copyright">
        <p>Â© Copyright The Linux Foundation. The PyTorch Foundation is a project of The Linux Foundation.
          For web site terms of use, trademark policy and other policies applicable to The PyTorch Foundation please see
          <a href="www.linuxfoundation.org/policies/">www.linuxfoundation.org/policies/</a>. The PyTorch Foundation supports the PyTorch open source
          project, which has been established as PyTorch Project a Series of LF Projects, LLC. For policies applicable to the PyTorch Project a Series of LF Projects, LLC,
          please see <a href="www.lfprojects.org/policies/">www.lfprojects.org/policies/</a>.</p>
      </div>
     </div>

  </footer>

  <div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebookâ€™s Cookies Policy applies. Learn more, including about available controls: <a href="https://www.facebook.com/policies/cookies/">Cookies Policy</a>.</p>
    <img class="close-button" src="../../_static/images/pytorch-x.svg">
  </div>
</div>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>
            
          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li class="resources-mobile-menu-title" class="active">
            Docs
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/docs/stable/index.html">PyTorch</a>
            </li>

            <li>
              <a href="https://pytorch.org/audio/stable/index.html">torchaudio</a>
            </li>

            <li>
              <a href="https://pytorch.org/text/stable/index.html">torchtext</a>
            </li>

            <li>
              <a href="https://pytorch.org/vision/stable/index.html">torchvision</a>
            </li>

            <li>
              <a href="https://pytorch.org/torcharrow">torcharrow</a>
            </li>

            <li>
              <a href="https://pytorch.org/data">TorchData</a>
            </li>

            <li>
              <a href="https://pytorch.org/torchrec">TorchRec</a>
            </li>

            <li>
              <a href="https://pytorch.org/serve/">TorchServe</a>
            </li>

            <li>
              <a href="https://pytorch.org/torchx/">TorchX</a>
            </li>

            <li>
              <a href="https://pytorch.org/xla">PyTorch on XLA Devices</a>
            </li>
          </ul>

          <li class="resources-mobile-menu-title">
            Resources
          </li>
            
           <ul class="resources-mobile-menu-items">

            <li>
              <a href="https://pytorch.org/features">About</a>
            </li>

            <li>
              <a href="https://pytorch.org/foundation">PyTorch Foundation</a>
            </li>

            <li>
              <a href="https://pytorch.org/#community-module">Community</a>
            </li>

            <li>
              <a href="https://pytorch.org/community-stories">Community Stories</a>
            </li>

            <li>
              <a href="https://pytorch.org/resources">Developer Resources</a>
            </li>

            <li>
              <a href="https://pytorch.org/events">Events</a>
            </li>

            <li>
              <a href="https://discuss.pytorch.org/">Forums</a>
            </li>

            <li>
              <a href="https://pytorch.org/hub">Models (Beta)</a>
            </li>
          </ul>

          <li>
            <a href="https://github.com/pytorch/pytorch">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="../../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>