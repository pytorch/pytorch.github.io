


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta name="robots" content="noindex">
  <meta name="robots" content="noindex">
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>torch.distributed.elastic.rendezvous.etcd_rendezvous &mdash; PyTorch 1.11.0 documentation</title>
  

  
  
  
  
    <link rel="canonical" href="https://pytorch.org/docs/stable/_modules/torch/distributed/elastic/rendezvous/etcd_rendezvous.html"/>
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="../../../../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.css" type="text/css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/katex-math.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/css/jit.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" />


  <!-- Google Analytics -->
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-117752657-2"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-117752657-2');
    </script>
  
  <!-- End Google Analytics -->
  


  
  <script src="../../../../../_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../../../../../_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../../_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../../_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../../_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>

          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li class="active docs-active">
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-orange-arrow">
                Docs
              </a>
              <div class="resources-dropdown-menu">
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/docs/stable/index.html">
                  <span class="dropdown-title">PyTorch</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/audio/stable/index.html">
                  <span class="dropdown-title">torchaudio</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/text/stable/index.html">
                  <span class="dropdown-title">torchtext</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/vision/stable/index.html">
                  <span class="dropdown-title">torchvision</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torchrec">
                  <span class="dropdown-title">TorchRec</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/data">
                  <span class="dropdown-title">TorchData</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/serve/">
                  <span class="dropdown-title">TorchServe</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/xla">
                  <span class="dropdown-title">PyTorch on XLA Devices</span>
                  <p></p>
                </a>
            </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-arrow">
                Resources
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/features">
                  <span class="dropdown-title">About</span>
                  <p>Learn about PyTorch’s features and capabilities</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/#community-module">
                  <span class="dropdown-title">Community</span>
                  <p>Join the PyTorch developer community to contribute, learn, and get your questions answered.</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/resources">
                  <span class="dropdown-title">Developer Resources</span>
                  <p>Find resources and get questions answered</p>
                </a>
                <a class="nav-dropdown-item" href="https://discuss.pytorch.org/" target="_blank">
                  <span class="dropdown-title">Forums</span>
                  <p>A place to discuss PyTorch code, issues, install, research</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/hub">
                  <span class="dropdown-title">Models (Beta)</span>
                  <p>Discover, publish, and reuse pre-trained models</p>
                </a>
              </div>
            </div>
          </li>

          <li>
            <a href="https://github.com/pytorch/pytorch">GitHub</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>

<body class="pytorch-body">

   

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            
    <div class="version">
      <a href='https://pytorch.org/docs/versions.html'>1.11.0 &#x25BC</a>
    </div>
    


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          </div>

          


            
            
              
            
            
              <p class="caption"><span class="caption-text">Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../notes/amp_examples.html">Automatic Mixed Precision examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../notes/autograd.html">Autograd mechanics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../notes/broadcasting.html">Broadcasting semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../notes/cpu_threading_torchscript_inference.html">CPU threading and TorchScript inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../notes/cuda.html">CUDA semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../notes/ddp.html">Distributed Data Parallel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../notes/extending.html">Extending PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../notes/faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../notes/gradcheck.html">Gradcheck mechanics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../notes/hip.html">HIP (ROCm) semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../notes/large_scale_deployments.html">Features for large-scale deployments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../notes/modules.html">Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../notes/multiprocessing.html">Multiprocessing best practices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../notes/numerical_accuracy.html">Numerical accuracy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../notes/randomness.html">Reproducibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../notes/serialization.html">Serialization semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../notes/windows.html">Windows FAQ</a></li>
</ul>
<p class="caption"><span class="caption-text">Language Bindings</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../cpp_index.html">C++</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/javadoc/">Javadoc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../deploy.html">torch::deploy</a></li>
</ul>
<p class="caption"><span class="caption-text">Python API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../torch.html">torch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../nn.html">torch.nn</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../nn.functional.html">torch.nn.functional</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tensors.html">torch.Tensor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tensor_attributes.html">Tensor Attributes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tensor_view.html">Tensor Views</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../autograd.html">torch.autograd</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../cuda.html">torch.cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../amp.html">torch.cuda.amp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../backends.html">torch.backends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../distributed.html">torch.distributed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../distributed.algorithms.join.html">torch.distributed.algorithms.join</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../distributed.elastic.html">torch.distributed.elastic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../fsdp.html">torch.distributed.fsdp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../distributed.optim.html">torch.distributed.optim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../distributions.html">torch.distributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../fft.html">torch.fft</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../futures.html">torch.futures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../fx.html">torch.fx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../hub.html">torch.hub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../jit.html">torch.jit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../linalg.html">torch.linalg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../monitor.html">torch.monitor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../special.html">torch.special</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../torch.overrides.html">torch.overrides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../package.html">torch.package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../profiler.html">torch.profiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../nn.init.html">torch.nn.init</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../onnx.html">torch.onnx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../optim.html">torch.optim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../complex_numbers.html">Complex Numbers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ddp_comm_hooks.html">DDP Communication Hooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pipeline.html">Pipeline Parallelism</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../quantization.html">Quantization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../rpc.html">Distributed RPC Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../random.html">torch.random</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../sparse.html">torch.sparse</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../storage.html">torch.Storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../testing.html">torch.testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../benchmark_utils.html">torch.utils.benchmark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../bottleneck.html">torch.utils.bottleneck</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../checkpoint.html">torch.utils.checkpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../cpp_extension.html">torch.utils.cpp_extension</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../data.html">torch.utils.data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../dlpack.html">torch.utils.dlpack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../mobile_optimizer.html">torch.utils.mobile_optimizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../model_zoo.html">torch.utils.model_zoo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tensorboard.html">torch.utils.tensorboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../type_info.html">Type Info</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../named_tensor.html">Named Tensors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../name_inference.html">Named Tensors operator coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../__config__.html">torch.__config__</a></li>
</ul>
<p class="caption"><span class="caption-text">Libraries</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/audio/stable">torchaudio</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/text/stable">torchtext</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/vision/stable">torchvision</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/serve">TorchServe</a></li>
<li class="toctree-l1"><a class="reference external" href="http://pytorch.org/xla/">PyTorch on XLA Devices</a></li>
</ul>
<p class="caption"><span class="caption-text">Community</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../community/contribution_guide.html">PyTorch Contribution Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../community/governance.html">PyTorch Governance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../community/persons_of_interest.html">PyTorch Governance | Persons of Interest</a></li>
</ul>

            
          

        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="../../../../../index.html">
          
            Docs
          
        </a> &gt;
      </li>

        
          <li><a href="../../../../index.html">Module code</a> &gt;</li>
        
          <li><a href="../../../../torch.html">torch</a> &gt;</li>
        
          <li><a href="../../../distributed.html">torch.distributed</a> &gt;</li>
        
      <li>torch.distributed.elastic.rendezvous.etcd_rendezvous</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">

        
          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <h1>Source code for torch.distributed.elastic.rendezvous.etcd_rendezvous</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>

<span class="c1"># Copyright (c) Facebook, Inc. and its affiliates.</span>
<span class="c1"># All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># This source code is licensed under the BSD-style license found in the</span>
<span class="c1"># LICENSE file in the root directory of this source tree.</span>

<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>

<span class="kn">import</span> <span class="nn">etcd</span>  <span class="c1"># type: ignore[import]</span>
<span class="kn">from</span> <span class="nn">torch.distributed.elastic.rendezvous</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">RendezvousClosedError</span><span class="p">,</span>
    <span class="n">RendezvousError</span><span class="p">,</span>
    <span class="n">RendezvousHandler</span><span class="p">,</span>
    <span class="n">RendezvousParameters</span><span class="p">,</span>
    <span class="n">RendezvousTimeoutError</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">parse_rendezvous_endpoint</span>
<span class="kn">from</span> <span class="nn">.etcd_store</span> <span class="kn">import</span> <span class="n">EtcdStore</span><span class="p">,</span> <span class="n">cas_delay</span>


<span class="n">_log_fmt</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%(levelname)s</span><span class="s2"> </span><span class="si">%(asctime)s</span><span class="s2"> </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">_log_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
<span class="n">_log_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">_log_fmt</span><span class="p">)</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">log</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">_log_handler</span><span class="p">)</span>


<span class="c1"># Retryable failure exception means the we were too late to make</span>
<span class="c1"># a desired state transition (e.g. because of a race condition),</span>
<span class="c1"># and should now restart from the beginning.</span>
<span class="c1"># A small delay is recommended to avoid spamming Etcd.</span>
<span class="k">class</span> <span class="nc">EtcdRendezvousRetryableFailure</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="c1"># Similar to retryable failure, but the new state we observed suggests we</span>
<span class="c1"># can re-try immediately, i.e. without a need for &quot;safety delay&quot;.</span>
<span class="k">class</span> <span class="nc">EtcdRendezvousRetryImmediately</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="c1"># Default timeout for the rendezvous.</span>
<span class="n">_DEFAULT_TIMEOUT</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">600</span>  <span class="c1"># 10 minutes</span>

<span class="c1"># Additional waiting time after reaching the minimum number of nodes</span>
<span class="c1"># in case the rendezvous is elastic (min != max).</span>
<span class="n">_DEFAULT_LAST_CALL_TIMEOUT</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span>  <span class="c1"># 30 seconds</span>

<span class="c1"># Various constants used internally in EtcdRendezvous</span>
<span class="n">CONST_ETCD_SETUP_TTL</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">CONST_ETCD_FROZEN_TTL</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">CONST_ETCD_JOINABLE_EPHEMERAL_TTL</span> <span class="o">=</span> <span class="mi">10</span>

<span class="c1"># Ephemeral node TTL for worker&#39;s keep-alive key:</span>
<span class="n">CONST_WORKER_KEEPALIVE_TTL</span> <span class="o">=</span> <span class="mi">10</span>

<span class="c1"># TTL for the ephemeral run_id-specific directory. All rendezvous state data</span>
<span class="c1"># for a specific run_id (job instance) is contained within directory.</span>
<span class="c1"># Its only role is to clean-up rendezvous data from old runs (for the case when</span>
<span class="c1"># etcd server is persistent), and has no affect on correctnes, but should be</span>
<span class="c1"># larger than any timeouts that a worker process is expected to survive:</span>
<span class="n">CONST_RUNID_SUBROOT_TTL</span> <span class="o">=</span> <span class="mi">7200</span>  <span class="c1"># 2 hours</span>


<div class="viewcode-block" id="EtcdRendezvousHandler"><a class="viewcode-back" href="../../../../../elastic/rendezvous.html#torch.distributed.elastic.rendezvous.etcd_rendezvous.EtcdRendezvousHandler">[docs]</a><span class="k">class</span> <span class="nc">EtcdRendezvousHandler</span><span class="p">(</span><span class="n">RendezvousHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implements a</span>
<span class="sd">    :py:class:`torch.distributed.elastic.rendezvous.RendezvousHandler` interface</span>
<span class="sd">    backed by</span>
<span class="sd">    :py:class:`torch.distributed.elastic.rendezvous.etcd_rendezvous.EtcdRendezvous`.</span>
<span class="sd">    ``EtcdRendezvousHandler`` uses a URL to configure the type of rendezvous to</span>
<span class="sd">    use and to pass implementation specific configurations to the rendezvous</span>
<span class="sd">    module. The basic etcd rendezvous configuration URL looks like the following</span>
<span class="sd">    ::</span>

<span class="sd">     etcd://&lt;etcd_address&gt;:&lt;port&gt;/&lt;job_id&gt;?min_workers=&lt;min_workers&gt;&amp;max_workers=&lt;max_workers&gt;  # noqa: W605</span>

<span class="sd">     -- example --</span>

<span class="sd">     etcd://localhost:2379/1234?min_workers=1&amp;max_workers=3</span>

<span class="sd">    The URL above is interpreted as follows:</span>

<span class="sd">    1. Use the rendezvous handler that is registered with the ``etcd``</span>
<span class="sd">       scheme</span>
<span class="sd">    2. The ``etcd`` endpoint to use is ``localhost:2379``</span>
<span class="sd">    3. ``job_id == 1234`` is used as the prefix in etcd (this allows one to</span>
<span class="sd">       share a common etcd server for multiple jobs so long as the</span>
<span class="sd">       ``job_ids`` are guaranteed to be unique). Note that the job id can be</span>
<span class="sd">       any string (e.g. does not need to be a number) as long as it is</span>
<span class="sd">       unique.</span>
<span class="sd">    4. ``min_workers=1`` and ``max_workers=3`` specifies a range for</span>
<span class="sd">       membership size - Torch Distributed Elastic starts running the job as</span>
<span class="sd">       long as the cluster size is greater than or equal to ``min_workers``</span>
<span class="sd">       and admits up to ``max_workers`` into the cluster.</span>

<span class="sd">    Below are a full list of the parameters that can be passed to etcd</span>
<span class="sd">    rendezvous:</span>

<span class="sd">    +--------------------------------------------+--------------------------+</span>
<span class="sd">    | Parameter                                  | Description              |</span>
<span class="sd">    +============================================+==========================+</span>
<span class="sd">    | min_workers                                | minimum number of        |</span>
<span class="sd">    |                                            | workers for the          |</span>
<span class="sd">    |                                            | rendezvous to be valid   |</span>
<span class="sd">    +--------------------------------------------+--------------------------+</span>
<span class="sd">    | max_workers                                | maximum number of        |</span>
<span class="sd">    |                                            | workers to admit         |</span>
<span class="sd">    +--------------------------------------------+--------------------------+</span>
<span class="sd">    | timeout                                    | total timeout within     |</span>
<span class="sd">    |                                            | which next_rendezvous is |</span>
<span class="sd">    |                                            | expected to succeed      |</span>
<span class="sd">    |                                            | (default 600s)           |</span>
<span class="sd">    +--------------------------------------------+--------------------------+</span>
<span class="sd">    | last_call_timeout                          | additional wait amount   |</span>
<span class="sd">    |                                            | (“last call”) after min  |</span>
<span class="sd">    |                                            | number of workers has    |</span>
<span class="sd">    |                                            | been reached (defaults   |</span>
<span class="sd">    |                                            | to 30s)                  |</span>
<span class="sd">    +--------------------------------------------+--------------------------+</span>
<span class="sd">    | etcd_prefix                                | path prefix (from etcd   |</span>
<span class="sd">    |                                            | root), inside which all  |</span>
<span class="sd">    |                                            | etcd nodes will be       |</span>
<span class="sd">    |                                            | created (defaults to     |</span>
<span class="sd">    |                                            | ``/torchelastic/p2p``)   |</span>
<span class="sd">    +--------------------------------------------+--------------------------+</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rdzv_impl</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rdzv_impl</span> <span class="o">=</span> <span class="n">rdzv_impl</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: look into using weakref here instead.</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdzv_impl</span>

    <span class="k">def</span> <span class="nf">get_backend</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;etcd&quot;</span>

    <span class="k">def</span> <span class="nf">next_rendezvous</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rdzv_version</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">world_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdzv_impl</span><span class="o">.</span><span class="n">rendezvous_barrier</span><span class="p">()</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating EtcdStore as the c10d::Store implementation&quot;</span><span class="p">)</span>
        <span class="n">store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdzv_impl</span><span class="o">.</span><span class="n">setup_kv_store</span><span class="p">(</span><span class="n">rdzv_version</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">store</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">world_size</span>

    <span class="k">def</span> <span class="nf">is_closed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdzv_impl</span><span class="o">.</span><span class="n">get_rdzv_state</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;closed&quot;</span>
        <span class="k">except</span> <span class="n">etcd</span><span class="o">.</span><span class="n">EtcdKeyNotFound</span><span class="p">:</span>
            <span class="c1"># No rendezvous state, so it cannot be closed.</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">set_closed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rdzv_impl</span><span class="o">.</span><span class="n">set_closed</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">num_nodes_waiting</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdzv_impl</span><span class="o">.</span><span class="n">get_rdzv_state</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;final&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;num_workers_waiting&quot;</span><span class="p">]</span>
        <span class="k">except</span> <span class="n">etcd</span><span class="o">.</span><span class="n">EtcdKeyNotFound</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">get_run_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdzv_impl</span><span class="o">.</span><span class="n">_run_id</span>

    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_closed</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shutdown failed. Error occurred: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<span class="c1"># TODO: we should probably handle a few additional errors,</span>
<span class="c1"># like EtcdLeaderElectionInProgress and EtcdWatcherCleared. These are</span>
<span class="c1"># only relevant for multi-node Etcd ensemble. A simple retry would work,</span>
<span class="c1"># but is verbose to add everywhere. Consider wrapping the client calls</span>
<span class="c1"># into auto-retry for these errors?</span>
<span class="c1">#</span>
<span class="k">class</span> <span class="nc">EtcdRendezvous</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A rendezvous implementation that uses `etcd &lt;https://etcd.io/&gt;`__ as</span>
<span class="sd">    the backend store.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">client</span><span class="p">,</span>
        <span class="n">prefix</span><span class="p">,</span>
        <span class="n">run_id</span><span class="p">,</span>
        <span class="n">num_min_workers</span><span class="p">,</span>
        <span class="n">num_max_workers</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">,</span>
        <span class="n">last_call_timeout</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Etcd machines: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">machines</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span> <span class="o">=</span> <span class="n">prefix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_id</span> <span class="o">=</span> <span class="n">run_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_min_workers</span> <span class="o">=</span> <span class="n">num_min_workers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_max_workers</span> <span class="o">=</span> <span class="n">num_max_workers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_call_timeout</span> <span class="o">=</span> <span class="n">last_call_timeout</span>

        <span class="c1"># For cleaning up TTL refresher threads (for ephemeral keys)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lease_run_id_stop</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lease_this_rank_stop</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span> <span class="o">+=</span> <span class="s2">&quot;/&quot;</span>

        <span class="c1"># Setup a permanent prefix dir, if didn&#39;t exist</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span> <span class="o">!=</span> <span class="s2">&quot;/&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_path_if_not_exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span><span class="p">)</span>

        <span class="c1"># Lease a &quot;sub-root&quot; node specific to this job instance (run_id)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_path_if_not_exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="n">ttl</span><span class="o">=</span><span class="n">CONST_RUNID_SUBROOT_TTL</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lease_run_id_stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_lease_renewal</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="n">ttl</span><span class="o">=</span><span class="n">CONST_RUNID_SUBROOT_TTL</span>
        <span class="p">)</span>

        <span class="c1"># Subdir for all rendezvous work</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_path_if_not_exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s2">&quot;/rdzv&quot;</span><span class="p">))</span>

        <span class="c1"># Create a rendezvous version counter, if doesn&#39;t exist</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s2">&quot;/rdzv/version_counter&quot;</span><span class="p">),</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="n">prevExist</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">etcd</span><span class="o">.</span><span class="n">EtcdAlreadyExist</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: look into using weakref here instead.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lease_run_id_stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lease_run_id_stop</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lease_this_rank_stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lease_this_rank_stop</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">rendezvous_barrier</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Main entry point for next rendezvous.</span>
<span class="sd">        This method is blocking until rendezvous succeeds or a timeout occurs.</span>

<span class="sd">        Returns:</span>
<span class="sd">             ``(rdzv_version, rank, world_size)``</span>

<span class="sd">        Raises:</span>
<span class="sd">            RendezvousTimeoutError - timeout waiting for rendezvous</span>
<span class="sd">            RendezvousClosedError - rendezvous is or was closed while waiting</span>
<span class="sd">            RendezvousError - other persistent errors that</span>
<span class="sd">             render the rendezvous non-retryable</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rendezvous_deadline</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rendezvous_deadline</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">RendezvousTimeoutError</span><span class="p">()</span>

            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Attempting to join next rendezvous&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Dis-own our lease in the previous rendezvous, if exists</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lease_this_rank_stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_lease_this_rank_stop</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_phase</span><span class="p">()</span>

            <span class="k">except</span> <span class="n">EtcdRendezvousRetryImmediately</span><span class="p">:</span>
                <span class="c1"># The type of failure suggests we can retry without delay</span>
                <span class="k">pass</span>

            <span class="k">except</span> <span class="n">EtcdRendezvousRetryableFailure</span><span class="p">:</span>
                <span class="c1"># In case of retryable failure, wait a small delay</span>
                <span class="c1"># to avoid spamming etcd</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">except</span> <span class="n">RendezvousTimeoutError</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rendezvous timeout occured in EtcdRendezvousHandler&quot;</span><span class="p">)</span>
                <span class="k">raise</span>

            <span class="k">except</span> <span class="n">RendezvousClosedError</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Rendezvous for run_id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_id</span><span class="si">}</span><span class="s2"> was observed to be closed&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span>

            <span class="k">except</span> <span class="n">RendezvousError</span><span class="p">:</span>
                <span class="k">raise</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># In case of a general exception, wait a small delay</span>
                <span class="c1"># to avoid spamming etcd</span>
                <span class="c1"># FIXME: there are a few things that fall under this like</span>
                <span class="c1"># etcd.EtcdKeyNotFound, etc, which could be handled more explicitly.</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rendezvous attempt failed, will retry. Reason: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">init_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initially, the rendezvous state is expected to be one of:</span>

<span class="sd">        1. empty (non-existent) - in this case we try to create a new one.</span>
<span class="sd">        2. joinable - we try to join it.</span>
<span class="sd">        3. final - we announce ourselves as waiting, and go into monitoring mode</span>

<span class="sd">        Any other state is considered transitional, and will be retried after</span>
<span class="sd">        a short delay.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ``(rdzv_version, rank, world_size)``</span>

<span class="sd">        Raises:</span>
<span class="sd">            RendezvousClosedError - current rendezvous was/is closed</span>
<span class="sd">            EtcdRendezvousRetryableFailure - observed some intermediate</span>
<span class="sd">             state, which is best handled by retrying later</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">active_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">try_create_rendezvous</span><span class="p">()</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">active_version</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;New rendezvous state created: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">etcd</span><span class="o">.</span><span class="n">EtcdAlreadyExist</span><span class="p">:</span>
            <span class="n">active_version</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rdzv_state</span><span class="p">()</span>
            <span class="c1"># Note: it is possible for above query to fail (etcd.EtcdKeyNotFound),</span>
            <span class="c1"># but this is ok for us - just means we&#39;ll restart from beginning.</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Observed existing rendezvous state: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;closed&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RendezvousClosedError</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;joinable&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">join_phase</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;final&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handle_existing_rendezvous</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">])</span>
            <span class="k">raise</span> <span class="n">EtcdRendezvousRetryImmediately</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">try_wait_for_state_change</span><span class="p">(</span><span class="n">etcd_index</span><span class="o">=</span><span class="n">active_version</span><span class="o">.</span><span class="n">etcd_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">EtcdRendezvousRetryableFailure</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">join_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expected_version</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        We observed a rendezvous state in &#39;joinable&#39; state, and attempt to join this</span>
<span class="sd">        particular version, and then wait for all other peers to join.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Failure to join will propagate an exception, causing a re-entry.</span>
        <span class="n">active_version</span><span class="p">,</span> <span class="n">this_rank</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">join_rendezvous</span><span class="p">(</span><span class="n">expected_version</span><span class="p">)</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">active_version</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Joined rendezvous version </span><span class="si">{}</span><span class="s2"> as rank </span><span class="si">{}</span><span class="s2">. Full state: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">state</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">],</span> <span class="n">this_rank</span><span class="p">,</span> <span class="n">state</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># If this worker was first to reach num_min_workers requirement,</span>
        <span class="c1"># and rendezvous is still joinable (therefore it is elastic),</span>
        <span class="c1"># then this worker will be repsonsible for waiting out the &quot;last call&quot;</span>
        <span class="c1"># timeout and closing (i.e. transitioning to &#39;frozen&#39;) the rendezvous</span>
        <span class="c1"># afterwards.</span>
        <span class="c1"># As a safety against a potential failure of this worker (during the</span>
        <span class="c1"># last call timeout), the rendezvous state is made ephemeral</span>
        <span class="c1"># when min_num_workers is reached.</span>

        <span class="k">if</span> <span class="n">this_rank</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_min_workers</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;joinable&quot;</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rank </span><span class="si">{}</span><span class="s2"> is responsible for join last call.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">this_rank</span><span class="p">))</span>
            <span class="n">last_call_deadline</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_call_timeout</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handle_join_last_call</span><span class="p">(</span><span class="n">expected_version</span><span class="p">,</span> <span class="n">last_call_deadline</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rank </span><span class="si">{}</span><span class="s2"> finished join last call.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">this_rank</span><span class="p">))</span>

        <span class="c1"># Wait for rendezvous state to be frozen, which means a fixed set of peers</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Waiting for remaining peers.&quot;</span><span class="p">)</span>
        <span class="n">active_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_peers</span><span class="p">(</span><span class="n">expected_version</span><span class="p">)</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">active_version</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">state</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">expected_version</span>
        <span class="p">),</span> <span class="s2">&quot;Logic error: failed to observe version mismatch&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">confirm_phase</span><span class="p">(</span><span class="n">expected_version</span><span class="p">,</span> <span class="n">this_rank</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">confirm_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expected_version</span><span class="p">,</span> <span class="n">this_rank</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Once the rendezvous state trainsitions from &#39;joinable&#39; to &#39;frozen&#39;,</span>
<span class="sd">        we have every participant confirm their membership and setup per-member</span>
<span class="sd">        keep-alive TTL keys, and then wait for all other participants to confirm,</span>
<span class="sd">        which would then successfully conclude this rendezvous.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All peers arrived. Confirming membership.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">confirm_membership</span><span class="p">(</span><span class="n">expected_version</span><span class="p">,</span> <span class="n">this_rank</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Waiting for confirmations from all peers.&quot;</span><span class="p">)</span>
        <span class="n">active_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_final</span><span class="p">(</span><span class="n">expected_version</span><span class="p">)</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">active_version</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Rendezvous version </span><span class="si">{}</span><span class="s2"> is complete. Final state: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">state</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">],</span> <span class="n">state</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Rendezvous version number; our rank in it; world size</span>
        <span class="k">return</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">],</span> <span class="n">this_rank</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;participants&quot;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">handle_existing_rendezvous</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expected_version</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle the case when there&#39;s an existing (state &#39;final) rendezvous already</span>
<span class="sd">        in place, and we have to announce ourselves waiting, and wait until</span>
<span class="sd">        the next rendezvous opportunity.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># If state is &#39;final&#39; -&gt; increment num_workers_waiting</span>
        <span class="c1"># Then, observe state changes:</span>
        <span class="c1">#   1. if it&#39;s no longer final -&gt; bail out and re-try</span>
        <span class="c1">#   2. if keep alives are missing, destroy it and bail out.</span>
        <span class="n">active_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">announce_self_waiting</span><span class="p">(</span><span class="n">expected_version</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Added self to waiting list. Rendezvous full state: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">active_state</span><span class="o">.</span><span class="n">value</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_rendezvous_to_free</span><span class="p">(</span><span class="n">expected_version</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Previously existing rendezvous state changed. Will re-try joining.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">try_create_rendezvous</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create new rendezvous state or raise an exception that indicates</span>
<span class="sd">        an unexpected state (e.g. already exists)</span>

<span class="sd">        Raises:</span>
<span class="sd">             RendezvousError - on unexpected state</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Initially active_version is ephemeral - this is to handle the</span>
        <span class="c1"># possibility that might fail to complete the setup transaction,</span>
        <span class="c1"># i.e. the transition &quot;setup&quot; -&gt; &quot;joinable&quot;.</span>
        <span class="n">active_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s2">&quot;/rdzv/active_version&quot;</span><span class="p">),</span>
            <span class="n">value</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;setup&quot;</span><span class="p">}),</span>
            <span class="n">prevExist</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">ttl</span><span class="o">=</span><span class="n">CONST_ETCD_SETUP_TTL</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">version_counter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s2">&quot;/rdzv/version_counter&quot;</span><span class="p">))</span>
            <span class="n">version_counter</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">version_counter</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">version_counter</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">etcd</span><span class="o">.</span><span class="n">EtcdKeyNotFound</span><span class="p">,</span> <span class="n">etcd</span><span class="o">.</span><span class="n">EtcdCompareFailed</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">RendezvousError</span><span class="p">(</span>
                <span class="s2">&quot;Unexpected state of EtcdRendezvousHandler, worker needs to die.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Any failure below results in declaring a retryable rendezvous failure.</span>
        <span class="c1"># The ephemeral /rdzv/active_version will expire and someone can then</span>
        <span class="c1"># re-try the setup process.</span>

        <span class="c1"># Create directory node for participant data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s2">&quot;/rdzv/v_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">version_counter</span><span class="o">.</span><span class="n">value</span><span class="p">)),</span>
            <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="nb">dir</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">prevExist</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Publish rendezvous version and signal it is ready-to-be-joined.</span>
        <span class="c1"># If rendezvous was set closed just before this, a retry will happen,</span>
        <span class="c1"># where the closed condition will be handled.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">test_and_set</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s2">&quot;/rdzv/active_version&quot;</span><span class="p">),</span>
            <span class="n">value</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;joinable&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">version_counter</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="s2">&quot;participants&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="p">}</span>
            <span class="p">),</span>
            <span class="n">prev_value</span><span class="o">=</span><span class="n">active_version</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">join_rendezvous</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expected_version</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper method for the join phase.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Use compare-and-swap to add self to rendezvous state:</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">cas_delay</span><span class="p">()</span>
            <span class="n">active_version</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rdzv_state</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;joinable&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">EtcdRendezvousRetryableFailure</span><span class="p">(</span>
                    <span class="s2">&quot;Rendezvous state became non-joinable before we could join. &quot;</span>
                    <span class="s2">&quot;Must join next one.&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">expected_version</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">EtcdRendezvousRetryImmediately</span><span class="p">(</span>
                    <span class="s2">&quot;Rendezvous version changed. Must try join the new one.&quot;</span>
                <span class="p">)</span>

            <span class="k">assert</span> <span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;participants&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_max_workers</span>
            <span class="p">),</span> <span class="s2">&quot;Logic error: joinable rendezvous should always have space left&quot;</span>

            <span class="n">this_rank</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;participants&quot;</span><span class="p">])</span>
            <span class="n">state</span><span class="p">[</span><span class="s2">&quot;participants&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_rank</span><span class="p">)</span>

            <span class="c1"># When reaching min workers, or changing state to frozen, we&#39;ll set</span>
            <span class="c1"># the active_version node to be ephemeral.</span>
            <span class="n">set_ttl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;participants&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_max_workers</span><span class="p">:</span>
                <span class="n">state</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;frozen&quot;</span>
                <span class="n">state</span><span class="p">[</span><span class="s2">&quot;keep_alives&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">set_ttl</span> <span class="o">=</span> <span class="n">CONST_ETCD_FROZEN_TTL</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;participants&quot;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_min_workers</span><span class="p">:</span>
                <span class="n">set_ttl</span> <span class="o">=</span> <span class="n">CONST_ETCD_JOINABLE_EPHEMERAL_TTL</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Compare-and-swap.</span>
                <span class="n">active_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">test_and_set</span><span class="p">(</span>
                    <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s2">&quot;/rdzv/active_version&quot;</span><span class="p">),</span>
                    <span class="n">value</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">state</span><span class="p">),</span>
                    <span class="n">prev_value</span><span class="o">=</span><span class="n">active_version</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="n">ttl</span><span class="o">=</span><span class="n">set_ttl</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="c1"># We succeeded joining.</span>
                <span class="k">return</span> <span class="n">active_version</span><span class="p">,</span> <span class="n">this_rank</span>

            <span class="k">except</span> <span class="n">etcd</span><span class="o">.</span><span class="n">EtcdCompareFailed</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Join rendezvous CAS unsuccessful, retrying&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">wait_for_peers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expected_version</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper method for the join phase.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">active_version</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rdzv_state</span><span class="p">()</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;frozen&quot;</span> <span class="ow">and</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">expected_version</span><span class="p">:</span>
                <span class="c1"># Success, all peers arrived.</span>
                <span class="k">return</span> <span class="n">active_version</span>

            <span class="k">elif</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;joinable&quot;</span> <span class="ow">and</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">expected_version</span><span class="p">:</span>
                <span class="c1"># Continue waiting for any interesting events.</span>
                <span class="n">active_version</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">try_wait_for_state_change</span><span class="p">(</span>
                    <span class="n">etcd_index</span><span class="o">=</span><span class="n">active_version</span><span class="o">.</span><span class="n">etcd_index</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># No valid transition possible at this point</span>
                <span class="k">raise</span> <span class="n">EtcdRendezvousRetryableFailure</span><span class="p">(</span>
                    <span class="s2">&quot;Rendezvous state transition no longer possible. Must re-enter.&quot;</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">confirm_membership</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expected_version</span><span class="p">,</span> <span class="n">this_rank</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper method for the confirm phase</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Compare-and-swap loop</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">cas_delay</span><span class="p">()</span>
            <span class="n">active_version</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rdzv_state</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;frozen&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">EtcdRendezvousRetryImmediately</span><span class="p">(</span>
                    <span class="s2">&quot;Rendezvous no longer frozen, before we confirmed. &quot;</span>
                    <span class="s2">&quot;Must join next one&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">expected_version</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">EtcdRendezvousRetryImmediately</span><span class="p">(</span>
                    <span class="s2">&quot;Rendezvous version changed. Must try join the new one.&quot;</span>
                <span class="p">)</span>

            <span class="n">this_lease_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span>
                <span class="s2">&quot;/rdzv/v_</span><span class="si">{}</span><span class="s2">/rank_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">expected_version</span><span class="p">,</span> <span class="n">this_rank</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">this_lease_key</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ttl</span><span class="o">=</span><span class="n">CONST_WORKER_KEEPALIVE_TTL</span><span class="p">)</span>

            <span class="n">state</span><span class="p">[</span><span class="s2">&quot;keep_alives&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_lease_key</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;keep_alives&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;participants&quot;</span><span class="p">]):</span>
                <span class="c1"># Everyone confirmed (this rank is last to do so)</span>
                <span class="n">state</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;final&quot;</span>
                <span class="n">state</span><span class="p">[</span><span class="s2">&quot;num_workers_waiting&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">finalize</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">finalize</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Compare-and-swap. If new state is still frozen, keep it ephemeral.</span>
                <span class="n">active_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">test_and_set</span><span class="p">(</span>
                    <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s2">&quot;/rdzv/active_version&quot;</span><span class="p">),</span>
                    <span class="n">value</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">state</span><span class="p">),</span>
                    <span class="n">prev_value</span><span class="o">=</span><span class="n">active_version</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="n">ttl</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="n">finalize</span> <span class="k">else</span> <span class="n">CONST_ETCD_FROZEN_TTL</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_lease_this_rank_stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_lease_renewal</span><span class="p">(</span>
                    <span class="n">this_lease_key</span><span class="p">,</span> <span class="n">ttl</span><span class="o">=</span><span class="n">CONST_WORKER_KEEPALIVE_TTL</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">active_version</span>

            <span class="k">except</span> <span class="n">etcd</span><span class="o">.</span><span class="n">EtcdCompareFailed</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Confirm membership CAS unsuccessful, retrying&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">wait_for_final</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expected_version</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper method for the confirm phase</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">active_version</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rdzv_state</span><span class="p">()</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;final&quot;</span> <span class="ow">and</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">expected_version</span><span class="p">:</span>
                <span class="c1"># Succcess. This rendezvous is final, and we accept it.</span>
                <span class="k">return</span> <span class="n">active_version</span>

            <span class="k">elif</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;frozen&quot;</span> <span class="ow">and</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">expected_version</span><span class="p">:</span>
                <span class="c1"># Continue waiting for any interesting events.</span>
                <span class="n">active_version</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">try_wait_for_state_change</span><span class="p">(</span>
                    <span class="n">etcd_index</span><span class="o">=</span><span class="n">active_version</span><span class="o">.</span><span class="n">etcd_index</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># No valid transition possible at this point</span>
                <span class="k">raise</span> <span class="n">EtcdRendezvousRetryableFailure</span><span class="p">(</span>
                    <span class="s2">&quot;Rendezvous state transition no longer possible. Must re-enter.&quot;</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">announce_self_waiting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expected_version</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Announce this worker is waiting (via num_workers_waiting counter) to join next</span>
<span class="sd">        rendezvous, but only if state and version match.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">cas_delay</span><span class="p">()</span>
            <span class="n">active_version</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rdzv_state</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;final&quot;</span> <span class="ow">or</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">expected_version</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">EtcdRendezvousRetryImmediately</span><span class="p">()</span>

            <span class="c1"># Increment counter to signal an additional waiting worker.</span>
            <span class="n">state</span><span class="p">[</span><span class="s2">&quot;num_workers_waiting&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">active_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">test_and_set</span><span class="p">(</span>
                    <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s2">&quot;/rdzv/active_version&quot;</span><span class="p">),</span>
                    <span class="n">value</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">state</span><span class="p">),</span>
                    <span class="n">prev_value</span><span class="o">=</span><span class="n">active_version</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">active_version</span>

            <span class="k">except</span> <span class="n">etcd</span><span class="o">.</span><span class="n">EtcdCompareFailed</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Announce self as waiting CAS unsuccessful, retrying&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">wait_for_rendezvous_to_free</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expected_version</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        When there&#39;s an existing valid rendezvous in state &#39;final&#39;, we have to</span>
<span class="sd">        wait until the next opportunity to join.</span>

<span class="sd">        Such opportunity may come from:</span>

<span class="sd">        1. rendezvous state changed by someone else, in which case we unblock and retry.</span>
<span class="sd">        2. rendezvous becomes invalid because at least one member failed to renew their</span>
<span class="sd">           leased keep_alive node. We detect this, and destroy the rendezvous.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">active_version</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rdzv_state</span><span class="p">()</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;final&quot;</span> <span class="ow">or</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">expected_version</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="c1"># Check if current rendezvous state is valid, in the sense that all</span>
            <span class="c1"># its members are alive (renewing their lease).</span>
            <span class="c1"># If not, try destroy this rendezvous, so a new one can be created.</span>
            <span class="n">alive_members</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s2">&quot;/rdzv/v_</span><span class="si">{version}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">expected_version</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="n">keep_alive_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">ch</span><span class="o">.</span><span class="n">key</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">alive_members</span><span class="o">.</span><span class="n">children</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;keep_alives&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keep_alive_keys</span><span class="p">:</span>
                    <span class="c1"># This participant didn&#39;t renew their lease. We&#39;ll declare this</span>
                    <span class="c1"># rendezvous version as dead (but only if it hadn&#39;t changed)</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Keep-alive key </span><span class="si">{}</span><span class="s2"> is not renewed.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;Rendevous version </span><span class="si">{}</span><span class="s2"> is incomplete. &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">expected_version</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Attempting to destroy it.&quot;</span><span class="p">)</span>

                    <span class="c1"># Compare-and-delete operation. Throws if compare failed,</span>
                    <span class="c1"># which means rendezvous was already destroyed/re-created/closed,</span>
                    <span class="c1"># and we can try to re-enter the barrier.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
                        <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s2">&quot;/rdzv/active_version&quot;</span><span class="p">),</span>
                        <span class="n">prevValue</span><span class="o">=</span><span class="n">active_version</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;Destroyed rendezvous version </span><span class="si">{}</span><span class="s2"> successfully.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">expected_version</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

                    <span class="c1"># We can return (and retry) immediately</span>
                    <span class="k">return</span>

            <span class="c1"># Existing rendezvous seems valid, no reason to destroy it.</span>
            <span class="c1"># We just have to wait until something changes and re-check.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">overall_timeout</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rendezvous_deadline</span> <span class="o">-</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.0</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">watch</span><span class="p">(</span>
                    <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s2">&quot;/rdzv&quot;</span><span class="p">),</span>
                    <span class="n">index</span><span class="o">=</span><span class="n">active_version</span><span class="o">.</span><span class="n">etcd_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="n">overall_timeout</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">etcd</span><span class="o">.</span><span class="n">EtcdEventIndexCleared</span><span class="p">,</span> <span class="n">etcd</span><span class="o">.</span><span class="n">EtcdWatchTimedOut</span><span class="p">):</span>
                <span class="k">pass</span>

            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rendezvous_deadline</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">RendezvousTimeoutError</span><span class="p">()</span>
            <span class="n">active_version</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rdzv_state</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">handle_join_last_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expected_version</span><span class="p">,</span> <span class="n">deadline</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        After we reach min number of workers, one particular worker takes on the</span>
<span class="sd">        responsibility of waiting an additional timeout before closing the join window.</span>
<span class="sd">        If the worker responsible for this fails, the rendezvous will be destroyed due</span>
<span class="sd">        to expiring TTL, and the other participants will re-rendezvous.</span>

<span class="sd">        Here we expect to see state &lt;joinable, expected_version&gt;</span>
<span class="sd">        Exit gracefully if either:</span>

<span class="sd">        1. state becomes &lt;frozen, expected_version&gt;</span>
<span class="sd">        2. timeout happens (reaching deadline), in which case</span>
<span class="sd">           we try the tranisiton to &lt;frozen, expected_version&gt;</span>

<span class="sd">        Exit with exception otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">active_version</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rdzv_state</span><span class="p">()</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;frozen&quot;</span> <span class="ow">and</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">expected_version</span><span class="p">:</span>
                <span class="c1"># Worker set became frozen before last-call timeout. This is possible</span>
                <span class="c1"># when num_max_workers is reached before the tiemout.</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;joinable&quot;</span> <span class="ow">or</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">expected_version</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">EtcdRendezvousRetryableFailure</span><span class="p">(</span>
                    <span class="s2">&quot;Rendezvous state transition no longer possible. Must re-enter.&quot;</span>
                <span class="p">)</span>

            <span class="c1"># If timeout occurred, attempt a state transition (joinable -&gt; frozen)</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">deadline</span><span class="p">:</span>
                <span class="n">state</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;frozen&quot;</span>
                <span class="n">state</span><span class="p">[</span><span class="s2">&quot;keep_alives&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">active_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">test_and_set</span><span class="p">(</span>
                        <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s2">&quot;/rdzv/active_version&quot;</span><span class="p">),</span>
                        <span class="n">value</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">state</span><span class="p">),</span>
                        <span class="n">prev_value</span><span class="o">=</span><span class="n">active_version</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                        <span class="n">ttl</span><span class="o">=</span><span class="n">CONST_ETCD_FROZEN_TTL</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="c1"># We successfully made this rendezvous frozen.</span>
                    <span class="k">return</span>
                <span class="k">except</span> <span class="n">etcd</span><span class="o">.</span><span class="n">EtcdCompareFailed</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Join last-call transition CAS unsuccessful. Will retry&quot;</span><span class="p">)</span>
                    <span class="n">cas_delay</span><span class="p">()</span>
                    <span class="n">active_version</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rdzv_state</span><span class="p">()</span>
                    <span class="k">continue</span>

            <span class="c1"># Timeout did not occur, so we must refresh TTL, and wait for</span>
            <span class="c1"># further changes. Note: we only want TTL to be refreshed if</span>
            <span class="c1"># state is still joinable, hence we use CAS for that here,</span>
            <span class="c1"># even though we don&#39;t change any of the data.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">active_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">test_and_set</span><span class="p">(</span>
                    <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s2">&quot;/rdzv/active_version&quot;</span><span class="p">),</span>
                    <span class="n">value</span><span class="o">=</span><span class="n">active_version</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="n">prev_value</span><span class="o">=</span><span class="n">active_version</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="n">ttl</span><span class="o">=</span><span class="n">CONST_ETCD_JOINABLE_EPHEMERAL_TTL</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Minimize &quot;oversleeping&quot;:</span>
                <span class="n">timeout</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                    <span class="n">CONST_ETCD_JOINABLE_EPHEMERAL_TTL</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="n">deadline</span> <span class="o">-</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">,</span>  <span class="c1"># Oversleeping by 1s is ok.</span>
                <span class="p">)</span>
                <span class="n">active_version</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">try_wait_for_state_change</span><span class="p">(</span>
                    <span class="n">etcd_index</span><span class="o">=</span><span class="n">active_version</span><span class="o">.</span><span class="n">etcd_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">etcd</span><span class="o">.</span><span class="n">EtcdCompareFailed</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Join last-call TTL refresh CAS unsuccessful, will retry&quot;</span><span class="p">)</span>
                <span class="n">cas_delay</span><span class="p">()</span>
                <span class="n">active_version</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rdzv_state</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">set_closed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Mark rendezvous &#39;closed&#39; for current run_id, which is used to signal other</span>
<span class="sd">        participants to not attempt to perform (re-)rendezvous. This is useful</span>
<span class="sd">        when one of the workers decides the job is complete.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">active_version</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rdzv_state</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;closed&quot;</span><span class="p">:</span>
                <span class="c1"># Already closed by someone else.</span>
                <span class="k">return</span>

            <span class="n">state</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;closed&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">test_and_set</span><span class="p">(</span>
                    <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s2">&quot;/rdzv/active_version&quot;</span><span class="p">),</span>
                    <span class="n">value</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">state</span><span class="p">),</span>
                    <span class="n">prev_value</span><span class="o">=</span><span class="n">active_version</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">return</span>

            <span class="k">except</span> <span class="n">etcd</span><span class="o">.</span><span class="n">EtcdCompareFailed</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Set closed CAS unsuccessful, retrying&quot;</span><span class="p">)</span>
                <span class="n">cas_delay</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_rdzv_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">active_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s2">&quot;/rdzv/active_version&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">active_version</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">active_version</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">try_wait_for_state_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etcd_index</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Don&#39;t sleep past the overall deadline (at least more than by 1s)</span>
        <span class="n">overall_timeout</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rendezvous_deadline</span> <span class="o">-</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.0</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="n">overall_timeout</span> <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">min</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="n">overall_timeout</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">watch</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s2">&quot;/rdzv/active_version&quot;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">etcd_index</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">etcd</span><span class="o">.</span><span class="n">EtcdEventIndexCleared</span><span class="p">,</span> <span class="n">etcd</span><span class="o">.</span><span class="n">EtcdWatchTimedOut</span><span class="p">):</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rendezvous_deadline</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RendezvousTimeoutError</span><span class="p">()</span>

        <span class="c1"># Unfortunately, we have to do another fetch in order to get last etcd_index.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rdzv_state</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">path</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{prefix}</span><span class="s2">run_</span><span class="si">{run_id}{path}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span><span class="p">,</span> <span class="n">run_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_id</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_path_if_not_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">full_path</span><span class="p">,</span> <span class="n">ttl</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="n">key</span><span class="o">=</span><span class="n">full_path</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prevExist</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ttl</span><span class="o">=</span><span class="n">ttl</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">etcd</span><span class="o">.</span><span class="n">EtcdAlreadyExist</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">setup_lease_renewal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">full_path</span><span class="p">,</span> <span class="n">ttl</span><span class="p">):</span>
        <span class="c1"># NOTE: For ephemeral key TTL renewal (~lease) to work correctly,</span>
        <span class="c1"># make sure you don&#39;t call any long-blocking methods that do not</span>
        <span class="c1"># release the Python&#39;s GIL! An example of this is calling a pybind11</span>
        <span class="c1"># extension function that is blocking / long-running, but is not</span>
        <span class="c1"># doing a scoped release of the GIL.</span>
        <span class="k">def</span> <span class="nf">lease_worker</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">ttl</span><span class="p">,</span> <span class="n">stop_event</span><span class="p">):</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">client</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ttl</span><span class="o">=</span><span class="n">ttl</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">etcd</span><span class="o">.</span><span class="n">EtcdKeyNotFound</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">except</span> <span class="ne">ConnectionRefusedError</span><span class="p">:</span>
                    <span class="c1"># This error usually occurs during test when the server already got terminated but the</span>
                    <span class="c1"># python garbage collector have not yet invoked the __del__ method.</span>
                    <span class="k">break</span>

                <span class="k">if</span> <span class="n">stop_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">ttl</span> <span class="o">/</span> <span class="mi">2</span><span class="p">):</span>
                    <span class="k">break</span>

        <span class="n">lease_stop_event</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="n">lease_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="n">lease_worker</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">,</span> <span class="n">full_path</span><span class="p">,</span> <span class="n">ttl</span><span class="p">,</span> <span class="n">lease_stop_event</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">lease_thread</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">lease_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">lease_stop_event</span>

    <span class="k">def</span> <span class="nf">store_extra_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rdzv_version</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s2">&quot;/rdzv/v_</span><span class="si">{}</span><span class="s2">/extra_data&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rdzv_version</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># If first time we are storing anything:</span>
            <span class="n">extra_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="n">key</span><span class="o">=</span><span class="n">node</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">}),</span> <span class="n">prevExist</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="k">except</span> <span class="n">etcd</span><span class="o">.</span><span class="n">EtcdAlreadyExist</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># CAS loop, to make sure we don&#39;t lose concurrent stores.</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># We never delete extra_data. Failure here should be fatal, no special handling.</span>
            <span class="n">extra_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

            <span class="n">new_extra_data_value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">extra_data</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">new_extra_data_value</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">extra_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">test_and_set</span><span class="p">(</span>
                    <span class="n">key</span><span class="o">=</span><span class="n">node</span><span class="p">,</span>
                    <span class="n">value</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">new_extra_data_value</span><span class="p">),</span>
                    <span class="n">prev_value</span><span class="o">=</span><span class="n">extra_data</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">return</span>
            <span class="k">except</span> <span class="n">etcd</span><span class="o">.</span><span class="n">EtcdCompareFailed</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Store extra_data CAS unsuccessful, retrying&quot;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load_extra_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rdzv_version</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># &#39;extra_data&#39; node itself, and the directory it is located in:</span>
        <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s2">&quot;/rdzv/v_</span><span class="si">{}</span><span class="s2">/extra_data&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rdzv_version</span><span class="p">))</span>
        <span class="n">node_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s2">&quot;/rdzv/v_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rdzv_version</span><span class="p">))</span>

        <span class="c1"># TODO: implement timeout</span>
        <span class="c1"># https://github.com/pytorch/elastic/issues/12</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># Combined wait for the node itself, and the key inside it.</span>
            <span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node_dir</span><span class="p">)</span>

            <span class="c1"># Find the extra_data node, if it exists</span>
            <span class="n">extra_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">children</span> <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="n">node</span><span class="p">]</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">extra_data</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span>

            <span class="c1"># Node for extra_data exists, check the desired key inside it.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">extra_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">extra_data_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">extra_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">extra_data_dict</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">extra_data_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

            <span class="c1"># The &#39;extra_data&#39; node doesn&#39;t exist, or they key isn&#39;t published yet.</span>
            <span class="c1"># Wait for interesting events on the extra_data node and retry.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">watch</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">root</span><span class="o">.</span><span class="n">etcd_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">etcd</span><span class="o">.</span><span class="n">EtcdEventIndexCleared</span><span class="p">,</span> <span class="n">etcd</span><span class="o">.</span><span class="n">EtcdWatchTimedOut</span><span class="p">):</span>
                <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">setup_kv_store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rdzv_version</span><span class="p">):</span>
        <span class="n">store_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/rdzv/v_</span><span class="si">{</span><span class="n">rdzv_version</span><span class="si">}</span><span class="s2">/kv&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_path_if_not_exists</span><span class="p">(</span><span class="n">store_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">EtcdStore</span><span class="p">(</span><span class="n">etcd_client</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">,</span> <span class="n">etcd_store_prefix</span><span class="o">=</span><span class="n">store_path</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_create_etcd_client</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">RendezvousParameters</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">etcd</span><span class="o">.</span><span class="n">Client</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a new ``etcd.Client`` from the specified ``RendezvousParameters``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hostname</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">parse_rendezvous_endpoint</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span> <span class="mi">2379</span><span class="p">)</span>

    <span class="c1"># The communication protocol</span>
    <span class="n">protocol</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;protocol&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">protocol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">protocol</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">protocol</span> <span class="o">!=</span> <span class="s2">&quot;http&quot;</span> <span class="ow">and</span> <span class="n">protocol</span> <span class="o">!=</span> <span class="s2">&quot;https&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The etcd protocol must be HTTP or HTTPS.&quot;</span><span class="p">)</span>

    <span class="c1"># The SSL client certificate</span>
    <span class="n">ssl_cert</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cert&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ssl_cert</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cert_key</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cert_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># The etcd client expects the certificate key as the second element</span>
            <span class="c1"># of the `cert` tuple.</span>
            <span class="n">ssl_cert</span> <span class="o">=</span> <span class="p">(</span><span class="n">ssl_cert</span><span class="p">,</span> <span class="n">cert_key</span><span class="p">)</span>

    <span class="c1"># The root certificate</span>
    <span class="n">ca_cert</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cacert&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">etcd</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span>
        <span class="n">hostname</span><span class="p">,</span>
        <span class="n">port</span><span class="p">,</span>
        <span class="n">protocol</span><span class="o">=</span><span class="n">protocol</span><span class="p">,</span>
        <span class="n">cert</span><span class="o">=</span><span class="n">ssl_cert</span><span class="p">,</span>
        <span class="n">ca_cert</span><span class="o">=</span><span class="n">ca_cert</span><span class="p">,</span>
        <span class="n">allow_reconnect</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>


<span class="c1"># Handler for torch.distributed &quot;static&quot; registration</span>
<span class="k">def</span> <span class="nf">create_rdzv_handler</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">RendezvousParameters</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RendezvousHandler</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Usage:</span>

<span class="sd">    ::</span>

<span class="sd">    rdzv_params = RendezvousParameters(</span>
<span class="sd">                        backend=&quot;etcd&quot;,</span>
<span class="sd">                        endpoint=&quot;192.168.0.42:2379&quot;,</span>
<span class="sd">                        run_id=&quot;123&quot;,</span>
<span class="sd">                        min_nodes=4,</span>
<span class="sd">                        max_nodes=8,</span>
<span class="sd">                        timeout=300,</span>
<span class="sd">                        last_call_timeout=30,</span>
<span class="sd">                        etcd_prefix=&quot;custom_prefix&quot;,</span>
<span class="sd">                        protocol=&quot;https&quot;,</span>
<span class="sd">                        cacert=&quot;/etc/kubernetes/certs/ca.crt&quot;,</span>
<span class="sd">                        cert=&quot;/etc/kubernetes/certs/client.crt&quot;,</span>
<span class="sd">                        key=&quot;/etc/kubernetes/certs/client.key&quot;)</span>
<span class="sd">    # -- or --</span>
<span class="sd">    rdzv_params = RendezvousParameters(</span>
<span class="sd">                        backend=&quot;etcd&quot;,</span>
<span class="sd">                        endpoint=&quot;192.168.0.42:2379&quot;,</span>
<span class="sd">                        run_id=&quot;123&quot;,</span>
<span class="sd">                        min_nodes=4,</span>
<span class="sd">                        max_nodes=8)</span>

<span class="sd">    etcd_rdzv_handler = create_etcd_rendezvous_handler(rdzv_params)</span>


<span class="sd">    Where:</span>
<span class="sd">        run_id - unique id for this training job instance,</span>
<span class="sd">        min_nodes - min number of workers expected to join the rendezvous,</span>
<span class="sd">        max_nodes - max number of workers allowed to join the rendezvous,</span>
<span class="sd">                        defaults to min_workers is not specified.</span>
<span class="sd">        timeout - total timeout within which next_rendezvous is expected to</span>
<span class="sd">                      succeed; a RendezvousTimeoutError is raised otherwise;</span>
<span class="sd">                      Defaults is 600 (10 minutes).</span>
<span class="sd">        last_call_timeout - additional wait amount (&quot;last call&quot;) after</span>
<span class="sd">                            min number of workers has been reached.</span>
<span class="sd">                            Defaults to 30 seconds.</span>
<span class="sd">        etcd_prefix - path prefix (from etcd root), inside which all</span>
<span class="sd">                      etcd nodes will be created.</span>
<span class="sd">                      Default is &quot;/torchelastic/p2p&quot;.</span>
<span class="sd">        protocol - http (default) or https to access etcd.</span>
<span class="sd">        cacert - CA cert to access etcd, only makes sense with https.</span>
<span class="sd">        cert - client cert to access etcd, only makes sense with https.</span>
<span class="sd">        key - client key to access etcd, only makes sense with https.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">_create_etcd_client</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="n">etcd_prefix</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;etcd_prefix&quot;</span><span class="p">,</span> <span class="s2">&quot;/torchelastic/p2p&quot;</span><span class="p">)</span>

    <span class="n">rdzv</span> <span class="o">=</span> <span class="n">EtcdRendezvous</span><span class="p">(</span>
        <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span>
        <span class="n">prefix</span><span class="o">=</span><span class="n">etcd_prefix</span><span class="p">,</span>
        <span class="n">run_id</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span>
        <span class="n">num_min_workers</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">min_nodes</span><span class="p">,</span>
        <span class="n">num_max_workers</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">max_nodes</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">get_as_int</span><span class="p">(</span><span class="s2">&quot;timeout&quot;</span><span class="p">,</span> <span class="n">_DEFAULT_TIMEOUT</span><span class="p">),</span>
        <span class="n">last_call_timeout</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">get_as_int</span><span class="p">(</span><span class="s2">&quot;last_call_timeout&quot;</span><span class="p">,</span> <span class="n">_DEFAULT_LAST_CALL_TIMEOUT</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">EtcdRendezvousHandler</span><span class="p">(</span><span class="n">rdzv_impl</span><span class="o">=</span><span class="n">rdzv</span><span class="p">)</span>
</pre></div>

             </article>
             
            </div>
            <footer>
  

  

    <hr>

  

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Torch Contributors.

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>
     

</footer>

          </div>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              
            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="../../../../../" src="../../../../../_static/documentation_options.js"></script>
         <script src="../../../../../_static/jquery.js"></script>
         <script src="../../../../../_static/underscore.js"></script>
         <script src="../../../../../_static/doctools.js"></script>
         <script src="../../../../../_static/clipboard.min.js"></script>
         <script src="../../../../../_static/copybutton.js"></script>
     

  

  <script type="text/javascript" src="../../../../../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../../../../../_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="../../../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 
<script script type="text/javascript">
  var collapsedSections = ['Notes', 'Language Bindings', 'Libraries', 'Community'];
</script>

<img height="1" width="1" style="border-style:none;" alt="" src="https://www.googleadservices.com/pagead/conversion/795629140/?label=txkmCPmdtosBENSssfsC&amp;guid=ON&amp;script=0"/>


  <!-- Begin Footer -->

  <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
    <div class="container">
      <div class="row">
        <div class="col-md-4 text-center">
          <h2>Docs</h2>
          <p>Access comprehensive developer documentation for PyTorch</p>
          <a class="with-right-arrow" href="https://pytorch.org/docs/stable/index.html">View Docs</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Tutorials</h2>
          <p>Get in-depth tutorials for beginners and advanced developers</p>
          <a class="with-right-arrow" href="https://pytorch.org/tutorials">View Tutorials</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Resources</h2>
          <p>Find development resources and get your questions answered</p>
          <a class="with-right-arrow" href="https://pytorch.org/resources">View Resources</a>
        </div>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container footer-container">
      <div class="footer-logo-wrapper">
        <a href="https://pytorch.org/" class="footer-logo"></a>
      </div>

      <div class="footer-links-wrapper">
        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/">PyTorch</a></li>
            <li><a href="https://pytorch.org/get-started">Get Started</a></li>
            <li><a href="https://pytorch.org/features">Features</a></li>
            <li><a href="https://pytorch.org/ecosystem">Ecosystem</a></li>
            <li><a href="https://pytorch.org/blog/">Blog</a></li>
            <li><a href="https://github.com/pytorch/pytorch/blob/master/CONTRIBUTING.md">Contributing</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/resources">Resources</a></li>
            <li><a href="https://pytorch.org/tutorials">Tutorials</a></li>
            <li><a href="https://pytorch.org/docs/stable/index.html">Docs</a></li>
            <li><a href="https://discuss.pytorch.org" target="_blank">Discuss</a></li>
            <li><a href="https://github.com/pytorch/pytorch/issues" target="_blank">Github Issues</a></li>
            <li><a href="https://pytorch.org/assets/brand-guidelines/PyTorch-Brand-Guidelines.pdf" target="_blank">Brand Guidelines</a></li>
          </ul>
        </div>

        <div class="footer-links-col follow-us-col">
          <ul>
            <li class="list-title">Stay Connected</li>
            <li>
              <div id="mc_embed_signup">
                <form
                  action="https://twitter.us14.list-manage.com/subscribe/post?u=75419c71fe0a935e53dfa4a3f&id=91d0dccd39"
                  method="post"
                  id="mc-embedded-subscribe-form"
                  name="mc-embedded-subscribe-form"
                  class="email-subscribe-form validate"
                  target="_blank"
                  novalidate>
                  <div id="mc_embed_signup_scroll" class="email-subscribe-form-fields-wrapper">
                    <div class="mc-field-group">
                      <label for="mce-EMAIL" style="display:none;">Email Address</label>
                      <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" placeholder="Email Address">
                    </div>

                    <div id="mce-responses" class="clear">
                      <div class="response" id="mce-error-response" style="display:none"></div>
                      <div class="response" id="mce-success-response" style="display:none"></div>
                    </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->

                    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_75419c71fe0a935e53dfa4a3f_91d0dccd39" tabindex="-1" value=""></div>

                    <div class="clear">
                      <input type="submit" value="" name="subscribe" id="mc-embedded-subscribe" class="button email-subscribe-button">
                    </div>
                  </div>
                </form>
              </div>

            </li>
          </ul>

          <div class="footer-social-icons">
            <a href="https://www.facebook.com/pytorch" target="_blank" class="facebook"></a>
            <a href="https://twitter.com/pytorch" target="_blank" class="twitter"></a>
            <a href="https://www.youtube.com/pytorch" target="_blank" class="youtube"></a>
          </div>
        </div>
      </div>
    </div>
  </footer>

  <div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebook’s Cookies Policy applies. Learn more, including about available controls: <a href="https://www.facebook.com/policies/cookies/">Cookies Policy</a>.</p>
    <img class="close-button" src="../../../../../_static/images/pytorch-x.svg">
  </div>
</div>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>

          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/hub">PyTorch Hub</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li class="resources-mobile-menu-title" class="active">
            Docs
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/docs/stable/index.html">PyTorch</a>
            </li>

            <li>
              <a href="https://pytorch.org/audio/stable/index.html">torchaudio</a>
            </li>

            <li>
              <a href="https://pytorch.org/text/stable/index.html">torchtext</a>
            </li>

            <li>
              <a href="https://pytorch.org/vision/stable/index.html">torchvision</a>
            </li>

            <li>
              <a href="https://pytorch.org/elastic/">TorchElastic</a>
            </li>

            <li>
              <a href="https://pytorch.org/serve/">TorchServe</a>
            </li>

            <li>
              <a href="https://pytorch.org/xla">PyTorch on XLA Devices</a>
            </li>
          </ul>

          <li class="resources-mobile-menu-title">
            Resources
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/resources">Developer Resources</a>
            </li>

            <li>
              <a href="https://pytorch.org/features">About</a>
            </li>

            <li>
              <a href="https://pytorch.org/hub">Models (Beta)</a>
            </li>

            <li>
              <a href="https://pytorch.org/#community-module">Community</a>
            </li>

            <li>
              <a href="https://discuss.pytorch.org/">Forums</a>
            </li>
          </ul>

          <li>
            <a href="https://github.com/pytorch/pytorch">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="../../../../../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>