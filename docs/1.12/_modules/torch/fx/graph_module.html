


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta name="robots" content="noindex">
  <meta name="robots" content="noindex">
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>torch.fx.graph_module &mdash; PyTorch 1.12 documentation</title>
  

  
  
  
  
    <link rel="canonical" href="https://pytorch.org/docs/stable/_modules/torch/fx/graph_module.html"/>
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.css" type="text/css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/katex-math.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/jit.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />


  <!-- Google Analytics -->
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-117752657-2"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-117752657-2');
    </script>
  
  <!-- End Google Analytics -->
  


  
  <script src="../../../_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>

          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li class="active docs-active">
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-orange-arrow">
                Docs
              </a>
              <div class="resources-dropdown-menu">
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/docs/stable/index.html">
                  <span class="dropdown-title">PyTorch</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/audio/stable/index.html">
                  <span class="dropdown-title">torchaudio</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/text/stable/index.html">
                  <span class="dropdown-title">torchtext</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/vision/stable/index.html">
                  <span class="dropdown-title">torchvision</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torchrec">
                  <span class="dropdown-title">TorchRec</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/data">
                  <span class="dropdown-title">TorchData</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/serve/">
                  <span class="dropdown-title">TorchServe</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torchx/">
                  <span class="dropdown-title">TorchX</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/xla">
                  <span class="dropdown-title">PyTorch on XLA Devices</span>
                  <p></p>
                </a>
            </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-arrow">
                Resources
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/features">
                  <span class="dropdown-title">About</span>
                  <p>Learn about PyTorchâ€™s features and capabilities</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/#community-module">
                  <span class="dropdown-title">Community</span>
                  <p>Join the PyTorch developer community to contribute, learn, and get your questions answered.</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/resources">
                  <span class="dropdown-title">Developer Resources</span>
                  <p>Find resources and get questions answered</p>
                </a>
                <a class="nav-dropdown-item" href="https://discuss.pytorch.org/" target="_blank">
                  <span class="dropdown-title">Forums</span>
                  <p>A place to discuss PyTorch code, issues, install, research</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/hub">
                  <span class="dropdown-title">Models (Beta)</span>
                  <p>Discover, publish, and reuse pre-trained models</p>
                </a>
              </div>
            </div>
          </li>

          <li>
            <a href="https://github.com/pytorch/pytorch">GitHub</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>

<body class="pytorch-body">

   

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            
    <div class="version">
      <a href='https://pytorch.org/docs/versions.html'>1.12 &#x25BC</a>
    </div>
    


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          </div>

          


            
            
              
            
            
              <p class="caption"><span class="caption-text">Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/amp_examples.html">CUDA Automatic Mixed Precision examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/autograd.html">Autograd mechanics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/broadcasting.html">Broadcasting semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/cpu_threading_torchscript_inference.html">CPU threading and TorchScript inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/cuda.html">CUDA semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/ddp.html">Distributed Data Parallel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/extending.html">Extending PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/gradcheck.html">Gradcheck mechanics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/hip.html">HIP (ROCm) semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/large_scale_deployments.html">Features for large-scale deployments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/modules.html">Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/mps.html">MPS backend</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/multiprocessing.html">Multiprocessing best practices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/numerical_accuracy.html">Numerical accuracy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/randomness.html">Reproducibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/serialization.html">Serialization semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/windows.html">Windows FAQ</a></li>
</ul>
<p class="caption"><span class="caption-text">Language Bindings</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../cpp_index.html">C++</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/javadoc/">Javadoc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../deploy.html">torch::deploy</a></li>
</ul>
<p class="caption"><span class="caption-text">Python API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../torch.html">torch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nn.html">torch.nn</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nn.functional.html">torch.nn.functional</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tensors.html">torch.Tensor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tensor_attributes.html">Tensor Attributes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tensor_view.html">Tensor Views</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../amp.html">torch.amp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../autograd.html">torch.autograd</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../library.html">torch.library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cuda.html">torch.cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../backends.html">torch.backends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.html">torch.distributed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.algorithms.join.html">torch.distributed.algorithms.join</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.elastic.html">torch.distributed.elastic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fsdp.html">torch.distributed.fsdp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.optim.html">torch.distributed.optim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributions.html">torch.distributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fft.html">torch.fft</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../futures.html">torch.futures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fx.html">torch.fx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hub.html">torch.hub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../jit.html">torch.jit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../linalg.html">torch.linalg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../monitor.html">torch.monitor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../special.html">torch.special</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../torch.overrides.html">torch.overrides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../package.html">torch.package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../profiler.html">torch.profiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nn.init.html">torch.nn.init</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../onnx.html">torch.onnx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../optim.html">torch.optim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../complex_numbers.html">Complex Numbers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ddp_comm_hooks.html">DDP Communication Hooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pipeline.html">Pipeline Parallelism</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quantization.html">Quantization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rpc.html">Distributed RPC Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../random.html">torch.random</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nested.html">torch.nested</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sparse.html">torch.sparse</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../storage.html">torch.Storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../testing.html">torch.testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../benchmark_utils.html">torch.utils.benchmark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../bottleneck.html">torch.utils.bottleneck</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../checkpoint.html">torch.utils.checkpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cpp_extension.html">torch.utils.cpp_extension</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data.html">torch.utils.data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dlpack.html">torch.utils.dlpack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mobile_optimizer.html">torch.utils.mobile_optimizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../model_zoo.html">torch.utils.model_zoo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tensorboard.html">torch.utils.tensorboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../type_info.html">Type Info</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../named_tensor.html">Named Tensors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../name_inference.html">Named Tensors operator coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../config_mod.html">torch.__config__</a></li>
</ul>
<p class="caption"><span class="caption-text">Libraries</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/audio/stable">torchaudio</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/data">TorchData</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/torchrec">TorchRec</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/serve">TorchServe</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/text/stable">torchtext</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/vision/stable">torchvision</a></li>
<li class="toctree-l1"><a class="reference external" href="http://pytorch.org/xla/">PyTorch on XLA Devices</a></li>
</ul>
<p class="caption"><span class="caption-text">Community</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../community/contribution_guide.html">PyTorch Contribution Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/governance.html">PyTorch Governance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/persons_of_interest.html">PyTorch Governance | Persons of Interest</a></li>
</ul>

            
          

        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="../../../index.html">
          
            Docs
          
        </a> &gt;
      </li>

        
          <li><a href="../../index.html">Module code</a> &gt;</li>
        
          <li><a href="../../torch.html">torch</a> &gt;</li>
        
      <li>torch.fx.graph_module</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">

        
          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <h1>Source code for torch.fx.graph_module</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.overrides</span>
<span class="kn">from</span> <span class="nn">torch.nn.modules.module</span> <span class="kn">import</span> <span class="n">_addindent</span>
<span class="kn">from</span> <span class="nn">torch.package</span> <span class="kn">import</span> <span class="n">PackageImporter</span><span class="p">,</span> <span class="n">PackageExporter</span>
<span class="kn">import</span> <span class="nn">linecache</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Type</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Set</span>
<span class="kn">from</span> <span class="nn">.graph</span> <span class="kn">import</span> <span class="n">Graph</span><span class="p">,</span> <span class="n">_PyTreeCodeGen</span><span class="p">,</span> <span class="n">_is_from_torch</span><span class="p">,</span> <span class="n">_custom_builtins</span><span class="p">,</span> <span class="n">PythonCode</span>
<span class="kn">from</span> <span class="nn">._compatibility</span> <span class="kn">import</span> <span class="n">compatibility</span>
<span class="kn">from</span> <span class="nn">torch.package</span> <span class="kn">import</span> <span class="n">Importer</span><span class="p">,</span> <span class="n">sys_importer</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="c1"># Normal exec loses the source code, however we can work with</span>
<span class="c1"># the linecache module to recover it.</span>
<span class="c1"># Using _exec_with_source will add it to our local cache</span>
<span class="c1"># and then tools like TorchScript will be able to get source info.</span>
<span class="k">class</span> <span class="nc">_EvalCacheLoader</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_id</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">globals</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Store the source in a private cache, and add a lazy entry in linecache</span>
<span class="sd">        that allows the source to be retrieved by &#39;filename&#39;.</span>

<span class="sd">        Args:</span>
<span class="sd">            src (str): The module source to cache</span>
<span class="sd">            globals (dict): The module globals</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The cache key (and dummy filename) generated for src.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_key</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span>

        <span class="c1"># Don&#39;t mutate globals so that this loader is only used</span>
        <span class="c1"># to populate linecache, and doesn&#39;t interact with other modules</span>
        <span class="c1"># that might check `__loader__`</span>
        <span class="n">globals_copy</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">globals_copy</span><span class="p">[</span><span class="s1">&#39;__file__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span>
        <span class="n">globals_copy</span><span class="p">[</span><span class="s1">&#39;__name__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span>
        <span class="n">globals_copy</span><span class="p">[</span><span class="s1">&#39;__loader__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">linecache</span><span class="o">.</span><span class="n">lazycache</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">globals_copy</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">key</span>

    <span class="c1"># Part of the loader protocol (PEP 302)</span>
    <span class="c1"># linecache will use this method when trying to find source code</span>
    <span class="k">def</span> <span class="nf">get_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module_name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">module_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_cache</span><span class="p">[</span><span class="n">module_name</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_get_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&lt;eval_with_key&gt;.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">next_id</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_id</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">key</span>

<span class="n">_loader</span> <span class="o">=</span> <span class="n">_EvalCacheLoader</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_exec_with_source</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">globals</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">_loader</span><span class="o">.</span><span class="n">cache</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="nb">globals</span><span class="p">)</span>
    <span class="n">exec</span><span class="p">(</span><span class="nb">compile</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">),</span> <span class="nb">globals</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_forward_from_src</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">globals</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
    <span class="c1"># avoid mutating the passed in dict</span>
    <span class="n">globals_copy</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">_exec_with_source</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">globals_copy</span><span class="p">)</span>
    <span class="n">forward_fn</span> <span class="o">=</span> <span class="n">globals_copy</span><span class="p">[</span><span class="s1">&#39;forward&#39;</span><span class="p">]</span>
    <span class="k">del</span> <span class="n">globals_copy</span><span class="p">[</span><span class="s1">&#39;forward&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">forward_fn</span>


<span class="k">def</span> <span class="nf">_format_import_statement</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">importer</span><span class="p">:</span> <span class="n">Importer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">_custom_builtins</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_custom_builtins</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">import_str</span>
    <span class="k">if</span> <span class="n">_is_from_torch</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;import torch&#39;</span>
    <span class="n">module_name</span><span class="p">,</span> <span class="n">attr_name</span> <span class="o">=</span> <span class="n">importer</span><span class="o">.</span><span class="n">get_name</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;from </span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s1"> import </span><span class="si">{</span><span class="n">attr_name</span><span class="si">}</span><span class="s1"> as </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span>


<span class="k">def</span> <span class="nf">_format_import_block</span><span class="p">(</span><span class="nb">globals</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">importer</span><span class="p">:</span> <span class="n">Importer</span><span class="p">):</span>
    <span class="n">import_strs</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="nb">globals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">import_strs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">_format_import_statement</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">importer</span><span class="p">))</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">import_strs</span><span class="p">)</span>


<span class="nd">@compatibility</span><span class="p">(</span><span class="n">is_backward_compatible</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">reduce_graph_module</span><span class="p">(</span><span class="n">body</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">import_block</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">:</span>
    <span class="c1"># BC: attribute name was changed from `code` to `_code` to facilitate</span>
    <span class="c1"># making `code` into a property and adding a docstring to it</span>
    <span class="n">fn_src</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_code&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">body</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span>
    <span class="n">forward</span> <span class="o">=</span> <span class="n">_forward_from_src</span><span class="p">(</span><span class="n">import_block</span> <span class="o">+</span> <span class="n">fn_src</span><span class="p">,</span> <span class="p">{})</span>
    <span class="k">return</span> <span class="n">_deserialize_graph_module</span><span class="p">(</span><span class="n">forward</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>


<span class="nd">@compatibility</span><span class="p">(</span><span class="n">is_backward_compatible</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">reduce_package_graph_module</span><span class="p">(</span>
    <span class="n">importer</span><span class="p">:</span> <span class="n">PackageImporter</span><span class="p">,</span> <span class="n">body</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">generated_module_name</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">:</span>
    <span class="n">forward</span> <span class="o">=</span> <span class="n">importer</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">generated_module_name</span><span class="p">)</span><span class="o">.</span><span class="n">forward</span>
    <span class="k">return</span> <span class="n">_deserialize_graph_module</span><span class="p">(</span><span class="n">forward</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>

<span class="nd">@compatibility</span><span class="p">(</span><span class="n">is_backward_compatible</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">reduce_deploy_graph_module</span><span class="p">(</span>
    <span class="n">importer</span><span class="p">:</span> <span class="n">PackageImporter</span><span class="p">,</span> <span class="n">body</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">import_block</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">:</span>
    <span class="n">ns</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">ns</span><span class="p">[</span><span class="s2">&quot;__builtins__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">importer</span><span class="o">.</span><span class="n">patched_builtins</span>
    <span class="n">fn_src</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_code&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">fn_src</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="n">forward</span> <span class="o">=</span> <span class="n">_forward_from_src</span><span class="p">(</span><span class="n">import_block</span> <span class="o">+</span> <span class="n">fn_src</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_deserialize_graph_module</span><span class="p">(</span><span class="n">forward</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_deserialize_graph_module</span><span class="p">(</span><span class="n">forward</span><span class="p">,</span> <span class="n">body</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deserialize a GraphModule given the dictionary of the original module,</span>
<span class="sd">    using the code to reconstruct the graph. We delete the actual graph before</span>
<span class="sd">    saving the dictionary so that changes to the in-memory graph format do not</span>
<span class="sd">    get serialized.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># We create a dummy class here because symbolic_trace pulls the forward()</span>
    <span class="c1"># function off of the class, rather than the instance</span>
    <span class="k">class</span> <span class="nc">CodeOnlyModule</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="n">body</span>

    <span class="c1"># Try to retrieve the forward source in a backward-compatible way</span>
    <span class="n">CodeOnlyModule</span><span class="o">.</span><span class="n">forward</span> <span class="o">=</span> <span class="n">forward</span>

    <span class="n">tracer_cls</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_tracer_cls&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tracer_cls</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">._symbolic_trace</span> <span class="kn">import</span> <span class="n">Tracer</span>
        <span class="n">tracer_cls</span> <span class="o">=</span> <span class="n">Tracer</span>

    <span class="n">graphmodule_cls_name</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_graphmodule_cls_name&#39;</span><span class="p">,</span> <span class="s1">&#39;GraphModule&#39;</span><span class="p">)</span>

    <span class="c1"># This is a workaround for a mypy linter issue related to</span>
    <span class="c1"># passing base class as an argument - https://github.com/python/mypy/issues/5865.</span>
    <span class="n">cls_tracer</span> <span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">tracer_cls</span>

    <span class="k">class</span> <span class="nc">KeepModules</span><span class="p">(</span><span class="n">cls_tracer</span><span class="p">):</span>
        <span class="c1"># we shouldn&#39;t trace into any of the submodules,</span>
        <span class="c1"># because they were not traced in the original GraphModule</span>
        <span class="k">def</span> <span class="nf">is_leaf_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">__</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="n">com</span> <span class="o">=</span> <span class="n">CodeOnlyModule</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>

    <span class="n">tracer_extras</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_tracer_extras&#39;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">KeepModules</span><span class="p">()</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">com</span><span class="p">,</span> <span class="o">**</span><span class="n">tracer_extras</span><span class="p">)</span>

    <span class="c1"># Manually set Tracer class on the reconstructed Graph, to avoid</span>
    <span class="c1"># referencing the private local subclass KeepModules.</span>
    <span class="n">graph</span><span class="o">.</span><span class="n">_tracer_cls</span> <span class="o">=</span> <span class="n">tracer_cls</span>
    <span class="n">gm</span> <span class="o">=</span> <span class="n">GraphModule</span><span class="p">(</span><span class="n">com</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">class_name</span><span class="o">=</span><span class="n">graphmodule_cls_name</span><span class="p">)</span>

    <span class="c1"># The GraphModule constructor only retains attributes referenced by the graph.</span>
    <span class="c1"># In this case, our goal is return a GraphModule as close to identical as the one</span>
    <span class="c1"># put into the package. If any additional attributes were present in body,</span>
    <span class="c1"># we should keep them.</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">body</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">gm</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">gm</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">gm</span>

<span class="c1"># copy an attribute value with qualified name &#39;target&#39; from &#39;from_module&#39; to &#39;to_module&#39;</span>
<span class="c1"># This installs empty Modules where none exist yet if they are subpaths of target</span>
<span class="k">def</span> <span class="nf">_copy_attr</span><span class="p">(</span><span class="n">from_module</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">to_module</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="o">*</span><span class="n">prefix</span><span class="p">,</span> <span class="n">field</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">prefix</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">from_module</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">to_module</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="n">t</span><span class="p">:</span>
            <span class="c1"># we have already installed one of its parents</span>
            <span class="c1"># (e.g. target = root.linear.weight, but we have already installed root.linear)</span>
            <span class="c1"># once we install a parent, we no longer need to copy the children</span>
            <span class="c1"># since all the needed properties will already be present</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">()</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">to_module</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="n">from_module</span><span class="p">,</span> <span class="n">to_module</span> <span class="o">=</span> <span class="n">f</span><span class="p">,</span> <span class="n">t</span>

    <span class="n">orig</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">from_module</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
    <span class="c1"># If it is a tensor and not a parameter attribute of a module, it should be a named buffer.</span>
    <span class="c1"># So, we register it as a named buffer in the target module.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">):</span>
        <span class="n">to_module</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">orig</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">to_module</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">orig</span><span class="p">)</span>

<span class="c1"># Assign attribute &#39;from_obj&#39; to the qualified name &#39;target&#39; on &#39;to_module</span>
<span class="c1"># This installs empty Modules where none exist yet if they are subpaths of target</span>
<span class="k">def</span> <span class="nf">_assign_attr</span><span class="p">(</span><span class="n">from_obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">to_module</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="o">*</span><span class="n">prefix</span><span class="p">,</span> <span class="n">field</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">prefix</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">to_module</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">()</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">to_module</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="n">to_module</span> <span class="o">=</span> <span class="n">t</span>

    <span class="c1"># If it is a tensor and not a parameter attribute of a module, it should be a named buffer.</span>
    <span class="c1"># So, we register it as a named buffer in the target module.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">from_obj</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">from_obj</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">):</span>
        <span class="n">to_module</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">from_obj</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">to_module</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">from_obj</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">_WrappedCall</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">cls_call</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cls</span> <span class="o">=</span> <span class="bp">cls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cls_call</span> <span class="o">=</span> <span class="n">cls_call</span>

    <span class="c1"># Previously, if an error occurred when valid</span>
    <span class="c1"># symbolically-traced code was run with an invalid input, the</span>
    <span class="c1"># user would see the source of the error as coming from</span>
    <span class="c1"># `File &quot;&lt;eval_with_key_N&quot;&gt;`, where N is some number. We use</span>
    <span class="c1"># this function to generate a more informative error message. We</span>
    <span class="c1"># return the traceback itself, a message explaining that the</span>
    <span class="c1"># error occurred in a traced Module&#39;s generated forward</span>
    <span class="c1"># function, and five lines of context surrounding the faulty</span>
    <span class="c1"># line</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_generate_error_message</span><span class="p">(</span><span class="n">frame_summary</span><span class="p">:</span> <span class="n">traceback</span><span class="o">.</span><span class="n">FrameSummary</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># auxiliary variables (for readability)</span>
        <span class="n">err_lineno</span> <span class="o">=</span> <span class="n">frame_summary</span><span class="o">.</span><span class="n">lineno</span>
        <span class="k">assert</span> <span class="n">err_lineno</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">frame_summary</span><span class="o">.</span><span class="n">line</span>
        <span class="k">assert</span> <span class="n">line</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">err_line_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">all_src_lines</span> <span class="o">=</span> <span class="n">linecache</span><span class="o">.</span><span class="n">getlines</span><span class="p">(</span><span class="n">frame_summary</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>

        <span class="c1"># constituent substrings of the error message</span>
        <span class="n">tb_repr</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">custom_msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Call using an FX-traced Module, &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;line </span><span class="si">{</span><span class="n">err_lineno</span><span class="si">}</span><span class="s2"> of the traced Module&#39;s &quot;</span>
                      <span class="s2">&quot;generated forward function:&quot;</span><span class="p">)</span>
        <span class="n">before_err</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">all_src_lines</span><span class="p">[</span><span class="n">err_lineno</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">:</span> <span class="n">err_lineno</span><span class="p">])</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;~&quot;</span> <span class="o">*</span> <span class="n">err_line_len</span> <span class="o">+</span> <span class="s2">&quot;~~~ &lt;--- HERE&quot;</span>
        <span class="n">err_and_after_err</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">all_src_lines</span><span class="p">[</span><span class="n">err_lineno</span> <span class="p">:</span> <span class="n">err_lineno</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span>

        <span class="c1"># joined message</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">tb_repr</span><span class="p">,</span> <span class="n">custom_msg</span><span class="p">,</span> <span class="n">before_err</span><span class="p">,</span> <span class="n">marker</span><span class="p">,</span> <span class="n">err_and_after_err</span><span class="p">])</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls_call</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls_call</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># type: ignore[misc]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">e</span><span class="o">.</span><span class="n">__traceback__</span>
            <span class="n">topmost_framesummary</span><span class="p">:</span> <span class="n">traceback</span><span class="o">.</span><span class="n">FrameSummary</span> <span class="o">=</span> \
                <span class="n">traceback</span><span class="o">.</span><span class="n">StackSummary</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">walk_tb</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">__traceback__</span><span class="p">))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># type: ignore[arg-type]</span>
            <span class="k">if</span> <span class="s2">&quot;eval_with_key&quot;</span> <span class="ow">in</span> <span class="n">topmost_framesummary</span><span class="o">.</span><span class="n">filename</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">_WrappedCall</span><span class="o">.</span><span class="n">_generate_error_message</span><span class="p">(</span><span class="n">topmost_framesummary</span><span class="p">),</span>
                      <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">e</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>

<div class="viewcode-block" id="GraphModule"><a class="viewcode-back" href="../../../fx.html#torch.fx.GraphModule">[docs]</a><span class="nd">@compatibility</span><span class="p">(</span><span class="n">is_backward_compatible</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">GraphModule</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GraphModule is an nn.Module generated from an fx.Graph. Graphmodule has a</span>
<span class="sd">    ``graph`` attribute, as well as ``code`` and ``forward`` attributes generated</span>
<span class="sd">    from that ``graph``.</span>

<span class="sd">    .. warning::</span>

<span class="sd">        When ``graph`` is reassigned, ``code`` and ``forward`` will be automatically</span>
<span class="sd">        regenerated. However, if you edit the contents of the ``graph`` without reassigning</span>
<span class="sd">        the ``graph`` attribute itself, you must call ``recompile()`` to update the generated</span>
<span class="sd">        code.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="s1">&#39;Type[GraphModule]&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># each instance of a graph module needs its own forward method</span>
        <span class="c1"># so create a new singleton class for each instance.</span>
        <span class="c1"># it is a subclass of the user-defined class, the only difference</span>
        <span class="c1"># is an extra layer to install the forward method</span>

        <span class="c1"># address issue described at https://github.com/pytorch/pytorch/issues/63883</span>
        <span class="c1"># in other words, traverse class hierarchy to fix the redundant class definition problem</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="vm">__qualname__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="s1">&#39;GraphModuleImpl&#39;</span><span class="p">:</span>
                <span class="bp">cls</span> <span class="o">=</span> <span class="n">t</span>
                <span class="k">break</span>

        <span class="k">class</span> <span class="nc">GraphModuleImpl</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>  <span class="c1"># type: ignore[misc, valid-type]</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">GraphModuleImpl</span><span class="p">)</span>

<div class="viewcode-block" id="GraphModule.__init__"><a class="viewcode-back" href="../../../fx.html#torch.fx.GraphModule.__init__">[docs]</a>    <span class="nd">@compatibility</span><span class="p">(</span><span class="n">is_backward_compatible</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">root</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
                 <span class="n">graph</span><span class="p">:</span> <span class="n">Graph</span><span class="p">,</span>
                 <span class="n">class_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;GraphModule&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct a GraphModule.</span>

<span class="sd">        Args:</span>

<span class="sd">            root (Union[torch.nn.Module, Dict[str, Any]):</span>
<span class="sd">                ``root`` can either be an nn.Module instance or a Dict mapping strings to any attribute type.</span>
<span class="sd">                In the case that ``root`` is a Module, any references to Module-based objects (via qualified</span>
<span class="sd">                name) in the Graph&#39;s Nodes&#39; ``target`` field will be copied over from the respective place</span>
<span class="sd">                within ``root``&#39;s Module hierarchy into the GraphModule&#39;s module hierarchy.</span>
<span class="sd">                In the case that ``root`` is a dict, the qualified name found in a Node&#39;s ``target`` will be</span>
<span class="sd">                looked up directly in the dict&#39;s keys. The object mapped to by the Dict will be copied</span>
<span class="sd">                over into the appropriate place within the GraphModule&#39;s module hierarchy.</span>

<span class="sd">            graph (Graph): ``graph`` contains the nodes this GraphModule should use for code generation</span>

<span class="sd">            class_name (str): ``name`` denotes the name of this GraphModule for debugging purposes. If it&#39;s unset, all</span>
<span class="sd">                error messages will report as originating from ``GraphModule``. It may be helpful to set this</span>
<span class="sd">                to ``root``&#39;s original name or a name that makes sense within the context of your transform.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="n">class_name</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;training&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">training</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">training</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">op</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;get_attr&#39;</span><span class="p">,</span> <span class="s1">&#39;call_module&#39;</span><span class="p">]:</span>
                    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                    <span class="n">_copy_attr</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">targets_to_copy</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">op</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;get_attr&#39;</span><span class="p">,</span> <span class="s1">&#39;call_module&#39;</span><span class="p">]:</span>
                    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">target</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">root</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Node &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; referenced target &#39;</span> <span class="o">+</span> <span class="n">node</span><span class="o">.</span><span class="n">target</span> <span class="o">+</span>
                                           <span class="s1">&#39; but that target was not provided in ``root``!&#39;</span><span class="p">)</span>
                    <span class="n">targets_to_copy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
            <span class="c1"># Sort targets in ascending order of the # of atoms.</span>
            <span class="c1"># This will ensure that less deeply nested attributes are assigned</span>
            <span class="c1"># before more deeply nested attributes. For example, foo.bar</span>
            <span class="c1"># will be assigned before foo.bar.baz. Otherwise, we might assign</span>
            <span class="c1"># the user-provided ``foo.bar`` and wipe out the previously-assigned</span>
            <span class="c1"># ``foo.bar.baz``</span>
            <span class="n">targets_to_copy</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">target_to_copy</span> <span class="ow">in</span> <span class="n">targets_to_copy</span><span class="p">:</span>
                <span class="n">_assign_attr</span><span class="p">(</span><span class="n">root</span><span class="p">[</span><span class="n">target_to_copy</span><span class="p">],</span> <span class="bp">self</span><span class="p">,</span> <span class="n">target_to_copy</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Unsupported type &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">root</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; passed for root!&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="n">graph</span>

        <span class="c1"># Store the Tracer class responsible for creating a Graph separately as part of the</span>
        <span class="c1"># GraphModule state, except when the Tracer is defined in a local namespace.</span>
        <span class="c1"># Locally defined Tracers are not pickleable. This is needed because torch.package will</span>
        <span class="c1"># serialize a GraphModule without retaining the Graph, and needs to use the correct Tracer</span>
        <span class="c1"># to re-create the Graph during deserialization.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tracer_cls</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">_tracer_cls</span> <span class="ow">and</span> <span class="s1">&#39;&lt;locals&gt;&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">_tracer_cls</span><span class="o">.</span><span class="vm">__qualname__</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tracer_cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">_tracer_cls</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_tracer_extras</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">_tracer_extras</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tracer_extras</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">_tracer_extras</span></div>

    <span class="c1"># TorchScript breaks trying to compile the graph setter because of the</span>
    <span class="c1"># continued string literal. Issue here: https://github.com/pytorch/pytorch/issues/44842</span>
    <span class="c1">#</span>
    <span class="c1"># Shouldn&#39;t be an issue since these methods shouldn&#39;t be used in TorchScript anyway</span>
    <span class="n">__jit_unused_properties__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;graph&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">graph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Graph</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the ``Graph`` underlying this ``GraphModule``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span>

    <span class="nd">@graph</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">g</span> <span class="p">:</span> <span class="n">Graph</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the underlying ``Graph`` for this ``GraphModule``. This will internally</span>
<span class="sd">        recompile the ``GraphModule`` so that the generated ``forward()`` function</span>
<span class="sd">        corresponds to ``g``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">Graph</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;Expected a Graph instance, but got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">g</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span> <span class="o">=</span> <span class="n">g</span>
        <span class="n">g</span><span class="o">.</span><span class="n">owning_module</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recompile</span><span class="p">()</span>

<div class="viewcode-block" id="GraphModule.to_folder"><a class="viewcode-back" href="../../../fx.html#torch.fx.GraphModule.to_folder">[docs]</a>    <span class="nd">@compatibility</span><span class="p">(</span><span class="n">is_backward_compatible</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">to_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">],</span> <span class="n">module_name</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;FxModule&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dumps out module to ``folder`` with ``module_name`` so that it can be</span>
<span class="sd">        imported with ``from &lt;folder&gt; import &lt;module_name&gt;``</span>

<span class="sd">        Args:</span>

<span class="sd">            folder (Union[str, os.PathLike]): The folder to write the code out to</span>

<span class="sd">            module_name (str): Top-level name to use for the ``Module`` while</span>
<span class="sd">                writing out the code</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
        <span class="n">Path</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">folder</span> <span class="o">/</span> <span class="s1">&#39;state_dict.pt&#39;</span><span class="p">)</span>
        <span class="n">tab</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="mi">4</span>
        <span class="n">model_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">import torch</span>
<span class="s2">from torch.nn import *</span>
<span class="s2">class </span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2">(torch.nn.Module):</span>
<span class="s2">    def __init__(self):</span>
<span class="s2">        super().__init__()</span>
<span class="s2">&quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_gen_model_repr</span><span class="p">(</span><span class="n">module_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">module</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
            <span class="n">safe_reprs</span> <span class="o">=</span> <span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv1d</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv3d</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm3d</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">module</span><span class="p">)</span> <span class="ow">in</span> <span class="n">safe_reprs</span><span class="p">:</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">module</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="n">blobified_modules</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">module_name</span><span class="p">,</span> <span class="n">module</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">named_children</span><span class="p">():</span>
            <span class="n">module_str</span> <span class="o">=</span> <span class="n">_gen_model_repr</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">module</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">module_str</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">module_file</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s1">.pt&#39;</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">module_file</span><span class="p">)</span>
                <span class="n">blobified_modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
                <span class="n">module_repr</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="n">module_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;torch.load(r&#39;</span><span class="si">{</span><span class="n">module_file</span><span class="si">}</span><span class="s2">&#39;) # </span><span class="si">{</span><span class="n">module_repr</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">model_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tab</span><span class="o">*</span><span class="mi">2</span><span class="si">}</span><span class="s2">self.</span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">module_str</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">for</span> <span class="n">buffer_name</span><span class="p">,</span> <span class="n">buffer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">buffer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">model_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tab</span><span class="o">*</span><span class="mi">2</span><span class="si">}</span><span class="s2">self.register_buffer(&#39;</span><span class="si">{</span><span class="n">buffer_name</span><span class="si">}</span><span class="s2">&#39;, torch.empty(</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">buffer</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="si">}</span><span class="s2">, dtype=</span><span class="si">{</span><span class="n">buffer</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">))</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">param</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">model_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tab</span><span class="o">*</span><span class="mi">2</span><span class="si">}</span><span class="s2">self.</span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2"> = torch.nn.Parameter(torch.empty(</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="si">}</span><span class="s2">, dtype=</span><span class="si">{</span><span class="n">param</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">))</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">model_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tab</span><span class="o">*</span><span class="mi">2</span><span class="si">}</span><span class="s2">self.load_state_dict(torch.load(r&#39;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">/state_dict.pt&#39;))</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">model_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_addindent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">module_file</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">/</span> <span class="s1">&#39;module.py&#39;</span>
        <span class="n">module_file</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">model_str</span><span class="p">)</span>

        <span class="n">init_file</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">/</span> <span class="s1">&#39;__init__.py&#39;</span>
        <span class="n">init_file</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="s1">&#39;from .module import *&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">blobified_modules</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Was not able to save the following children modules as reprs -&quot;</span>
                          <span class="sa">f</span><span class="s2">&quot;saved as pickled files instead: </span><span class="si">{</span><span class="n">blobified_modules</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="GraphModule.add_submodule"><a class="viewcode-back" href="../../../fx.html#torch.fx.GraphModule.add_submodule">[docs]</a>    <span class="nd">@compatibility</span><span class="p">(</span><span class="n">is_backward_compatible</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">add_submodule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds the given submodule to ``self``.</span>

<span class="sd">        This installs empty Modules where none exist yet if they are</span>
<span class="sd">        subpaths of ``target``.</span>

<span class="sd">        Args:</span>
<span class="sd">            target: The fully-qualified string name of the new submodule</span>
<span class="sd">                (See example in ``nn.Module.get_submodule`` for how to</span>
<span class="sd">                specify a fully-qualified string.)</span>
<span class="sd">            m: The submodule itself; the actual object we want to</span>
<span class="sd">                install in the current Module</span>

<span class="sd">        Return:</span>
<span class="sd">            bool: Whether or not the submodule could be inserted. For</span>
<span class="sd">                this method to return True, each object in the chain</span>
<span class="sd">                denoted by ``target`` must either a) not exist yet,</span>
<span class="sd">                or b) reference an ``nn.Module`` (not a parameter or</span>
<span class="sd">                other attribute)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">*</span><span class="n">prefix</span><span class="p">,</span> <span class="n">field</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="n">mod</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">prefix</span><span class="p">:</span>

            <span class="n">submod</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">submod</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">submod</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">()</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">submod</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">submod</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="n">mod</span> <span class="o">=</span> <span class="n">submod</span>

        <span class="n">mod</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="GraphModule.delete_submodule"><a class="viewcode-back" href="../../../fx.html#torch.fx.GraphModule.delete_submodule">[docs]</a>    <span class="nd">@compatibility</span><span class="p">(</span><span class="n">is_backward_compatible</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">delete_submodule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deletes the given submodule from ``self``.</span>

<span class="sd">        The module will not be deleted if ``target`` is not a valid</span>
<span class="sd">        target.</span>

<span class="sd">        Args:</span>
<span class="sd">            target: The fully-qualified string name of the new submodule</span>
<span class="sd">                (See example in ``nn.Module.get_submodule`` for how to</span>
<span class="sd">                specify a fully-qualified string.)</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: Whether or not the target string referenced a</span>
<span class="sd">                submodule we want to delete. A return value of ``False``</span>
<span class="sd">                means that the ``target`` was not a valid reference to</span>
<span class="sd">                a submodule.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="n">path</span><span class="p">,</span> <span class="n">target_submod</span> <span class="o">=</span> <span class="n">atoms</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">mod</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c1"># Get the parent module</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="n">mod</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">target_submod</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">target_submod</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="nb">delattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">target_submod</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="GraphModule.delete_all_unused_submodules"><a class="viewcode-back" href="../../../fx.html#torch.fx.GraphModule.delete_all_unused_submodules">[docs]</a>    <span class="nd">@compatibility</span><span class="p">(</span><span class="n">is_backward_compatible</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">delete_all_unused_submodules</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deletes all unused submodules from ``self``.</span>

<span class="sd">        A Module is considered &quot;used&quot; if any one of the following is</span>
<span class="sd">        true:</span>
<span class="sd">        1. It has children that are used</span>
<span class="sd">        2. Its forward is called directly via a ``call_module`` node</span>
<span class="sd">        3. It has a non-Module attribute that is used from a</span>
<span class="sd">        ``get_attr`` node</span>

<span class="sd">        This method can be called to clean up an ``nn.Module`` without</span>
<span class="sd">        manually calling ``delete_submodule`` on each unused submodule.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">used</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;call_module&quot;</span> <span class="ow">or</span> <span class="n">node</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;get_attr&quot;</span><span class="p">:</span>

                <span class="c1"># A list of strings representing the different parts</span>
                <span class="c1"># of the path. For exmaple, `foo.bar.baz` gives us</span>
                <span class="c1"># [&quot;foo&quot;, &quot;bar&quot;, &quot;baz&quot;]</span>
                <span class="n">fullpath</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>

                <span class="c1"># If we&#39;re looking at multiple parts of a path, join</span>
                <span class="c1"># join them with a dot. Otherwise, return that single</span>
                <span class="c1"># element without doing anything to it.</span>
                <span class="k">def</span> <span class="nf">join_fn</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="k">if</span> <span class="n">y</span> <span class="k">else</span> <span class="p">[</span><span class="n">x</span><span class="p">])</span>

                <span class="c1"># Progressively collect all the names of intermediate</span>
                <span class="c1"># modules. For example, if we have the target</span>
                <span class="c1"># `foo.bar.baz`, we&#39;ll add `foo`, `foo.bar`, and</span>
                <span class="c1"># `foo.bar.baz` to the list.</span>
                <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">fullpath</span><span class="p">,</span> <span class="n">join_fn</span><span class="p">):</span>
                    <span class="n">used</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

                <span class="c1"># For a `call_module` node, also register all recursive submodules</span>
                <span class="c1"># as used</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;call_module&quot;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">submod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_submodule</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>

                        <span class="k">for</span> <span class="n">submod_name</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">submod</span><span class="o">.</span><span class="n">named_modules</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">submod_name</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                                <span class="n">used</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">submod_name</span><span class="p">]))</span>
                    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                        <span class="c1"># Node referenced nonexistent submodule, don&#39;t need to</span>
                        <span class="c1"># worry about GCing anything</span>
                        <span class="k">pass</span>

        <span class="n">to_delete</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">named_modules</span><span class="p">()</span>
                     <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">to_delete</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete_submodule</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">code</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the Python code generated from the ``Graph`` underlying this</span>
<span class="sd">        ``GraphModule``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_code&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Code has not been generated! Please report a bug to PyTorch&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_code</span>

<div class="viewcode-block" id="GraphModule.recompile"><a class="viewcode-back" href="../../../fx.html#torch.fx.GraphModule.recompile">[docs]</a>    <span class="nd">@compatibility</span><span class="p">(</span><span class="n">is_backward_compatible</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">recompile</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PythonCode</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recompile this GraphModule from its ``graph`` attribute. This should be</span>
<span class="sd">        called after editing the contained ``graph``, otherwise the generated</span>
<span class="sd">        code of this ``GraphModule`` will be out of date.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">_codegen</span><span class="p">,</span> <span class="n">_PyTreeCodeGen</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_in_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">_codegen</span><span class="o">.</span><span class="n">pytree_info</span><span class="o">.</span><span class="n">in_spec</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_out_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">_codegen</span><span class="o">.</span><span class="n">pytree_info</span><span class="o">.</span><span class="n">out_spec</span>
        <span class="n">python_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">python_code</span><span class="p">(</span><span class="n">root_module</span><span class="o">=</span><span class="s1">&#39;self&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_code</span> <span class="o">=</span> <span class="n">python_code</span><span class="o">.</span><span class="n">src</span>

        <span class="bp">cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">forward</span> <span class="o">=</span> <span class="n">_forward_from_src</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_code</span><span class="p">,</span> <span class="n">python_code</span><span class="o">.</span><span class="n">globals</span><span class="p">)</span>

        <span class="c1"># Determine whether this class explicitly defines a __call__ implementation</span>
        <span class="c1"># to wrap. If it does, save it in order to have wrapped_call invoke it.</span>
        <span class="c1"># If it does not, wrapped_call can use a dynamic call to super() instead.</span>
        <span class="c1"># In most cases, super().__call__ should be torch.nn.Module.__call__.</span>
        <span class="c1"># We do not want to hold a reference to Module.__call__ here; doing so will</span>
        <span class="c1"># bypass patching of torch.nn.Module.__call__ done while symbolic tracing.</span>
        <span class="n">cls_call</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__call__</span> <span class="k">if</span> <span class="s2">&quot;__call__&quot;</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="s1">&#39;_wrapped_call&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_wrapped_call</span> <span class="o">=</span> <span class="n">_WrappedCall</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">cls_call</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>

        <span class="k">def</span> <span class="nf">call_wrapped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrapped_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">cls</span><span class="o">.</span><span class="fm">__call__</span> <span class="o">=</span> <span class="n">call_wrapped</span>

        <span class="k">return</span> <span class="n">python_code</span></div>

    <span class="c1"># Passing Tracer as argument allows subclasses extending fx.GraphModule</span>
    <span class="c1"># define their own Tracer (extending fx.Tracer).</span>
    <span class="k">def</span> <span class="nf">__reduce_deploy__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">importer</span><span class="p">:</span> <span class="n">Importer</span><span class="p">):</span>
        <span class="n">dict_without_graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">dict_without_graph</span><span class="p">[</span><span class="s1">&#39;_graphmodule_cls_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">del</span> <span class="n">dict_without_graph</span><span class="p">[</span><span class="s1">&#39;_graph&#39;</span><span class="p">]</span>

        <span class="n">python_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recompile</span><span class="p">()</span>
        <span class="n">import_block</span> <span class="o">=</span> <span class="n">_format_import_block</span><span class="p">(</span><span class="n">python_code</span><span class="o">.</span><span class="n">globals</span><span class="p">,</span> <span class="n">importer</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">reduce_deploy_graph_module</span><span class="p">,</span> <span class="p">(</span><span class="n">dict_without_graph</span><span class="p">,</span> <span class="n">import_block</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__reduce_package__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exporter</span><span class="p">:</span> <span class="n">PackageExporter</span><span class="p">):</span>
        <span class="n">dict_without_graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">dict_without_graph</span><span class="p">[</span><span class="s1">&#39;_graphmodule_cls_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">del</span> <span class="n">dict_without_graph</span><span class="p">[</span><span class="s1">&#39;_graph&#39;</span><span class="p">]</span>

        <span class="n">generated_module_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;fx-generated._</span><span class="si">{</span><span class="n">exporter</span><span class="o">.</span><span class="n">get_unique_id</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">python_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recompile</span><span class="p">()</span>
        <span class="n">import_block</span> <span class="o">=</span> <span class="n">_format_import_block</span><span class="p">(</span><span class="n">python_code</span><span class="o">.</span><span class="n">globals</span><span class="p">,</span> <span class="n">exporter</span><span class="o">.</span><span class="n">importer</span><span class="p">)</span>
        <span class="n">module_code</span> <span class="o">=</span> <span class="n">import_block</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">code</span>
        <span class="n">exporter</span><span class="o">.</span><span class="n">save_source_string</span><span class="p">(</span><span class="n">generated_module_name</span><span class="p">,</span> <span class="n">module_code</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">reduce_package_graph_module</span><span class="p">,</span> <span class="p">(</span><span class="n">dict_without_graph</span><span class="p">,</span> <span class="n">generated_module_name</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Serialization of GraphModule. We serialize only the generated code, not</span>
<span class="sd">        the underlying ``Graph``. This is because ``Graph`` does not have on-disk</span>
<span class="sd">        backward-compatibility guarantees, whereas Python source code does.</span>
<span class="sd">        On the deserialization side, we symbolically trace through the generated</span>
<span class="sd">        code to regenerate the underlying ``Graph``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dict_without_graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">python_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recompile</span><span class="p">()</span>
        <span class="n">import_block</span> <span class="o">=</span> <span class="n">_format_import_block</span><span class="p">(</span><span class="n">python_code</span><span class="o">.</span><span class="n">globals</span><span class="p">,</span> <span class="n">sys_importer</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">dict_without_graph</span><span class="p">[</span><span class="s1">&#39;_graph&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">reduce_graph_module</span><span class="p">,</span> <span class="p">(</span><span class="n">dict_without_graph</span><span class="p">,</span> <span class="n">import_block</span><span class="p">))</span>

    <span class="c1"># because __reduce__ is defined for serialization,</span>
    <span class="c1"># we need to define deepcopy otherwise it will call __reduce__</span>
    <span class="c1"># and cause symbolic tracing to occur every time we try to copy the object</span>
    <span class="k">def</span> <span class="nf">__deepcopy__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="n">fake_mod</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">()</span>
        <span class="n">fake_mod</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">GraphModule</span><span class="p">(</span><span class="n">fake_mod</span><span class="p">,</span> <span class="n">fake_mod</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_graph&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__copy__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">GraphModule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">orig_str</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">orig_str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_code</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_replicate_for_data_parallel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">new_gm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__copy__</span><span class="p">()</span>
        <span class="n">new_gm</span><span class="o">.</span><span class="n">_is_replica</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">new_gm</span></div>

<span class="c1"># workarounds for issues in __torch_function__</span>

<span class="c1"># WAR for __torch_function__ not handling tensor lists,</span>
<span class="c1"># fix is in https://github.com/pytorch/pytorch/pull/34725</span>
<span class="c1"># orig_cat = torch.cat</span>
<span class="c1"># def patched_cat(*args, **kwargs):</span>
<span class="c1">#     tensors = args[0]</span>
<span class="c1">#     for t in tensors:</span>
<span class="c1">#         if isinstance(t, Proxy):</span>
<span class="c1">#             return t.__torch_function__(patched_cat, (), args, kwargs)</span>
<span class="c1">#     return orig_cat(*args, **kwargs)</span>
<span class="c1"># patched_cat.__module__ = &#39;torch&#39;</span>
<span class="c1"># patched_cat.__name__ = &#39;cat&#39;</span>
<span class="c1"># torch.cat = patched_cat</span>
</pre></div>

             </article>
             
            </div>
            <footer>
  

  

    <hr>

  

  <div role="contentinfo">
    <p>
        &copy; Copyright 2022, PyTorch Contributors.

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>
     

</footer>

          </div>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              
            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
         <script src="../../../_static/jquery.js"></script>
         <script src="../../../_static/underscore.js"></script>
         <script src="../../../_static/doctools.js"></script>
         <script src="../../../_static/clipboard.min.js"></script>
         <script src="../../../_static/copybutton.js"></script>
     

  

  <script type="text/javascript" src="../../../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 
<script script type="text/javascript">
  var collapsedSections = ['Notes', 'Language Bindings', 'Libraries', 'Community'];
</script>

<img height="1" width="1" style="border-style:none;" alt="" src="https://www.googleadservices.com/pagead/conversion/795629140/?label=txkmCPmdtosBENSssfsC&amp;guid=ON&amp;script=0"/>


  <!-- Begin Footer -->

  <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
    <div class="container">
      <div class="row">
        <div class="col-md-4 text-center">
          <h2>Docs</h2>
          <p>Access comprehensive developer documentation for PyTorch</p>
          <a class="with-right-arrow" href="https://pytorch.org/docs/stable/index.html">View Docs</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Tutorials</h2>
          <p>Get in-depth tutorials for beginners and advanced developers</p>
          <a class="with-right-arrow" href="https://pytorch.org/tutorials">View Tutorials</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Resources</h2>
          <p>Find development resources and get your questions answered</p>
          <a class="with-right-arrow" href="https://pytorch.org/resources">View Resources</a>
        </div>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container footer-container">
      <div class="footer-logo-wrapper">
        <a href="https://pytorch.org/" class="footer-logo"></a>
      </div>

      <div class="footer-links-wrapper">
        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/">PyTorch</a></li>
            <li><a href="https://pytorch.org/get-started">Get Started</a></li>
            <li><a href="https://pytorch.org/features">Features</a></li>
            <li><a href="https://pytorch.org/ecosystem">Ecosystem</a></li>
            <li><a href="https://pytorch.org/blog/">Blog</a></li>
            <li><a href="https://github.com/pytorch/pytorch/blob/master/CONTRIBUTING.md">Contributing</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/resources">Resources</a></li>
            <li><a href="https://pytorch.org/tutorials">Tutorials</a></li>
            <li><a href="https://pytorch.org/docs/stable/index.html">Docs</a></li>
            <li><a href="https://discuss.pytorch.org" target="_blank">Discuss</a></li>
            <li><a href="https://github.com/pytorch/pytorch/issues" target="_blank">Github Issues</a></li>
            <li><a href="https://pytorch.org/assets/brand-guidelines/PyTorch-Brand-Guidelines.pdf" target="_blank">Brand Guidelines</a></li>
          </ul>
        </div>

        <div class="footer-links-col follow-us-col">
          <ul>
            <li class="list-title">Stay Connected</li>
          </ul>

          <div class="footer-social-icons">
            <a href="https://www.facebook.com/pytorch" target="_blank" class="facebook"></a>
            <a href="https://twitter.com/pytorch" target="_blank" class="twitter"></a>
            <a href="https://www.youtube.com/pytorch" target="_blank" class="youtube"></a>
          </div>
        </div>
      </div>
    </div>
  </footer>

  <div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebookâ€™s Cookies Policy applies. Learn more, including about available controls: <a href="https://www.facebook.com/policies/cookies/">Cookies Policy</a>.</p>
    <img class="close-button" src="../../../_static/images/pytorch-x.svg">
  </div>
</div>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>

          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/hub">PyTorch Hub</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li class="resources-mobile-menu-title" class="active">
            Docs
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/docs/stable/index.html">PyTorch</a>
            </li>

            <li>
              <a href="https://pytorch.org/audio/stable/index.html">torchaudio</a>
            </li>

            <li>
              <a href="https://pytorch.org/text/stable/index.html">torchtext</a>
            </li>

            <li>
              <a href="https://pytorch.org/vision/stable/index.html">torchvision</a>
            </li>

            <li>
              <a href="https://pytorch.org/serve/">TorchServe</a>
            </li>

            <li>
              <a href="https://pytorch.org/torchx/">TorchX</a>
            </li>

            <li>
              <a href="https://pytorch.org/xla">PyTorch on XLA Devices</a>
            </li>
          </ul>

          <li class="resources-mobile-menu-title">
            Resources
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/resources">Developer Resources</a>
            </li>

            <li>
              <a href="https://pytorch.org/features">About</a>
            </li>

            <li>
              <a href="https://pytorch.org/hub">Models (Beta)</a>
            </li>

            <li>
              <a href="https://pytorch.org/#community-module">Community</a>
            </li>

            <li>
              <a href="https://discuss.pytorch.org/">Forums</a>
            </li>
          </ul>

          <li>
            <a href="https://github.com/pytorch/pytorch">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="../../../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>