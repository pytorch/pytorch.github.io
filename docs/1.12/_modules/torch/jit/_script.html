


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta name="robots" content="noindex">
  <meta name="robots" content="noindex">
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>torch.jit._script &mdash; PyTorch 1.12 documentation</title>
  

  
  
  
  
    <link rel="canonical" href="https://pytorch.org/docs/stable/_modules/torch/jit/_script.html"/>
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.css" type="text/css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/katex-math.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/jit.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />


  <!-- Google Analytics -->
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-117752657-2"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-117752657-2');
    </script>
  
  <!-- End Google Analytics -->
  


  
  <script src="../../../_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>

          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li class="active docs-active">
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-orange-arrow">
                Docs
              </a>
              <div class="resources-dropdown-menu">
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/docs/stable/index.html">
                  <span class="dropdown-title">PyTorch</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/audio/stable/index.html">
                  <span class="dropdown-title">torchaudio</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/text/stable/index.html">
                  <span class="dropdown-title">torchtext</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/vision/stable/index.html">
                  <span class="dropdown-title">torchvision</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torchrec">
                  <span class="dropdown-title">TorchRec</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/data">
                  <span class="dropdown-title">TorchData</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/serve/">
                  <span class="dropdown-title">TorchServe</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torchx/">
                  <span class="dropdown-title">TorchX</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/xla">
                  <span class="dropdown-title">PyTorch on XLA Devices</span>
                  <p></p>
                </a>
            </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-arrow">
                Resources
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/features">
                  <span class="dropdown-title">About</span>
                  <p>Learn about PyTorchâ€™s features and capabilities</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/#community-module">
                  <span class="dropdown-title">Community</span>
                  <p>Join the PyTorch developer community to contribute, learn, and get your questions answered.</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/resources">
                  <span class="dropdown-title">Developer Resources</span>
                  <p>Find resources and get questions answered</p>
                </a>
                <a class="nav-dropdown-item" href="https://discuss.pytorch.org/" target="_blank">
                  <span class="dropdown-title">Forums</span>
                  <p>A place to discuss PyTorch code, issues, install, research</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/hub">
                  <span class="dropdown-title">Models (Beta)</span>
                  <p>Discover, publish, and reuse pre-trained models</p>
                </a>
              </div>
            </div>
          </li>

          <li>
            <a href="https://github.com/pytorch/pytorch">GitHub</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>

<body class="pytorch-body">

   

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            
    <div class="version">
      <a href='https://pytorch.org/docs/versions.html'>1.12 &#x25BC</a>
    </div>
    


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          </div>

          


            
            
              
            
            
              <p class="caption"><span class="caption-text">Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/amp_examples.html">CUDA Automatic Mixed Precision examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/autograd.html">Autograd mechanics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/broadcasting.html">Broadcasting semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/cpu_threading_torchscript_inference.html">CPU threading and TorchScript inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/cuda.html">CUDA semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/ddp.html">Distributed Data Parallel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/extending.html">Extending PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/gradcheck.html">Gradcheck mechanics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/hip.html">HIP (ROCm) semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/large_scale_deployments.html">Features for large-scale deployments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/modules.html">Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/mps.html">MPS backend</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/multiprocessing.html">Multiprocessing best practices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/numerical_accuracy.html">Numerical accuracy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/randomness.html">Reproducibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/serialization.html">Serialization semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/windows.html">Windows FAQ</a></li>
</ul>
<p class="caption"><span class="caption-text">Language Bindings</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../cpp_index.html">C++</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/javadoc/">Javadoc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../deploy.html">torch::deploy</a></li>
</ul>
<p class="caption"><span class="caption-text">Python API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../torch.html">torch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nn.html">torch.nn</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nn.functional.html">torch.nn.functional</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tensors.html">torch.Tensor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tensor_attributes.html">Tensor Attributes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tensor_view.html">Tensor Views</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../amp.html">torch.amp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../autograd.html">torch.autograd</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../library.html">torch.library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cuda.html">torch.cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../backends.html">torch.backends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.html">torch.distributed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.algorithms.join.html">torch.distributed.algorithms.join</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.elastic.html">torch.distributed.elastic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fsdp.html">torch.distributed.fsdp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.optim.html">torch.distributed.optim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributions.html">torch.distributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fft.html">torch.fft</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../futures.html">torch.futures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fx.html">torch.fx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hub.html">torch.hub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../jit.html">torch.jit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../linalg.html">torch.linalg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../monitor.html">torch.monitor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../special.html">torch.special</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../torch.overrides.html">torch.overrides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../package.html">torch.package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../profiler.html">torch.profiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nn.init.html">torch.nn.init</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../onnx.html">torch.onnx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../optim.html">torch.optim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../complex_numbers.html">Complex Numbers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ddp_comm_hooks.html">DDP Communication Hooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pipeline.html">Pipeline Parallelism</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quantization.html">Quantization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rpc.html">Distributed RPC Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../random.html">torch.random</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nested.html">torch.nested</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sparse.html">torch.sparse</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../storage.html">torch.Storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../testing.html">torch.testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../benchmark_utils.html">torch.utils.benchmark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../bottleneck.html">torch.utils.bottleneck</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../checkpoint.html">torch.utils.checkpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cpp_extension.html">torch.utils.cpp_extension</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data.html">torch.utils.data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dlpack.html">torch.utils.dlpack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mobile_optimizer.html">torch.utils.mobile_optimizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../model_zoo.html">torch.utils.model_zoo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tensorboard.html">torch.utils.tensorboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../type_info.html">Type Info</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../named_tensor.html">Named Tensors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../name_inference.html">Named Tensors operator coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../config_mod.html">torch.__config__</a></li>
</ul>
<p class="caption"><span class="caption-text">Libraries</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/audio/stable">torchaudio</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/data">TorchData</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/torchrec">TorchRec</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/serve">TorchServe</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/text/stable">torchtext</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/vision/stable">torchvision</a></li>
<li class="toctree-l1"><a class="reference external" href="http://pytorch.org/xla/">PyTorch on XLA Devices</a></li>
</ul>
<p class="caption"><span class="caption-text">Community</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../community/contribution_guide.html">PyTorch Contribution Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/governance.html">PyTorch Governance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/persons_of_interest.html">PyTorch Governance | Persons of Interest</a></li>
</ul>

            
          

        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="../../../index.html">
          
            Docs
          
        </a> &gt;
      </li>

        
          <li><a href="../../index.html">Module code</a> &gt;</li>
        
          <li><a href="../../torch.html">torch</a> &gt;</li>
        
          <li><a href="../jit.html">torch.jit</a> &gt;</li>
        
      <li>torch.jit._script</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">

        
          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <h1>Source code for torch.jit._script</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;TorchScript</span>

<span class="sd">This module contains functionality to support the JIT&#39;s scripting frontend, notably:</span>
<span class="sd">    - torch.jit.script</span>

<span class="sd">This is not intended to be imported directly; please use the exposed</span>
<span class="sd">functionalities in `torch.jit`.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">enum</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Callable</span>


<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch._jit_internal</span> <span class="k">as</span> <span class="nn">_jit_internal</span>
<span class="kn">from</span> <span class="nn">torch.utils</span> <span class="kn">import</span> <span class="n">set_module</span>
<span class="kn">from</span> <span class="nn">torch.jit._recursive</span> <span class="kn">import</span> <span class="n">ScriptMethodStub</span><span class="p">,</span> <span class="n">wrap_cpp_module</span><span class="p">,</span> <span class="n">infer_methods_to_compile</span><span class="p">,</span> <span class="n">_compile_and_register_class</span>
<span class="kn">from</span> <span class="nn">torch.nn</span> <span class="kn">import</span> <span class="n">Module</span>
<span class="kn">from</span> <span class="nn">torch.jit._state</span> <span class="kn">import</span> <span class="n">_enabled</span>
<span class="kn">from</span> <span class="nn">torch.jit._builtins</span> <span class="kn">import</span> <span class="n">_register_builtin</span>
<span class="kn">from</span> <span class="nn">torch._six</span> <span class="kn">import</span> <span class="n">with_metaclass</span>
<span class="kn">from</span> <span class="nn">torch.jit.frontend</span> <span class="kn">import</span> <span class="n">get_jit_def</span><span class="p">,</span> <span class="n">get_default_args</span><span class="p">,</span> <span class="n">get_jit_class_def</span>
<span class="kn">from</span> <span class="nn">torch._jit_internal</span> <span class="kn">import</span> <span class="n">_qualified_name</span>
<span class="kn">from</span> <span class="nn">torch.jit._fuser</span> <span class="kn">import</span> <span class="n">_graph_for</span><span class="p">,</span> <span class="n">_script_method_graph_for</span>
<span class="kn">from</span> <span class="nn">torch.jit._state</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">_try_get_jit_cached_function</span><span class="p">,</span>
    <span class="n">_try_get_jit_cached_overloads</span><span class="p">,</span>
    <span class="n">_set_jit_function_cache</span><span class="p">,</span>
    <span class="n">_set_jit_overload_cache</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">torch.overrides</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">has_torch_function</span><span class="p">,</span> <span class="n">has_torch_function_unary</span><span class="p">,</span> <span class="n">has_torch_function_variadic</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">torch.package</span> <span class="kn">import</span> <span class="n">PackageExporter</span><span class="p">,</span> <span class="n">PackageImporter</span>
<span class="kn">from</span> <span class="nn">._serialization</span> <span class="kn">import</span> <span class="n">validate_map_location</span>

<span class="kn">from</span> <span class="nn">torch.jit._monkeytype_config</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">monkeytype_trace</span><span class="p">,</span>
    <span class="n">JitTypeTraceConfig</span> <span class="p">,</span>
    <span class="n">JitTypeTraceStore</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">torch._classes</span> <span class="kn">import</span> <span class="n">classes</span>

<span class="n">type_trace_db</span> <span class="o">=</span> <span class="n">JitTypeTraceStore</span><span class="p">()</span>  <span class="c1"># DB to hold all call traces from MonkeyType</span>

<span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">ScriptMethod</span><span class="o">.</span><span class="n">graph_for</span> <span class="o">=</span> <span class="n">_script_method_graph_for</span>  <span class="c1"># type: ignore[attr-defined]</span>
<span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">ScriptFunction</span><span class="o">.</span><span class="n">graph_for</span> <span class="o">=</span> <span class="n">_graph_for</span>  <span class="c1"># type: ignore[attr-defined]</span>
<span class="n">ScriptFunction</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">ScriptFunction</span>
<span class="n">ScriptFunction</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Functionally equivalent to a :class:`ScriptModule`, but represents a single</span>
<span class="s2">function and does not have any attributes or Parameters.</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">set_module</span><span class="p">(</span><span class="n">ScriptFunction</span><span class="p">,</span> <span class="s2">&quot;torch.jit&quot;</span><span class="p">)</span>

<span class="c1"># Throws an error if a jit function is pickled.</span>
<span class="c1"># Helps to avoid Python crashes for Python versions 3.9.5 + when protocol 0 or 1 is given as an argument.</span>
<span class="k">def</span> <span class="nf">_reduce</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PickleError</span><span class="p">(</span><span class="s2">&quot;ScriptFunction cannot be pickled&quot;</span><span class="p">)</span>

<span class="n">ScriptFunction</span><span class="o">.</span><span class="n">__reduce__</span> <span class="o">=</span> <span class="n">_reduce</span>  <span class="c1"># type: ignore[assignment]</span>


<span class="k">if</span> <span class="n">_enabled</span><span class="p">:</span>
    <span class="n">Attribute</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;Attribute&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">])</span>
<span class="k">else</span><span class="p">:</span>

<div class="viewcode-block" id="Attribute"><a class="viewcode-back" href="../../../generated/torch.jit.Attribute.html#torch.jit.Attribute">[docs]</a>    <span class="k">def</span> <span class="nf">Attribute</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>  <span class="c1"># type: ignore[no-redef]</span>
        <span class="k">return</span> <span class="n">value</span></div>

<span class="n">Attribute</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    This method is a pass-through function that returns `value`, mostly</span>
<span class="s2">    used to indicate to the TorchScript compiler that the left-hand side</span>
<span class="s2">    expression is a class instance attribute with type of `type`. Note that</span>
<span class="s2">    `torch.jit.Attribute` should only be used in `__init__` method of `jit.ScriptModule`</span>
<span class="s2">    subclasses.</span>

<span class="s2">    Though TorchScript can infer correct type for most Python expressions, there are some cases where</span>
<span class="s2">    type inference can be wrong, including:</span>

<span class="s2">    - Empty containers like `[]` and `</span><span class="si">{}</span><span class="s2">`, which TorchScript assumes to be container of `Tensor`</span>
<span class="s2">    - Optional types like `Optional[T]` but assigned a valid value of type `T`, TorchScript would assume</span>
<span class="s2">      it is type `T` rather than `Optional[T]`</span>

<span class="s2">    In eager mode, it is simply a pass-through function that returns `value`</span>
<span class="s2">    without other implications.</span>

<span class="s2">    Example:</span>

<span class="s2">    .. testcode::</span>

<span class="s2">        import torch</span>
<span class="s2">        from typing import Dict</span>

<span class="s2">        class AttributeModule(torch.jit.ScriptModule):</span>
<span class="s2">            def __init__(self):</span>
<span class="s2">                super(AttributeModule, self).__init__()</span>
<span class="s2">                self.foo = torch.jit.Attribute(0.1, float)</span>

<span class="s2">                # we should be able to use self.foo as a float here</span>
<span class="s2">                assert 0.0 &lt; self.foo</span>

<span class="s2">                self.names_ages = torch.jit.Attribute(</span><span class="si">{}</span><span class="s2">, Dict[str, int])</span>
<span class="s2">                self.names_ages[&quot;someone&quot;] = 20</span>
<span class="s2">                assert isinstance(self.names_ages[&quot;someone&quot;], int)</span>

<span class="s2">        m = AttributeModule()</span>
<span class="s2">        # m will contain two attributes</span>
<span class="s2">        # 1. foo of type float</span>
<span class="s2">        # 2. names_ages of type Dict[str, int]</span>

<span class="s2">    .. testcleanup::</span>

<span class="s2">        del AttributeModule</span>
<span class="s2">        del m</span>

<span class="s2">    Note: it&#39;s now preferred to instead use type annotations instead of `torch.jit.Annotate`:</span>

<span class="s2">    .. testcode::</span>

<span class="s2">        import torch</span>
<span class="s2">        from typing import Dict</span>

<span class="s2">        class AttributeModule(torch.nn.Module):</span>
<span class="s2">            names: Dict[str, int]</span>

<span class="s2">            def __init__(self):</span>
<span class="s2">                super(AttributeModule, self).__init__()</span>
<span class="s2">                self.names = </span><span class="si">{}</span><span class="s2"></span>

<span class="s2">        m = AttributeModule()</span>

<span class="s2">    .. testcleanup::</span>

<span class="s2">        del AttributeModule</span>
<span class="s2">        del m</span>

<span class="s2">    Args:</span>
<span class="s2">        value: An initial value to be assigned to attribute.</span>
<span class="s2">        type: A Python type</span>

<span class="s2">    Returns:</span>
<span class="s2">        Returns `value`</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="k">def</span> <span class="nf">_get_type_trace_db</span><span class="p">():</span>
    <span class="c1"># This is a private API. Use of this for external purposes is discouraged.</span>
    <span class="k">return</span> <span class="n">type_trace_db</span>

<span class="c1"># Gets a function from the name of a method on a type</span>
<span class="k">def</span> <span class="nf">_get_function_from_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>


<span class="c1"># ScriptClasses must be new-style classes because we construct them using their</span>
<span class="c1"># __new__ method.</span>
<span class="k">def</span> <span class="nf">_is_new_style_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;__class__&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;__dict__&quot;</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;__slots__&quot;</span><span class="p">)</span>


<span class="c1"># These OrderedDictWrapper classes replace the actual OrderedDicts in</span>
<span class="c1"># module with versions that get/set properties inside of Module.</span>
<span class="c1"># This allows us to reuse most of nn.Module while still storing the</span>
<span class="c1"># data in C++.</span>
<span class="c1"># Each OrderedDict needs to support:</span>
<span class="c1">#  x not in view</span>
<span class="c1">#  x in view</span>
<span class="c1">#  view[name] = ...</span>
<span class="c1">#  view.values()</span>
<span class="c1">#  del view[name]</span>
<span class="c1">#  view.items()</span>
<span class="c1">#  view.keys()</span>
<span class="c1">#  len(view)</span>


<span class="k">class</span> <span class="nc">OrderedDictWrapper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_c</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_c</span> <span class="o">=</span> <span class="n">_c</span>

    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;cannot delete methods or parameters of a script module&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Can&#39;t add a new parameter after ScriptModule construction.&quot;</span>
                <span class="s2">&quot; Tried to add &#39;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">getattr</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">OrderedModuleDict</span><span class="p">(</span><span class="n">OrderedDictWrapper</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">python_dict</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OrderedModuleDict</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
        <span class="c1"># contains _both_ script modules and non-script python-only modules</span>

        <span class="c1"># because script modules are subclassed in python and the</span>
        <span class="c1"># C++ Module class will not hold references to them,</span>
        <span class="c1"># to ensure that you always get the same python value here</span>
        <span class="c1"># we store it in the python dict as well</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_python_modules</span> <span class="o">=</span> <span class="n">python_dict</span>

    <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_python_modules</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">r</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_python_modules</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="c1"># Cases where sub-module can be re-assigned after ScriptModule construction</span>
        <span class="c1"># 1. If the attr is an module interface type, it&#39;s guaranteed that the module is</span>
        <span class="c1">#    not inlined in the graph, so it&#39;s safe to swap a new ScriptModule in.</span>
        <span class="c1"># 2. if the new value if a ScriptModule with the same JIT type, IR won&#39;t change</span>
        <span class="c1">#    and it&#39;s legit to swap a new module in.</span>
        <span class="c1"># In these two cases we allow swapping a new scripted module and update the</span>
        <span class="c1"># corresponding python module dict to keep sync.</span>
        <span class="c1"># Note: the value to be swapped in has to be ScriptModule instead of nn.Module,</span>
        <span class="c1"># otherwise it&#39;s illegal and we throw error.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">ScriptModule</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_python_modules</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot re-assign modules in a ScriptModule with non-scripted &quot;</span>
                <span class="s2">&quot;module, tried to replace existing module &#39;</span><span class="si">{}</span><span class="s2">&#39;: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_python_modules</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>


<span class="c1"># For each user-defined class that subclasses ScriptModule, this meta-class:</span>
<span class="c1"># (1) finds all the methods annotated with @script_method in a ScriptModule and</span>
<span class="c1">#     removes them from the class attributes</span>
<span class="c1"># (2) puts a wrapper around the class&#39;s __init__ method to recursively compile</span>
<span class="c1">#     all of the script_methods with the module after the original __init__ has</span>
<span class="c1">#     run. This has to occur after the user-defined __init__ so that submodules and</span>
<span class="c1">#     parameters are initialized _before_ the script compiler resolve references to</span>
<span class="c1">#     `self.param` or `self.module`.</span>
<span class="k">class</span> <span class="nc">ScriptMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>  <span class="c1"># noqa: B902</span>
        <span class="c1"># Aggregate all the ScriptMethods and constants from superclasses</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_methods</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_constants_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;__constants__&quot;</span><span class="p">,</span> <span class="p">()))</span>
        <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">bases</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="s2">&quot;_methods&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">_methods</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="n">base_constants</span><span class="p">:</span> <span class="n">Set</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="s2">&quot;_constants_set&quot;</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_constants_set</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_constants_set</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">base_constants</span><span class="p">)</span>

        <span class="c1"># find all the script methods of the current class</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">ScriptMethodStub</span><span class="p">):</span>
                <span class="nb">delattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">_methods</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">original_method</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;_disable_script_meta&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="c1"># We leave built-in ScriptModule types alone, since this metaclass</span>
            <span class="c1"># is only for compiling user classes that inherit from</span>
            <span class="c1"># ScriptModule.</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">ScriptMeta</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>

        <span class="n">original_init</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;__init__&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="kc">None</span><span class="p">)</span>

        <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">original_init</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">init_then_script</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">num_methods</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_methods</span><span class="p">)</span>
            <span class="n">original_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">added_methods_in_init</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_methods</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">num_methods</span>

            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="bp">cls</span><span class="p">:</span>

                <span class="k">def</span> <span class="nf">make_stubs</span><span class="p">(</span><span class="n">module</span><span class="p">):</span>
                    <span class="bp">cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;_methods&quot;</span><span class="p">):</span>
                        <span class="k">return</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_methods</span><span class="o">.</span><span class="n">items</span><span class="p">())]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">infer_methods_to_compile</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span>
                    <span class="s2">&quot;_actual_script_module&quot;</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">_recursive</span><span class="o">.</span><span class="n">create_script_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">make_stubs</span><span class="p">,</span> <span class="n">share_types</span><span class="o">=</span><span class="ow">not</span> <span class="n">added_methods_in_init</span><span class="p">)</span>

                <span class="c1"># Delete the Python attributes that now shadow the ScriptModule</span>
                <span class="c1"># ones, so that __getattr__ and __setattr__ will properly find</span>
                <span class="c1"># the scripted versions.</span>
                <span class="n">concrete_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_actual_script_module</span><span class="o">.</span><span class="n">_concrete_type</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">concrete_type</span><span class="o">.</span><span class="n">get_attributes</span><span class="p">():</span>
                    <span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">concrete_type</span><span class="o">.</span><span class="n">get_modules</span><span class="p">():</span>
                    <span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;_parameters&quot;</span><span class="p">,</span> <span class="s2">&quot;_buffers&quot;</span><span class="p">,</span> <span class="s2">&quot;_modules&quot;</span><span class="p">):</span>
                    <span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="bp">cls</span><span class="o">.</span><span class="fm">__init__</span> <span class="o">=</span> <span class="n">init_then_script</span>  <span class="c1"># type: ignore[misc]</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ScriptMeta</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_CachedForward</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span><span class="s2">&quot;forward&quot;</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>


<span class="k">class</span> <span class="nc">ScriptWarning</span><span class="p">(</span><span class="ne">Warning</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">def</span> <span class="nf">script_method</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_enabled</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fn</span>
    <span class="c1"># NOTE: we need to traverse two frames here because the meta-class frame</span>
    <span class="c1"># for ScriptModule will be present, as opposed to invoking @script on a</span>
    <span class="c1"># a function or invoking define() on a CompilationUnit.</span>
    <span class="c1"># The stack will look like:</span>
    <span class="c1">#</span>
    <span class="c1"># 0. createResolutionCallback()</span>
    <span class="c1"># 1. script_method()</span>
    <span class="c1"># 2. ScriptModule metaclass frame</span>
    <span class="c1"># 3. Surrounding scope</span>
    <span class="c1">#</span>
    <span class="c1"># createResolutionCallback internally adds 1 to get us to the scope of this</span>
    <span class="c1"># function (the calling function). Adding 2 gets us to the proper surrounding scope.</span>
    <span class="n">_rcb</span> <span class="o">=</span> <span class="n">_jit_internal</span><span class="o">.</span><span class="n">createResolutionCallbackFromFrame</span><span class="p">(</span><span class="n">frames_up</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">ast</span> <span class="o">=</span> <span class="n">get_jit_def</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">self_name</span><span class="o">=</span><span class="s2">&quot;ScriptModule&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ScriptMethodStub</span><span class="p">(</span><span class="n">_rcb</span><span class="p">,</span> <span class="n">ast</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ConstMap</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">const_mapping</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">const_mapping</span> <span class="o">=</span> <span class="n">const_mapping</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">const_mapping</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">unpackage_script_module</span><span class="p">(</span><span class="n">importer</span><span class="p">:</span> <span class="n">PackageImporter</span><span class="p">,</span> <span class="n">script_module_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Called by ``torch.package.PackageImporter``&#39;s Pickler&#39;s ``persistent_load`` function.</span>
<span class="sd">    Performs work of loading and returning a ScriptModule from a ``torch.package`` archive.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">importer</span><span class="o">.</span><span class="n">zip_reader</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">PyTorchFileReader</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;Loading ScriptObjects from a PackageImporter created from a &quot;</span>
            <span class="s2">&quot;directory is not supported. Use a package archive file instead.&quot;</span>
        <span class="p">)</span>
    <span class="n">cu</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">CompilationUnit</span><span class="p">()</span>
    <span class="n">cpp_module</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">_import_ir_module_from_package</span><span class="p">(</span>
        <span class="n">cu</span><span class="p">,</span>
        <span class="n">importer</span><span class="o">.</span><span class="n">zip_reader</span><span class="p">,</span>
        <span class="n">importer</span><span class="o">.</span><span class="n">storage_context</span><span class="p">,</span>
        <span class="n">validate_map_location</span><span class="p">(</span><span class="n">importer</span><span class="o">.</span><span class="n">last_map_location</span><span class="p">),</span>
        <span class="n">script_module_id</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">wrap_cpp_module</span><span class="p">(</span><span class="n">cpp_module</span><span class="p">)</span>


<span class="k">if</span> <span class="n">_enabled</span><span class="p">:</span>
    <span class="n">_magic_methods</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;__iter__&quot;</span><span class="p">,</span>
        <span class="s2">&quot;__len__&quot;</span><span class="p">,</span>
        <span class="s2">&quot;__neg__&quot;</span><span class="p">,</span>
        <span class="s2">&quot;__mul__&quot;</span><span class="p">,</span>
        <span class="s2">&quot;__contains__&quot;</span><span class="p">,</span>
        <span class="s2">&quot;__add__&quot;</span><span class="p">,</span>
        <span class="s2">&quot;__sub__&quot;</span><span class="p">,</span>
        <span class="s2">&quot;__pow__&quot;</span><span class="p">,</span>
        <span class="s2">&quot;__truediv__&quot;</span><span class="p">,</span>
        <span class="s2">&quot;__mod__&quot;</span><span class="p">,</span>
        <span class="s2">&quot;__ne__&quot;</span><span class="p">,</span>
        <span class="s2">&quot;__eq__&quot;</span><span class="p">,</span>
        <span class="s2">&quot;__lt__&quot;</span><span class="p">,</span>
        <span class="s2">&quot;__gt__&quot;</span><span class="p">,</span>
        <span class="s2">&quot;__le__&quot;</span><span class="p">,</span>
        <span class="s2">&quot;__ge__&quot;</span><span class="p">,</span>
        <span class="s2">&quot;__and__&quot;</span><span class="p">,</span>
        <span class="s2">&quot;__or__&quot;</span><span class="p">,</span>
        <span class="s2">&quot;__xor__&quot;</span><span class="p">,</span>
        <span class="s2">&quot;__getitem__&quot;</span><span class="p">,</span>
        <span class="s2">&quot;__setitem__&quot;</span><span class="p">,</span>
        <span class="s2">&quot;__call__&quot;</span><span class="p">,</span>
        <span class="s2">&quot;__int__&quot;</span><span class="p">,</span>
        <span class="s2">&quot;__float__&quot;</span><span class="p">,</span>
        <span class="s2">&quot;__bool__&quot;</span><span class="p">,</span>
        <span class="s2">&quot;__str__&quot;</span><span class="p">,</span>
        <span class="s2">&quot;__enter__&quot;</span><span class="p">,</span>
        <span class="s2">&quot;__exit__&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">class</span> <span class="nc">RecursiveScriptClass</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        An analogue of RecursiveScriptModule for regular objects that are not modules.</span>
<span class="sd">        This class is a wrapper around a torch._C.ScriptObject that represents an instance</span>
<span class="sd">        of a TorchScript class and allows it to be used in Python.</span>

<span class="sd">        Attributes:</span>
<span class="sd">            _c [torch._C.ScriptObject]: The C++ object to which attribute lookups and method</span>
<span class="sd">                calls are forwarded.</span>
<span class="sd">            _props [Dict[str, property]]: A dictionary of properties fetched from self._c and</span>
<span class="sd">                exposed on this wrppaer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cpp_class</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">RecursiveScriptClass</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;_initializing&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_c</span> <span class="o">=</span> <span class="n">cpp_class</span>

            <span class="c1"># Add wrapped object&#39;s properties to this class instance.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_props</span> <span class="o">=</span> <span class="p">{</span><span class="n">prop</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="nb">property</span><span class="p">(</span><span class="n">prop</span><span class="o">.</span><span class="n">getter</span><span class="p">,</span> <span class="n">prop</span><span class="o">.</span><span class="n">setter</span><span class="p">)</span> <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">_properties</span><span class="p">()}</span>

            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;_initializing&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;_initializing&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;_initializing&quot;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">RecursiveScriptClass</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>  <span class="c1"># type: ignore[misc]</span>

            <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">fget</span><span class="p">()</span>  <span class="c1"># type: ignore[call-arg, misc]</span>

            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>

        <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;_initializing&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;_initializing&quot;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">RecursiveScriptClass</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">fset</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>  <span class="c1"># type: ignore[call-arg, misc]</span>

            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="c1"># Delegate calls to magic methods like __len__ to the C++ module backing the</span>
        <span class="c1"># RecursiveScriptClass.</span>
        <span class="k">def</span> <span class="nf">forward_magic_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method_name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">_has_method</span><span class="p">(</span><span class="n">method_name</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">()</span>

            <span class="n">self_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span><span class="n">method_name</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">self_method</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PickleError</span><span class="p">(</span><span class="s2">&quot;ScriptClasses cannot be pickled&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="fm">__iadd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">_has_method</span><span class="p">(</span><span class="s2">&quot;__iadd__&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward_magic_method</span><span class="p">(</span><span class="s2">&quot;__iadd__&quot;</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward_magic_method</span><span class="p">(</span><span class="s2">&quot;__add__&quot;</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>


    <span class="k">for</span> <span class="n">method_name</span> <span class="ow">in</span> <span class="n">_magic_methods</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">method_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward_magic_method</span><span class="p">(</span><span class="n">method_name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="nb">setattr</span><span class="p">(</span><span class="n">RecursiveScriptClass</span><span class="p">,</span> <span class="n">method_name</span><span class="p">,</span> <span class="n">method_template</span><span class="p">)</span>

    <span class="c1"># this is a Python &#39;non-data descriptor&#39; that causes the first access</span>
    <span class="c1"># to ScriptModule&#39;s forward to look up the forward method and stash</span>
    <span class="c1"># it in the objects dict. Due to the standard rules for attribute lookup,</span>
    <span class="c1"># subsequent lookups will just directly return the previously looked up method.</span>
    <span class="c1"># This is necessary because nn.Module defines forward as a method. If we</span>
    <span class="c1"># did nothing, __getattr__ would not be called. Instead we&#39;d get nn.Module.forward</span>
    <span class="c1"># which always throws an exception.</span>

    <span class="k">class</span> <span class="nc">ScriptModule</span><span class="p">(</span><span class="n">with_metaclass</span><span class="p">(</span><span class="n">ScriptMeta</span><span class="p">,</span> <span class="n">Module</span><span class="p">)):</span>  <span class="c1"># type: ignore[misc]</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A wrapper around C++ ``torch::jit::Module``. ``ScriptModule``\s</span>
<span class="sd">        contain methods, attributes, parameters, and</span>
<span class="sd">        constants. These can be accessed the same way as on a normal ``nn.Module``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">__jit_unused_properties__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s1">&#39;code_with_constants&#39;</span><span class="p">,</span> <span class="s1">&#39;graph&#39;</span><span class="p">,</span> <span class="s1">&#39;inlined_graph&#39;</span><span class="p">,</span> <span class="s1">&#39;original_name&#39;</span><span class="p">]</span>

        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">ScriptModule</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="n">forward</span> <span class="o">=</span> <span class="n">_CachedForward</span><span class="p">()</span>

        <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;_actual_script_module&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">ScriptModule</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_actual_script_module</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>

        <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;_actual_script_module&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
                <span class="c1"># Unwrap torch.jit.Attribute into a regular setattr + record</span>
                <span class="c1"># the provided type in __annotations__.</span>
                <span class="c1">#</span>
                <span class="c1"># This ensures that if we use the attr again in `__init__`, it</span>
                <span class="c1"># will look like the actual value, not an instance of Attribute.</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Attribute</span><span class="p">):</span>
                    <span class="c1"># NB: Ensure that we set __annotations__ on the specific</span>
                    <span class="c1"># class in question, and not on a superclass (which would</span>
                    <span class="c1"># be wrong wrong wrong!).</span>
                    <span class="c1"># See also https://github.com/pytorch/pytorch/issues/39463</span>
                    <span class="k">if</span> <span class="s2">&quot;__annotations__&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__annotations__</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="bp">self</span><span class="o">.</span><span class="vm">__annotations__</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">type</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">value</span>
                <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">ScriptModule</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_actual_script_module</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;_actual_script_module&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
                <span class="c1"># If we have completed initialization, just defer to the</span>
                <span class="c1"># backing RecursiveScriptModule to eagerly compile the provided</span>
                <span class="c1"># source.</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_actual_script_module</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>

            <span class="c1"># Otherwise, we are still in the object&#39;s __init__.</span>
            <span class="c1"># In that case, add `src` as a stub to be compiled.</span>
            <span class="c1">#</span>
            <span class="c1"># We use frames_up=1 to get to the proper surrounding scope. The stack</span>
            <span class="c1"># will look like:</span>
            <span class="c1"># 0. createResolutionCallback</span>
            <span class="c1"># 1. define()</span>
            <span class="c1"># 2. surrounding scope.</span>
            <span class="c1">#</span>
            <span class="c1"># createResolutionCallback internally adds 1 to get us to our frame, then</span>
            <span class="c1"># we add 1 to get to the proper surrounding scope.</span>
            <span class="n">rcb</span> <span class="o">=</span> <span class="n">_jit_internal</span><span class="o">.</span><span class="n">createResolutionCallbackFromFrame</span><span class="p">(</span><span class="n">frames_up</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ast</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">_parse_source_def</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_methods</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ScriptMethodStub</span><span class="p">(</span><span class="n">rcb</span><span class="p">,</span> <span class="n">ast</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_replicate_for_data_parallel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_actual_script_module</span><span class="o">.</span><span class="n">_replicate_for_data_parallel</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">__reduce_package__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exporter</span><span class="p">:</span> <span class="n">PackageExporter</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Called by ``torch.package.PackageExporter``&#39;s Pickler&#39;s ``persistent_id`` when</span>
<span class="sd">            saving TorchScript objects. Performs act of saving a ScriptModule inside of</span>
<span class="sd">            a ``torch.package`` archive.</span>

<span class="sd">            Returns method to load the ScriptModule from a ``torch.package.PackageImporter``&#39;s</span>
<span class="sd">            Pickler&#39;s ``persistent_load`` function.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">script_module_id</span> <span class="o">=</span> <span class="n">exporter</span><span class="o">.</span><span class="n">get_unique_id</span><span class="p">()</span>
            <span class="n">exporter</span><span class="o">.</span><span class="n">script_module_serializer</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">script_module_id</span><span class="p">))</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">unpackage_script_module</span><span class="p">,</span> <span class="p">(</span><span class="n">script_module_id</span><span class="p">,))</span>

    <span class="k">class</span> <span class="nc">RecursiveScriptModule</span><span class="p">(</span><span class="n">ScriptModule</span><span class="p">):</span>
        <span class="c1"># XXX: RecursiveScriptModule inherits from ScriptModule for the sole</span>
        <span class="c1"># reason that it retains the existing isinstance(ScriptModule)</span>
        <span class="c1"># behavior.</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The core data structure in TorchScript is the ``ScriptModule``. It is an</span>
<span class="sd">        analogue of torch&#39;s ``nn.Module`` and represents an entire model as a tree of</span>
<span class="sd">        submodules. Like normal modules, each individual module in a ``ScriptModule`` can</span>
<span class="sd">        have submodules, parameters, and methods. In ``nn.Module``\s methods are implemented</span>
<span class="sd">        as Python functions, but in ``ScriptModule``\s methods are implemented as</span>
<span class="sd">        TorchScript functions, a statically-typed subset of Python that contains all</span>
<span class="sd">        of PyTorch&#39;s built-in Tensor operations. This difference allows your</span>
<span class="sd">        ``ScriptModule``\s code to run without the need for a Python interpreter.</span>

<span class="sd">        ``ScriptModule``\s should not be created manually, instead use</span>
<span class="sd">        either :func:`tracing &lt;torch.jit.trace&gt;` or :func:`scripting &lt;torch.jit.script&gt;`.</span>
<span class="sd">        Tracing and scripting can be applied incrementally and :ref:`composed as necessary &lt;Types&gt;`.</span>

<span class="sd">        * Tracing records the tensor operations as executed with a set of example inputs and uses these</span>
<span class="sd">          operations to construct a computation graph. You can use the full dynamic behavior of Python with tracing,</span>
<span class="sd">          but values other than Tensors and control flow aren&#39;t captured in the graph.</span>

<span class="sd">        * Scripting inspects the Python code of the model</span>
<span class="sd">          and compiles it to TorchScript. Scripting allows the use of many `types`_ of values and supports dynamic control flow.</span>
<span class="sd">          Many, but not all features of Python are supported by the compiler, so changes to the source code may be necessary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_disable_script_meta</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cpp_module</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;_initializing&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_c</span> <span class="o">=</span> <span class="n">cpp_module</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">RecursiveScriptModule</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
            <span class="c1"># Delete the &#39;training&#39; attribute set up by `Module.__init__`. It</span>
            <span class="c1"># will get set on the underlying cpp module, so we delete it here</span>
            <span class="c1"># to avoid this version shadowing the cpp module version.</span>
            <span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;training&quot;</span><span class="p">)</span>

        <span class="nd">@staticmethod</span>
        <span class="k">def</span> <span class="nf">_construct</span><span class="p">(</span><span class="n">cpp_module</span><span class="p">,</span> <span class="n">init_fn</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Construct a RecursiveScriptModule that&#39;s ready for use. PyTorch</span>
<span class="sd">            code should use this to construct a RecursiveScriptModule instead</span>
<span class="sd">            of instead of calling `__init__` directly, as it makes sure the</span>
<span class="sd">            object is properly finalized (and in the future, we may take</span>
<span class="sd">            control of how the RecursiveScriptModule instance is created).</span>

<span class="sd">            Args:</span>
<span class="sd">                cpp_module:  The C++ Module that will hold the actual state of</span>
<span class="sd">                             this RecursiveScriptModule instance.</span>
<span class="sd">                init_fn:  Lambda that initializes the RecursiveScriptModule passed to it.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">script_module</span> <span class="o">=</span> <span class="n">RecursiveScriptModule</span><span class="p">(</span><span class="n">cpp_module</span><span class="p">)</span>
            <span class="n">init_fn</span><span class="p">(</span><span class="n">script_module</span><span class="p">)</span>

            <span class="c1"># Finalize the ScriptModule: replace the nn.Module state with our</span>
            <span class="c1"># custom implementations and flip the _initializing bit.</span>
            <span class="n">RecursiveScriptModule</span><span class="o">.</span><span class="n">_finalize_scriptmodule</span><span class="p">(</span><span class="n">script_module</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">script_module</span>

        <span class="nd">@staticmethod</span>
        <span class="k">def</span> <span class="nf">_finalize_scriptmodule</span><span class="p">(</span><span class="n">script_module</span><span class="p">):</span>
            <span class="n">script_module</span><span class="o">.</span><span class="n">_parameters</span> <span class="o">=</span> <span class="n">OrderedDictWrapper</span><span class="p">(</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">ParameterDict</span><span class="p">(</span><span class="n">script_module</span><span class="o">.</span><span class="n">_c</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">script_module</span><span class="o">.</span><span class="n">_buffers</span> <span class="o">=</span> <span class="n">OrderedDictWrapper</span><span class="p">(</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">BufferDict</span><span class="p">(</span><span class="n">script_module</span><span class="o">.</span><span class="n">_c</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">script_module</span><span class="o">.</span><span class="n">_modules</span> <span class="o">=</span> <span class="n">OrderedModuleDict</span><span class="p">(</span>
                <span class="n">script_module</span><span class="o">.</span><span class="n">_c</span><span class="p">,</span> <span class="n">script_module</span><span class="o">.</span><span class="n">_modules</span>
            <span class="p">)</span>
            <span class="n">script_module</span><span class="o">.</span><span class="n">_initializing</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">def</span> <span class="nf">_reconstruct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cpp_module</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Re-construct an instance of RecursiveScriptModule using an instance of a C++ module.</span>

<span class="sd">            Args:</span>
<span class="sd">                cpp_module: The C++ module that this RecursiveScriptModule will be rebuilt around.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">cpp_module</span><span class="p">)</span>  <span class="c1"># type: ignore[misc]</span>

            <span class="c1"># Copy the concrete type from the C++ module to this ScriptModule.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_concrete_type</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">ConcreteModuleType</span><span class="o">.</span><span class="n">from_jit_type</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">_type</span><span class="p">()</span>
            <span class="p">)</span>

            <span class="c1"># Copy submodules from the C++ module to this ScriptModule.</span>
            <span class="n">modules</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">cpp_module</span> <span class="ow">in</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">modules</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">wrap_cpp_module</span><span class="p">(</span><span class="n">cpp_module</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_modules</span> <span class="o">=</span> <span class="n">OrderedModuleDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="p">,</span> <span class="n">modules</span><span class="p">)</span>

            <span class="c1"># Copy parameters and buffers.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span> <span class="o">=</span> <span class="n">OrderedDictWrapper</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">ParameterDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_buffers</span> <span class="o">=</span> <span class="n">OrderedDictWrapper</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">BufferDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="p">))</span>

            <span class="c1"># Get rid of the functions from the old C++ module.</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">ScriptMethod</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;_initializing&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="nd">@property</span>
        <span class="k">def</span> <span class="nf">graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Returns a string representation of the internal graph for the</span>
<span class="sd">            ``forward`` method. See :ref:`interpreting-graphs` for details.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">_get_method</span><span class="p">(</span><span class="s2">&quot;forward&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">graph</span>

        <span class="nd">@property</span>
        <span class="k">def</span> <span class="nf">inlined_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Returns a string representation of the internal graph for the</span>
<span class="sd">            ``forward`` method. This graph will be preprocessed to inline all function and method calls.</span>
<span class="sd">            See :ref:`interpreting-graphs` for details.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward</span><span class="o">.</span><span class="n">inlined_graph</span>

        <span class="nd">@property</span>
        <span class="k">def</span> <span class="nf">code</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Returns a pretty-printed representation (as valid Python syntax) of</span>
<span class="sd">            the internal graph for the ``forward`` method. See</span>
<span class="sd">            :ref:`inspecting-code` for details.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward</span><span class="o">.</span><span class="n">code</span>

        <span class="nd">@property</span>
        <span class="k">def</span> <span class="nf">code_with_constants</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Returns a tuple of:</span>

<span class="sd">            [0] a pretty-printed representation (as valid Python syntax) of</span>
<span class="sd">            the internal graph for the ``forward`` method. See `code`.</span>
<span class="sd">            [1] a ConstMap following the CONSTANT.cN format of the output in [0].</span>
<span class="sd">            The indices in the [0] output are keys to the underlying constant&#39;s values.</span>

<span class="sd">            See :ref:`inspecting-code` for details.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward</span><span class="o">.</span><span class="n">code_with_constants</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ConstMap</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            save(f, _extra_files={})</span>

<span class="sd">            See :func:`torch.jit.save &lt;torch.jit.save&gt;` for details.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_save_for_lite_interpreter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            _save_for_lite_interpreter(f)</span>

<span class="sd">            Add (or update) the bytecode session to the script model. The updated model is used</span>
<span class="sd">            in lite interpreter for mobile applications.</span>

<span class="sd">            Args:</span>
<span class="sd">                f: a string containing a file name.</span>
<span class="sd">                _extra_files: Map from filename to contents which will be stored as part of &#39;f&#39;.</span>

<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">_save_for_mobile</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_save_to_buffer_for_lite_interpreter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">_save_to_buffer_for_mobile</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">save_to_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">save_to_buffer</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_debug_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">get_debug_state</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">extra_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;original_name=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">original_name</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">graph_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward</span><span class="o">.</span><span class="n">graph_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="nd">@property</span>
        <span class="k">def</span> <span class="nf">original_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">_type</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">()):</span>
                <span class="k">return</span> <span class="s2">&quot;&quot;</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">_type</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>

        <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">):</span>
            <span class="c1"># We use frames_up=1 to get to the proper surrounding scope. The stack</span>
            <span class="c1"># will look like:</span>
            <span class="c1"># 0. createResolutionCallback</span>
            <span class="c1"># 1. define()</span>
            <span class="c1"># 2. surrounding scope.</span>
            <span class="c1">#</span>
            <span class="c1"># createResolutionCallback internally adds 1 to get us to our frame, then</span>
            <span class="c1"># we add 1 to get to the proper surrounding scope.</span>
            <span class="n">rcb</span> <span class="o">=</span> <span class="n">_jit_internal</span><span class="o">.</span><span class="n">createResolutionCallbackFromFrame</span><span class="p">(</span><span class="n">frames_up</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">_define</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_concrete_type</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">rcb</span><span class="p">)</span>

        <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;_initializing&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s2">&quot;ScriptModule has not been initialized, did you forget to call super&#39;s init?&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initializing</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">RecursiveScriptModule</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>

            <span class="c1"># _modules check is before hasattr since modules are included as attributes in _c,</span>
            <span class="c1"># but we want to get the python wrapper from _modules instead of the raw _c object.</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modules</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modules</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">hasattr</span><span class="p">(</span><span class="n">attr</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">getattr</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">_has_method</span><span class="p">(</span><span class="n">attr</span><span class="p">):</span>
                <span class="n">script_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">_get_method</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                <span class="c1"># cache method so future calls do not go through __getattr__</span>
                <span class="c1"># to improve invocation performance</span>
                <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">script_method</span>
                <span class="k">return</span> <span class="n">script_method</span>

            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">RecursiveScriptModule</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>

        <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initializing</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">RecursiveScriptModule</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modules</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_modules</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">hasattr</span><span class="p">(</span><span class="n">attr</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_concrete_type&quot;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_concrete_type</span><span class="o">.</span><span class="n">get_constants</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="p">):</span>
                <span class="c1"># TODO: we don&#39;t have _concrete_type set after load(), and in general we lose constant information.</span>
                <span class="c1"># We should encode constants as class type attributes (or something) so it persists across save/load.</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot mutate TorchScript constant value: &#39;</span><span class="si">{}</span><span class="s2">&#39;. Value: &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">attr</span><span class="p">,</span> <span class="n">value</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># We allow setting Python attributes on the ScriptModule, for</span>
                <span class="c1"># when people want to stash some convenience info on it.</span>
                <span class="c1"># TODO: it&#39;s possible that the following is confusing:</span>
                <span class="c1">#   s = torch.jit.script(...)</span>
                <span class="c1">#   s.python_attr = ...</span>
                <span class="c1">#   s.save()   &lt;--- this doesn&#39;t have `python_attr`</span>
                <span class="c1"># It&#39;s fairly trivial to save enough info to warn in this case.</span>
                <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">RecursiveScriptModule</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">__copy__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">_recursive</span><span class="o">.</span><span class="n">wrap_cpp_module</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">__deepcopy__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">_recursive</span><span class="o">.</span><span class="n">wrap_cpp_module</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="p">,</span> <span class="n">memo</span><span class="p">))</span>

        <span class="c1"># Python magic methods do method lookups on an object&#39;s class type, instead of looking up</span>
        <span class="c1"># the method defines on the class instance. In order to continue to expose the magic methods</span>
        <span class="c1"># of builtin-containers (ModuleList, Sequential, ModuleDict) to Python, we</span>
        <span class="c1"># define magic methods here as a shim to the correct attribute.</span>
        <span class="k">def</span> <span class="nf">forward_magic_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method_name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">self_method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">self_method</span><span class="p">,</span> <span class="s2">&quot;__func__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="nb">getattr</span><span class="p">(</span>
                <span class="n">RecursiveScriptModule</span><span class="p">,</span> <span class="n">method_name</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">self_method</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward_magic_method</span><span class="p">(</span><span class="s2">&quot;__iter__&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward_magic_method</span><span class="p">(</span><span class="s2">&quot;__getitem__&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>

        <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward_magic_method</span><span class="p">(</span><span class="s2">&quot;__len__&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward_magic_method</span><span class="p">(</span><span class="s2">&quot;__contains__&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

        <span class="c1"># dir is defined by the base nn.Module, so instead of throwing if</span>
        <span class="c1"># it is not overridden, we call into the nn.Module __dir__ method</span>
        <span class="k">def</span> <span class="fm">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">self_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__dir__</span>
            <span class="k">if</span> <span class="n">self_method</span><span class="o">.</span><span class="vm">__func__</span> <span class="o">==</span> <span class="n">_get_function_from_type</span><span class="p">(</span>  <span class="c1"># type: ignore[attr-defined]</span>
                <span class="n">RecursiveScriptModule</span><span class="p">,</span> <span class="s2">&quot;__dir__&quot;</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">RecursiveScriptModule</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__dir__</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">self_method</span><span class="p">()</span>

        <span class="c1"># to resolve bool(value), Python looks if __bool__ is defined then __iter__</span>
        <span class="c1"># is defined then returns true for classes. Since __iter__() on this</span>
        <span class="c1"># class throws if it isn&#39;t overridden, we define __bool__ to preserve default behavior</span>
        <span class="k">def</span> <span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">self_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__bool__</span>
            <span class="k">if</span> <span class="n">self_method</span><span class="o">.</span><span class="vm">__func__</span> <span class="o">==</span> <span class="n">_get_function_from_type</span><span class="p">(</span>  <span class="c1"># type: ignore[attr-defined]</span>
                <span class="n">RecursiveScriptModule</span><span class="p">,</span> <span class="s2">&quot;__bool__&quot;</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="n">self_method</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">_replicate_for_data_parallel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="c1"># we have to initialize ScriptModule properly so that</span>
            <span class="c1"># it works with pybind11</span>
            <span class="k">def</span> <span class="nf">init_fn</span><span class="p">(</span><span class="n">script_module</span><span class="p">):</span>
                <span class="c1"># Don&#39;t do anything here, we&#39;ll initialize the ScriptModule below</span>
                <span class="k">return</span>

            <span class="k">return</span> <span class="n">RecursiveScriptModule</span><span class="o">.</span><span class="n">_construct</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">_replicate_for_data_parallel</span><span class="p">(),</span> <span class="n">init_fn</span>
            <span class="p">)</span>

    <span class="c1"># Need to copy all RecursiveScriptModule methods to ScriptModule.</span>
    <span class="c1">#</span>
    <span class="c1"># This is because `super(MyScriptModule, self).foo()` does not use</span>
    <span class="c1"># `__getattr__` to look up `foo`. So we need to make each method available on</span>
    <span class="c1"># the ScriptModule manually.</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">RecursiveScriptModule</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">property</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ScriptModule</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="c1"># We can copy over the implementation wholesale because besides the</span>
        <span class="c1"># `super()` thing above, ScriptModule behaves exactly like</span>
        <span class="c1"># RecursiveScriptModule</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">ScriptModule</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_methods</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">inspect</span>

        <span class="c1"># In Python 3 unbound methods are functions, but in Python 2 they are methods</span>
        <span class="k">return</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">or</span> <span class="n">inspect</span><span class="o">.</span><span class="n">ismethod</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="n">_compiled_methods_allowlist</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;forward&quot;</span><span class="p">,</span>
        <span class="s2">&quot;register_buffer&quot;</span><span class="p">,</span>
        <span class="s2">&quot;register_parameter&quot;</span><span class="p">,</span>
        <span class="s2">&quot;register_module&quot;</span><span class="p">,</span>
        <span class="s2">&quot;add_module&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_apply&quot;</span><span class="p">,</span>
        <span class="s2">&quot;apply&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cuda&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
        <span class="s2">&quot;to&quot;</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">,</span>
        <span class="s2">&quot;float&quot;</span><span class="p">,</span>
        <span class="s2">&quot;double&quot;</span><span class="p">,</span>
        <span class="s2">&quot;half&quot;</span><span class="p">,</span>
        <span class="s2">&quot;state_dict&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_save_to_state_dict&quot;</span><span class="p">,</span>
        <span class="s2">&quot;load_state_dict&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_load_from_state_dict&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_named_members&quot;</span><span class="p">,</span>
        <span class="s2">&quot;parameters&quot;</span><span class="p">,</span>
        <span class="s2">&quot;named_parameters&quot;</span><span class="p">,</span>
        <span class="s2">&quot;buffers&quot;</span><span class="p">,</span>
        <span class="s2">&quot;named_buffers&quot;</span><span class="p">,</span>
        <span class="s2">&quot;children&quot;</span><span class="p">,</span>
        <span class="s2">&quot;named_children&quot;</span><span class="p">,</span>
        <span class="s2">&quot;modules&quot;</span><span class="p">,</span>
        <span class="s2">&quot;named_modules&quot;</span><span class="p">,</span>
        <span class="s2">&quot;zero_grad&quot;</span><span class="p">,</span>
        <span class="s2">&quot;share_memory&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_get_name&quot;</span><span class="p">,</span>
        <span class="s2">&quot;extra_repr&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_slow_forward&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_tracing_name&quot;</span><span class="p">,</span>
        <span class="s2">&quot;eval&quot;</span><span class="p">,</span>
        <span class="s2">&quot;train&quot;</span><span class="p">,</span>
        <span class="s2">&quot;get_extra_state&quot;</span><span class="p">,</span>
        <span class="s2">&quot;set_extra_state&quot;</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_make_fail</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot; is not supported on ScriptModules&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fail</span>

    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">_get_methods</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">RecursiveScriptModule</span><span class="o">.</span><span class="vm">__dict__</span>
            <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_compiled_methods_allowlist</span>
        <span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">RecursiveScriptModule</span><span class="p">,</span> <span class="n">method</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">_make_fail</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>


<span class="k">else</span><span class="p">:</span>
    <span class="c1"># TODO MAKE SURE THAT DISABLING WORKS</span>
    <span class="k">class</span> <span class="nc">RecursiveScriptClass</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>  <span class="c1"># type: ignore[no-redef]</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

<div class="viewcode-block" id="ScriptModule"><a class="viewcode-back" href="../../../generated/torch.jit.ScriptModule.html#torch.jit.ScriptModule">[docs]</a>    <span class="k">class</span> <span class="nc">ScriptModule</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>  <span class="c1"># type: ignore[no-redef]</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span></div>

    <span class="k">class</span> <span class="nc">RecursiveScriptModule</span><span class="p">(</span><span class="n">ScriptModule</span><span class="p">):</span>  <span class="c1"># type: ignore[no-redef]</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">call_prepare_scriptable_func_impl</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="n">obj_id</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

    <span class="c1"># If obj_id is in memo, obj has already been prepared or is being</span>
    <span class="c1"># prepared in another call up the stack.</span>
    <span class="k">if</span> <span class="n">obj_id</span> <span class="ow">in</span> <span class="n">memo</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">memo</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">obj</span><span class="p">)]</span>

    <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__prepare_scriptable__</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;__prepare_scriptable__&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">obj</span>  <span class="c1"># type: ignore[operator]</span>
    <span class="c1"># Record obj in memo to avoid infinite recursion in the case of cycles in the module</span>
    <span class="c1"># hierarchy when recursing below.</span>
    <span class="n">memo</span><span class="p">[</span><span class="n">obj_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>

    <span class="n">new_obj_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">sub_module</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;_modules&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sub_module</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">sub_module</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">call_prepare_scriptable_func_impl</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span>
            <span class="n">new_obj_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub_module</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sub_module</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sub_module</span><span class="p">,</span> <span class="n">ScriptModule</span><span class="p">):</span>
            <span class="n">new_obj_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">call_prepare_scriptable_func_impl</span><span class="p">(</span><span class="n">sub_module</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_obj_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub_module</span>

    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">new_obj_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">obj</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="k">return</span> <span class="n">obj</span>


<span class="k">def</span> <span class="nf">call_prepare_scriptable_func</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="n">memo</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">return</span> <span class="n">call_prepare_scriptable_func_impl</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">create_script_dict</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a ``torch._C.ScriptDict`` instance with the data from ``obj``.</span>

<span class="sd">    Args:</span>
<span class="sd">        obj (dict): The Python dictionary that is used to initialize the ``ScriptDict``</span>
<span class="sd">                    returned by this function.</span>

<span class="sd">    Returns:</span>
<span class="sd">        An instance of ``torch._C.ScriptDict`` that has the same data as ``obj``</span>
<span class="sd">        and can be passed between Python and TorchScript with reference semantics and</span>
<span class="sd">        zero copy overhead.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">ScriptDict</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>


<span class="k">def</span> <span class="nf">create_script_list</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">type_hint</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a ``torch._C.ScriptList`` instance with the data from ``obj``.</span>
<span class="sd">    Args:</span>
<span class="sd">        obj (dict): The Python list that is used to initialize the ``ScriptList``</span>
<span class="sd">                    returned by this function.</span>
<span class="sd">    Returns:</span>
<span class="sd">        An instance of ``torch._C.ScriptList`` that has the same data as ``obj``</span>
<span class="sd">        and can be passed between Python and TorchScript with reference semantics and</span>
<span class="sd">        zero copy overhead.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">ScriptList</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>


<div class="viewcode-block" id="script"><a class="viewcode-back" href="../../../generated/torch.jit.script.html#torch.jit.script">[docs]</a><span class="k">def</span> <span class="nf">script</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">_frames_up</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">_rcb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
           <span class="n">example_inputs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">]],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Scripting a function or ``nn.Module`` will inspect the source code, compile</span>
<span class="sd">    it as TorchScript code using the TorchScript compiler, and return a :class:`ScriptModule` or</span>
<span class="sd">    :class:`ScriptFunction`. TorchScript itself is a subset of the Python language, so not all</span>
<span class="sd">    features in Python work, but we provide enough functionality to compute on</span>
<span class="sd">    tensors and do control-dependent operations. For a complete guide, see the</span>
<span class="sd">    :ref:`language-reference`.</span>

<span class="sd">    Scripting a dictionary or list copies the data inside it into a TorchScript instance than can be</span>
<span class="sd">    subsequently passed by reference between Python and TorchScript with zero copy overhead.</span>

<span class="sd">    ``torch.jit.script`` can be used as a function for modules, functions, dictionaries and lists</span>
<span class="sd">     and as a decorator ``@torch.jit.script`` for :ref:`torchscript-classes` and functions.</span>

<span class="sd">    Args:</span>
<span class="sd">        obj (callable, class, or ``nn.Module``):  The ``nn.Module``, function, class type,</span>
<span class="sd">                                                  dictionary, or list to compile.</span>
<span class="sd">        example_inputs (Union[List[Tuple], Dict[Callable, List[Tuple]], None]): Provide example inputs</span>
<span class="sd">            to annotate the arguments for a function or ``nn.Module``.</span>

<span class="sd">    Returns:</span>
<span class="sd">        If ``obj`` is ``nn.Module``, ``script`` returns</span>
<span class="sd">        a :class:`ScriptModule` object. The returned :class:`ScriptModule` will</span>
<span class="sd">        have the same set of sub-modules and parameters as the</span>
<span class="sd">        original ``nn.Module``. If ``obj`` is a standalone function,</span>
<span class="sd">        a :class:`ScriptFunction` will be returned. If ``obj`` is a ``dict``, then</span>
<span class="sd">        ``script`` returns an instance of `torch._C.ScriptDict`. If ``obj`` is a ``list``,</span>
<span class="sd">        then ``script`` returns an instance of `torch._C.ScriptList`.</span>

<span class="sd">    **Scripting a function**</span>
<span class="sd">        The ``@torch.jit.script`` decorator will construct a :class:`ScriptFunction`</span>
<span class="sd">        by compiling the body of the function.</span>

<span class="sd">        Example (scripting a function):</span>

<span class="sd">        .. testcode::</span>

<span class="sd">            import torch</span>

<span class="sd">            @torch.jit.script</span>
<span class="sd">            def foo(x, y):</span>
<span class="sd">                if x.max() &gt; y.max():</span>
<span class="sd">                    r = x</span>
<span class="sd">                else:</span>
<span class="sd">                    r = y</span>
<span class="sd">                return r</span>

<span class="sd">            print(type(foo))  # torch.jit.ScriptFunction</span>

<span class="sd">            # See the compiled graph as Python code</span>
<span class="sd">            print(foo.code)</span>

<span class="sd">            # Call the function using the TorchScript interpreter</span>
<span class="sd">            foo(torch.ones(2, 2), torch.ones(2, 2))</span>

<span class="sd">        .. testoutput::</span>
<span class="sd">            :hide:</span>

<span class="sd">            ...</span>

<span class="sd">    ****Scripting a function using example_inputs**</span>
<span class="sd">        Example inputs can be used to annotate a function arguments.</span>

<span class="sd">        Example (annotating a function before scripting):</span>

<span class="sd">        .. testcode::</span>

<span class="sd">            import torch</span>

<span class="sd">            def test_sum(a, b):</span>
<span class="sd">                return a + b</span>

<span class="sd">            # Annotate the arguments to be int</span>
<span class="sd">            scripted_fn = torch.jit.script(test_sum, example_inputs=[(3, 4)])</span>

<span class="sd">            print(type(scripted_fn))  # torch.jit.ScriptFunction</span>

<span class="sd">            # See the compiled graph as Python code</span>
<span class="sd">            print(scripted_fn.code)</span>

<span class="sd">            # Call the function using the TorchScript interpreter</span>
<span class="sd">            scripted_fn(20, 100)</span>

<span class="sd">        .. testoutput::</span>
<span class="sd">            :hide:</span>

<span class="sd">            ...</span>

<span class="sd">    **Scripting an nn.Module**</span>
<span class="sd">        Scripting an ``nn.Module`` by default will compile the ``forward`` method and recursively</span>
<span class="sd">        compile any methods, submodules, and functions called by ``forward``. If a ``nn.Module`` only uses</span>
<span class="sd">        features supported in TorchScript, no changes to the original module code should be necessary. ``script``</span>
<span class="sd">        will construct :class:`ScriptModule` that has copies of the attributes, parameters, and methods of</span>
<span class="sd">        the original module.</span>

<span class="sd">        Example (scripting a simple module with a Parameter):</span>

<span class="sd">        .. testcode::</span>

<span class="sd">            import torch</span>

<span class="sd">            class MyModule(torch.nn.Module):</span>
<span class="sd">                def __init__(self, N, M):</span>
<span class="sd">                    super(MyModule, self).__init__()</span>
<span class="sd">                    # This parameter will be copied to the new ScriptModule</span>
<span class="sd">                    self.weight = torch.nn.Parameter(torch.rand(N, M))</span>

<span class="sd">                    # When this submodule is used, it will be compiled</span>
<span class="sd">                    self.linear = torch.nn.Linear(N, M)</span>

<span class="sd">                def forward(self, input):</span>
<span class="sd">                    output = self.weight.mv(input)</span>

<span class="sd">                    # This calls the `forward` method of the `nn.Linear` module, which will</span>
<span class="sd">                    # cause the `self.linear` submodule to be compiled to a `ScriptModule` here</span>
<span class="sd">                    output = self.linear(output)</span>
<span class="sd">                    return output</span>

<span class="sd">            scripted_module = torch.jit.script(MyModule(2, 3))</span>

<span class="sd">        Example (scripting a module with traced submodules):</span>

<span class="sd">        .. testcode::</span>

<span class="sd">            import torch</span>
<span class="sd">            import torch.nn as nn</span>
<span class="sd">            import torch.nn.functional as F</span>

<span class="sd">            class MyModule(nn.Module):</span>
<span class="sd">                def __init__(self):</span>
<span class="sd">                    super(MyModule, self).__init__()</span>
<span class="sd">                    # torch.jit.trace produces a ScriptModule&#39;s conv1 and conv2</span>
<span class="sd">                    self.conv1 = torch.jit.trace(nn.Conv2d(1, 20, 5), torch.rand(1, 1, 16, 16))</span>
<span class="sd">                    self.conv2 = torch.jit.trace(nn.Conv2d(20, 20, 5), torch.rand(1, 20, 16, 16))</span>

<span class="sd">                def forward(self, input):</span>
<span class="sd">                    input = F.relu(self.conv1(input))</span>
<span class="sd">                    input = F.relu(self.conv2(input))</span>
<span class="sd">                    return input</span>

<span class="sd">            scripted_module = torch.jit.script(MyModule())</span>

<span class="sd">        To compile a method other than ``forward`` (and recursively compile anything it calls), add</span>
<span class="sd">        the :func:`@torch.jit.export &lt;torch.jit.export&gt;` decorator to the method. To opt out of compilation</span>
<span class="sd">        use :func:`@torch.jit.ignore &lt;torch.jit.ignore&gt;` or :func:`@torch.jit.unused &lt;torch.jit.unused&gt;`.</span>

<span class="sd">        Example (an exported and ignored method in a module)::</span>

<span class="sd">            import torch</span>
<span class="sd">            import torch.nn as nn</span>

<span class="sd">            class MyModule(nn.Module):</span>
<span class="sd">                def __init__(self):</span>
<span class="sd">                    super(MyModule, self).__init__()</span>

<span class="sd">                @torch.jit.export</span>
<span class="sd">                def some_entry_point(self, input):</span>
<span class="sd">                    return input + 10</span>

<span class="sd">                @torch.jit.ignore</span>
<span class="sd">                def python_only_fn(self, input):</span>
<span class="sd">                    # This function won&#39;t be compiled, so any</span>
<span class="sd">                    # Python APIs can be used</span>
<span class="sd">                    import pdb</span>
<span class="sd">                    pdb.set_trace()</span>

<span class="sd">                def forward(self, input):</span>
<span class="sd">                    if self.training:</span>
<span class="sd">                        self.python_only_fn(input)</span>
<span class="sd">                    return input * 99</span>

<span class="sd">            scripted_module = torch.jit.script(MyModule())</span>
<span class="sd">            print(scripted_module.some_entry_point(torch.randn(2, 2)))</span>
<span class="sd">            print(scripted_module(torch.randn(2, 2)))</span>

<span class="sd">        Example ( Annotating forward of nn.Module using example_inputs)::</span>

<span class="sd">            import torch</span>
<span class="sd">            import torch.nn as nn</span>
<span class="sd">            from typing import NamedTuple</span>

<span class="sd">            class MyModule(NamedTuple):</span>
<span class="sd">            result: List[int]</span>

<span class="sd">            class TestNNModule(torch.nn.Module):</span>
<span class="sd">                def forward(self, a) -&gt; MyModule:</span>
<span class="sd">                    result = MyModule(result=a)</span>
<span class="sd">                    return result</span>

<span class="sd">            pdt_model = TestNNModule()</span>

<span class="sd">            # Runs the pdt_model in eager model with the inputs provided and annotates the arguments of forward</span>
<span class="sd">            scripted_model = torch.jit.script(pdt_model, example_inputs={pdt_model: [([10, 20, ], ), ], })</span>

<span class="sd">            # Run the scripted_model with actual inputs</span>
<span class="sd">            print(scripted_model([20]))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">type_trace_db</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_enabled</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="k">if</span> <span class="n">optimize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;`optimize` is deprecated and has no effect. Use `with torch.jit.optimized_execution() instead&quot;</span>
        <span class="p">)</span>

    <span class="c1"># No-op for modules, functions, class instances that are already scripted</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">RecursiveScriptClass</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">obj</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">ScriptModule</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">obj</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">ScriptFunction</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="k">if</span> <span class="n">example_inputs</span><span class="p">:</span>
        <span class="c1"># If MonkeyType is installed, enable profile directed type annotation</span>
        <span class="c1"># Check if example_inputs are defined and generate call traces</span>
        <span class="c1"># for the method by running eager mode version of the method with</span>
        <span class="c1"># the provide example inputs. This logs all the traces in type_trace_db</span>
        <span class="n">type_trace_db</span> <span class="o">=</span> <span class="n">JitTypeTraceStore</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">monkeytype_trace</span><span class="p">:</span>
            <span class="n">monkeytype_config</span> <span class="o">=</span> <span class="n">JitTypeTraceConfig</span><span class="p">(</span><span class="n">type_trace_db</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">monkeytype_trace</span><span class="p">(</span><span class="n">monkeytype_config</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">example_inputs</span><span class="p">,</span> <span class="n">Dict</span><span class="p">):</span>
                    <span class="c1"># If the obj is an nn.Module or a class, then each method is</span>
                    <span class="c1"># executed with the arguments provided in the example inputs.</span>
                    <span class="c1"># example inputs here will be of type Dict(class.method, (arguments))</span>
                    <span class="c1"># This is used to infer type annotations for those methods</span>
                    <span class="c1"># which are not called directly under the hood of monkeytype.</span>
                    <span class="k">for</span> <span class="n">module</span><span class="p">,</span> <span class="n">example_input</span> <span class="ow">in</span> <span class="n">example_inputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">example_input</span><span class="p">:</span>
                            <span class="n">module</span><span class="p">(</span><span class="o">*</span><span class="n">example</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">example_inputs</span><span class="p">,</span> <span class="n">List</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">examples</span> <span class="ow">in</span> <span class="n">example_inputs</span><span class="p">:</span>
                        <span class="n">obj</span><span class="p">(</span><span class="o">*</span><span class="n">examples</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Error: Unable to infer types. Please format the inputs to type `List[Tuple]`&quot;</span>
                                     <span class="s2">&quot; or `Dict[Callable, List[Tuple]]` to be run with MonkeyType.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Warning: monkeytype is not installed. Please install https://github.com/Instagram/MonkeyType &quot;</span>
                          <span class="s2">&quot;to enable Profile-Directed Typing in TorchScript. Refer to &quot;</span>
                          <span class="s2">&quot;https://github.com/Instagram/MonkeyType/blob/master/README.rst to install MonkeyType. &quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">call_prepare_scriptable_func</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">_recursive</span><span class="o">.</span><span class="n">create_script_module</span><span class="p">(</span>
            <span class="n">obj</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">_recursive</span><span class="o">.</span><span class="n">infer_methods_to_compile</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">create_script_dict</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">create_script_list</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="n">qualified_name</span> <span class="o">=</span> <span class="n">_qualified_name</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="c1"># If this type is a `nn.Module` subclass, they probably meant to pass</span>
        <span class="c1"># an instance instead of a Module</span>
        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Type &#39;</span><span class="si">{}</span><span class="s2">&#39; cannot be compiled since it inherits&quot;</span>
                <span class="s2">&quot; from nn.Module,&quot;</span>
                <span class="s2">&quot; pass an instance instead&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Enums are automatically usable in TorchScript, explicitly scripting</span>
        <span class="c1"># is not necessary, but not harmful either.</span>
        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">obj</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_new_style_class</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;TorchScript classes must be new-style classes. &quot;</span>
                <span class="s2">&quot;Please inherit from &#39;object&#39;.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">mro</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;TorchScript classes does not support inheritance yet. &quot;</span>
                <span class="s2">&quot;Please directly inherit from &#39;object&#39;.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">_rcb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_rcb</span> <span class="o">=</span> <span class="n">_jit_internal</span><span class="o">.</span><span class="n">createResolutionCallbackFromFrame</span><span class="p">(</span><span class="n">_frames_up</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">_compile_and_register_class</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">_rcb</span><span class="p">,</span> <span class="n">qualified_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span>
    <span class="k">elif</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">or</span> <span class="n">inspect</span><span class="o">.</span><span class="n">ismethod</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="n">qualified_name</span> <span class="o">=</span> <span class="n">_qualified_name</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="c1"># this is a decorated fn, and we need to the underlying fn and its rcb</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__script_if_tracing_wrapper&quot;</span><span class="p">):</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__original_fn</span>  <span class="c1"># type: ignore[union-attr]</span>
            <span class="n">_rcb</span> <span class="o">=</span> <span class="n">_jit_internal</span><span class="o">.</span><span class="n">createResolutionCallbackFromClosure</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

        <span class="c1"># some functions are explicitly marked as not supported in script mode</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__script_unsupported&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;TorchScript error: &quot;</span> <span class="o">+</span> <span class="n">obj</span><span class="o">.</span><span class="n">__script_unsupported</span><span class="p">)</span>

        <span class="n">_check_directly_compile_overloaded</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">maybe_already_compiled_fn</span> <span class="o">=</span> <span class="n">_try_get_jit_cached_function</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">maybe_already_compiled_fn</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">maybe_already_compiled_fn</span>
        <span class="n">ast</span> <span class="o">=</span> <span class="n">get_jit_def</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_rcb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_rcb</span> <span class="o">=</span> <span class="n">_jit_internal</span><span class="o">.</span><span class="n">createResolutionCallbackFromClosure</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">_jit_script_compile</span><span class="p">(</span>
            <span class="n">qualified_name</span><span class="p">,</span> <span class="n">ast</span><span class="p">,</span> <span class="n">_rcb</span><span class="p">,</span> <span class="n">get_default_args</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Forward docstrings</span>
        <span class="n">fn</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__doc__</span>
        <span class="n">_set_jit_function_cache</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fn</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">_recursive</span><span class="o">.</span><span class="n">create_script_class</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span></div>


<span class="c1"># overloads are registered in _jit_internal and compiled here so that _overload</span>
<span class="c1"># can be used in nn/functional.py without an import cycle</span>


<span class="k">def</span> <span class="nf">_check_overload_defaults</span><span class="p">(</span><span class="n">impl_defaults</span><span class="p">,</span> <span class="n">overload_defaults</span><span class="p">,</span> <span class="n">loc</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">overload_value</span> <span class="ow">in</span> <span class="n">overload_defaults</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">impl_defaults</span> <span class="ow">or</span> <span class="n">impl_defaults</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">!=</span> <span class="n">overload_value</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">frontend</span><span class="o">.</span><span class="n">FrontendError</span><span class="p">(</span>
                <span class="n">loc</span><span class="p">,</span>
                <span class="s2">&quot;Default parameters on overloads do not affect the runtime so they &quot;</span>
                <span class="s2">&quot;must equal to the default parameter on the implementation function. Found on &quot;</span>
                <span class="s2">&quot;parameter </span><span class="si">{name}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">),</span>
            <span class="p">)</span>


<span class="k">def</span> <span class="nf">_compile_function_with_overload</span><span class="p">(</span><span class="n">overload_fn</span><span class="p">,</span> <span class="n">qual_name</span><span class="p">,</span> <span class="n">impl_fn</span><span class="p">):</span>
    <span class="n">overload_decl</span> <span class="o">=</span> <span class="n">get_jit_def</span><span class="p">(</span><span class="n">overload_fn</span><span class="p">,</span> <span class="n">overload_fn</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span><span class="o">.</span><span class="n">decl</span><span class="p">()</span>
    <span class="n">overload_signature</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">get_signature</span><span class="p">(</span>
        <span class="n">overload_fn</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">inspect</span><span class="o">.</span><span class="n">ismethod</span><span class="p">(</span><span class="n">overload_fn</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">impl_ast</span> <span class="o">=</span> <span class="n">get_jit_def</span><span class="p">(</span><span class="n">impl_fn</span><span class="p">,</span> <span class="n">impl_fn</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">overload_defaults</span> <span class="o">=</span> <span class="n">get_default_args</span><span class="p">(</span><span class="n">overload_fn</span><span class="p">)</span>
    <span class="n">implementation_defaults</span> <span class="o">=</span> <span class="n">get_default_args</span><span class="p">(</span><span class="n">impl_fn</span><span class="p">)</span>
    <span class="n">_rcb</span> <span class="o">=</span> <span class="n">_jit_internal</span><span class="o">.</span><span class="n">createResolutionCallbackFromClosure</span><span class="p">(</span><span class="n">impl_fn</span><span class="p">)</span>
    <span class="n">_check_overload_defaults</span><span class="p">(</span>
        <span class="n">implementation_defaults</span><span class="p">,</span> <span class="n">overload_defaults</span><span class="p">,</span> <span class="n">overload_decl</span><span class="o">.</span><span class="n">range</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">_jit_script_compile_overload</span><span class="p">(</span>
        <span class="n">qual_name</span><span class="p">,</span>
        <span class="n">overload_decl</span><span class="p">,</span>
        <span class="n">impl_ast</span><span class="p">,</span>
        <span class="n">_rcb</span><span class="p">,</span>
        <span class="n">implementation_defaults</span><span class="p">,</span>
        <span class="n">overload_signature</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">fn</span>


<span class="k">def</span> <span class="nf">_get_overloads</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="c1"># check for cached compiled fns</span>
    <span class="n">existing_compiled_fns</span> <span class="o">=</span> <span class="n">_try_get_jit_cached_overloads</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="n">qual_name</span> <span class="o">=</span> <span class="n">_qualified_name</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="n">uncompiled_overloads</span> <span class="o">=</span> <span class="n">_jit_internal</span><span class="o">.</span><span class="n">_get_fn_overloads</span><span class="p">(</span><span class="n">qual_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">uncompiled_overloads</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">existing_compiled_fns</span>

    <span class="k">if</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">uncompiled_overloads</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">_jit_internal</span><span class="o">.</span><span class="n">get_overload_no_implementation_error_message</span><span class="p">(</span>
            <span class="s1">&#39;function&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">))</span>

    <span class="n">compiled_fns</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">overload_fn</span> <span class="ow">in</span> <span class="n">uncompiled_overloads</span><span class="p">:</span>
        <span class="n">compiled_fns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">_compile_function_with_overload</span><span class="p">(</span><span class="n">overload_fn</span><span class="p">,</span> <span class="n">qual_name</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">existing_compiled_fns</span><span class="p">:</span>
        <span class="n">compiled_fns</span> <span class="o">=</span> <span class="n">existing_compiled_fns</span> <span class="o">+</span> <span class="n">compiled_fns</span>

    <span class="c1"># cache compilation, remove information stored to do compilation</span>
    <span class="n">_set_jit_overload_cache</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">compiled_fns</span><span class="p">)</span>
    <span class="n">_jit_internal</span><span class="o">.</span><span class="n">_clear_fn_overloads</span><span class="p">(</span><span class="n">qual_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">compiled_fns</span>


<span class="k">def</span> <span class="nf">_check_directly_compile_overloaded</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="n">qual_name</span> <span class="o">=</span> <span class="n">_qualified_name</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_jit_internal</span><span class="o">.</span><span class="n">_get_fn_overloads</span><span class="p">(</span><span class="n">qual_name</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_try_get_jit_cached_overloads</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;Function </span><span class="si">{}</span><span class="s2"> cannot be directly compiled because it&quot;</span>
            <span class="s2">&quot; is overloaded. It must be used in a context of a function&quot;</span>
            <span class="s2">&quot; where its inputs can determine which overload to call.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">qual_name</span><span class="p">)</span>
        <span class="p">)</span>


<span class="k">def</span> <span class="nf">interface</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;interface must be applied to a class&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_new_style_class</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;TorchScript interfaces must inherit from &#39;object&#39;&quot;</span><span class="p">)</span>

    <span class="c1"># Expected MRO is:</span>
    <span class="c1">#   User module</span>
    <span class="c1">#   torch.nn.modules.module.Module</span>
    <span class="c1">#   object</span>
    <span class="n">is_module_interface</span> <span class="o">=</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">mro</span><span class="p">())</span> <span class="o">==</span> <span class="mi">3</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_module_interface</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">mro</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;TorchScript interface does not support inheritance yet. &quot;</span>
            <span class="s2">&quot;Please directly inherit from &#39;object&#39; or &#39;nn.Module&#39;.&quot;</span>
        <span class="p">)</span>

    <span class="n">qualified_name</span> <span class="o">=</span> <span class="n">_qualified_name</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="n">rcb</span> <span class="o">=</span> <span class="n">_jit_internal</span><span class="o">.</span><span class="n">createResolutionCallbackFromFrame</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># if this type is a `nn.Module` subclass, generate a module interface type</span>
    <span class="c1"># instead of a class interface type; a module interface type only compiles</span>
    <span class="c1"># the user provided methods as part of the interface</span>
    <span class="n">ast</span> <span class="o">=</span> <span class="n">get_jit_class_def</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">mangled_classname</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">_jit_script_interface_compile</span><span class="p">(</span>
        <span class="n">qualified_name</span><span class="p">,</span> <span class="n">ast</span><span class="p">,</span> <span class="n">rcb</span><span class="p">,</span> <span class="n">is_module_interface</span>
    <span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">__torch_script_interface__</span> <span class="o">=</span> <span class="n">mangled_classname</span>
    <span class="k">return</span> <span class="n">obj</span>


<span class="k">def</span> <span class="nf">_recursive_compile_class</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">loc</span><span class="p">):</span>
    <span class="n">_qual_name</span> <span class="o">=</span> <span class="n">_qualified_name</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="c1"># We&#39;re starting a new compilation, so update the error call stack in</span>
    <span class="c1"># case it fails</span>
    <span class="n">error_stack</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">CallStack</span><span class="p">(</span><span class="n">_qual_name</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span>
    <span class="n">rcb</span> <span class="o">=</span> <span class="n">_jit_internal</span><span class="o">.</span><span class="n">createResolutionCallbackForClassMethods</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_compile_and_register_class</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">rcb</span><span class="p">,</span> <span class="n">_qual_name</span><span class="p">)</span>

<span class="n">CompilationUnit</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">CompilationUnit</span>
<span class="n">set_module</span><span class="p">(</span><span class="n">CompilationUnit</span><span class="p">,</span> <span class="s2">&quot;torch.jit&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">pad</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">padding</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">char</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">padding</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="n">padding</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">char</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">padding</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)])</span> <span class="o">+</span> <span class="n">s</span>


<span class="k">class</span> <span class="nc">_ScriptProfileColumn</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">alignment</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">header</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alignment</span> <span class="o">=</span> <span class="n">alignment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">add_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineno</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="n">lineno</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">materialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">max_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
        <span class="n">rows</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">cell</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">cell</span><span class="p">))</span>
            <span class="n">max_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cell</span><span class="p">),</span> <span class="n">max_length</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignment</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">padding</span> <span class="o">=</span> <span class="n">max_length</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignment</span>
            <span class="n">padding</span> <span class="o">-=</span> <span class="n">padding</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignment</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">padding</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">rows</span> <span class="o">=</span> <span class="p">[(</span><span class="n">key</span><span class="p">,</span> <span class="n">pad</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">padding</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">))</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">pad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="n">padding</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">),</span> <span class="n">rows</span>


<span class="k">class</span> <span class="nc">_ScriptProfileTable</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">_ScriptProfileColumn</span><span class="p">],</span> <span class="n">source_range</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cols</span> <span class="o">=</span> <span class="n">cols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_range</span> <span class="o">=</span> <span class="n">source_range</span>

    <span class="k">def</span> <span class="nf">dump_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">outputs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cells</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">header_buffer</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">:</span>
            <span class="n">header</span><span class="p">,</span> <span class="n">rows</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">materialize</span><span class="p">()</span>
            <span class="n">header_buffer</span> <span class="o">+=</span> <span class="n">header</span>
            <span class="n">cells</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">header</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">rows</span><span class="p">)))</span>

        <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">header_buffer</span><span class="p">)</span>
        <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pad</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">header_buffer</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_range</span><span class="p">:</span>
            <span class="n">row_buffer</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">header</span><span class="p">,</span> <span class="n">rows</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">:</span>
                <span class="n">cell</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cell</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">row_buffer</span> <span class="o">+=</span> <span class="n">pad</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">row_buffer</span> <span class="o">+=</span> <span class="n">cell</span>
            <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row_buffer</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_ScriptProfile</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile</span> <span class="o">=</span> <span class="n">classes</span><span class="o">.</span><span class="n">profiling</span><span class="o">.</span><span class="n">_ScriptProfile</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">enable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">disable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">dump_string</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">outputs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">source_stats</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">_dump_stats</span><span class="p">():</span>
            <span class="n">source_ref</span> <span class="o">=</span> <span class="n">source_stats</span><span class="o">.</span><span class="n">source</span><span class="p">()</span>
            <span class="n">source_lines</span> <span class="o">=</span> <span class="n">source_ref</span><span class="o">.</span><span class="n">text</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
            <span class="n">dedent</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">source_lines</span><span class="p">])</span>
            <span class="n">source_lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="n">dedent</span><span class="p">:]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">source_lines</span><span class="p">]</span>

            <span class="n">start_line</span> <span class="o">=</span> <span class="n">source_ref</span><span class="o">.</span><span class="n">starting_lineno</span><span class="p">()</span>
            <span class="n">end_line</span> <span class="o">=</span> <span class="n">start_line</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">source_lines</span><span class="p">)</span>
            <span class="n">source_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_line</span><span class="p">,</span> <span class="n">end_line</span><span class="p">)</span>
            <span class="n">lineno</span> <span class="o">=</span> <span class="n">_ScriptProfileColumn</span><span class="p">(</span><span class="s2">&quot;Line #&quot;</span><span class="p">)</span>
            <span class="n">hits</span> <span class="o">=</span> <span class="n">_ScriptProfileColumn</span><span class="p">(</span><span class="s2">&quot;Hits&quot;</span><span class="p">)</span>
            <span class="n">time_ns</span> <span class="o">=</span> <span class="n">_ScriptProfileColumn</span><span class="p">(</span><span class="s2">&quot;Time (ns)&quot;</span><span class="p">)</span>
            <span class="n">line_contents</span> <span class="o">=</span> <span class="n">_ScriptProfileColumn</span><span class="p">(</span><span class="s2">&quot;Line Contents&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="n">source_stats</span><span class="o">.</span><span class="n">line_map</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">source_range</span><span class="p">:</span>
                <span class="n">lineno</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="n">line_contents</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">source_lines</span><span class="p">[</span><span class="n">line</span> <span class="o">-</span> <span class="n">start_line</span><span class="p">])</span>
                <span class="n">stat</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">stat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">hits</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">stat</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
                    <span class="n">time_ns</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">stat</span><span class="o">.</span><span class="n">duration_ns</span><span class="p">())</span>

            <span class="n">table</span> <span class="o">=</span> <span class="n">_ScriptProfileTable</span><span class="p">([</span><span class="n">lineno</span><span class="p">,</span> <span class="n">hits</span><span class="p">,</span> <span class="n">time_ns</span><span class="p">,</span> <span class="n">line_contents</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">source_range</span><span class="p">))</span>
            <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">dump_string</span><span class="p">())</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dump_string</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">_unwrap_optional</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Unwrapping null optional&quot;</span>
    <span class="k">return</span> <span class="n">x</span>


<span class="n">_register_builtin</span><span class="p">(</span><span class="n">_unwrap_optional</span><span class="p">,</span> <span class="s2">&quot;aten::_unwrap_optional&quot;</span><span class="p">)</span>
<span class="n">_register_builtin</span><span class="p">(</span><span class="n">_jit_internal</span><span class="o">.</span><span class="n">is_scripting</span><span class="p">,</span> <span class="s2">&quot;aten::is_scripting&quot;</span><span class="p">)</span>
<span class="n">_register_builtin</span><span class="p">(</span><span class="n">has_torch_function</span><span class="p">,</span> <span class="s2">&quot;aten::has_torch_function&quot;</span><span class="p">)</span>
<span class="n">_register_builtin</span><span class="p">(</span><span class="n">has_torch_function_unary</span><span class="p">,</span> <span class="s2">&quot;aten::has_torch_function&quot;</span><span class="p">)</span>
<span class="n">_register_builtin</span><span class="p">(</span><span class="n">has_torch_function_variadic</span><span class="p">,</span> <span class="s2">&quot;aten::has_torch_function&quot;</span><span class="p">)</span>
</pre></div>

             </article>
             
            </div>
            <footer>
  

  

    <hr>

  

  <div role="contentinfo">
    <p>
        &copy; Copyright 2022, PyTorch Contributors.

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>
     

</footer>

          </div>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              
            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
         <script src="../../../_static/jquery.js"></script>
         <script src="../../../_static/underscore.js"></script>
         <script src="../../../_static/doctools.js"></script>
         <script src="../../../_static/clipboard.min.js"></script>
         <script src="../../../_static/copybutton.js"></script>
     

  

  <script type="text/javascript" src="../../../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 
<script script type="text/javascript">
  var collapsedSections = ['Notes', 'Language Bindings', 'Libraries', 'Community'];
</script>

<img height="1" width="1" style="border-style:none;" alt="" src="https://www.googleadservices.com/pagead/conversion/795629140/?label=txkmCPmdtosBENSssfsC&amp;guid=ON&amp;script=0"/>


  <!-- Begin Footer -->

  <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
    <div class="container">
      <div class="row">
        <div class="col-md-4 text-center">
          <h2>Docs</h2>
          <p>Access comprehensive developer documentation for PyTorch</p>
          <a class="with-right-arrow" href="https://pytorch.org/docs/stable/index.html">View Docs</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Tutorials</h2>
          <p>Get in-depth tutorials for beginners and advanced developers</p>
          <a class="with-right-arrow" href="https://pytorch.org/tutorials">View Tutorials</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Resources</h2>
          <p>Find development resources and get your questions answered</p>
          <a class="with-right-arrow" href="https://pytorch.org/resources">View Resources</a>
        </div>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container footer-container">
      <div class="footer-logo-wrapper">
        <a href="https://pytorch.org/" class="footer-logo"></a>
      </div>

      <div class="footer-links-wrapper">
        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/">PyTorch</a></li>
            <li><a href="https://pytorch.org/get-started">Get Started</a></li>
            <li><a href="https://pytorch.org/features">Features</a></li>
            <li><a href="https://pytorch.org/ecosystem">Ecosystem</a></li>
            <li><a href="https://pytorch.org/blog/">Blog</a></li>
            <li><a href="https://github.com/pytorch/pytorch/blob/master/CONTRIBUTING.md">Contributing</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/resources">Resources</a></li>
            <li><a href="https://pytorch.org/tutorials">Tutorials</a></li>
            <li><a href="https://pytorch.org/docs/stable/index.html">Docs</a></li>
            <li><a href="https://discuss.pytorch.org" target="_blank">Discuss</a></li>
            <li><a href="https://github.com/pytorch/pytorch/issues" target="_blank">Github Issues</a></li>
            <li><a href="https://pytorch.org/assets/brand-guidelines/PyTorch-Brand-Guidelines.pdf" target="_blank">Brand Guidelines</a></li>
          </ul>
        </div>

        <div class="footer-links-col follow-us-col">
          <ul>
            <li class="list-title">Stay Connected</li>
          </ul>

          <div class="footer-social-icons">
            <a href="https://www.facebook.com/pytorch" target="_blank" class="facebook"></a>
            <a href="https://twitter.com/pytorch" target="_blank" class="twitter"></a>
            <a href="https://www.youtube.com/pytorch" target="_blank" class="youtube"></a>
          </div>
        </div>
      </div>
    </div>
  </footer>

  <div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebookâ€™s Cookies Policy applies. Learn more, including about available controls: <a href="https://www.facebook.com/policies/cookies/">Cookies Policy</a>.</p>
    <img class="close-button" src="../../../_static/images/pytorch-x.svg">
  </div>
</div>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>

          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/hub">PyTorch Hub</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li class="resources-mobile-menu-title" class="active">
            Docs
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/docs/stable/index.html">PyTorch</a>
            </li>

            <li>
              <a href="https://pytorch.org/audio/stable/index.html">torchaudio</a>
            </li>

            <li>
              <a href="https://pytorch.org/text/stable/index.html">torchtext</a>
            </li>

            <li>
              <a href="https://pytorch.org/vision/stable/index.html">torchvision</a>
            </li>

            <li>
              <a href="https://pytorch.org/serve/">TorchServe</a>
            </li>

            <li>
              <a href="https://pytorch.org/torchx/">TorchX</a>
            </li>

            <li>
              <a href="https://pytorch.org/xla">PyTorch on XLA Devices</a>
            </li>
          </ul>

          <li class="resources-mobile-menu-title">
            Resources
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/resources">Developer Resources</a>
            </li>

            <li>
              <a href="https://pytorch.org/features">About</a>
            </li>

            <li>
              <a href="https://pytorch.org/hub">Models (Beta)</a>
            </li>

            <li>
              <a href="https://pytorch.org/#community-module">Community</a>
            </li>

            <li>
              <a href="https://discuss.pytorch.org/">Forums</a>
            </li>
          </ul>

          <li>
            <a href="https://github.com/pytorch/pytorch">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="../../../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>