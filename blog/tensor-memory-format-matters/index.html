<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-T8XT4PS');</script>
  <!-- End Google Tag Manager -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?">
  <title>
    
      Efficient PyTorch: Tensor Memory Format Matters | PyTorch
    
  </title>
  
  <meta property="og:title" content="Efficient PyTorch: Tensor Memory Format Matters" />
  <meta property="og:description" content="Ensuring the right memory format for your inputs can significantly impact the running time of your PyTorch vision models. When in doubt, choose a Channels Last memory format.

" />
  <meta property="og:image" content="https://pytorch.org/" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Efficient PyTorch: Tensor Memory Format Matters">
  <meta name="twitter:description" content="Ensuring the right memory format for your inputs can significantly impact the running time of your PyTorch vision models. When in doubt, choose a Channels Last memory format.

" />


<meta property="og:type" content="website" />
<meta name="robots" content="index, follow" />

  <link rel="stylesheet" href="/assets/main.css">
  <script src="/assets/vendor/jquery.min.js"></script>
  <script src="/assets/vendor/popper.min.js"></script>
  <script src="/assets/vendor/bootstrap.min.js"></script>
  <script src="/assets/vendor/anchor.min.js"></script>
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
        inlineMath: [['$','$']]
      }
    });
  </script>
  <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
  
    <script
  async
  src="https://www.googletagmanager.com/gtag/js?id=UA-117752657-2"
></script>

<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() {
    dataLayer.push(arguments);
  }
  gtag("js", new Date());
  gtag("config", "UA-117752657-2");
</script>

    <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window,document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '243028289693773');
    fbq('track', 'PageView');
</script>

<noscript>
  <img height="1" width="1"
  src="https://www.facebook.com/tr?id=243028289693773&ev=PageView
  &noscript=1"/>
</noscript>

    <!-- Twitter universal website tag code -->
<img height="1" width="1" style="display:none;" alt="" src="https://analytics.twitter.com/i/adsct?p_id=Twitter&p_user_id=0&txn_id=o2gi1&events=%5B%5B%22pageview%22%2Cnull%5D%5D&tw_sale_amount=0&tw_order_quantity=0 (https://urldefense.proofpoint.com/v2/url?u=https-3A__analytics.twitter.com_i_adsct-3Fp-5Fid-3DTwitter-26p-5Fuser-5Fid-3D0-26txn-5Fid-3Do2gi1-26events-3D-255B-255B-2522pageview-2522-252Cnull-255D-255D-26tw-5Fsale-5Famount-3D0-26tw-5Forder-5Fquantity-3D0&d=DwMGaQ&c=5VD0RTtNlTh3ycd41b3MUw&r=GMr8XYCDyeQQZuD3noL91A&m=dAJyokk16UvYy-vMrGn_JwYiGfp_eEgo25B9iGDCG-A&s=o6i4D0V0088WH2RnzIoqiF-vj45PL-2sTrsxQ0SNO3A&e=)" />
<img height="1" width="1" style="display:none;" alt="" src="//t.co/i/adsct?p_id=Twitter&p_user_id=0&txn_id=o2gi1&events=%5B%5B%22pageview%22%2Cnull%5D%5D&tw_sale_amount=0&tw_order_quantity=0 (https://urldefense.proofpoint.com/v2/url?u=https-3A__linkprotect.cudasvc.com_url-3Fa-3Dhttp-253a-252f-252ft.co-252fi-252fadsct-253fp-5Fid-253dTwitter-2526p-5Fuser-5Fid-253d0-2526txn-5Fid-253do2gi1-2526events-253d-25255B-25255B-252522pageview-252522-25252Cnull-25255D-25255D-2526tw-5Fsale-5Famount-253d0-2526tw-5Forder-5Fquantity-253d0-26c-3DE-2C1-2CC33dLwIhtuEcl5FhdztSnUwsioeej5k-2DWy0RYREBAq51kGji32A2Cw94YU9vQBpY5tPN3AukEw3C-5F-2DlbtndnLoR7-5FA-5FLoH0Rr7zLtP1ykptN-26typo-3D1&d=DwMGaQ&c=5VD0RTtNlTh3ycd41b3MUw&r=GMr8XYCDyeQQZuD3noL91A&m=dAJyokk16UvYy-vMrGn_JwYiGfp_eEgo25B9iGDCG-A&s=Abgc3XBkhESv8XBYtLchdDZyISGsK6v_BB6cLMJGyCw&e=)" />
<!-- End Twitter universal website tag code -->

  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />
  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Pythorch Blog Posts" />
</head>


<body class="blog">
    <!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T8XT4PS"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->

    <div class="main-background blog-background blog-detail-background"></div>

    <div class="container-fluid header-holder blog-detail-header">
        <div class="container">
            

<div class="header-container">
  <a class="header-logo" href="https://pytorch.org" aria-label="PyTorch"></a>

  <div class="main-menu">
  <ul>
    <li class="main-menu-item ">
      <a href="/get-started">Get Started</a>
    </li>

    <li class="main-menu-item">
      <div id="dropdownMenuButton" data-toggle="resources-dropdown" class="resources-dropdown">
        <a class="resource-option with-down-arrow" href="/ecosystem">
          Ecosystem 
        </a>
        <div class="resources-dropdown-menu">
          <a class="nav-dropdown-item" href="/ecosystem">
            <span class="dropdown-title">Tools</span>
            <p>Learn about the tools and frameworks in the PyTorch Ecosystem</p>
          </a>
          <a class="nav-dropdown-item" href="/ecosystem/pted/2021">
            <span class="dropdown-title">Ecosystem Day - 2021</span>
            <p>See the posters presented at ecosystem day 2021</p>
          </a>
          <a class="nav-dropdown-item" href="/ecosystem/ptdd/2021">
            <span class="dropdown-title">Developer Day - 2021</span>
            <p>See the posters presented at developer day 2021</p>
          </a>
          <a class="nav-dropdown-item" href="/ecosystem/ptc/2022">
            <span class="dropdown-title">PyTorch Conference - 2022</span>
            <p>See the posters presented at PyTorch conference - 2022</p>
          </a>

        </div>
      </div>
    </li>

    <li class="main-menu-item ">
      <a href="/mobile">Mobile</a>
    </li>

    <li class="main-menu-item active">
      <a href="/blog">Blog</a>
    </li>

    <li class="main-menu-item">
      <a href="https://pytorch.org/tutorials">Tutorials</a>
    </li>

    <li class="main-menu-item">
      <div id="docsDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
        <a class="doc-option with-down-arrow">
          Docs
        </a>
        <div class="resources-dropdown-menu">
          <a class="nav-dropdown-item" href="/docs">
            <span class="dropdown-title docs-title">PyTorch</span>
            <p></p>
          </a>
          <a class="nav-dropdown-item" href="/audio">
            <span class="dropdown-title docs-title">torchaudio</span>
            <p></p>
          </a>
          <a class="nav-dropdown-item" href="/text">
            <span class="dropdown-title docs-title">torchtext</span>
            <p></p>
          </a>
          <a class="nav-dropdown-item" href="/vision">
            <span class="dropdown-title docs-title">torchvision</span>
            <p></p>
          </a>
          <a class="nav-dropdown-item" href="/torcharrow">
            <span class="dropdown-title docs-title">torcharrow</span>
            <p></p>
          </a>
          <a class="nav-dropdown-item" href="/data">
            <span class="dropdown-title docs-title">TorchData</span>
            <p></p>
          </a>
          <a class="nav-dropdown-item" href="/torchrec">
            <span class="dropdown-title docs-title">TorchRec</span>
            <p></p>
          </a>
          <a class="nav-dropdown-item" href="/serve">
            <span class="dropdown-title docs-title">TorchServe</span>
            <p></p>
          </a>
          <a class="nav-dropdown-item" href="/xla/release/1.6/index.html">
            <span class="dropdown-title docs-title">PyTorch on XLA Devices</span>
            <p></p>
          </a>
        </div>
      </div>
    </li>

    

    <li class="main-menu-item ">

      <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
        <a class="resource-option with-down-arrow">
          Resources
        </a>
        <div class="resources-dropdown-menu">
          <a class="nav-dropdown-item" href="/features">
            <span class=dropdown-title>About</span>
            <p>Learn about PyTorch’s features and capabilities</p>
          </a>
          <a class="nav-dropdown-item" href="/foundation">
            <span class=dropdown-title>PyTorch Foundation</span>
            <p>Learn more about the PyTorch Foundation.</p>
          </a>
          <a class="nav-dropdown-item" href="/#community-module">
            <span class=dropdown-title>Community</span>
            <p>Join the PyTorch developer community to contribute, learn, and get your questions answered.</p>
          </a>
          <a class="nav-dropdown-item" href="/community-stories">
            <span class=dropdown-title>Community stories</span>
            <p>Learn how our community solves real, everyday machine learning problems with PyTorch</p>
          </a>
          <a class="nav-dropdown-item" href="/resources">
            <span class=dropdown-title>Developer Resources</span>
            <p>Find resources and get questions answered</p>
          </a>
          <a class="nav-dropdown-item" href="/events">
            <span class=dropdown-title>Events</span>
            <p>Find events, webinars, and podcasts</p>
          </a>
          <a class="nav-dropdown-item" href="https://discuss.pytorch.org" target="_blank">
            <span class=dropdown-title>Forums</span>
            <p>A place to discuss PyTorch code, issues, install, research</p>
          </a>
          <a class="nav-dropdown-item" href="/hub">
            <span class=dropdown-title>Models (Beta)</span>
            <p>Discover, publish, and reuse pre-trained models</p>
          </a>
        </div>
      </div>
    </li>

    <li class="main-menu-item" id="github-main-menu-link">
      <a href="https://github.com/pytorch/pytorch">GitHub</a>
    </li>

    <li class="navSearchWrapper reactNavSearchWrapper" key="search">
      <div class="search-border">
        <div id="search-icon"></div>
        <input
          id="search-input"
          type="text"
          title="Search"
        />
        <div id="close-search">X</div>
      </div>
    </li>
  </ul>
</div>

<script src="/assets/main-menu-dropdown.js"></script>


  <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
</div>

        </div>
    </div>

    <div class="jumbotron jumbotron-fluid blog-detail-jumbotron">
        <div class="container blog-detail-container">
            <p class="featured-post">December 15, 2021</p>
            <h1>
                <a class="blog-title">Efficient PyTorch: Tensor Memory Format Matters</a>
            </h1>
        </div>
    </div>

    <div class="main-content-wrapper blog-detail-wrapper">
        <div class="main-content blog-detail-content">
            <div class="container">
                <img src="/assets/images/logo-icon.svg" class="img-fluid author-icon">
                <article class="pytorch-article">
                    <p class="author">
                      by
                      
                        Dhruv Matani, Suraj Subramanian
                      
                    </p>
                    <p>Ensuring the right memory format for your inputs can significantly impact the running time of your PyTorch vision models. When in doubt, choose a Channels Last memory format.</p>

<p>When dealing with vision models in PyTorch that accept multimedia (for example image Tensorts) as input, the Tensor’s memory format can significantly impact <strong>the inference execution speed of your model on mobile platforms when using the CPU backend along with XNNPACK</strong>. This holds true for training and inference on server platforms as well, but latency is particularly critical for mobile devices and users.</p>

<style type="text/css">
article.pytorch-article table tr th, article.pytorch-article table td {line-height: 1.5rem}
</style>

<h2 id="outline-of-this-article">Outline of this article</h2>
<ol>
  <li>Deep Dive into matrix storage/memory representation in C++. Introduction to <a href="https://en.wikipedia.org/wiki/Row-_and_column-major_order">Row and Column major order</a>.</li>
  <li>Impact of looping over a matrix in the same or different order as the storage representation, along with an example.</li>
  <li>Introduction to Cachegrind; a tool to inspect the cache friendliness of your code.</li>
  <li>Memory formats supported by PyTorch Operators.</li>
  <li>Best practices example to ensure efficient model execution with XNNPACK optimizations</li>
</ol>

<h2 id="matrix-storage-representation-in-c">Matrix Storage Representation in C++</h2>

<p>Images are fed into PyTorch ML models as multi-dimensional Tensors. These Tensors have specific memory formats. To understand this concept better, let’s take a look at how a 2-d matrix may be stored in memory.</p>

<p>Broadly speaking, there are 2 main ways of efficiently storing multi-dimensional data in memory.</p>
<ol>
  <li><strong>Row Major Order:</strong> In this format, the matrix is stored in row order, with each row stored before the next row in memory. I.e. row N comes before row N+1.</li>
  <li><strong>Column Major Order:</strong> In this format, the matrix is stored in column-order, with each column stored before the next column in memory. I.e. column N comes before column N+1.</li>
</ol>

<p>You can see the differences graphically below.</p>

<p align="center">
<img src="/assets/images/tensor/image1.png" alt="C++ stores multi-dimensional data in row-major format." width="100%" />
<br />
C++ stores multi-dimensional data in row-major format.
</p>

<h2 id="efficiently-accessing-elements-of-a-2d-matrix">Efficiently accessing elements of a 2d matrix</h2>

<p>Similar to the storage format, there are 2 ways to access data in a 2d matrix.</p>

<ol>
  <li><strong>Loop Over Rows first:</strong> All elements of a row are processed before any element of the next row.</li>
  <li><strong>Loop Over Columns first:</strong> All elements of a column are processed before any element of the next column.</li>
</ol>

<p>For maximum efficiency, one should always access data in the same format in which it is stored. I.e. if the data is stored in row-major order, then one should try to access it in that order.</p>

<p>The code below (main.cpp) shows <a href="https://stackoverflow.com/questions/9936132/why-does-the-order-of-the-loops-affect-performance-when-iterating-over-a-2d-arra">2 ways</a> of accessing all the elements of a 2d 4000x4000 matrix.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#include &lt;iostream&gt;
#include &lt;chrono&gt;
</span>
<span class="o">//</span> <span class="n">loop1</span> <span class="n">accesses</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">matrix</span> <span class="s">'a'</span> <span class="ow">in</span> <span class="n">row</span> <span class="n">major</span> <span class="n">order</span><span class="p">,</span>
<span class="o">//</span> <span class="n">since</span> <span class="n">i</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">outer</span> <span class="n">loop</span> <span class="n">variable</span><span class="p">,</span> <span class="ow">and</span> <span class="n">j</span> <span class="ow">is</span> <span class="n">the</span>
<span class="o">//</span> <span class="n">inner</span> <span class="n">loop</span> <span class="n">variable</span><span class="p">.</span>
<span class="nb">int</span> <span class="n">loop1</span><span class="p">(</span><span class="nb">int</span> <span class="n">a</span><span class="p">[</span><span class="mi">4000</span><span class="p">][</span><span class="mi">4000</span><span class="p">])</span> <span class="p">{</span>
 <span class="nb">int</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4000</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4000</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
     <span class="n">s</span> <span class="o">+=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
   <span class="p">}</span>
 <span class="p">}</span>
 <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">loop2</span> <span class="n">accesses</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">matrix</span> <span class="s">'a'</span> <span class="ow">in</span> <span class="n">column</span> <span class="n">major</span> <span class="n">order</span>
<span class="o">//</span> <span class="n">since</span> <span class="n">j</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">outer</span> <span class="n">loop</span> <span class="n">variable</span><span class="p">,</span> <span class="ow">and</span> <span class="n">i</span> <span class="ow">is</span> <span class="n">the</span>
<span class="o">//</span> <span class="n">inner</span> <span class="n">loop</span> <span class="n">variable</span><span class="p">.</span>
<span class="nb">int</span> <span class="n">loop2</span><span class="p">(</span><span class="nb">int</span> <span class="n">a</span><span class="p">[</span><span class="mi">4000</span><span class="p">][</span><span class="mi">4000</span><span class="p">])</span> <span class="p">{</span>
 <span class="nb">int</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4000</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4000</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
     <span class="n">s</span> <span class="o">+=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
   <span class="p">}</span>
 <span class="p">}</span>
 <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
<span class="p">}</span>

<span class="nb">int</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
 <span class="n">static</span> <span class="nb">int</span> <span class="n">a</span><span class="p">[</span><span class="mi">4000</span><span class="p">][</span><span class="mi">4000</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
 <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
   <span class="nb">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="mi">4000</span><span class="p">;</span>
   <span class="nb">int</span> <span class="n">y</span> <span class="o">=</span> <span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="mi">4000</span><span class="p">;</span>
   <span class="n">a</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">;</span>
 <span class="p">}</span>

 <span class="n">auto</span> <span class="n">start</span> <span class="o">=</span> <span class="n">std</span><span class="p">::</span><span class="n">chrono</span><span class="p">::</span><span class="n">high_resolution_clock</span><span class="p">::</span><span class="n">now</span><span class="p">();</span>
 <span class="n">auto</span> <span class="n">end</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
 <span class="nb">int</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="c1">#if defined RUN_LOOP1
</span> <span class="n">start</span> <span class="o">=</span> <span class="n">std</span><span class="p">::</span><span class="n">chrono</span><span class="p">::</span><span class="n">high_resolution_clock</span><span class="p">::</span><span class="n">now</span><span class="p">();</span>

 <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">s</span> <span class="o">+=</span> <span class="n">loop1</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
   <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">%</span> <span class="mi">100</span><span class="p">;</span>
 <span class="p">}</span>
 <span class="n">end</span> <span class="o">=</span> <span class="n">std</span><span class="p">::</span><span class="n">chrono</span><span class="p">::</span><span class="n">high_resolution_clock</span><span class="p">::</span><span class="n">now</span><span class="p">();</span>

 <span class="n">std</span><span class="p">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"s = "</span> <span class="o">&lt;&lt;</span> <span class="n">s</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="p">::</span><span class="n">endl</span><span class="p">;</span>
 <span class="n">std</span><span class="p">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Time for loop1: "</span>
   <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="p">::</span><span class="n">chrono</span><span class="p">::</span><span class="n">duration</span><span class="o">&lt;</span><span class="n">double</span><span class="p">,</span> <span class="n">std</span><span class="p">::</span><span class="n">milli</span><span class="o">&gt;</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">).</span><span class="n">count</span><span class="p">()</span>
   <span class="o">&lt;&lt;</span> <span class="s">"ms"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="p">::</span><span class="n">endl</span><span class="p">;</span>
<span class="c1">#endif
</span>
<span class="c1">#if defined RUN_LOOP2
</span> <span class="n">start</span> <span class="o">=</span> <span class="n">std</span><span class="p">::</span><span class="n">chrono</span><span class="p">::</span><span class="n">high_resolution_clock</span><span class="p">::</span><span class="n">now</span><span class="p">();</span>
 <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">s</span> <span class="o">+=</span> <span class="n">loop2</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
   <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">%</span> <span class="mi">100</span><span class="p">;</span>
 <span class="p">}</span>
 <span class="n">end</span> <span class="o">=</span> <span class="n">std</span><span class="p">::</span><span class="n">chrono</span><span class="p">::</span><span class="n">high_resolution_clock</span><span class="p">::</span><span class="n">now</span><span class="p">();</span>

 <span class="n">std</span><span class="p">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"s = "</span> <span class="o">&lt;&lt;</span> <span class="n">s</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="p">::</span><span class="n">endl</span><span class="p">;</span>
 <span class="n">std</span><span class="p">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Time for loop2: "</span>
   <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="p">::</span><span class="n">chrono</span><span class="p">::</span><span class="n">duration</span><span class="o">&lt;</span><span class="n">double</span><span class="p">,</span> <span class="n">std</span><span class="p">::</span><span class="n">milli</span><span class="o">&gt;</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">).</span><span class="n">count</span><span class="p">()</span>
   <span class="o">&lt;&lt;</span> <span class="s">"ms"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="p">::</span><span class="n">endl</span><span class="p">;</span>
<span class="c1">#endif
</span><span class="p">}</span>


<span class="n">Let</span><span class="err">’</span><span class="n">s</span> <span class="n">build</span> <span class="ow">and</span> <span class="n">run</span> <span class="n">this</span> <span class="n">program</span> <span class="ow">and</span> <span class="n">see</span> <span class="n">what</span> <span class="n">it</span> <span class="n">prints</span><span class="p">.</span>

<span class="n">g</span><span class="o">++</span> <span class="o">-</span><span class="n">O2</span> <span class="n">main</span><span class="p">.</span><span class="n">cpp</span> <span class="o">-</span><span class="n">DRUN_LOOP1</span> <span class="o">-</span><span class="n">DRUN_LOOP2</span>
<span class="p">.</span><span class="o">/</span><span class="n">a</span><span class="p">.</span><span class="n">out</span>


<span class="n">Prints</span> <span class="n">the</span> <span class="n">following</span><span class="p">:</span>

<span class="n">s</span> <span class="o">=</span> <span class="mi">70</span>
<span class="n">Time</span> <span class="k">for</span> <span class="n">loop1</span><span class="p">:</span> <span class="mf">77.0687</span><span class="n">ms</span>
<span class="n">s</span> <span class="o">=</span> <span class="mi">70</span>
<span class="n">Time</span> <span class="k">for</span> <span class="n">loop2</span><span class="p">:</span> <span class="mf">1219.49</span><span class="n">ms</span>
</code></pre></div></div>

<p>loop1() is <strong>15x faster</strong> than loop2(). Why is that? Let’s find out below!</p>

<h2 id="measure-cache-misses-using-cachegrind">Measure cache misses using Cachegrind</h2>

<p><a href="https://courses.cs.washington.edu/courses/cse326/05wi/valgrind-doc/cg_main.html">Cachegrind</a> is a cache profiling tool used to see how many I1 (first level instruction), D1 (first level data), and LL (last level) cache misses your program caused.</p>

<p>Let’s build our program with just loop1() and just loop2() to see how cache friendly each of these functions is.</p>

<h3 id="build-and-runprofile-just-loop1">Build and run/profile just loop1()</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">g</span><span class="o">++</span> <span class="o">-</span><span class="n">O2</span> <span class="n">main</span><span class="p">.</span><span class="n">cpp</span> <span class="o">-</span><span class="n">DRUN_LOOP1</span>
<span class="n">valgrind</span> <span class="o">--</span><span class="n">tool</span><span class="o">=</span><span class="n">cachegrind</span> <span class="p">.</span><span class="o">/</span><span class="n">a</span><span class="p">.</span><span class="n">out</span>
</code></pre></div></div>

<h4 id="prints">Prints:</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">==</span><span class="mi">3299700</span><span class="o">==</span>
<span class="o">==</span><span class="mi">3299700</span><span class="o">==</span> <span class="n">I</span>   <span class="n">refs</span><span class="p">:</span>      <span class="mi">643</span><span class="p">,</span><span class="mi">156</span><span class="p">,</span><span class="mi">721</span>
<span class="o">==</span><span class="mi">3299700</span><span class="o">==</span> <span class="n">I1</span>  <span class="n">misses</span><span class="p">:</span>          <span class="mi">2</span><span class="p">,</span><span class="mi">077</span>
<span class="o">==</span><span class="mi">3299700</span><span class="o">==</span> <span class="n">LLi</span> <span class="n">misses</span><span class="p">:</span>          <span class="mi">2</span><span class="p">,</span><span class="mi">021</span>
<span class="o">==</span><span class="mi">3299700</span><span class="o">==</span> <span class="n">I1</span>  <span class="n">miss</span> <span class="n">rate</span><span class="p">:</span>        <span class="mf">0.00</span><span class="o">%</span>
<span class="o">==</span><span class="mi">3299700</span><span class="o">==</span> <span class="n">LLi</span> <span class="n">miss</span> <span class="n">rate</span><span class="p">:</span>        <span class="mf">0.00</span><span class="o">%</span>
<span class="o">==</span><span class="mi">3299700</span><span class="o">==</span>
<span class="o">==</span><span class="mi">3299700</span><span class="o">==</span> <span class="n">D</span>   <span class="n">refs</span><span class="p">:</span>      <span class="mi">160</span><span class="p">,</span><span class="mi">952</span><span class="p">,</span><span class="mi">192</span>  <span class="p">(</span><span class="mi">160</span><span class="p">,</span><span class="mi">695</span><span class="p">,</span><span class="mi">444</span> <span class="n">rd</span>   <span class="o">+</span> <span class="mi">256</span><span class="p">,</span><span class="mi">748</span> <span class="n">wr</span><span class="p">)</span>
<span class="o">==</span><span class="mi">3299700</span><span class="o">==</span> <span class="n">D1</span>  <span class="n">misses</span><span class="p">:</span>     <span class="mi">10</span><span class="p">,</span><span class="mi">021</span><span class="p">,</span><span class="mi">300</span>  <span class="p">(</span> <span class="mi">10</span><span class="p">,</span><span class="mi">018</span><span class="p">,</span><span class="mi">723</span> <span class="n">rd</span>   <span class="o">+</span>   <span class="mi">2</span><span class="p">,</span><span class="mi">577</span> <span class="n">wr</span><span class="p">)</span>
<span class="o">==</span><span class="mi">3299700</span><span class="o">==</span> <span class="n">LLd</span> <span class="n">misses</span><span class="p">:</span>     <span class="mi">10</span><span class="p">,</span><span class="mi">010</span><span class="p">,</span><span class="mi">916</span>  <span class="p">(</span> <span class="mi">10</span><span class="p">,</span><span class="mi">009</span><span class="p">,</span><span class="mi">147</span> <span class="n">rd</span>   <span class="o">+</span>   <span class="mi">1</span><span class="p">,</span><span class="mi">769</span> <span class="n">wr</span><span class="p">)</span>
<span class="o">==</span><span class="mi">3299700</span><span class="o">==</span> <span class="n">D1</span>  <span class="n">miss</span> <span class="n">rate</span><span class="p">:</span>         <span class="mf">6.2</span><span class="o">%</span> <span class="p">(</span>        <span class="mf">6.2</span><span class="o">%</span>     <span class="o">+</span>     <span class="mf">1.0</span><span class="o">%</span>  <span class="p">)</span>
<span class="o">==</span><span class="mi">3299700</span><span class="o">==</span> <span class="n">LLd</span> <span class="n">miss</span> <span class="n">rate</span><span class="p">:</span>         <span class="mf">6.2</span><span class="o">%</span> <span class="p">(</span>        <span class="mf">6.2</span><span class="o">%</span>     <span class="o">+</span>     <span class="mf">0.7</span><span class="o">%</span>  <span class="p">)</span>
<span class="o">==</span><span class="mi">3299700</span><span class="o">==</span>
<span class="o">==</span><span class="mi">3299700</span><span class="o">==</span> <span class="n">LL</span> <span class="n">refs</span><span class="p">:</span>        <span class="mi">10</span><span class="p">,</span><span class="mi">023</span><span class="p">,</span><span class="mi">377</span>  <span class="p">(</span> <span class="mi">10</span><span class="p">,</span><span class="mi">020</span><span class="p">,</span><span class="mi">800</span> <span class="n">rd</span>   <span class="o">+</span>   <span class="mi">2</span><span class="p">,</span><span class="mi">577</span> <span class="n">wr</span><span class="p">)</span>
<span class="o">==</span><span class="mi">3299700</span><span class="o">==</span> <span class="n">LL</span> <span class="n">misses</span><span class="p">:</span>      <span class="mi">10</span><span class="p">,</span><span class="mi">012</span><span class="p">,</span><span class="mi">937</span>  <span class="p">(</span> <span class="mi">10</span><span class="p">,</span><span class="mi">011</span><span class="p">,</span><span class="mi">168</span> <span class="n">rd</span>   <span class="o">+</span>   <span class="mi">1</span><span class="p">,</span><span class="mi">769</span> <span class="n">wr</span><span class="p">)</span>
<span class="o">==</span><span class="mi">3299700</span><span class="o">==</span> <span class="n">LL</span> <span class="n">miss</span> <span class="n">rate</span><span class="p">:</span>          <span class="mf">1.2</span><span class="o">%</span> <span class="p">(</span>        <span class="mf">1.2</span><span class="o">%</span>     <span class="o">+</span>     <span class="mf">0.7</span><span class="o">%</span>  <span class="p">)</span>
</code></pre></div></div>

<h3 id="build-and-runprofile-just-loop2">Build and run/profile just loop2()</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">g</span><span class="o">++</span> <span class="o">-</span><span class="n">O2</span> <span class="n">main</span><span class="p">.</span><span class="n">cpp</span> <span class="o">-</span><span class="n">DRUN_LOOP2</span>
<span class="n">valgrind</span> <span class="o">--</span><span class="n">tool</span><span class="o">=</span><span class="n">cachegrind</span> <span class="p">.</span><span class="o">/</span><span class="n">a</span><span class="p">.</span><span class="n">out</span>
</code></pre></div></div>

<h4 id="prints-1">Prints:</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">==</span><span class="mi">3300389</span><span class="o">==</span>
<span class="o">==</span><span class="mi">3300389</span><span class="o">==</span> <span class="n">I</span>   <span class="n">refs</span><span class="p">:</span>      <span class="mi">643</span><span class="p">,</span><span class="mi">156</span><span class="p">,</span><span class="mi">726</span>
<span class="o">==</span><span class="mi">3300389</span><span class="o">==</span> <span class="n">I1</span>  <span class="n">misses</span><span class="p">:</span>          <span class="mi">2</span><span class="p">,</span><span class="mi">075</span>
<span class="o">==</span><span class="mi">3300389</span><span class="o">==</span> <span class="n">LLi</span> <span class="n">misses</span><span class="p">:</span>          <span class="mi">2</span><span class="p">,</span><span class="mi">018</span>
<span class="o">==</span><span class="mi">3300389</span><span class="o">==</span> <span class="n">I1</span>  <span class="n">miss</span> <span class="n">rate</span><span class="p">:</span>        <span class="mf">0.00</span><span class="o">%</span>
<span class="o">==</span><span class="mi">3300389</span><span class="o">==</span> <span class="n">LLi</span> <span class="n">miss</span> <span class="n">rate</span><span class="p">:</span>        <span class="mf">0.00</span><span class="o">%</span>
<span class="o">==</span><span class="mi">3300389</span><span class="o">==</span>
<span class="o">==</span><span class="mi">3300389</span><span class="o">==</span> <span class="n">D</span>   <span class="n">refs</span><span class="p">:</span>      <span class="mi">160</span><span class="p">,</span><span class="mi">952</span><span class="p">,</span><span class="mi">196</span>  <span class="p">(</span><span class="mi">160</span><span class="p">,</span><span class="mi">695</span><span class="p">,</span><span class="mi">447</span> <span class="n">rd</span>   <span class="o">+</span> <span class="mi">256</span><span class="p">,</span><span class="mi">749</span> <span class="n">wr</span><span class="p">)</span>
<span class="o">==</span><span class="mi">3300389</span><span class="o">==</span> <span class="n">D1</span>  <span class="n">misses</span><span class="p">:</span>    <span class="mi">160</span><span class="p">,</span><span class="mi">021</span><span class="p">,</span><span class="mi">290</span>  <span class="p">(</span><span class="mi">160</span><span class="p">,</span><span class="mi">018</span><span class="p">,</span><span class="mi">713</span> <span class="n">rd</span>   <span class="o">+</span>   <span class="mi">2</span><span class="p">,</span><span class="mi">577</span> <span class="n">wr</span><span class="p">)</span>
<span class="o">==</span><span class="mi">3300389</span><span class="o">==</span> <span class="n">LLd</span> <span class="n">misses</span><span class="p">:</span>     <span class="mi">10</span><span class="p">,</span><span class="mi">014</span><span class="p">,</span><span class="mi">907</span>  <span class="p">(</span> <span class="mi">10</span><span class="p">,</span><span class="mi">013</span><span class="p">,</span><span class="mi">138</span> <span class="n">rd</span>   <span class="o">+</span>   <span class="mi">1</span><span class="p">,</span><span class="mi">769</span> <span class="n">wr</span><span class="p">)</span>
<span class="o">==</span><span class="mi">3300389</span><span class="o">==</span> <span class="n">D1</span>  <span class="n">miss</span> <span class="n">rate</span><span class="p">:</span>        <span class="mf">99.4</span><span class="o">%</span> <span class="p">(</span>       <span class="mf">99.6</span><span class="o">%</span>     <span class="o">+</span>     <span class="mf">1.0</span><span class="o">%</span>  <span class="p">)</span>
<span class="o">==</span><span class="mi">3300389</span><span class="o">==</span> <span class="n">LLd</span> <span class="n">miss</span> <span class="n">rate</span><span class="p">:</span>         <span class="mf">6.2</span><span class="o">%</span> <span class="p">(</span>        <span class="mf">6.2</span><span class="o">%</span>     <span class="o">+</span>     <span class="mf">0.7</span><span class="o">%</span>  <span class="p">)</span>
<span class="o">==</span><span class="mi">3300389</span><span class="o">==</span>
<span class="o">==</span><span class="mi">3300389</span><span class="o">==</span> <span class="n">LL</span> <span class="n">refs</span><span class="p">:</span>       <span class="mi">160</span><span class="p">,</span><span class="mi">023</span><span class="p">,</span><span class="mi">365</span>  <span class="p">(</span><span class="mi">160</span><span class="p">,</span><span class="mi">020</span><span class="p">,</span><span class="mi">788</span> <span class="n">rd</span>   <span class="o">+</span>   <span class="mi">2</span><span class="p">,</span><span class="mi">577</span> <span class="n">wr</span><span class="p">)</span>
<span class="o">==</span><span class="mi">3300389</span><span class="o">==</span> <span class="n">LL</span> <span class="n">misses</span><span class="p">:</span>      <span class="mi">10</span><span class="p">,</span><span class="mi">016</span><span class="p">,</span><span class="mi">925</span>  <span class="p">(</span> <span class="mi">10</span><span class="p">,</span><span class="mi">015</span><span class="p">,</span><span class="mi">156</span> <span class="n">rd</span>   <span class="o">+</span>   <span class="mi">1</span><span class="p">,</span><span class="mi">769</span> <span class="n">wr</span><span class="p">)</span>
<span class="o">==</span><span class="mi">3300389</span><span class="o">==</span> <span class="n">LL</span> <span class="n">miss</span> <span class="n">rate</span><span class="p">:</span>          <span class="mf">1.2</span><span class="o">%</span> <span class="p">(</span>        <span class="mf">1.2</span><span class="o">%</span>     <span class="o">+</span>     <span class="mf">0.7</span><span class="o">%</span>  <span class="p">)</span>
</code></pre></div></div>

<p>The main differences between the 2 runs are:</p>
<ol>
  <li><strong>D1 misses:</strong> 10M v/s 160M</li>
  <li><strong>D1 miss rate:</strong> 6.2% v/s 99.4%</li>
</ol>

<p>As you can see, <code class="language-plaintext highlighter-rouge">loop2()</code> causes many many more (<strong>~16x more</strong>) L1 data cache misses than loop1(). This is why <code class="language-plaintext highlighter-rouge">loop1()</code> is ~15x faster than loop2().</p>

<h2 id="memory-formats-supported-by-pytorch-operators">Memory Formats supported by PyTorch Operators</h2>

<p>While PyTorch operators expect all tensors to be in <a href="https://discuss.pytorch.org/t/why-does-pytorch-prefer-using-nchw/83637/4">Channels First (NCHW) dimension format</a>, PyTorch operators support 3 output <a href="https://github.com/pytorch/pytorch/blob/master/c10/core/MemoryFormat.h">memory formats</a>.</p>

<ol>
  <li><strong>Contiguous:</strong> Tensor memory is in the same order as the tensor’s dimensions.</li>
  <li><strong>ChannelsLast:</strong> Irrespective of the dimension order, the 2d (image) tensor is laid out as an HWC or <a href="https://oneapi-src.github.io/oneDNN/dev_guide_understanding_memory_formats.html">NHWC</a> (N: batch, H: height, W: width, C: channels) tensor in memory. The dimensions could be permuted in any order.</li>
  <li><strong>ChannelsLast3d:</strong> For 3d tensors (video tensors), the memory is laid out in THWC (Time, Height, Width, Channels) or NTHWC (N: batch, T: time, H: height, W: width, C: channels) format. The dimensions could be permuted in any order.</li>
</ol>

<p>The reason that ChannelsLast is preferred for vision models is because <a href="https://github.com/google/XNNPACK">XNNPACK</a> (kernel acceleration library) used by PyTorch expects all inputs to be in <strong>Channels Last</strong> format, so if the input to the model isn’t channels last, then it must first be converted to channels last, which is an additional operation.</p>

<p>Additionally, most PyTorch operators preserve the input tensor’s memory format, so if the input is Channels First, then the operator needs to first convert to Channels Last, then perform the operation, and then convert back to Channels First.</p>

<p>When you combine it with the fact that accelerated operators work better with a channels last memory format, you’ll notice that having the operator return back a channels-last memory format is better for subsequent operator calls or you’ll end up having every operator convert to channels-last (should it be more efficient for that specific operator).</p>

<p>From the XNNPACK home page:</p>

<blockquote>
  <p>“All operators in XNNPACK support NHWC layout, but additionally allow custom stride along the Channel dimension”.</p>
</blockquote>

<h2 id="pytorch-best-practice">PyTorch Best Practice</h2>

<p>The best way to get the most performance from your PyTorch vision models is to ensure that your input tensor is in a <strong>Channels Last</strong> <a href="https://pytorch.org/tutorials/intermediate/memory_format_tutorial.html">memory format</a> before it is fed into the model.</p>

<p>You can get even more speedups by optimizing your model to use the XNNPACK backend (by simply calling <code class="language-plaintext highlighter-rouge">optimize_for_mobile()</code> on your torchscripted model). Note that XNNPACK models will run slower if the inputs are contiguous, so definitely make sure it is in Channels-Last format.</p>

<h2 id="working-example-showing-speedup">Working example showing speedup</h2>

<p>Run this example on <a href="https://colab.research.google.com/gist/suraj813/ad9aebcbffbdd6d02b23ca7231130a30/channels-last-with-xnnpack.ipynb#scrollTo=xvJN73YWXgDF">Google Colab</a> - note that runtimes on colab CPUs might not reflect accurate performance; it is recommended to run this code on your local machine.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch.utils.mobile_optimizer</span> <span class="kn">import</span> <span class="n">optimize_for_mobile</span>
<span class="kn">import</span> <span class="nn">torch.backends.xnnpack</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">print</span><span class="p">(</span><span class="s">"XNNPACK is enabled: "</span><span class="p">,</span> <span class="n">torch</span><span class="p">.</span><span class="n">backends</span><span class="p">.</span><span class="n">xnnpack</span><span class="p">.</span><span class="n">enabled</span><span class="p">,</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>

<span class="n">N</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">W</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">200</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">rand</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Contiguous shape: "</span><span class="p">,</span> <span class="n">x</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Contiguous stride: "</span><span class="p">,</span> <span class="n">x</span><span class="p">.</span><span class="n">stride</span><span class="p">())</span>
<span class="k">print</span><span class="p">()</span>

<span class="n">xcl</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">memory_format</span><span class="o">=</span><span class="n">torch</span><span class="p">.</span><span class="n">channels_last</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Channels-Last shape: "</span><span class="p">,</span> <span class="n">xcl</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Channels-Last stride: "</span><span class="p">,</span> <span class="n">xcl</span><span class="p">.</span><span class="n">stride</span><span class="p">())</span>

<span class="c1">## Outputs:
</span> 
<span class="c1"># XNNPACK is enabled:  True
</span> 
<span class="c1"># Contiguous shape:  torch.Size([1, 3, 200, 200])
# Contiguous stride:  (120000, 40000, 200, 1)
</span> 
<span class="c1"># Channels-Last shape:  torch.Size([1, 3, 200, 200])
# Channels-Last stride:  (120000, 1, 600, 3)
</span>
</code></pre></div></div>

<p>The input shape stays the same for contiguous and channels-last formats. Internally however, the tensor’s layout has changed as you can see in the strides. Now, the number of jumps required to go across channels is only 1 (instead of 40000 in the contiguous tensor).
This better data locality means convolution layers can access all the channels for a given pixel much faster. Let’s see now how the memory format affects runtime:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">torchvision.models</span> <span class="kn">import</span> <span class="n">resnet34</span><span class="p">,</span> <span class="n">resnet50</span><span class="p">,</span> <span class="n">resnet101</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">resnet34</span><span class="p">(</span><span class="n">pretrained</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="c1"># m = resnet50(pretrained=False)
# m = resnet101(pretrained=False)
</span>
<span class="k">def</span> <span class="nf">get_optimized_model</span><span class="p">(</span><span class="n">mm</span><span class="p">):</span>
  <span class="n">mm</span> <span class="o">=</span> <span class="n">mm</span><span class="p">.</span><span class="nb">eval</span><span class="p">()</span>
  <span class="n">scripted</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">jit</span><span class="p">.</span><span class="n">script</span><span class="p">(</span><span class="n">mm</span><span class="p">)</span>
  <span class="n">optimized</span> <span class="o">=</span> <span class="n">optimize_for_mobile</span><span class="p">(</span><span class="n">scripted</span><span class="p">)</span>  <span class="c1"># explicitly call the xnnpack rewrite 
</span>  <span class="k">return</span> <span class="n">scripted</span><span class="p">,</span> <span class="n">optimized</span>


<span class="k">def</span> <span class="nf">compare_contiguous_CL</span><span class="p">(</span><span class="n">mm</span><span class="p">):</span>
  <span class="c1"># inference on contiguous
</span>  <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">perf_counter</span><span class="p">()</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
    <span class="n">mm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">perf_counter</span><span class="p">()</span>
  <span class="k">print</span><span class="p">(</span><span class="s">"Contiguous: "</span><span class="p">,</span> <span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>

  <span class="c1"># inference on channels-last
</span>  <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">perf_counter</span><span class="p">()</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
    <span class="n">mm</span><span class="p">(</span><span class="n">xcl</span><span class="p">)</span>
  <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">perf_counter</span><span class="p">()</span>
  <span class="k">print</span><span class="p">(</span><span class="s">"Channels-Last: "</span><span class="p">,</span> <span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>

<span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="n">inference_mode</span><span class="p">():</span>
  <span class="n">scripted</span><span class="p">,</span> <span class="n">optimized</span> <span class="o">=</span> <span class="n">get_optimized_model</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

  <span class="k">print</span><span class="p">(</span><span class="s">"Runtimes for torchscripted model: "</span><span class="p">)</span>
  <span class="n">compare_contiguous_CL</span><span class="p">(</span><span class="n">scripted</span><span class="p">.</span><span class="nb">eval</span><span class="p">())</span>
  <span class="k">print</span><span class="p">()</span>
  <span class="k">print</span><span class="p">(</span><span class="s">"Runtimes for mobile-optimized model: "</span><span class="p">)</span>
  <span class="n">compare_contiguous_CL</span><span class="p">(</span><span class="n">optimized</span><span class="p">.</span><span class="nb">eval</span><span class="p">())</span>

   
<span class="c1">## Outputs (on an Intel Core i9 CPU):
</span> 
<span class="c1"># Runtimes for torchscripted model:
# Contiguous:  1.6711160129999598
# Channels-Last:  1.6678222839999535
</span> 
<span class="c1"># Runtimes for mobile-optimized model:
# Contiguous:  0.5712863490000473
# Channels-Last:  0.46113000699995155
</span>
</code></pre></div></div>

<h2 id="conclusion">Conclusion</h2>

<p>The Memory Layout of an input tensor can significantly impact a model’s running time. For Vision Models, prefer a <strong>Channels Last</strong> memory format to get the most out of your PyTorch models.</p>

<h2 id="references">References</h2>

<ul>
  <li><a href="https://en.wikipedia.org/wiki/Row-_and_column-major_order">Row/Column Major matrix storage order</a></li>
  <li><a href="https://stackoverflow.com/questions/9936132/why-does-the-order-of-the-loops-affect-performance-when-iterating-over-a-2d-arra">Loop order impact on performance</a></li>
  <li><a href="https://courses.cs.washington.edu/courses/cse326/05wi/valgrind-doc/cg_main.html">Cachegrind: a cache-miss profiler</a></li>
  <li><a href="https://oneapi-src.github.io/oneDNN/dev_guide_understanding_memory_formats.html">NHWC format explained</a></li>
  <li><a href="https://discuss.pytorch.org/t/why-does-pytorch-prefer-using-nchw/83637/4">Why does PyTorch prefer NCHW?</a></li>
  <li><a href="https://github.com/google/XNNPACK">XNNPACK</a></li>
  <li><a href="https://pytorch.org/tutorials/intermediate/memory_format_tutorial.html">PyTorch memory format tutorial</a></li>
  <li><a href="https://github.com/pytorch/pytorch/wiki/Operators-with-Channels-Last-support">Supported operators</a></li>
</ul>

                </article>
            </div>
        </div>
    </div>

<!--    


 -->
    <div class="container-fluid docs-tutorials-resources">
  <div class="container">
    <div class="row">
      <div class="col-md-4 text-center">
        <h2>Docs</h2>
        <p>Access comprehensive developer documentation for PyTorch</p>
        <a class="with-right-arrow" href="/docs">View Docs</a>
      </div>

      <div class="col-md-4 text-center">
        <h2>Tutorials</h2>
        <p>Get in-depth tutorials for beginners and advanced developers</p>
        <a class="with-right-arrow" href="https://pytorch.org/tutorials">View Tutorials</a>
      </div>

      <div class="col-md-4 text-center">
        <h2>Resources</h2>
        <p>Find development resources and get your questions answered</p>
        <a class="with-right-arrow" href="/resources">View Resources</a>
      </div>
    </div>
  </div>
</div>

<footer class="site-footer">
  <div class="container footer-container">
    <div class="footer-logo-wrapper">
      <a href="https://pytorch.org" class="footer-logo"></a>
    </div>

    <div class="footer-links-wrapper">
      <div class="footer-links-col">
        <ul>
          <li class="list-title"><a href="https://pytorch.org">PyTorch</a></li>
          <li><a href="/get-started">Get Started</a></li>
          <li><a href="/features">Features</a></li>
          <li><a href="/ecosystem">Ecosystem</a></li>
          <li><a href="/blog">Blog</a></li>
          <li><a href="https://github.com/pytorch/pytorch/blob/master/CONTRIBUTING.md" target="_blank">Contributing</a></li>
          <li><a href="https://github.com/pytorch/pytorch/security/policy" target="_blank">Security</a></li>
        </ul>
      </div>

      <div class="footer-links-col">
        <ul>
          <li class="list-title"><a href="/resources">Resources</a></li>
          <li><a href="https://pytorch.org/tutorials">Tutorials</a></li>
          <li><a href="/docs">Docs</a></li>
          <li><a href="https://discuss.pytorch.org" target="_blank">Discuss</a></li>
          <li><a href="https://github.com/pytorch/pytorch/issues" target="_blank">GitHub Issues</a></li>
          <li><a href="/assets/brand-guidelines/PyTorch-Brand-Guidelines.pdf" target="_blank">Brand Guidelines</a></li>
        </ul>
      </div>

      <div class="footer-links-col">
        <ul>
          <li class="list-title"><p>Stay up to date</p></li>
          <li><a href="https://www.facebook.com/pytorch" target="_blank">Facebook</a></li>
          <li><a href="https://twitter.com/pytorch" target="_blank">Twitter</a></li>
          <li><a href="https://www.youtube.com/pytorch" target="_blank">YouTube</a></li>
          <li><a href="https://www.linkedin.com/company/pytorch" target="_blank">LinkedIn</a></li>
          <li><a href="https://social.lfx.dev/@pytorch" rel="me" target="_blank">Mastodon</a></li>
        </ul>
      </div>

      <div class="footer-links-col">
        <ul>
          <li class="list-title"><p>PyTorch Podcasts</p></li>
          <li><a href="https://open.spotify.com/show/6UzHKeiy368jKfQMKKvJY5" target="_blank">Spotify</a></li>
          <li><a href="https://podcasts.apple.com/us/podcast/pytorch-developer-podcast/id1566080008" target="_blank">Apple</a></li>
          <li><a href="https://www.google.com/podcasts?feed=aHR0cHM6Ly9mZWVkcy5zaW1wbGVjYXN0LmNvbS9PQjVGa0lsOA%3D%3D" target="_blank">Google</a></li>
          <li><a href="https://music.amazon.com/podcasts/7a4e6f0e-26c2-49e9-a478-41bd244197d0/PyTorch-Developer-Podcast?" target="_blank">Amazon</a></li>
        </ul>
      </div>
    </div>

    <div class="privacy-policy">
      <ul>
        <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/terms/" target="_blank">Terms</a></li>
        <li class="privacy-policy-links">|</li>
        <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/privacy-policy/" target="_blank">Privacy</a></li>
      </ul>
      <div class="copyright">
        <p>© Copyright The Linux Foundation. The PyTorch Foundation is a project of The Linux Foundation. 
          For web site terms of use, trademark policy and other policies applicable to The PyTorch Foundation please see 
          <a href="https://www.linuxfoundation.org/policies/">www.linuxfoundation.org/policies/</a>. The PyTorch Foundation supports the PyTorch open source 
          project, which has been established as PyTorch Project a Series of LF Projects, LLC. For policies applicable to the PyTorch Project a Series of LF Projects, LLC, 
          please see <a href="https://www.lfprojects.org/policies/">www.lfprojects.org/policies/</a>.</p>
      </div>
    </div>
  </div>
  <img height="1" width="1" style="border-style:none;" alt="" src="https://www.googleadservices.com/pagead/conversion/795629140/?label=txkmCPmdtosBENSssfsC&amp;guid=ON&amp;script=0"/>

</footer>

<div class="mobile-main-menu">
  <div class="container-fluid">
    <div class="container">
      <div class="mobile-main-menu-header-container">
        <a class="header-logo" href="https://pytorch.org" aria-label="PyTorch"></a>
        <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
      </div>
    </div>
  </div>

  <div class="mobile-main-menu-links-container">

    <div class="main-menu">
      <ul>
        <li class="navSearchWrapper reactNavSearchWrapper tabletSearchWrapper" key="search">
          <div class="mobile-search-border">
            <input
              id="mobile-search-input"
              type="text"
              title="Search"
            />
            <div id="mobile-search-icon"></div>
          </div>
        </li>

        <li class="">
          <a href="/get-started">Get Started</a>
        </li>

        <li class="resources-mobile-menu-title">
          <a href="/ecosystem">Ecosystem</a>
        </li>
        <ul class="resources-mobile-menu-items">
          <li>
            <a href="/ecosystem">Tools</a>
          </li>
          <li>
            <a href="/ecosystem/pted/2021">Ecosystem Day 2021</a>
          </li>
          <li>
            <a href="/ecosystem/ptdd/2021">Developer Day 2021</a>
          </li>
        </ul>

        <li class="">
          <a href="/mobile">Mobile</a>
        </li>

        <li class="active">
          <a href="/blog">Blog</a>
        </li>

        <li>
          <a href="https://pytorch.org/tutorials">Tutorials</a>
        </li>

        <li class="resources-mobile-menu-title">
          <a href="/docs">Docs</a>
        </li>

        <ul class="resources-mobile-menu-items">
          <li class="">
            <a href="/docs">PyTorch</a>
          </li>

          <li class="">
            <a href="/audio">torchaudio</a>
          </li>

          <li class="">
            <a href="/text">torchtext</a>
          </li>

          <li class="">
            <a href="/vision">torchvision</a>
          </li>

          <li class="">
            <a href="/torcharrow">torcharrow</a>
          </li>

          <li class="">
            <a href="/data">TorchData</a>
          </li> 

          <li class="">
            <a href="/torchrec">TorchRec</a>
          </li>

          <li class="">
            <a href="/serve">TorchServe</a>
          </li>

          <li class="">
            <a href="/xla/release/1.6/index.html">PyTorch on XLA Devices</a>
          </li>
        </ul>

        <li class="resources-mobile-menu-title">
          Resources
        </li>

        <ul class="resources-mobile-menu-items">
          <li class="">
            <a href="/features">About</a>
          </li>

          <li>
            <a href="/foundation">PyTorch Foundation</a>
          </li>
          
          <li>
            <a href="/#community-module">Community</a>
          </li>
          
          <li class="">
            <a href="/community-stories">Community stories</a>
          </li>

          <li class="">
            <a href="/resources">Developer Resources</a>
          </li>

          <li>
            <a href="/events">Events</a>
          </li>

          <li>
            <a href="https://discuss.pytorch.org">Forum</a>
          </li>

          <li class="">
            <a href="/hub">Models (Beta)</a>
          </li>

        </ul>

        <li id="github-mobile-menu-link">
          <a href="https://github.com/pytorch/pytorch">GitHub</a>
        </li>
      </ul>
    </div>

  </div>
</div>


<script src="/assets/mobile-menu.js"></script>
<script src="/assets/scroll-to-anchor.js"></script>
<script src="/assets/external-links-new-tab.js"></script>

  <script src="/assets/search-bar.js"></script>

<script src="/assets/cookie-banner.js"></script>

<script type="text/javascript">
  mobileMenu.bind();
  anchors.add('.pytorch-article h2, .pytorch-article h3, .pytorch-article h4, .pytorch-article h5');

  // Add class to links that have code blocks, since we cannot create links in code blocks
  $("a code.highlighter-rouge").each(function(e) {
    $(this).closest("a").addClass("has-code");
  });

  scrollToAnchor.bind();

  var hasStaticHeader = $(".blog-header, .blog-detail-header, .resources-header, .get-started-header, .features-header, .ecosystem-header, .hub-header, .mobile-header").length > 0;

  if (!hasStaticHeader) {
    $(window).on("scroll", function() {
      var top = $(this).scrollTop();
      var fullPosition = $(".main-background").height() - $(".header-holder").height();

      if (top <= 40) {
        $(".header-holder").css({"backgroundColor": "rgba(0, 0, 0, 0.165)"});
      } else if (top >= fullPosition) {
        $(".header-holder").css({"backgroundColor": "#000000"});
      } else {
        var bgColor = "rgba(0, 0, 0, " + top / fullPosition + ")";
        $(".header-holder").css({"backgroundColor": bgColor});
      }
    });
  }
</script>


  <script src="/assets/track-events.js"></script>
  <script>trackEvents.bind();</script>



<div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebook’s Cookies Policy applies. Learn more, including about available controls: <a href="https://www.facebook.com/policies/cookies/">Cookies Policy</a>.</p>
    <img class="close-button" src="/assets/images/pytorch-x.svg">
  </div>
</div>


</body>

</html>
